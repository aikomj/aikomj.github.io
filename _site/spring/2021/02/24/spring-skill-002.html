<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> Spring中那些让你爱不释手的代码技巧（下） - 大伟的博客 </title>
    <meta name="keywords" content="spring">
    <meta name="description"
          content="Conditional判断的强大，如何妙用@Import,@ConfigurationProperties赋值，声明式事务编程式事务避坑，跨域问题的3种解决方案，如何定义自己的starter启动器，项目启动时初始化数据、预热本地缓存">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/spring/2021/02/24/spring-skill-002.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="Spring中那些让你爱不释手的代码技巧（下）">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>Spring中那些让你爱不释手的代码技巧（下）</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2021/02/24
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1conditional的强大">1、@Conditional的强大</h2>

<p>不知道你们有没有遇到过这些问题：</p>

<ol>
  <li>某个功能需要根据项目中有没有某个jar判断是否开启该功能。</li>
  <li>某个bean的实例化需要先判断另一个bean有没有实例化，再判断是否实例化自己。</li>
  <li>某个功能是否开启，在配置文件中有个参数可以对它进行控制</li>
</ol>

<p>看SpringBoot的自动配置源码，你会经常看到@Conditional这个注解</p>

<p><img src="/assets/images/2020/icoding/springdata/springdata-datasource-configuration.gif" alt="" /></p>

<p>你会发现除了Hikari DataSource configuration  外，其它都是红色的因为缺失依赖类没生效，我们导入的依赖包spring-boot-starter-jdbc里面有hikari的依赖包，所以Hikari DataSource configuration生效，成为默认的数据源，</p>

<p><strong>@ConditionalOnClass</strong></p>

<p>问题1可以用<code class="highlighter-rouge">@ConditionalOnClass</code>注解解决，代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span>  <span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
<span class="o">}</span>

<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">B</span> <span class="o">{</span>
<span class="o">}</span>

<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="no">B</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="no">A</span> <span class="nf">a</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">A</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>如果项目中存在B类，则会实例化A类。如果不存在B类，则不会实例化A类。你引入了某个jar，必定引入了某个类。这个注解有个升级版的应用场景：比如common工程中写了一个发消息的工具类mqTemplate，业务工程引用了common工程，只需再引入消息中间件，比如rocketmq的jar包，就能开启mqTemplate的功能。而如果有另一个业务工程，通用引用了common工程，如果不需要发消息的功能，不引入rocketmq的jar包即可。</p>

<p><strong>@ConditionalOnBean</strong></p>

<p>问题2可以通过<code class="highlighter-rouge">@ConditionalOnBean</code>注解解决，代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="no">B</span> <span class="nf">b</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span>  <span class="k">new</span> <span class="nf">B</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@ConditionalOnBean</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"b"</span><span class="o">)</span> <span class="c1">// 实例A只有在实例B存在时，才能实例化</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="no">A</span> <span class="nf">a</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span>    <span class="k">new</span> <span class="nf">A</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>@ConditionalOnProperty</strong></p>

<p>问题3可以通过<code class="highlighter-rouge">@ConditionalOnProperty</code>注解解决，代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ConditionalOnProperty</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"demo"</span><span class="o">,</span><span class="n">name</span><span class="o">=</span><span class="s">"enable"</span><span class="o">,</span> <span class="n">havingValue</span> <span class="o">=</span> <span class="s">"true"</span><span class="o">,</span><span class="n">matchIfMissing</span><span class="o">=</span><span class="kc">true</span> <span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="no">A</span> <span class="nf">a</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span>    <span class="k">new</span> <span class="nf">A</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在applicationContext.properties文件中配置参数：</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">demo.enable</span><span class="p">=</span><span class="s">false</span>
</code></pre></div></div>

<ul>
  <li>prefix 表示参数名的前缀，这里是demo</li>
  <li>name 表示参数名</li>
  <li>havingValue 表示指定的值，参数中配置的值需要跟指定的值比较是否相等，相等才满足条件</li>
  <li>matchIfMissing 表示是否允许缺省配置，也就是说demo.enable默认是true</li>
</ul>

<p>这个功能可以作为开关，相比EnableXXX注解的开关更优雅，因为它可以通过参数配置是否开启，而EnableXXX注解的开关需要在代码中硬编码开启或关闭。</p>

<p>下面用一张图整体认识一下<code class="highlighter-rouge">@Conditional</code>家族。</p>

<p><img src="\assets\images\2021\springcloud\conditional.jpg" alt="" /></p>

<p>SpringBoot自动配置原理<a href="/icoding-edu/2020/03/14/icoding-note-008.html">飞天班第8节：SpringBoot原理探究</a></p>

<blockquote>
  <p>自定义Conditional</p>
</blockquote>

<p>说实话，个人认为springboot自带的Conditional系列已经可以满足我们绝大多数的需求了。但如果你有比较特殊的场景，也可以自定义自定义Conditional。</p>

<p>第一步，自定义注解：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Conditional</span><span class="o">(</span><span class="nc">MyCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="nd">@Documented</span>
<span class="kd">public</span>  <span class="nd">@interface</span> <span class="nc">MyConditionOnProperty</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">name</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>

    <span class="nc">String</span> <span class="nf">havingValue</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>第二步，实现Condition接口：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span>  <span class="kd">class</span> <span class="nc">MyCondition</span> <span class="kd">implements</span> <span class="nc">Condition</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="nc">ConditionContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">AnnotatedTypeMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"实现自定义逻辑"</span><span class="o">);</span>
        <span class="k">return</span>  <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>第三步，使用@MyConditionOnProperty注解。</p>

<p>Conditional的奥秘就藏在<code class="highlighter-rouge">ConfigurationClassParser</code>类的<code class="highlighter-rouge">processConfigurationClass</code>方法中，该方法会被同类的<code class="highlighter-rouge">parse</code>方法调用，<code class="highlighter-rouge">parse</code>方法被<code class="highlighter-rouge">ConfigurationClassPostProcessor</code>类的<code class="highlighter-rouge">processConfigBeanDefinitions</code>方法调用，该方法从bean定义注册器中获取所有配置类，代码片段如下</p>

<p><img src="\assets\images\2021\springcloud\spring-process-config-bean.png" alt="" /></p>

<p>configCandidates就是所有候选配置节点，循环验证是否生效，代码片段如下：</p>

<p><img src="\assets\images\2021\springcloud\spring-process-config-bean-2.png" alt="" /></p>

<p>现在我们继续看<code class="highlighter-rouge">ConfigurationClassParser</code>类的<code class="highlighter-rouge">processConfigurationClass</code>方法</p>

<p><img src="\assets\images\2021\springcloud\spring-process-config-bean-3.png" alt="" /></p>

<p>条件判断就在<code class="highlighter-rouge">shouldSkip</code>方法</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">shouldSkip</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">AnnotatedTypeMetadata</span> <span class="n">metadata</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">ConfigurationPhase</span> <span class="n">phase</span><span class="o">)</span> <span class="o">{</span>
 <span class="c1">// 没有使用Conditional注解，直接返回false</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">metadata</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">metadata</span><span class="o">.</span><span class="na">isAnnotated</span><span class="o">(</span><span class="nc">Conditional</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// 配置类</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">phase</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">metadata</span> <span class="k">instanceof</span> <span class="nc">AnnotationMetadata</span> <span class="o">&amp;&amp;</span>
        <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">isConfigurationCandidate</span><span class="o">((</span><span class="nc">AnnotationMetadata</span><span class="o">)</span> <span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">shouldSkip</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">PARSE_CONFIGURATION</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">shouldSkip</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">REGISTER_BEAN</span><span class="o">);</span>
  <span class="o">}</span>
<span class="c1">// 收集条件conditions</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Condition</span><span class="o">&gt;</span> <span class="n">conditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">conditionClasses</span> <span class="o">:</span> <span class="n">getConditionClasses</span><span class="o">(</span><span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">conditionClass</span> <span class="o">:</span> <span class="n">conditionClasses</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">getCondition</span><span class="o">(</span><span class="n">conditionClass</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
      <span class="n">conditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">condition</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="c1">// 排序</span>
  <span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">conditions</span><span class="o">);</span>
<span class="c1">// 遍历该集合，循环调用condition的matchs方法。</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">Condition</span> <span class="n">condition</span> <span class="o">:</span> <span class="n">conditions</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ConfigurationPhase</span> <span class="n">requiredPhase</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">condition</span> <span class="k">instanceof</span> <span class="nc">ConfigurationCondition</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">requiredPhase</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ConfigurationCondition</span><span class="o">)</span> <span class="n">condition</span><span class="o">).</span><span class="na">getConfigurationPhase</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">requiredPhase</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">requiredPhase</span> <span class="o">==</span> <span class="n">phase</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">condition</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">,</span> <span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// 不满足匹配条件，改配置类就会不生效</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="2如何妙用import">2、如何妙用@Import</h2>

<p>有时我们需要在某个配置类中引入另外一些类，被引入的类也加到spring容器中。这时可以使用<code class="highlighter-rouge">@Import</code>注解完成这个功能。如果你看过它的源码会发现，引入的类支持三种不同类型。但是我认为最好将普通类和@Configuration注解的配置类分开讲解，所以列了四种不同类型：</p>

<p><img src="\assets\images\2021\springcloud\spring-import.jpg" alt="" /></p>

<h3 id="普通类">普通类</h3>

<p>这种引入方式是最简单的，被引入的类会被实例化bean对象。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span>  <span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
<span class="o">}</span>

<span class="nd">@Import</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<p>通过<code class="highlighter-rouge">@Import</code>注解引入A类，spring就能自动实例化A对象，然后在需要使用的地方通过<code class="highlighter-rouge">@Autowired</code>注解注入即可：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="no">A</span> <span class="n">a</span><span class="o">;</span>
</code></pre></div></div>

<p>是不是挺让人意外的？不用加<code class="highlighter-rouge">@Bean</code>注解也能实例化bean。</p>

<h3 id="configuration注解的配置类">@Configuration注解的配置类</h3>

<p>这种引入方式是最复杂的，因为<code class="highlighter-rouge">@Configuration</code>注解还支持多种组合注解，比如：</p>

<ul>
  <li><code class="highlighter-rouge">@Import</code></li>
  <li><code class="highlighter-rouge">@ImportResource</code></li>
  <li><code class="highlighter-rouge">@PropertySource</code>等</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span>  <span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
<span class="o">}</span>

<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">B</span> <span class="o">{</span>
<span class="o">}</span>

<span class="nd">@Import</span><span class="o">(</span><span class="no">B</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AConfiguration</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="no">A</span> <span class="nf">a</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span>  <span class="k">new</span> <span class="nf">A</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Import</span><span class="o">(</span><span class="nc">AConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<p>通过<code class="highlighter-rouge">@Import</code>注解引入@Configuration注解的配置类，会把该配置类相关<code class="highlighter-rouge">@Import</code>、<code class="highlighter-rouge">@ImportResource</code>、<code class="highlighter-rouge">@PropertySource</code>（属性资源文件）等注解引入的类进行递归，一次性全部引入，spring的源码里看到。由于文章篇幅有限不过多介绍了，这里留点悬念，后面会出一篇文章专门介绍<code class="highlighter-rouge">@Configuration</code>注解，因为它实在太太太重要了。</p>

<h3 id="实现importselector接口的类">实现ImportSelector接口的类</h3>

<p>这种引入方式需要实现<code class="highlighter-rouge">ImportSelector</code>接口：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span>  <span class="kd">class</span> <span class="nc">AImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
  <span class="kd">private</span>  <span class="kd">static</span>  <span class="kd">final</span> <span class="nc">String</span> <span class="no">CLASS_NAME</span> <span class="o">=</span> <span class="s">"com.sue.cache.service.test13.A"</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span>  <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="no">CLASS_NAME</span><span class="o">};</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Import</span><span class="o">(</span><span class="nc">AImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这种方式的好处是<code class="highlighter-rouge">selectImports</code>方法返回的是数组，意味着可以同时引入多个类，还是非常方便的。</p>

<h3 id="实现importbeandefinitionregistrar接口的类">实现ImportBeanDefinitionRegistrar接口的类</h3>

<p>这种引入方式需要实现<code class="highlighter-rouge">ImportBeanDefinitionRegistrar</code>接口：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span>  <span class="kd">class</span> <span class="nc">AImportBeanDefinitionRegistrar</span> <span class="kd">implements</span> <span class="nc">ImportBeanDefinitionRegistrar</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">RootBeanDefinition</span> <span class="n">rootBeanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">registry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="n">rootBeanDefinition</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Import</span><span class="o">(</span><span class="nc">AImportBeanDefinitionRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这种方式是最灵活的，能在<code class="highlighter-rouge">registerBeanDefinitions</code>方法中获取到<code class="highlighter-rouge">BeanDefinitionRegistry</code>容器注册对象，可以手动控制<code class="highlighter-rouge">BeanDefinition</code>的创建和注册。</p>

<p>当然<code class="highlighter-rouge">@import</code>注解非常人性化，还支持同时引入多种不同类型的类。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Import</span><span class="o">({</span><span class="no">B</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="nc">AImportBeanDefinitionRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>总结：</strong></p>

<ul>
  <li>
    <p>普通类，用于创建没有特殊要求的bean实例。</p>
  </li>
  <li>
    <p>@Configuration注解的配置类，用于层层嵌套引入的场景。</p>
  </li>
  <li>
    <p>实现ImportSelector接口的类，用于一次性引入多个类的场景，或者可以根据不同的配置决定引入不同类的场景。</p>
  </li>
  <li>
    <p>实现ImportBeanDefinitionRegistrar接口的类，主要用于可以手动控制BeanDefinition的创建和注册的场景，它的方法中可以获取BeanDefinitionRegistry注册容器对象。</p>
  </li>
</ul>

<p>在<code class="highlighter-rouge">ConfigurationClassParser</code>类的<code class="highlighter-rouge">processImports</code>方法中可以看到这三种方式的处理逻辑：</p>

<p><img src="\assets\images\2021\springcloud\spring-process-imports.png" alt="" /></p>

<p>最后的else方法其实包含了：普通类和@Configuration注解的配置类两种不同的处理逻辑。</p>

<h2 id="3configurationproperties赋值">3、@ConfigurationProperties赋值</h2>

<p>Springboot 自动配置参数场景，多数时候都会用到该注解 <a href="/icoding-edu/2020/03/14/icoding-note-008.html">飞天班第8节：SpringBoot原理探究</a>，经常配合@Value和@PropertySource 一起使用</p>

<p>在application.properties定义</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">thread.pool.corePoolSize</span><span class="p">=</span><span class="s">5</span>
<span class="py">thread.pool.maxPoolSize</span><span class="p">=</span><span class="s">10</span>
<span class="py">thread.pool.queueCapacity</span><span class="p">=</span><span class="s">200</span>
<span class="py">thread.pool.keepAliveSeconds</span><span class="p">=</span><span class="s">30</span>
</code></pre></div></div>

<p>方法一：通过<code class="highlighter-rouge">@Value</code>注解读取这些配置。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">ThreadPoolConfig</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${thread.pool.corePoolSize:5}"</span><span class="o">)</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${thread.pool.maxPoolSize:10}"</span><span class="o">)</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">maxPoolSize</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${thread.pool.queueCapacity:200}"</span><span class="o">)</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">queueCapacity</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${thread.pool.keepAliveSeconds:30}"</span><span class="o">)</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">keepAliveSeconds</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${thread.pool.threadNamePrefix:ASYNC_}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">threadNamePrefix</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Executor</span> <span class="nf">threadPoolExecutor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">);</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="n">maxPoolSize</span><span class="o">);</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setQueueCapacity</span><span class="o">(</span><span class="n">queueCapacity</span><span class="o">);</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setKeepAliveSeconds</span><span class="o">(</span><span class="n">keepAliveSeconds</span><span class="o">);</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setThreadNamePrefix</span><span class="o">(</span><span class="n">threadNamePrefix</span><span class="o">);</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">setRejectedExecutionHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">.</span><span class="na">CallerRunsPolicy</span><span class="o">());</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>建议在使用时都加上<code class="highlighter-rouge">:</code>，因为<code class="highlighter-rouge">:</code>后面跟的是默认值，比如：@Value(“${thread.pool.corePoolSize:5}”)，定义的默认核心线程数是5。</p>

<p>方法二：通过<code class="highlighter-rouge">@ConfigurationProperties</code>注解</p>

<p>如果参数多的时候，@Value就显得麻烦，每个都得加上，这时，<code class="highlighter-rouge">@ConfigurationProperties</code>就派上用场了，它是springboot中新加的注解。</p>

<p>第一步，先定义ThreadPoolProperties类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="nd">@Component</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="s">"thread.pool"</span><span class="o">)</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">ThreadPoolProperties</span> <span class="o">{</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">maxPoolSize</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">queueCapacity</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">keepAliveSeconds</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">threadNamePrefix</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>第二步，使用ThreadPoolProperties类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">ThreadPoolConfig</span> <span class="o">{</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">ThreadPoolProperties</span> <span class="n">threadPoolProperties</span><span class="o">;</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">Executor</span> <span class="nf">threadPoolExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ThreadPoolTaskExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskExecutor</span><span class="o">();</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="n">threadPoolProperties</span><span class="o">.</span><span class="na">getCorePoolSize</span><span class="o">());</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="n">threadPoolProperties</span><span class="o">.</span><span class="na">getMaxPoolSize</span><span class="o">());</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">setQueueCapacity</span><span class="o">(</span><span class="n">threadPoolProperties</span><span class="o">.</span><span class="na">getQueueCapacity</span><span class="o">());</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">setKeepAliveSeconds</span><span class="o">(</span><span class="n">threadPoolProperties</span><span class="o">.</span><span class="na">getKeepAliveSeconds</span><span class="o">());</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">setThreadNamePrefix</span><span class="o">(</span><span class="n">threadPoolProperties</span><span class="o">.</span><span class="na">getThreadNamePrefix</span><span class="o">());</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">setRejectedExecutionHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">.</span><span class="na">CallerRunsPolicy</span><span class="o">());</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">executor</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用<code class="highlighter-rouge">@ConfigurationProperties</code>注解，可以将<code class="highlighter-rouge">thread.pool</code>开头的参数直接赋值到ThreadPoolProperties类的同名参数中，这样省去了像<code class="highlighter-rouge">@Value</code>注解那样一个个手动去对应的过程。</p>

<p>这种方式显然要方便很多，我们只需编写xxxProperties类，spring会自动装配参数。此外，不同系列的参数可以定义不同的xxxProperties类，也便于管理，推荐优先使用这种方式。</p>

<blockquote>
  <p>底层原理</p>
</blockquote>

<p>它的底层是通过：<code class="highlighter-rouge">ConfigurationPropertiesBindingPostProcessor</code>类（配置属性绑定处理器）实现的，该类实现了<code class="highlighter-rouge">BeanPostProcessor</code>接口，在<code class="highlighter-rouge">postProcessBeforeInitialization</code>方法中解析<code class="highlighter-rouge">@ConfigurationProperties</code>注解，并且绑定数据到相应的对象上。</p>

<p><img src="D:\jacob\code\aikomj.github.io\assets\images\2021\springcloud\spring-bind-properties.png" alt="" /></p>

<p>绑定是通过<code class="highlighter-rouge">Binder</code>类的<code class="highlighter-rouge">bindObject</code>方法完成的：</p>

<p><img src="\assets\images\2021\springcloud\spring-bind-object.png" alt="" /></p>

<p>以上这段代码会递归绑定数据，主要考虑了三种情况：</p>

<ul>
  <li><code class="highlighter-rouge">bindAggregate</code> 绑定集合类</li>
  <li><code class="highlighter-rouge">bindBean</code> 绑定对象</li>
  <li><code class="highlighter-rouge">bindProperty</code> 绑定参数 前面两种情况最终也会调用到bindProperty方法。</li>
</ul>

<p>使用<code class="highlighter-rouge">@ConfigurationProperties</code>注解有些场景有问题，比如：在apollo中修改了某个参数，正常情况可以动态更新到<code class="highlighter-rouge">@ConfigurationProperties</code>注解定义的xxxProperties类的对象中，但是如果出现比较复杂的对象，比如：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;&gt;</span>  <span class="n">urls</span><span class="o">;</span>
</code></pre></div></div>

<p>可能动态更新不了。</p>

<p>这时候该怎么办呢？</p>

<p>答案是使用<code class="highlighter-rouge">ApolloConfigChangeListener</code>监听器自己处理：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">ctrip</span><span class="o">.</span><span class="na">framework</span><span class="o">.</span><span class="na">apollo</span><span class="o">.</span><span class="na">spring</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">EnableApolloConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApolloConfigurationAutoRefresh</span> <span class="kd">implements</span> <span class="nc">ApplicationContextAware</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>
   
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setApplicationContext</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">applicationContext</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">;</span>
   <span class="o">}</span>
   
    <span class="nd">@ApolloConfigChangeListener</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">onChange</span><span class="o">(</span><span class="nc">ConfigChangeEvent</span> <span class="n">changeEvent</span><span class="o">{</span>
        <span class="n">refreshConfig</span><span class="o">(</span><span class="n">changeEvent</span><span class="o">.</span><span class="na">changedKeys</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">refreshConfig</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">changedKeys</span><span class="o">){</span>
       <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"将变更的参数更新到相应的对象中"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="4spring事务如何避坑">4、Spring事务如何避坑</h2>

<h3 id="声明式事务">声明式事务</h3>

<p>大多数情况下，我们在开发过程中使用更多的可能是<code class="highlighter-rouge">声明式事务</code>，即使用<code class="highlighter-rouge">@Transactional</code>注解定义的事务，因为它用起来简单方便，但是只能控制单个数据库的事务</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserMapper</span> <span class="n">userMapper</span><span class="o">;</span>
    
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="nc">UserModel</span> <span class="n">userModel</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userMapper</span><span class="o">.</span><span class="na">insertUser</span><span class="o">(</span><span class="n">userModel</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这种声明式事务之所以能生效，是因为它的底层使用了AOP，创建了代理对象，调用<code class="highlighter-rouge">TransactionInterceptor</code>事务拦截器实现事务的功能。</p>

<p>spring事务有个特别的地方：它获取的数据库连接放在<code class="highlighter-rouge">ThreadLocal</code>中的，<strong>也就是说同一个线程中从始至终都能获取同一个数据库连接</strong>，可以保证同一个线程中多次数据库操作在同一个事务中执行。</p>

<p>正常情况下是没有问题的，但是如果使用不当，事务会失效，主要原因如下:</p>

<p><img src="\assets\images\2021\springcloud\spring-transactional.jpg" alt="" /></p>

<p>默认情况下， Spring会对所有的运行时异常进行事务回滚</p>

<p>除了上述列举的问题之外，由于<code class="highlighter-rouge">@Transactional</code>注解最小粒度是要被定义在方法上，如果有多层的事务方法调用，可能会造成大事务问题</p>

<p><img src="\assets\images\2021\springcloud\spring-transactional-invalid.png" alt="" /></p>

<p>所以，建议在实际工作中少用<code class="highlighter-rouge">@Transactional</code>注解开启事务，使用<code class="highlighter-rouge">TransactionTemplate</code>替代</p>

<h3 id="编程式事务">编程式事务</h3>

<p>一般情况下编程式事务我们可以通过<code class="highlighter-rouge">TransactionTemplate</code>类开启事务功能。有个好消息，就是<code class="highlighter-rouge">springboot</code>已经默认实例化好这个对象了，我们能直接在项目中使用。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
   <span class="nd">@Autowired</span>
   <span class="kd">private</span> <span class="nc">TransactionTemplate</span> <span class="n">transactionTemplate</span><span class="o">;</span>
   
   <span class="o">...</span>
   
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="kd">final</span> <span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">((</span><span class="n">status</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="o">{</span>
            <span class="n">doSameThing</span><span class="o">...</span>
            <span class="k">return</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">;</span> <span class="c1">// 返回true，则自动提交事务，false就回滚事务</span>
         <span class="o">})</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用<code class="highlighter-rouge">TransactionTemplate</code>的编程式事务能避免很多事务失效的问题，但是对大事务问题，不一定能够解决，只是说相对于使用<code class="highlighter-rouge">@Transactional</code>注解要好些。事务控制在execute方法里，看源码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">TransactionCallback</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransactionException</span> <span class="o">{</span>
  <span class="nc">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="s">"No PlatformTransactionManager set"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span> <span class="k">instanceof</span> <span class="nc">CallbackPreferringPlatformTransactionManager</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">((</span><span class="nc">CallbackPreferringPlatformTransactionManager</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span><span class="o">).</span><span class="na">execute</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">action</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">TransactionStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

    <span class="nc">Object</span> <span class="n">result</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="na">doInTransaction</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Error</span> <span class="o">|</span> <span class="nc">RuntimeException</span> <span class="n">var5</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">rollbackOnException</span><span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="n">var5</span><span class="o">);</span>
      <span class="k">throw</span> <span class="n">var5</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">var6</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">rollbackOnException</span><span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="n">var6</span><span class="o">);</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var6</span><span class="o">,</span> <span class="s">"TransactionCallback threw undeclared checked exception"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>从源码可以看出，spring会开启一个事务，并在这个事务里执行所有的业务操作，当然只限本地事务。</p>

<p>不使用TransactionTemplate可以直接获取事务进行业务操作，自己手动commit或rollback</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Resource</span>
<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"transactionManager1"</span><span class="o">)</span>
<span class="kd">private</span> <span class="nc">PlatformTransactionManager</span> <span class="n">txManager1</span><span class="o">;</span>
<span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"transactionManager2"</span><span class="o">)</span>
<span class="nd">@Resource</span>
<span class="kd">private</span> <span class="nc">PlatformTransactionManager</span> <span class="n">txManager2</span><span class="o">;</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
  <span class="nc">DefaultTransactionDefinition</span> <span class="n">def1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultTransactionDefinition</span><span class="o">();</span> 
  <span class="c1">// explicitly setting the transaction name is something that can be done only programmatically </span>
  <span class="n">def1</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"SomeTxName"</span><span class="o">);</span> 
  <span class="n">def1</span><span class="o">.</span><span class="na">setPropagationBehavior</span><span class="o">(</span><span class="nc">TransactionDefinition</span><span class="o">.</span><span class="na">PROPAGATION_REQUIRED</span><span class="o">);</span>
  <span class="nc">TransactionStatus</span> <span class="n">status1</span> <span class="o">=</span> <span class="n">txManager1</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(</span><span class="n">def1</span><span class="o">);</span>

  <span class="nc">DefaultTransactionDefinition</span> <span class="n">def2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultTransactionDefinition</span><span class="o">();</span> 
  <span class="c1">// explicitly setting the transaction name is something that can be done only programmatically </span>
  <span class="n">def2</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"SomeTxName"</span><span class="o">);</span> 
  <span class="n">def2</span><span class="o">.</span><span class="na">setPropagationBehavior</span><span class="o">(</span><span class="nc">TransactionDefinition</span><span class="o">.</span><span class="na">PROPAGATION_REQUIRED</span><span class="o">);</span>
  <span class="nc">TransactionStatus</span> <span class="n">status2</span> <span class="o">=</span> <span class="n">txManager2</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(</span><span class="n">def2</span><span class="o">);</span>

  <span class="c1">//统一进行事务控制</span>
  <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// put your business logic here</span>
      <span class="n">executeDataSource1</span><span class="o">(</span><span class="n">txManager1</span><span class="o">,</span><span class="n">otherParams</span><span class="o">);</span>
      <span class="n">executeDataSource2</span><span class="o">(</span><span class="n">txManager2</span><span class="o">,</span><span class="n">otherParams</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">catch</span> <span class="o">(</span><span class="nc">MyException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">txManager1</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">status1</span><span class="o">);</span>
      <span class="n">txManager2</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">status2</span><span class="o">);</span>
      <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="n">txManager1</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">status1</span><span class="o">);</span>
  <span class="n">txManager2</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">status2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>区别</p>
</blockquote>

<ul>
  <li>
    <p>声明式事务只能做到<mark>public方法</mark>级别的粒度控制，代码简洁。</p>

    <p>注意自调用问题, @Transactional 注解仅在外部类的调用才生效, 原因是使用 Spring AOP 机制造成的. 所以: 主调函数如果是本Service类, 应该也要打上 @Transactional, 否则事务控制被忽略；</p>

    <p>缺省的情况下, 只有 RuntimeException 类异常才会触发回滚. 如果在事务中抛出其他异常,并期望回滚事务, 必须设定  rollbackFor 参数. 例子:  @Transactional(propagation=Propagation.REQUIRED,rollbackFor=  MyException.class)，只要MyException 继承 RuntimeException就行</p>
  </li>
  <li>
    <p>编程式事务粒度更细，可以做到代码块级别的事务控制，原理是通过AOP+proxy代理模式的方式实现的。</p>
  </li>
</ul>

<h3 id="platformtransactionmanager接口">PlatformTransactionManager接口</h3>

<p>Spring 控制事务的方式基础是 PlatformTransactionManager 接口, 它为各种数据访问技术提供了统一的事务支持接口, 不同的数据技术都有自己的实现:</p>

<ul>
  <li>Spring JDBC 技术: DataSourceTransactionManager</li>
  <li>JPA 技术: JpaTransactionManager</li>
  <li>Hibernate 技术: HibernateTransactionManager</li>
  <li>JDO 技术: JdoTransactionManager</li>
  <li>分布式事务: JtaTransactionManager</li>
</ul>

<p>Spring Boot 项目中</p>

<p>1.引入了 spring-boot-starter-jdbc 之后, 会自动注入一个  <code class="highlighter-rouge">DataSourceTransactionManager </code>类型 bean 对象, 这个对象有两个名称, 分别为  <code class="highlighter-rouge">transactionManager</code> 和 <code class="highlighter-rouge">platformTransactionManager</code></p>

<p>2.引入了  spring-boot-starter-data-jpa 依赖后, 会自动注入一个 <code class="highlighter-rouge">JpaTransactionManager</code> 类型 bean  对象, 这个对象有两个名称, 分别为 <code class="highlighter-rouge">transactionManager </code>和 <code class="highlighter-rouge">platformTransactionManager</code></p>

<h3 id="多数据源指定事务控制器">多数据源指定事务控制器</h3>

<p>如果我们项目有多个数据源, 或者既引入了 spring-boot-starter-jdbc, 又引入了  spring-boot-starter-data-jpa 依赖, 自动注入事务控制器就会混乱, 所以需要创建一个 <code class="highlighter-rouge">TransactionManager</code> configuration 类, 手动为不同数据源建立对应的  <code class="highlighter-rouge">PlatformTransactionManager</code> bean. 如果使用 @Transactional 注解控制事务,  需要指定对应的事务控制器, 比如</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">"txManager1"</span><span class="o">)</span> 
</code></pre></div></div>

<p>事务管理配置类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableTransactionManagement</span>
<span class="kd">class</span> <span class="nc">TransactionManagerConfig</span><span class="o">{</span>
<span class="nd">@Bean</span>  
<span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">txManager1</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource1</span><span class="o">)</span> <span class="o">{</span>     
  <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource1</span><span class="o">);</span>    
<span class="o">}</span>
 <span class="nd">@Bean</span>       
 <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">txManager2</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource2</span><span class="o">)</span> <span class="o">{</span>    
   <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource2</span><span class="o">);</span>    
 <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// dataSourec1、dataSourec2是多数据源配置注入的bean,考虑这样的场景：mysql主从库，一个服务应用连接两个数据库，做读写分离，写必须是主库</span>

    <span class="nd">@Bean</span>
    <span class="nd">@Primary</span> <span class="c1">// 不指定的时候取这个事务控制器</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">rccManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"rccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">smcManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"smcShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">mccManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"mccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="事务监听机制">事务监听机制</h3>

<p>原文：<a href="https://fangshixiang.blog.csdn.net/article/details/91897175">https://fangshixiang.blog.csdn.net/article/details/91897175</a></p>

<p>在spring事务的管控下，需要在执行完数据库操作后，发送消息（比如短信、邮件、微信通知等）来执行其它的操作，而这些并不是主干业务，所以一般会放在异步线程里。spring 提供了两种解决方案</p>

<ul>
  <li>事务同步管理器<code class="highlighter-rouge">TransactionSynchronizationManager</code></li>
  <li><code class="highlighter-rouge">@TransactionalEventListener</code>注解（Spring 4.2+）</li>
</ul>

<p>demo代码</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServiceImpl</span> <span class="kd">implements</span> <span class="nc">HelloService</span> <span class="o">{</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">ApplicationEventPublisher</span> <span class="n">applicationEventPublisher</span><span class="o">;</span>

  <span class="nd">@Transactional</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">hello</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 向数据库插入一条记录</span>
    <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into user (id,name,age) values ("</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">",'fsx',21)"</span><span class="o">;</span>
    <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

    <span class="c1">// 发布自定义事件</span>
    <span class="n">applicationEventPublisher</span><span class="o">.</span><span class="na">publishEvent</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyAfterTransactionEvent</span><span class="o">(</span><span class="s">"我是和事务相关的事件，请事务提交后执行我~~~"</span><span class="o">,</span> <span class="n">id</span><span class="o">));</span>
    <span class="k">return</span> <span class="s">"service hello"</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Slf4j</span>
  <span class="nd">@Component</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyTransactionListener</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="c1">// 订阅自定义事件，事务提交后触发</span>
    <span class="nd">@TransactionalEventListener</span><span class="o">(</span><span class="n">phase</span> <span class="o">=</span> <span class="nc">TransactionPhase</span><span class="o">.</span><span class="na">AFTER_COMMIT</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">onHelloEvent</span><span class="o">(</span><span class="nc">HelloServiceImpl</span><span class="o">.</span><span class="na">MyAfterTransactionEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Object</span> <span class="n">source</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getSource</span><span class="o">();</span>
      <span class="nc">Integer</span> <span class="n">id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>

      <span class="nc">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"select count(1) from user where id = "</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
      <span class="nc">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">source</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">count</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span> <span class="c1">// 我是和事务相关的事件，请事务提交后执行我~~~:1</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// 定一个事件，继承自ApplicationEvent </span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyAfterTransactionEvent</span> <span class="kd">extends</span> <span class="nc">ApplicationEvent</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MyAfterTransactionEvent</span><span class="o">(</span><span class="nc">Object</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>默认情况下，spring的事件监听机制不是异步的，而是同步的，只是做了代码上的解耦，注解<code class="highlighter-rouge">@TransactionEventListener</code>也是同步的，通过回调的方式，在提交或者回滚后触发回调事件（被该注解标识的方法）。</p>

<p>点进<code class="highlighter-rouge">TransactionalEventListener</code>的源码</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">ANNOTATION_TYPE</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="nd">@EventListener</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">TransactionalEventListener</span> <span class="o">{</span>
	<span class="cm">/**
	 * Phase to bind the handling of an event to.
	 * &lt;p&gt;The default phase is {@link TransactionPhase#AFTER_COMMIT}.
	 * &lt;p&gt;If no transaction is in progress, the event is not processed at
	 * all unless {@link #fallbackExecution} has been enabled explicitly.
	 取值有：BEFORE_COMMIT、AFTER_COMMIT、AFTER_ROLLBACK、AFTER_COMPLETION
	 */</span>
	<span class="nc">TransactionPhase</span> <span class="nf">phase</span><span class="o">()</span> <span class="k">default</span> <span class="nc">TransactionPhase</span><span class="o">.</span><span class="na">AFTER_COMMIT</span><span class="o">;</span>

	<span class="cm">/**
	 * Whether the event should be processed if no transaction is running.
	 若没有事务的时候，对应的event是否已经执行  
	 */</span>
	<span class="kt">boolean</span> <span class="nf">fallbackExecution</span><span class="o">()</span> <span class="k">default</span> <span class="kc">false</span><span class="o">;</span>

	<span class="cm">/**
	 * Alias for {@link #classes}.
	 */</span>
	<span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">EventListener</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">attribute</span> <span class="o">=</span> <span class="s">"classes"</span><span class="o">)</span>
	<span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">value</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

	<span class="cm">/**
	 * The event classes that this listener handles.
	 * &lt;p&gt;If this attribute is specified with a single value, the annotated
	 * method may optionally accept a single parameter. However, if this
	 * attribute is specified with multiple values, the annotated method
	 * must &lt;em&gt;not&lt;/em&gt; declare any parameters.
	 */</span>
	<span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">EventListener</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">attribute</span> <span class="o">=</span> <span class="s">"classes"</span><span class="o">)</span>
	<span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">classes</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

	<span class="cm">/**
	 * Spring Expression Language (SpEL) attribute used for making the event
	 * handling conditional.
	 * &lt;p&gt;The default is {@code ""}, meaning the event is always handled.
	 * @see EventListener#condition
	 支持spel表达式，触发事件的条件，详情看注解的EventListener#condition
	 */</span>
	<span class="nc">String</span> <span class="nf">condition</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>注解<code class="highlighter-rouge">@TransactionalEventListener</code>标识的方法，底层是通过<code class="highlighter-rouge">TransactionalEventListenerFactory</code>工厂方法生成一个<code class="highlighter-rouge">ApplicationListenerMethodTransactionalAdapter</code>适配器，把监听事件<code class="highlighter-rouge">ApplicationEvent</code>注册到事件发射器的容器里面</p>

<p>点进<code class="highlighter-rouge">ApplicationListenerMethodTransactionalAdapter</code>的源码，它继承<code class="highlighter-rouge">ApplicationListenerMethodAdapter</code>应用事件监听方法适配器，</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ApplicationListenerMethodTransactionalAdapter</span> <span class="kd">extends</span> <span class="nc">ApplicationListenerMethodAdapter</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TransactionalEventListener</span> <span class="n">annotation</span><span class="o">;</span> <span class="c1">// 被封装的对象</span>

  <span class="kd">public</span> <span class="nf">ApplicationListenerMethodTransactionalAdapter</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>
    <span class="nc">TransactionalEventListener</span> <span class="n">ann</span> <span class="o">=</span> <span class="nc">AnnotatedElementUtils</span><span class="o">.</span><span class="na">findMergedAnnotation</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="nc">TransactionalEventListener</span><span class="o">.</span><span class="na">class</span><span class="o">);</span> <span class="c1">// 找到添加了注解@TransactionalEventListener的方法</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ann</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"No TransactionalEventListener annotation found on method: "</span> <span class="o">+</span> <span class="n">method</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">annotation</span> <span class="o">=</span> <span class="n">ann</span><span class="o">;</span>
  <span class="o">}</span>
  
  	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 事务同步管理器，注册事务同步器，同步器里就是自定义的同步事件</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">TransactionSynchronizationManager</span><span class="o">.</span><span class="na">isSynchronizationActive</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
				<span class="nc">TransactionSynchronizationManager</span><span class="o">.</span><span class="na">isActualTransactionActive</span><span class="o">())</span> <span class="o">{</span>
			<span class="nc">TransactionSynchronization</span> <span class="n">transactionSynchronization</span> <span class="o">=</span> <span class="n">createTransactionSynchronization</span><span class="o">(</span><span class="n">event</span><span class="o">);</span> 
			<span class="nc">TransactionSynchronizationManager</span><span class="o">.</span><span class="na">registerSynchronization</span><span class="o">(</span><span class="n">transactionSynchronization</span><span class="o">);</span>
		<span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">fallbackExecution</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// 如果没有事务，也执行事件</span>
			<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">phase</span><span class="o">()</span> <span class="o">==</span> <span class="nc">TransactionPhase</span><span class="o">.</span><span class="na">AFTER_ROLLBACK</span> <span class="o">&amp;&amp;</span> <span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Processing "</span> <span class="o">+</span> <span class="n">event</span> <span class="o">+</span> <span class="s">" as a fallback execution on AFTER_ROLLBACK phase"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">processEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
		<span class="o">}</span><span class="k">else</span> <span class="o">{</span>
			<span class="c1">// No transactional event execution at all</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"No transaction is active - skipping "</span> <span class="o">+</span> <span class="n">event</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>    
</code></pre></div></div>

<p><code class="highlighter-rouge">createTransactionSynchronization</code>方法返回的是内部类<code class="highlighter-rouge">TransactionSynchronizationEventAdapter</code> 事务同步事件适配器</p>

<p><img src="\assets\images\2021\javabase\transaction-synchronization.jpg" alt="" /></p>

<p>注解<code class="highlighter-rouge">@TransactionalEventListener</code>底层原理还是<code class="highlighter-rouge">TransactionSynchronization</code>和<code class="highlighter-rouge">TransactionSynchronizationManager</code>。</p>

<p>内部类<code class="highlighter-rouge">TransactionSynchronizationEventAdapter</code>的源码</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TransactionSynchronizationEventAdapter</span> <span class="kd">extends</span> <span class="nc">TransactionSynchronizationAdapter</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ApplicationListenerMethodAdapter</span> <span class="n">listener</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TransactionPhase</span> <span class="n">phase</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">TransactionSynchronizationEventAdapter</span><span class="o">(</span><span class="nc">ApplicationListenerMethodAdapter</span> <span class="n">listener</span><span class="o">,</span>
                                                <span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">,</span> <span class="nc">TransactionPhase</span> <span class="n">phase</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">this</span><span class="o">.</span><span class="na">listener</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">event</span> <span class="o">=</span> <span class="n">event</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOrder</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// 50</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">listener</span><span class="o">.</span><span class="na">getOrder</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span> <span class="c1">// 提交前处理事件</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeCommit</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">readOnly</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">phase</span> <span class="o">==</span> <span class="nc">TransactionPhase</span><span class="o">.</span><span class="na">BEFORE_COMMIT</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">processEvent</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span> <span class="c1">// 提交或回滚后处理事件</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterCompletion</span><span class="o">(</span><span class="kt">int</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">phase</span> <span class="o">==</span> <span class="nc">TransactionPhase</span><span class="o">.</span><span class="na">AFTER_COMMIT</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">==</span> <span class="no">STATUS_COMMITTED</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">processEvent</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">phase</span> <span class="o">==</span> <span class="nc">TransactionPhase</span><span class="o">.</span><span class="na">AFTER_ROLLBACK</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">==</span> <span class="no">STATUS_ROLLED_BACK</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">processEvent</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">phase</span> <span class="o">==</span> <span class="nc">TransactionPhase</span><span class="o">.</span><span class="na">AFTER_COMPLETION</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">processEvent</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processEvent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">listener</span><span class="o">.</span><span class="na">processEvent</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">event</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="5跨域问题的3种解决方案">5、跨域问题的3种解决方案</h2>

<p><a href="/springboot/2021/01/27/spring-boot-cors.html">SpringBoot 解决跨越问题的3种方案</a></p>

<h3 id="crossorigin注解">CrossOrigin注解</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/user"</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>
    <span class="nd">@CrossOrigin</span><span class="o">(</span><span class="n">origins</span> <span class="o">=</span> <span class="s">"http://localhost:8016"</span><span class="o">)</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/getUser"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUser</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"name:"</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
        <span class="k">return</span>  <span class="s">"success"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>该方案需要在跨域访问的接口上加<code class="highlighter-rouge">@CrossOrigin</code>注解，访问规则可以通过注解中的参数控制，控制粒度更细。如果需要跨域访问的接口数量较少，可以使用该方案。</p>

<h3 id="全局配置类">全局配置类</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">WebConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addCorsMappings</span><span class="o">(</span><span class="nc">CorsRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="s">"/**"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowedOrigins</span><span class="o">(</span><span class="s">"*"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowedMethods</span><span class="o">(</span><span class="s">"GET"</span><span class="o">,</span> <span class="s">"POST"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowCredentials</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">maxAge</span><span class="o">(</span><span class="mi">3600</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowedHeaders</span><span class="o">(</span><span class="s">"*"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>该方案需要实现<code class="highlighter-rouge">WebMvcConfigurer</code>接口，重写<code class="highlighter-rouge">addCorsMappings</code>方法，在该方法中定义跨域访问的规则。这是一个全局的配置，可以应用于所有接口。</p>

<h3 id="自定义过滤器">自定义过滤器</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebFilter</span><span class="o">(</span><span class="s">"corsFilter"</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">CorsFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
        <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Origin"</span><span class="o">,</span> <span class="s">"*"</span><span class="o">);</span>
        <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Methods"</span><span class="o">,</span> <span class="s">"POST, GET"</span><span class="o">);</span>
        <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Max-Age"</span><span class="o">,</span> <span class="s">"3600"</span><span class="o">);</span>
        <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Headers"</span><span class="o">,</span> <span class="s">"x-requested-with"</span><span class="o">);</span>
        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>该方案通过在请求的<code class="highlighter-rouge">header</code>中增加<code class="highlighter-rouge">Access-Control-Allow-Origin</code>等参数解决跨域问题</p>

<p>顺便说一下，使用<code class="highlighter-rouge">@CrossOrigin</code>注解 和 实现<code class="highlighter-rouge">WebMvcConfigurer</code>接口的方案，spring在底层最终都会调用到<code class="highlighter-rouge">DefaultCorsProcessor</code>类的<code class="highlighter-rouge">handleInternal</code>方法：</p>

<p>最终三种方案殊途同归，都会往<code class="highlighter-rouge">header</code>中添加跨域需要参数，只是实现形式不一样而已。</p>

<h2 id="6如何自定义starter">6、如何自定义starter</h2>

<p>spring boot starter原理：<a href="/icoding-edu/2020/03/14/icoding-note-008.html">飞天班第8节：SpringBoot原理探究</a></p>

<p>以前在没有使用<code class="highlighter-rouge">starter</code>时，我们在项目中需要引入新功能，步骤一般是这样的：</p>

<ul>
  <li>在maven仓库找该功能所需jar包</li>
  <li>在maven仓库找该jar所依赖的其他jar包</li>
  <li>配置新功能所需参数（xml）</li>
</ul>

<p>以上这种方式会带来三个问题：</p>

<ol>
  <li>如果依赖包较多，找起来很麻烦，容易找错，而且要花很多时间。</li>
  <li>各依赖包之间可能会存在版本兼容性问题，项目引入这些jar包后，可能没法正常启动。</li>
  <li>如果有些参数没有配好，启动服务也会报错，没有默认配置。</li>
</ol>

<p><strong>「为了解决这些问题，springboot的<code class="highlighter-rouge">starter</code>机制应运而生」</strong>。</p>

<ol>
  <li>它能启动相应的默认配置。</li>
  <li>它能够管理所需依赖，摆脱了需要到处找依赖 和 兼容性问题的困扰。</li>
  <li>自动发现机制，将spring.factories文件中配置的类，自动注入到spring容器中。</li>
  <li>遵循“约定大于配置”的理念。</li>
</ol>

<p>在业务工程中只需引入xxx-starter包，就能使用它的功能，太爽了。</p>

<p>下面用一张图，总结starter的几个要素：</p>

<p><img src="\assets\images\2021\springcloud\spring-boot-starter.png" alt="" /></p>

<p>加了@SpringBootApplication注解的启动类，启动加载的时候会从spring.factories读取配置</p>

<blockquote>
  <p>实战，定义自己的starter</p>
</blockquote>

<p>启动器包含两个模块：</p>

<ul>
  <li>
    <p>autoconfigure module 配置模块</p>
  </li>
  <li>
    <p>starter module 启动模块</p>

    <p>starter module是一个空jar,只是用来提供依赖包</p>
  </li>
</ul>

<p>第一步，创建id-generate-starter的spring boot工程，pom.xml配置如下：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;version&gt;</span>1.3.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.sue<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>id-generate-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;name&gt;</span>id-generate-spring-boot-starter<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.sue<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>id-generate-spring-boot-autoconfigure<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.3.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div>

<p>第二步，创建id-generate-spring-boot-autoconfigure工程：</p>

<p><img src="\assets\images\2021\springcloud\springboot-self-autoconfigure.jpg" alt="" /></p>

<p>pom.xml配置如下</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.0.4.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.3.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.sue<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>id-generate-spring-boot-autoconfigure<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;name&gt;</span>id-generate-spring-boot-autoconfigure<span class="nt">&lt;/name&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-autoconfigure<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-configuration-processor<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;configuration&gt;</span>
                    <span class="nt">&lt;source&gt;</span>1.8<span class="nt">&lt;/source&gt;</span>
                    <span class="nt">&lt;target&gt;</span>1.8<span class="nt">&lt;/target&gt;</span>
                <span class="nt">&lt;/configuration&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div>

<p>该项目当中包含</p>

<ul>
  <li>spring.factories</li>
  <li>IdGenerateAutoConfiguration</li>
  <li>IdGenerateService</li>
  <li>IdProperties</li>
</ul>

<p>spring.factories配置如下：</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="p">=</span><span class="s">com.sue.IdGenerateAutoConfiguration</span>
</code></pre></div></div>

<p>IdGenerateAutoConfiguration类：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">IdProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">IdProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IdGenerateAutoConfiguration</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">IdProperties</span> <span class="n">properties</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">IdGenerateService</span> <span class="nf">idGenerateService</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span>  <span class="k">new</span> <span class="nf">IdGenerateService</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">getWorkId</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>IdGenerateService类：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span>  <span class="kd">class</span> <span class="nc">IdGenerateService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">workId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">IdGenerateService</span><span class="o">(</span><span class="nc">Long</span> <span class="n">workId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">workId</span> <span class="o">=</span> <span class="n">workId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">generate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span>  <span class="k">new</span> <span class="nf">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">workId</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>IdProperties类：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="nc">IdProperties</span><span class="o">.</span><span class="na">PREFIX</span><span class="o">)</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">IdProperties</span> <span class="o">{</span>
    <span class="kd">public</span>  <span class="kd">static</span>  <span class="kd">final</span> <span class="nc">String</span> <span class="no">PREFIX</span> <span class="o">=</span> <span class="s">"sue"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">workId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getWorkId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">workId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWorkId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">workId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">workId</span> <span class="o">=</span> <span class="n">workId</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这样在业务项目中引入相关依赖:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.sue<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>id-generate-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>1.3.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>就能使用注入使用IdGenerateService的功能了</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="nc">IdGenerateService</span> <span class="n">idGenerateService</span><span class="o">;</span>
</code></pre></div></div>

<p>完成。</p>

<h2 id="7项目启动时的附加功能">7、项目启动时的附加功能</h2>

<p>有时候我们需要在项目启动时定制化一些附加功能，比如：加载一些系统参数、完成初始化、预热本地缓存等，该怎么办呢？</p>

<p>方法一：@PostConstruct注解加到Service方法上，在项目启动加载servlet时运行完成初始化。</p>

<p>方法二：使用springboot提供的CommandLineRunner接口和ApplicationRunner接口</p>

<h3 id="callrunner">callRunner</h3>

<p>它们的用法还是挺简单的，以<code class="highlighter-rouge">ApplicationRunner</code>接口为例：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span>  <span class="kd">class</span> <span class="nc">TestRunner</span> <span class="kd">implements</span> <span class="nc">ApplicationRunner</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">LoadDataService</span> <span class="n">loadDataService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">ApplicationArguments</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">loadDataService</span><span class="o">.</span><span class="na">load</span><span class="o">();</span>
    <span class="o">}</span>   
<span class="o">}</span>
</code></pre></div></div>

<p>实现<code class="highlighter-rouge">ApplicationRunner</code>接口，重写<code class="highlighter-rouge">run</code>方法，在该方法中实现自己定制化需求。</p>

<p>如果项目中有多个类实现了<code class="highlighter-rouge">ApplicationRunner</code>接口，他们的执行顺序要怎么指定呢？</p>

<p>答案是<mark>使用`@Order(n)`注解，n的值越小越先执行。</mark>当然也可以通过<code class="highlighter-rouge">@Priority</code>注解指定顺序。</p>

<p>springboot项目启动时主要流程是这样的：</p>

<p><img src="\assets\images\2021\springcloud\springboot-start-flow.jpg" style="zoom: 50%;" /></p>

<p>SpringApplication的run方法源码:</p>

<p><img src="\assets\images\2021\springcloud\springapplication-run.png" alt="" /></p>

<p>在<code class="highlighter-rouge">SpringApplication</code>类的<code class="highlighter-rouge">callRunners</code>方法中，我们能看到这两个接口的具体调用：</p>

<p><img src="\assets\images\2021\springcloud\springapplication-run-callrunner.png" alt="" /></p>

<p>所以项目启动时，会调用TestRunner类的run方法。</p>

<blockquote>
  <p>这两个接口有什么区别？</p>
</blockquote>

<ul>
  <li>CommandLineRunner接口中run方法的参数为String数组</li>
  <li>ApplicationRunner中run方法的参数为ApplicationArguments，该参数包含了String数组参数 和 一些可选参数。</li>
</ul>


            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/spring/2021/02/24/spring-skill-002.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
