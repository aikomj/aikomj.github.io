<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 接口性能优化的11个技巧 - 大伟的博客 </title>
    <meta name="keywords" content="springboot">
    <meta name="description"
          content="添加索引，让索引生效，sql优化，远程调用使用并行、redis缓存数据异构方案，避免重复调用如循环查询数据库、无限递归，异步处理，避免大事务，synchronzied和redis分布式锁控制好锁粒度,远程调用分页查询数据，redis缓存与二级缓存的使用，分库分表解决数据库连接资源不足、磁盘IO的性能瓶颈、检索数据耗时和消耗cpu资源等问题，辅助功能开启慢查询日志、prometheus普罗米修斯监控、skywalking接口链路跟踪快速定位耗时问题">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/springboot/2022/01/03/skill-to-optimize-your-api.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="接口性能优化的11个技巧">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>接口性能优化的11个技巧</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2022/01/03
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <p>转载自苏三说技术</p>

<p>导致接口性能问题的原因千奇百怪，不同项目的不同接口，原因可能也不一样，本文我总结了一些行之有效的优化接口性能的办法。</p>

<h2 id="1索引">1、索引</h2>

<p>优化索引的成本是最小的，你通过查看线上日志或监控报告，查到某个接口用到的某条sql语句耗时比较长，这时你可能就有以下疑问：</p>

<ul>
  <li>这条sql语句加了索引没？</li>
  <li>加的索引生效没？</li>
  <li>mysql选错了索引吗？</li>
</ul>

<blockquote>
  <p>1.1 没加索引</p>
</blockquote>

<p>sql语句中 where 条件的关键字段，或者<code class="highlighter-rouge">order by </code>后面的排序字段，忘了加索引，这个问题在项目很常见。</p>

<p>项目开始的时候，由于表的数据量小，加不加索引sql查询性能差别不大，后来随着业务的发展，表中数据量越来越多，就不得不加索引了。</p>

<p>查看索引的命令</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- 查看order表的索引情况</span>
<span class="k">show</span> <span class="k">index</span> <span class="k">from</span> <span class="k">order</span><span class="p">;</span>
<span class="c1">-- 查看order表的建表语句</span>
<span class="k">show</span> <span class="k">create</span> <span class="k">table</span> <span class="k">order</span><span class="p">;</span>

</code></pre></div></div>

<p>添加索引</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- 在order表的name字段上添加索引</span>
<span class="k">alter</span> <span class="k">table</span> <span class="k">order</span> <span class="k">add</span> <span class="k">index</span> <span class="n">idx_name</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="c1">-- 或者</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">idx_name</span> <span class="k">on</span> <span class="k">order</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<p>这里有一个要注意的地方，要先删除旧索引，再重新添加新索引</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">`order`</span> <span class="k">DROP</span> <span class="k">INDEX</span> <span class="n">idx_name</span><span class="p">;</span>
<span class="c1">-- 或者</span>
<span class="k">DROP</span> <span class="k">INDEX</span> <span class="n">idx_name</span> <span class="k">ON</span> <span class="nv">`order`</span><span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>1.2 索引生效了没</p>
</blockquote>

<p>如何查看索引有没有生效，可以使用<code class="highlighter-rouge">explain</code>命令来查看mysql的执行计划，它会显示索引的使用情况</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="k">order</span> <span class="k">where</span> <span class="n">code</span> <span class="o">=</span> <span class="s1">'002'</span><span class="p">;</span>
</code></pre></div></div>

<p>结果：</p>

<p><img src="/assets/images/2022/springboot/mysql-explain.jpg" alt="" /></p>

<p>执行计划包含列的含义如下图所示：</p>

<p><img src="/assets/images/2022/springboot/mysql-explain-2.jpg" alt="" /></p>

<p>sql语句没有走索引，排除没有建索引之外，最大的可能性就是索引失效了，索引失效的常见原因：</p>

<p><img src="/assets/images/2022/springboot/mysql-explain-3.jpg" alt="" /></p>

<blockquote>
  <p>1.3 mysql选错索引</p>
</blockquote>

<p>此外，你有没有遇到过这样一种情况：明明是同一条sql，只有入参不同而已。有的时候走的索引a，有的时候却走的索引b？没错，有时候mysql会选错索引，有时可以使用<code class="highlighter-rouge">force index</code>来强制查询sql走某个索引。</p>

<h2 id="2sql优化">2、sql优化</h2>

<p>如果优化了索引之后，也没啥效果。</p>

<p>接下来试着优化一下sql语句，因为它的改造成本相对于java代码来说也要小得多。</p>

<p>下面给大家列举了sql优化的15个小技巧</p>

<p><img src="/assets/images/2021/mysql/optimize-sql.jpg" alt="" /></p>

<p>看博客文章<a href="/mysql/2021/11/11/sql-optimization.html">《sql优化的15个技巧》</a></p>

<h2 id="3远程调用">3、远程调用</h2>

<p>很多时候，我们需要在某个接口中，调用其他服务的接口。比如有这样的业务场景：</p>

<p>在用户信息查询接口中需要返回：用户名称、性别、等级、头像、积分、成长值等信息。</p>

<ul>
  <li>
    <p>而用户名称、性别、等级、头像在用户服务中</p>
  </li>
  <li>
    <p>积分在积分服务中</p>
  </li>
  <li>
    <p>成长值在成长值服务中</p>
  </li>
</ul>

<p>为了汇总这些数据统一返回，需要另外提供一个对外接口服务。</p>

<p>于是，用户信息查询接口需要调用用户查询接口、积分查询接口 和 成长值查询接口，然后汇总数据统一返回。</p>

<p>调用过程如下图所示：</p>

<p><img src="/assets/images/2022/springboot/feign-other-service.jpg" alt="" /></p>

<p>调用远程接口总耗时 530ms = 200ms + 150ms + 180ms</p>

<p>显然这种串行调用远程接口性能是非常不好的，调用远程接口总的耗时为所有的远程接口耗时之和。</p>

<p>那么如何优化远程接口性能呢？</p>

<h3 id="并行调用">并行调用</h3>

<p><img src="/assets/images/2022/springboot/feign-other-service-2.jpg" alt="" /></p>

<p>调用远程接口总耗时 200ms = 200ms（即耗时最长的那次远程接口调用）</p>

<p>在java8之前可以通过实现<code class="highlighter-rouge">Callable</code>接口，获取线程返回结果。</p>

<p>java8以后通过<code class="highlighter-rouge">CompleteFuture</code>类实现该功能。我们这里以CompleteFuture为例：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">UserInfo</span> <span class="nf">getUserInfo</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span><span class="o">,</span> <span class="nc">ExecutionException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">UserInfo</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserInfo</span><span class="o">();</span>
    <span class="nc">CompletableFuture</span> <span class="n">userFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">getRemoteUserAndFill</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">userInfo</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">;</span>
    <span class="o">},</span> <span class="n">executor</span><span class="o">);</span>

    <span class="nc">CompletableFuture</span> <span class="n">bonusFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">getRemoteBonusAndFill</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">userInfo</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">;</span>
    <span class="o">},</span> <span class="n">executor</span><span class="o">);</span>

    <span class="nc">CompletableFuture</span> <span class="n">growthFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">getRemoteGrowthAndFill</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">userInfo</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">;</span>
    <span class="o">},</span> <span class="n">executor</span><span class="o">);</span>
    <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">userFuture</span><span class="o">,</span> <span class="n">bonusFuture</span><span class="o">,</span> <span class="n">growthFuture</span><span class="o">).</span><span class="na">join</span><span class="o">();</span>

    <span class="n">userFuture</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="n">bonusFuture</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="n">growthFuture</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">userInfo</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="数据异构">数据异构</h3>

<p>上面说到的用户信息查询接口需要调用用户查询接口、积分查询接口 和 成长值查询接口，然后汇总数据统一返回。</p>

<p>那么，我们能不能把数据冗余一下，把用户信息、积分和成长值的数据统一存储到一个地方，比如：redis，存的数据结构就是用户信息查询接口所需要的内容。然后通过用户id，直接从redis中查询数据出来，不就OK了？</p>

<p>如果在高并发的场景下，为了提升接口性能，远程接口调用大概率会被去掉，而改成保存冗余数据的数据异构方案。</p>

<p><img src="/assets/images/2022/springboot/redis-cache.jpg" alt="" /></p>

<p><mark>注意：</mark>可能会出现数据库与缓存不一致的问题，一般是先更新数据库后删除缓存，redis要设置一个过期时间，</p>

<p>mysql与redis如何保证数据一致性，<a href="/mysql/2021/03/25/update-db-or-cache-first.html">/mysql/2021/03/25/update-db-or-cache-first.html</a></p>

<h2 id="4重复调用">4、重复调用</h2>

<p><code class="highlighter-rouge">重复调用</code>在我们的日常工作代码中可以说随处可见，但如果没有控制好，会非常影响接口的性能。</p>

<p>不信，我们一起看看。</p>

<h3 id="循环查数据库">循环查数据库</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">queryUser</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">searchList</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">searchList</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>
    <span class="n">searchList</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">user</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userMapper</span><span class="o">.</span><span class="na">getUserById</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">())));</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里如果有50个用户，则需要循环50次，去查询数据库。我们都知道，每查询一次数据库，就是一次远程调用。查询50次数据库，这是非常耗时的操作。</p>

<p>那么，我们如何优化？</p>

<p>具体代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">queryUser</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">searchList</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">searchList</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">searchList</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">User:</span><span class="o">:</span><span class="n">getId</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">getUserByIds</span><span class="o">(</span><span class="n">ids</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>提供一个根据用户id集合批量查询用户的接口，只远程调用一次，就能查询出所有的数据。</p>

<blockquote>
  <p>这里有个需要注意的地方是：id集合的大小要做限制，最好一次不要请求太多的数据。要根据实际情况而定，建议控制每次请求的记录条数在500以内。</p>
</blockquote>

<h3 id="死循环">死循环</h3>

<p>代码中不是应该避免死循环吗？为啥还是会产生死循环？</p>

<p>有时候死循环是我们自己写的，例如下面这段代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">condition</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"do samething"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里使用了while(true)的循环调用，这种写法在<code class="highlighter-rouge">CAS自旋锁</code>中使用比较多。</p>

<p>当满足condition等于true的时候，则自动退出该循环</p>

<p>如果condition条件非常复杂，一旦出现判断不正确，或者少写了一些逻辑判断，就可能在某些场景下出现死循环的问题</p>

<blockquote>
  <p>还有一种隐藏的比较深的死循环，是由于代码写的不太严谨导致的。如果用正常数据，可能测不出问题，但一旦出现异常数据，就会立即出现死循环。</p>
</blockquote>

<h3 id="无限递归">无限递归</h3>

<p>如果想要打印某个分类的所有父分类，可以用类似这样的递归方法实现：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">printCategory</span><span class="o">(</span><span class="nc">Category</span> <span class="n">category</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span><span class="o">(</span><span class="n">category</span> <span class="o">==</span> <span class="kc">null</span> 
      <span class="o">||</span> <span class="n">category</span><span class="o">.</span><span class="na">getParentId</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span> 
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"父分类名称："</span><span class="o">+</span> <span class="n">category</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
  <span class="nc">Category</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">categoryMapper</span><span class="o">.</span><span class="na">getCategoryById</span><span class="o">(</span><span class="n">category</span><span class="o">.</span><span class="na">getParentId</span><span class="o">());</span>
  <span class="n">printCategory</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>正常情况下，这段代码是没有问题的。</p>

<p>但如果某次有人误操作，把某个分类的parentId指向了它自己，这样就会出现无限递归的情况。导致接口一直不能返回数据，最终会发生堆栈溢出。<mark>所以，要判断parentId不能是自己，否则就抛业务异常，来避免无限递归</mark></p>

<blockquote>
  <p>建议写递归方法时，设定一个递归的深度，比如：分类最大等级有4级，则深度可以设置为4。然后在递归方法中做判断，如果深度大于4时，则自动返回，这样就能避免无限循环的情况。</p>
</blockquote>

<h2 id="5异步处理">5、异步处理</h2>

<p>有时候，我们接口性能优化，需要重新梳理一下业务逻辑，看看是否有设计上的不太合理的地方，比如有个用户请求接口中，需要做业务操作，发站内通知，和记录操作日志。为了实现起来比较方便，通常我们会将这些逻辑放在接口中同步执行，势必会对接口性能造成一定的影响。</p>

<p><img src="/assets/images/2022/springboot/async.jpg" alt="" /></p>

<p>仔细梳理一下，发现只有业务操作才是<code class="highlighter-rouge">核心逻辑</code>,其他功能都是<code class="highlighter-rouge">非核心逻辑</code></p>

<blockquote>
  <p>在这里有个原则就是：核心逻辑可以同步执行，同步写库。非核心逻辑，可以异步执行，异步写库。</p>
</blockquote>

<p>通常异步主要有两种解决方案：<code class="highlighter-rouge">多线程</code>和<code class="highlighter-rouge">mq</code></p>

<h3 id="线程池">线程池</h3>

<p>使用<code class="highlighter-rouge">线程池</code>改造之后，接口逻辑如下：</p>

<p><img src="/assets/images/2022/springboot/async-2.jpg" alt="" /></p>

<p>发站内通知和用户操作日志功能，被提及到两个单独的线程池中。</p>

<p>这样接口重点关注的是业务操作，把其他的逻辑交给线程异步执行，这样改造之后，让接口性能瞬间提升了。</p>

<p><strong>但线程池有个问题</strong></p>

<ul>
  <li>服务器重启，线程池里的任务都会丢失</li>
  <li>被执行的功能异常，无法重试，无法丢失。</li>
</ul>

<p>这个问题使用MQ改造，可以解决</p>

<h3 id="mq">MQ</h3>

<p>使用<code class="highlighter-rouge">MQ</code>改造之后，接口逻辑如下</p>

<p><img src="https://mmbiz.qpic.cn/mmbiz_png/ibJZVicC7nz5hq0iaKg80FgbtoMf7wY5zmvQ3FrvLJETJGpgeUfCjqWXymLqtl89avXvfc3QjRxJQupxLQd2n5Mqg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" /><img src="/assets/images/2022/springboot/async-mq.jpg" alt="" /></p>

<p>对于发站内通知和用户操作日志功能，在接口中并没真正实现，它只发送了mq消息到mq服务器。然后由mq消费者消费消息时，才真正的执行这两个功能。</p>

<p>这样改造之后，接口性能同样提升了，因为发送mq消息速度是很快的，我们只需关注业务操作的代码即可。</p>

<h2 id="6避免大事务">6、避免大事务</h2>

<p>很多小伙伴在使用spring框架开发项目时，为了方便，喜欢使用<code class="highlighter-rouge">@Transactional</code>注解提供事务功能。</p>

<p>没错，使用@Transactional注解这种声明式事务的方式提供事务功能，确实能少写很多代码，提升开发效率。</p>

<p>但也容易造成大事务，引发其他的问题。下面用一张图看看大事务引发的问题。</p>

<p><img src="/assets/images/2022/springboot/big-transaction-problem.jpg" alt="" /></p>

<p>从图中能够看出，大事务问题可能会造成接口超时，我们该如何优化大事务？</p>

<ul>
  <li>少用@Transactional注解，使用编程式事务替代；</li>
  <li>将select查询方法放到事务外</li>
  <li>事务中避免远程调用</li>
  <li>
    <font color="red">事务中避免一次性处理太多数据</font>
  </li>
  <li>有些功能可以非事务执行</li>
  <li>有些功能可以异步处理</li>
</ul>

<h2 id="7锁粒度">7、锁粒度</h2>

<p>在某些业务场景中，为了防止多个线程并发修改某个共享数据，造成数据异常，我们会<mark>加锁</mark></p>

<p>但如果锁加得不好，导致锁的粒度太粗，也会非常影响接口性能。</p>

<h3 id="synchronzied">synchronzied</h3>

<p>Java中提供了<code class="highlighter-rouge">synchronzied</code>关键字给我们的代码加锁，通常有两种写法：</p>

<ul>
  <li><mark>在方法上加锁</mark></li>
  <li><mark>在代码上加锁</mark></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">synchronized</span> <span class="nf">doSave</span><span class="o">(</span><span class="nc">String</span> <span class="n">fileUrl</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mkdir</span><span class="o">();</span>
    <span class="n">uploadFile</span><span class="o">(</span><span class="n">fileUrl</span><span class="o">);</span>
    <span class="n">sendMessage</span><span class="o">(</span><span class="n">fileUrl</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里加锁的目的是为了防止并发的情况下，创建了相同的目录，第二次会创建失败，影响业务功能。</p>

<p>但这种直接在方法上加锁，锁的粒度有点粗。因为doSave方法中的上传文件和发消息方法，是不需要加锁的。只有创建目录方法，才需要加锁。</p>

<p>我们都知道文件上传操作是非常耗时的，如果将整个方法加锁，那么需要等到整个方法执行完之后才能释放锁。显然，这会导致该方法的性能很差，变得得不偿失。</p>

<p>这时，我们可以改成在代码块上加锁了，具体代码如下</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSave</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span><span class="nc">String</span> <span class="n">fileUrl</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span><span class="o">(!</span><span class="n">exists</span><span class="o">(</span><span class="n">path</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">mkdir</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
       <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">uploadFile</span><span class="o">(</span><span class="n">fileUrl</span><span class="o">);</span>
    <span class="n">sendMessage</span><span class="o">(</span><span class="n">fileUrl</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>当然，这种做在单机版的服务中，是没有问题的。但现在部署的生产环境，为了保证服务的稳定性，一般情况下，同一个服务会被部署在多个节点中。如果哪天挂了一个节点，其他的节点服务任然可用。</p>

<p>多节点部署避免了因为某个节点挂了，导致服务不可用的情况。同时也能分摊整个系统的流量，避免系统压力过大。</p>

<p>同时它也带来了新的问题：synchronized只能保证一个节点加锁是有效的，但如果有多个节点如何加锁呢?</p>

<p>答：这就需要使用：<code class="highlighter-rouge">分布式锁</code>了。目前主流的分布式锁包括：redis分布式锁、zookeeper分布式锁 和 数据库分布式锁。</p>

<p>由于zookeeper分布式锁的性能不太好，真实业务场景用的不多，这里先不讲。</p>

<p>下面聊一下redis分布式锁。</p>

<h3 id="redis分布式锁">redis分布式锁</h3>

<p>在分布式系统中，由于redis分布式锁相对于更简单和高效，成为了分布式锁的首先，被我们用到了很多实际业务场景当中。</p>

<p>使用redis分布式锁的伪代码如下</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSave</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span><span class="nc">String</span> <span class="n">fileUrl</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">requestId</span><span class="o">,</span> <span class="s">"NX"</span><span class="o">,</span> <span class="s">"PX"</span><span class="o">,</span> <span class="n">expireTime</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="s">"OK"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">if</span><span class="o">(!</span><span class="n">exists</span><span class="o">(</span><span class="n">path</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">mkdir</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
         <span class="n">uploadFile</span><span class="o">(</span><span class="n">fileUrl</span><span class="o">);</span>
         <span class="n">sendMessage</span><span class="o">(</span><span class="n">fileUrl</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
      <span class="n">unlock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span><span class="n">requestId</span><span class="o">);</span>
  <span class="o">}</span>  
  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>跟之前使用<code class="highlighter-rouge">synchronized</code>关键字加锁时一样，这里锁的范围也太大了，换句话说就是锁的粒度太粗，这样会导致整个方法的执行效率很低。</p>

<p>其实只有创建目录的时候，才需要加分布式锁，其余代码根本不用加锁。</p>

<p>于是，我们需要优化一下代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSave</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span><span class="nc">String</span> <span class="n">fileUrl</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tryLock</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">mkdir</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="n">uploadFile</span><span class="o">(</span><span class="n">fileUrl</span><span class="o">);</span>
   <span class="n">sendMessage</span><span class="o">(</span><span class="n">fileUrl</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span> <span class="n">requestId</span><span class="o">,</span> <span class="s">"NX"</span><span class="o">,</span> <span class="s">"PX"</span><span class="o">,</span> <span class="n">expireTime</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="s">"OK"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
      <span class="n">unlock</span><span class="o">(</span><span class="n">lockKey</span><span class="o">,</span><span class="n">requestId</span><span class="o">);</span>
  <span class="o">}</span>  
  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>上面代码将加锁的范围缩小了，只有创建目录时才加了锁。这样看似简单的优化之后，接口性能能提升很多。说不定，会有意外的惊喜喔。哈哈哈。</p>

<p>redis分布式锁虽说好用，但它在使用时，有很多注意的细节，隐藏了很多坑，如果稍不注意很容易踩中，注意锁超时、锁续命的问题。</p>

<h3 id="数据库分布式锁">数据库分布式锁</h3>

<p>mysql数据库中主要有三种锁：</p>

<ul>
  <li>表锁：加锁快，不会出现死锁。但锁定粒度大，发生锁冲突的概率最高，并发度最低。</li>
  <li>行锁：加锁慢，会出现死锁。但锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</li>
  <li>间隙锁：开销和加锁时间界于表锁和行锁之间。它会出现死锁，锁定粒度界于表锁和行锁之间，并发度一般。</li>
</ul>

<p>并发度越高，意味着接口性能越好。</p>

<p>所以数据库锁的优化方向是：</p>

<p>优先使用<code class="highlighter-rouge">行锁</code>，其次使用<code class="highlighter-rouge">间隙锁</code>，再其次使用<code class="highlighter-rouge">表锁</code>。</p>

<h2 id="8分页处理">8、分页处理</h2>

<p>有时候我会调用某个接口批量查询数据，比如：通过用户id批量查询出用户信息，然后给这些用户送积分。</p>

<p>但如果你一次性查询的用户数量太多了，比如一次查询2000个用户的数据。参数中传入了2000个用户的id，远程调用接口，会发现该用户查询接口经常超时。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">remoteCallUser</span><span class="o">(</span><span class="n">ids</span><span class="o">);</span>
</code></pre></div></div>

<p>调用接口从数据库获取数据，是需要经过网络传输的。如果数据量太大，无论是获取数据的速度，还是网络传输受限于带宽，都会导致耗时时间比较长。</p>

<p>这种情况要如何优化？<mark>分页处理</mark></p>

<p>将一次获取所有的数据的请求，改成分多次获取，每次只获取一部分用户的数据，最后进行合并和汇总。</p>

<p>处理这个问题，我们要分两种场景：同步调用 和 异步调用</p>

<h3 id="同步调用">同步调用</h3>

<p>如果在<code class="highlighter-rouge">job</code>中需要获取2000个用户的信息，它要求只要能正确获取到数据就好，对获取数据的总耗时要求不太高。</p>

<p>但对每一次远程接口调用的耗时有要求，不能大于500ms，不然会有邮件预警。</p>

<p>这时，我们可以同步分页调用批量查询用户信息接口。代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;&gt;</span> <span class="n">allIds</span> <span class="o">=</span> <span class="nc">Lists</span><span class="o">.</span><span class="na">partition</span><span class="o">(</span><span class="n">ids</span><span class="o">,</span><span class="mi">200</span><span class="o">);</span>

<span class="k">for</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="nl">batchIds:</span><span class="n">allIds</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">remoteCallUser</span><span class="o">(</span><span class="n">batchIds</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>代码中我用的<code class="highlighter-rouge">google</code>的<code class="highlighter-rouge">guava</code>工具中的<code class="highlighter-rouge">Lists.partition</code>方法，用它来做分页简直太好用了。</p>

<h3 id="异步调用">异步调用</h3>

<p>如果是在<code class="highlighter-rouge">某个接口</code>中需要获取2000个用户的信息，它考虑的就需要更多一些。</p>

<p>除了需要考虑远程调用接口的耗时之外，还需要考虑该接口本身的总耗时，也不能超时500ms。只能使用异步调用了，代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;&gt;</span> <span class="n">allIds</span> <span class="o">=</span> <span class="nc">Lists</span><span class="o">.</span><span class="na">partition</span><span class="o">(</span><span class="n">ids</span><span class="o">,</span><span class="mi">200</span><span class="o">);</span>

<span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>
<span class="n">allIds</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">forEach</span><span class="o">((</span><span class="n">batchIds</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
   <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">remoteCallUser</span><span class="o">(</span><span class="n">batchIds</span><span class="o">));</span>
        <span class="k">return</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">;</span>
    <span class="o">},</span> <span class="n">executor</span><span class="o">);</span>
<span class="o">})</span>
</code></pre></div></div>

<p>使用CompletableFuture类，多个线程异步调用远程接口，最后汇总结果统一返回。executor是自定义的线程池。</p>

<h2 id="9加缓存">9、加缓存</h2>

<p>解决接口性能问题，<code class="highlighter-rouge">加缓存</code>是一个非常高效的方法。</p>

<p>但不能为了缓存而缓存，还是要看具体的业务场景。毕竟加了缓存，会导致接口的复杂度增加，同时也会带来数据不一致的问题。</p>

<p>比如商城首页显示商品分类的地方，假设分类的调用接口获取的数据，就可以使用缓存。</p>

<h3 id="redis缓存">redis缓存</h3>

<p>通常情况下，我们使用最多的缓存可能是：<code class="highlighter-rouge">redis</code>和<code class="highlighter-rouge">memcached</code>。后者适合单体应用，</p>

<p>由于在关系型数据库，比如：mysql中，菜单是有上下级关系的。某个四级分类是某个三级分类的子分类，这个三级分类，又是某个二级分类的子分类，而这个二级分类，又是某个一级分类的子分类。</p>

<p>这种存储结构决定了，想一次性查出这个分类树，并非是一件非常容易的事情。这就需要使用程序递归查询了，如果分类多的话，这个递归是比较耗时的。</p>

<p>所以，如果每次都直接从数据库中查询分类树的数据，是一个非常耗时的操作。</p>

<p>这时我们可以使用缓存，大部分情况，接口都直接从缓存中获取数据。操作redis可以使用成熟的框架，比如：jedis和redisson等。</p>

<p>伪代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
<span class="k">if</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">json</span><span class="o">))</span> <span class="o">{</span>
   <span class="nc">CategoryTree</span> <span class="n">categoryTree</span> <span class="o">=</span> <span class="nc">JsonUtil</span><span class="o">.</span><span class="na">toObject</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
   <span class="k">return</span> <span class="n">categoryTree</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">return</span> <span class="nf">queryCategoryTreeFromDb</span><span class="o">();</span>
</code></pre></div></div>

<p>先从redis中根据某个key查询是否有菜单数据，如果有则转换成对象，直接返回。如果redis中没有查到菜单数据，则再从数据库中查询菜单数据，有则返回。</p>

<p>此外，我们还需要有个job每隔一段时间，从数据库中查询菜单数据，更新到redis当中，这样以后每次都能直接从redis中获取菜单的数据，而无需访问数据库了。如果菜单修改了，应该删除缓存，</p>

<p><img src="/assets/images/2022/springboot/redis-cache-2.jpg" alt="" /></p>

<h3 id="二级缓存">二级缓存</h3>

<p>上面的方案基于redis缓存的，虽说redis访问速度很快。但毕竟是一个远程调用，而且菜单树的数据很多，在网络传输的过程中，是有些耗时的。</p>

<p>有没有办法，不经过请求远程，就能直接获取到数据呢？</p>

<p>使用<mark>二级缓存，基于内存的缓存</mark></p>

<p>目前使用比较多的内存缓存框架有：guava、Ehcache、caffine等。</p>

<p>我们在这里以<code class="highlighter-rouge">caffeine</code>为例，它是spring官方推荐的。</p>

<p>1、引入依赖包</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-cache<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.github.ben-manes.caffeine<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>caffeine<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.6.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、配置CacheManager，开启EnableCaching</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableCaching</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">CacheManager</span> <span class="nf">cacheManager</span><span class="o">(){</span>
        <span class="nc">CaffeineCacheManager</span> <span class="n">cacheManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CaffeineCacheManager</span><span class="o">();</span>
        <span class="c1">//Caffeine配置</span>
        <span class="nc">Caffeine</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">caffeine</span> <span class="o">=</span> <span class="nc">Caffeine</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
                <span class="c1">//最后一次写入后经过固定时间过期</span>
                <span class="o">.</span><span class="na">expireAfterWrite</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
                <span class="c1">//缓存的最大条数</span>
                <span class="o">.</span><span class="na">maximumSize</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="n">cacheManager</span><span class="o">.</span><span class="na">setCaffeine</span><span class="o">(</span><span class="n">caffeine</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">cacheManager</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3、使用Cacheable注解获取数据</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CategoryService</span> <span class="o">{</span>
   
   <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"category"</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#categoryKey"</span><span class="o">)</span>
   <span class="kd">public</span> <span class="nc">CategoryModel</span> <span class="nf">getCategory</span><span class="o">(</span><span class="nc">String</span> <span class="n">categoryKey</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">categoryKey</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">json</span><span class="o">))</span> <span class="o">{</span>
         <span class="nc">CategoryTree</span> <span class="n">categoryTree</span> <span class="o">=</span> <span class="nc">JsonUtil</span><span class="o">.</span><span class="na">toObject</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
         <span class="k">return</span> <span class="n">categoryTree</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="nf">queryCategoryTreeFromDb</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>调用categoryService.getCategory()方法时，先从caffine缓存中获取数据，如果能够获取到数据，则直接返回该数据，不进入方法体。</p>

<p>如果不能获取到数据，则再从redis中查一次数据。如果查询到了，则返回数据，并且放入caffine中。</p>

<p>具体流程图如下：</p>

<p><img src="/assets/images/2022/springboot/caffine-cache.jpg" alt="" /></p>

<p>该方案的性能更好，但有个缺点就是，如果数据更新了，不能及时刷新缓存。此外，如果有多台服务器节点，可能存在各个节点上数据不一样的情况。上面的代码中，caffine 缓存的过期时间是10秒，也就是说可能存在10秒内的数据不一致的情况。</p>

<p>由此可见，二级缓存给我们带来性能提升的同时，也带来了数据不一致的问题。使用二级缓存一定要结合实际的业务场景，并非所有的业务场景都适用。</p>

<p>但上面我列举的分类场景，是适合使用二级缓存的。因为它属于用户不敏感数据，即使出现了短暂的有点数据不一致也没有关系，用户有可能都没有察觉出来。</p>

<h2 id="10分库分表">10、分库分表</h2>

<p>有时候，接口性能受限的不是别的，而是数据库。</p>

<p>当系统发展到一定的阶段，用户并发量大，会有大量的数据库请求，需要占用大量的数据库连接，同时会带来磁盘IO的性能瓶颈问题。</p>

<p>此外，随着用户数量越来越多，产生的数据也越来越多，一张表有可能存不下。由于数据量太大，sql语句查询数据时，即使走了索引也会非常耗时。</p>

<p>这时该怎么办呢？</p>

<p>需要做<mark>分库分表</mark>，如下图所示：</p>

<p><img src="/assets/images/2022/springboot/distribute-db-tables.jpg" alt="" /></p>

<p>图中将用户库拆分成了三个库，每个库都包含了四张用户表。</p>

<p>如果有用户请求过来的时候，先根据用户id路由到其中一个用户库，然后再定位到某张表。</p>

<p>路由的算法挺多的：</p>

<ul>
  <li><code class="highlighter-rouge">根据id取模</code>，比如：id=7，有4张表，则7%4=3，模为3，路由到用户表3。</li>
  <li><code class="highlighter-rouge">给id指定一个区间范围</code>，比如：id的值是0-10万，则数据存在用户表0，id的值是10-20万，则数据存在用户表1。</li>
  <li><code class="highlighter-rouge">一致性hash算法</code></li>
</ul>

<p>分库分表主要有两个方向：<code class="highlighter-rouge">垂直</code>和<code class="highlighter-rouge">水平</code>。肯定是先垂直后水平的，垂直就是将表结构拆分为多个表，减少大表的字段数。可以这样总结：</p>

<ul>
  <li>垂直方向，即根据业务拆分表结构</li>
  <li>水平方向，数据方向上进行切分，把数据切分到多个数据库多个表上，所有的表数据才是一个完整的数据。</li>
</ul>

<p>目的：</p>

<ul>
  <li><strong>分库</strong>：是为了解决数据库连接资源不足问题，和磁盘IO的性能瓶颈问题。</li>
  <li><strong>分表</strong>：是为了解决单表数据量太大，sql语句查询数据时，即使走了索引也非常耗时问题。此外还可以解决消耗cpu资源问题。</li>
  <li><strong>分库分表</strong>：可以解决 数据库连接资源不足、磁盘IO的性能瓶颈、检索数据耗时 和 消耗cpu资源等问题。</li>
</ul>

<p><mark>场景使用：</mark></p>

<p>如果在有些业务场景中，用户并发量很大，但是需要保存的数据量很少，这时可以只分库，不分表。</p>

<p>如果在有些业务场景中，用户并发量不大，但是需要保存的数量很多，这时可以只分表，不分库。</p>

<p>如果在有些业务场景中，用户并发量大，并且需要保存的数量也很多时，可以分库分表。</p>

<h2 id="11辅助功能">11、辅助功能</h2>

<p>优化接口性能问题，除了上面提到的这些常用方法之外，还需要配合使用一些辅助功能，因为它们真的可以帮我们提升查找问题的效率。</p>

<h3 id="开启慢查询日志">开启慢查询日志</h3>

<p>通常情况下，为了定位sql的性能瓶颈，我们需要开启mysql的慢查询日志。把超过指定时间的sql语句，单独记录下来，方面以后分析和定位问题。</p>

<p>开启慢查询日志需要重点关注三个参数：</p>

<ul>
  <li><code class="highlighter-rouge">slow_query_log</code> 慢查询开关</li>
  <li><code class="highlighter-rouge">slow_query_log_file</code> 慢查询日志存放的路径</li>
  <li><code class="highlighter-rouge">long_query_time</code> 超过多少秒才会记录日志</li>
</ul>

<p>通过mysql的<code class="highlighter-rouge">set</code>命令可以设置</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set </span>global <span class="nv">slow_query_log</span><span class="o">=</span><span class="s1">'ON'</span><span class="p">;</span> 
<span class="nb">set </span>global <span class="nv">slow_query_log_file</span><span class="o">=</span><span class="s1">'/usr/local/mysql/data/slow.log'</span><span class="p">;</span>
<span class="nb">set </span>global <span class="nv">long_query_time</span><span class="o">=</span>2<span class="p">;</span>
</code></pre></div></div>

<p>设置完之后，如果某条sql的执行时间超过了2秒，会被自动记录到slow.log文件中。</p>

<p>当然也可以直接修改配置文件<code class="highlighter-rouge">my.cnf</code></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>mysqld]
slow_query_log <span class="o">=</span> ON
slow_query_log_file <span class="o">=</span> /usr/local/mysql/data/slow.log
long_query_time <span class="o">=</span> 2
</code></pre></div></div>

<p>但这种方式需要重启mysql服务。</p>

<h3 id="加监控">加监控</h3>

<p>为了出现sql问题时，能够让我们及时发现，我们需要对系统做<code class="highlighter-rouge">监控</code>。</p>

<p>目前业界使用比较多的开源监控系统是：<code class="highlighter-rouge">Prometheus</code>。</p>

<p>它提供了 <code class="highlighter-rouge">监控</code> 和 <code class="highlighter-rouge">预警</code> 的功能。架构图如下：</p>

<p><img src="/assets/images/2022/springboot/prometheus-1.jpg" alt="" /></p>

<p>我们可以用它监控如下信息：</p>

<ul>
  <li>接口响应时间</li>
  <li>调用第三方服务耗时</li>
  <li>慢查询sql耗时</li>
  <li>cpu使用情况</li>
  <li>内存使用情况</li>
  <li>磁盘使用情况</li>
  <li>数据库使用情况</li>
</ul>

<p>它的界面大概长这样子：</p>

<p><img src="/assets/images/2022/springboot/prometheus-2.jpg" alt="" /></p>

<p>可以看到mysql当前qps，活跃线程数，连接数，缓存池的大小等信息。</p>

<p>如果发现数据量连接池占用太多，对接口的性能肯定会有影响。</p>

<p>这时可能是代码中开启了连接忘了关，或者并发量太大了导致的，需要做进一步排查和系统优化。</p>

<p>截图中只是它一小部分功能，如果你想了解更多功能，可以访问Prometheus的官网：<a href="https://prometheus.io/">https://prometheus.io/</a></p>

<h3 id="链路跟踪">链路跟踪</h3>

<p>有时候某个接口涉及的逻辑很多，比如：查数据库、查redis、远程调用接口，发mq消息，执行业务代码等等。</p>

<p>该接口一次请求的链路很长，如果逐一排查，需要花费大量的时间，这时候，我们已经没法用传统的办法定位问题了。</p>

<p>有没有办法解决这问题呢？</p>

<p>用分布式链路跟踪系统：<code class="highlighter-rouge">skywalking</code>。</p>

<p>它的架构图如下：</p>

<p><img src="/assets/images/2022/springboot/skywalking.jpg" alt="" /></p>

<p>通过skywalking定位性能问题：</p>

<p><img src="/assets/images/2022/springboot/skywalking-2.jpg" alt="" /></p>

<p>在skywalking中可以通过<code class="highlighter-rouge">traceId</code>（全局唯一的id），串联一个接口请求的完整链路。可以看到整个接口的耗时，调用的远程服务的耗时，访问数据库或者redis的耗时等等，功能非常强大。</p>

<p>之前没有这个功能的时候，为了定位线上接口性能问题，我们还需要在代码中加日志，手动打印出链路中各个环节的耗时情况，然后再逐一排查。</p>

<p>如果你用过skywalking排查接口性能问题，不自觉的会爱上它的。如果你想了解更多功能，可以访问skywalking的官网：<a href="https://skywalking.apache.org/">https://skywalking.apache.org/</a></p>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/springboot/2022/01/03/skill-to-optimize-your-api.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
