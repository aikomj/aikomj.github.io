<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 10w 级别Excel数据导入的优化记录 - 大伟的博客 </title>
    <meta name="keywords" content="springboot">
    <meta name="description"
          content="使用EasyExcel提升读取excel的性能，缓存数据库查询结果集HashMap匹配校验，insert批量插入，适当使用并行流优化插入速度，利用掉网络IO等待时间，避免循环打印无用日志,导入结果回写原excel文件提供下载，异步分页导出大量数据">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/springboot/2021/03/11/10w-line-excel-import.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="10w 级别Excel数据导入的优化记录">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>10w 级别Excel数据导入的优化记录</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2021/03/11
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1需求说明">1、需求说明</h2>

<p>项目中有一个 Excel 导入的需求：缴费记录导入，由用户将别的系统数据填入我们系统中的 Excel 模板，应用将文件内容读取、校对、转换之后产生欠费数据、票据、票据详情并存储到数据库中。</p>

<p>在我接手之前可能由于之前导入的数据量并不多没有对效率有过高的追求。但是到了 4.0 版本，我预估导入时Excel 行数会是 10w+ 级别，而往数据库插入的数据量是大于 3N 的，也就是说 10w 行的 Excel，则至少向数据库插入 30w 行数据。</p>

<p>因此优化原来的导入代码是势在必行的。我逐步分析和优化了导入的代码，使之在百秒内完成。最终性能瓶颈在数据库的处理速度上，测试服务器 4g 内存不仅放了数据库，还放了很多微服务应用，处理能力不太行，数据库永远是最脆弱的部分。</p>

<p>导入 Excel 的需求在系统中还是很常见的，我的优化办法可能不是最优的，具体过程如下</p>

<p><strong>细节</strong></p>

<ul>
  <li>
    <p>数据导入：导入使用的模板由系统提供，格式是 xlsx (支持 65535+行数据) ，用户按照表头在对应列写入相应的数据</p>
  </li>
  <li>
    <p>数据校验：数据校验有两种</p>

    <p>1) 字段长度、字段正则表达式校验等，内存内校验，不存在外部数据交互。对性能影响较小；</p>

    <p>2) 数据重复性校验，如票据号是否和系统已存在的票据号重复(需要查询数据库，十分影响性能)，解决方案对查询做缓存</p>
  </li>
  <li>
    <p>数据插入：测试环境数据库使用 MySQL 5.7，未分库分表，连接池使用 Druid</p>
  </li>
</ul>

<h2 id="2迭代记录">2、迭代记录</h2>

<h3 id="第一版poi">第一版POI</h3>

<blockquote>
  <p>POI + 逐行查询校对 + 逐行插入</p>
</blockquote>

<p>这个版本是最古老的版本，采用原生 POI，手动将 Excel 中的行映射成 ArrayList 对象，然后存储到 List ，一般程序员写的都是这个版本，代码执行的步骤如下：</p>

<ol>
  <li>手动读取 Excel 成 List</li>
  <li>循环遍历，在循环中进行以下步骤</li>
  <li>
    <p>a. 检验字段长度；</p>
  </li>
  <li>
    <p>b. 一些查询数据库的校验，比如校验当前行欠费对应的房屋是否在系统中存在，需要查询房屋表</p>
  </li>
  <li>
    <p>c. 写入当前行数据</p>
  </li>
  <li>返回执行结果，如果出错 / 校验不合格。则返回提示信息并回滚数据</li>
</ol>

<p>显而易见的，这样实现一定是赶工赶出来的，后续可能用的少也没有察觉到性能问题，但是它最多适用于个位数/十位数级别的数据。存在以下明显的问题：</p>

<ul>
  <li>查询数据库的校验对每一行数据都要查询一次数据库，应用访问数据库来回的网络IO次数被放大了 n 倍，时间也就放大了 n 倍</li>
  <li>写入数据也是逐行写入的，问题和上面的一样</li>
  <li>数据读取使用原生 POI，代码十分冗余，可维护性差。</li>
</ul>

<h3 id="第二版easypoi">第二版EasyPOI</h3>

<blockquote>
  <p>缓存数据库查询操作 + 批量插入</p>
</blockquote>

<p>针对第一版分析的三个问题，分别采用以下三个方法优化</p>

<ol>
  <li>
    <p>缓存数据，以空间换时间</p>

    <p>逐行查询数据库校验的时间成本主要在来回的网络IO中，优化方法也很简单。将参加校验的数据全部缓存到 HashMap 中。直接到 HashMap 去命中。</p>

    <p>例如：校验行中的房屋是否存在，原本是要用 区域 + 楼宇 + 单元 + 房号 去查询房屋表匹配房屋ID，查到则校验通过，生成的欠单中存储房屋ID，校验不通过则返回错误信息给用户。而房屋信息在导入欠费的时候是不会更新的。并且一个小区的房屋信息也不会很多(5000以内)因此我采用一条SQL，将该小区下所有的房屋以 <mark>区域/楼宇/单元/房号 作为 key，以 房屋ID 作为 value</mark>，存储到 HashMap 中，后续校验只需要在 HashMap 中命中。</p>

    <blockquote>
      <p>定义SessionMapper</p>
    </blockquote>

    <p>Mybatis 原生是不支持将查询到的结果直接写人一个 HashMap 中的，需要自定义 SessionMapper</p>

    <p>SessionMapper 中指定使用 MapResultHandler 处理 SQL 查询的结果集</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionMapper</span> <span class="kd">extends</span> <span class="nc">SqlSessionDaoSupport</span> <span class="o">{</span>
  <span class="nd">@Resource</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSqlSessionFactory</span><span class="o">(</span><span class="nc">SqlSessionFactory</span> <span class="n">sqlSessionFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">setSqlSessionFactory</span><span class="o">(</span><span class="n">sqlSessionFactory</span><span class="o">);</span>
  <span class="o">}</span>
   
  <span class="c1">// 区域楼宇单元房号 - 房屋ID</span>
  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">getHouseMapByAreaId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">areaId</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">MapResultHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapResultHandler</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">getSqlSession</span><span class="o">().</span><span class="na">select</span><span class="o">(</span><span class="nc">BaseUnitMapper</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()+</span><span class="s">".getHouseMapByAreaId"</span><span class="o">,</span> <span class="n">areaId</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="na">getMappedResults</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>  
</code></pre></div>    </div>

    <p>MapResultHandler 处理程序，将结果集放入 HashMap</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MapResultHandler</span> <span class="kd">implements</span> <span class="nc">ResultHandler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span> <span class="n">mappedResults</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">();</span>
   
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleResult</span><span class="o">(</span><span class="nc">ResultContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
        <span class="nc">Map</span> <span class="n">map</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">)</span><span class="n">context</span><span class="o">.</span><span class="na">getResultObject</span><span class="o">();</span>
        <span class="n">mappedResults</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"key"</span><span class="o">),</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"value"</span><span class="o">));</span>
    <span class="o">}</span>
   
    <span class="kd">public</span> <span class="nc">Map</span> <span class="nf">getMappedResults</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mappedResults</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>Mapper</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Mapper</span>
<span class="nd">@Repository</span> 
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BaseUnitMapper</span> <span class="o">{</span>
    <span class="c1">// 收费标准绑定 区域楼宇单元房号 - 房屋ID</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">getHouseMapByAreaId</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"areaId"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">areaId</span><span class="o">);</span>
<span class="o">}</span>   
</code></pre></div>    </div>

    <p>Mapper.xml</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"getHouseMapByAreaId"</span> <span class="na">resultMap=</span><span class="s">"mapResultLong"</span><span class="nt">&gt;</span>
    SELECT
        CONCAT( h.bulid_area_name, h.build_name, h.unit_name, h.house_num ) k,
        h.house_id v
    FROM
        base_house h
    WHERE
        h.area_id = #{areaId}
    GROUP BY
        h.house_id
<span class="nt">&lt;/select&gt;</span>
               
<span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">"mapResultLong"</span> <span class="na">type=</span><span class="s">"java.util.HashMap"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">"key"</span> <span class="na">column=</span><span class="s">"k"</span> <span class="na">javaType=</span><span class="s">"string"</span> <span class="na">jdbcType=</span><span class="s">"VARCHAR"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">"value"</span> <span class="na">column=</span><span class="s">"v"</span> <span class="na">javaType=</span><span class="s">"long"</span> <span class="na">jdbcType=</span><span class="s">"INTEGER"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>  
</code></pre></div>    </div>

    <p>之后在代码中调用 SessionMapper 类对应的方法即可。获取一个小区的房屋信息。</p>
  </li>
  <li>
    <p><strong>使用 values 批量插入</strong></p>

    <p>MySQL insert 语句支持使用 values (),(),() 的方式一次插入多行数据，通过 mybatis foreach 结合 java 集合可以实现批量插入，代码写法如下：</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">"insertList"</span><span class="nt">&gt;</span>
    insert into table(colom1, colom2)
    values
    <span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">"list"</span> <span class="na">item=</span><span class="s">"item"</span> <span class="na">index=</span><span class="s">"index"</span> <span class="na">separator=</span><span class="s">","</span><span class="nt">&gt;</span>
     ( #{item.colom1}, #{item.colom2})
    <span class="nt">&lt;/foreach&gt;</span>
<span class="nt">&lt;/insert&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>使用EasyPOI 读写Excel</p>

    <p>EasyPOI 采用基于注解的导入导出,修改注解就可以修改Excel，非常方便，代码维护起来也容易。</p>
  </li>
</ol>

<h3 id="第三版easyexcel">第三版EasyExcel</h3>

<p>第二版采用 EasyPOI 之后，对于几千、几万的 Excel 数据已经可以轻松导入了，不过耗时有点久(5W 数据 10分钟左右写入到数据库)不过由于后来导入的操作基本都是开发在一边看日志一边导入，也就没有进一步优化。但是好景不长，有新小区需要迁入，票据 Excel 有 41w 行，这个时候使用 EasyPOI 在开发环境跑直接就 OOM 了，增大 JVM 内存参数之后，虽然不 OOM 了，但是 CPU 占用 100% 20 分钟仍然未能成功读取全部数据。故在读取大 Excel 时需要再优化速度。莫非要我这个渣渣去深入 POI 优化了吗？别慌，先上 GITHUB 找找别的开源项目。这时阿里 EasyExcel 映入眼帘：</p>

<p><a href="/icoding-edu/2020/04/12/icoding-note-021.html">飞天班21节-企业项目研发poi实际应用</a></p>

<p><img src="\assets\images\2021\javabase\easyexcel.png" alt="" /></p>

<p>easyexcel重写了poi对07版Excel的解析，能够原本一个3M的excel用POI  sax依然需要100M左右内存降低到几M，并且再大的excel不会出现内存溢出。</p>

<p>github地址：<a href="https://github.com/alibaba/easyexcel">https://github.com/alibaba/easyexcel</a></p>

<p>官方文档：<a href="https://www.yuque.com/easyexcel/doc/easyexcel">https://www.yuque.com/easyexcel/doc/easyexcel</a></p>

<p>EasyExcel 采用和 EasyPOI 类似的注解方式读写 Excel，因此从 EasyPOI 切换过来很方便，分分钟就搞定了。也确实如阿里大神描述的：41w行、25列、45.5m 数据读取平均耗时 50s，因此对于大 Excel 建议使用 EasyExcel 读取。</p>

<p>springboot导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>easyexcel<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.0.5<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>demo示例根据官方例子快速开始就可以了，不难。</p>

<h3 id="easyexcel的高阶使用">EasyExcel的高阶使用</h3>

<p>EasyExcel和EasyPoi的使用非常类似，都是通过注解来控制导入导出。接下来我们以会员信息和订单信息的导入导出为例，分别实现下简单的单表导出和具有一对多关系的复杂导出。</p>

<ul>
  <li>
    <p><strong>简单导出</strong></p>

    <p>首先创建一个会员对象<code class="highlighter-rouge">Member</code>，封装会员信息，这里使用了EasyExcel的注解；</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="s">"ID"</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="s">"用户名"</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    
    <span class="nd">@ExcelIgnore</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="s">"昵称"</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">nickname</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="s">"出生日期"</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="nd">@DateTimeFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">birthday</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="s">"手机号"</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">phone</span><span class="o">;</span>
    
    <span class="nd">@ExcelIgnore</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">icon</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"性别"</span><span class="o">,</span> <span class="n">converter</span> <span class="o">=</span> <span class="nc">GenderConverter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">gender</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>@ExcelProperty：核心注解，<code class="highlighter-rouge">value</code>属性可用来设置表头名称，<code class="highlighter-rouge">converter</code>属性可以用来设置类型转换器；</li>
      <li>@ColumnWidth：用于设置表格列的宽度；</li>
      <li>@DateTimeFormat：用于设置日期转换格式。</li>
    </ul>

    <p>在EasyExcel中，如果你想实现枚举类型到字符串的转换（比如gender属性中，<code class="highlighter-rouge">0-&gt;男</code>，<code class="highlighter-rouge">1-&gt;女</code>），需要自定义转换器，下面为自定义的<code class="highlighter-rouge">GenderConverter</code>代码实现；</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenderConverter</span> <span class="kd">implements</span> <span class="nc">Converter</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">supportJavaTypeKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//对象属性类型</span>
        <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">CellDataTypeEnum</span> <span class="nf">supportExcelTypeKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//CellData属性类型</span>
        <span class="k">return</span> <span class="nc">CellDataTypeEnum</span><span class="o">.</span><span class="na">STRING</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">convertToJavaData</span><span class="o">(</span><span class="nc">ReadConverterContext</span><span class="o">&lt;?&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">//CellData转对象属性</span>
        <span class="nc">String</span> <span class="n">cellStr</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getReadCellData</span><span class="o">().</span><span class="na">getStringValue</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StrUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">cellStr</span><span class="o">))</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">"男"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cellStr</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="s">"女"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cellStr</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">WriteCellData</span><span class="o">&lt;?&gt;</span> <span class="n">convertToExcelData</span><span class="o">(</span><span class="nc">WriteConverterContext</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="c1">//对象属性转CellData</span>
        <span class="nc">Integer</span> <span class="n">cellValue</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cellValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">WriteCellData</span><span class="o">&lt;&gt;(</span><span class="s">""</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cellValue</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">WriteCellData</span><span class="o">&lt;&gt;(</span><span class="s">"男"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cellValue</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">WriteCellData</span><span class="o">&lt;&gt;(</span><span class="s">"女"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">WriteCellData</span><span class="o">&lt;&gt;(</span><span class="s">""</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>接下来我们在Controller中添加一个接口，用于导出会员列表到Excel，还需给响应头设置下载excel的属性，具体代码如下</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="nd">@Api</span><span class="o">(</span><span class="n">tags</span> <span class="o">=</span> <span class="s">"EasyExcelController"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"EasyExcel导入导出测试"</span><span class="o">)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/easyExcel"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EasyExcelController</span> <span class="o">{</span>
    <span class="nd">@SneakyThrows</span><span class="o">(</span><span class="nc">IOException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@ApiOperation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"导出会员列表Excel"</span><span class="o">)</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/exportMemberList"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportMemberList</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setExcelRespProp</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="s">"会员列表"</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">memberList</span> <span class="o">=</span> <span class="nc">LocalJsonUtil</span><span class="o">.</span><span class="na">getListFromJson</span><span class="o">(</span><span class="s">"json/members.json"</span><span class="o">,</span> <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">EasyExcel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">())</span>
                <span class="o">.</span><span class="na">head</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">excelType</span><span class="o">(</span><span class="nc">ExcelTypeEnum</span><span class="o">.</span><span class="na">XLSX</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sheet</span><span class="o">(</span><span class="s">"会员列表"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">doWrite</span><span class="o">(</span><span class="n">memberList</span><span class="o">);</span>
    <span class="o">}</span>
      
  <span class="cm">/**
   * 设置excel下载响应头属性
   */</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setExcelRespProp</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">String</span> <span class="n">rawFileName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UnsupportedEncodingException</span> <span class="o">{</span>
    <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span><span class="o">);</span>
    <span class="n">response</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="nc">URLEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">rawFileName</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\+"</span><span class="o">,</span> <span class="s">"%20"</span><span class="o">);</span>
    <span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Content-disposition"</span><span class="o">,</span> <span class="s">"attachment;filename*=utf-8''"</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s">".xlsx"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>运行项目，通过Swagger测试接口，注意在Swagger中访问接口无法直接下载，需要点击返回结果中的<code class="highlighter-rouge">下载按钮</code>才行，访问地址：http://localhost:8088/swagger-ui/</p>

    <p><img src="/assets/images/2022/springboot/easyexcel-1.png" alt="" /></p>

    <p>下载完成后，查看下文件，一个标准的Excel文件已经被导出了</p>
  </li>
  <li>
    <p><strong>简单导入</strong></p>

    <p>在Controller中添加会员信息导入的接口，这里需要注意的是使用<code class="highlighter-rouge">@RequestPart</code>注解修饰文件上传参数，否则在Swagger中就没法显示上传按钮了；</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="nd">@Api</span><span class="o">(</span><span class="n">tags</span> <span class="o">=</span> <span class="s">"EasyExcelController"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"EasyExcel导入导出测试"</span><span class="o">)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/easyExcel"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EasyExcelController</span> <span class="o">{</span>
      
    <span class="nd">@SneakyThrows</span>
    <span class="nd">@ApiOperation</span><span class="o">(</span><span class="s">"从Excel导入会员列表"</span><span class="o">)</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/importMemberList"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="nc">CommonResult</span> <span class="nf">importMemberList</span><span class="o">(</span><span class="nd">@RequestPart</span><span class="o">(</span><span class="s">"file"</span><span class="o">)</span> <span class="nc">MultipartFile</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">memberList</span> <span class="o">=</span> <span class="nc">EasyExcel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">())</span>
                <span class="o">.</span><span class="na">head</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sheet</span><span class="o">()</span>
                <span class="o">.</span><span class="na">doReadSync</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">CommonResult</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">memberList</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>然后在Swagger中测试接口，选择之前导出的Excel文件即可，导入成功后会返回解析到的数据。</p>

    <p><img src="/assets/images/2022/springboot/easyexcel-2.png" alt="" /></p>
  </li>
  <li>
    <p><strong>复杂导出</strong></p>

    <p>使用EasyPoi实现，由于EasyPoi本来就支持嵌套对象的导出，直接使用内置的<code class="highlighter-rouge">@ExcelCollection</code>注解即可实现，非常方便也符合面向对象的思想。</p>

    <p><img src="/assets/images/2022/springboot/easyexcel-3.png" alt="" /></p>

    <blockquote>
      <p>由于EasyExcel本身并不支持这种一对多的信息导出，所以我们得自行实现下，这里分享一个我平时常用的<code class="highlighter-rouge">快速查找解决方案</code>的办法。</p>
    </blockquote>

    <p>我们可以直接从开源项目的<code class="highlighter-rouge">issues</code>里面去搜索，比如搜索下<code class="highlighter-rouge">一对多</code>，会直接找到<code class="highlighter-rouge">有无一对多导出比较优雅的方案</code>这个issue。</p>

    <p><img src="/assets/images/2022/springboot/easyexcel-4.png" alt="" /></p>
  </li>
</ul>

<p>从此issue的回复我们可以发现，项目维护者建议<code class="highlighter-rouge">创建自定义合并策略</code>来实现，有位回复的老哥已经给出了实现代码，接下来我们就用这个方案来实现下。</p>

<p><img src="/assets/images/2022/springboot/easyexcel-5.png" alt="" /></p>

<p><strong>解决思路</strong></p>

<p>为什么自定义单元格合并策略能实现一对多的列表信息的导出呢？首先我们来看下将嵌套数据平铺，不进行合并导出的Excel。</p>

<p><img src="/assets/images/2022/springboot/easyexcel-6.png" alt="" /></p>

<p>看完之后我们很容易理解解决思路，只要把<code class="highlighter-rouge">订单ID</code>相同的列中需要合并的列给合并了，就可以实现这种一对多嵌套信息的导出了。</p>

<blockquote>
  <p>实现过程</p>
</blockquote>

<ul>
  <li>
    <p>首先我们得把原来嵌套的订单商品信息给平铺了，创建一个专门的导出对象<code class="highlighter-rouge">OrderData</code>，包含订单和商品信息，二级表头可以通过设置<code class="highlighter-rouge">@ExcelProperty</code>的value为数组来实现；</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderData</span> <span class="o">{</span>
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"订单ID"</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
    <span class="nd">@CustomMerge</span><span class="o">(</span><span class="n">needMerge</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">isPk</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"订单编码"</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="nd">@CustomMerge</span><span class="o">(</span><span class="n">needMerge</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">orderSn</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"创建时间"</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="nd">@DateTimeFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd"</span><span class="o">)</span>
    <span class="nd">@CustomMerge</span><span class="o">(</span><span class="n">needMerge</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">createTime</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"收货地址"</span><span class="o">)</span>
    <span class="nd">@CustomMerge</span><span class="o">(</span><span class="n">needMerge</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">receiverAddress</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="s">"商品信息"</span><span class="o">,</span> <span class="s">"商品编码"</span><span class="o">})</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">productSn</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="s">"商品信息"</span><span class="o">,</span> <span class="s">"商品名称"</span><span class="o">})</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="s">"商品信息"</span><span class="o">,</span> <span class="s">"商品标题"</span><span class="o">})</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">30</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">subTitle</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="s">"商品信息"</span><span class="o">,</span> <span class="s">"品牌名称"</span><span class="o">})</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">brandName</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="s">"商品信息"</span><span class="o">,</span> <span class="s">"商品价格"</span><span class="o">})</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">BigDecimal</span> <span class="n">price</span><span class="o">;</span>
    
    <span class="nd">@ExcelProperty</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="s">"商品信息"</span><span class="o">,</span> <span class="s">"商品数量"</span><span class="o">})</span>
    <span class="nd">@ColumnWidth</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">count</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>然后将原来嵌套的<code class="highlighter-rouge">Order</code>对象列表转换为<code class="highlighter-rouge">OrderData</code>对象列表；</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="nd">@Api</span><span class="o">(</span><span class="n">tags</span> <span class="o">=</span> <span class="s">"EasyExcelController"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"EasyExcel导入导出测试"</span><span class="o">)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/easyExcel"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EasyExcelController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderData</span><span class="o">&gt;</span> <span class="nf">convert</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orderList</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderData</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Order</span> <span class="n">order</span> <span class="o">:</span> <span class="n">orderList</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">productList</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="na">getProductList</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Product</span> <span class="n">product</span> <span class="o">:</span> <span class="n">productList</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">OrderData</span> <span class="n">orderData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderData</span><span class="o">();</span>
                <span class="nc">BeanUtil</span><span class="o">.</span><span class="na">copyProperties</span><span class="o">(</span><span class="n">product</span><span class="o">,</span><span class="n">orderData</span><span class="o">);</span>
                <span class="nc">BeanUtil</span><span class="o">.</span><span class="na">copyProperties</span><span class="o">(</span><span class="n">order</span><span class="o">,</span><span class="n">orderData</span><span class="o">);</span>
                <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">orderData</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>再创建一个自定义注解<code class="highlighter-rouge">CustomMerge</code>，用于标记哪些属性需要合并，哪个是主键；</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 自定义注解，用于判断是否需要合并以及合并的主键
 */</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Inherited</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">CustomMerge</span> <span class="o">{</span>
  
    <span class="cm">/**
     * 是否需要合并单元格
     */</span>
    <span class="kt">boolean</span> <span class="nf">needMerge</span><span class="o">()</span> <span class="k">default</span> <span class="kc">false</span><span class="o">;</span>
  
    <span class="cm">/**
     * 是否是主键,即该字段相同的行合并
     */</span>
    <span class="kt">boolean</span> <span class="nf">isPk</span><span class="o">()</span> <span class="k">default</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>再创建自定义单元格合并策略类<code class="highlighter-rouge">CustomMergeStrategy</code>，当Excel中两列主键相同时，合并被标记需要合并的列；</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 自定义单元格合并策略
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomMergeStrategy</span> <span class="kd">implements</span> <span class="nc">RowWriteHandler</span> <span class="o">{</span>
    <span class="cm">/**
     * 主键下标
     */</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">pkIndex</span><span class="o">;</span>
  
    <span class="cm">/**
     * 需要合并的列的下标集合
     */</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">needMergeColumnIndex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
  
    <span class="cm">/**
     * DTO数据类型
     */</span>
    <span class="kd">private</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">elementType</span><span class="o">;</span>
  
    <span class="kd">public</span> <span class="nf">CustomMergeStrategy</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">elementType</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementType</span> <span class="o">=</span> <span class="n">elementType</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterRowDispose</span><span class="o">(</span><span class="nc">WriteSheetHolder</span> <span class="n">writeSheetHolder</span><span class="o">,</span> <span class="nc">WriteTableHolder</span> <span class="n">writeTableHolder</span><span class="o">,</span> <span class="nc">Row</span> <span class="n">row</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">relativeRowIndex</span><span class="o">,</span> <span class="nc">Boolean</span> <span class="n">isHead</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 如果是标题,则直接返回</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isHead</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
  
        <span class="c1">// 获取当前sheet</span>
        <span class="nc">Sheet</span> <span class="n">sheet</span> <span class="o">=</span> <span class="n">writeSheetHolder</span><span class="o">.</span><span class="na">getSheet</span><span class="o">();</span>
  
        <span class="c1">// 获取标题行</span>
        <span class="nc">Row</span> <span class="n">titleRow</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getRow</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
  
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">pkIndex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">lazyInit</span><span class="o">(</span><span class="n">writeSheetHolder</span><span class="o">);</span>
        <span class="o">}</span>
  
        <span class="c1">// 判断是否需要和上一行进行合并</span>
        <span class="c1">// 不能和标题合并，只能数据行之间合并</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getRowNum</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 获取上一行数据</span>
        <span class="nc">Row</span> <span class="n">lastRow</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getRow</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getRowNum</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="c1">// 将本行和上一行是同一类型的数据(通过主键字段进行判断)，则需要合并</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lastRow</span><span class="o">.</span><span class="na">getCell</span><span class="o">(</span><span class="n">pkIndex</span><span class="o">).</span><span class="na">getStringCellValue</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getCell</span><span class="o">(</span><span class="n">pkIndex</span><span class="o">).</span><span class="na">getStringCellValue</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Integer</span> <span class="n">needMerIndex</span> <span class="o">:</span> <span class="n">needMergeColumnIndex</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">CellRangeAddress</span> <span class="n">cellRangeAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CellRangeAddress</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getRowNum</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">row</span><span class="o">.</span><span class="na">getRowNum</span><span class="o">(),</span>
                        <span class="n">needMerIndex</span><span class="o">,</span> <span class="n">needMerIndex</span><span class="o">);</span>
                <span class="n">sheet</span><span class="o">.</span><span class="na">addMergedRegionUnsafe</span><span class="o">(</span><span class="n">cellRangeAddress</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="cm">/**
     * 初始化主键下标和需要合并字段的下标
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">lazyInit</span><span class="o">(</span><span class="nc">WriteSheetHolder</span> <span class="n">writeSheetHolder</span><span class="o">)</span> <span class="o">{</span>
  
        <span class="c1">// 获取当前sheet</span>
        <span class="nc">Sheet</span> <span class="n">sheet</span> <span class="o">=</span> <span class="n">writeSheetHolder</span><span class="o">.</span><span class="na">getSheet</span><span class="o">();</span>
  
        <span class="c1">// 获取标题行</span>
        <span class="nc">Row</span> <span class="n">titleRow</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getRow</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="c1">// 获取DTO的类型</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eleType</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementType</span><span class="o">;</span>
  
        <span class="c1">// 获取DTO所有的属性</span>
        <span class="nc">Field</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">eleType</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">();</span>
  
        <span class="c1">// 遍历所有的字段，因为是基于DTO的字段来构建excel，所以字段数 &gt;= excel的列数</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="n">theField</span> <span class="o">:</span> <span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 获取@ExcelProperty注解，用于获取该字段对应在excel中的列的下标</span>
            <span class="nc">ExcelProperty</span> <span class="n">easyExcelAnno</span> <span class="o">=</span> <span class="n">theField</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">ExcelProperty</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="c1">// 为空,则表示该字段不需要导入到excel,直接处理下一个字段</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">easyExcelAnno</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// 获取自定义的注解，用于合并单元格</span>
            <span class="nc">CustomMerge</span> <span class="n">customMerge</span> <span class="o">=</span> <span class="n">theField</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">CustomMerge</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  
            <span class="c1">// 没有@CustomMerge注解的默认不合并</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">customMerge</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
  
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">fields</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">index</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">Cell</span> <span class="n">theCell</span> <span class="o">=</span> <span class="n">titleRow</span><span class="o">.</span><span class="na">getCell</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="c1">// 当配置为不需要导出时，返回的为null，这里作一下判断，防止NPE</span>
                <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">theCell</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">// 将字段和excel的表头匹配上</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">easyExcelAnno</span><span class="o">.</span><span class="na">value</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">theCell</span><span class="o">.</span><span class="na">getStringCellValue</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">customMerge</span><span class="o">.</span><span class="na">isPk</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">pkIndex</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
                    <span class="o">}</span>
  
                    <span class="k">if</span> <span class="o">(</span><span class="n">customMerge</span><span class="o">.</span><span class="na">needMerge</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">needMergeColumnIndex</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
  
        <span class="c1">// 没有指定主键，则异常</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="k">this</span><span class="o">.</span><span class="na">pkIndex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"使用@CustomMerge注解必须指定主键"</span><span class="o">);</span>
        <span class="o">}</span>
  
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>接下来在Controller中添加导出订单列表的接口，将我们自定义的合并策略<code class="highlighter-rouge">CustomMergeStrategy</code>给注册上去；</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="nd">@Api</span><span class="o">(</span><span class="n">tags</span> <span class="o">=</span> <span class="s">"EasyExcelController"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"EasyExcel导入导出测试"</span><span class="o">)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/easyExcel"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EasyExcelController</span> <span class="o">{</span>
      
    <span class="nd">@SneakyThrows</span>
    <span class="nd">@ApiOperation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"导出订单列表Excel"</span><span class="o">)</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/exportOrderList"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportOrderList</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orderList</span> <span class="o">=</span> <span class="n">getOrderList</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderData</span><span class="o">&gt;</span> <span class="n">orderDataList</span> <span class="o">=</span> <span class="n">convert</span><span class="o">(</span><span class="n">orderList</span><span class="o">);</span>
        <span class="n">setExcelRespProp</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="s">"订单列表"</span><span class="o">);</span>
        <span class="nc">EasyExcel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">())</span>
                <span class="o">.</span><span class="na">head</span><span class="o">(</span><span class="nc">OrderData</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">registerWriteHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">CustomMergeStrategy</span><span class="o">(</span><span class="nc">OrderData</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
                <span class="o">.</span><span class="na">excelType</span><span class="o">(</span><span class="nc">ExcelTypeEnum</span><span class="o">.</span><span class="na">XLSX</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sheet</span><span class="o">(</span><span class="s">"订单列表"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">doWrite</span><span class="o">(</span><span class="n">orderDataList</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>在Swagger中访问接口测试，导出订单列表对应Excel；</p>

<p><img src="/assets/images/2022/springboot/easyexcel-1.png" alt="" /></p>

<p>下载完成后，查看下文件，由于EasyExcel需要自己来实现，对比之前使用EasyPoi来实现麻烦了不少。</p>

<p><img src="/assets/images/2022/springboot/easyexcel-8.png" alt="" /></p>

<p><strong>其他使用</strong></p>

<p>由于EasyExcel的官方文档介绍的比较简单，如果你想要更深入地进行使用的话，建议大家看下官方Demo</p>

<p><img src="/assets/images/2022/springboot/easyexcel-7.png" alt="" /></p>

<p>参考地址：</p>

<ul>
  <li>项目地址：https://github.com/alibaba/easyexcel</li>
  <li>官方文档：https://www.yuque.com/easyexcel/doc/easyexcel</li>
</ul>

<h3 id="第四版优化插入速度">第四版优化插入速度</h3>

<p>在第二版插入的时候，我使用了 values 批量插入代替逐行插入。每 30000 行拼接一个长 SQL、顺序插入。整个导入方法这块耗时最多，非常拉跨。后来我将每次拼接的行数减少到 10000、5000、3000、1000、500 发现执行最快的是 1000。结合网上一些对 innodb_buffer_pool_size 描述我猜是因为过长的 SQL 在写操作的时候由于超过内存阈值，发生了磁盘交换。限制了速度，另外测试服务器的数据库性能也不怎么样，过多的插入他也处理不过来。所以最终采用每次 1000 条插入。</p>

<p>每次 1000 条插入后，为了榨干数据库的 CPU，那么网络IO的等待时间就需要利用起来，这个需要多线程来解决，而最简单的多线程可以使用 并行流 来实现，接着我将代码用并行流来测试了一下：</p>

<p>10w行的 excel、42w 欠单、42w记录详情、2w记录、16 线程并行插入数据库、每次 1000 行。插入时间 72s，导入总时间 95 s。</p>

<p><img src="\assets\images\2021\javabase\easyexcel-test.png" alt="" /></p>

<p>并行插入工具类，封装成一个函数式编程的工具类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 功能：利用并行流快速插入数据
 *
 * @author Keats
 * @date 2020/7/1 9:25
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InsertConsumer</span> <span class="o">{</span>
    <span class="cm">/**
     * 每个长 SQL 插入的行数，可以根据数据库性能调整
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">SIZE</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>

    <span class="cm">/**
     * 如果需要调整并发数目，修改下面方法的第二个参数即可
     */</span>
    <span class="kd">static</span> <span class="o">{</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"java.util.concurrent.ForkJoinPool.common.parallelism"</span><span class="o">,</span> <span class="s">"4"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 插入方法
     *
     * @param list     插入数据集合
     * @param consumer 消费型方法，直接使用 mapper::method 方法引用的方式
     * @param &lt;T&gt;      插入的数据类型
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">insertData</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">list</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">streamList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span> <span class="o">+=</span> <span class="no">SIZE</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">((</span><span class="n">i</span> <span class="o">+</span> <span class="no">SIZE</span><span class="o">),</span> <span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">subList</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">j</span><span class="o">);</span>
            <span class="n">streamList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">subList</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 并行流使用的并发数是 CPU 核心数，不能局部更改。全局更改影响较大，斟酌</span>
        <span class="n">streamList</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>方法用起来很简单，直接调用mapper的insert方法</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">InsertConsumer</span><span class="o">.</span><span class="na">insertData</span><span class="o">(</span><span class="n">feeList</span><span class="o">,</span> <span class="nl">arrearageMapper:</span><span class="o">:</span><span class="n">insertList</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="3其他影响性能的内容">3、其他影响性能的内容</h2>

<h3 id="减少输出日志">减少输出日志</h3>

<blockquote>
  <p>避免在 for 循环中打印过多的 info 日志</p>
</blockquote>

<p>在优化的过程中，我还发现了一个<strong>特别影响性能</strong>的东西：info 日志，还是使用 41w行、25列、45.5m 数据，在 <strong>开始-数据读取完毕</strong> 之间每 1000 行打印一条 info 日志，<strong>缓存校验数据-校验完毕</strong> 之间每行打印 3+ 条 info 日志，日志框架使用 Slf4j 。打印并持久化到磁盘。下面是打印日志和不打印日志效率的差别</p>

<ul>
  <li>
    <p>打印日志</p>

    <p><img src="\assets\images\2021\javabase\easyexcel-test-print-log.png" alt="" /></p>
  </li>
  <li>
    <p>不打印日志</p>

    <p><img src="\assets\images\2021\javabase\easyexcel-test-no-print-log.png" alt="" /></p>
  </li>
</ul>

<p>缓存校验数据-校验完毕 不打印日志耗时仅仅是打印日志耗时的 1/10 ！</p>

<h2 id="4总结">4、总结</h2>

<p>提升Excel导入速度的方法：</p>

<p>1）使用更快的 Excel 读取框架(推荐使用阿里 EasyExcel)</p>

<p>2）对于需要与数据库交互的校验、按照业务逻辑适当的使用缓存。用空间换时间</p>

<p>3）使用 values(),(),() 拼接长 SQL 一次插入多行数据</p>

<p>4）使用多线程插入数据，利用掉网络IO等待时间(推荐使用并行流，简单易用)</p>

<p>5）避免在循环中打印无用的日志</p>

<h2 id="5信息回写">5、信息回写</h2>

<p>上面使用了easyExcel导入文件内容到数据库，导入过程中某些行出错，我们可以把出错信息回写到excel对应行中，返回一个excel文件的下载路径给前端，用户下载后了解具体的行错误信息。</p>

<h3 id="poi方式导入">POI方式导入</h3>

<p>在ccs项目组的时候，导入库存账龄保留天数就是这样实现的。</p>

<p>1、controller层请求接口StockInvAccountAgeController.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/mobile/stockInvAccountAgeCtrl"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StockInvAccountAgeController</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">StockInvAccountAgeController</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

  <span class="c1">// 配置的excel文件夹路径</span>
  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${ccs.file.importResult.dir}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">importResultDir</span><span class="o">;</span>
  
  <span class="cm">/**
     * 导入库存账龄保留天数
     */</span>
    <span class="nd">@ResponseBody</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/excelImport"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="nc">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">importCreate</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">){</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;(</span><span class="mi">4</span><span class="o">);</span>
        <span class="nc">MultipartHttpServletRequest</span> <span class="n">multiRequest</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MultipartHttpServletRequest</span><span class="o">)</span><span class="n">request</span><span class="o">;</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ite</span> <span class="o">=</span> <span class="n">multiRequest</span><span class="o">.</span><span class="na">getFileNames</span><span class="o">();</span>
        <span class="nc">MultipartFile</span> <span class="n">file</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="c1">// 1、载入文件内容</span>
            <span class="k">while</span><span class="o">(</span><span class="n">ite</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">multiRequest</span><span class="o">.</span><span class="na">getFile</span><span class="o">(</span><span class="n">ite</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
                <span class="k">if</span><span class="o">(</span><span class="n">file</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">list</span><span class="o">=</span> <span class="nc">ExcelImportUtils</span><span class="o">.</span><span class="na">getUploadImportData</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">(),</span> <span class="n">file</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// 2、校验第一行模板</span>
            <span class="k">if</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="s">"事业部账套"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">||</span> <span class="o">!</span><span class="s">"商品编码"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">||</span> <span class="o">!</span><span class="s">"保留天数"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">))){</span>
                <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"success"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"code"</span><span class="o">,</span> <span class="s">"0500"</span><span class="o">);</span>
                <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"msg"</span><span class="o">,</span> <span class="s">"数据异常！"</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">AtomicInteger</span> <span class="n">successCount</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// 成功条数</span>
            <span class="kt">int</span> <span class="n">failCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// 失败条数</span>
            <span class="kt">int</span> <span class="n">importDataCnt</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span><span class="c1">//去掉标题行</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">bsImportMsg</span> <span class="o">=</span><span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;(</span><span class="n">importDataCnt</span><span class="o">);</span>
            <span class="nc">CountDownLatch</span> <span class="n">countDownLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="n">importDataCnt</span><span class="o">);</span>
            <span class="c1">// 查询所有的事业部账套ID</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">setsOfBooksList</span> <span class="o">=</span> <span class="n">stockInvAccountAgeFacade</span><span class="o">.</span><span class="na">listAllBooksId</span><span class="o">();</span>
            <span class="c1">// 创建线程资源类</span>
            <span class="nc">DealProtectDays</span> <span class="n">dealProtectDays</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DealProtectDays</span><span class="o">(</span><span class="n">list</span><span class="o">,</span><span class="n">successCount</span><span class="o">,</span><span class="n">bsImportMsg</span><span class="o">,</span><span class="n">setsOfBooksList</span><span class="o">);</span>
            <span class="c1">// 创建线程池</span>
            <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">7</span><span class="o">,</span><span class="mi">50</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span>
                    <span class="o">,</span><span class="k">new</span> <span class="nc">LinkedBlockingDeque</span><span class="o">&lt;&gt;(</span><span class="mi">100</span><span class="o">),</span><span class="k">new</span> <span class="nc">BlockRejectedExecutionHandler</span><span class="o">());</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// 逐条处理导入数据</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">importDataCnt</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="kt">int</span> <span class="n">tempRowNo</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
                    <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()-&gt;{</span>
                        <span class="n">dealProtectDays</span><span class="o">.</span><span class="na">importExcelData</span><span class="o">(</span><span class="n">tempRowNo</span><span class="o">);</span>
                        <span class="n">countDownLatch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                    <span class="o">});</span>
                <span class="o">}</span>
                <span class="c1">// 阻塞主线程</span>
                <span class="n">countDownLatch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="c1">// System.out.printf("导入完成了，呵呵");</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="n">failCount</span> <span class="o">=</span> <span class="n">importDataCnt</span> <span class="o">-</span> <span class="n">successCount</span><span class="o">.</span><span class="na">intValue</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">failCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
                <span class="c1">// 有导入失败行，失败行信息写回原Excel文件</span>
                <span class="nc">String</span> <span class="n">resultFileUrl</span> <span class="o">=</span> <span class="nc">ExcelImportUtils</span><span class="o">.</span><span class="na">getResultFileUrl</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">file</span><span class="o">,</span> <span class="n">bsImportMsg</span><span class="o">,</span> <span class="n">importResultDir</span><span class="o">);</span>
                <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"msg"</span><span class="o">,</span> <span class="s">"导入总条数："</span><span class="o">+</span><span class="n">importDataCnt</span><span class="o">+</span><span class="s">"&lt;br/&gt;成功条数："</span><span class="o">+</span><span class="n">successCount</span><span class="o">.</span><span class="na">intValue</span><span class="o">()+</span><span class="s">"&lt;br/&gt;失败条数："</span><span class="o">+</span><span class="n">failCount</span><span class="o">);</span>
                <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"resultFileUrl"</span><span class="o">,</span> <span class="n">resultFileUrl</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"msg"</span><span class="o">,</span> <span class="s">"导入总条数："</span><span class="o">+</span><span class="n">importDataCnt</span><span class="o">+</span><span class="s">"&lt;br/&gt;成功条数："</span><span class="o">+</span><span class="n">successCount</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"success"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"code"</span><span class="o">,</span> <span class="s">"0000"</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"successCount"</span><span class="o">,</span> <span class="n">successCount</span><span class="o">.</span><span class="na">intValue</span><span class="o">());</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"failCount"</span><span class="o">,</span> <span class="n">failCount</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"success"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"code"</span><span class="o">,</span> <span class="s">"0500"</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"msg"</span><span class="o">,</span> <span class="s">"数据异常！"</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导入数据失败："</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>线程资源类DealProtectDays.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 线程资源类</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DealProtectDays</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">list</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">AtomicInteger</span> <span class="n">successCount</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">bsImportMsg</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">setsOfBooksList</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">loginId</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">DealProtectDays</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">list</span><span class="o">,</span><span class="nc">AtomicInteger</span> <span class="n">successCount</span><span class="o">,</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">bsImportMsg</span><span class="o">,</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">setsOfBooksList</span><span class="o">){</span>
    <span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">successCount</span> <span class="o">=</span> <span class="n">successCount</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">bsImportMsg</span> <span class="o">=</span> <span class="n">bsImportMsg</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">setsOfBooksList</span> <span class="o">=</span> <span class="n">setsOfBooksList</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">loginId</span> <span class="o">=</span> <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">getSessionUser</span><span class="o">().</span><span class="na">getLoginId</span><span class="o">();</span> <span class="c1">// 登录账号</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">importExcelData</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">){</span>
    <span class="k">try</span><span class="o">{</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
      <span class="n">data</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"loginId"</span><span class="o">,</span><span class="n">loginId</span><span class="o">);</span>
      <span class="n">stockInvAccountAgeFacade</span><span class="o">.</span><span class="na">saveImportData</span><span class="o">(</span><span class="n">data</span><span class="o">,</span><span class="n">setsOfBooksList</span><span class="o">);</span>
      <span class="n">bsImportMsg</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="s">"导入成功"</span><span class="o">);</span>
      <span class="n">successCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
      <span class="n">bsImportMsg</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2、工具类ExcelImportUtils.java，导入功能可以使用easyExcel替代</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExcelImportUtils</span> <span class="o">{</span>
  	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="nf">getUploadImportData</span><span class="o">(</span><span class="nc">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="nc">InputStream</span> <span class="n">inputStream</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">getUploadImportData</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="n">inputStream</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>
  
  <span class="c1">// 获取excel文件数据</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="nf">getUploadImportData</span><span class="o">(</span><span class="nc">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="nc">InputStream</span> <span class="n">inputStream</span><span class="o">,</span>
			<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">headerList</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;();</span>
		<span class="nc">OPCPackage</span> <span class="n">pkg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">Workbook</span> <span class="n">workBook</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">fileName</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".xls"</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// 2003-2007版本的Excel文件</span>
				 <span class="n">workBook</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HSSFWorkbook</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
				<span class="n">saveData4Excel</span><span class="o">(</span><span class="n">workBook</span><span class="o">.</span><span class="na">getSheetAt</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">list</span><span class="o">,</span> <span class="n">headerList</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">fileName</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".xlsx"</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// 2007版本或更高版本的Excel文件</span>
				<span class="n">pkg</span> <span class="o">=</span> <span class="nc">OPCPackage</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
				 <span class="n">workBook</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XSSFWorkbook</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>
		        <span class="n">saveData4Excel</span><span class="o">(</span><span class="n">workBook</span><span class="o">.</span><span class="na">getSheetAt</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">list</span><span class="o">,</span> <span class="n">headerList</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"读取导入数据异常。"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>				
				<span class="k">if</span><span class="o">(</span><span class="n">workBook</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
					<span class="n">workBook</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span>				
				<span class="k">if</span> <span class="o">(</span><span class="n">pkg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">pkg</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">inputStream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"IO流关闭异常。"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">list</span><span class="o">;</span>
	<span class="o">}</span>
  
  <span class="c1">// 错误信息写入文件，返回文件路径</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getResultFileUrl</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">MultipartFile</span> <span class="n">importFile</span><span class="o">,</span> 
                                        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">errorMsgMap</span><span class="o">,</span> <span class="nc">String</span> <span class="n">importResultDir</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 保存导入结果文件的文件夹在服务器上的本地路径</span>
    <span class="nc">String</span> <span class="n">importResultLocalDir</span> <span class="o">=</span><span class="n">importResultDir</span><span class="o">;</span>

    <span class="nc">String</span> <span class="n">fileDate</span> <span class="o">=</span> <span class="n">fileDateSdf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>		
    <span class="n">importResultLocalDir</span> <span class="o">+=</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span> <span class="o">+</span> <span class="n">fileDate</span><span class="o">;</span>

    <span class="nc">File</span> <span class="n">tempFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">importResultLocalDir</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">tempFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// 文件夹不存在就新建</span>
      <span class="n">tempFile</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 通过UUID创建唯一编码</span>
    <span class="nc">String</span> <span class="n">fileId</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="c1">// 导出结果文件的后缀名要与导入文件的一致</span>
    <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">fileId</span> <span class="o">+</span> <span class="n">getFileSuffix</span><span class="o">(</span><span class="n">importFile</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">());</span>
    <span class="c1">// 导出结果文件的服务器路径</span>
    <span class="nc">String</span> <span class="n">fileLocalPath</span> <span class="o">=</span> <span class="n">importResultLocalDir</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">writeImportResultFile</span><span class="o">(</span><span class="n">errorMsgMap</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">importFile</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="n">fileLocalPath</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ApplicationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"文件生成失败："</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"文件生成失败："</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">importResultLocalDir</span>
        <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span>  <span class="o">+</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  
   <span class="c1">// 表格数据读取到List</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">saveData4Excel</span><span class="o">(</span><span class="nc">Sheet</span> <span class="n">sheet</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">headerList</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">sheet</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"sheet 不能为null"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">list</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"list 不能为null"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// 定义 row、cell</span>
		<span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="c1">// 循环输出表格中的内容</span>
		<span class="cm">/*
		 * 如果中间各行或者隔列的话getPhysicalNumberOfRows和getPhysicalNumberOfCells就不能读取到所有的行和列了
		 * sheet.getLastRowNum() + 1
		 * row.getLastCellNum()
		 */</span>
		<span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
		<span class="k">if</span><span class="o">(</span><span class="n">headerList</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
			<span class="n">i</span><span class="o">=</span><span class="n">sheet</span><span class="o">.</span><span class="na">getFirstRowNum</span><span class="o">()+</span><span class="mi">1</span><span class="o">;</span>
		<span class="o">}</span><span class="k">else</span><span class="o">{</span>
			<span class="n">i</span><span class="o">=</span><span class="n">sheet</span><span class="o">.</span><span class="na">getFirstRowNum</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">for</span> <span class="o">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getLastRowNum</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">row</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getRow</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isEmptyRow</span><span class="o">(</span><span class="n">row</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">continue</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;();</span>
			<span class="kt">int</span> <span class="n">firstCellNum</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getFirstCellNum</span><span class="o">();</span>
			<span class="kt">int</span> <span class="n">lastCellNum</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getLastCellNum</span><span class="o">();</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">firstCellNum</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">lastCellNum</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
				<span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getCell</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
				<span class="k">if</span><span class="o">(</span><span class="n">isEmptyCell</span><span class="o">(</span><span class="n">cell</span><span class="o">))</span> <span class="o">{</span>
					<span class="k">continue</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="n">value</span> <span class="o">=</span> <span class="n">getCellValue</span><span class="o">(</span><span class="n">cell</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">isEmptyValue</span><span class="o">(</span><span class="n">value</span><span class="o">))</span> <span class="o">{</span>
					<span class="k">continue</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">j</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>				
			<span class="o">}</span>
			<span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">sheet</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
  
  <span class="c1">// 写入workbook  </span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">writeImportResultFile</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span> <span class="kt">int</span> <span class="n">page</span><span class="o">,</span> 
			<span class="nc">InputStream</span> <span class="n">inputStream</span><span class="o">,</span><span class="nc">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ApplicationException</span> <span class="o">{</span>
		<span class="nc">OPCPackage</span> <span class="n">pkg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">Workbook</span> <span class="n">workbook</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span><span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">fileName</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".xls"</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">workbook</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HSSFWorkbook</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
				<span class="k">return</span> <span class="nf">updateMessage4Excel</span><span class="o">(</span><span class="n">workbook</span><span class="o">,</span> <span class="n">page</span><span class="o">,</span> <span class="n">map</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">fileName</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".xlsx"</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">pkg</span> <span class="o">=</span> <span class="nc">OPCPackage</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
				<span class="n">workbook</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XSSFWorkbook</span><span class="o">(</span><span class="n">pkg</span><span class="o">);</span>
				<span class="k">return</span> <span class="nf">updateMessage4Excel</span><span class="o">(</span><span class="n">workbook</span><span class="o">,</span> <span class="n">page</span><span class="o">,</span> <span class="n">map</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"写入数据异常。"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="o">(</span><span class="s">"写入数据异常。"</span><span class="o">);</span>
		<span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>				
				<span class="k">if</span><span class="o">(</span><span class="n">workbook</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
					<span class="n">workbook</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span>				
				<span class="k">if</span> <span class="o">(</span><span class="n">pkg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>					
					<span class="n">pkg</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">inputStream</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"IO流关闭异常。"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="o">(</span><span class="s">"文件类型错误，必须是后缀名为.xls或者.xlsx的excel文件"</span><span class="o">);</span>
	<span class="o">}</span>
  <span class="c1">// 写入Sheet</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">updateMessage4Excel</span><span class="o">(</span><span class="nc">Workbook</span> <span class="n">workbook</span><span class="o">,</span> <span class="kt">int</span> <span class="n">page</span><span class="o">,</span> 
			<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span><span class="nc">String</span> <span class="n">downloadFileName</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">workbook</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">downloadFileName</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="nc">Sheet</span> <span class="n">sheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="na">getSheetAt</span><span class="o">(</span><span class="n">page</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">sheet</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="c1">// 定义 row、cell</span>
		<span class="nc">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">createColInd</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				
		<span class="c1">// 循环输出表格中的内容</span>
		<span class="cm">/*
		 * 如果中间各行或者隔列的话getPhysicalNumberOfRows和getPhysicalNumberOfCells就不能读取到所有的行和列了
		 * sheet.getLastRowNum() + 1
		 * row.getLastCellNum()
		 */</span>
		<span class="kt">int</span> <span class="n">emptyRowNum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getFirstRowNum</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getLastRowNum</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">row</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getRow</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isEmptyRow</span><span class="o">(</span><span class="n">row</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">emptyRowNum</span><span class="o">++;</span>
				<span class="k">continue</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 以头行的第一个空白列做为错误信息列</span>
				<span class="n">createColInd</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getLastCellNum</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">createColInd</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span> <span class="c1">// 否则以第一非空行的第一个空白列做为错误信息列</span>
				<span class="n">createColInd</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getLastCellNum</span><span class="o">();</span>
			<span class="o">}</span>
			<span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">createCell</span><span class="o">(</span><span class="n">createColInd</span><span class="o">);</span>
			<span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">emptyRowNum</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">downloadFileName</span><span class="o">);</span>
			<span class="n">workbook</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">fos</span><span class="o">);</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"写入导入失败文件失败："</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="n">sheet</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">fos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"关闭导入失败文件输出流失败："</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">workbook</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">workbook</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"关闭导入失败文件输出流失败："</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>	
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>如果是微服务，excel文件不能保留在服务单例上，应该上传到fastDFS或者OSS上</p>

<h3 id="easyexcel方式导入">EasyExcel方式导入</h3>

<p>rcc 对账服务佣金点位配置异步导入excel</p>

<p>1、Controller层接口</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Api</span><span class="o">(</span><span class="n">tags</span> <span class="o">=</span> <span class="s">"佣金点位配置"</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/pointConfig"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PointConfigController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">PointConfigService</span> <span class="n">pointConfigService</span><span class="o">;</span>
  
    <span class="nd">@ApiOperation</span><span class="o">(</span><span class="s">"导入"</span><span class="o">)</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/importFile.do"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Result</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">importFile</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"file"</span><span class="o">)</span> <span class="nc">MultipartFile</span> <span class="n">file</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Result</span><span class="o">.</span><span class="na">getSuccessResult</span><span class="o">(</span><span class="n">pointConfigService</span><span class="o">.</span><span class="na">importFile</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2、业务层实现类<code class="highlighter-rouge">PointConfigServiceImpl</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PointConfigServiceImpl</span> <span class="kd">extends</span> <span class="nc">ServiceImpl</span><span class="o">&lt;</span><span class="nc">PointConfigMapper</span><span class="o">,</span> <span class="nc">PointConfig</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">PointConfigService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">RccExcelServiceImpl</span> <span class="n">rccExcelService</span><span class="o">;</span>
  
  	<span class="c1">// 新增点位数据</span>
   <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addBatch</span><span class="o">(</span><span class="nc">String</span> <span class="n">tenantCode</span><span class="o">,</span><span class="nc">String</span> <span class="n">userCode</span><span class="o">,</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">PointConfigFormDTO</span><span class="o">&gt;</span> <span class="n">dtoList</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 尽量保证校验唯一与插入的原子性，避免插入重复数据</span>
        <span class="nc">RLock</span> <span class="n">rLock</span> <span class="o">=</span> <span class="n">redisLockHelper</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="s">"addPointConfig"</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">rLock</span><span class="o">,</span><span class="s">"获取锁失败,请稍后重试"</span><span class="o">);</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="c1">// 1.唯一判断校验，满足以下场景</span>
            <span class="c1">// 相同模板+品牌+品类，允许商品编码空与非空的两种情况存在</span>
            <span class="c1">// 相同模板+品牌+品类+商品编码空的唯一</span>
            <span class="c1">// 相同模板+品牌+品类+商品编码非空的唯一</span>
            <span class="c1">// 过滤商品编码空的记录,再进行分组，如果每组的数量大于1，则存在重复</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PointConfigFormDTO</span><span class="o">&gt;&gt;</span> <span class="n">group1</span> <span class="o">=</span> <span class="n">dtoList</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">dto</span> <span class="o">-&gt;</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">dto</span><span class="o">.</span><span class="na">getItemCode</span><span class="o">()))</span>
                    <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">dto</span> <span class="o">-&gt;</span> <span class="n">dto</span><span class="o">.</span><span class="na">getTemplateId</span><span class="o">()+</span><span class="s">"-"</span><span class="o">+</span><span class="n">dto</span><span class="o">.</span><span class="na">getBrandCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getCategoryCode</span><span class="o">()));</span>
            <span class="n">group1</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">)-&gt;{</span>
                <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">1</span><span class="o">,</span><span class="s">"模板-品牌-品类("</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="s">")存在重复点位配置"</span><span class="o">);</span>
                <span class="c1">// 判断数据库是否已存在该点位配置</span>
                <span class="nc">PointConfig</span> <span class="n">one</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getOne</span><span class="o">(</span><span class="k">new</span> <span class="nc">QueryWrapper</span><span class="o">&lt;</span><span class="nc">PointConfig</span><span class="o">&gt;().</span><span class="na">select</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">ID</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">TENANT_CODE</span><span class="o">,</span><span class="n">tenantCode</span><span class="o">).</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">TEMPLATE_ID</span><span class="o">,</span><span class="n">v</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getTemplateId</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">BRAND_CODE</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getBrandCode</span><span class="o">()).</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">CATEGORY_CODE</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getCategoryCode</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">wrap</span> <span class="o">-&gt;</span><span class="n">wrap</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">ITEM_CODE</span><span class="o">).</span><span class="na">or</span><span class="o">().</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">ITEM_CODE</span><span class="o">,</span><span class="s">""</span><span class="o">)).</span><span class="na">last</span><span class="o">(</span><span class="s">"LIMIT 1"</span><span class="o">));</span>
                <span class="k">if</span><span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">one</span><span class="o">)){</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"模板-品牌-品类("</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="s">")已存在点位配置，ID："</span><span class="o">+</span><span class="n">one</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="c1">// 过滤商品编码非空的记录,再进行分组，如果每组的数量大于1，则存在重复</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PointConfigFormDTO</span><span class="o">&gt;&gt;</span> <span class="n">group2</span> <span class="o">=</span> <span class="n">dtoList</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">dto</span> <span class="o">-&gt;</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">dto</span><span class="o">.</span><span class="na">getItemCode</span><span class="o">()))</span>
                    <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">groupingBy</span><span class="o">(</span><span class="n">dto</span> <span class="o">-&gt;</span> <span class="n">dto</span><span class="o">.</span><span class="na">getTemplateId</span><span class="o">()+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getBrandCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getCategoryCode</span><span class="o">()</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">dto</span><span class="o">.</span><span class="na">getItemCode</span><span class="o">()));</span>
            <span class="n">group2</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="o">-&gt;{</span>
                <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">1</span><span class="o">,</span><span class="s">"模板-品牌-品类-商品("</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="s">")存在重复点位配置"</span><span class="o">);</span>
                <span class="nc">PointConfig</span> <span class="n">one</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getOne</span><span class="o">(</span><span class="k">new</span> <span class="nc">QueryWrapper</span><span class="o">&lt;</span><span class="nc">PointConfig</span><span class="o">&gt;().</span><span class="na">select</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">ID</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">TENANT_CODE</span><span class="o">,</span><span class="n">tenantCode</span><span class="o">).</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">TEMPLATE_ID</span><span class="o">,</span><span class="n">v</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getTemplateId</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">BRAND_CODE</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getBrandCode</span><span class="o">()).</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">CATEGORY_CODE</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getCategoryCode</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointConfig</span><span class="o">.</span><span class="na">ITEM_CODE</span><span class="o">,</span><span class="n">v</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getItemCode</span><span class="o">()).</span><span class="na">last</span><span class="o">(</span><span class="s">"LIMIT 1"</span><span class="o">));</span>
                <span class="k">if</span><span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">one</span><span class="o">)){</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"模板-品牌-品类-商品("</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="s">")已存在点位配置，ID："</span><span class="o">+</span><span class="n">one</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">});</span>

            <span class="c1">// 2.插入</span>
            <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">dtoList</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">dto</span> <span class="o">-&gt;{</span>
                    <span class="nc">PointConfig</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PointConfig</span><span class="o">();</span>
                    <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">copyProperties</span><span class="o">(</span><span class="n">dto</span><span class="o">,</span><span class="n">entity</span><span class="o">);</span>
                    <span class="n">entity</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="nc">DateUtils</span><span class="o">.</span><span class="na">generateId</span><span class="o">());</span>
                    <span class="n">entity</span><span class="o">.</span><span class="na">setTenantCode</span><span class="o">(</span><span class="n">tenantCode</span><span class="o">);</span>
                    <span class="n">entity</span><span class="o">.</span><span class="na">setCreatedBy</span><span class="o">(</span><span class="n">userCode</span><span class="o">);</span>
                    <span class="n">entity</span><span class="o">.</span><span class="na">setUpdatedBy</span><span class="o">(</span><span class="n">userCode</span><span class="o">);</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>

                    <span class="c1">// 操作日志</span>
                    <span class="nc">RccOperateLog</span> <span class="n">operateLog</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RccOperateLog</span><span class="o">().</span><span class="na">setTenantCode</span><span class="o">(</span><span class="n">tenantCode</span><span class="o">).</span><span class="na">setForeignKey</span><span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">())</span>
                            <span class="o">.</span><span class="na">setCreatedBy</span><span class="o">(</span><span class="n">userCode</span><span class="o">).</span><span class="na">setUpdatedBy</span><span class="o">(</span><span class="n">userCode</span><span class="o">).</span><span class="na">setOperateRecord</span><span class="o">(</span><span class="s">"新增"</span><span class="o">+</span><span class="n">getFormString</span><span class="o">(</span><span class="n">dto</span><span class="o">));</span>
                    <span class="n">operateLogGenMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">operateLog</span><span class="o">);</span>
                <span class="o">});</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">});</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">rLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">importFile</span><span class="o">(</span><span class="nc">MultipartFile</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">tenantCode</span> <span class="o">=</span> <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">getBaseRequest</span><span class="o">().</span><span class="na">getTenantCode</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">userCode</span> <span class="o">=</span> <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">getUserCode</span><span class="o">();</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">tenantCode</span><span class="o">),</span><span class="s">"租户编码为空，请重新登录"</span><span class="o">);</span>
      <span class="c1">// excel文件工作簿对象</span>
        <span class="nc">Workbook</span> <span class="n">workbook</span> <span class="o">=</span> <span class="nc">RccExcelUtils</span><span class="o">.</span><span class="na">getWorkBook</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
      <span class="c1">// 导出文件的名称</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="nc">DateUtils</span><span class="o">.</span><span class="na">DF_YMDHMS_S</span><span class="o">))+</span><span class="n">file</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">();</span>
      <span class="c1">// 调用基础中心保存一条文件导出记录</span>
        <span class="nc">ComExportRecordGenDTO</span> <span class="n">fileRecord</span> <span class="o">=</span> <span class="n">rccExcelService</span><span class="o">.</span><span class="na">saveFileRecord</span><span class="o">(</span><span class="s">"pointConfig"</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>

      <span class="c1">// 异步导入</span>
        <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()-&gt;{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">PointConfigExcelListener</span> <span class="n">excelListener</span><span class="o">=</span><span class="k">new</span> <span class="nc">PointConfigExcelListener</span><span class="o">().</span><span class="na">setTenantCode</span><span class="o">(</span><span class="n">tenantCode</span><span class="o">).</span><span class="na">setUserCode</span><span class="o">(</span><span class="n">userCode</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setPointConfigService</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">setPointTemplateConfigService</span><span class="o">(</span><span class="n">pointTemplateConfigService</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setWorkbook</span><span class="o">(</span><span class="n">workbook</span><span class="o">).</span><span class="na">setExcelService</span><span class="o">(</span><span class="n">rccExcelService</span><span class="o">).</span><span class="na">setFileRecord</span><span class="o">(</span><span class="n">fileRecord</span><span class="o">);</span>
                <span class="c1">// 读取第一个sheet,默认第1行是标题，忽略空行,文件流自动关闭</span>
                <span class="nc">EasyExcel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="nc">PointConfigFormDTO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">excelListener</span><span class="o">).</span><span class="na">registerConverter</span><span class="o">(</span><span class="k">new</span> <span class="nc">LocalDateTimeConverter</span><span class="o">()).</span><span class="na">sheet</span><span class="o">().</span><span class="na">doRead</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"pointConfig importFile error {}"</span><span class="o">,</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>整个系统是微服务应用，先调用基础中心生成一条文件导出记录，生成成功，开启子线程异步导入excel，并返回文件名称给前端</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">ComExportRecordGenDTO</span> <span class="n">fileRecord</span> <span class="o">=</span> <span class="n">rccExcelService</span><span class="o">.</span><span class="na">saveFileRecord</span><span class="o">(</span><span class="s">"pointConfig"</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
</code></pre></div></div>

<p>实现类<code class="highlighter-rouge">RccExcelServiceImpl</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @Author xiejw17
 * @Date 2021/11/15 17:45
 */</span>
<span class="nd">@Lazy</span>
<span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RccExcelServiceImpl</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${server.tomcat.basedir:/tmp/}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">tempDir</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">ExportRecordAtoFeign</span> <span class="n">exportRecordAtoFeign</span><span class="o">;</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">ComExportRecordGenFeign</span> <span class="n">exportRecordGenFeign</span><span class="o">;</span>

    <span class="cm">/**
     * 保存文件记录
     * @param prefix
     * @param fileName
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">ComExportRecordGenDTO</span> <span class="nf">saveFileRecord</span><span class="o">(</span><span class="nc">String</span> <span class="n">prefix</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">){</span>
        <span class="nc">LockExportRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LockExportRequest</span><span class="o">();</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setFilePrefix</span><span class="o">(</span><span class="n">prefix</span><span class="o">);</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setFileName</span><span class="o">(</span><span class="n">prefix</span><span class="o">+</span><span class="s">"-"</span><span class="o">+</span><span class="n">fileName</span><span class="o">);</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setCountLimit</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="nc">ComExportRecordGenDTO</span> <span class="n">record</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">exportRecordAtoFeign</span><span class="o">.</span><span class="na">lockExportRecord</span><span class="o">(</span><span class="nc">CommonRequest</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">request</span><span class="o">)).</span><span class="na">getData</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">record</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BussinessException</span><span class="o">(</span><span class="nc">ModuleErrorEnum</span><span class="o">.</span><span class="na">EXCEL_PROGRESS_LIMIT</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">record</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 文件上传OSS
     * @param workbook
     * @param record
     * @param startTime
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">uploadFile</span><span class="o">(</span><span class="nc">Workbook</span> <span class="n">workbook</span><span class="o">,</span><span class="nc">ComExportRecordGenDTO</span> <span class="n">record</span><span class="o">){</span>
        <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">tempDir</span> <span class="o">+</span><span class="s">"/"</span><span class="o">+</span> <span class="n">record</span><span class="o">.</span><span class="na">getFileName</span><span class="o">());</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="c1">// 输出到文件</span>
            <span class="nc">FileOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
            <span class="n">workbook</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="c1">//  文件上传OSS</span>
            <span class="nc">UploadMediaRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UploadMediaRequest</span><span class="o">();</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setSystem</span><span class="o">(</span><span class="nc">GlobalConstants</span><span class="o">.</span><span class="na">OssSystem</span><span class="o">.</span><span class="na">PASS_OSS</span><span class="o">.</span><span class="na">getSystemSign</span><span class="o">());</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setBucket</span><span class="o">(</span><span class="s">"mcsp-public-store"</span><span class="o">);</span>
            <span class="nc">UploadResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="nc">MediaUploadHelper</span><span class="o">.</span><span class="na">upload</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
            <span class="n">record</span><span class="o">.</span><span class="na">setFileSize</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
            <span class="k">if</span><span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">response</span><span class="o">)){</span>
                <span class="n">record</span><span class="o">.</span><span class="na">setExportStatus</span><span class="o">(</span><span class="nc">DictEnum</span><span class="o">.</span><span class="na">ExportStatus</span><span class="o">.</span><span class="na">FAIL</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
                <span class="n">record</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="s">"上传OSS返回空"</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="n">record</span><span class="o">.</span><span class="na">setDownload</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getUrl</span><span class="o">());</span>
                <span class="n">record</span><span class="o">.</span><span class="na">setExportStatus</span><span class="o">(</span><span class="nc">DictEnum</span><span class="o">.</span><span class="na">ExportStatus</span><span class="o">.</span><span class="na">COMPLETED</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
                <span class="n">record</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="s">"success"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">record</span><span class="o">.</span><span class="na">setExportStatus</span><span class="o">(</span><span class="nc">DictEnum</span><span class="o">.</span><span class="na">ExportStatus</span><span class="o">.</span><span class="na">FAIL</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
            <span class="n">record</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="s">"导入结果文件上传OSS失败："</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">file</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 更新文件记录</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateFileRecord</span><span class="o">(</span><span class="nc">ComExportRecordGenDTO</span> <span class="n">record</span><span class="o">,</span><span class="kt">int</span> <span class="n">tryTimes</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span><span class="o">{</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">exportRecordGenFeign</span><span class="o">.</span><span class="na">updateComExportRecord</span><span class="o">(</span><span class="nc">CommonRequest</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">record</span><span class="o">));</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span> <span class="o">){</span>
            <span class="n">tryTimes</span> <span class="o">=</span> <span class="n">tryTimes</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">tryTimes</span><span class="o">&lt;=</span><span class="mi">0</span><span class="o">){</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"文件记录&lt;"</span><span class="o">+</span><span class="n">record</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()+</span><span class="s">"&gt;更新失败："</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="c1">// 2秒后重试</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
                    <span class="n">updateFileRecord</span><span class="o">(</span><span class="n">record</span><span class="o">,</span><span class="n">tryTimes</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">interruptedException</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"文件记录&lt;"</span><span class="o">+</span><span class="n">record</span><span class="o">.</span><span class="na">getFileName</span><span class="o">()+</span><span class="s">"&gt;更新失败："</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                    <span class="k">throw</span> <span class="n">interruptedException</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>feign接口</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@FeignClient</span><span class="o">(</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">"base-atomic-service"</span><span class="o">,</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">"/base-atomic"</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExportRecordAtoFeign</span> <span class="o">{</span>
    <span class="nd">@PostMapping</span><span class="o">({</span><span class="s">"/export/lockExportRecord.ato.do"</span><span class="o">})</span>
    <span class="nc">Result</span><span class="o">&lt;</span><span class="nc">ComExportRecordGenDTO</span><span class="o">&gt;</span> <span class="nf">lockExportRecord</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">CommonRequest</span><span class="o">&lt;</span><span class="nc">LockExportRequest</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">);</span>

    <span class="nd">@PostMapping</span><span class="o">({</span><span class="s">"/export/exportRecordList.ato.do"</span><span class="o">})</span>
    <span class="nc">PaginationResult</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">ExportRecordAtoRespDTO</span><span class="o">&gt;&gt;</span> <span class="nf">exportRecordList</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">PaginationRequest</span><span class="o">&lt;</span><span class="nc">ExportQueryAtoReqDTO</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Component</span>
<span class="nd">@FeignClient</span><span class="o">(</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">"base-atomic-service"</span><span class="o">,</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">"/base-atomic"</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ComExportRecordGenFeign</span> <span class="o">{</span>
    <span class="nd">@PostMapping</span><span class="o">({</span><span class="s">"/comExportRecord/updateComExportRecord.gen.do"</span><span class="o">})</span>
    <span class="nc">Result</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="nf">updateComExportRecord</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">CommonRequest</span><span class="o">&lt;</span><span class="nc">ComExportRecordGenDTO</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里整合EasyExcel导入文件，需要继承<code class="highlighter-rouge">AnalysisEventListener</code>重写数据处理监听器</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PointConfigExcelListener</span> <span class="kd">extends</span> <span class="nc">AnalysisEventListener</span><span class="o">&lt;</span><span class="nc">PointConfigFormDTO</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">PointConfigService</span> <span class="n">pointConfigService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">PointTemplateConfigService</span> <span class="n">pointTemplateConfigService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">RccExcelServiceImpl</span> <span class="n">excelService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">ComExportRecordGenDTO</span> <span class="n">fileRecord</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">tenantCode</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userCode</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">startTime</span><span class="o">;</span>
    <span class="c1">//private static final int BATCH_COUNT = 1;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PointConfigFormDTO</span><span class="o">&gt;</span> <span class="n">configList</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">templateMap</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">failMessageMap</span><span class="o">;</span> <span class="c1">// 行导入失败的原因</span>
    <span class="nc">Workbook</span> <span class="n">workbook</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PointConfigExcelListener</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">configList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">templateMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">failMessageMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">PointConfigExcelListener</span> <span class="nf">setTenantCode</span><span class="o">(</span><span class="nc">String</span> <span class="n">tenantCode</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tenantCode</span> <span class="o">=</span> <span class="n">tenantCode</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">PointConfigExcelListener</span> <span class="nf">setUserCode</span><span class="o">(</span><span class="nc">String</span> <span class="n">userCode</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userCode</span> <span class="o">=</span> <span class="n">userCode</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">PointConfigExcelListener</span> <span class="nf">setPointConfigService</span><span class="o">(</span><span class="nc">PointConfigService</span> <span class="n">pointConfigService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pointConfigService</span> <span class="o">=</span> <span class="n">pointConfigService</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">PointConfigExcelListener</span> <span class="nf">setPointTemplateConfigService</span><span class="o">(</span><span class="nc">PointTemplateConfigService</span> <span class="n">pointTemplateConfigService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pointTemplateConfigService</span> <span class="o">=</span> <span class="n">pointTemplateConfigService</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">PointConfigExcelListener</span> <span class="nf">setExcelService</span><span class="o">(</span><span class="nc">RccExcelServiceImpl</span> <span class="n">excelService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">excelService</span> <span class="o">=</span> <span class="n">excelService</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">PointConfigExcelListener</span> <span class="nf">setWorkbook</span><span class="o">(</span><span class="nc">Workbook</span> <span class="n">workbook</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">workbook</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">PointConfigExcelListener</span> <span class="nf">setFileRecord</span><span class="o">(</span><span class="nc">ComExportRecordGenDTO</span> <span class="n">fileRecord</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">fileRecord</span> <span class="o">=</span> <span class="n">fileRecord</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 每条数据解析都会来调用
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">PointConfigFormDTO</span> <span class="n">data</span><span class="o">,</span> <span class="nc">AnalysisContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">rowIndex</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">readRowHolder</span><span class="o">().</span><span class="na">getRowIndex</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getBrandCode</span><span class="o">())||</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getCategoryCode</span><span class="o">())){</span>
            <span class="n">failMessageMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">rowIndex</span><span class="o">,</span><span class="s">"品牌编码、品类编码必填"</span><span class="o">);</span>
            <span class="c1">//context.readRowHolder().getCellMap().put(10, new CellData("品牌编码、品类编码必填"));</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 检验品牌、品类的正确性</span>

        <span class="c1">// 查询模板id</span>
        <span class="nc">Long</span> <span class="n">templateId</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">templateMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getTemplateName</span><span class="o">())).</span><span class="na">orElseGet</span><span class="o">(()-&gt;{</span>
            <span class="nc">PointTemplateConfig</span> <span class="n">one</span> <span class="o">=</span> <span class="n">pointTemplateConfigService</span><span class="o">.</span><span class="na">getOne</span><span class="o">(</span><span class="k">new</span> <span class="nc">QueryWrapper</span><span class="o">&lt;</span><span class="nc">PointTemplateConfig</span><span class="o">&gt;()</span>
                    <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="nc">PointTemplateConfig</span><span class="o">.</span><span class="na">ID</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointTemplateConfig</span><span class="o">.</span><span class="na">TENANT_CODE</span><span class="o">,</span> <span class="n">tenantCode</span><span class="o">).</span><span class="na">eq</span><span class="o">(</span><span class="nc">PointTemplateConfig</span><span class="o">.</span><span class="na">TEMPLATE_NAME</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">getTemplateName</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">last</span><span class="o">(</span><span class="s">"limit 1"</span><span class="o">));</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">one</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">});</span>
        <span class="k">if</span><span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">templateId</span><span class="o">)){</span>
            <span class="n">failMessageMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">rowIndex</span><span class="o">,</span><span class="s">"当前租户没配置模板："</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="na">getTemplateName</span><span class="o">());</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">templateMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getTemplateName</span><span class="o">(),</span><span class="n">templateId</span><span class="o">);</span>
        <span class="n">data</span><span class="o">.</span><span class="na">setTemplateId</span><span class="o">(</span><span class="n">templateId</span><span class="o">);</span>
        <span class="c1">// 现在每读一条数据保存一次，因为要获取成功失败信息</span>
        <span class="n">configList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">pointConfigService</span><span class="o">.</span><span class="na">addBatch</span><span class="o">(</span><span class="n">tenantCode</span><span class="o">,</span><span class="n">userCode</span><span class="o">,</span><span class="n">configList</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">failMessageMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">rowIndex</span><span class="o">,</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">configList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 所有数据解析完后调用
     */</span>
    <span class="nd">@SneakyThrows</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAfterAllAnalysed</span><span class="o">(</span><span class="nc">AnalysisContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 每条记录的导入结果更新到原文件</span>
        <span class="nc">RccExcelUtils</span><span class="o">.</span><span class="na">updateMessage4Excel</span><span class="o">(</span><span class="n">workbook</span><span class="o">,</span><span class="n">failMessageMap</span><span class="o">);</span>
        <span class="c1">// 文件上传OSS</span>
        <span class="n">excelService</span><span class="o">.</span><span class="na">uploadFile</span><span class="o">(</span><span class="n">workbook</span><span class="o">,</span><span class="n">fileRecord</span><span class="o">);</span>
        <span class="c1">// 更新文件记录</span>
        <span class="k">this</span><span class="o">.</span><span class="na">fileRecord</span><span class="o">.</span><span class="na">setCostTime</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()-</span><span class="n">startTime</span><span class="o">);</span>
        <span class="n">excelService</span><span class="o">.</span><span class="na">updateFileRecord</span><span class="o">(</span><span class="n">fileRecord</span><span class="o">,</span><span class="mi">3</span><span class="o">);</span>
        <span class="c1">// 一定要关闭文件流</span>
        <span class="n">workbook</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 每条数据转换时的异常处理，默认会抛出异常，停止读取，这里不抛异常，将异常信息保存下来，继续读取下一行
     * @param exception
     * @param context
     * @throws Exception
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onException</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">exception</span><span class="o">,</span> <span class="nc">AnalysisContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">failMessageMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">readRowHolder</span><span class="o">().</span><span class="na">getRowIndex</span><span class="o">(),</span><span class="s">"数据解析异常"</span><span class="o">+</span><span class="n">exception</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>工具类<code class="highlighter-rouge">RccExcelUtils</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RccExcelUtils</span> <span class="o">{</span>
      <span class="nd">@SneakyThrows</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Workbook</span> <span class="nf">getWorkBook</span><span class="o">(</span><span class="nc">MultipartFile</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">originalFilename</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">originalFilename</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BussinessException</span><span class="o">(</span><span class="nc">ErrorEnum</span><span class="o">.</span><span class="na">FAIL</span><span class="o">,</span> <span class="s">"excel文件名称不能为空"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">originalFilename</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">fileName</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".xls"</span><span class="o">)){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">HSSFWorkbook</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">fileName</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".xlsx"</span><span class="o">)){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">XSSFWorkbook</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"excel文件格式错误"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">updateMessage4Excel</span><span class="o">(</span><span class="nc">Workbook</span> <span class="n">workbook</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Sheet</span> <span class="n">sheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="na">getSheetAt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">columnIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="c1">// 第一行是标题</span>
        <span class="nc">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getRow</span><span class="o">(</span><span class="n">sheet</span><span class="o">.</span><span class="na">getFirstRowNum</span><span class="o">());</span>
        <span class="n">columnIndex</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getLastCellNum</span><span class="o">();</span>
        <span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">createCell</span><span class="o">(</span><span class="n">columnIndex</span><span class="o">);</span>
        <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="s">"提示"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getFirstRowNum</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getLastRowNum</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">getRow</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">createCell</span><span class="o">(</span><span class="n">columnIndex</span><span class="o">);</span>
            <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">defaultString</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="s">"success"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="6异步分页导出">6、异步分页导出</h2>

<p>1、Controller层接口</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Api</span><span class="o">(</span><span class="n">tags</span> <span class="o">=</span> <span class="s">"电商对账-销售发票核对"</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/reconciliation/saleInvoice"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SaleInvoiceRecController</span> <span class="o">{</span>
      <span class="nd">@ApiOperation</span><span class="o">(</span><span class="s">"导出对账明细,返回导出的任务id"</span><span class="o">)</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/exportDetails.do"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Result</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">exportDetails</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">PaginationRequest</span><span class="o">&lt;</span><span class="nc">FindSaleInvoiceDetailReqDTO</span><span class="o">&gt;</span> <span class="n">pageRequest</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">downloadId</span> <span class="o">=</span> <span class="n">saleInvoiceRecFacade</span><span class="o">.</span><span class="na">exportDetails</span><span class="o">(</span><span class="n">pageRequest</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Result</span><span class="o">.</span><span class="na">getSuccessResult</span><span class="o">(</span><span class="n">downloadId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2、业务层实现类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SaleInvoiceRecFacadeImpl</span> <span class="kd">implements</span> <span class="nc">SaleInvoiceRecFacade</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">exportDetails</span><span class="o">(</span><span class="nc">PaginationRequest</span><span class="o">&lt;</span><span class="nc">FindSaleInvoiceDetailReqDTO</span><span class="o">&gt;</span> <span class="n">pageRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">tenantCode</span> <span class="o">=</span> <span class="n">pageRequest</span><span class="o">.</span><span class="na">getHeadParams</span><span class="o">().</span><span class="na">getTenantCode</span><span class="o">();</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">tenantCode</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                <span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">pageRequest</span><span class="o">.</span><span class="na">getRestParams</span><span class="o">().</span><span class="na">getPeriod</span><span class="o">()),</span><span class="s">"租户编码与账期必填"</span><span class="o">);</span>
        <span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="n">param</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span><span class="o">(</span><span class="s">"销售发票核对明细导出"</span><span class="o">,</span> <span class="s">"租户编码"</span><span class="o">+</span><span class="n">tenantCode</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"checkBatchNum"</span><span class="o">,</span><span class="s">"核对批次号"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"period"</span><span class="o">,</span><span class="s">"账期"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"merchantCode"</span><span class="o">,</span><span class="s">"商户编码"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"merchantName"</span><span class="o">,</span><span class="s">"商户名称"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"customerCode"</span><span class="o">,</span><span class="s">"客户编码"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"customerName"</span><span class="o">,</span><span class="s">"客户名称"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"shopCode"</span><span class="o">,</span><span class="s">"店铺编码"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"shopName"</span><span class="o">,</span><span class="s">"店铺名称"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"outTradeNo"</span><span class="o">,</span><span class="s">"订单号"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"settleAmount"</span><span class="o">,</span><span class="s">"本期结算金额"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"settleTaxAmount"</span><span class="o">,</span><span class="s">"本期结算税额"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"invoiceAmount"</span><span class="o">,</span><span class="s">"本期开票金额"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"invoiceTaxAmount"</span><span class="o">,</span><span class="s">"本期开票税额"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"diffAmount"</span><span class="o">,</span><span class="s">"本期差异"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"taxDiffAmount"</span><span class="o">,</span><span class="s">"本期税额差异"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"startDiffAmount"</span><span class="o">,</span><span class="s">"期初差异"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"startTaxDiffAmount"</span><span class="o">,</span><span class="s">"期初税额差异"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"endDiffAmount"</span><span class="o">,</span><span class="s">"期末差异"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"endTaxDiffAmount"</span><span class="o">,</span><span class="s">"期末税额差异"</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">addHead</span><span class="o">(</span><span class="s">"diffJudgeTypeName"</span><span class="o">,</span><span class="s">"差异判断"</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">downloadId</span> <span class="o">=</span> <span class="n">excelService</span><span class="o">.</span><span class="na">asyncExport</span><span class="o">(</span><span class="n">pr</span> <span class="o">-&gt;{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SaleInvoiceDetailRespDTO</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">listDetails</span><span class="o">(</span><span class="n">pr</span><span class="o">);</span>
            <span class="n">list</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">dto</span><span class="o">-&gt;{</span>
                <span class="n">dto</span><span class="o">.</span><span class="na">setDiffJudgeTypeName</span><span class="o">(</span><span class="n">getDiffJudgeTypeName</span><span class="o">(</span><span class="n">dto</span><span class="o">.</span><span class="na">getDiffJudgeType</span><span class="o">()));</span>
            <span class="o">});</span>
            <span class="k">return</span> <span class="nc">PaginationResult</span><span class="o">.</span><span class="na">getSuccessResult</span><span class="o">(</span><span class="n">list</span><span class="o">,</span><span class="n">pr</span><span class="o">.</span><span class="na">getPagination</span><span class="o">());</span>
        <span class="o">},</span><span class="n">pageRequest</span><span class="o">,</span><span class="n">param</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">downloadId</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>主要工具类<code class="highlighter-rouge">ExcelServiceImpl</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.node.ArrayNode</span><span class="o">;</span>

<span class="nd">@Lazy</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExcelServiceImpl</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">ComExportRecordGenFeign</span> <span class="n">exportRecordGenFeign</span><span class="o">;</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">ExportRecordAtoFeign</span> <span class="n">exportRecordAtoFeign</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EXCEL_SUFFIX</span> <span class="o">=</span> <span class="s">".xlsx"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">COUNT_PER_PERSON</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">PROGRESS_TIMEOUT</span> <span class="o">=</span> <span class="mi">3600</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">DateTimeFormatter</span> <span class="no">DF</span> <span class="o">=</span> <span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="s">"yyyyMMddHHmmssSSS"</span><span class="o">);</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${server.tomcat.basedir:/tmp/}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">tempDir</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>
  
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">asyncExport</span><span class="o">(</span><span class="nc">Function</span><span class="o">&lt;</span><span class="nc">PaginationRequest</span><span class="o">,</span> <span class="nc">PaginationResult</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&gt;&gt;</span> <span class="n">function</span><span class="o">,</span> <span class="nc">PaginationRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">initParam</span><span class="o">(</span><span class="n">param</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="nc">ExecutorConfig</span><span class="o">.</span><span class="na">TASK_EXECUTOR</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">exportEasy</span><span class="o">(</span><span class="n">function</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">param</span><span class="o">);</span>
                <span class="k">this</span><span class="o">.</span><span class="na">exportEasySuccess</span><span class="o">(</span><span class="n">param</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">var10</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"导出取消，任务ID: [{0}]"</span><span class="o">,</span> <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
                <span class="k">this</span><span class="o">.</span><span class="na">exportCancel</span><span class="o">(</span><span class="n">param</span><span class="o">,</span> <span class="s">"手动取消任务"</span><span class="o">);</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NullPointerException</span> <span class="n">var11</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导出失败：空指针异常"</span><span class="o">,</span> <span class="n">var11</span><span class="o">);</span>
                <span class="k">this</span><span class="o">.</span><span class="na">exportFail</span><span class="o">(</span><span class="n">param</span><span class="o">,</span> <span class="s">"空指针异常"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">var12</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导出失败："</span><span class="o">,</span> <span class="n">var12</span><span class="o">);</span>
                <span class="k">this</span><span class="o">.</span><span class="na">exportFail</span><span class="o">(</span><span class="n">param</span><span class="o">,</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getExceptionMessage</span><span class="o">(</span><span class="n">var12</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1000</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="nc">ExportProgressHelper</span><span class="o">.</span><span class="na">clearProgress</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="o">}</span>

        <span class="o">});</span>
        <span class="k">return</span> <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
  
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initParam</span><span class="o">(</span><span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="n">param</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">async</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">param</span><span class="o">.</span><span class="na">async</span> <span class="o">=</span> <span class="n">async</span><span class="o">;</span>
        <span class="n">param</span><span class="o">.</span><span class="na">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">param</span><span class="o">.</span><span class="na">fileName</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="na">docName</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="no">DF</span><span class="o">)</span> <span class="o">+</span> <span class="s">".xlsx"</span><span class="o">;</span>
        <span class="n">param</span><span class="o">.</span><span class="na">record</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ComExportRecordGenDTO</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">exportRecordAtoFeign</span><span class="o">.</span><span class="na">lockExportRecord</span><span class="o">(</span><span class="nc">CommonRequest</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getRecord</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">docName</span><span class="o">,</span> <span class="n">param</span><span class="o">.</span><span class="na">fileName</span><span class="o">,</span> <span class="mi">5</span><span class="o">))).</span><span class="na">getData</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">record</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BussinessException</span><span class="o">(</span><span class="nc">ModuleErrorEnum</span><span class="o">.</span><span class="na">EXCEL_PROGRESS_LIMIT</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="c1">// 初始文件导出进度到redis</span>
            <span class="nc">ExportProgressHelper</span><span class="o">.</span><span class="na">setProgress</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="s">"0"</span><span class="o">,</span> <span class="mi">3600L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">exportEasy</span><span class="o">(</span><span class="nc">Function</span><span class="o">&lt;</span><span class="nc">PaginationRequest</span><span class="o">,</span> <span class="nc">PaginationResult</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&gt;&gt;</span> <span class="n">function</span><span class="o">,</span> <span class="nc">PaginationRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="n">param</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Pagination</span> <span class="n">pagination</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getPagination</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">5000</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">tempDir</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="na">fileName</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">sheetName</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="na">sheetName</span><span class="o">;</span>
        <span class="nc">Long</span> <span class="n">progress</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">lineCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">sheetNum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">keys</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">[])</span><span class="n">param</span><span class="o">.</span><span class="na">head</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">param</span><span class="o">.</span><span class="na">head</span><span class="o">.</span><span class="na">size</span><span class="o">()]);</span>
        <span class="nc">ExcelWriter</span> <span class="n">excelWriter</span> <span class="o">=</span> <span class="nc">EasyExcel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">fileName</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="nc">WriteSheet</span> <span class="n">writeSheet</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ExcelWriterSheetBuilder</span><span class="o">)</span><span class="nc">EasyExcel</span><span class="o">.</span><span class="na">writerSheet</span><span class="o">(</span><span class="n">sheetNum</span><span class="o">,</span> <span class="n">sheetName</span><span class="o">).</span><span class="na">needHead</span><span class="o">(</span><span class="kc">false</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">headList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">();</span>
        <span class="n">headList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">head</span><span class="o">.</span><span class="na">values</span><span class="o">()));</span>
        <span class="n">excelWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">headList</span><span class="o">,</span> <span class="n">writeSheet</span><span class="o">);</span>

        <span class="k">while</span><span class="o">(</span><span class="n">progress</span> <span class="o">&lt;</span> <span class="mi">100L</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setPagination</span><span class="o">(</span><span class="n">pagination</span><span class="o">);</span>
            <span class="nc">PaginationResult</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="nc">PaginationResult</span><span class="o">)</span><span class="n">function</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">((</span><span class="nc">Collection</span><span class="o">)</span><span class="n">result</span><span class="o">.</span><span class="na">getData</span><span class="o">()))</span> <span class="o">{</span>
                <span class="nc">ExportProgressHelper</span><span class="o">.</span><span class="na">setProgress</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="s">"100"</span><span class="o">,</span> <span class="mi">3600L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">lineCount</span> <span class="o">+</span> <span class="o">((</span><span class="nc">List</span><span class="o">)</span><span class="n">result</span><span class="o">.</span><span class="na">getData</span><span class="o">()).</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">++</span><span class="n">sheetNum</span><span class="o">;</span>
                <span class="n">sheetName</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="na">sheetName</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">sheetNum</span><span class="o">;</span>
                <span class="n">writeSheet</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ExcelWriterSheetBuilder</span><span class="o">)</span><span class="nc">EasyExcel</span><span class="o">.</span><span class="na">writerSheet</span><span class="o">(</span><span class="n">sheetNum</span><span class="o">,</span> <span class="n">sheetName</span><span class="o">).</span><span class="na">needHead</span><span class="o">(</span><span class="kc">false</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
                <span class="n">excelWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">headList</span><span class="o">,</span> <span class="n">writeSheet</span><span class="o">);</span>
                <span class="n">lineCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="c1">// 导出数据写入文件</span>
            <span class="n">lineCount</span> <span class="o">=</span> <span class="n">writeDataEasy</span><span class="o">(</span><span class="n">excelWriter</span><span class="o">,</span> <span class="n">writeSheet</span><span class="o">,</span> <span class="n">keys</span><span class="o">,</span> <span class="o">(</span><span class="nc">ArrayNode</span><span class="o">)</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">valueToTree</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getData</span><span class="o">()),</span> <span class="n">lineCount</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pagination</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0L</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pagination</span><span class="o">.</span><span class="na">setCount</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getPagination</span><span class="o">().</span><span class="na">getCount</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">pagination</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0L</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)(</span><span class="n">pagination</span><span class="o">.</span><span class="na">getPageNo</span><span class="o">()</span> <span class="o">*</span> <span class="n">pagination</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">()</span> <span class="o">*</span> <span class="mi">100</span><span class="o">)</span> <span class="o">/</span> <span class="n">pagination</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span>
                <span class="nc">ExportProgressHelper</span><span class="o">.</span><span class="na">setProgress</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">progress</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="mi">3600L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">pagination</span><span class="o">.</span><span class="na">setCountFlag</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">pagination</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5L</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">excelWriter</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="o">}</span>
  
      <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">writeDataEasy</span><span class="o">(</span><span class="nc">ExcelWriter</span> <span class="n">excelWriter</span><span class="o">,</span> <span class="nc">WriteSheet</span> <span class="n">writeSheet</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">keys</span><span class="o">,</span> <span class="nc">ArrayNode</span> <span class="n">datas</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lineCount</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&gt;</span> <span class="n">dataList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">();</span>

        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">datas</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">List</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">();</span>

            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">keys</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">j</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
                <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">getValue</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">datas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">dataList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">excelWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">dataList</span><span class="o">,</span> <span class="n">writeSheet</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">lineCount</span> <span class="o">+</span> <span class="n">datas</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="o">}</span>
  
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportEasySuccess</span><span class="o">(</span><span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="n">param</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">fileName</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">UploadMediaRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UploadMediaRequest</span><span class="o">();</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setSystem</span><span class="o">(</span><span class="nc">OssSystem</span><span class="o">.</span><span class="na">PASS_OSS</span><span class="o">.</span><span class="na">getSystemSign</span><span class="o">());</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setBucket</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">bucket</span><span class="o">)</span> <span class="o">?</span> <span class="s">"mcsp-public-store"</span> <span class="o">:</span> <span class="n">param</span><span class="o">.</span><span class="na">bucket</span><span class="o">);</span>
            <span class="nc">UploadResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="nc">MediaUploadHelper</span><span class="o">.</span><span class="na">upload</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
            <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setDownload</span><span class="o">(</span><span class="n">response</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="n">response</span><span class="o">.</span><span class="na">getUrl</span><span class="o">());</span>
            <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setFileSize</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
            <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setCostTime</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">param</span><span class="o">.</span><span class="na">startTime</span><span class="o">);</span>
            <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setExportStatus</span><span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">response</span> <span class="o">?</span> <span class="nc">ExportStatus</span><span class="o">.</span><span class="na">FAIL</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()</span> <span class="o">:</span> <span class="nc">ExportStatus</span><span class="o">.</span><span class="na">COMPLETED</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
            <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getRemark</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">exportRecordGenFeign</span><span class="o">.</span><span class="na">updateComExportRecord</span><span class="o">(</span><span class="nc">CommonRequest</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">FileUtil</span><span class="o">.</span><span class="na">delteTempFile</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportCancel</span><span class="o">(</span><span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="n">param</span><span class="o">,</span> <span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setCostTime</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">param</span><span class="o">.</span><span class="na">startTime</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setExportStatus</span><span class="o">(</span><span class="nc">ExportStatus</span><span class="o">.</span><span class="na">CANCEL</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
        <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">exportRecordGenFeign</span><span class="o">.</span><span class="na">updateComExportRecord</span><span class="o">(</span><span class="nc">CommonRequest</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">));</span>
    <span class="o">}</span>
  
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportFail</span><span class="o">(</span><span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="n">param</span><span class="o">,</span> <span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setCostTime</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">param</span><span class="o">.</span><span class="na">startTime</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setExportStatus</span><span class="o">(</span><span class="nc">ExportStatus</span><span class="o">.</span><span class="na">FAIL</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
        <span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">exportRecordGenFeign</span><span class="o">.</span><span class="na">updateComExportRecord</span><span class="o">(</span><span class="nc">CommonRequest</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">record</span><span class="o">));</span>
    <span class="o">}</span>
  
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ExcelParam</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">docName</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">sheetName</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">head</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">bucket</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">remark</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">Long</span> <span class="n">startTime</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">ComExportRecordGenDTO</span> <span class="n">record</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">async</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ExcelParam</span><span class="o">(</span><span class="nc">String</span> <span class="n">docName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">sheetName</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">docName</span> <span class="o">=</span> <span class="n">docName</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">sheetName</span> <span class="o">=</span> <span class="n">sheetName</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="nf">setDocName</span><span class="o">(</span><span class="nc">String</span> <span class="n">docName</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">docName</span> <span class="o">=</span> <span class="n">docName</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="nf">setSheetName</span><span class="o">(</span><span class="nc">String</span> <span class="n">sheetName</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">sheetName</span> <span class="o">=</span> <span class="n">sheetName</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="nf">setBucket</span><span class="o">(</span><span class="nc">String</span> <span class="n">bucket</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">bucket</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="nf">setRemark</span><span class="o">(</span><span class="nc">String</span> <span class="n">remark</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">remark</span> <span class="o">=</span> <span class="n">remark</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getRemark</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">remark</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">ExcelServiceImpl</span><span class="o">.</span><span class="na">ExcelParam</span> <span class="nf">addHead</span><span class="o">(</span><span class="nc">String</span> <span class="n">colunm</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">head</span> <span class="o">=</span> <span class="o">(</span><span class="nc">LinkedHashMap</span><span class="o">)</span><span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">head</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">head</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">colunm</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span> 
</code></pre></div></div>

<p>用到了EasyExcel 依赖与 jackson-databind依赖</p>

<p><img src="\assets\images\2021\springcloud\jackson-databind.png" alt="" /></p>

<p>DTO对象</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ComExportRecordGenDTO</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">filePrefix</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">download</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">fileSize</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">costTime</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">exportStatus</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>微服务Feign接口<code class="highlighter-rouge">ExportRecordAtoFeign</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@FeignClient</span><span class="o">(</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">"base-atomic-service"</span><span class="o">,</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">"/base-atomic"</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ExportRecordAtoFeign</span> <span class="o">{</span>
    <span class="nd">@PostMapping</span><span class="o">({</span><span class="s">"/export/lockExportRecord.ato.do"</span><span class="o">})</span>
    <span class="nc">Result</span><span class="o">&lt;</span><span class="nc">ComExportRecordGenDTO</span><span class="o">&gt;</span> <span class="nf">lockExportRecord</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">CommonRequest</span><span class="o">&lt;</span><span class="nc">LockExportRequest</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">);</span>

    <span class="nd">@PostMapping</span><span class="o">({</span><span class="s">"/export/exportRecordList.ato.do"</span><span class="o">})</span>
    <span class="nc">PaginationResult</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">ExportRecordAtoRespDTO</span><span class="o">&gt;&gt;</span> <span class="nf">exportRecordList</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">PaginationRequest</span><span class="o">&lt;</span><span class="nc">ExportQueryAtoReqDTO</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Component</span>
<span class="nd">@FeignClient</span><span class="o">(</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">"base-atomic-service"</span><span class="o">,</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">"/base-atomic"</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ComExportRecordGenFeign</span> <span class="o">{</span>
      <span class="nd">@PostMapping</span><span class="o">({</span><span class="s">"/comExportRecord/updateComExportRecord.gen.do"</span><span class="o">})</span>
    <span class="nc">Result</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="nf">updateComExportRecord</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">CommonRequest</span><span class="o">&lt;</span><span class="nc">ComExportRecordGenDTO</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>导出文件进度工具类<code class="highlighter-rouge">ExportProgressHelper</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExportProgressHelper</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EXPORT_PROGRESS_PREFIX</span> <span class="o">=</span> <span class="s">"EXPORT_PROGRESS:"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ExportProgressHelper</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">clearProgress</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">InitRedisConfig</span><span class="o">.</span><span class="na">BASE_REDIS_TEMPLATE</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="s">"EXPORT_PROGRESS:"</span> <span class="o">+</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setProgress</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">progress</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">timeUnit</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">InitRedisConfig</span><span class="o">.</span><span class="na">BASE_REDIS_TEMPLATE</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"EXPORT_PROGRESS:"</span> <span class="o">+</span> <span class="n">id</span><span class="o">,</span> <span class="s">"0"</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getProgress</span><span class="o">(</span><span class="nc">Long</span> <span class="n">jobId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="nc">InitRedisConfig</span><span class="o">.</span><span class="na">BASE_REDIS_TEMPLATE</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"EXPORT_PROGRESS:"</span> <span class="o">+</span> <span class="n">jobId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">listProgress</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">jobIds</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">();</span>
        <span class="nc">Iterator</span> <span class="n">var3</span> <span class="o">=</span> <span class="n">jobIds</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>

        <span class="k">while</span><span class="o">(</span><span class="n">var3</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Long</span> <span class="n">jobId</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Long</span><span class="o">)</span><span class="n">var3</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">keys</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"EXPORT_PROGRESS:"</span> <span class="o">+</span> <span class="n">jobId</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mget</span><span class="o">(</span><span class="n">keys</span><span class="o">);</span>
        <span class="nc">Iterator</span> <span class="n">var7</span> <span class="o">=</span> <span class="n">jobIds</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>

        <span class="k">while</span><span class="o">(</span><span class="n">var7</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Long</span> <span class="n">jobId</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Long</span><span class="o">)</span><span class="n">var7</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">jobId</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"EXPORT_PROGRESS:"</span> <span class="o">+</span> <span class="n">jobId</span><span class="o">,</span> <span class="s">""</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">mget</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keys</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="nc">InitRedisConfig</span><span class="o">.</span><span class="na">BASE_REDIS_TEMPLATE</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">multiGet</span><span class="o">(</span><span class="n">keys</span><span class="o">);</span>

        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">keys</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">keys</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>美的云上传OSS工具类<code class="highlighter-rouge">MediaUploadHelper</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MediaUploadHelper</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MediaUploadHelper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">OssUploadInterface</span><span class="o">&gt;</span> <span class="no">EXECUTOR_MAP</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">MediaUploadHelper</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
  
      <span class="kd">public</span> <span class="kd">static</span> <span class="nc">UploadResponse</span> <span class="nf">upload</span><span class="o">(</span><span class="nc">File</span> <span class="n">file</span><span class="o">,</span> <span class="nc">UploadMediaRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">UploadResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getSystem</span><span class="o">()))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">BussinessException</span><span class="o">(</span><span class="nc">ModuleErrorEnum</span><span class="o">.</span><span class="na">UPLOAD_EXECUTOR_EMPTY</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OssUploadInterface</span><span class="o">&gt;</span> <span class="n">executors</span> <span class="o">=</span> <span class="n">getExecutors</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getSystem</span><span class="o">());</span>

                <span class="nc">OssUploadInterface</span> <span class="n">executor</span><span class="o">;</span>
                <span class="k">for</span><span class="o">(</span><span class="nc">Iterator</span> <span class="n">var4</span> <span class="o">=</span> <span class="n">executors</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span> <span class="n">var4</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="n">response</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">upload</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="kc">null</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="na">getBucket</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="n">executor</span> <span class="o">=</span> <span class="o">(</span><span class="nc">OssUploadInterface</span><span class="o">)</span><span class="n">var4</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="o">}</span>

                <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="o">|</span> <span class="nc">InstantiationException</span> <span class="n">var6</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">SystemException</span><span class="o">(</span><span class="s">"OssUploadInterface init error"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/springboot/2021/03/11/10w-line-excel-import.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
