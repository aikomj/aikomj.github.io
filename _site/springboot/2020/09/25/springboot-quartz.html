<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 定时任务调度实战1 - 大伟的博客 </title>
    <meta name="keywords" content="springboot">
    <meta name="description"
          content="linux系统下使用crontab，在单体应用中使用Timer定时器，Spring Scheduled注解，Quartz框架，分布式调度框架xxl-job,elastic-job,saturn,tbschedule">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/springboot/2020/09/25/springboot-quartz.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="定时任务调度实战1">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>定时任务调度实战1</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/09/25
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1linux的crontab">1、Linux的crontab</h2>

<p>场景：使用<code class="highlighter-rouge">crontab -e</code>编辑定时器，执行一个jar包，生成的excel文件下载到本地</p>

<p>运行<code class="highlighter-rouge">crontab -e</code>，可以编辑定时器，然后加入如下命令：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /usr/local/java/jdk1.8/bin/java <span class="nt">-jar</span> /data/app/tool.jar <span class="o">&gt;</span> /logs/tool.log &amp;
</code></pre></div></div>

<p>就可以在<code class="highlighter-rouge">每天凌晨2点</code>，定时执行<code class="highlighter-rouge">tool.jar</code>程序，并且把日志输出到<code class="highlighter-rouge">tool.log</code>文件中。当然你也可以把后面的执行java程序的命令写成shell脚本，更方便维护。</p>

<p>crontab命令的基本格式如下:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crontab <span class="o">[</span>参数] <span class="o">[</span>文件名]
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">参数</th>
      <th style="text-align: center">功能</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">-u</td>
      <td style="text-align: center">指定用户</td>
    </tr>
    <tr>
      <td style="text-align: left">-e</td>
      <td style="text-align: center">编辑某个用户的crontab文件内容</td>
    </tr>
    <tr>
      <td style="text-align: left">-l</td>
      <td style="text-align: center">显示某个用户的crontab文件内容</td>
    </tr>
    <tr>
      <td style="text-align: left">-r</td>
      <td style="text-align: center">删除某用户的crontab文件</td>
    </tr>
    <tr>
      <td style="text-align: left">-i</td>
      <td style="text-align: center">删除某用户的crontab文件时需确认</td>
    </tr>
  </tbody>
</table>

<p>以上参数，如果没有使用<code class="highlighter-rouge">-u</code>指定用户，则默认使用的当前用户。</p>

<p>通过<code class="highlighter-rouge">crontab -e</code>命令编辑文件内容，具体语法如下：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>分] <span class="o">[</span>小时] <span class="o">[</span>日期] <span class="o">[</span>月] <span class="o">[</span>星期] 具体任务
</code></pre></div></div>

<ul>
  <li>分，表示多少分钟，范围：0-59</li>
  <li>小时，表示多少小时，范围：0-23</li>
  <li>日期，表示具体在哪一天，范围：1-31</li>
  <li>月，表示多少月，范围：1-12</li>
  <li>星期，表示多少周，范围：0-7，0和7都代表星期日</li>
</ul>

<p>其中，还有一些特殊字符：</p>

<ul>
  <li><code class="highlighter-rouge">*</code>代表如何时间，比如：<code class="highlighter-rouge">*1***</code> 表示每天凌晨1点执行。</li>
  <li><code class="highlighter-rouge">/</code>代表每隔多久执行一次，比如：<code class="highlighter-rouge">*/5 ****</code> 表示每隔5分钟执行一次。</li>
  <li><code class="highlighter-rouge">,</code>代表支持多个，比如：<code class="highlighter-rouge">10 7,9,12 ***</code> 表示在每天的7、9、12点10分各执行一次。</li>
  <li><code class="highlighter-rouge">-</code>代表支持一个范围，比如：<code class="highlighter-rouge">10 7-9 ***</code> 表示在每天的7、8、9点10分各执行一次。</li>
</ul>

<blockquote>
  <p>crond服务</p>
</blockquote>

<p>顺便说一下<code class="highlighter-rouge">crontab</code>需要<code class="highlighter-rouge">crond</code>服务支持，<code class="highlighter-rouge">crond</code>是<code class="highlighter-rouge">linux</code>下用来周期地执行某种任务的一个守护进程，在安装<code class="highlighter-rouge">linux</code>操作系统后，默认会安装<code class="highlighter-rouge">crond</code>服务工具，且<code class="highlighter-rouge">crond</code>服务默认就是自启动的。<code class="highlighter-rouge">crond</code>进程每分钟会定期检查是否有要执行的任务，如果有，则会自动执行该任务。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service crond status // 查看运行状态
service crond start //启动服务
service crond stop //关闭服务
service crond restart //重启服务
service crond reload //重新载入配置
</code></pre></div></div>

<p><strong>使用<code class="highlighter-rouge">crontab</code>的优缺点：</strong></p>

<ul>
  <li>优点：方便修改定时规则，支持一些较复杂的定时规则，通过文件可以统一管理配好的各种定时脚本</li>
  <li>缺点：如果定时任务非常多，不太好找，而且必须要求操作系统是<code class="highlighter-rouge">linux</code>，否则无法执行。</li>
</ul>

<h2 id="2whilesleep方案">2、while+sleep方案</h2>

<p>最简单定时，while+sleep方案，就是定义一个线程，然后 while 循环，通过 sleep 延迟时间来达到周期性调度任务。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeInterval</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"每隔5秒执行一次"</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">timeInterval</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>实现上非常简单，如果我们想在创建一个每隔3秒钟执行一次任务，怎么办呢？</p>

<p>同样的，也可以在创建一个线程，然后间隔性的调度方法；但是如果创建了大量这种类型的线程，这个时候会发现大量的定时任务线程在调度切换时性能消耗会非常大，而且整体效率低！</p>

<p>面对这种在情况，大佬们也想到了，于是想出了用一个线程将所有的定时任务存起来，事先排好序，按照一定的规则来调度，这样不就可以极大的减少每个线程的切换消耗吗？</p>

<p>正因此，JDK 中的 Timer 定时器由此诞生了！</p>

<h2 id="3timer定时器">3、Timer定时器</h2>

<h3 id="timer">Timer</h3>

<p><code class="highlighter-rouge">Timer</code>类是jdk专门提供的定时器工具，用来在后台线程计划执行指定任务，在<code class="highlighter-rouge">java.util</code>包下，要跟<code class="highlighter-rouge">TimerTask</code>一起配合使用。</p>

<p><img src="/assets/images/2021/javabase/timer.jpg" alt="" /></p>

<p><code class="highlighter-rouge">Timer</code>类其实是一个任务调度器，它里面包含了一个<code class="highlighter-rouge">TimerThread</code>线程，在这个线程中无限循环从<code class="highlighter-rouge">TaskQueue</code>中获取<code class="highlighter-rouge">TimerTask</code>（该类实现了Runnable接口），调用其<code class="highlighter-rouge">run</code>方法，就能异步执行定时任务。我们需要继承<code class="highlighter-rouge">TimerTask</code>类，实现它的<code class="highlighter-rouge">run</code>方法，在该方法中加上自己的业务逻辑。</p>

<p>首先看一个timer的例子</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Timer</span><span class="o">();</span>
    <span class="c1">//每隔1秒调用一次</span>
    <span class="n">timer</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="k">new</span> <span class="nc">TimerTask</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"test1"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="mi">1000</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
    <span class="c1">//每隔3秒调用一次</span>
    <span class="n">timer</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="k">new</span> <span class="nc">TimerTask</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"test2"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="mi">3000</span><span class="o">,</span> <span class="mi">3000</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>发现两个线程任务共用一个timer调度器，一起来看看源码</p>

<ul>
  <li>
    <p>进入Timer.schedule()方法</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">schedule</span><span class="o">(</span><span class="nc">TimerTask</span> <span class="n">task</span><span class="o">,</span> <span class="kt">long</span> <span class="n">delay</span><span class="o">,</span> <span class="kt">long</span> <span class="n">period</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Negative delay."</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">period</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Non-positive period."</span><span class="o">);</span>
    <span class="n">sched</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()+</span><span class="n">delay</span><span class="o">,</span> <span class="o">-</span><span class="n">period</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>从方法上可以看出，这里主要做参数验证，其中<code class="highlighter-rouge">TimerTask</code>是一个线程任务，<code class="highlighter-rouge">delay</code>表示延迟多久执行（单位毫秒），<code class="highlighter-rouge">period</code>表示多久执行一次（单位毫秒）</p>
  </li>
  <li>
    <p>接着看<code class="highlighter-rouge">sched()</code>方法</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">sched</span><span class="o">(</span><span class="nc">TimerTask</span> <span class="n">task</span><span class="o">,</span> <span class="kt">long</span> <span class="n">time</span><span class="o">,</span> <span class="kt">long</span> <span class="n">period</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Illegal execution time."</span><span class="o">);</span>
  
    <span class="c1">// Constrain value of period sufficiently to prevent numeric</span>
    <span class="c1">// overflow while still being effectively infinitely large.</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">period</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">))</span>
        <span class="n">period</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="o">;</span>
  
    <span class="kd">synchronized</span><span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">thread</span><span class="o">.</span><span class="na">newTasksMayBeScheduled</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Timer already cancelled."</span><span class="o">);</span>
  
        <span class="kd">synchronized</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">state</span> <span class="o">!=</span> <span class="nc">TimerTask</span><span class="o">.</span><span class="na">VIRGIN</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
                    <span class="s">"Task already scheduled or cancelled"</span><span class="o">);</span>
            <span class="n">task</span><span class="o">.</span><span class="na">nextExecutionTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">;</span>
            <span class="n">task</span><span class="o">.</span><span class="na">period</span> <span class="o">=</span> <span class="n">period</span><span class="o">;</span>
            <span class="n">task</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="nc">TimerTask</span><span class="o">.</span><span class="na">SCHEDULED</span><span class="o">;</span>
        <span class="o">}</span>
  
        <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">getMin</span><span class="o">()</span> <span class="o">==</span> <span class="n">task</span><span class="o">)</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>这步操作中，可以很清晰的看到，在同步代码块里，会将<code class="highlighter-rouge">task</code>对象加入到<code class="highlighter-rouge">queue</code>对象</p>
  </li>
  <li>
    <p>我们继续来看<code class="highlighter-rouge">queue</code>对象</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Timer</span> <span class="o">{</span>
      
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TaskQueue</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TaskQueue</span><span class="o">();</span>
  
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TimerThread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TimerThread</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
  
    <span class="kd">public</span> <span class="nf">Timer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="s">"Timer-"</span> <span class="o">+</span> <span class="n">serialNumber</span><span class="o">());</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="nf">Timer</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
  
    <span class="c1">//...</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>任务会进入到<code class="highlighter-rouge">TaskQueue</code>队列中，同时在<code class="highlighter-rouge">Timer</code>初始化阶段会将<code class="highlighter-rouge">TaskQueue</code>作为参数传入到<code class="highlighter-rouge">TimerThread</code>线程中，并且启动线程。</p>

    <p>而<code class="highlighter-rouge">TaskQueue</code>其实是一个最小堆的数据实体类，源码如下</p>

    <blockquote>
      <p>每当有新元素加入的时候，会对原来的数组进行重排，会将即将要执行的任务排在数组的前面</p>
    </blockquote>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TaskQueue</span> <span class="o">{</span>
      
    <span class="kd">private</span> <span class="nc">TimerTask</span><span class="o">[]</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TimerTask</span><span class="o">[</span><span class="mi">128</span><span class="o">];</span>
  
  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  
    <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="nc">TimerTask</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Grow backing store if necessary</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">queue</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">queue</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
  
        <span class="n">queue</span><span class="o">[++</span><span class="n">size</span><span class="o">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
        <span class="n">fixUp</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">fixUp</span><span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">[</span><span class="n">j</span><span class="o">].</span><span class="na">nextExecutionTime</span> <span class="o">&lt;=</span> <span class="n">queue</span><span class="o">[</span><span class="n">k</span><span class="o">].</span><span class="na">nextExecutionTime</span><span class="o">)</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nc">TimerTask</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">queue</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
   <span class="n">queue</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">queue</span><span class="o">[</span><span class="n">k</span><span class="o">];</span>
   <span class="n">queue</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">;</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
   
 <span class="c1">//....</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>最后我们来看看<code class="highlighter-rouge">TimerThread</code></p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TimerThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">newTasksMayBeScheduled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">TaskQueue</span> <span class="n">queue</span><span class="o">;</span>
  
    <span class="nc">TimerThread</span><span class="o">(</span><span class="nc">TaskQueue</span> <span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">mainLoop</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// Someone killed this Thread, behave as if Timer cancelled</span>
            <span class="kd">synchronized</span><span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">newTasksMayBeScheduled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>  <span class="c1">// Eliminate obsolete references</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="cm">/**
     * The main timer loop.  (See class comment.)
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">mainLoop</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">TimerTask</span> <span class="n">task</span><span class="o">;</span>
                <span class="kt">boolean</span> <span class="n">taskFired</span><span class="o">;</span>
                <span class="kd">synchronized</span><span class="o">(</span><span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Wait for queue to become non-empty</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">newTasksMayBeScheduled</span><span class="o">)</span>
                        <span class="n">queue</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span>
                        <span class="k">break</span><span class="o">;</span> <span class="c1">// Queue is empty and will forever remain; die</span>
  
                    <span class="c1">// Queue nonempty; look at first evt and do the right thing</span>
                    <span class="kt">long</span> <span class="n">currentTime</span><span class="o">,</span> <span class="n">executionTime</span><span class="o">;</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">getMin</span><span class="o">();</span>
                    <span class="kd">synchronized</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">lock</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">state</span> <span class="o">==</span> <span class="nc">TimerTask</span><span class="o">.</span><span class="na">CANCELLED</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">queue</span><span class="o">.</span><span class="na">removeMin</span><span class="o">();</span>
                            <span class="k">continue</span><span class="o">;</span>  <span class="c1">// No action required, poll queue again</span>
                        <span class="o">}</span>
                        <span class="n">currentTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
                        <span class="n">executionTime</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="na">nextExecutionTime</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">taskFired</span> <span class="o">=</span> <span class="o">(</span><span class="n">executionTime</span><span class="o">&lt;=</span><span class="n">currentTime</span><span class="o">))</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">period</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Non-repeating, remove</span>
                                <span class="n">queue</span><span class="o">.</span><span class="na">removeMin</span><span class="o">();</span>
                                <span class="n">task</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="nc">TimerTask</span><span class="o">.</span><span class="na">EXECUTED</span><span class="o">;</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">// Repeating task, reschedule</span>
                                <span class="n">queue</span><span class="o">.</span><span class="na">rescheduleMin</span><span class="o">(</span>
                                  <span class="n">task</span><span class="o">.</span><span class="na">period</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">?</span> <span class="n">currentTime</span>   <span class="o">-</span> <span class="n">task</span><span class="o">.</span><span class="na">period</span>
                                                <span class="o">:</span> <span class="n">executionTime</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="na">period</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">taskFired</span><span class="o">)</span> <span class="c1">// Task hasn't yet fired; wait</span>
                        <span class="n">queue</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="n">executionTime</span> <span class="o">-</span> <span class="n">currentTime</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">taskFired</span><span class="o">)</span>  <span class="c1">// Task fired; run it, holding no locks</span>
                    <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p><code class="highlighter-rouge">TimerThread</code>其实就是一个任务调度线程，首先从<code class="highlighter-rouge">TaskQueue</code>里面获取排在最前面的任务，然后判断它是否到达任务执行时间点，如果已到达，就会立刻执行任务</p>
  </li>
</ul>

<p><strong>总结</strong></p>

<p>相比 <strong>while + sleep</strong> 方案，多了一个线程来管理所有的任务，优点就是<strong>减少了线程之间的性能开销，提升了执行效率</strong>；但是同样也带来的了一些缺点，整体的新加任务写入效率变成了 O(log(n))。</p>

<p>缺点：</p>

<ul>
  <li><strong>串行阻塞</strong>：调度线程只有一个，长任务会阻塞短任务的执行，例如，A任务跑了一分钟，B任务至少需要等1分钟才能跑</li>
  <li><strong>容错能力差</strong>：没有异常处理能力，一旦一个任务执行故障，后续任务都无法执行</li>
</ul>

<p>阿里巴巴开发者规范中不建议使用它。</p>

<h3 id="scheduledthreadpoolexecutor">ScheduledThreadPoolExecutor</h3>

<p>鉴于 Timer 的上述缺陷，从 Java 5 开始，推出了基于线程池设计的 ScheduledThreadPoolExecutor 调度线程池。</p>

<p><img src="\assets\images\2021\juc\scheduled-thread-pool-executor.jpg" alt="" /></p>

<p>其设计思想是，每一个被调度的任务都会由线程池来管理执行，因此任务是并发执行的，相互之间不会受到干扰。需要注意的是，只有当任务的执行时间到来时，ScheduledThreadPoolExecutor 才会真正启动一个线程，其余时间 ScheduledThreadPoolExecutor 都是在轮询任务的状态。</p>

<p><strong>例子</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ScheduledThreadPoolExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ScheduledThreadPoolExecutor</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="c1">//启动1秒之后，每隔1秒执行一次</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">((</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"test3"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}),</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
    <span class="c1">//启动1秒之后，每隔3秒执行一次</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">((</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"test4"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}),</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>同样的，我们首先打开源码，看看里面到底做了啥</p>

<ul>
  <li>
    <p>进入<code class="highlighter-rouge">scheduleAtFixedRate()</code>方法</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">ScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">scheduleAtFixedRate</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">command</span><span class="o">,</span>
                                              <span class="kt">long</span> <span class="n">initialDelay</span><span class="o">,</span>
                                              <span class="kt">long</span> <span class="n">period</span><span class="o">,</span>
                                              <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">command</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">unit</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">period</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
    <span class="nc">ScheduledFutureTask</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">sft</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nc">ScheduledFutureTask</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;(</span><span class="n">command</span><span class="o">,</span>
                                      <span class="kc">null</span><span class="o">,</span>
                                      <span class="n">triggerTime</span><span class="o">(</span><span class="n">initialDelay</span><span class="o">,</span> <span class="n">unit</span><span class="o">),</span>
                                      <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">period</span><span class="o">));</span>
    <span class="nc">RunnableScheduledFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">decorateTask</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="n">sft</span><span class="o">);</span>
    <span class="n">sft</span><span class="o">.</span><span class="na">outerTask</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
    <span class="n">delayedExecute</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>首先是校验基本参数，然后将任务作为封装到<code class="highlighter-rouge">ScheduledFutureTask</code>线程中，<code class="highlighter-rouge">ScheduledFutureTask</code>继承自<code class="highlighter-rouge">RunnableScheduledFuture</code>，并作为参数调用<code class="highlighter-rouge">delayedExecute()</code>方法进行预处理</p>
  </li>
  <li>
    <p>进入<code class="highlighter-rouge">delayedExecute()</code>方法</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">delayedExecute</span><span class="o">(</span><span class="nc">RunnableScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isShutdown</span><span class="o">())</span>
        <span class="n">reject</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">getQueue</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isShutdown</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">canRunInCurrentRunState</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">isPeriodic</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
            <span class="n">remove</span><span class="o">(</span><span class="n">task</span><span class="o">))</span>
            <span class="n">task</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">else</span>
   <span class="c1">//预处理</span>
            <span class="n">ensurePrestart</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>可以很清晰的看到，当线程池没有关闭的时候，会通过<code class="highlighter-rouge">super.getQueue().add(task)</code>操作，将任务加入到队列，同时调用<code class="highlighter-rouge">ensurePrestart()</code>方法做预处理</p>

    <p>其中<code class="highlighter-rouge">super.getQueue()</code>得到的是一个自定义的<code class="highlighter-rouge">new DelayedWorkQueue()</code>阻塞队列，数据存储方面也是一个最小堆结构的队列，这一点在初始化<code class="highlighter-rouge">new ScheduledThreadPoolExecutor()</code>的时候，可以看出！</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">ScheduledThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="no">NANOSECONDS</span><span class="o">,</span>
          <span class="k">new</span> <span class="nf">DelayedWorkQueue</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>打开源码可以看到，<code class="highlighter-rouge">DelayedWorkQueue</code>其实是<code class="highlighter-rouge">ScheduledThreadPoolExecutor</code>中的一个静态内部类，在添加的时候，会将任务加入到<code class="highlighter-rouge">RunnableScheduledFuture</code>数组中，同时线程池中的<code class="highlighter-rouge">Woker</code>线程会通过调用任务队列中的<code class="highlighter-rouge">take()</code>方法获取对应的<code class="highlighter-rouge">ScheduledFutureTask</code>线程任务，接着执行对应的任务线程</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="kd">class</span> <span class="nc">DelayedWorkQueue</span> <span class="kd">extends</span> <span class="nc">AbstractQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span>
        <span class="kd">implements</span> <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="o">{</span>
  
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">INITIAL_CAPACITY</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">RunnableScheduledFuture</span><span class="o">&lt;?&gt;[]</span> <span class="n">queue</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nc">RunnableScheduledFuture</span><span class="o">&lt;?&gt;[</span><span class="no">INITIAL_CAPACITY</span><span class="o">];</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>   
  
    <span class="c1">//....</span>
  
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">offer</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="nc">RunnableScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">RunnableScheduledFuture</span><span class="o">&lt;?&gt;)</span><span class="n">x</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">queue</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
                <span class="n">grow</span><span class="o">();</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">queue</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="n">setIndex</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">siftUp</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">leader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">available</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="nc">RunnableScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">take</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
                <span class="nc">RunnableScheduledFuture</span><span class="o">&lt;?&gt;</span> <span class="n">first</span> <span class="o">=</span> <span class="n">queue</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">available</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">getDelay</span><span class="o">(</span><span class="no">NANOSECONDS</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">delay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
                        <span class="k">return</span> <span class="nf">finishPoll</span><span class="o">(</span><span class="n">first</span><span class="o">);</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// don't retain ref while waiting</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">leader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">available</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="nc">Thread</span> <span class="n">thisThread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                        <span class="n">leader</span> <span class="o">=</span> <span class="n">thisThread</span><span class="o">;</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">available</span><span class="o">.</span><span class="na">awaitNanos</span><span class="o">(</span><span class="n">delay</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">leader</span> <span class="o">==</span> <span class="n">thisThread</span><span class="o">)</span>
                                <span class="n">leader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">leader</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">queue</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">available</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>回到我们最开始说到的<code class="highlighter-rouge">ScheduledFutureTask</code>任务线程类，最终执行任务的其实就是它</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ScheduledFutureTask</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">RunnableScheduledFuture</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
  
    <span class="cm">/** Sequence number to break ties FIFO */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">sequenceNumber</span><span class="o">;</span>
  
    <span class="cm">/** The time the task is enabled to execute in nanoTime units */</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">time</span><span class="o">;</span>
  
    <span class="cm">/**
     * Period in nanoseconds for repeating tasks.  A positive
     * value indicates fixed-rate execution.  A negative value
     * indicates fixed-delay execution.  A value of 0 indicates a
     * non-repeating task.
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">period</span><span class="o">;</span>
  
    <span class="cm">/** The actual task to be re-enqueued by reExecutePeriodic */</span>
    <span class="nc">RunnableScheduledFuture</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">outerTask</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
  
    <span class="cm">/**
     * Overrides FutureTask version so as to reset/requeue if periodic.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">periodic</span> <span class="o">=</span> <span class="n">isPeriodic</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">canRunInCurrentRunState</span><span class="o">(</span><span class="n">periodic</span><span class="o">))</span>
            <span class="n">cancel</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">periodic</span><span class="o">)</span>
            <span class="nc">ScheduledFutureTask</span><span class="o">.</span><span class="na">super</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">ScheduledFutureTask</span><span class="o">.</span><span class="na">super</span><span class="o">.</span><span class="na">runAndReset</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">setNextRunTime</span><span class="o">();</span>
            <span class="n">reExecutePeriodic</span><span class="o">(</span><span class="n">outerTask</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
 <span class="c1">//...</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p><code class="highlighter-rouge">ScheduledFutureTask</code>任务线程，才是真正执行任务的线程类，只是绕了一圈，做了很多包装，<code class="highlighter-rouge">run()</code>方法就是真正执行定时任务的方法。</p>
  </li>
</ul>

<blockquote>
  <p>小结</p>
</blockquote>

<p>ScheduledExecutorService 相比 Timer 定时器，完美的解决上面说到的 Timer 存在的两个缺点！</p>

<font style="color:red">在单体应用里面</font>
<p>，使用 ScheduledExecutorService 可以解决大部分需要使用定时任务的业务需求！</p>

<p>但是这是否意味着它是最佳的解决方案呢？</p>

<p>我们发现线程池中 ScheduledExecutorService 的排序容器跟 Timer 一样，都是采用最小堆的存储结构，新任务加入排序效率是<code class="highlighter-rouge">O(log(n))</code>，执行取任务是<code class="highlighter-rouge">O(1)</code>。</p>

<p>这里的写入排序效率其实是有空间可提升的，有可能优化到<code class="highlighter-rouge">O(1)</code>的时间复杂度，也就是我们下面要介绍的<strong>时间轮实现</strong>！</p>

<h3 id="时间轮实现">时间轮实现</h3>

<p>所谓时间轮（RingBuffer）实现，从数据结构上看，简单的说就是循环队列，从名称上看可能感觉很抽象。</p>

<p>它其实就是一个环形的数组，如图所示，假设我们创建了一个长度为 8 的时间轮</p>

<p><img src="\assets\images\2021\juc\scheudler-1.jpg" alt="" /></p>

<blockquote>
  <p>1、插入、取值流程</p>
</blockquote>

<ul>
  <li>1.当我们需要新建一个 1s 延时任务的时候，则只需要将它放到下标为 1 的那个槽中，2、3、…、7也同样如此。</li>
  <li>2.而如果是新建一个 10s 的延时任务，则需要将它放到下标为 2 的槽中，但同时需要记录它所对应的圈数，也就是 1 圈，不然就和 2 秒的延时消息重复了</li>
  <li>3.当创建一个 21s 的延时任务时，它所在的位置就在下标为 5 的槽中，同样的需要为他加上圈数为 2，依次类推…</li>
</ul>

<p>因此，总结起来有两个核心的变量：</p>

<ul>
  <li>数组下标：表示某个任务延迟时间，从数据操作上对执行时间点进行取余</li>
  <li>圈数：表示需要循环圈数</li>
</ul>

<p>通过这张图可以更直观的理解！</p>

<p><img src="\assets\images\2021\juc\scheudler-2.jpg" alt="" /></p>

<p>当我们需要取出延时任务时，只需要每秒往下移动这个指针，然后取出该位置的所有任务即可，取任务的时间消耗为<code class="highlighter-rouge">O(1)</code>。</p>

<p>当我们需要插入任务式，也只需要计算出对应的下表和圈数，即可将任务插入到对应的数组位置中，插入任务的时间消耗为<code class="highlighter-rouge">O(1)</code>。</p>

<p>如果时间轮的槽比较少，会导致某一个槽上的任务非常多，那么效率也比较低，这就和 HashMap 的 hash 冲突是一样的，因此在设计槽的时候不能太大也不能太小。</p>

<blockquote>
  <p>2、代码实现</p>
</blockquote>

<p>首先创建一个<code class="highlighter-rouge">RingBufferWheel</code>时间轮定时任务管理器</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RingBufferWheel</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">RingBufferWheel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>


    <span class="cm">/**
     * default ring buffer size
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">STATIC_RING_SIZE</span> <span class="o">=</span> <span class="mi">64</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">ringBuffer</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="o">;</span>

    <span class="cm">/**
     * business thread pool
     */</span>
    <span class="kd">private</span> <span class="nc">ExecutorService</span> <span class="n">executorService</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="cm">/***
     * task stop sign
     */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="cm">/**
     * task start sign
     */</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">AtomicBoolean</span> <span class="n">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicBoolean</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

    <span class="cm">/**
     * total tick times
     */</span>
    <span class="kd">private</span> <span class="nc">AtomicInteger</span> <span class="n">tick</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>

    <span class="kd">private</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>

    <span class="kd">private</span> <span class="nc">AtomicInteger</span> <span class="n">taskId</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Task</span><span class="o">&gt;</span> <span class="n">taskMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;(</span><span class="mi">16</span><span class="o">);</span>

    <span class="cm">/**
     * Create a new delay task ring buffer by default size
     *
     * @param executorService the business thread pool
     */</span>
    <span class="kd">public</span> <span class="nf">RingBufferWheel</span><span class="o">(</span><span class="nc">ExecutorService</span> <span class="n">executorService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executorService</span> <span class="o">=</span> <span class="n">executorService</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bufferSize</span> <span class="o">=</span> <span class="no">STATIC_RING_SIZE</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ringBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">bufferSize</span><span class="o">];</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Create a new delay task ring buffer by custom buffer size
     *
     * @param executorService the business thread pool
     * @param bufferSize      custom buffer size
     */</span>
    <span class="kd">public</span> <span class="nf">RingBufferWheel</span><span class="o">(</span><span class="nc">ExecutorService</span> <span class="n">executorService</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bufferSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">executorService</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">powerOf2</span><span class="o">(</span><span class="n">bufferSize</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"bufferSize=["</span> <span class="o">+</span> <span class="n">bufferSize</span> <span class="o">+</span> <span class="s">"] must be a power of 2"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bufferSize</span> <span class="o">=</span> <span class="n">bufferSize</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ringBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">bufferSize</span><span class="o">];</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Add a task into the ring buffer(thread safe)
     *
     * @param task business task extends {@link Task}
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">addTask</span><span class="o">(</span><span class="nc">Task</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">key</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mod</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">bufferSize</span><span class="o">);</span>
            <span class="n">task</span><span class="o">.</span><span class="na">setIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

            <span class="kt">int</span> <span class="n">cycleNum</span> <span class="o">=</span> <span class="n">cycleNum</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">bufferSize</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tasks</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">task</span><span class="o">.</span><span class="na">setCycleNum</span><span class="o">(</span><span class="n">cycleNum</span><span class="o">);</span>
                <span class="n">tasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">task</span><span class="o">.</span><span class="na">setIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="n">task</span><span class="o">.</span><span class="na">setCycleNum</span><span class="o">(</span><span class="n">cycleNum</span><span class="o">);</span>
                <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="n">sets</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
                <span class="n">sets</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
                <span class="n">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">sets</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">id</span> <span class="o">=</span> <span class="n">taskId</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
            <span class="n">task</span><span class="o">.</span><span class="na">setTaskId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
            <span class="n">taskMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
            <span class="n">size</span><span class="o">++;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">start</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Cancel task by taskId
     * @param id unique id through {@link #addTask(Task)}
     * @return
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">cancel</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>

        <span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="n">tempTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="nc">Task</span> <span class="n">task</span> <span class="o">=</span> <span class="n">taskMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getIndex</span><span class="o">());</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Task</span> <span class="n">tk</span> <span class="o">:</span> <span class="n">tasks</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">tk</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">tk</span><span class="o">.</span><span class="na">getCycleNum</span><span class="o">()</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="na">getCycleNum</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">size</span><span class="o">--;</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">taskMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">tempTask</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">tk</span><span class="o">);</span>
                <span class="o">}</span>

            <span class="o">}</span>
            <span class="c1">//update origin data</span>
            <span class="n">ringBuffer</span><span class="o">[</span><span class="n">task</span><span class="o">.</span><span class="na">getIndex</span><span class="o">()]</span> <span class="o">=</span> <span class="n">tempTask</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">flag</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Thread safe
     *
     * @return the size of ring buffer
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">taskSize</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Same with method {@link #taskSize}
     * @return
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">taskMapSize</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">taskMap</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Start background thread to consumer wheel timer, it will always run until you call method {@link #stop}
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">start</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">start</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">start</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Delay task is starting"</span><span class="o">);</span>
                <span class="nc">Thread</span> <span class="n">job</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">TriggerJob</span><span class="o">());</span>
                <span class="n">job</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"consumer RingBuffer thread"</span><span class="o">);</span>
                <span class="n">job</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
                <span class="n">start</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Stop consumer ring buffer thread
     *
     * @param force True will force close consumer thread and discard all pending tasks
     *              otherwise the consumer thread waits for all tasks to completes before closing.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">force</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">force</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Delay task is forced stop"</span><span class="o">);</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">shutdownNow</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Delay task is stopping"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">taskSize</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                    <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"InterruptedException"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="o">}</span>


    <span class="o">}</span>


    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;)</span> <span class="n">ringBuffer</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="n">tasks</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mod</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">bufferSize</span><span class="o">);</span>
        <span class="n">ringBuffer</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Remove and get task list.
     * @param key
     * @return task list
     */</span>
    <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="n">tempTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>

        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;)</span> <span class="n">ringBuffer</span><span class="o">[</span><span class="n">key</span><span class="o">];</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tasks</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">Task</span> <span class="n">task</span> <span class="o">:</span> <span class="n">tasks</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getCycleNum</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>

                <span class="n">size2Notify</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// decrement 1 cycle number and update origin data</span>
                <span class="n">task</span><span class="o">.</span><span class="na">setCycleNum</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getCycleNum</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
                <span class="n">tempTask</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// remove task, and free the memory.</span>
            <span class="n">taskMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getTaskId</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">//update origin data</span>
        <span class="n">ringBuffer</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">tempTask</span><span class="o">;</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">size2Notify</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="n">size</span><span class="o">--;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">condition</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">powerOf2</span><span class="o">(</span><span class="kt">int</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">target</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">target</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">mod</span><span class="o">(</span><span class="kt">int</span> <span class="n">target</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mod</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// equals target % mod</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="n">tick</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">target</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">mod</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">cycleNum</span><span class="o">(</span><span class="kt">int</span> <span class="n">target</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mod</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//equals target/mod</span>
        <span class="k">return</span> <span class="n">target</span> <span class="o">&gt;&gt;</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">bitCount</span><span class="o">(</span><span class="n">mod</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * An abstract class used to implement business.
     */</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="n">cycleNum</span><span class="o">;</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="n">key</span><span class="o">;</span>

        <span class="cm">/**
         * The unique ID of the task
         */</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">taskId</span> <span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getKey</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         *
         * @param key Delay time(seconds)
         */</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setKey</span><span class="o">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCycleNum</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">cycleNum</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setCycleNum</span><span class="o">(</span><span class="kt">int</span> <span class="n">cycleNum</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">cycleNum</span> <span class="o">=</span> <span class="n">cycleNum</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getIndex</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getTaskId</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">taskId</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTaskId</span><span class="o">(</span><span class="kt">int</span> <span class="n">taskId</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">taskId</span> <span class="o">=</span> <span class="n">taskId</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">TriggerJob</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">stop</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Task</span><span class="o">&gt;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="n">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                    <span class="k">for</span> <span class="o">(</span><span class="nc">Task</span> <span class="n">task</span> <span class="o">:</span> <span class="n">tasks</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="k">if</span> <span class="o">(++</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">bufferSize</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="c1">//Total tick number of records</span>
                    <span class="n">tick</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
                    <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Exception"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>

            <span class="o">}</span>

            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Delay task has stopped"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>接着，编写一个客户端，测试客户端</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">RingBufferWheel</span> <span class="n">ringBufferWheel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RingBufferWheel</span><span class="o">(</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">RingBufferWheel</span><span class="o">.</span><span class="na">Task</span> <span class="n">job</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Job</span><span class="o">();</span>
        <span class="n">job</span><span class="o">.</span><span class="na">setKey</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">ringBufferWheel</span><span class="o">.</span><span class="na">addTask</span><span class="o">(</span><span class="n">job</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Job</span> <span class="kd">extends</span> <span class="nc">RingBufferWheel</span><span class="o">.</span><span class="na">Task</span><span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"test5"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>执行结果</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test5</span>
<span class="n">test5</span>
<span class="n">test5</span>
</code></pre></div></div>

<p>如果要周期性执行任务，可以在任务执行完成之后，再重新加入到时间轮中。</p>

<p>详细源码分析地址：[https://crossoverjie.top/2019/09/27/algorithm/time%20wheel/]</p>

<h2 id="4scheduledexecutorservice">4、ScheduledExecutorService</h2>

<p><code class="highlighter-rouge">ScheduledExecutorService</code>是基于多线程的，设计的初衷是为了解决<code class="highlighter-rouge">Timer</code>单线程执行，多个任务之间会互相影响的问题。</p>

<p>它主要包含4个方法：</p>

<ul>
  <li><code class="highlighter-rouge">schedule(Runnable command,long delay,TimeUnit unit)</code>，带延迟时间的调度，只执行一次，调度之后可通过Future.get()阻塞直至任务执行完毕。</li>
  <li>
    <p><code class="highlighter-rouge">schedule(Callable&lt;V&gt; callable,long delay,TimeUnit unit)</code>，带延迟时间的调度，只执行一次，调度之后可通过Future.get()阻塞直至任务执行完毕，并且可以获取执行结果。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">scheduleAtFixedRate</code>，表示以固定频率执行的任务，如果当前任务耗时较多，超过定时周期period，则当前任务结束后会立即执行。</p>
  </li>
  <li><code class="highlighter-rouge">scheduleWithFixedDelay</code>，表示以固定延时执行任务，延时是相对当前任务结束为起点计算开始时间。</li>
</ul>

<p>具体代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ScheduleExecutorTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ScheduledExecutorService</span> <span class="n">scheduledExecutorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newScheduledThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="n">scheduledExecutorService</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"doSomething"</span><span class="o">);</span>
    <span class="o">},</span><span class="mi">1000</span><span class="o">,</span><span class="mi">1000</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>调用<code class="highlighter-rouge">ScheduledExecutorService</code>类的<code class="highlighter-rouge">scheduleAtFixedRate</code>方法实现周期性任务，每隔1秒钟执行一次，每次延迟1秒再执行。</p>

<p>这种定时任务是阿里巴巴开发者规范中用来替代<code class="highlighter-rouge">Timer</code>类的方案，对于多线程执行周期性任务，是个不错的选择。</p>

<p><mark>优点：</mark>基于多线程的定时任务，多个任务之间不会相关影响，支持周期性的执行任务，并且带延迟功能</p>

<p><mark>缺点：</mark>不支持一些较复杂的定时规则</p>

<h2 id="5spring-task">5、Spring task</h2>

<h3 id="注解schedule">注解@Schedule</h3>

<p>Spring实现定时任务，首先说它支持的定时任务注解@Scheduled，支持cron表达式，代码内嵌简单的定时任务，例子：</p>

<p>1、pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、springboot启动类加上<code class="highlighter-rouge">@EnableScheduling</code>注解</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableAsync</span> <span class="c1">// 开启异步注解的支持</span>
<span class="nd">@EnableScheduling</span> <span class="c1">// 开启定时任务的支持</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringBootDataStudyXjwApplication</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">SpringBootDataStudyXjwApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3、定时任务</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 定时任务类</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ScheduledService</span> <span class="o">{</span>
	<span class="c1">// 每分钟执行一次</span>
	<span class="nd">@Scheduled</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="s">"0 * * * * ?"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello ......"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span> 
</code></pre></div></div>

<p>application.properties配置参数的方式</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 每10执行一次
</span><span class="py">sue.spring.task.cron</span><span class="p">=</span><span class="s">*/10 * * * * ?</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringTaskTest</span> <span class="o">{</span>
    <span class="nd">@Scheduled</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="s">"${sue.spring.task.cron}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fun</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"doSomething"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>cron规则</p>
</blockquote>

<p>spring4以上的版本中，cron表达式包含6个参数：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>秒] <span class="o">[</span>分] <span class="o">[</span>时] <span class="o">[</span>日期] <span class="o">[</span>月] <span class="o">[</span>星期]

秒: 取值范围：0-59，支持<span class="k">*</span>、,、-、/。
分: 取值范围：0-59，支持<span class="k">*</span>、,、-、/。
时: 取值范围：0-23，支持<span class="k">*</span>、,、-、/。
日期: 取值范围：1-31，支持<span class="k">*</span>、,、-、/。比秒多了?，表示如果指定的星期触发了，则配置的日期变成无效。
月: 取值范围：1-12，支持<span class="k">*</span>、,、-、/。
星期: 取值范围：1~7，1代表星期天，6代表星期六，其他的以此类推。支持<span class="k">*</span>、,、-、/、?。比秒多了?，表示如果指定的日期触发了，则配置的星期变成无效。
</code></pre></div></div>

<p>与Linux的crontab规则是一样的</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>：表示任何时间触发任务
,：表示指定的时间触发任务
-：表示一段时间内触发任务
/：表示从哪一个时刻开始，每隔多长时间触发一次任务。
?：表示用于月中的天和周中的天两个子表达式，表示不指定值。
</code></pre></div></div>

<p>举例：</p>

<ul>
  <li><code class="highlighter-rouge">0 0 0 1 * ?</code> 每月1号零点执行</li>
  <li><code class="highlighter-rouge">0 0 2 * * ?</code> 每天凌晨2点执行</li>
  <li><code class="highlighter-rouge">0 0 2 * * ?</code> 每天凌晨2点执行</li>
  <li><code class="highlighter-rouge">0 0/5 11 * * ?</code> 每天11点-11点55分，每隔5分钟执行一次</li>
  <li><code class="highlighter-rouge">0 0 18 ? * WED</code> 每周三下午6点执行</li>
</ul>

<p>spring task先通过ScheduledAnnotationBeanPostProcessor类的processScheduled方法，解析和收集<code class="highlighter-rouge">Scheduled</code>注解中的参数，包含：cron表达式。</p>

<p>然后在ScheduledTaskRegistrar类的afterPropertiesSet方法中，默认初始化一个<mark>单线程</mark>的<code class="highlighter-rouge">ThreadPoolExecutor</code>执行任务。</p>

<p><mark>优点：</mark></p>

<ul>
  <li>spring框架自带的定时功能，springboot做了非常好的封装，开启和定义定时任务非常容易，支持复杂的<code class="highlighter-rouge">cron</code>表达式，可以满足绝大多数单机版的业务场景。单个任务时，当前次的调度完成后，再执行下一次任务调度。</li>
</ul>

<p><mark>缺点：</mark></p>

<ul>
  <li>默认单线程，如果前面的任务执行时间太长，对后面任务的执行有影响。不支持集群方式部署，不能做数据存储型定时任务</li>
</ul>

<h2 id="6定时框架quartz">6、定时框架Quartz</h2>

<h3 id="quartz的架构图">Quartz的架构图</h3>

<p><img src="\assets\images\2021\juc\quartz.png" alt="" /></p>

<p>从图中可以看出，Quartz 框架主要包括如下几个部分：</p>

<ul>
  <li><strong>SchedulerFactory</strong>：任务调度工厂，主要负责管理任务调度器</li>
  <li><strong>Scheduler</strong>：任务调度控制器，主要是负责任务调度</li>
  <li><strong>Job</strong>：任务接口，即被调度的任务</li>
  <li><strong>JobDetail</strong>：Job 的任务描述类，job 执行时会依据此对象的信息反射实例化出 Job 的具体执行对象。</li>
  <li><strong>Trigger</strong>：任务触发器，主要存放 Job 执行的时间策略。例如多久执行一次，什么时候执行，以什么频率执行等等</li>
  <li><strong>Calendar</strong>：Trigger 扩展对象，可以排除或者包含某个指定的时间点（如排除法定节假日）</li>
  <li><strong>JobStore</strong>：存储作业和任务调度期间的状态</li>
</ul>

<p>看个简单的例子</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuartzTest</span> <span class="kd">implements</span> <span class="nc">Job</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JobExecutionException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SchedulerException</span> <span class="o">{</span>
        <span class="c1">// 创建一个Scheduler</span>
        <span class="nc">Scheduler</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="nc">StdSchedulerFactory</span><span class="o">.</span><span class="na">getDefaultScheduler</span><span class="o">();</span>
        <span class="c1">// 启动Scheduler</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// 新建一个Job, 指定执行类是QuartzTest, 指定一个K/V类型的数据, 指定job的name和group</span>
        <span class="nc">JobDetail</span> <span class="n">job</span> <span class="o">=</span> <span class="nc">JobBuilder</span><span class="o">.</span><span class="na">newJob</span><span class="o">(</span><span class="nc">QuartzTest</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">usingJobData</span><span class="o">(</span><span class="s">"jobData"</span><span class="o">,</span> <span class="s">"test"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withIdentity</span><span class="o">(</span><span class="s">"myJob"</span><span class="o">,</span> <span class="s">"myJobGroup"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="c1">// 新建一个Trigger, 表示JobDetail的调度计划, 这里的cron表达式是 每1秒执行一次</span>
        <span class="nc">Trigger</span> <span class="n">trigger</span> <span class="o">=</span> <span class="nc">TriggerBuilder</span><span class="o">.</span><span class="na">newTrigger</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withIdentity</span><span class="o">(</span><span class="s">"myTrigger"</span><span class="o">,</span> <span class="s">"myTriggerGroup"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">startNow</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withSchedule</span><span class="o">(</span><span class="nc">CronScheduleBuilder</span><span class="o">.</span><span class="na">cronSchedule</span><span class="o">(</span><span class="s">"0/5 * * * * ?"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="c1">// 让scheduler开始调度这个job, 按trigger指定的计划</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="na">scheduleJob</span><span class="o">(</span><span class="n">job</span><span class="o">,</span> <span class="n">trigger</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>执行结果</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">09</span> <span class="mi">21</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">40</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">09</span> <span class="mi">21</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">45</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">09</span> <span class="mi">21</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">50</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">09</span> <span class="mi">21</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">55</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">09</span> <span class="mi">21</span><span class="o">:</span><span class="mi">39</span><span class="o">:</span><span class="mo">00</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">09</span> <span class="mi">21</span><span class="o">:</span><span class="mi">39</span><span class="o">:</span><span class="mo">05</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">09</span> <span class="mi">21</span><span class="o">:</span><span class="mi">39</span><span class="o">:</span><span class="mi">10</span>
</code></pre></div></div>

<p>整个代码虽然简单，但是五脏俱全，在应用方面使用最多的就是<code class="highlighter-rouge">Job</code>和<code class="highlighter-rouge">Trigger</code>。</p>

<h3 id="分析源码">分析源码</h3>

<blockquote>
  <p>1、Job</p>
</blockquote>

<p>打开<code class="highlighter-rouge">Job</code>源码，里面其实就是一个包含执行方法<code class="highlighter-rouge">void execute(JobExecutionContext context)</code>的接口，开发者只需实现接口来定义具体任务即可！</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Job</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JobExecutionException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">JobExecutionContext</code> 类封装了获取上下文的各种信息，<code class="highlighter-rouge">Job</code>运行时的信息也保存在 <code class="highlighter-rouge">JobDataMap</code> 实例中！例如，我想要获取在上文初始化时使用到的<code class="highlighter-rouge">usingJobData("jobData", "test")</code>参数，可以通过如下方式进行获取！</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JobExecutionException</span> <span class="o">{</span>
    <span class="c1">//从context中获取instName，groupName以及dataMap</span>
    <span class="nc">String</span> <span class="n">jobName</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getJobDetail</span><span class="o">().</span><span class="na">getKey</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">groupName</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getJobDetail</span><span class="o">().</span><span class="na">getKey</span><span class="o">().</span><span class="na">getGroup</span><span class="o">();</span>
    <span class="nc">JobDataMap</span> <span class="n">dataMap</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getJobDetail</span><span class="o">().</span><span class="na">getJobDataMap</span><span class="o">();</span>
    <span class="c1">//从dataMap中获取myDescription，myValue以及myArray</span>
    <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">dataMap</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"jobData"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"jobName:"</span> <span class="o">+</span> <span class="n">jobName</span> <span class="o">+</span> <span class="s">",groupName:"</span> <span class="o">+</span> <span class="n">groupName</span> <span class="o">+</span> <span class="s">",jobData:"</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>输出结果：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">jobName:</span><span class="n">myJob</span><span class="o">,</span><span class="nl">groupName:</span><span class="n">myJobGroup</span><span class="o">,</span><span class="nl">jobData:</span><span class="n">test</span>
</code></pre></div></div>

<blockquote>
  <p>2、Trigger</p>
</blockquote>

<p><code class="highlighter-rouge">Trigger</code>主要用于描述<code class="highlighter-rouge">Job</code>执行的时间触发规则，最常用的有<code class="highlighter-rouge">SimpleTrigger</code>和<code class="highlighter-rouge">CronTrigger</code>两个实现类型。</p>

<ul>
  <li><strong>SimpleTrigger</strong>：主要处理一些简单的调度规则，例如触发一次或者以固定时间间隔周期执行</li>
  <li><strong>CronTrigger</strong>：调度处理更加灵活，可以通过<code class="highlighter-rouge">Cron</code>表达式定义出各种复杂时间规则的调度方案，例如每早晨9:00执行，周一、周三、周五下午5:00执行等；</li>
</ul>

<p>用<code class="highlighter-rouge">SimpleTrigger</code>实现每2秒钟执行一次任务为例，代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SchedulerException</span> <span class="o">{</span>
    <span class="c1">//构建一个JobDetail实例...</span>

    <span class="c1">// 构建一个Trigger，指定Trigger名称和组，规定该Job立即执行，且两秒钟重复执行一次</span>
    <span class="nc">SimpleTrigger</span> <span class="n">trigger</span> <span class="o">=</span> <span class="nc">TriggerBuilder</span><span class="o">.</span><span class="na">newTrigger</span><span class="o">()</span>
            <span class="o">.</span><span class="na">startNow</span><span class="o">()</span> <span class="c1">// 执行的时机，立即执行</span>
            <span class="o">.</span><span class="na">withIdentity</span><span class="o">(</span><span class="s">"myTrigger"</span><span class="o">,</span> <span class="s">"myTriggerGroup"</span><span class="o">)</span> <span class="c1">// 不是必须的</span>
            <span class="o">.</span><span class="na">withSchedule</span><span class="o">(</span><span class="nc">SimpleScheduleBuilder</span><span class="o">.</span><span class="na">simpleSchedule</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">withIntervalInSeconds</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="na">repeatForever</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>

    <span class="c1">// 让scheduler开始调度这个job, 按trigger指定的计划</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="na">scheduleJob</span><span class="o">(</span><span class="n">job</span><span class="o">,</span> <span class="n">trigger</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>执行结果</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mo">03</span> <span class="mi">16</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mi">53</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mo">03</span> <span class="mi">16</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mi">55</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mo">03</span> <span class="mi">16</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mi">57</span>
<span class="o">......</span>
</code></pre></div></div>

<p>其中最关键的就是<code class="highlighter-rouge">withSchedule()</code>这个方法，通过<code class="highlighter-rouge">SimpleScheduleBuilder.simpleSchedule().withIntervalInSeconds(2).repeatForever()</code>来构建了一个简单的<code class="highlighter-rouge">SimpleTrigger</code>类型的任务调度规则，从而实现任务调度！</p>

<p>用<code class="highlighter-rouge">CronTrigger</code> 每隔5秒执行一次任务，代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SchedulerException</span> <span class="o">{</span>
  <span class="c1">//构建一个JobDetail实例...</span>

  <span class="c1">// 新建一个Trigger, 表示JobDetail的调度计划, 这里的cron表达式是 每5秒执行一次</span>
  <span class="nc">Trigger</span> <span class="n">trigger</span> <span class="o">=</span> <span class="nc">TriggerBuilder</span><span class="o">.</span><span class="na">newTrigger</span><span class="o">()</span>
    <span class="o">.</span><span class="na">withIdentity</span><span class="o">(</span><span class="s">"myTrigger"</span><span class="o">,</span> <span class="s">"myTriggerGroup"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">startNow</span><span class="o">()</span> <span class="c1">// 立即执行</span>
    <span class="o">.</span><span class="na">withSchedule</span><span class="o">(</span><span class="nc">CronScheduleBuilder</span><span class="o">.</span><span class="na">cronSchedule</span><span class="o">(</span><span class="s">"0/5 * * * * ?"</span><span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

  <span class="c1">// 让scheduler开始调度这个job, 按trigger指定的计划</span>
  <span class="n">scheduler</span><span class="o">.</span><span class="na">scheduleJob</span><span class="o">(</span><span class="n">job</span><span class="o">,</span> <span class="n">trigger</span><span class="o">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">CronTrigger</code>相比<code class="highlighter-rouge">SimpleTrigger</code>，在配置调度规则方面，使用<code class="highlighter-rouge">cron</code>表达式更加灵活！</p>

<p>执行结果：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mo">03</span> <span class="mi">17</span><span class="o">:</span><span class="mi">09</span><span class="o">:</span><span class="mi">10</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mo">03</span> <span class="mi">17</span><span class="o">:</span><span class="mi">09</span><span class="o">:</span><span class="mi">15</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mo">03</span> <span class="mi">17</span><span class="o">:</span><span class="mi">09</span><span class="o">:</span><span class="mi">20</span>
<span class="o">......</span>
</code></pre></div></div>

<blockquote>
  <p>3、cron表达式</p>
</blockquote>

<p>在我这篇文章<a href="/icoding-edu/2020/03/22/icoding-note-012.html">/icoding-edu/2020/03/22/icoding-note-012.html</a>  @schedule注解也有使用cron表达式</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.---------------------- seconds<span class="o">(</span>0 - 59<span class="o">)</span>
|  .------------------- minute <span class="o">(</span>0 - 59<span class="o">)</span>
|  |  .---------------- hour <span class="o">(</span>0 - 23<span class="o">)</span>
|  |  |  .------------- day of month <span class="o">(</span>1 - 31<span class="o">)</span>
|  |  |  |  .---------- month <span class="o">(</span>1 - 12<span class="o">)</span>
|  |  |  |  |  .------- Day-of-Week <span class="o">(</span>1 - 7<span class="o">)</span> 
|  |  |  |  |  |  .---- year <span class="o">(</span>1970 - 2099<span class="o">)</span> ...
|  |  |  |  |  |  |
<span class="k">*</span>  <span class="k">*</span>  <span class="k">*</span>  <span class="k">*</span>  <span class="k">*</span>  ?  <span class="k">*</span>
</code></pre></div></div>

<p><img src="\assets\images\2021\juc\quartz-crontrigger.png" alt="" /></p>

<p>在 cron 表达式中不区分大小写，更多配置和使用操作可以参考这里。</p>

<p>还可以在线解析<code class="highlighter-rouge">cron</code>表达式进行测试。</p>

<p><img src="\assets\images\2021\juc\cron-expression-online.jpg" alt="" /></p>

<h3 id="监听器">监听器</h3>

<p>quartz 除了提供能正常调度任务的功能之外，还提供了监听器功能！</p>

<p>所谓监听器，其实你可以把它理解为类似<code class="highlighter-rouge">Spring Aop</code>的功能，可以对全局或者局部实现监听！</p>

<p>监听器应用，在实际项目中并不常用，但是在某些业务场景下，可以发挥一定的作用，例如：你想在任务处理完成之后，去发送邮件或者发短信进行通知，但是你又不想改以前的代码，这个时候就可以在监听器里面完成改项任务！</p>

<p>quartz 监听器主要分三大类：</p>

<ul>
  <li>SchedulerListener：任务调度监听器</li>
  <li>TriggerListener：任务触发监听器</li>
  <li>JobListener：任务执行监听器</li>
</ul>

<blockquote>
  <p>1、SchedulerListener：任务调度监听器</p>
</blockquote>

<p><code class="highlighter-rouge">SchedulerListener</code>监听器，主要对任务调度<code class="highlighter-rouge">Scheduler</code>生命周期中关键节点进行监听，它只能全局进行监听，简单示例如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleSchedulerListener</span> <span class="kd">implements</span> <span class="nc">SchedulerListener</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobScheduled</span><span class="o">(</span><span class="nc">Trigger</span> <span class="n">trigger</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"任务被部署时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobUnscheduled</span><span class="o">(</span><span class="nc">TriggerKey</span> <span class="n">triggerKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"任务被卸载时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">triggerFinalized</span><span class="o">(</span><span class="nc">Trigger</span> <span class="n">trigger</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"任务完成了它的使命，光荣退休时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">triggerPaused</span><span class="o">(</span><span class="nc">TriggerKey</span> <span class="n">triggerKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">triggerKey</span> <span class="o">+</span> <span class="s">"（一个触发器）被暂停时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">triggersPaused</span><span class="o">(</span><span class="nc">String</span> <span class="n">triggerGroup</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">triggerGroup</span> <span class="o">+</span> <span class="s">"所在组的全部触发器被停止时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">triggerResumed</span><span class="o">(</span><span class="nc">TriggerKey</span> <span class="n">triggerKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">triggerKey</span> <span class="o">+</span> <span class="s">"（一个触发器）被恢复时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">triggersResumed</span><span class="o">(</span><span class="nc">String</span> <span class="n">triggerGroup</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">triggerGroup</span> <span class="o">+</span> <span class="s">"所在组的全部触发器被回复时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobAdded</span><span class="o">(</span><span class="nc">JobDetail</span> <span class="n">jobDetail</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"一个JobDetail被动态添加进来"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobDeleted</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jobKey</span> <span class="o">+</span> <span class="s">"被删除时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobPaused</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jobKey</span> <span class="o">+</span> <span class="s">"被暂停时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobsPaused</span><span class="o">(</span><span class="nc">String</span> <span class="n">jobGroup</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jobGroup</span> <span class="o">+</span> <span class="s">"(一组任务）被暂停时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobResumed</span><span class="o">(</span><span class="nc">JobKey</span> <span class="n">jobKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jobKey</span> <span class="o">+</span> <span class="s">"被恢复时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobsResumed</span><span class="o">(</span><span class="nc">String</span> <span class="n">jobGroup</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jobGroup</span> <span class="o">+</span> <span class="s">"(一组任务）被恢复时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">schedulerError</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">SchedulerException</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"出现异常"</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">"时被执行"</span><span class="o">);</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">schedulerInStandbyMode</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"scheduler被设为standBy等候模式时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">schedulerStarted</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"scheduler启动时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">schedulerStarting</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"scheduler正在启动时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">schedulerShutdown</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"scheduler关闭时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">schedulerShuttingdown</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"scheduler正在关闭时被执行"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">schedulingDataCleared</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"scheduler中所有数据包括jobs, triggers和calendars都被清空时被执行"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>需要在任务调度器启动前，将<code class="highlighter-rouge">SimpleSchedulerListener</code>注册到<code class="highlighter-rouge">Scheduler</code>容器中！</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 创建一个Scheduler
Scheduler scheduler <span class="o">=</span> StdSchedulerFactory.getDefaultScheduler<span class="o">()</span><span class="p">;</span>
//添加SchedulerListener监听器
scheduler.getListenerManager<span class="o">()</span>.addSchedulerListener<span class="o">(</span>new SimpleSchedulerListener<span class="o">())</span><span class="p">;</span>
// 启动Scheduler
scheduler.start<span class="o">()</span><span class="p">;</span>
</code></pre></div></div>

<p>运行<code class="highlighter-rouge">main</code>方法，输出结果如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scheduler</span><span class="err">正在启动时被执行</span>
<span class="n">scheduler</span><span class="err">启动时被执行</span>
<span class="err">一个</span><span class="n">JobDetail</span><span class="err">被动态添加进来</span>
<span class="err">任务被部署时被执行</span>
<span class="mi">2020</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">10</span> <span class="mi">17</span><span class="o">:</span><span class="mi">27</span><span class="o">:</span><span class="mi">10</span>
<span class="o">....</span>
</code></pre></div></div>

<blockquote>
  <p>2、TriggerListener：任务触发监听器</p>
</blockquote>

<p><code class="highlighter-rouge">TriggerListener</code>，与触发器<code class="highlighter-rouge">Trigger</code>相关的事件都会被监听，它既可以全局监听，也可以实现局部监听。所谓局部监听，就是对某个<code class="highlighter-rouge">Trigger</code>的名称或者组进行监听，简单示例如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleTriggerListener</span> <span class="kd">implements</span> <span class="nc">TriggerListener</span> <span class="o">{</span>

    <span class="cm">/**
     * Trigger监听器的名称
     * @return
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"mySimpleTriggerListener"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Trigger被激发 它关联的job即将被运行
     * @param trigger
     * @param context
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">triggerFired</span><span class="o">(</span><span class="nc">Trigger</span> <span class="n">trigger</span><span class="o">,</span> <span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"myTriggerListener.triggerFired()"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Trigger被激发 它关联的job即将被运行, TriggerListener 给了一个选择去否决 Job 的执行,如果返回TRUE 那么任务job会被终止
     * @param trigger
     * @param context
     * @return
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">vetoJobExecution</span><span class="o">(</span><span class="nc">Trigger</span> <span class="n">trigger</span><span class="o">,</span> <span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"myTriggerListener.vetoJobExecution()"</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 当Trigger错过被激发时执行,比如当前时间有很多触发器都需要执行，但是线程池中的有效线程都在工作，
     * 那么有的触发器就有可能超时，错过这一轮的触发。
     * @param trigger
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">triggerMisfired</span><span class="o">(</span><span class="nc">Trigger</span> <span class="n">trigger</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"myTriggerListener.triggerMisfired()"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 任务完成时触发
     * @param trigger
     * @param context
     * @param triggerInstructionCode
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">triggerComplete</span><span class="o">(</span><span class="nc">Trigger</span> <span class="n">trigger</span><span class="o">,</span> <span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Trigger</span><span class="o">.</span><span class="na">CompletedExecutionInstruction</span> <span class="n">triggerInstructionCode</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"myTriggerListener.triggerComplete()"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>同样，需要将<code class="highlighter-rouge">SimpleTriggerListener</code>注册到<code class="highlighter-rouge">Scheduler</code>容器中</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建一个Scheduler</span>
<span class="nc">Scheduler</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="nc">StdSchedulerFactory</span><span class="o">.</span><span class="na">getDefaultScheduler</span><span class="o">();</span>
<span class="c1">// 创建并注册一个全局的Trigger Listener</span>
<span class="n">scheduler</span><span class="o">.</span><span class="na">getListenerManager</span><span class="o">().</span><span class="na">addTriggerListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleTriggerListener</span><span class="o">(),</span> <span class="nc">EverythingMatcher</span><span class="o">.</span><span class="na">allTriggers</span><span class="o">());</span>
        
<span class="c1">// 创建并注册一个局部的Trigger Listener</span>
<span class="c1">//scheduler.getListenerManager().addTriggerListener(new SimpleTriggerListener(), KeyMatcher.keyEquals(TriggerKey.triggerKey("myTrigger", "myJobTrigger")));</span>
        
<span class="c1">// 创建并注册一个特定组的Trigger Listener</span>
<span class="c1">//scheduler.getListenerManager().addTriggerListener(new SimpleTriggerListener(), GroupMatcher.groupEquals("myTrigger"));</span>
<span class="c1">// 启动Scheduler</span>
<span class="n">scheduler</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</code></pre></div></div>

<blockquote>
  <p>3、JobListener 任务执行监听器</p>
</blockquote>

<p><code class="highlighter-rouge">JobListener</code>，与任务执行<code class="highlighter-rouge">Job</code>相关的事件都会被监听，和<code class="highlighter-rouge">Trigger</code>一样，既可以全局监听，也可以实现局部监听。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleJobListener</span> <span class="kd">implements</span> <span class="nc">JobListener</span> <span class="o">{</span>

    <span class="cm">/**
     * job监听器名称
     * @return
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"mySimpleJobListener"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 任务被调度前
     * @param context
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobToBeExecuted</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"simpleJobListener监听器，准备执行："</span><span class="o">+</span><span class="n">context</span><span class="o">.</span><span class="na">getJobDetail</span><span class="o">().</span><span class="na">getKey</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 任务调度被拒了
     * @param context
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobExecutionVetoed</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"simpleJobListener监听器，取消执行："</span><span class="o">+</span><span class="n">context</span><span class="o">.</span><span class="na">getJobDetail</span><span class="o">().</span><span class="na">getKey</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 任务被调度后
     * @param context
     * @param jobException
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jobWasExecuted</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">JobExecutionException</span> <span class="n">jobException</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"simpleJobListener监听器，执行结束："</span><span class="o">+</span><span class="n">context</span><span class="o">.</span><span class="na">getJobDetail</span><span class="o">().</span><span class="na">getKey</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>同样的，将<code class="highlighter-rouge">SimpleJobListener</code>注册到<code class="highlighter-rouge">Scheduler</code>容器中，即可实现监听！</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建一个Scheduler</span>
<span class="nc">Scheduler</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="nc">StdSchedulerFactory</span><span class="o">.</span><span class="na">getDefaultScheduler</span><span class="o">();</span>
<span class="c1">// 创建并注册一个全局的Job Listener</span>
<span class="n">scheduler</span><span class="o">.</span><span class="na">getListenerManager</span><span class="o">().</span><span class="na">addJobListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleJobListener</span><span class="o">(),</span> <span class="nc">EverythingMatcher</span><span class="o">.</span><span class="na">allJobs</span><span class="o">());</span>

<span class="c1">// 创建并注册一个指定任务的Job Listener</span>
<span class="c1">//scheduler.getListenerManager().addJobListener(new SimpleJobListener(), KeyMatcher.keyEquals(JobKey.jobKey("myJob", "myJobGroup")));</span>

<span class="c1">// 将同一任务组的任务注册到监听器中</span>
<span class="c1">//scheduler.getListenerManager().addJobListener(new SimpleJobListener(), GroupMatcher.jobGroupEquals("myJobGroup"));</span>

<span class="c1">// 启动Scheduler</span>
<span class="n">scheduler</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</code></pre></div></div>

<p><strong>小结</strong></p>

<p>如果想多个同时监听，将其依次加入即可！</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Scheduler</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="nc">StdSchedulerFactory</span><span class="o">.</span><span class="na">getDefaultScheduler</span><span class="o">();</span>

<span class="c1">//添加SchedulerListener监听器</span>
<span class="n">scheduler</span><span class="o">.</span><span class="na">getListenerManager</span><span class="o">().</span><span class="na">addSchedulerListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleSchedulerListener</span><span class="o">());</span>

<span class="c1">// 创建并注册一个全局的Trigger Listener</span>
<span class="n">scheduler</span><span class="o">.</span><span class="na">getListenerManager</span><span class="o">().</span><span class="na">addTriggerListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleTriggerListener</span><span class="o">(),</span> <span class="nc">EverythingMatcher</span><span class="o">.</span><span class="na">allTriggers</span><span class="o">());</span>

<span class="c1">// 创建并注册一个全局的Job Listener</span>
<span class="n">scheduler</span><span class="o">.</span><span class="na">getListenerManager</span><span class="o">().</span><span class="na">addJobListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleJobListener</span><span class="o">(),</span> <span class="nc">EverythingMatcher</span><span class="o">.</span><span class="na">allJobs</span><span class="o">());</span>

<span class="c1">// 启动Scheduler</span>
<span class="n">scheduler</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</code></pre></div></div>

<h3 id="springboot-整合">SpringBoot 整合</h3>

<blockquote>
  <p>单体应用介绍</p>
</blockquote>

<p>1、pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-quartz<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、编写具体任务</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestTask</span> <span class="kd">implements</span> <span class="nc">Job</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">jobExecutionContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JobExecutionException</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"testTask："</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()));</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3、调度配置类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestTaskConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JobDetail</span> <span class="nf">testQuartz</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">JobBuilder</span><span class="o">.</span><span class="na">newJob</span><span class="o">(</span><span class="nc">TestTask</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">usingJobData</span><span class="o">(</span><span class="s">"jobData"</span><span class="o">,</span> <span class="s">"test"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withIdentity</span><span class="o">(</span><span class="s">"myJob"</span><span class="o">,</span> <span class="s">"myJobGroup"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">storeDurably</span><span class="o">()</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Trigger</span> <span class="nf">testQuartzTrigger</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//5秒执行一次</span>
        <span class="k">return</span> <span class="nc">TriggerBuilder</span><span class="o">.</span><span class="na">newTrigger</span><span class="o">()</span>
                <span class="o">.</span><span class="na">forJob</span><span class="o">(</span><span class="n">testQuartz</span><span class="o">())</span>
                <span class="o">.</span><span class="na">withIdentity</span><span class="o">(</span><span class="s">"myTrigger"</span><span class="o">,</span> <span class="s">"myTriggerGroup"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">startNow</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withSchedule</span><span class="o">(</span><span class="nc">CronScheduleBuilder</span><span class="o">.</span><span class="na">cronSchedule</span><span class="o">(</span><span class="s">"0/5 * * * * ?"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4、启动测试</p>

<p><img src="\assets\images\2021\juc\testQuartz.jpg" alt="" /></p>

<p>如果需要创建多个定时任务，配置流程也类似！但是这个是静态的。我们需要改成动态配置的</p>

<blockquote>
  <p>动态配置定时任务</p>
</blockquote>

<p>从上面的代码中我们可以分析中，定时任务的有三个核心变量，其他的方法都可以封装成公共的。</p>

<ul>
  <li>任务名称：例如<code class="highlighter-rouge">myJob</code></li>
  <li>任务执行类：例如<code class="highlighter-rouge">TestTask.class</code></li>
  <li>任务调度时间：例如<code class="highlighter-rouge">0/5 * * * * ?</code></li>
</ul>

<p>基于此规律，我们可以创建一个定时任务实体类，用于保存定时任务相关信息到数据库当中，然后编写一个定时任务工具库，用于创建、更新、删除、暂停任务操作，通过 restful 接口操作将任务存入数据库并管理定时任务！</p>

<p>这里ORM框架使用Jpa</p>

<p>1、导入Jpa依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--jpa 支持--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!--mysql 数据源--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>在<code class="highlighter-rouge">application.properties</code>中加入数据源配置</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.datasource.url</span><span class="p">=</span><span class="s">jdbc:mysql://127.0.0.1:3306/test</span>
<span class="py">spring.datasource.username</span><span class="p">=</span><span class="s">root</span>
<span class="py">spring.datasource.password</span><span class="p">=</span><span class="s">123456</span>
<span class="py">spring.datasource.driver-class-name</span><span class="p">=</span><span class="s">com.mysql.cj.jdbc.Driver</span>
</code></pre></div></div>

<p>2、创建任务配置表</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`tb_job_task`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'任务ID'</span><span class="p">,</span>
  <span class="nv">`job_name`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'任务名称'</span><span class="p">,</span>
  <span class="nv">`job_class`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>  <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'任务执行类'</span><span class="p">,</span>
  <span class="nv">`cron_expression`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'任务调度时间表达式'</span><span class="p">,</span>
  <span class="nv">`status`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'任务状态，0：启动，1：暂停，2：停用'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_general_ci</span><span class="p">;</span>
</code></pre></div></div>

<p>3、编写实体类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"tb_job_task"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuartzBean</span> <span class="o">{</span>

    <span class="cm">/**
     * 任务ID
     */</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="cm">/**
     * 任务名称
     */</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"job_name"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">jobName</span><span class="o">;</span>

    <span class="cm">/**
     * 任务执行类
     */</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"job_class"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">jobClass</span><span class="o">;</span>

    <span class="cm">/**
     * 任务调度时间表达式
     */</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"cron_expression"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">cronExpression</span><span class="o">;</span>

    <span class="cm">/**
     * 任务状态，0：启动，1：暂停，2：停用
     */</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"status"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">status</span><span class="o">;</span>

    <span class="c1">//get、set...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4、编写任务操作工具类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuartzUtils</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="cm">/**
     * 创建定时任务 定时任务创建之后默认启动状态
     * @param scheduler   调度器
     * @param quartzBean  定时任务信息类
     * @throws Exception
     */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createScheduleJob</span><span class="o">(</span><span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">,</span> <span class="nc">QuartzBean</span> <span class="n">quartzBean</span><span class="o">){</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">//获取到定时任务的执行类  必须是类的绝对路径名称</span>
      <span class="c1">//定时任务类需要是job类的具体实现 QuartzJobBean是job的抽象类。</span>
      <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Job</span><span class="o">&gt;</span> <span class="n">jobClass</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Job</span><span class="o">&gt;)</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getJobClass</span><span class="o">());</span>
      <span class="c1">// 构建定时任务信息</span>
      <span class="nc">JobDetail</span> <span class="n">jobDetail</span> <span class="o">=</span> <span class="nc">JobBuilder</span><span class="o">.</span><span class="na">newJob</span><span class="o">(</span><span class="n">jobClass</span><span class="o">).</span><span class="na">withIdentity</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getJobName</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
      <span class="c1">// 设置定时任务执行方式</span>
      <span class="nc">CronScheduleBuilder</span> <span class="n">scheduleBuilder</span> <span class="o">=</span> <span class="nc">CronScheduleBuilder</span><span class="o">.</span><span class="na">cronSchedule</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getCronExpression</span><span class="o">());</span>
      <span class="c1">// 构建触发器trigger</span>
      <span class="nc">CronTrigger</span> <span class="n">trigger</span> <span class="o">=</span> <span class="nc">TriggerBuilder</span><span class="o">.</span><span class="na">newTrigger</span><span class="o">().</span><span class="na">withIdentity</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getJobName</span><span class="o">()).</span><span class="na">withSchedule</span><span class="o">(</span><span class="n">scheduleBuilder</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="na">scheduleJob</span><span class="o">(</span><span class="n">jobDetail</span><span class="o">,</span> <span class="n">trigger</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"定时任务类路径出错：请输入类的绝对路径"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"创建定时任务出错"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
     * 根据任务名称暂停定时任务
     * @param scheduler  调度器
     * @param jobName    定时任务名称
     * @throws SchedulerException
     */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">pauseScheduleJob</span><span class="o">(</span><span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">,</span> <span class="nc">String</span> <span class="n">jobName</span><span class="o">){</span>
    <span class="nc">JobKey</span> <span class="n">jobKey</span> <span class="o">=</span> <span class="nc">JobKey</span><span class="o">.</span><span class="na">jobKey</span><span class="o">(</span><span class="n">jobName</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="na">pauseJob</span><span class="o">(</span><span class="n">jobKey</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"暂停定时任务出错"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
     * 根据任务名称恢复定时任务
     * @param scheduler  调度器
     * @param jobName    定时任务名称
     * @throws SchedulerException
     */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">resumeScheduleJob</span><span class="o">(</span><span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">,</span> <span class="nc">String</span> <span class="n">jobName</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">JobKey</span> <span class="n">jobKey</span> <span class="o">=</span> <span class="nc">JobKey</span><span class="o">.</span><span class="na">jobKey</span><span class="o">(</span><span class="n">jobName</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="na">resumeJob</span><span class="o">(</span><span class="n">jobKey</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"暂停定时任务出错"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
     * 根据任务名称立即运行一次定时任务
     * @param scheduler     调度器
     * @param jobName       定时任务名称
     * @throws SchedulerException
     */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runOnce</span><span class="o">(</span><span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">,</span> <span class="nc">String</span> <span class="n">jobName</span><span class="o">){</span>
    <span class="nc">JobKey</span> <span class="n">jobKey</span> <span class="o">=</span> <span class="nc">JobKey</span><span class="o">.</span><span class="na">jobKey</span><span class="o">(</span><span class="n">jobName</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="na">triggerJob</span><span class="o">(</span><span class="n">jobKey</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"运行定时任务出错"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
     * 更新定时任务
     * @param scheduler   调度器
     * @param quartzBean  定时任务信息类
     * @throws SchedulerException
     */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">updateScheduleJob</span><span class="o">(</span><span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">,</span> <span class="nc">QuartzBean</span> <span class="n">quartzBean</span><span class="o">){</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">//获取到对应任务的触发器</span>
      <span class="nc">TriggerKey</span> <span class="n">triggerKey</span> <span class="o">=</span> <span class="nc">TriggerKey</span><span class="o">.</span><span class="na">triggerKey</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getJobName</span><span class="o">());</span>
      <span class="c1">//设置定时任务执行方式</span>
      <span class="nc">CronScheduleBuilder</span> <span class="n">scheduleBuilder</span> <span class="o">=</span> <span class="nc">CronScheduleBuilder</span><span class="o">.</span><span class="na">cronSchedule</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getCronExpression</span><span class="o">());</span>
      <span class="c1">//重新构建任务的触发器trigger</span>
      <span class="nc">CronTrigger</span> <span class="n">trigger</span> <span class="o">=</span> <span class="o">(</span><span class="nc">CronTrigger</span><span class="o">)</span> <span class="n">scheduler</span><span class="o">.</span><span class="na">getTrigger</span><span class="o">(</span><span class="n">triggerKey</span><span class="o">);</span>
      <span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span><span class="o">.</span><span class="na">getTriggerBuilder</span><span class="o">().</span><span class="na">withIdentity</span><span class="o">(</span><span class="n">triggerKey</span><span class="o">).</span><span class="na">withSchedule</span><span class="o">(</span><span class="n">scheduleBuilder</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
      <span class="c1">//重置对应的job</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="na">rescheduleJob</span><span class="o">(</span><span class="n">triggerKey</span><span class="o">,</span> <span class="n">trigger</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"更新定时任务出错"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
     * 根据定时任务名称从调度器当中删除定时任务
     * @param scheduler 调度器
     * @param jobName   定时任务名称
     * @throws SchedulerException
     */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">deleteScheduleJob</span><span class="o">(</span><span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">,</span> <span class="nc">String</span> <span class="n">jobName</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">JobKey</span> <span class="n">jobKey</span> <span class="o">=</span> <span class="nc">JobKey</span><span class="o">.</span><span class="na">jobKey</span><span class="o">(</span><span class="n">jobName</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">scheduler</span><span class="o">.</span><span class="na">deleteJob</span><span class="o">(</span><span class="n">jobKey</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SchedulerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"删除定时任务出错"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>5、编写Jpa数据操作（DAO层）</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">QuartzBeanRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">QuartzBean</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="cm">/**
     * 修改任务状态
     * @param id
     * @param status
     */</span>
  <span class="nd">@Modifying</span>
  <span class="nd">@Transactional</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="s">"update QuartzBean m set m.status = ?2 where m.id =?1"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">updateState</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">status</span><span class="o">);</span>

  <span class="cm">/**
     * 修改任务调度时间
     * @param id
     * @param cronExpression
     */</span>
  <span class="nd">@Modifying</span>
  <span class="nd">@Transactional</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="s">"update QuartzBean m set m.cronExpression = ?2 where m.id =?1"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">updateCron</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">cronExpression</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>6、编写WEB控制层controller服务</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/quartz"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuartzController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">QuartzController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">QuartzBeanRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="cm">/**
     * 创建任务
     * @param quartzBean
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/createJob"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">HttpStatus</span> <span class="nf">createJob</span><span class="o">(</span><span class="nd">@RequestBody</span>  <span class="nc">QuartzBean</span> <span class="n">quartzBean</span><span class="o">)</span>  <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========开始创建任务========="</span><span class="o">);</span>
        <span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">createScheduleJob</span><span class="o">(</span><span class="n">scheduler</span><span class="o">,</span><span class="n">quartzBean</span><span class="o">);</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">()).</span><span class="na">setStatus</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========创建任务成功，信息：{}"</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">));</span>
        <span class="k">return</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 暂停任务
     * @param quartzBean
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/pauseJob"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">HttpStatus</span> <span class="nf">pauseJob</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">QuartzBean</span> <span class="n">quartzBean</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========开始暂停任务，请求参数：{}========="</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">));</span>
        <span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">pauseScheduleJob</span><span class="o">(</span><span class="n">scheduler</span><span class="o">,</span> <span class="n">quartzBean</span><span class="o">.</span><span class="na">getJobName</span><span class="o">());</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">updateState</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========暂停任务成功========="</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 立即运行一次定时任务
     * @param quartzBean
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/runOnce"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">HttpStatus</span> <span class="nf">runOnce</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">QuartzBean</span> <span class="n">quartzBean</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========立即运行一次定时任务，请求参数：{}"</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">));</span>
        <span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">runOnce</span><span class="o">(</span><span class="n">scheduler</span><span class="o">,</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getJobName</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========立即运行一次定时任务成功========="</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 恢复定时任务
     * @param quartzBean
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/resume"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">HttpStatus</span> <span class="nf">resume</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">QuartzBean</span> <span class="n">quartzBean</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========恢复定时任务，请求参数：{}"</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">));</span>
        <span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">resumeScheduleJob</span><span class="o">(</span><span class="n">scheduler</span><span class="o">,</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getJobName</span><span class="o">());</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">updateState</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========恢复定时任务成功========="</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 更新定时任务
     * @param quartzBean
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/update"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">HttpStatus</span> <span class="nf">update</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">QuartzBean</span> <span class="n">quartzBean</span><span class="o">)</span>  <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========更新定时任务，请求参数：{}"</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">));</span>
        <span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">updateScheduleJob</span><span class="o">(</span><span class="n">scheduler</span><span class="o">,</span><span class="n">quartzBean</span><span class="o">);</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">updateCron</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">quartzBean</span><span class="o">.</span><span class="na">getCronExpression</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========更新定时任务成功========="</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 删除定时任务
     * @param quartzBean
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/delete"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">HttpStatus</span> <span class="nf">delete</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">QuartzBean</span> <span class="n">quartzBean</span><span class="o">)</span>  <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========删除定时任务，请求参数：{}"</span><span class="o">,</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">));</span>
        <span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">deleteScheduleJob</span><span class="o">(</span><span class="n">scheduler</span><span class="o">,</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getJobName</span><span class="o">());</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">updateState</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="mi">2</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"=========删除定时任务成功========="</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>服务重启补偿</strong></p>

<p>在应用程序正常运行的时候，虽然没问题，但是当我们重启服务的时候，这个时候内存的里面的定时任务其实全部都被销毁，因此在应用程序启动的时候，还需要将正常的任务重新加入到服务中！</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TaskConfigApplicationRunner</span> <span class="kd">implements</span> <span class="nc">ApplicationRunner</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">QuartzBeanRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">Scheduler</span> <span class="n">scheduler</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">ApplicationArguments</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">QuartzBean</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(!</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">list</span><span class="o">)){</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">QuartzBean</span> <span class="n">quartzBean</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//加载启动类型的定时任务</span>
                <span class="k">if</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getStatus</span><span class="o">().</span><span class="na">intValue</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                    <span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">createScheduleJob</span><span class="o">(</span><span class="n">scheduler</span><span class="o">,</span><span class="n">quartzBean</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">//加载暂停类型的定时任务</span>
                <span class="k">if</span><span class="o">(</span><span class="n">quartzBean</span><span class="o">.</span><span class="na">getStatus</span><span class="o">().</span><span class="na">intValue</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">){</span>
                    <span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">createScheduleJob</span><span class="o">(</span><span class="n">scheduler</span><span class="o">,</span><span class="n">quartzBean</span><span class="o">);</span>
                    <span class="nc">QuartzUtils</span><span class="o">.</span><span class="na">pauseScheduleJob</span><span class="o">(</span><span class="n">scheduler</span><span class="o">,</span> <span class="n">quartzBean</span><span class="o">.</span><span class="na">getJobName</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在服务重启的时候，会重新将有效任务加入quartz 中！</p>

<p>7、接口服务测试</p>

<p>使用postman调用controller层的接口方法测试新增、更新任务等</p>

<p>8、添加监听器（选用）</p>

<p>当然，如果你想对某个任务实现监听，只需要添加一个配置类，将其注入即可！</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestTaskConfig</span> <span class="o">{</span>

  <span class="nd">@Primary</span>
  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">Scheduler</span> <span class="nf">initScheduler</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SchedulerException</span> <span class="o">{</span>
    <span class="nc">Scheduler</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="nc">StdSchedulerFactory</span><span class="o">.</span><span class="na">getDefaultScheduler</span><span class="o">();</span>
    <span class="c1">//添加SchedulerListener监听器</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="na">getListenerManager</span><span class="o">().</span><span class="na">addSchedulerListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleSchedulerListener</span><span class="o">());</span>

    <span class="c1">// 创建并注册一个全局的Trigger Listener</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="na">getListenerManager</span><span class="o">().</span><span class="na">addTriggerListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleTriggerListener</span><span class="o">(),</span> <span class="nc">EverythingMatcher</span><span class="o">.</span><span class="na">allTriggers</span><span class="o">());</span>

    <span class="c1">// 创建并注册一个全局的Job Listener</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="na">getListenerManager</span><span class="o">().</span><span class="na">addJobListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleJobListener</span><span class="o">(),</span> <span class="nc">EverythingMatcher</span><span class="o">.</span><span class="na">allJobs</span><span class="o">());</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">scheduler</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>小结</strong></p>

<p>需要注意的是：在 quartz 任务暂停之后再次启动时，会立即执行一次，在更新之后也会立即执行一次任务调度！</p>

<blockquote>
  <p>使用示例renren_fast中集成quartz</p>
</blockquote>

<p>之前使用renren_fast框架中的定时器也是使用quartz框架，有界面可以动态启动、停止任务，任务被执行时用到了反射，下面是它的核心代码。</p>

<p>1、导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.quartz-scheduler<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>quartz<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.2.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context-support<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、配置类QuartzConfigration</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuartzConfigration</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JobFactory</span> <span class="n">jobFactory</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SchedulerFactoryBean</span> <span class="nf">schedulerFactoryBean</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">SchedulerFactoryBean</span> <span class="n">schedulerFactoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SchedulerFactoryBean</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">schedulerFactoryBean</span><span class="o">.</span><span class="na">setOverwriteExistingJobs</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">schedulerFactoryBean</span><span class="o">.</span><span class="na">setQuartzProperties</span><span class="o">(</span><span class="n">quartzProperties</span><span class="o">());</span>
            <span class="n">schedulerFactoryBean</span><span class="o">.</span><span class="na">setJobFactory</span><span class="o">(</span><span class="n">jobFactory</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">schedulerFactoryBean</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 指定quartz.properties，可在配置文件中配置相关属性</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Properties</span> <span class="nf">quartzProperties</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">PropertiesFactoryBean</span> <span class="n">propertiesFactoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PropertiesFactoryBean</span><span class="o">();</span>
        <span class="n">propertiesFactoryBean</span><span class="o">.</span><span class="na">setLocation</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"/config/quartz.properties"</span><span class="o">));</span>
        <span class="n">propertiesFactoryBean</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">propertiesFactoryBean</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 创建schedule</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"scheduler"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Scheduler</span> <span class="nf">scheduler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">schedulerFactoryBean</span><span class="o">().</span><span class="na">getScheduler</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="总结">总结</h3>

<ul>
  <li>优点：默认是多线程异步执行，单个任务时，在上一个调度未完成时，下一个调度时间到时，会另起一个线程开始新的调度，多个任务之间互不影响。支持复杂的<code class="highlighter-rouge">cron</code>表达式，它能被集群实例化，支持分布式部署。</li>
  <li>缺点：相对于spring task实现定时任务成本更高，需要手动配置<code class="highlighter-rouge">QuartzJobBean</code>、<code class="highlighter-rouge">JobDetail</code>和<code class="highlighter-rouge">Trigger</code>等。需要引入了第三方的<code class="highlighter-rouge">quartz</code>包，有一定的学习成本。不支持并行调度，不支持失败处理策略和动态分片的策略等。</li>
</ul>

<h2 id="7分布式调度框架">7、分布式调度框架</h2>

<h3 id="xxl-job">xxl-job</h3>

<p>在《定时任务实战2》中，我也有介绍如何使用，这里也说一下。</p>

<p><code class="highlighter-rouge">xxl-job</code>是大众点评（许雪里）开发的一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>

<p>它对对<code class="highlighter-rouge">quartz</code>进行了扩展，使用<code class="highlighter-rouge">mysql</code>数据库存储数据，并且内置jetty作为<code class="highlighter-rouge">RPC</code>服务调用。</p>

<p>主要特点如下：</p>

<ol>
  <li>有界面维护定时任务和触发规则，非常容易管理。</li>
  <li>能动态启动或停止任务</li>
  <li>支持弹性扩容缩容</li>
  <li>支持任务失败报警</li>
  <li>支持动态分片</li>
  <li>支持故障转移</li>
  <li>Rolling实时日志</li>
  <li>支持用户和权限管理</li>
</ol>

<p>在xxl-job中，有2个角色</p>

<ul>
  <li>xxl-job-admin，调度任务管理系统，官方代码已经写好，直接启动即可</li>
  <li>xxl-job-excutor，通常是我们业务系统</li>
</ul>

<p>整体架构图如下：</p>

<p><img src="/assets/images/2021/juc/xxljob-structure.jpg" alt="" /></p>

<p>使用quartz架构图如下：</p>

<p><img src="/assets/images/2021/juc/xxljob-quartz-structure.jpg" alt="" /></p>

<blockquote>
  <p>项目实战</p>
</blockquote>

<p>假设xxl-job-admin服务已准备好，接下来我们需要做xxl-job-excutor的部分，新建一个springboot工程</p>

<p>1、pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
   <span class="nt">&lt;groupId&gt;</span>com.xuxueli<span class="nt">&lt;/groupId&gt;</span>
   <span class="nt">&lt;artifactId&gt;</span>xxl-job-core<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、application.properties配置</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">xxl.job.admin.address</span><span class="p">:</span> <span class="s">http://localhost:8088/xxl-job-admin/</span>
<span class="py">xxl.job.executor.appname</span><span class="p">:</span> <span class="s">xxl-job-executor-sample</span>
<span class="py">xxl.job.executor.port</span><span class="p">:</span> <span class="s">8888</span>
<span class="py">xxl.job.executor.logpath</span><span class="p">:</span> <span class="s">/data/applogs/xxl-job/</span>
</code></pre></div></div>

<p>3、继承<code class="highlighter-rouge">IJobHandler</code>类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JobHandler</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"helloJobHandler"</span><span class="o">)</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloJobHandler</span> <span class="kd">extends</span> <span class="nc">IJobHandler</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ReturnT</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">String</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"XXL-JOB, Hello World."</span><span class="o">);</span>
        <span class="k">return</span> <span class="no">SUCCESS</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>启动工程xxl-job-excutor，在xxl-job-admin中可以看到helloJobHandler的配置，在控制台修改配置和启动任务。这里入参param是任务配置传入的参数，可以根据param查询分片数据进行处理，任务可以配置多个，配置的param都不一样。</p>

<p><strong>优缺点</strong></p>

<ul>
  <li>优点：有界面管理定时任务，支持弹性扩容缩容、动态分片、故障转移、失败报警等功能。它的功能非常强大，很多大厂在用，可以满足绝大多数业务场景。</li>
  <li>缺点：和<code class="highlighter-rouge">quartz</code>一样，通过数据库分布式锁，来控制任务不能重复执行。在任务非常多的情况下，有一些性能问题。</li>
</ul>

<h3 id="elastic-job">elastic-job</h3>

<p>在《定时任务实战2》中，我有深入介绍使用，这里也说一下</p>

<p><code class="highlighter-rouge">elastic-job</code>是当当网开发的弹性分布式任务调度系统，功能丰富强大，采用zookeeper实现分布式协调，实现任务高可用以及分片。它是专门为高并发和复杂业务场景开发。</p>

<p><code class="highlighter-rouge">elastic-job</code>目前是<code class="highlighter-rouge">apache</code>的<code class="highlighter-rouge">shardingsphere</code>(前身是sharding-jdbc)项目下的一个子项目，</p>

<p>官网地址：<a href="http://shardingsphere.apache.org/elasticjob/">http://shardingsphere.apache.org/elasticjob/</a></p>

<p><code class="highlighter-rouge">elastic-job</code>在2.x之后，出了两个产品线：<code class="highlighter-rouge">Elastic-Job-Lite</code>和<code class="highlighter-rouge">Elastic-Job-Cloud</code>，而我们一般使用Elastic-Job-Lite就能够满足需求。Elastic-Job-Lite定位为轻量级无中心化解决方案，使用jar包的形式提供分布式任务的协调服务，外部仅依赖于Zookeeper。</p>

<p>主要特点如下：</p>

<ul>
  <li>分布式调度协调</li>
  <li>弹性扩容缩容</li>
  <li>失效转移</li>
  <li>错过执行作业重触发</li>
  <li>作业分片一致性，保证同一分片在分布式环境中仅一个执行实例</li>
  <li>自诊断并修复分布式不稳定造成的问题</li>
  <li>支持并行调度</li>
</ul>

<p>整体架构图如下：</p>

<p><img src="/assets/images/2021/springcloud/elastic-job-arch.png" alt="" /></p>

<blockquote>
  <p>项目实战</p>
</blockquote>

<p>前提已准备好zookeeper和elastic-job-lite-console控制台，下面新建一个springboot工程</p>

<p>1、pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.dangdang<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>elastic-job-lite-core<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.dangdang<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>elastic-job-lite-spring<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、增加zkconfig类，配置<code class="highlighter-rouge">zookeeper</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ConditionalOnExpression</span><span class="o">(</span><span class="s">"'${zk.serverList}'.length() &gt; 0"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZKConfig</span> <span class="o">{</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">ZookeeperRegistryCenter</span> <span class="nf">registry</span><span class="o">(</span><span class="nd">@Value</span><span class="o">(</span><span class="s">"${zk.serverList}"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">serverList</span><span class="o">,</span>
                                          <span class="nd">@Value</span><span class="o">(</span><span class="s">"${zk.namespace}"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">namespace</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ZookeeperRegistryCenter</span><span class="o">(</span><span class="k">new</span> <span class="nc">ZookeeperConfiguration</span><span class="o">(</span><span class="n">serverList</span><span class="o">,</span> <span class="n">namespace</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3、定义一个类实现<code class="highlighter-rouge">SimpleJob</code>接口</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestJob</span> <span class="kd">implements</span> <span class="nc">SimpleJob</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">ShardingContext</span> <span class="n">shardingContext</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ShardingTotalCount:"</span><span class="o">+</span><span class="n">shardingContext</span><span class="o">.</span><span class="na">getShardingTotalCount</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ShardingItem:"</span><span class="o">+</span><span class="n">shardingContext</span><span class="o">.</span><span class="na">getShardingItem</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4、增加JobConfig配置任务</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JobConfig</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${sue.spring.elatisc.cron}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">testCron</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${sue.spring.elatisc.itemParameters}"</span><span class="o">)</span>
    <span class="kd">private</span>  <span class="nc">String</span> <span class="n">shardingItemParameters</span><span class="o">;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${sue.spring.elatisc.jobParameters}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">jobParameters</span> <span class="o">=;</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${sue.spring.elatisc.shardingTotalCount}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">shardingTotalCount</span><span class="o">;</span>
    
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ZookeeperRegistryCenter</span> <span class="n">registryCenter</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SimpleJob</span> <span class="nf">testJob</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">TestJob</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JobScheduler</span> <span class="nf">simpleJobScheduler</span><span class="o">(</span><span class="kd">final</span> <span class="nc">SimpleJob</span> <span class="n">simpleJob</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">SpringJobScheduler</span><span class="o">(</span><span class="n">simpleJob</span><span class="o">,</span> <span class="n">registryCenter</span><span class="o">,</span> <span class="n">getConfiguration</span><span class="o">(</span><span class="n">simpleJob</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span>
                <span class="n">cron</span><span class="o">,</span> <span class="n">shardingTotalCount</span><span class="o">,</span> <span class="n">shardingItemParameters</span><span class="o">,</span> <span class="n">jobParameters</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">geConfiguration</span> <span class="nf">getConfiguration</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">SimpleJob</span><span class="o">&gt;</span> <span class="n">jobClass</span><span class="o">,</span><span class="nc">String</span> <span class="n">cron</span><span class="o">,</span><span class="kt">int</span> <span class="n">shardingTotalCount</span><span class="o">,</span><span class="nc">String</span> <span class="n">shardingItemParameters</span><span class="o">,</span><span class="nc">String</span> <span class="n">jobParameters</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">JobCoreConfiguration</span> <span class="n">simpleCoreConfig</span> <span class="o">=</span> <span class="nc">JobCoreConfiguration</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="n">jobClass</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">testCron</span><span class="o">,</span> <span class="n">shardingTotalCount</span><span class="o">).</span>
                <span class="n">shardingItemParameters</span><span class="o">(</span><span class="n">shardingItemParameters</span><span class="o">).</span><span class="na">jobParameter</span><span class="o">(</span><span class="n">jobParameters</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="nc">SimpleJobConfiguration</span> <span class="n">simpleJobConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleJobConfiguration</span><span class="o">(</span><span class="n">simpleCoreConfig</span><span class="o">,</span> <span class="n">jobClass</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span>
        <span class="nc">LiteJobConfiguration</span> <span class="n">jobConfig</span> <span class="o">=</span> <span class="nc">LiteJobConfiguration</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="n">simpleJobConfig</span><span class="o">).</span><span class="na">overwrite</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">jobConfig</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>cron：cron表达式，定义触发规则。</li>
  <li>shardingTotalCount：定义作业分片总数</li>
  <li>shardingItemParameters：定义分配项参数，一般用分片序列号和参数用等号分隔，多个键值对用逗号分隔，分片序列号从0开始，不可大于或等于作业分片总数。</li>
  <li>jobParameters：作业自定义参数</li>
</ul>

<p>5、application.properties配置参数</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">spring</span><span class="o">.</span><span class="na">application</span><span class="o">.</span><span class="na">name</span><span class="o">=</span><span class="n">elasticjobDemo</span>
<span class="n">zk</span><span class="o">.</span><span class="na">serverList</span><span class="o">=</span><span class="nl">localhost:</span><span class="mi">2181</span>
<span class="n">zk</span><span class="o">.</span><span class="na">namespace</span><span class="o">=</span><span class="n">elasticjobDemo</span>
<span class="n">sue</span><span class="o">.</span><span class="na">spring</span><span class="o">.</span><span class="na">elatisc</span><span class="o">.</span><span class="na">cron</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="mi">5</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">?</span>
<span class="n">sue</span><span class="o">.</span><span class="na">spring</span><span class="o">.</span><span class="na">elatisc</span><span class="o">.</span><span class="na">itemParameters</span><span class="o">=</span><span class="mi">0</span><span class="o">=</span><span class="no">A</span><span class="o">,</span><span class="mi">1</span><span class="o">=</span><span class="no">B</span><span class="o">,</span><span class="mi">2</span><span class="o">=</span><span class="no">C</span><span class="o">,</span><span class="mi">3</span><span class="o">=</span><span class="no">D</span>
<span class="n">sue</span><span class="o">.</span><span class="na">spring</span><span class="o">.</span><span class="na">elatisc</span><span class="o">.</span><span class="na">jobParameters</span><span class="o">=</span><span class="n">test</span>
<span class="n">sue</span><span class="o">.</span><span class="na">spring</span><span class="o">.</span><span class="na">elatisc</span><span class="o">.</span><span class="na">shardingTotalCount</span><span class="o">=</span><span class="mi">4</span>
</code></pre></div></div>

<p>这样定时任务就配置好了，创建定时任务的步骤，相对于<code class="highlighter-rouge">xxl-job</code>来说要繁琐一些</p>

<p><strong>优缺点</strong></p>

<ul>
  <li>
    <p>优点：支持分布式调度协调，支持分片，适合高并发，和一些业务相对来说较复杂的场景。</p>
  </li>
  <li>
    <p>缺点：需要依赖于zookeeper，实现定时任务相对于<code class="highlighter-rouge">xxl-job</code>要复杂一些，要对分片规则非常熟悉。</p>
  </li>
</ul>

<h3 id="saturn">Saturn</h3>

<p>Saturn是唯品会开源的一个分布式任务调度平台。取代传统的Linux Cron/Spring Batch Job的方式，做到全域统一配置，统一监控，任务高可用以及分片并发处理。</p>

<p>Saturn是在当当开源的Elastic-Job基础上，结合各方需求和我们的实践见解改良而成。使用案例：唯品会、酷狗音乐、新网银行、海融易、航美在线、量富征信等。</p>

<p>github地址：<a href="https://github.com/vipshop/Saturn/">https://github.com/vipshop/Saturn/</a></p>

<h3 id="tbschedule">TBSchedule</h3>

<p>TBSchedule是阿里开发的一款分布式任务调度平台，旨在将调度作业从业务系统中分离出来，降低或者是消除和业务系统的耦合度，进行高效异步任务处理。</p>

<p>目前被广泛应用在阿里巴巴、淘宝、支付宝、京东、聚美、汽车之家、国美等很多互联网企业的流程调度系统中。</p>

<p>github地址：<a href="https://github.com/taobao/TBSchedule">https://github.com/taobao/TBSchedule</a></p>

<h3 id="总结-1">总结</h3>

<p>老实说优秀的定时任务还是挺多的，不是说哪种定时任务牛逼我们就一定要用哪种，而是要根据实际业务需求选择。每种定时任务都有优缺点，合理选择既能满足业务需求，又能避免资源浪费，才是上上策。当然在实际的业务场景，通常会多种定时任务一起配合使用。</p>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/springboot/2020/09/25/springboot-quartz.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
