<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> ElasticSearch冷热数据分离，滚动索引的使用 - 大伟的博客 </title>
    <meta name="keywords" content="elasticSearch">
    <meta name="description"
          content="使用热数据节点、冷数据节点部署ES集群，索引数据读写分离，Rolover滚动索引，索引生命周期管理，滚动踩坑">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/springcloud/2020/06/10/save-hot-cool-data-in-elasticsearch.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="ElasticSearch冷热数据分离，滚动索引的使用">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>ElasticSearch冷热数据分离，滚动索引的使用</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/06/10
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1冷热数据分离">1、冷热数据分离</h2>

<p>Elasticsearch的冷热数据分离，热数据存储到SSD硬盘，冷数据存储到普通SATA硬盘，降低成本，提升ES的热数据读写性能。</p>

<p>实现方案</p>

<ul>
  <li>ES节点被分为热节点和冷节点，通过节点属性配置实现</li>
  <li>
    <p>索引通过路由分布策略设置，装热数据的索引的分片被分布到热节点上，冷数据的索引被分布到冷节点上</p>
  </li>
  <li>当需要分片数据从热机迁移到冷机上，新建一个冷数据的索引做存储冷数据，或者直接迁移到冷数据索引上</li>
</ul>

<h3 id="索引路由分布策略">索引路由分布策略</h3>

<p>1、配置节点属性</p>

<ul>
  <li>热节点: es-node-1、es-node-2</li>
  <li>冷节点: es-node-3</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 修改 es-node-1 和 es-node-2 的elasticsearch.yml，增加属性</span>
node.attr.tag: hot   <span class="c"># 标识为热数据节点</span>

<span class="c"># 修改 es-node-3 的elasticsearch.yml，增加属性</span>
node.attr.tag: cool  <span class="c"># 标识为冷数据节点</span>

node.attr.<span class="k">*</span> <span class="c"># 你可以按业务场景指定需要的值，如</span>
node.attr.hotwarm_type: hot

<span class="c"># 重启es节点</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/elasticsearch/es-hot-cool1.jpg" alt="" /></p>

<p>2、配置索引路由分布策略</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">索引都分配到热数据节点上</span><span class="w">
</span><span class="err">PUT</span><span class="w"> </span><span class="err">jd_goods/_settings</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"index.routing.allocation.require.tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hot"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">PUT</span><span class="w"> </span><span class="err">index_customer/_settings</span><span class="w">
</span><span class="p">{</span><span class="w">
     </span><span class="nl">"index.routing.allocation.require.tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hot"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>执行后发现，es会自动将两个索引的分片迁移到es-node-1和es-node-2两个热数据节点上</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/es-hot-cool2.jpg" alt="" /></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">创建索引</span><span class="w">
</span><span class="err">PUT</span><span class="w"> </span><span class="err">/index_test</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"settings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"number_of_shards"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">3</span><span class="err">个分片</span><span class="w">
            </span><span class="nl">"number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="err">，//</span><span class="w"> </span><span class="err">每个分片</span><span class="mi">0</span><span class="err">副本</span><span class="w">
             </span><span class="nl">"routing.allocation.require.tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hot"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>第二种方式，通过模板指定索引的冷热存储</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_template/logs_</span><span class="mi">2019-08</span><span class="err">-template</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"index_patterns"</span><span class="p">:</span><span class="w"> </span><span class="s2">"logs_2019-08-*"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"settings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"index.number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"index.routing.allocation.require.hotwarm_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"warm"</span><span class="w">
      </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">PUT</span><span class="w"> </span><span class="err">_template/logs_</span><span class="mi">2019-10</span><span class="err">-template</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"index_patterns"</span><span class="p">:</span><span class="w"> </span><span class="s2">"logs_2019-10-*"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"settings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    	</span><span class="nl">"index.number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
    	</span><span class="nl">"index.routing.allocation.require.hotwarm_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hot"</span><span class="w">
     </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="数据从热机迁移到冷机">数据从热机迁移到冷机</h3>

<p>只需更新索引配置</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">将jd_goods从热机迁移到冷机上</span><span class="w">
</span><span class="err">PUT</span><span class="w"> </span><span class="err">jd_goods/_settings</span><span class="w">
</span><span class="p">{</span><span class="w">
   </span><span class="nl">"settings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"index.routing.allocation.include.tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cool"</span><span class="w">
   </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="err">//</span><span class="w"> </span><span class="err">查看jd_goods的设置信息</span><span class="w">
</span><span class="err">GET</span><span class="w"> </span><span class="err">jd_goods/_settings</span><span class="w">
</span><span class="err">//</span><span class="w"> </span><span class="err">响应</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"jd_goods"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"settings"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"index"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"routing"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"allocation"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"require"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"tag"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cool"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"number_of_shards"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"provided_name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"jd_goods"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"creation_date"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"1590719598769"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"number_of_replicas"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"uuid"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"UntC75oMRPOAgt6uWrNXfg"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"version"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"created"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"7060199"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>执行后发现，数据自动迁移到es-node-3上，主分片数据迁移到es-node3上</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/es-hot-cool3.jpg" alt="" /></p>

<p>我们可以基于时间创建索引，做个定时任务，将超过固定时间的索引修改setting配置，这样就可实现自动迁移冷数据到冷节点上。</p>

<h3 id="集群路由分布策略">集群路由分布策略</h3>

<p>此策略比索引级路由策略权重高</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">/_cluster/settings</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"routing"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"allocation.awareness.attributes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"box_type"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>新建索引时，索引分片及副本只会分配到含有node.attr.box_type属性的节点上。（该值可以为多个，如”box_type,zone”）</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">/_cluster/settings</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"routing"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"allocation.awareness.force.box_type.values"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hot,cool"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>强制分离主分片与副本，若只有hot标签的节点，索引只有分片可以写入，副本无法分配；若有hot、cool两种标签节点，相同分片与其副本绝不在相同标签节点上。但是本来ES就是主分片与副本不在同一个物理机上的，没理解这个配置有啥用。</p>

<h2 id="2读写分离">2、读写分离</h2>

<p>目标：使主分片分配在SSD磁盘上，副本落在SATA磁盘上，读取时优先从副本中查询数据，SSD节点只负责写入数据。</p>

<p>实现步骤：</p>

<p>1、修改集群路由分配策略配置</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT /_cluster/settings
<span class="o">{</span>
	<span class="s2">"routing"</span>:<span class="o">{</span>
		<span class="s2">"allocation.awareness.attributes"</span>: <span class="s2">"box_type"</span>,
		<span class="s2">"allocation.awareness.force.box_type.values"</span>: <span class="s2">"hot,cool"</span>	
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2、提前创建索引</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">log</span><span class="mi">4</span><span class="err">x_trace_</span><span class="mi">2018</span><span class="err">_</span><span class="mi">08</span><span class="err">_</span><span class="mi">11</span><span class="w">
</span><span class="p">{</span><span class="w">
   </span><span class="nl">"settings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"index.routing.allocation.require.box_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hot"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">可使索引所有分片都分配在SSD磁盘中(节点属性box_type=hot的节点上)</span><span class="w">
     </span><span class="nl">"number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
	</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>3、修改索引路由分配策略配置，索引创建好后，动态修改索引配置</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">log</span><span class="mi">4</span><span class="err">x_trace_</span><span class="mi">2018</span><span class="err">_</span><span class="mi">08</span><span class="err">_</span><span class="mi">11</span><span class="err">/_settings</span><span class="w">
</span><span class="p">{</span><span class="w">
 </span><span class="nl">"index.routing.allocation.require.box_type"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
 </span><span class="nl">"number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>4、转为冷数据，动态修改索引配置，并取消副本数</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">log</span><span class="mi">4</span><span class="err">x_trace_</span><span class="mi">2018</span><span class="err">_</span><span class="mi">08</span><span class="err">_</span><span class="mi">11</span><span class="err">/_settings</span><span class="w">
</span><span class="p">{</span><span class="w">
 </span><span class="nl">"index.routing.allocation.require.box_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cool"</span><span class="p">,</span><span class="w">
 </span><span class="nl">"number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>来源于： https://elasticsearch.cn/article/6127#tip3</p>

<h2 id="3rollover索引滚动">3、RollOver索引滚动</h2>

<p>当现有索引被认为太大或太旧时，滚动索引API将别名滚动到新索引，该API接受一个别名和一个条件列表。如果索引满足指定条件，则创建一个新索引，并将别名切换到指向新索引的位置。通过别名写入文档，会写入到新索引上。通过别名读取文档，会搜索所有别名关联的索引。旧索引的文档支持删除API，那更新API是否也支持，测试一下便知。
Rollover支持的条件是：</p>

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>max_age</td>
      <td>指定索引存在的最大时间，如10s（秒），1h（小时），7d（天），1m，1y（年）</td>
    </tr>
    <tr>
      <td>max_docs</td>
      <td>存放的索引文档数（不包括副本）</td>
    </tr>
    <tr>
      <td>max_size</td>
      <td>索引所有主分片大小，如50gb</td>
    </tr>
    <tr>
      <td>max_parimary_shard_size</td>
      <td>索引主分片大小，索引数据一般写入到多个分片，其中一个分片达到设定的大小，则索引触发滚动，官方建议分片大小控制在30gb~50gb</td>
    </tr>
  </tbody>
</table>

<p>下面是ES6.x版本的Rollover API实战举例：</p>

<h3 id="基于序号的索引管理">基于序号的索引管理</h3>

<p>1、创建索引</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">/logs</span><span class="mi">-000001</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"aliases"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="err">//</span><span class="w"> </span><span class="err">别名</span><span class="w">
        </span><span class="nl">"logs_writes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    		</span><span class="nl">"is_write_index"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">表示索引是别名的当前写入索引</span><span class="w">
    	</span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">    
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>2、批量插入数据</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">logs_write/logs/_bulk</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"create"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">1</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"111"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"create"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">2</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"222"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"create"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">3</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"333"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"create"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">4</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4444"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>3、发起RollOver请求，当满足规则，索引就会滚动，创建新的索引，索引别名写入指向新索引，旧索引不再写入文档数据</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/logs_write/_rollover</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"conditions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"max_age"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7d"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"max_docs"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
        </span><span class="nl">"max_size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5gb"</span><span class="w">
        </span><span class="err">//</span><span class="nl">"max_primary_shard_size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"50gb"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>“max_age”: “7d”, 最长期限 7d，超过7天，索引会实现滚动。</li>
  <li>“max_docs”: 5, 最大文档数 5，超过 5个文档，索引会实现滚动（测试需要，设置的很小）。</li>
  <li>“max_primary_shard_size”: “50gb”，主分片最大存储容量 50GB，超过50GB，索引就会滚动。</li>
</ul>

<p>注意，三个条件是或的关系，满足其中一个，索引就会滚动。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">滚动成功响应，创建了新的索引</span><span class="w">
</span><span class="p">{</span><span class="w">
   </span><span class="nl">"old_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"logs-000001"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"new_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"logs-000002"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"rolled_over"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
   </span><span class="nl">"dry_run"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
   </span><span class="nl">"acknowledged"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
   </span><span class="nl">"shards_acknowledged"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
   </span><span class="nl">"conditions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     	</span><span class="nl">"[max_docs: 5]"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    	</span><span class="nl">"[max_age: 7d]"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    	</span><span class="nl">"[max_size: 5gb]"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><mark>注意：</mark></p>

<p>索引不会自动滚动，每次需要手动触发_rollover请求去检查索引是否满足滚动条件，满足则进行滚动，需要结合定时任务触发rollover请求，实现自动滚动。</p>

<h3 id="基于时间的索引管理">基于时间的索引管理</h3>

<p>1、创建基于日期的索引</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">PUT</span><span class="w"> </span><span class="err">/&lt;logs-</span><span class="p">{</span><span class="err">now/d</span><span class="p">}</span><span class="mi">-1</span><span class="err">&gt;</span><span class="w"> </span><span class="err">with</span><span class="w"> </span><span class="err">URI</span><span class="w"> </span><span class="err">encoding:</span><span class="w">
</span><span class="err">PUT</span><span class="w"> </span><span class="err">/%</span><span class="mi">3</span><span class="err">Clogs-%</span><span class="mi">7</span><span class="err">Bnow%</span><span class="mi">2</span><span class="err">Fd%</span><span class="mi">7</span><span class="err">D</span><span class="mi">-1</span><span class="err">%</span><span class="mi">3</span><span class="err">E</span><span class="w"> 
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"aliases"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"logs_write"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"is_write_index"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>URI 编码工具：http://t.cn/RAEZiuq</p>

<p>输入：<code class="highlighter-rouge">&lt;logs-{now/d}-1&gt;</code>
输出：<code class="highlighter-rouge">%3Clogs-%7Bnow%2Fd%7D-1%3E</code></p>

<p><img src="\assets\images\2022\tool\uri-code-convert.jpg" alt="" /></p>

<p>2、插入数据</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">/logs_write/_bulk</span><span class="w">
</span><span class="p">{</span><span class="nl">"index"</span><span class="p">:{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">1</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"testing 01"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"index"</span><span class="p">:{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">2</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"testing 02"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"index"</span><span class="p">:{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">3</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"testing 03"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"index"</span><span class="p">:{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">4</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"testing 04"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"index"</span><span class="p">:{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">5</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"testing 05"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>3、发起RollOver请求</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">POST</span> <span class="o">/</span><span class="n">logs_write</span><span class="o">/</span><span class="n">_rollover</span> 
<span class="o">{</span>
  <span class="s">"conditions"</span><span class="o">:</span> <span class="o">{</span> <span class="c1">// 条件</span>
    <span class="s">"max_age"</span><span class="o">:</span> <span class="s">"7d"</span><span class="o">,</span>
    <span class="s">"max_docs"</span><span class="o">:</span> <span class="mi">5</span><span class="o">,</span>
    <span class="s">"max_primary_shard_size"</span><span class="o">:</span> <span class="s">"50gb"</span>  <span class="c1">// 最大分片大小，官方建议30gb-50gb</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>满足max_docs=5 ，索引滚动，响应数据如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
   <span class="s">"old_index"</span><span class="o">:</span> <span class="s">"logs-2018.08.05-1"</span><span class="o">,</span>
   <span class="s">"new_index"</span><span class="o">:</span> <span class="s">"logs-2018.08.05-000002"</span><span class="o">,</span>
   <span class="s">"rolled_over"</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span>
   <span class="s">"dry_run"</span><span class="o">:</span> <span class="kc">false</span><span class="o">,</span>
   <span class="s">"acknowledged"</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span>
   <span class="s">"shards_acknowledged"</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span>
   <span class="s">"conditions"</span><span class="o">:</span> <span class="o">{</span>
     <span class="s">"[max_docs: 5]"</span><span class="o">:</span> <span class="kc">true</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>如果24小时候后执行，new_index的名字就是+1天后的日期：logs-2018.08.06-000002，序号会自增，跟日期没有关系。</p>

<p>4、插入数据，在满足滚动条件的前提下滚动索引</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">/logs_write/_bulk</span><span class="w">
</span><span class="p">{</span><span class="nl">"index"</span><span class="p">:{</span><span class="nl">"_id"</span><span class="p">:</span><span class="mi">6</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"testing 06"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>查询索引文档数据，验证滚动是否生效</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET</span><span class="w"> </span><span class="err">/log_write/_search</span><span class="w">
</span></code></pre></div></div>

<p>前面执行_rollover时已满足max_docs=5的条件触发了滚动创建新索引<code class="highlighter-rouge">logs-2018.08.05-000002</code>，所以id=6的文档写入到新索引上。</p>

<p>索引不会自动滚动，每次需要手动触发_rollover请求去检查索引是否满足滚动条件，满足则进行滚动，需要结合定时任务触发rollover请求，实现自动滚动。</p>

<h2 id="4索引生命周期管理">4、索引生命周期管理</h2>

<h3 id="管理策略">管理策略</h3>

<p>index-lifecycle-managemen（ILM），从ES6.6开始，Elasticsearch提供索引生命周期管理功能，索引生命周期管理可以通过API或者kibana界面配置，在kibana中的索引生命周期管理位置如下图(版本6.8.2)：</p>

<p><img src="\assets\images\2022\springcloud\es-kibana.png" alt="" /></p>

<p>点击创建create policy，进入配置界面，可以看到索引的生命周期被分为：<code class="highlighter-rouge">Hot</code>, <code class="highlighter-rouge">Warm</code>, <code class="highlighter-rouge">Cold</code>, <code class="highlighter-rouge">Delete</code>四个阶段</p>

<ul>
  <li>
    <p>Hot phrase:</p>

    <p>该阶段可以根据索引的文档数，大小，时长决定是否调用rollover API来滚动索引</p>
  </li>
  <li>
    <p>Warm phrase</p>

    <p>索引在Hot阶段被rollover后便会进入Warm阶段，进入该阶段的索引可以设置为readonly, 用户可以为这个索引设置要使用的attribute， 如对于冷热分离策略，这里可以选择temperature: warm属性，还可以对索引进行forcemerge，shrink，set  priority设置索引优先级（值越大，优先级越高，ES节点重启，会按该优先级恢复索引），kibana配置界面如下：</p>

    <p><img src="\assets\images\2022\springcloud\es-kibana-phrase.png" alt="" /></p>
  </li>
  <li>
    <p>Cold phrase</p>

    <p>索引rollover一段时间后进入cold阶段，通过设置min_age值进入该阶段。从冷热分离架构可以看出冷热属性是具备扩展性的，不仅可以指定hot, warm, 也可以扩展增加hot, warm, cold, freeze等多个冷热属性。如果想使用三层的冷热分离的话这里可以指定为temperature: cold, 此阶段支持对索引的freeze操作</p>
  </li>
  <li>
    <p>Delete phrase</p>

    <p>索引rollover一段时间后进入delete阶段，通过设置min_age值进入该阶段，进入该阶段的索引会自动被删除。</p>
  </li>
</ul>

<h3 id="四个生命周期阶段">四个生命周期阶段</h3>

<p>phrase与Action：</p>

<p><img src="\assets\images\2022\springcloud\es-policy.png" alt="" /></p>

<ul>
  <li>
    <p>Hot</p>

    <p>Set Priority，具有较高优先级的索引将在节点重启后优先恢复。通常，热阶段的指数应具有最高值，而冷阶段的指数应具有最低值。未设置此值的指标的隐含默认优先级为1。</p>
  </li>
  <li>
    <p>Warm</p>

    <p>Read-Only：设为只读索引</p>

    <p>Allocate：</p>

    <p><img src="\assets\images\2022\springcloud\es-ilm-policy-warm.png" alt="" /></p>

    <table>
      <thead>
        <tr>
          <th>名称</th>
          <th>描述</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>number_of_replicas</td>
          <td>要分配给索引的副本数</td>
        </tr>
        <tr>
          <td>include</td>
          <td>为具有至少一个属性的节点分配索引</td>
        </tr>
        <tr>
          <td>exclude</td>
          <td>为没有任何属性的节点分配索引</td>
        </tr>
        <tr>
          <td>require</td>
          <td>为具有所有属性的节点分配索引</td>
        </tr>
      </tbody>
    </table>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"allocate"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"box_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"warm"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">分片数据迁移到节点属性</span><span class="w"> </span><span class="err">box_type</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">warm的ES节点</span><span class="w"> 
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">副本数为</span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="nl">"readonly"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></code></pre></div>    </div>

    <p>Force Merge：强制合并，<code class="highlighter-rouge">索引将变成只读</code></p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_ilm/policy/my_policy</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"policy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"phases"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"warm"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"actions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"forcemerge"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"max_num_segments"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="err">//合并后的shard里的lucene</span><span class="w"> </span><span class="err">segments数</span><span class="p">,</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>

    <p>Shrink：收缩索引，<code class="highlighter-rouge">索引将变成只读</code></p>

    <p>收缩索引API允许您将现有索引缩减为具有较少主分片的新索引。目标索引中请求的主分片数必须是源索引中分片数的一个因子。如果索引中的分片数是素数，则只能缩小为单个主分片。</p>

    <p>新索引将有一个新名称：<code class="highlighter-rouge">shrink-&lt;origin-index-name&gt;</code>。因此，如果原始索引称为“logs”，则新索引将命名为“shrink-logs”。</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_ilm/policy/my_policy</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"policy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"phases"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"warm"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"actions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"shrink"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"number_of_shards"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Cold</p>

    <p>Freeze：冷冻索引</p>

    <p>为了使索引可用且可查询更长时间但同时降低其硬件要求，它们可以转换为冻结状态。一旦索引被冻结，它的所有瞬态分片内存（除了映射和分析器）都会被移动到持久存储。</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_ilm/policy/my_policy</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"policy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"phases"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"cold"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"actions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"freeze"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>

    <p><mark>注意</mark></p>

    <p>冻结一个索引会close并reopen，这会导致短时间内索引不可用，集群会变red，直到这个索引的分片分配完毕。</p>
  </li>
  <li>
    <p>Delete</p>
  </li>
</ul>

<h3 id="时间参数">时间参数</h3>

<p>在 ILM 中，索引滚动后基于 min_age 参数进入下一个阶段（phrase）。未设置，默认是0ms，像hot阶段不用设置min_age。</p>

<p>min_age通常是指从索引被创建时开始计算的时间，如果是滚动索引，min_age是从索引滚动开始计算。在索引生命周期管理检查min_age并过渡到下一个阶段之前，<strong>前一个阶段的操作必须完成</strong>。min_age的单位 s秒，h小时，d天，y年，举例子</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_ilm/policy/my_policy</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"policy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"phases"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"warm"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"min_age"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1d"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"actions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"allocate"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"delete"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"min_age"</span><span class="p">:</span><span class="w"> </span><span class="s2">"30d"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"actions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"delete"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>索引创建在 1 天后将移动到 warm 暖阶段。在此之前，索引处于等待状态。</li>
  <li>进入 warm 暖阶段后，它将等到 30 天后才进入删除 delete 阶段并删除索引。</li>
</ul>

<p><img src="\assets\images\2022\springcloud\es-ilm-min-age.png" alt="" /></p>

<h3 id="节点角色">节点角色</h3>

<p>7.9+版本后，ES出现了节点角色的概念，配置好节点的冷热温节点角色，索引的分片数据迁移不再需要配置分配策略</p>

<p>Elasitcsearch 7.9 之前早期版本，需要配置分片分配策略机制，如下：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"allocate"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      	</span><span class="nl">"box_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"warm"</span><span class="w">
      </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>7.9+之后新版本相当于我们提前预设定了冷热集群架构的节点不同的角色，后台会帮我们自动迁移数据。</p>

<p>仅数据层面的节点角色做了如下细分：</p>

<ul>
  <li>data_hot 热节点</li>
  <li>data_warm 暖节点</li>
  <li>data_cold 冷节点</li>
  <li>data_content 数据内容节点</li>
  <li>data：原有数据节点</li>
</ul>

<p>三节点的样例冷热集群架构集群节点角色划分如下：</p>

<p><img src="\assets\images\2022\springcloud\es-cluster.png" alt="" /></p>

<p>es 的elasticsearch.yml 配置文件如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">node.roles</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">data_hot</span><span class="pi">,</span> <span class="nv">data_content</span><span class="pi">,</span> <span class="nv">master</span><span class="pi">,</span> <span class="nv">ingest</span> <span class="pi">]</span>
</code></pre></div></div>

<p>我们只需要设置好不同的横向：phrase 和 每个phrase 下的 action（rollover，freeze， number_of_replicas  delete forcemerge 操作）就可以了，其他的我们不需要关注了，后台会有定时任务轮询完整数据各个 phrase 阶段的更迭</p>

<h3 id="dsl-实战索引生命周期管理">DSL 实战索引生命周期管理</h3>

<p>策略不一定需要配置每个阶段，始终使用索引模板来定义具有滚动操作的策略</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># step1: 前提：演示刷新需要,默认是10分钟检查索引是否满足rollover条件</span>
<span class="c"># 检查是否满足 rollover 的周期频率值</span>
PUT _cluster/settings
<span class="o">{</span>
  <span class="s2">"persistent"</span>: <span class="o">{</span>
    <span class="s2">"indices.lifecycle.poll_interval"</span>: <span class="s2">"1s"</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c"># step2:测试需要，值调的很小</span>
PUT _ilm/policy/my_custom_policy_filter
<span class="o">{</span>
  <span class="s2">"policy"</span>: <span class="o">{</span>
    <span class="s2">"phases"</span>: <span class="o">{</span>
      <span class="s2">"hot"</span>: <span class="o">{</span>
        <span class="s2">"actions"</span>: <span class="o">{</span>
          <span class="s2">"rollover"</span>: <span class="o">{</span> // 滚动索引
            <span class="s2">"max_age"</span>: <span class="s2">"3d"</span>,
            // <span class="s2">"max_docs"</span>: 5, 不一定都配置
            <span class="s2">"max_size"</span>: <span class="s2">"50gb"</span>  // 数据写入达到50gb，即索引大小
          <span class="o">}</span>,
          <span class="s2">"set_priority"</span>: <span class="o">{</span>
            <span class="s2">"priority"</span>: 100 // 优先加载，值越大优先级越高，ES节点重启根据该优先级恢复索引
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>,
      <span class="s2">"warm"</span>: <span class="o">{</span>
        <span class="s2">"min_age"</span>: <span class="s2">"30s"</span>, // 索引滚动后，经过30秒进入该阶段，触发action操作
        <span class="s2">"actions"</span>: <span class="o">{</span>
          <span class="s2">"forcemerge"</span>: <span class="o">{</span>  // 强制合并,索引会变成只读
            <span class="s2">"max_num_segments"</span>: 1  // 分片只有1个段
          <span class="o">}</span>,
           <span class="s2">"shrink"</span>: <span class="o">{</span>  // 收缩索引，索引会变成只读
                <span class="s2">"number_of_shards"</span>:1 // 主分片数
           <span class="o">}</span>,
          <span class="s2">"allocate"</span>: <span class="o">{</span>
            <span class="s2">"require"</span>: <span class="o">{</span>
              <span class="s2">"box_type"</span>: <span class="s2">"warm"</span> // 分片数据迁移到节点属性 box_type <span class="o">=</span> warm的ES节点 
            <span class="o">}</span>,
            <span class="s2">"number_of_replicas"</span>: 0 // 副本数为0
          <span class="o">}</span>,
          <span class="s2">"set_priority"</span>: <span class="o">{</span> // 设置优先级
            <span class="s2">"priority"</span>: 50 
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>,
      <span class="s2">"cold"</span>: <span class="o">{</span>
        <span class="s2">"min_age"</span>: <span class="s2">"90s"</span>,  // 索引滚动后，经过90秒进入该阶段，触发action操作
        <span class="s2">"actions"</span>: <span class="o">{</span>
          <span class="s2">"allocate"</span>: <span class="o">{</span>
            <span class="s2">"require"</span>: <span class="o">{</span>
              <span class="s2">"box_type"</span>: <span class="s2">"cold"</span> // 分片数据迁移到节点属性 box_type <span class="o">=</span> cold的ES节点 
            <span class="o">}</span>
          <span class="o">}</span>,
         <span class="s2">"freeze"</span>: <span class="o">{}</span> // 冷冻索引
        <span class="o">}</span>
      <span class="o">}</span>,
      <span class="s2">"delete"</span>: <span class="o">{</span>
        <span class="s2">"min_age"</span>: <span class="s2">"150s"</span>, // 索引滚动后，经过150秒进入该阶段，触发action操作
        <span class="s2">"actions"</span>: <span class="o">{</span>
          <span class="s2">"delete"</span>: <span class="o">{}</span> // 删除索引
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c"># step3:创建模板，关联配置的ilm_policy ,ES版本7.4</span>
PUT _template/timeseries_template
<span class="o">{</span>
  <span class="s2">"index_patterns"</span>: <span class="o">[</span><span class="s2">"timeseries-*"</span><span class="o">]</span>,                 
    <span class="s2">"settings"</span>: <span class="o">{</span>
    	<span class="s2">"index"</span>: <span class="o">{</span>
        	<span class="s2">"number_of_shards"</span>: 3,
      		<span class="s2">"number_of_replicas"</span>: 1,
      		<span class="s2">"lifecycle"</span>: <span class="o">{</span>
      			<span class="s2">"name"</span>: <span class="s2">"my_custom_policy_filter"</span>, // ILM策略
      			<span class="s2">"rollover_alias"</span>: <span class="s2">"timeseries"</span> // 别名
      		<span class="o">}</span>,
      		<span class="s2">"routing"</span>: <span class="o">{</span>
      			<span class="s2">"allocation"</span>: <span class="o">{</span>
      				<span class="s2">"require"</span>:<span class="o">{</span>
      				   <span class="s2">"box_type"</span>: <span class="s2">"hot"</span> <span class="c"># 新创建的索引分配到节点属性 box_type = hot的ES节点（热节点）</span>
      				<span class="o">}</span>
      			<span class="o">}</span>
      		<span class="o">}</span>
    	<span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c"># step4:创建起始索引（便于滚动），基于序号</span>
PUT timeseries-000001
<span class="o">{</span>
  <span class="s2">"aliases"</span>: <span class="o">{</span>
    <span class="s2">"timeseries"</span>: <span class="o">{</span>
      <span class="s2">"is_write_index"</span>: <span class="nb">true</span> // true表示索引是别名的当前写入索引，索引滚动后该属性会变为false
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c"># step5：插入数据</span>
PUT timeseries/_bulk
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_id"</span>:1<span class="o">}}</span>
<span class="o">{</span><span class="s2">"title"</span>:<span class="s2">"testing 01"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_id"</span>:2<span class="o">}}</span>
<span class="o">{</span><span class="s2">"title"</span>:<span class="s2">"testing 02"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_id"</span>:3<span class="o">}}</span>
<span class="o">{</span><span class="s2">"title"</span>:<span class="s2">"testing 03"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_id"</span>:4<span class="o">}}</span>
<span class="o">{</span><span class="s2">"title"</span>:<span class="s2">"testing 04"</span><span class="o">}</span>

<span class="c"># step6：临界值（会滚动）</span>
PUT timeseries/_bulk
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_id"</span>:5<span class="o">}}</span>
<span class="o">{</span><span class="s2">"title"</span>:<span class="s2">"testing 05"</span><span class="o">}</span>
<span class="c"># 下一个索引数据写入</span>
PUT timeseries/_bulk
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_id"</span>:6<span class="o">}}</span>
<span class="o">{</span><span class="s2">"title"</span>:<span class="s2">"testing 06"</span><span class="o">}</span>

<span class="c"># 查看索引的ILM是否生效</span>
GET /timeseries/_ilm/explain
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">参数</th>
      <th style="text-align: left">说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">hot</td>
      <td style="text-align: left">该策略设置索引只要满足其中任一条件：数据写入达到50GB、使用超过3天、doc数超过5，就会触发索引滚动更新。此时系统将创建一个新索引，该索引将重新启动策略，而旧索引将在滚动更新后等待30秒进入warm阶段，这30秒索引其实还是hot阶段，处于一个等待状态</td>
    </tr>
    <tr>
      <td style="text-align: left">warm</td>
      <td style="text-align: left">索引进入warm阶段后，ILM会将索引收缩到1个分片，强制合并为1个段，数据迁移到warm(温数据)节点。完成该操作后，索引将在70秒（从滚动更新时算起）后进入cold阶段，70-30=40，即索引处于warm阶段40秒</td>
    </tr>
    <tr>
      <td style="text-align: left">cold</td>
      <td style="text-align: left">索引进入cold阶段后，ILM将索引从warm节点移动到cold（冷数据）节点。完成操作后，索引将在120秒（从滚动更新时算起）后进入delete阶段，120-70=50，即索引处于cold阶段50秒</td>
    </tr>
    <tr>
      <td style="text-align: left">delete</td>
      <td style="text-align: left">索引进入delete阶段后被删除。</td>
    </tr>
  </tbody>
</table>

<p><strong>核心步骤</strong>总结如下：</p>

<ul>
  <li>第一步：创建生周期 policy。</li>
  <li>第二步：创建索引模板，模板中关联 policy 和别名。</li>
  <li>第三步：创建符合模板的起始索引，并插入数据。</li>
  <li>第四步: 索引基于配置的 ilm 滚动</li>
</ul>

<blockquote>
  <p>统一APP消息中心，待办消息索引使用ILM</p>
</blockquote>

<p>step1，设置rollover的检查频率</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_cluster/settings</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"persistent"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"indices.lifecycle.poll_interval"</span><span class="p">:</span><span class="w"> </span><span class="s2">"30s"</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="mi">30</span><span class="err">秒检查一次rollover，默认</span><span class="mi">10</span><span class="err">分钟</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>step2: 创建ILM策略</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_ilm/policy/index_toread_policy_filter</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"policy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"phases"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"hot"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">      </span><span class="err">//</span><span class="w"> </span><span class="err">热阶段</span><span class="w">
        </span><span class="nl">"actions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"rollover"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"max_age"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1y"</span><span class="p">,</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">索引创建</span><span class="mi">1</span><span class="err">年后</span><span class="w">
            </span><span class="nl">"max_docs"</span><span class="p">:</span><span class="w"> </span><span class="mi">20000000</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">索引最大文档数（不包含副本）</span><span class="mi">2000</span><span class="err">万</span><span class="w">
            </span><span class="nl">"max_size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"50gb"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">索引大小</span><span class="mi">50</span><span class="err">GB</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"set_priority"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"priority"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">值越大，优先级越高</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"warm"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">         </span><span class="err">//</span><span class="w"> </span><span class="err">温阶段</span><span class="w">
        </span><span class="nl">"min_age"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10d"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">索引滚动更新</span><span class="mi">10</span><span class="err">天后进入warm阶段</span><span class="w">
        </span><span class="nl">"actions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"forcemerge"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="err">//</span><span class="w"> </span><span class="err">实现段合并</span><span class="w">
                </span><span class="nl">"max_num_segments"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">每个分片强制合并为</span><span class="mi">1</span><span class="err">个段，即每个分片下只有</span><span class="mi">1</span><span class="err">个段</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">分片的副本数为</span><span class="mi">0</span><span class="err">，没有副本</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"set_priority"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"priority"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">优先级设为</span><span class="mi">50</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"delete"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">           </span><span class="err">//</span><span class="w"> </span><span class="err">删除阶段</span><span class="w">
        </span><span class="nl">"min_age"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1y"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">索引滚动更新</span><span class="mi">1</span><span class="err">年后，进入删除阶段</span><span class="w">
        </span><span class="nl">"actions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
             </span><span class="nl">"delete"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">删除索引</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="err">}</span><span class="w">
</span></code></pre></div></div>

<p>step3，创建索引模板，关联ILM策略</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_template/index_toread_template</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"index_patterns"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"index_toread-*"</span><span class="p">],</span><span class="w">                
   </span><span class="nl">"settings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"number_of_shards"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">创建的索引有</span><span class="mi">3</span><span class="err">个分片</span><span class="w">
            </span><span class="nl">"number_of_replicas"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">每个分片，</span><span class="mi">1</span><span class="err">个副本</span><span class="w">
            </span><span class="nl">"lifecycle"</span><span class="p">:{</span><span class="w">
                </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"index_toread_policy_filter"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">关联ILM策略</span><span class="w">
                </span><span class="nl">"rollover_alias"</span><span class="p">:</span><span class="w"> </span><span class="s2">"index_toread"</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">滚动索引别名</span><span class="w">
            </span><span class="p">}</span><span class="w">
            </span><span class="err">/*</span><span class="nl">"routing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"allocation"</span><span class="p">:{</span><span class="w">
                    </span><span class="nl">"require"</span><span class="p">:{</span><span class="w">
                        </span><span class="nl">"box_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hot"</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">路由的ES的hot节点，这里注释掉</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="err">*/</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"mappings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"sourceAppName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">              </span><span class="err">//</span><span class="w"> </span><span class="err">来源系统</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"pushAppName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                </span><span class="err">//</span><span class="w"> </span><span class="err">推送的目标应用</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"subject"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                    </span><span class="err">//</span><span class="w"> </span><span class="err">主标题</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                  </span><span class="err">//</span><span class="w"> </span><span class="err">副标题</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="w">             
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"link"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                   </span><span class="err">//</span><span class="w">  </span><span class="err">待办的链接地址</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">          </span><span class="err">//</span><span class="w"> </span><span class="err">不支持搜索</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"mobileLink"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"modelId"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                    </span><span class="err">//</span><span class="w"> </span><span class="err">来源系统待办消息业务id，</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"docCreator"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="w">           </span><span class="err">//</span><span class="w"> </span><span class="err">发起人账号</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"target"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">                     </span><span class="err">//</span><span class="w"> </span><span class="err">接受人账号</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"createTime"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="err">//</span><span class="w"> </span><span class="err">创建时间</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"date"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
            </span><span class="p">}</span><span class="err">，</span><span class="w">
            </span><span class="nl">"endTime"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">处理时间</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"date"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
            </span><span class="p">}</span><span class="err">，</span><span class="w">
            </span><span class="nl">"extra"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">          </span><span class="err">//</span><span class="w"> </span><span class="err">额外字段属性</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>stpe4，创建起始索引</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="err">//</span><span class="w"> </span><span class="err">PUT</span><span class="w"> </span><span class="err">/&lt;index_toread-</span><span class="p">{</span><span class="err">now/d</span><span class="p">}</span><span class="mi">-000001</span><span class="err">&gt;</span><span class="w">
</span><span class="err">PUT</span><span class="w"> </span><span class="err">/%</span><span class="mi">3</span><span class="err">Cindex_toread-%</span><span class="mi">7</span><span class="err">Bnow%</span><span class="mi">2</span><span class="err">Fd%</span><span class="mi">7</span><span class="err">D</span><span class="mi">-000001</span><span class="err">%</span><span class="mi">3</span><span class="err">E</span><span class="w">
</span><span class="p">{</span><span class="w">
 </span><span class="nl">"aliases"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"index_toread"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"is_write_index"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">通过索引别名进行数据写入</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>step5，检查索引IML配置是否生效</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET</span><span class="w"> </span><span class="err">索引名称/_ilm/explain</span><span class="w">
</span><span class="err">GET</span><span class="w"> </span><span class="err">/index_toread/_ilm/explain</span><span class="w">
</span></code></pre></div></div>

<p>插入数据，观察索引滚动。</p>

<h3 id="kibana--界面实战索引生命周期管理">Kibana  界面实战索引生命周期管理</h3>

<p>1、创建policy策略</p>

<p><img src="\assets\images\2022\springcloud\es-kibana-create-policy.png" alt="" /></p>

<p>2、关联索引模板</p>

<p>模板要先创建</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT _index_template/timebase_template 
<span class="o">{</span> <span class="s2">"index_patterns"</span>: <span class="o">[</span><span class="s2">"time_base-*"</span><span class="o">]</span> <span class="o">}</span>
</code></pre></div></div>

<p>创建起始索引，指定别名和写入</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT time_base-000001 <span class="o">{</span> <span class="s2">"aliases"</span>: <span class="o">{</span> <span class="s2">"timebase_alias"</span>: <span class="o">{</span> <span class="s2">"is_write_index"</span>: <span class="nb">true</span> <span class="o">}</span> <span class="o">}</span> <span class="o">}</span>
</code></pre></div></div>

<p><img src="\assets\images\2022\springcloud\es-kibana-policy-template.png" alt="" /></p>

<p>小结：</p>

<p>索引生命周期管理需要加强对三个概念的认知：</p>

<ul>
  <li>横向——Phrase 阶段：Hot、Warm、Cold、Delete 等对应索引的生、老、病、死。</li>
  <li>纵向——Actions 阶段：各个阶段的动作。</li>
  <li>横向纵向整合的Policy：实际是阶段和动作的综合体。</li>
</ul>

<p>配置完毕Policy，关联好模板 template，整个核心工作就完成了80%。</p>

<p>剩下就是各个阶段 Actions 的调整和优化了。</p>

<p>实战表明：用 DSL 实现ILM 比图形化界面更可控、更便于问题排查。</p>

<h3 id="策略更新启用关闭">策略更新启用关闭</h3>

<ol>
  <li>如果没有index应用这份策略，那么我们可以直接更新该策略。</li>
  <li>如果有index应用了这份策略，那么当前正在执行的阶段不会同步修改，当当前阶段结束后，会进入新版本策略的下个阶段。</li>
  <li>如果更换了策略，当前正在执行的阶段不会变化，在结束当前阶段后，将会由新的策略管理下一个生命周期。</li>
</ol>

<p>错误处理：</p>

<p>当在生命周期策略处理中出现异常时，会进入错误阶段，停止策略的执行。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /myindex/_ilm/explain
</code></pre></div></div>

<p>使用上述API可以看到异常的原因，当解决这个问题，并更新策略后，可以通过下面的API进行重试：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /myindex/_ilm/retry
</code></pre></div></div>

<p>ILM的状态查看：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET _ilm/status
{
  "operation_mode": "RUNNING"
}
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>名称</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>RUNNING</td>
      <td>Normal operation where all policies are executed as normal</td>
    </tr>
    <tr>
      <td>STOPPING</td>
      <td>ILM has received a request to stop but is still processing some policies</td>
    </tr>
    <tr>
      <td>STOPPED</td>
      <td>This represents a state where no policies are executed</td>
    </tr>
  </tbody>
</table>

<p>ILM的启用关闭</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">_ilm/start</span><span class="w">
</span><span class="err">POST</span><span class="w"> </span><span class="err">_ilm/stop</span><span class="w">
</span></code></pre></div></div>

<p>参考：</p>

<p>https://mp.weixin.qq.com/s/Px5Eo7_aGy8cDLrhToSn_w</p>

<p>https://mp.weixin.qq.com/s/7VQd5sKt_PH56PFnCrUOHQ</p>

<p>https://www.alibabacloud.com/help/zh/elasticsearch/latest/use-ilm-to-separate-hot-data-and-cold-data</p>

<p>https://www.csdn.net/tags/MtTagg0sNDM2NjgtYmxvZwO0O0OO0O0O.html</p>

<p><a href="https://zhuanlan.zhihu.com/p/154339421">ElasticSearch索引容量管理实践</a></p>

<h3 id="滚动踩坑">滚动踩坑</h3>

<p>ILM触发索引滚动后，旧索引会添加两个设置，通过别名进行写操作会被阻塞（新增、更新、删除）</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">查询索引相关信息</span><span class="w">
</span><span class="err">GET</span><span class="w"> </span><span class="err">/index_todo</span><span class="mf">-2022.07</span><span class="err">.</span><span class="mi">31-000002</span><span class="w">
</span></code></pre></div></div>

<p><img src="\assets\images\2022\springcloud\es-ilm-block.png" alt="" /></p>

<p>索引 index_todo-2022.07.31-000002 不支持删除文档请求了，不支持删除待处理消息的业务场景，我把索引的<code class="highlighter-rouge">blocks.write</code>属性设置为false，就支持delete请求了</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">/index_todo</span><span class="mf">-2022.07</span><span class="err">.</span><span class="mi">31-000002</span><span class="err">/_settings</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"index"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"blocks"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"write"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="w">
            </span><span class="p">},</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>但也导致了ILM 自动滚动索引失败，索引满足滚动条件也不会自动滚动，查看索引的ILM信息</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET</span><span class="w"> </span><span class="err">/index_todo/_ilm/explain</span><span class="w">
</span></code></pre></div></div>

<p><img src="\assets\images\2022\springcloud\es-ilm-rollover-error.png" alt="" /></p>

<p>因为修改索引 index_todo-2022.07.31-000002 允许删除导致。</p>

<p>那我们就手动触发rollover请求</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST</span><span class="w"> </span><span class="err">/index_todo/_rollover</span><span class="w">
</span></code></pre></div></div>

<p>滚动后创建了新的索引 <code class="highlighter-rouge">index_todo-2022.08.03-000004</code>，已被ILM管理了</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET</span><span class="w"> </span><span class="err">/index_todo/_ilm/explain</span><span class="w">
</span></code></pre></div></div>

<p><img src="\assets\images\2022\springcloud\es-ilm-check-rollover-ready.png" alt="" /></p>

<p>而旧索引<code class="highlighter-rouge">index_todo-2022.08.01-000003</code>没有被加上<code class="highlighter-rouge">blocks.write=true</code>的属性，</p>

<p><img src="\assets\images\2022\springcloud\es-is-write-index-false.png" alt="" /></p>

<p><code class="highlighter-rouge">is_write_index=false</code>不支持新增文档，但没有了<code class="highlighter-rouge">blocks.write=true</code>，应该支持删除文档，这是与ILM自动滚动的不同点，测试一下</p>

<p>经过测试确实支持删除文档操作。因为配置ILM策略，在warm阶段，增加forcemerge强制合并或者shrink收缩索引操作，导致索引变成只读，ILM就会给旧索引增加属性<code class="highlighter-rouge">blocks.write=true</code>，阻塞写操作（不能删除，更新）。</p>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/springcloud/2020/06/10/save-hot-cool-data-in-elasticsearch.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
