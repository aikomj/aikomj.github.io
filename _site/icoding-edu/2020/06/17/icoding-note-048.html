<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 飞天班第48节：数据库高级应用-1 - 大伟的博客 </title>
    <meta name="keywords" content="mysql">
    <meta name="description"
          content="mysql5.7的安装，sql语句基础知识回顾，mysql数据引擎，mysql错误日志、慢查询日志、二进制日志binlog，开启binlog备份数据，binlog的statement、row模式的比较，全量备份、差异备份、增量备份，热备、温备、冷备，mysqldump导出数据备份，使用crontab定时备份数据库，模拟drop database 恢复数据。">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-edu/2020/06/17/icoding-note-048.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="飞天班第48节：数据库高级应用-1">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>飞天班第48节：数据库高级应用-1</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/06/17
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1mysql-57安装">1、MySQL 5.7安装</h2>

<blockquote>
  <p>Linux</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1、下载rpm包
wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.28-1.el7.x86_64.rpm-bundle.tar

<span class="c"># 如果提示需要账号密码，就用这个方式下载</span>
<span class="c"># wget --http-user=youremail@email.com --http-passwd=yourpassword https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.28-1.el7.x86_64.rpm-bundle.tar</span>

2、查看系统是否自带mariadb
rpm <span class="nt">-qa</span> | <span class="nb">grep </span>mariadb
<span class="o">[</span>root@alibaba <span class="nb">local</span><span class="o">]</span><span class="c"># rpm -qa | grep mariadb</span>
mariadb-libs-5.5.60-1.el7_5.x86_64

3、将查出的mariadb进行卸载
rpm <span class="nt">-e</span> <span class="nt">--nodeps</span> mariadb-libs-5.5.60-1.el7_5.x86_64

4、把刚刚下载的mysql tar解压
<span class="nb">tar</span> <span class="nt">-xvf</span> mysql-5.7.28-1.el7.x86_64.rpm-bundle.tar

5、在解压目录安装如下4个mysql核心包
rpm <span class="nt">-ivh</span> mysql-community-common-5.7.28-1.el7.x86_64.rpm
rpm <span class="nt">-ivh</span> mysql-community-libs-5.7.28-1.el7.x86_64.rpm
rpm <span class="nt">-ivh</span> mysql-community-client-5.7.28-1.el7.x86_64.rpm
rpm <span class="nt">-ivh</span> mysql-community-server-5.7.28-1.el7.x86_64.rpm

6、安装到server时缺少依赖报错
<span class="o">[</span>root@alibaba mysql5.7]# rpm <span class="nt">-ivh</span> mysql-community-server-5.7.28-1.el7.x86_64.rpm
warning: mysql-community-server-5.7.28-1.el7.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 5072e1f5: NOKEY
error: Failed dependencies:
        libaio.so.1<span class="o">()(</span>64bit<span class="o">)</span> is needed by mysql-community-server-5.7.28-1.el7.x86_64
        libaio.so.1<span class="o">(</span>LIBAIO_0.1<span class="o">)(</span>64bit<span class="o">)</span> is needed by mysql-community-server-5.7.28-1.el7.x86_64
        libaio.so.1<span class="o">(</span>LIBAIO_0.4<span class="o">)(</span>64bit<span class="o">)</span> is needed by mysql-community-server-5.7.28-1.el7.x86_64

7、安装缺少的依赖
yum <span class="nt">-y</span> <span class="nb">install </span>libaio

8、再次安装server
rpm <span class="nt">-ivh</span> mysql-community-server-5.7.28-1.el7.x86_64.rpm

9、启动mysql服务
<span class="o">[</span>root@alibaba ~]# service mysqld start
Redirecting to /bin/systemctl start mysqld.service

10、查看v5.7版本的默认登录密码,只能本地登录
<span class="o">[</span>root@alibaba ~]# <span class="nb">grep </span>password /var/log/mysqld.log
2020-06-19T04:30:50.288394Z 1 <span class="o">[</span>Note] A temporary password is generated <span class="k">for </span>root@localhost: <span class="o">=</span>GDs4dKhDTJT

11、登录到mysql命令行，修改默认密码
<span class="o">[</span>root@alibaba ~]# mysql <span class="nt">-uroot</span> <span class="nt">-p</span>
mysql&gt; ALTER USER <span class="s1">'root'</span>@<span class="s1">'localhost'</span> IDENTIFIED BY <span class="s1">'12345678'</span><span class="p">;</span>

12、会告诉你密码不符合规范，可以修改校验等级和长度后再次执行上面的语句
mysql&gt; <span class="nb">set </span>global <span class="nv">validate_password_policy</span><span class="o">=</span>LOW<span class="p">;</span>
mysql&gt; <span class="nb">set </span>global <span class="nv">validate_password_length</span><span class="o">=</span>6<span class="p">;</span> 

13、账户授权
mysql&gt; use mysql<span class="p">;</span>
mysql&gt; <span class="k">select </span>host,user from user<span class="p">;</span>
<span class="c"># 所有ip都可以访问数据库</span>
mysql&gt; grant all privileges on <span class="k">*</span>.<span class="k">*</span> to gavin@<span class="s1">'%'</span> identified by <span class="s1">'123456'</span><span class="p">;</span>
<span class="c"># 也可以设置只有内网网段ip才可访问，并授权账号可以授权其他人,%不限制访问的ip</span>
<span class="c"># mysql&gt; grant all privileges on *.* to gavin@'192.168.%' identified by '123456' with grant option;</span>
mysql&gt; flush privileges<span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>yum安装的mysql</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum remove mysql mysql-server mysql-libs compat-mysql51
<span class="c"># 删除数据目录</span>
<span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/mysq
<span class="c"># 删除配置文件</span>
<span class="nb">rm</span> /etc/my.cnf
</code></pre></div>    </div>
  </li>
  <li>
    <p>rpm安装的mysql</p>
  </li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpm <span class="nt">-qa</span> | <span class="nb">grep</span> <span class="nt">-i</span> mysql
<span class="c"># 1、将查出来的包名卸载</span>
rpm <span class="nt">-e</span> –nodeps 包名
<span class="c"># 查看mysql是否开启启动</span>
chkconfig <span class="nt">--list</span> | <span class="nb">grep</span> <span class="nt">-i</span> mysql
<span class="c"># 2、删除mysql开启启动服务</span>
chkconfig <span class="nt">--del</span> mysql
<span class="c"># 3、然后找出OS中分散的mysql文件夹，并删除</span>
<span class="o">[</span>root@helloworld mysql]# find / <span class="nt">-name</span> mysql
/etc/selinux/targeted/active/modules/100/mysql
/etc/rc.d/init.d/mysql
/run/lock/subsys/mysql
/var/spool/mail/mysql
/usr/bin/mysql
/usr/local/mysql
/usr/local/mysql/bin/mysql
/usr/local/mysql/data/mysql
/usr/local/mysql/include/mysql
/usr/lib64/mysql
/usr/lib64/python2.7/site-packages/sqlalchemy/dialects/mysql
/usr/share/mysql
/home/mysql
/www/aikomj.github.io/assets/images/2020/icoding/mysql
/www/aikomj.github.io/_posts/2020/mysql
/www/jekyll-blog/mysql
/www/jekyll-blog/assets/images/2020/icoding/mysql
/root/mysql
/root/mysql/mysql
</code></pre></div></div>

<blockquote>
  <p>Window</p>
</blockquote>

<p><strong>安装mysql8.0</strong></p>

<p>1、下载免安装版，解压缩</p>

<p>2、配置环境变量</p>

<ul>
  <li>变量名：<code class="highlighter-rouge">MYSQL_HOME</code></li>
  <li>变量值：<code class="highlighter-rouge">D:\software\mysql-8.0.13-winx64</code>（这里填写MySQL的安装路径）</li>
</ul>

<p>在path变量的变量值末尾加上：<code class="highlighter-rouge">;%MYSQL_HOME%\bin</code></p>

<p>3、生成data文件</p>

<p>打开cmd窗口，切换到<code class="highlighter-rouge">%MYSQL_HOME%/bin</code>下，输入命令：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysqld <span class="nt">--initialize-insecure</span> <span class="nt">--user</span><span class="o">=</span>mysql
</code></pre></div></div>

<p>等待执行完毕，会在mysql根目录下生成data文件夹</p>

<p>4、启动msyql服务</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 以管理员身份运行CMD 命令，否则没有权限</span>
net start mysql
</code></pre></div></div>

<p><img src="\assets\images\tools\windows-admin-cmd.png" alt="" /></p>

<p><img src="\assets\images\tools\windows-start-mysql.jpg" alt="" /></p>

<p>5、登录msyql</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> root <span class="nt">-p</span>
<span class="c"># 此时会提示输入密码，由于初次登录MySQL，无需输入密码，所以直接回车即可</span>

<span class="c"># 修改 root用户的密码</span>
mysql&gt; ALTER USER <span class="s1">'root'</span>@<span class="s1">'localhost'</span> IDENTIFIED WITH mysql_native_password BY <span class="s1">'123456'</span><span class="p">;</span>
<span class="c"># 刷新权限</span>
mysql&gt; flush privileges<span class="p">;</span>
<span class="c"># 退出</span>
mysql&gt; quit<span class="p">;</span>
</code></pre></div></div>

<p><strong>学习的基础数据导入</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">database</span> <span class="n">icoding_admin</span><span class="p">;</span>
<span class="n">use</span> <span class="n">icoding_admin</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="nv">`ad_role`</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`ad_role`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="nb">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`role_name`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`ad_role`</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span> <span class="nv">`role_name`</span><span class="p">)</span>
<span class="k">VALUES</span>
	<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">'vip1'</span><span class="p">),</span>
	<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">'vip2'</span><span class="p">),</span>
	<span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">'vip3'</span><span class="p">);</span>
	
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="nv">`ad_user`</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`ad_user`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="nb">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`username`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span><span class="p">,</span>
  <span class="nv">`password`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`ad_user`</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span> <span class="nv">`username`</span><span class="p">,</span> <span class="nv">`password`</span><span class="p">)</span>
<span class="k">VALUES</span>
	<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">'arry'</span><span class="p">,</span><span class="s1">'123456'</span><span class="p">),</span>
	<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">'gavin'</span><span class="p">,</span><span class="s1">'1234567'</span><span class="p">),</span>
	<span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">'coding'</span><span class="p">,</span><span class="s1">'123456'</span><span class="p">);</span>
	
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="nv">`ad_user_role`</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`ad_user_role`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="nb">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`user_id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`role_id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`ad_user_role`</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span> <span class="nv">`user_id`</span><span class="p">,</span> <span class="nv">`role_id`</span><span class="p">)</span>
<span class="k">VALUES</span>
	<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
	<span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
	<span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
	<span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
	<span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
	<span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="2基础知识回顾">2、基础知识回顾</h2>

<h3 id="sql语句">sql语句</h3>

<ul>
  <li>where条件解析顺序
    <ul>
      <li>
        <font color="red">MySQL：自左向右，所以考虑写sql语句时把筛选条件强的写在最左边，算是sql语句优化的第一步</font>
      </li>
      <li>Oralce：自右向左</li>
    </ul>
  </li>
  <li>SQL执行顺序
    <ul>
      <li>FROM</li>
      <li>ON</li>
      <li>JOIN</li>
      <li>WHERE</li>
      <li>GROUP BY</li>
      <li>HAVING</li>
      <li>SELECT</li>
      <li>DISTINCT 去重复</li>
      <li>ORDER BY</li>
      <li>LIMIT 限制返回结果条数</li>
    </ul>
  </li>
  <li>全文索引
    <ul>
      <li>
        <font color="red">只有在MyISAM的引擎才可以用</font>
        <p>，只能使用在CHAR、VARCHAR、TEXT字段使用使用，如like,not like</p>
      </li>
    </ul>
  </li>
  <li>MySQL中SQL执行的过程-MySQL 5.7
    <ul>
      <li>连接器</li>
      <li>查询缓存，注意8.0后把缓存去掉了</li>
      <li>分析器（词法分析（如select from等关键字是否正确）、语法分析（sql语句的前后逻辑是否正常，如group by不能写在select 后面））</li>
      <li>优化器（表的索引是否命中， 挑选最优化的索引，完成执行计划）</li>
      <li>执行器（开始执行sql语句查询数据 ，会判断客户端连接的用户是否查询表的权限 ）</li>
      <li>数据引擎（有查询权限，通过数据引擎查询数据 ）</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/images/2020/icoding/mysql/sql-execute-flow.png" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 声明使用查询缓存，但是不建议这样使用</span>
<span class="k">select </span>SQL_CACHE <span class="k">*</span> from ad_user<span class="p">;</span>
<span class="c"># 怎么保证数据一致性， 查询缓存失效是非常频繁的，查询缓存被清空：1.表结构变化，2.增加数据，3.修改数据 </span>
<span class="c"># mysql底层会监控commit事件和ddl,判断查询缓存是否应该被清空。 </span>
<span class="c"># 注意：</span>
	1、MySQL 8.0 把查询缓存这个模块去掉了，这说明查询缓存的作用不大
	2、判断用户查询权限是在执行器阶段开始的
	3、查询缓存会随着结果定期更新
<span class="c"># 核心三步</span>
- 分析
- 优化
- 执行 
</code></pre></div></div>

<h3 id="mysql体系结构">MySQL体系结构</h3>

<p>如下图</p>

<p><img src="\assets\images\2021\mysql\arch.jpg" alt="" /></p>

<ul>
  <li>Connectors 连接的客户端</li>
  <li>Connection Pool 连接池</li>
  <li>Management Service &amp; Utlities 管理服务和工具组件</li>
  <li>SQL Interface SQL接口组件</li>
  <li>Parser 查询分析组件</li>
  <li>Optimizer  SQL语句优化器组件</li>
  <li>Caches &amp; Buffers 缓冲组件</li>
  <li>Pluggable Storage Engines 插件式存储引擎</li>
  <li>Files &amp; Logs 物理文件（数据索引文件、日志文件）</li>
</ul>

<p>MySQL数据库区别于其他数据库的最重要的一个特点就是其插件式的表存储引擎。但是我们要注意一个最重要的，那就是存储引擎是基于表的，而不是数据库。</p>

<h3 id="mysql数据引擎">MySQL数据引擎</h3>

<p>存储引擎是MySQL区别于其他数据库的一个最重要特性</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 看MySQL支持的数据引擎8个</span>
mysql&gt; show engines<span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/mysql-engines.jpg" alt="" /></p>

<table>
  <thead>
    <tr>
      <th>存储引擎</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>MyISAM</td>
      <td>高速查询引擎，不支持事务，写入时对表加排他锁</td>
    </tr>
    <tr>
      <td><mark>InnoDB</mark></td>
      <td>v5.5以后是MySQL的默认引擎，写入时对行加排他锁，<mark>只有它支持事务</mark></td>
    </tr>
    <tr>
      <td>Archive</td>
      <td>数据压缩存储引擎，便于数据归档</td>
    </tr>
    <tr>
      <td>Memory</td>
      <td>内存存储引擎，只要断电了，数据就没了</td>
    </tr>
  </tbody>
</table>

<p>对比MyISAM和InnoDB</p>

<table>
  <thead>
    <tr>
      <th>对比</th>
      <th>InnoDB</th>
      <th>MyISAM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>存储文件的形式</td>
      <td>.frm表定义文件，.ibd存放数据和索引的</td>
      <td>.frm表定义文件，.myd数据文件，.myi索引文件</td>
    </tr>
    <tr>
      <td>锁</td>
      <td><mark>表、页、行</mark></td>
      <td><mark>表</mark></td>
    </tr>
    <tr>
      <td>事务</td>
      <td>支持</td>
      <td>不支持</td>
    </tr>
    <tr>
      <td>CRUD</td>
      <td>可同时读、写</td>
      <td>只可同时读，不可同时写</td>
    </tr>
    <tr>
      <td>全文索引</td>
      <td>不支持</td>
      <td>支持</td>
    </tr>
  </tbody>
</table>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查询表的引擎,一般客户端工具也可以查询，如navicat</span>
show table status like <span class="s1">'%ad_user%'</span> <span class="se">\G</span><span class="p">;</span>
<span class="c"># 创建表的时候可以选择数据引擎</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/table-engine.jpg" alt="" /></p>

<p><img src="\assets\images\2020\icoding\mysql\data-engine-innodb.jpg" alt="" /></p>

<p><img src="\assets\images\2020\icoding\mysql\data-engine-tokudb.jpg" alt="" /></p>

<p>MySQL的9种存储引擎都是各自是各自的特点，然后根据需求的不同，我们在建表的时候可以选择一下，</p>

<blockquote>
  <p>1.FEDERATED存储引擎</p>
</blockquote>

<p>这个引擎不是存放数据的引擎，而是一个指向远程MySQL数据库服务器的，那是什么意思呢，其实一句大白话：“我这里不存表结构文件和数据文件，我是在远程端存的”</p>

<p><img src="\assets\images\2021\mysql\federated.png" alt="" /></p>

<p>就像图上说的，FEDERATED存储引擎分成了2部分，一部分是本地服务，另外一部分就是远程服务，那么如果在你切换到这个引擎的时候，他在执行CRUD的时候，就会把执行操作的命令发到远程服务器，然后执行完了之后，在发回本地，然后从本地服务器中返回匹配的行即可。</p>

<blockquote>
  <p>2.InnoDB存储引擎</p>
</blockquote>

<p>v5.5以后是MySQL的默认引擎，唯一支持事务</p>

<ul>
  <li>支持事务。默认的事务隔离级别为可重复读</li>
  <li>支持外键，这个外键大家肯定也都清楚，有利有弊，毕竟外键的作用在那里放着(利：增加可读性，若出现宕机，最大限度的保证数据的一致性和完整性，弊：降低了表的查询速度，如果数据了过大，那么你插入数据库数据的时长可能是不增加外键的十倍)</li>
  <li>行锁设计，这样可以支持更高的并发，这也是为什么有时候面试官说你们上ES有点大材小用，因为MySQL自己也能处理那么多。</li>
  <li>使用多版本并发控制（MVCC）来获得高并发性，并且实现了SQL标准的4种隔离级别，默认为REPEATABLE READ级别（可重复读）。</li>
  <li>使用一种被称为next-key locking(有人称它为间隙锁)的策略来避免幻读（phantom）现象的产生</li>
  <li>数据存储采用了<mark>聚集（clustered）</mark>的方式，每张表的存储都是按主键的顺序进行存放。所以主键不要uuid导致数据无序，当插入新的行，会触发索引重排，消耗CPU性能。</li>
  <li>InnoDB的索引结构和MySQL其他的存储引擎不同，聚簇索引对主键查询性能非常高，这时候就得有个限制要求，如果表上的索引较多，主键就尽可能的小</li>
  <li>数据存储在表空间(tablespace)中，这个表空间实际上是由InnoDB管理的一个黑盒，由一系列的文件组成。</li>
</ul>

<p><img src="\assets\images\2021\mysql\innodb.png" alt="" /></p>

<p>我们从上面的图中能看到，InnoDB存储引擎有许多的内存块，可以认为这些内存块其实就相当于是一个大的内存池，就是线程池类似的那种，</p>

<p>InnoDB存储引擎是<mark>多线程</mark>的模型，因此其后台有多个不同的后台线程，负责处理不同的任务。可以把它分为4种线程</p>

<ul>
  <li>
    <p>核心线程Master Thread</p>

    <p>将缓冲池中的数据异步的刷新到磁盘上，来保证数据的一致性</p>
  </li>
  <li>
    <p>IO线程 IO Thread</p>

    <p>主要就是用来IO请求的回调处理，在做主从复制，从库会启动一个IO线程读取主库的binlog写入自己的relaylog,开启一条核心线程读取relaylog在自己数据库上重放操作</p>
  </li>
  <li>
    <p>净化线程Purge Thread</p>

    <p>主要作用就是事务提交之后回收已经使用并分配的undo页</p>
  </li>
  <li>
    <p>清理线程Page Cleaner Thread</p>

    <p>他的作用是将之前版本中脏页的刷新操作都放入到单独的线程中来完成</p>
  </li>
</ul>

<blockquote>
  <p>3、Memory 存储引擎</p>
</blockquote>

<p>Memory 存储引擎实际上就是将表中的数据存放在内存中，如果数据库重启或发生崩溃，表中的数据都将消失</p>

<ul>
  <li>
    <p>速度非常快，只支持表锁，并发性能较差</p>
  </li>
  <li>不支持TEXT和BLOB类型，对于字符串类型的数据，只支持固定长度的行，VARCHAR会被自动存储为CHAR类型</li>
  <li>存储变长字段（varchar）时是按照定常字段（char）的方式进行的，因此会浪费内存</li>
</ul>

<blockquote>
  <p>4、CSV 存储引擎</p>
</blockquote>

<p>CSV 存储引擎实际上操作的就是一个标准的CSV 文件，而且他的特点就是不支持索引，也就说，不支持索引，那么效率必然会很低，这个相信很多人都不会选择去使用它。</p>

<h3 id="mysql默认存储数据的位置">MySQL默认存储数据的位置</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /var/lib/mysql
<span class="c"># 这个目录下存放的是数据库对应的各个数据库的数据文件,直接把数据库文件icoding_admin备份到别的服务器，实现数据库冷备份/数据库迁移</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/icoding-admin.jpg" alt="" /></p>

<h3 id="mysql默认配置文件路径">MySQL默认配置文件路径</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>linux下Mysql启动时读取配置文件的顺序为
1./etc/my.cnf 
2./etc/mysql/my.cnf
3./usr/local/mysql/etc/my.cnf（自己安装mysql的目录）
4.~/my.cnf 

<span class="c"># 查找my.cnf文件</span>
<span class="nb">sudo </span>find / <span class="nt">-name</span> my.cnf
<span class="c">#第二种</span>
<span class="nb">sudo </span>mysql <span class="nt">--help</span> | <span class="nb">grep </span>my.cnf
</code></pre></div></div>

<blockquote>
  <p>总结：</p>
</blockquote>

<ul>
  <li>
    <p>MyISAM：默认的MySQL插件式存储引擎，它是在Web、数据仓储和其他应用环境下最常使用的存储引擎之一。注意，通过更改STORAGE_ENGINE配置变量，能够方便地更改MySQL服务器的默认存储引擎。</p>
  </li>
  <li>
    <p>InnoDB：用于事务处理应用程序，具有众多特性，包括ACID事务支持。(提供行级锁)</p>
  </li>
  <li>
    <p>BDB：可替代InnoDB的事务引擎，支持COMMIT、ROLLBACK和其他事务特性。</p>
  </li>
  <li>
    <p>Memory：将所有数据保存在RAM中，在需要快速查找引用和其他类似数据的环境下，可提供极快的访问。</p>
  </li>
  <li>
    <p>Merge：允许MySQL DBA或开发人员将一系列等同的MyISAM表以逻辑方式组合在一起，并作为1个对象引用它们。对于诸如数据仓储等VLDB环境十分适合。</p>
  </li>
  <li>
    <p>Archive：为大量很少引用的历史、归档、或安全审计信息的存储和检索提供了完美的解决方案。</p>
  </li>
  <li>
    <p><mark>Federated</mark>：能够将多个分离的MySQL服务器链接起来，从多个物理服务器创建一个逻辑数据库。十分适合于<mark>分布式环境</mark>或数据集市环境。</p>
  </li>
  <li>
    <p><mark>Cluster/NDB</mark>：MySQL的簇式数据库引擎，尤其适合于具有<mark>高性能查找要求的应用程序</mark>，这类查找需求还要求具有最高的正常工作时间和可用性。</p>
  </li>
  <li>
    <p>Other：其他存储引擎包括CSV（引用由逗号隔开的用作数据库表的文件），Blackhole（用于临时禁止对数据库的应用程序输入），以及Example引擎（可为快速创建定制的插件式存储引擎提供帮助）。</p>
  </li>
</ul>

<font color="red">一般来说不使用事务的话，请使用MyISAM引擎（mysql的一个默认数据库mysql就是使用MyISAM引擎的），使用事务的话，一般使用InnoDB</font>

<h2 id="3mysql内部的日志类型重点">3、MySQL内部的日志类型(重点)</h2>

<p>MySQL常用的日志有下面几个</p>

<h3 id="错误日志">错误日志</h3>

<p>查看mysql是否正常启动，<font color="red">默认路径/var/log/mysqld.log</font></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; show variables like <span class="s1">'%log_error%'</span><span class="p">;</span>
<span class="c"># mysql配置文件my.cnf配置如下，修改log_error的文件路径，错误级别</span>
<span class="nv">log_error</span><span class="o">=</span>/var/log/mysqld.log
<span class="nv">log_warnings</span><span class="o">=</span>2
<span class="c"># log_warnings= 0| 1| 2 </span>
<span class="c"># 0 关闭</span>
<span class="c"># 1 开启-default</span>
<span class="c"># &gt;1 大于1,失败的连接，拒绝访问的错误也会记录到log_error</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/log_warning.jpg" alt="" /></p>

<p><img src="/assets/images/2020/icoding/mysql/my-cnf.jpg" alt="" /></p>

<h3 id="查询日志">查询日志</h3>

<p>查询日志会将所有数据库的操作（ddl,dml）都会记录（general log 通用日志），<font color="red">消耗I/O，默认不开</font></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; show variables like <span class="s1">'%general_log%'</span><span class="p">;</span>
<span class="c"># mysql配置文件/etc/my.cnf配置</span>
<span class="nv">log_output</span><span class="o">=</span>FILE
FILE、TABLE、FILE,TABLE、NONE<span class="o">(</span>不输出<span class="o">)</span>
</code></pre></div></div>

<h3 id="慢查询日志">慢查询日志</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; show variables like <span class="s1">'%slow%'</span><span class="p">;</span>
</code></pre></div></div>

<p>Mysql默认是关闭慢查询日志的，也可以使用druid 作为数据库连接池的同时监控慢查询sql语句</p>

<p><img src="/assets/images/2020/icoding/mysql/slow-log.jpg" alt="" /></p>

<blockquote>
  <p>测试慢查询</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1、mysql配置文件/etc/my.cnf配置慢查询相关参数</span>
<span class="o">[</span>root@alibaba mysql]# vi /etc/my.cnf
<span class="nv">slow_query_log</span><span class="o">=</span>ON  <span class="c"># 开启</span>
<span class="nv">slow_launch_time</span><span class="o">=</span>3  
<span class="c"># slow_query_log_file=/usr/local/mysql/slow.log 慢sql语句日志文件，修改后要授权mysql用户</span>
<span class="c"># 修改/usr/local目录的拥有者是mysql用户</span>
<span class="o">[</span>root@alibaba mysql]# <span class="nb">chown</span> <span class="nt">-R</span> mysql:mysql /usr/local/mysql/slow.log
<span class="c"># 2、重启mysql</span>
<span class="o">[</span>root@alibaba mysql]# service mysqld restart
Redirecting to /bin/systemctl restart mysqld.service
<span class="c"># 3、tail -f 命令刷新查看慢sql日志文件</span>
<span class="c"># 4、慢查询sql语句</span>
mysql&gt; use icoding_admin<span class="p">;</span>
mysql&gt; <span class="k">select </span><span class="nb">sleep</span><span class="o">(</span>4<span class="o">)</span>,username from ad_user<span class="p">;</span> <span class="c"># 每条记录睡4秒</span>
</code></pre></div></div>

<p>3、直接查看慢查询日志</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba mysql]# <span class="nb">tail</span> <span class="nt">-f</span> <span class="nt">-n100</span> /var/lib/mysql/alibaba-slow.log 
/usr/sbin/mysqld, Version: 5.7.28-log <span class="o">(</span>MySQL Community Server <span class="o">(</span>GPL<span class="o">))</span><span class="nb">.</span> started with:
Tcp port: 0  Unix socket: /var/lib/mysql/mysql.sock
Time                 Id Command    Argument
<span class="c"># Time: 2020-06-19T08:38:17.726855Z</span>
<span class="c"># User@Host: root[root] @ localhost []  Id:     6</span>
<span class="c"># Query_time: 12.000825  Lock_time: 0.000176 Rows_sent: 3  Rows_examined: 3</span>
use icoding_admin<span class="p">;</span>
SET <span class="nv">timestamp</span><span class="o">=</span>1592555897<span class="p">;</span>
<span class="k">select </span><span class="nb">sleep</span><span class="o">(</span>4<span class="o">)</span>,username from ad_user<span class="p">;</span>
</code></pre></div></div>

<p>发现查询用了12秒，远远超过4秒，返回了3条记录，3*4=12秒。mysql的默认慢查询时间是10秒</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看sql语句慢查询时间</span>
mysql&gt; show variables like <span class="s1">'long_query_time'</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/long-query-time.jpg" alt="" /></p>

<blockquote>
  <p>mysqldumpslow 慢查询命令</p>
</blockquote>

<p>我们也可以使用mysql提供的慢查询命令mysqldumpslow来查看慢sql语句，更方便</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 帮助手册</span>
mysqldumpslow <span class="nt">--help</span>
<span class="c"># 根据时间降序</span>
mysqldumpslow <span class="nt">-s</span> <span class="nt">-t</span> /var/lib/mysql/alibaba-slow.log 
<span class="c"># 根据记录数降序</span>
mysqldumpslow <span class="nt">-s</span> <span class="nt">-r</span> /var/lib/mysql/alibaba-slow.log 
<span class="c"># 根据执行次数降序</span>
mysqldumpslow <span class="nt">-s</span> <span class="nt">-c</span> /var/lib/mysql/alibaba-slow.log 
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/mysql-dump-slow.jpg" alt="" /></p>

<p>Count:执行了多少次</p>

<h3 id="二进制日志binlog">二进制日志binlog</h3>

<p><mark>这个是数据库中最重要的日志，会记录所有DML，不会记录select</mark>,只记录数据的修改。trancate table属于ddl语句，不会被binlog记录。</p>

<h3 id="事务日志">事务日志</h3>

<h3 id="中继日志relay-log">中继日志relay log</h3>

<p>主从复制模式，从节点一定要配置relay log</p>

<h2 id="4mysql数据备份恢复">4、MySQL数据备份恢复</h2>

<h3 id="查询binlog是否开启">查询binlog是否开启</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c"># 默认关闭 </span>
 mysql&gt; show variables like <span class="s1">'log_bin'</span><span class="p">;</span>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| log_bin       | OFF   |
+---------------+-------+

<span class="c"># 查询mysql当前使用的binlog模式</span>
mysql&gt; show variables like <span class="s1">'%binlog_format%'</span><span class="p">;</span>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| binlog_format | ROW   |
+---------------+-------+

<span class="c"># 查询binlog单个文件的最大大小，默认是1g,文件达到1g，创建新的binlog文件</span>
mysql&gt; show variables like <span class="s1">'%max_binlog%'</span><span class="p">;</span>
| max_binlog_size      | 1073741824 

<span class="c"># 查看当前正在记录操作的日志log_bin文件名称</span>
mysql <span class="o">&gt;</span> show master status<span class="p">;</span>

<span class="c"># my.cnf开启binlog和binlog文件大小，一般设置500m,根据公司要求数据库情况自己调整</span>
<span class="c"># 开启binlog看下面的两种模式</span>
</code></pre></div></div>

<h3 id="binlog的statement模式">Binlog的statement模式</h3>

<blockquote>
  <p>statement（v5.6 及以下是statement模式）</p>
</blockquote>

<p>纯粹的记录DML的语句，<mark>记录sql语句本身</mark>，如：</p>

<p>update ad_user set username=’gavin.huang’ where id=1;</p>

<p>delete from ad_user where id=1;</p>

<p>如果你误删了数据，但你有不知道删除数据的内容是什么，你要恢复的话，statement模式下只能通过binlog跑一遍到删除前（你要知道删除的时间），那样你就知道被删除的数据是什么了，当然你不能在生产库上跑statement脚本，要到一个空数据库上跑。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 新建文件夹binlog</span>
<span class="o">[</span>root@alibaba <span class="nb">local</span><span class="o">]</span><span class="c"># mkdir binlog</span>
<span class="c"># 给mysql用户授权</span>
<span class="o">[</span>root@alibaba <span class="nb">local</span><span class="o">]</span><span class="c"># chown -R mysql:mysql /usr/local/binlog/</span>
<span class="c"># 修改mysql配置文件my.cnf，开启statement模式</span>
<span class="o">[</span>root@alibaba <span class="nb">local</span><span class="o">]</span><span class="c"># vi /etc/my.cnf </span>
<span class="o">[</span>mysqld]
server-id<span class="o">=</span>213   <span class="c"># mysql5.7版本一定要加server-id，5.6可不加</span>
<span class="nv">log_bin</span><span class="o">=</span>/usr/local/binlog/mysql-bin   <span class="c"># MySQL会自动生成一个mysql-bin-00001.log</span>
<span class="nv">binlog_format</span><span class="o">=</span>statement
<span class="c"># binlog日志切割的大小</span>
<span class="nv">max_binlog_size</span><span class="o">=</span>500m
<span class="c"># binlog过期清理时间,有效期3天</span>
<span class="nv">expire_logs_days</span><span class="o">=</span>3

<span class="c"># 重启mysql</span>
<span class="o">[</span>root@alibaba <span class="nb">local</span><span class="o">]</span><span class="c"># service mysqld restart</span>
</code></pre></div></div>

<p>binlog已开启</p>

<p><img src="/assets/images/2020/icoding/mysql/open-binlog.jpg" alt="" /></p>

<p>已创建binlog文件</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba binlog]# <span class="nb">ls
</span>mysql-bin.000001  mysql-bin.index
</code></pre></div></div>

<p>修改数据测试</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">update</span> <span class="n">ad_user</span> <span class="k">set</span> <span class="n">username</span> <span class="o">=</span> <span class="s1">'gavin_wang'</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">2</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">ad_user</span>  <span class="k">where</span> <span class="n">id</span> <span class="o">=</span><span class="mi">1</span> 
</code></pre></div></div>

<p>查看binlog日志，发现已经记录了修改的sql语句.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看</span>
mysql&gt; show binlog events <span class="k">in</span> <span class="s1">'mysql-bin.000001'</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/binlog-statement.jpg" alt="" /></p>

<p>小结：statement模式只会记录sql语句，不记录数据。</p>

<h3 id="binlog的row模式">Binlog的row模式</h3>

<blockquote>
  <p>row（v5.7版本默认是row模式）</p>
</blockquote>

<p>记录过去的历史值和现在的新值，<mark>记录数据的变化</mark></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 修改my.cnf 将statement模式修改为row模式</span>
<span class="o">[</span>root@alibaba binlog]# vi /etc/my.cnf
<span class="nv">binlog_format</span><span class="o">=</span>row
<span class="c"># 重启mysql</span>
<span class="o">[</span>root@alibaba binlog]# service mysqld restart

<span class="c"># 重启后发现多了个mysql-bin.000002文件，因为模式不同</span>
<span class="o">[</span>root@alibaba binlog]# <span class="nb">ls
</span>mysql-bin.000001  mysql-bin.000002  mysql-bin.index

<span class="c"># row模式的日志查询, -v 显示更新语句 -vv 显示更新语句+显示字段</span>
mysqlbinlog <span class="nt">--base64-output</span><span class="o">=</span>decode-rows <span class="nt">-vv</span> mysql-bin.000002
</code></pre></div></div>

<ul>
  <li><strong>删除数据测试</strong></li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>delete from ad_user where <span class="nb">id</span> <span class="o">=</span>3
</code></pre></div></div>

<p>通过mysql命令行查看，不明确</p>

<p><img src="/assets/images/2020/icoding/mysql/binlog-row-delete-show.jpg" alt="" /></p>

<p>通过mysqlbinlog命令查看binlog日志，发现已经记录了被删除的记录</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba binlog]# mysqlbinlog <span class="nt">--base64-output</span><span class="o">=</span>decode-rows <span class="nt">-vv</span> mysql-bin.000002
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/binlog-row.jpg" alt="" /></p>

<ul>
  <li><strong>修改数据测试</strong></li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">update</span> <span class="n">ad_user</span> <span class="k">set</span> <span class="n">username</span> <span class="o">=</span> <span class="s1">'gavin'</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">2</span>
</code></pre></div></div>

<p>再查看binlog日志</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba binlog]# mysqlbinlog <span class="nt">--base64-output</span><span class="o">=</span>decode-rows <span class="nt">-vv</span> mysql-bin.000002
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/binlog-row2.jpg" alt="" /></p>

<p>看到被修改的数据，恢复就方便多啦。</p>

<ul>
  <li><strong>truancate table测试</strong></li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">truncate</span> <span class="k">table</span> <span class="n">ad_user</span><span class="p">;</span>
</code></pre></div></div>

<p>再查看binlog日志</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba binlog]# mysqlbinlog <span class="nt">--base64-output</span><span class="o">=</span>decode-rows <span class="nt">-vv</span> mysql-bin.000002
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/binlog-row-truncate-table.jpg" alt="" /></p>

<p><strong>怎么快速找到误操作的语句</strong></p>

<p>row模式的定位，根据时间范围定位</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysqlbinlog <span class="nt">--base64-output</span><span class="o">=</span>decode-rows <span class="nt">--start-datetime</span><span class="o">=</span><span class="s1">'2020-06-19 22:00'</span> <span class="nt">--stop-datetime</span><span class="o">=</span><span class="s1">'2020-06-19 22:05'</span> <span class="nt">-vv</span> mysql-bin.000002
</code></pre></div></div>

<p>定位到了我们刚刚删除的记录</p>

<p><img src="/assets/images/2020/icoding/mysql/binlog-row-delete-find.jpg" alt="" /></p>

<p>mysqlbinlog也可以查询statement模式的数据，得到时间区间</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看帮助命令</span>
mysqlbinlog <span class="nt">--help</span>
</code></pre></div></div>

<p><strong>当前会话的所有操作不记录binlog日志</strong></p>

<p>如果进行大批量的数据操作，这个时候数据库是安全的，不让MySQL记录</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; <span class="nb">set </span><span class="nv">sql_log_bin</span><span class="o">=</span>0<span class="p">;</span> <span class="c">#临时关闭binlog</span>
</code></pre></div></div>

<p>测试</p>

<p><img src="/assets/images/2020/icoding/mysql/binlog-row-update-not-log.jpg" alt="" /></p>

<p>查看binlog日志</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba binlog]# mysqlbinlog <span class="nt">--base64-output</span><span class="o">=</span>decode-rows <span class="nt">-vv</span> mysql-bin.000002
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/binlog-row-update-not-log2.jpg" alt="" /></p>

<blockquote>
  <p>mixed 混合模式</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 混合模式</span>
statement：95%
</code></pre></div></div>

<h3 id="数据备份">数据备份</h3>

<blockquote>
  <p>备份的场景和分析</p>
</blockquote>

<ul>
  <li>全量备份</li>
  <li>差异备份，全量+周二是完整的，全量+周三是完整的</li>
</ul>

<p><img src="/assets/images/2020/icoding/mysql/backup-difference.png" alt="" /></p>

<ul>
  <li>增量备份，丢了一天的数据就不完整</li>
</ul>

<p><img src="/assets/images/2020/icoding/mysql/backup-increment.png" alt="" /></p>

<ul>
  <li>时间点备份</li>
</ul>

<blockquote>
  <p><strong>备份类型</strong></p>
</blockquote>

<ul>
  <li>热备：热备是不能通过简单的copy命令执行备份的，在备份的过程中mysql能读能写，比如使用mysqldump备份就是热备。</li>
  <li>温备：只能进行读操作，备份的过程中可以进行读操作，不能进行写操作，锁表就可以达到这种效果</li>
  <li>冷备：备份的过程中不能读也不能写</li>
  <li>物理备份：copy 数据库文件</li>
  <li>逻辑备份：把数据导出来的方式来备份数据，如导到另外一个数据库，或者mysqldump</li>
</ul>

<blockquote>
  <p><strong>常用备份工具</strong></p>
</blockquote>

<ul>
  <li>mysqldump</li>
  <li>Percona提供的xtrabackup，支持热备、温备多种备份方式</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看帮助命令</span>
mysqldump <span class="nt">--help</span>

<span class="c"># --master-data 0(不记录position) 1(记录position位置) 2(记录position位置并注释该条解析的语句)</span>
<span class="c"># routines 存储过程</span>
<span class="c"># triggers 触发器</span>
<span class="c"># events 事件</span>
<span class="c"># single-transaction 避免导出数据的过程中mysql卡顿 ，在开始备份前会对导出数据内容做镜像再导出，在导出的过程中，独立一个事务是隔离的，保证数据的一致性</span>
<span class="c"># --ignore-table=icoding_admin.ad_user_role --ignore-table=icoding_admin.ad_user  忽略多表</span>
<span class="c"># 基于innodb引擎 ，-p密码 -P端口</span>
<span class="c"># --flush-logs 刷新，生成新的binlog日志</span>
mysqldump <span class="nt">-uroot</span> <span class="nt">-p123456</span> <span class="nt">-h127</span>.0.0.1 <span class="nt">--master-data</span><span class="o">=</span>2 <span class="nt">--routines</span> <span class="nt">--triggers</span> <span class="nt">--events</span> <span class="nt">--single-transaction</span> <span class="nt">--databases</span> icoding_admin <span class="nt">--ignore-table</span><span class="o">=</span>icoding_admin.ad_user_role <span class="o">&gt;</span> mydb.sql
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/mysqldump.jpg" alt="" /></p>

<p>已经备份了数据库文件在当前目录下进入mysql命令行</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; show databases<span class="p">;</span>
+--------------------+
| Database           |
+--------------------+
| information_schema |
| icoding_admin      |
| mysql              |
| performance_schema |
| sys                |
+--------------------+

<span class="c"># 删除数据库</span>
mysql&gt; drop database icoding_admin<span class="p">;</span>
Query OK, 3 rows affected <span class="o">(</span>0.04 sec<span class="o">)</span>

<span class="c"># 查看</span>
mysql&gt; show databases<span class="p">;</span>
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+

<span class="c"># 恢复数据库</span>
mysql&gt; <span class="nb">source </span>mydb.sql<span class="p">;</span>

<span class="c"># 查看数据库,icoding_admin又回来啦</span>
mysql&gt; show databases<span class="p">;</span>
+--------------------+
| Database           |
+--------------------+
| information_schema |
| icoding_admin      |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
</code></pre></div></div>

<p><strong>为什么一定要加–single-transaction</strong></p>

<p>场景：有一个电商系统，小明有200积分，我们24 :00 点备份，假如积分表有200w数据，数据库有300张表，积分表是比较靠后才导出的（mysqldump是按表名字母顺序排序导出的 ），因为是热备所以能写能读，如果在导出的过程中，小明买了东西积分被提升为400，没有加–single-transaction 开启一个事务来隔离的话，那么24点备份的数据中小明的积分就变为400，而不是200，很明显这是错误的，因为积分400是24点后的数据，不是24点的数据。这就会造成备份的业务数据在某个时间点是不准确的。</p>

<p><strong>如果表的数据引擎是MyISAM不支持事务怎么办</strong>？</p>

<p>添加 –lock-tables 锁表把所有表锁了，能读不让写就可以了（温备），保证数据的一致性。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysqldump <span class="nt">-uroot</span> <span class="nt">-p123456</span> <span class="nt">-h127</span>.0.0.1 <span class="nt">--master-data</span><span class="o">=</span>2 <span class="nt">--routines</span> <span class="nt">--triggers</span> <span class="nt">--events</span> <span class="nt">--lock-tables</span> <span class="nt">--databases</span> icoding_admin <span class="nt">--ignore-table</span><span class="o">=</span>icoding_admin.ad_user_role <span class="o">&gt;</span> mydb.sql
</code></pre></div></div>

<h3 id="crontab定时任务">crontab定时任务</h3>

<p><strong>cron介绍</strong></p>

<p>我们经常使用的是crontab命令是cron table的简写，它是cron的配置文件，也可以叫它作业列表，我们可以在以下文件夹内找到相关配置文件。</p>

<ul>
  <li>/var/spool/cron/ 目录下存放的是每个用户包括root的crontab任务，每个任务以创建者的名字命名</li>
  <li>/etc/crontab 这个文件负责调度各种管理和维护任务。</li>
  <li>/etc/cron.d/ 这个目录用来存放任何要执行的crontab文件或脚本。</li>
  <li>我们还可以把脚本放在/etc/cron.hourly、/etc/cron.daily、/etc/cron.weekly、/etc/cron.monthly目录中，让它每小时/天/星期、月执行一次。</li>
</ul>

<p><strong>crontab的使用</strong></p>

<p>我们常用的命令如下：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba binlog]# crontab <span class="nt">--help</span>
crontab <span class="o">[</span><span class="nt">-u</span> username]　　　　//省略用户表表示操作当前用户的crontab
    <span class="nt">-e</span>      <span class="o">(</span>编辑工作表<span class="o">)</span>
    <span class="nt">-l</span>      <span class="o">(</span>列出工作表里的命令<span class="o">)</span>
    <span class="nt">-r</span>      <span class="o">(</span>删除工作表<span class="o">)</span>
</code></pre></div></div>

<p>我们用<strong>crontab -e</strong>进入当前用户的工作表编辑，是常见的vim界面。每行是一条命令。</p>

<p>crontab的命令构成为 时间+动作，其时间有<strong>分、时、日、月、周</strong>五种，操作符有</p>

<ul>
  <li>***** 取值范围内的所有数字</li>
  <li><strong>/</strong> 每过多少个数字</li>
  <li><strong>-</strong> 从X到Z</li>
  <li><strong>，</strong>散列数字</li>
</ul>

<p><strong>实例</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 每1分钟执行一次myCommand</span>
<span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> myCommand

<span class="c"># 每小时的第3和第15分钟执行</span>
3,15 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> myCommand

<span class="c"># 在上午8点到11点的第3和第15分钟执行</span>
3,15 8-11 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> myCommand

<span class="c"># 每隔两天的上午8点到11点的第3和第15分钟执行</span>
3,15 8-11 <span class="k">*</span>/2  <span class="k">*</span>  <span class="k">*</span> myCommand

<span class="c"># 每周一上午8点到11点的第3和第15分钟执行</span>
3,15 8-11 <span class="k">*</span> <span class="k">*</span> 1 myCommand

<span class="c"># 每晚的21:30重启smb</span>
30 21 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /etc/init.d/smb restart

<span class="c"># 每月1、10、22日的4 : 45重启smb</span>
45 4 1,10,22 <span class="k">*</span> <span class="k">*</span> /etc/init.d/smb restart

<span class="c"># 每周六、周日的1 : 10重启smb</span>
10 1 <span class="k">*</span> <span class="k">*</span> 6,0 /etc/init.d/smb restart

<span class="c"># 每天18 : 00至23 : 00之间每隔30分钟重启smb</span>
0,30 18-23 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /etc/init.d/smb restart

<span class="c"># 每星期六的晚上11 : 00 pm重启smb</span>
0 23 <span class="k">*</span> <span class="k">*</span> 6 /etc/init.d/smb restart

<span class="c"># 每一小时重启smb</span>
<span class="k">*</span> <span class="k">*</span>/1 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /etc/init.d/smb restart

<span class="c"># 晚上11点到早上7点之间，每隔一小时重启smb</span>
<span class="k">*</span> 23-7/1 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /etc/init.d/smb restart
</code></pre></div></div>

<h3 id="数据恢复">数据恢复</h3>

<p>备份如何设计</p>

<ul>
  <li>
    <p>全量备份的方式</p>

    <p>使用crontab结合mysqldump来做定时备份</p>
  </li>
  <li>
    <p>增量时间点补偿</p>

    <ul>
      <li>如何补偿</li>
      <li>考虑修改的变化：update、delete</li>
      <li>借助我们的binlog</li>
    </ul>
  </li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1、先做全量备份,可以定时处理</span>
<span class="c"># 编写备份的脚本</span>
<span class="o">[</span>root@alibaba binlog]# vim icoding_admin_bak.sh
<span class="nv">backupdir</span><span class="o">=</span>/usr/local/binlog/bak
<span class="nb">time</span><span class="o">=</span><span class="sb">`</span> <span class="nb">date</span> +%Y%m%d%H%M <span class="sb">`</span>
<span class="c"># --master-data=2 记录position位置</span>
mysqldump <span class="nt">-uroot</span> <span class="nt">-p123456</span> <span class="nt">-h127</span>.0.0.1 <span class="nt">--master-data</span><span class="o">=</span>2 <span class="nt">--single-transaction</span> <span class="nt">--databases</span> icoding_admin  <span class="o">&gt;</span> <span class="nv">$backupdir</span>/icoding_admin_bak_<span class="nv">$time</span>.sql
<span class="c"># 删除过期的备份，这里是超过6天</span>
find <span class="nv">$backupdir</span> <span class="nt">-name</span> <span class="s2">"icoding_admin_bak_*.sql"</span> <span class="nt">-type</span> f <span class="nt">-mtime</span> +6 <span class="nt">-exec</span> <span class="nb">rm</span> <span class="o">{}</span> <span class="se">\;</span> <span class="o">&gt;</span> /dev/null 2&gt;&amp;1

<span class="c"># crontab添加定时执行脚本的任务</span>
<span class="o">[</span>root@alibaba binlog]# crontab <span class="nt">-e</span>
13 14 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> sh /usr/local/binlog/icoding_admin_bak.sh
</code></pre></div></div>

<p>看到脚本已经定时备份了</p>

<p><img src="/assets/images/2020/icoding/mysql/mysqldump-crontab.jpg" alt="" /></p>

<p>binlog日志我已开启row模式，备份完后修改数据</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c"># 添加一条数据</span>
 insert into ad_user VALUES<span class="o">(</span>4,<span class="s1">'allen'</span>,<span class="s1">'1234567'</span><span class="o">)</span>
</code></pre></div></div>

<p>删除数据库，模拟恢复数据</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; drop database icoding_admin<span class="p">;</span>  
Query OK, 3 rows affected <span class="o">(</span>0.03 sec<span class="o">)</span>
</code></pre></div></div>

<p>我们的全量备份并没有记录新增的allen老师的记录，所以要结合binlog一起恢复数据</p>

<p>查看全量备份文件，发现它备份的数据库记录位置是 6246，对应binlog的</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba bak]# <span class="nb">cat </span>icoding_admin_bak_202006211413.sql 
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/master-log-pos.jpg" alt="" /></p>

<p>查看binlog ，我们应该从6246的下一个位置6311到6542作为增量恢复的数据，恢复要看增量的数据大小</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; show binlog events <span class="k">in</span> <span class="s1">'mysql-bin.000002'</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/show-event-in-binlog.jpg" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 2、开启binlong，statement/row/mixed三种模式，默认使用row模式</span>
<span class="c"># 全量恢复数据，也可考虑是否binlog</span>
mysql&gt; <span class="nb">source </span>icoding_admin_bak_202006211413.sql.sql
<span class="c"># 对binlog做数据导出</span>
<span class="c"># 场景1:如果数据量小，比如关键的某一条数据，row模式下可以直接手工处理，row模式可以看被修改删除的数据，直接自己拿出来重新写回</span>
mysqlbinlog <span class="nt">--base64-output</span><span class="o">=</span>decode-rows <span class="nt">--start-position</span><span class="o">=</span>6311 <span class="nt">--stop-position</span><span class="o">=</span>6542  <span class="nt">-vv</span> mysql-bin.000002

<span class="c"># 场景2:数据量特别大，需要导出进行处理</span>
mysqlbinlog <span class="nt">--start-position</span><span class="o">=</span>6311 <span class="nt">--stop-position</span><span class="o">=</span>6542 mysql-bin.000002 <span class="o">&gt;</span> ist.sql

<span class="c"># 3、增量数据的恢复根据需要把当前会话binlog记录关掉，避免记录没必要的操作，提高恢复效率</span>
mysql&gt; <span class="nb">set </span><span class="nv">sql_log_bin</span><span class="o">=</span>0<span class="p">;</span>
mysql&gt; <span class="nb">source </span>ist.sql
</code></pre></div></div>

<p>好了，现在知道了增量恢复的位置，使用全量备份+增量备份恢复数据</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 导出增量备份的数据</span>
<span class="o">[</span>root@alibaba binlog]# mysqlbinlog <span class="nt">--start-position</span><span class="o">=</span>6311 <span class="nt">--stop-position</span><span class="o">=</span>6542 mysql-bin.000002 <span class="o">&gt;</span> bak/ist.sql
<span class="o">[</span>root@alibaba binlog]# <span class="nb">cd </span>bak
<span class="o">[</span>root@alibaba bak]# <span class="nb">ls
</span>icoding_admin_bak_202006211413.sql  ist.sql
<span class="c"># 进入mysql命令行模式恢复数据</span>
mysql&gt; <span class="nb">source </span>icoding_admin_bak_202006211413.sql
<span class="c"># 全量备份恢复完毕查看数据 </span>
mysql&gt; use icoding_admin<span class="p">;</span>
Database changed
mysql&gt; <span class="k">select</span> <span class="k">*</span> from ad_user<span class="p">;</span>
+----+------------+----------+
| <span class="nb">id</span> | username   | password |
+----+------------+----------+
|  1 | arry       | 1234567  |
|  2 | gavin      | 1234567  |
|  3 | coding_qin | 1234567  |
+----+------------+----------+
<span class="c"># 增量恢复，不记录binlog</span>
mysql&gt; <span class="nb">set </span><span class="nv">sql_log_bin</span><span class="o">=</span>0<span class="p">;</span>
mysql&gt; <span class="nb">source </span>ist.sql
<span class="c"># 增量备份恢复完毕查看数据，allen老师也恢复了</span>
mysql&gt; <span class="k">select</span> <span class="k">*</span> from ad_user<span class="p">;</span>
+----+------------+----------+
| <span class="nb">id</span> | username   | password |
+----+------------+----------+
|  1 | arry       | 1234567  |
|  2 | gavin      | 1234567  |
|  3 | coding_qin | 1234567  |
|  4 | allen      | 1234567  |
+----+------------+----------+
<span class="c"># 恢复完成</span>
mysql&gt; <span class="nb">exit</span><span class="p">;</span>
Bye
</code></pre></div></div>

<p>全量恢复的时候，当前会话是并没有关闭binlog的，也就是说恢复的操作也会被binlog记录（整体来说记录了重复的dml,ddl操作），所以可以考虑恢复前把当前会话的binlog先关闭。</p>

<p><img src="/assets/images/2020/icoding/mysql/binlog2.jpg" alt="" /></p>

<p>可以看出，binlog的数据库位置已发生变化。</p>

<p>总结：<strong>数据一定要定时全量备份，开启binlog</strong></p>

<h3 id="作业全量备份增量备份">作业：全量备份+增量备份</h3>

<p>参考博客:<a href="https://www.jianshu.com/p/d3f77f7da512">https://www.jianshu.com/p/d3f77f7da512</a></p>

<blockquote>
  <p>全量备份</p>
</blockquote>

<p>步骤流程：</p>

<ul>
  <li>先创建相应目录</li>
  <li>使用mysqldump进行全量备份</li>
  <li>对备份文件进行压缩</li>
  <li>使用scp复制备份文件到其他服务器</li>
  <li>清理过期的全量备份文件</li>
  <li>定时任务自动进行全量备份</li>
</ul>

<p>备份命令</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># --quick : 该选项在导出大表时很有用，它强制 mysqldump 从服务器查询取得记录直接输出而不是取得所有记录后将它们缓存到内存中。</span>
<span class="c"># --all-databases 备份所有数据库</span>
<span class="c"># --databases 指定备份的数据库</span>
<span class="c"># --flush-logs 生成新的二进制日志</span>
<span class="c"># --delete-master-logs </span>
<span class="c"># --single-transaction 单事务，为了确保数据的一致性，为了确保使用--single-transaction命令时，保证dump文件的有效性。需没有下列语句ALTER TABLE, CREATE TABLE, DROP TABLE, RENAME TABLE, TRUNCATE TABLE，因为一致性读不能隔离上述语句。所以如果在dump过程中，使用上述语句，可能会导致dump出来的文件数据不一致或者不可用。</span>
mysqldump <span class="nt">-uroot</span> <span class="nt">-p123456</span> <span class="nt">--quick</span> <span class="nt">--events</span> <span class="nt">--all-databases</span> <span class="nt">--flush-logs</span> <span class="nt">--delete-master-logs</span> <span class="nt">--single-transaction</span> <span class="o">&gt;</span> data.sql
</code></pre></div></div>

<p>全量备份脚本</p>

<p>mysqlFullBack.sh</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 初始化时，创建相应目录</span>
<span class="c"># mkdir -p /home/mysql/backup/daily </span>

<span class="c"># 定时任务</span>
<span class="c"># 每个星期日凌晨3:00执行全量备份脚本 </span>
<span class="c"># 0 3 * * 0 /bin/bash -x /root/mysqlFullBack.sh &gt;/dev/null 2&gt;&amp;1</span>
<span class="c"># 周一到周六凌晨3:00执行增量备份脚本</span>
<span class="c"># 0 3 * * 1-6 /bin/bash -x /root/mysqlPartBack.sh &gt;/dev/null 2&gt;&amp;1</span>

<span class="nv">BakDir</span><span class="o">=</span>/home/mysql/backup
<span class="nv">LogFile</span><span class="o">=</span>/home/mysql/backup/bak.log
<span class="nv">Date</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +%Y%m%d<span class="sb">`</span>
<span class="nv">Begin</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +<span class="s2">"%Y年%m月%d日 %H:%M:%S"</span><span class="sb">`</span>
<span class="nb">cd</span> <span class="nv">$BakDir</span>
<span class="nv">DumpFile</span><span class="o">=</span><span class="nv">$Date</span>.sql
<span class="nv">GZDumpFile</span><span class="o">=</span><span class="nv">$Date</span>.sql.tgz
mysqldump <span class="nt">-uroot</span> <span class="nt">-p123456</span> <span class="nt">--quick</span> <span class="nt">--events</span> <span class="nt">--all-databases</span> <span class="nt">--flush-logs</span> <span class="nt">--delete-master-logs</span> <span class="nt">--single-transaction</span> <span class="o">&gt;</span> <span class="nv">$DumpFile</span>
/bin/tar <span class="nt">-zvcf</span> <span class="nv">$GZDumpFile</span> <span class="nv">$DumpFile</span>
/bin/rm <span class="nv">$DumpFile</span>
<span class="nv">Last</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +<span class="s2">"%Y年%m月%d日 %H:%M:%S"</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="o">[</span>FullBack] 开始:<span class="nv">$Begin</span> 结束:<span class="nv">$Last</span> <span class="nv">$GZDumpFile</span> successful <span class="o">&gt;&gt;</span> <span class="nv">$LogFile</span>
<span class="c"># scp重复全量备份文件到其他服务器</span>
<span class="c"># scp $GZDumpFile root@xxxx:/usr/mysql/backup/$GZDumpFile</span>
<span class="c"># 删除30天前的全量备份文件</span>
find <span class="nv">$BakDir</span> <span class="nt">-mtime</span> +30 <span class="nt">-type</span> f <span class="nt">-name</span> <span class="s2">"*.sql.tgz"</span> | xargs <span class="nb">rm</span> <span class="nt">-f</span>
<span class="c"># 删除增量备份文件</span>
<span class="nb">cd</span> <span class="nv">$BakDir</span>/daily
/bin/rm <span class="nt">-f</span> <span class="k">*</span>
</code></pre></div></div>

<p>恢复全量备份数据</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="o">&gt;</span> <span class="nb">source</span> /home/data.sql<span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>增量备份</p>
</blockquote>

<p>步骤流程</p>

<ul>
  <li>刷新日志</li>
  <li>遍历日志索引文件</li>
  <li>备份新日志文件，忽略已经备份的文件</li>
</ul>

<p>增量备份命令</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在/var/lib/mysql下或/var/lib/mysql/mysql-bin下可查看到增量备份日志</span>
mysqladmin <span class="nt">-uroot</span> <span class="nt">-p123456</span> flush-logs
</code></pre></div></div>

<p>增量备份脚本</p>

<p>mysqlPartBack.sh</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#在使用之前，请提前创建以下各个目录</span>
<span class="nv">backupDir</span><span class="o">=</span>/home/mysql/backup/daily
<span class="c">#增量备份时复制mysql-bin.00000*的目标目录，提前手动创建这个目录</span>
<span class="nv">mysqlDir</span><span class="o">=</span>/var/lib/mysql
<span class="c">#mysql的数据目录</span>
<span class="nv">logFile</span><span class="o">=</span>/home/mysql/backup/bak.log
<span class="nv">BinFile</span><span class="o">=</span>/var/lib/mysql/binlog.index
<span class="c">#mysql的index文件路径，放在数据目录下的</span>

mysqladmin <span class="nt">-uroot</span> <span class="nt">-p123456</span> flush-logs
<span class="c">#这个是用于产生新的mysql-bin.00000*文件</span>
<span class="c"># wc -l 统计行数</span>
<span class="c"># awk 简单来说awk就是把文件逐行的读入，以空格为默认分隔符将每行切片，切开的部分再进行各种分析处理。</span>
<span class="nv">Counter</span><span class="o">=</span><span class="sb">`</span><span class="nb">wc</span> <span class="nt">-l</span> <span class="nv">$BinFile</span> |awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="nv">NextNum</span><span class="o">=</span>0
<span class="c">#这个for循环用于比对$Counter,$NextNum这两个值来确定文件是不是存在或最新的</span>
<span class="k">for </span>file <span class="k">in</span> <span class="sb">`</span><span class="nb">cat</span> <span class="nv">$BinFile</span><span class="sb">`</span>
<span class="k">do
    </span><span class="nv">base</span><span class="o">=</span><span class="sb">`</span><span class="nb">basename</span> <span class="nv">$file</span><span class="sb">`</span>
    <span class="nb">echo</span> <span class="nv">$base</span>
    <span class="c">#basename用于截取mysql-bin.00000*文件名，去掉./mysql-bin.000005前面的./</span>
    <span class="nv">NextNum</span><span class="o">=</span><span class="sb">`</span><span class="nb">expr</span> <span class="nv">$NextNum</span> + 1<span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$NextNum</span> <span class="nt">-eq</span> <span class="nv">$Counter</span> <span class="o">]</span>
    <span class="k">then
        </span><span class="nb">echo</span> <span class="nv">$base</span> skip! <span class="o">&gt;&gt;</span> <span class="nv">$logFile</span>
    <span class="k">else
        </span><span class="nv">dest</span><span class="o">=</span><span class="nv">$backupDir</span>/<span class="nv">$base</span>
        <span class="k">if</span><span class="o">(</span><span class="nb">test</span> <span class="nt">-e</span> <span class="nv">$dest</span><span class="o">)</span>
        <span class="c">#test -e用于检测目标文件是否存在，存在就写exist!到$logFile去</span>
        <span class="k">then
            </span><span class="nb">echo</span> <span class="nv">$base</span> exist! <span class="o">&gt;&gt;</span> <span class="nv">$logFile</span>
        <span class="k">else
            </span><span class="nb">cp</span> <span class="nv">$mysqlDir</span>/<span class="nv">$base</span> <span class="nv">$backupDir</span>
            <span class="nb">echo</span> <span class="nv">$base</span> copying <span class="o">&gt;&gt;</span> <span class="nv">$logFile</span>
         <span class="k">fi
     fi
done
</span><span class="nb">echo</span> <span class="o">[</span>PartBack] <span class="sb">`</span><span class="nb">date</span> +<span class="s2">"%Y年%m月%d日 %H:%M:%S"</span><span class="sb">`</span> <span class="nv">$Next</span> Bakup successful! <span class="o">&gt;&gt;</span> <span class="nv">$logFile</span>
</code></pre></div></div>

<p>恢复增量备份数据</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysqlbinlog /home/mysql/backup/daily/binlog.000008 | mysql <span class="nt">-uroot</span> <span class="nt">-p123456</span><span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>Crontab定时任务</p>
</blockquote>

<p>每个星期日凌晨3:00执行全量备份脚本</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 3 <span class="k">*</span> <span class="k">*</span> 0 /bin/bash <span class="nt">-x</span> /root/mysqlFullBack.sh <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
</code></pre></div></div>

<p>周一到周六凌晨3:00执行增量备份脚本</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 3 <span class="k">*</span> <span class="k">*</span> 1-6 /bin/bash <span class="nt">-x</span> /root/mysqlPartBack.sh <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
</code></pre></div></div>

<p><strong>常见问题</strong></p>

<p>当通过linux定时任务crontab去执行备份脚本时，你会发现全量备份后的sql文件是个空文件。然而，你手动执行命令却是正常的。</p>

<p>原因：mysqldump命令在crontab执行环境中并不存在，要使用绝对路径，才能执行此命令。
 查看mysqldump所在位置</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba ~]# which mysqldump
/usr/bin/mysqldump
</code></pre></div></div>

<p>然后把全量备份脚本中的<code class="highlighter-rouge">mysqldump</code>替换为<code class="highlighter-rouge">/usr/bin/mysqldump</code></p>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-edu/2020/06/17/icoding-note-048.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
