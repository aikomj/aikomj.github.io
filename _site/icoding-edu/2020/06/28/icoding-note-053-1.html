<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 飞天班第53节：数据切分设计方案Sharding-jdbc - 大伟的博客 </title>
    <meta name="keywords" content="mysql">
    <meta name="description"
          content="客户端代理模式数据源连接管理应用Sharingjdbc,引入使用，配置广播表，绑定表，读写分离，整合druid连接池的注意点，java类配置分库分表策略，整合dynamic多数据源依赖">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-edu/2020/06/28/icoding-note-053-1.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="飞天班第53节：数据切分设计方案Sharding-jdbc">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>飞天班第53节：数据切分设计方案Sharding-jdbc</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/06/28
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1-sharding-jdbc介绍">1. Sharding-Jdbc介绍</h2>

<p>官方文档：<a href="https://shardingsphere.apache.org/">https://shardingsphere.apache.org/</a></p>

<p><img src="/assets/images/2020/icoding/mysql/sharding-sphere.jpg" alt="" /></p>

<p>sharingSphere 包括，使用时一定要多看看用户手册</p>

<p><img src="/assets/images/2020/icoding/mysql/sharding-sphere2.jpg" alt="" /></p>

<p>Sharding-JDBC是ShardingSphere的第一个产品，也是ShardingSphere的前身。</p>

<ul>
  <li>sharding-jdbc是一个分布式的关系型数据库中间件</li>
  <li>
    <font color="red">客户端代理模式，不需要搭建服务器，只需要后端数据库即可，有个IDE就行了</font>
  </li>
  <li>定位于轻量级的Java框架，以jar的方式提供服务</li>
  <li>可以理解为增强版的jdbc驱动</li>
  <li>完全兼容主流的ORM框架，如Mybatis-plus</li>
  <li>架构：</li>
</ul>

<p><img src="/assets/images/2020/icoding/mysql/sharding-jdbc.jpg" alt="" /></p>

<ul>
  <li>sharding-jdbc提供了4种配置
    <ul>
      <li>Java API</li>
      <li>yaml (层级深)</li>
      <li>properties</li>
      <li>spring命名空间</li>
    </ul>
  </li>
  <li><strong>与MyCat的区别</strong>
    <ul>
      <li>
        <font color="red">MyCat是服务端的代理模式，Sharding-Jdbc是客户端代理模式</font>
      </li>
      <li>实际开发中如果企业有DBA建议使用MyCat，都是开发人员建议使用sharding-jdbc</li>
      <li>MyCat不支持在一个库内进行水平分表，而sharding-jdbc支持在同一个数据库中进行水平分表</li>
    </ul>
  </li>
  <li>名词解释
    <ul>
      <li>逻辑表：物理表的合并表</li>
      <li>真实表：存放数据的地方</li>
      <li>数据节点：存储数据的MySQL节点</li>
      <li>绑定表：相当于MyCat中的子表</li>
      <li>广播表：相当于MyCat中的全局表</li>
    </ul>
  </li>
</ul>

<h2 id="2-sharding-jdbc引入使用">2. Sharding-Jdbc引入使用</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 0.首先在两个MySQL实例上分别创建数据库：shard_order</span>
<span class="c"># 1.在两个数据库创建两个表order_info_1,order_info_2</span>
CREATE TABLE <span class="sb">`</span>order_info_1<span class="sb">`</span> <span class="o">(</span>
  <span class="sb">`</span><span class="nb">id</span><span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> NOT NULL,
  <span class="sb">`</span>order_amount<span class="sb">`</span> decimal<span class="o">(</span>10,2<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>order_status<span class="sb">`</span> int<span class="o">(</span>255<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>user_id<span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> DEFAULT NULL,
  PRIMARY KEY <span class="o">(</span><span class="sb">`</span><span class="nb">id</span><span class="sb">`</span><span class="o">)</span>
<span class="o">)</span> <span class="nv">ENGINE</span><span class="o">=</span>InnoDB DEFAULT <span class="nv">CHARSET</span><span class="o">=</span>utf8<span class="p">;</span>
CREATE TABLE <span class="sb">`</span>order_info_2<span class="sb">`</span> <span class="o">(</span>
  <span class="sb">`</span><span class="nb">id</span><span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> NOT NULL,
  <span class="sb">`</span>order_amount<span class="sb">`</span> decimal<span class="o">(</span>10,2<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>order_status<span class="sb">`</span> int<span class="o">(</span>255<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>user_id<span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> DEFAULT NULL,
  PRIMARY KEY <span class="o">(</span><span class="sb">`</span><span class="nb">id</span><span class="sb">`</span><span class="o">)</span>
<span class="o">)</span> <span class="nv">ENGINE</span><span class="o">=</span>InnoDB DEFAULT <span class="nv">CHARSET</span><span class="o">=</span>utf8<span class="p">;</span>
<span class="c"># 2.切分规则，按照id的奇偶数切分到两个数据库，在自己的数据库按照user_id进行表切分</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/shard-order.jpg" alt="" /></p>

<p>新建一个SpringBoot项目</p>

<p>代码导入POM依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.shardingsphere<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>sharding-jdbc-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>4.0.0-RC2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>applicaiton.properties配置</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 给两个数据源命名</span>
spring.shardingsphere.datasource.names<span class="o">=</span>ds0,ds1
<span class="c"># 数据源链接ds0要和命名一致</span>
spring.shardingsphere.datasource.ds0.type<span class="o">=</span>com.zaxxer.hikari.HikariDataSource
spring.shardingsphere.datasource.ds0.driver-class-name<span class="o">=</span>com.mysql.jdbc.Driver
spring.shardingsphere.datasource.ds0.jdbcUrl<span class="o">=</span>jdbc:mysql://39.103.163.215:3306/shard_order
spring.shardingsphere.datasource.ds0.username<span class="o">=</span>gavin
spring.shardingsphere.datasource.ds0.password<span class="o">=</span>123456
<span class="c"># 数据源链接ds1要和命名一致</span>
spring.shardingsphere.datasource.ds1.type<span class="o">=</span>com.zaxxer.hikari.HikariDataSource
spring.shardingsphere.datasource.ds1.driver-class-name<span class="o">=</span>com.mysql.jdbc.Driver
spring.shardingsphere.datasource.ds1.jdbcUrl<span class="o">=</span>jdbc:mysql://39.101.221.95:3306/shard_order
spring.shardingsphere.datasource.ds1.username<span class="o">=</span>gavin
spring.shardingsphere.datasource.ds1.password<span class="o">=</span>123456
<span class="c"># 具体的分片规则,基于数据节点</span>
spring.shardingsphere.sharding.tables.order_info.actual-data-nodes<span class="o">=</span>ds<span class="nv">$-</span><span class="o">&gt;{</span>0..1<span class="o">}</span>.order_info_<span class="nv">$-</span><span class="o">&gt;{</span>1..2<span class="o">}</span>
<span class="c"># 分库的规则</span>
spring.shardingsphere.sharding.tables.order_info.database-strategy.inline.sharding-column<span class="o">=</span><span class="nb">id
</span>spring.shardingsphere.sharding.tables.order_info.database-strategy.inline.algorithm-expression<span class="o">=</span>ds<span class="nv">$-</span><span class="o">&gt;{</span><span class="nb">id</span> % 2<span class="o">}</span>
<span class="c"># 分表的规则</span>
spring.shardingsphere.sharding.tables.order_info.table-strategy.inline.sharding-column<span class="o">=</span>user_id
spring.shardingsphere.sharding.tables.order_info.table-strategy.inline.algorithm-expression<span class="o">=</span>order_info_<span class="nv">$-</span><span class="o">&gt;{</span>user_id % 2 + 1<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 使用jdbcTemplate 测试代码</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">class</span> <span class="nc">ShardingjdbcProjectApplicationTests</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">insertTest</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into order_info(id,order_amount,order_status,user_id) values(3,213.88,1,2)"</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"影响行数:"</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>结合 mybatis-plus  ORM 框架 测试代码</p>

<blockquote>
  <p>插入数据</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="nc">OrderInfoService</span> <span class="n">orderInfoService</span><span class="o">;</span>

<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderInfo</span><span class="o">();</span>
		<span class="n">orderInfo</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="na">setOrderAmount</span><span class="o">(</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">300</span><span class="o">)).</span><span class="na">setOrderStatus</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">setUserId</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
		<span class="n">orderInfoService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">);</span>

		<span class="nc">OrderInfo</span> <span class="n">orderInfo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderInfo</span><span class="o">();</span>
		<span class="n">orderInfo2</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="na">setOrderAmount</span><span class="o">(</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">213</span><span class="o">)).</span><span class="na">setOrderStatus</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">setUserId</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
		<span class="n">orderInfoService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">orderInfo2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>报错，一个坑,</p>

<p><img src="/assets/images/2020/icoding/mysql/shardingDataSource-jdbc.jpg" alt="" /></p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.shardingsphere.datasource.ds0.url</span><span class="p">=</span><span class="s">jdbc:mysql://39.103.163.215:3306/shard_order</span>
<span class="c"># 修改为：
</span><span class="py">spring.shardingsphere.datasource.ds0.jdbcUrl</span><span class="p">=</span><span class="s">jdbc:mysql://39.103.163.215:3306/shard_order</span>
</code></pre></div></div>

<p>运行成功后，发现两张订单表已分库分表</p>

<p><img src="/assets/images/2020/icoding/mysql/sharding-jdbc-213.jpg" alt="" /></p>

<p><img src="/assets/images/2020/icoding/mysql/sharding-jdbc-214.jpg" alt="" /></p>

<blockquote>
  <p>查询所有数据</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 使用上没有任何变化</span>
<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">listAll</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderInfo</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">orderInfoService</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
  <span class="n">list</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/sharding-jdbc-list-all.jpg" alt="" /></p>

<h2 id="3-配置广播表">3. 配置广播表</h2>

<p>相当于mycat的全局表(每个库的数据一样，就是全部数据)，先在两个库上创建广播表province_info</p>

<p>应用场景：数据量不大，并且不希望数据分片的表，如配置表，省市区表</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`province_info`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`name`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</code></pre></div></div>

<p>在application.properties里增加配置</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spring.shardingsphere.sharding.broadcast-tables<span class="o">=</span>province_info
</code></pre></div></div>

<p>测试插入和查询的代码</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">insertBroadcast</span><span class="o">(){</span>
  <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into province_info(id,name) values(1,'beijing')"</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"******* 影响的结果："</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">selectBroadcast</span><span class="o">(){</span>
  <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from province_info"</span><span class="o">;</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForList</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nl">val:</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"=========== "</span><span class="o">+</span><span class="n">val</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">)+</span><span class="s">" ----- "</span><span class="o">+</span><span class="n">val</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="4-配置绑定表">4. 配置绑定表</h2>

<p>相当于mycat的主表子表管理，首先按照order_info的建表顺序创建order_item分别在两个库上建立order_item_1,order_item_2</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TABLE <span class="sb">`</span>order_item_1<span class="sb">`</span> <span class="o">(</span>
  <span class="sb">`</span><span class="nb">id</span><span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>product_name<span class="sb">`</span> varchar<span class="o">(</span>255<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>order_id<span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>user_id<span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> DEFAULT NULL
<span class="o">)</span> <span class="nv">ENGINE</span><span class="o">=</span>InnoDB DEFAULT <span class="nv">CHARSET</span><span class="o">=</span>utf8<span class="p">;</span>

CREATE TABLE <span class="sb">`</span>order_item_2<span class="sb">`</span> <span class="o">(</span>
  <span class="sb">`</span><span class="nb">id</span><span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>product_name<span class="sb">`</span> varchar<span class="o">(</span>255<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>order_id<span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> DEFAULT NULL,
  <span class="sb">`</span>user_id<span class="sb">`</span> int<span class="o">(</span>11<span class="o">)</span> DEFAULT NULL
<span class="o">)</span> <span class="nv">ENGINE</span><span class="o">=</span>InnoDB DEFAULT <span class="nv">CHARSET</span><span class="o">=</span>utf8<span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/order-item.jpg" alt="" /></p>

<p>配置绑定表，将两个item表的分片逻辑和order_info保持一致</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 给两个数据源命名</span>
spring.shardingsphere.datasource.names<span class="o">=</span>ds0,ds1
<span class="c"># 数据源链接ds0要和命名一致</span>
spring.shardingsphere.datasource.ds0.type<span class="o">=</span>com.zaxxer.hikari.HikariDataSource
spring.shardingsphere.datasource.ds0.driver-class-name<span class="o">=</span>com.mysql.jdbc.Driver
spring.shardingsphere.datasource.ds0.jdbcUrl<span class="o">=</span>jdbc:mysql://39.103.163.215:3306/shard_order
spring.shardingsphere.datasource.ds0.username<span class="o">=</span>gavin
spring.shardingsphere.datasource.ds0.password<span class="o">=</span>123456
<span class="c"># 数据源链接ds1要和命名一致</span>
spring.shardingsphere.datasource.ds1.type<span class="o">=</span>com.zaxxer.hikari.HikariDataSource
spring.shardingsphere.datasource.ds1.driver-class-name<span class="o">=</span>com.mysql.jdbc.Driver
spring.shardingsphere.datasource.ds1.jdbcUrl<span class="o">=</span>jdbc:mysql://39.101.221.95:3306/shard_order
spring.shardingsphere.datasource.ds1.username<span class="o">=</span>gavin
spring.shardingsphere.datasource.ds1.password<span class="o">=</span>123456

<span class="c"># 具体的分片规则,基于数据节点</span>
spring.shardingsphere.sharding.tables.order_info.actual-data-nodes<span class="o">=</span>ds<span class="nv">$-</span><span class="o">&gt;{</span>0..1<span class="o">}</span>.order_info_<span class="nv">$-</span><span class="o">&gt;{</span>1..2<span class="o">}</span>
<span class="c"># 分库的规则</span>
spring.shardingsphere.sharding.tables.order_info.database-strategy.inline.sharding-column<span class="o">=</span><span class="nb">id
</span>spring.shardingsphere.sharding.tables.order_info.database-strategy.inline.algorithm-expression<span class="o">=</span>ds<span class="nv">$-</span><span class="o">&gt;{</span><span class="nb">id</span> % 2<span class="o">}</span>
<span class="c"># 分表的规则</span>
spring.shardingsphere.sharding.tables.order_info.table-strategy.inline.sharding-column<span class="o">=</span>user_id
spring.shardingsphere.sharding.tables.order_info.table-strategy.inline.algorithm-expression<span class="o">=</span>order_info_<span class="nv">$-</span><span class="o">&gt;{</span>user_id % 2 + 1<span class="o">}</span>

<span class="c"># 具体的分片规则,基于数据节点</span>
spring.shardingsphere.sharding.tables.order_item.actual-data-nodes<span class="o">=</span>ds<span class="nv">$-</span><span class="o">&gt;{</span>0..1<span class="o">}</span>.order_item_<span class="nv">$-</span><span class="o">&gt;{</span>1..2<span class="o">}</span>
<span class="c"># 分库的规则</span>
spring.shardingsphere.sharding.tables.order_item.database-strategy.inline.sharding-column<span class="o">=</span>order_id
spring.shardingsphere.sharding.tables.order_item.database-strategy.inline.algorithm-expression<span class="o">=</span>ds<span class="nv">$-</span><span class="o">&gt;{</span>order_id % 2<span class="o">}</span>
<span class="c"># 分表的规则</span>
spring.shardingsphere.sharding.tables.order_item.table-strategy.inline.sharding-column<span class="o">=</span>user_id
spring.shardingsphere.sharding.tables.order_item.table-strategy.inline.algorithm-expression<span class="o">=</span>order_item_<span class="nv">$-</span><span class="o">&gt;{</span>user_id % 2 + 1<span class="o">}</span>

<span class="c"># 绑定表关系</span>
spring.shardingsphere.sharding.binding-tables<span class="o">=</span>order_info,order_item

<span class="c"># 广播表</span>
spring.shardingsphere.sharding.broadcast-tables<span class="o">=</span>province_info
</code></pre></div></div>

<blockquote>
  <p>作业：自己配置使用一个绑定表来进行插入数据和查询数据</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 绑定表插入数据</span>
<span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">insertOrder</span><span class="o">(){</span>
  <span class="nc">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderInfo</span><span class="o">();</span>
  <span class="n">orderInfo</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">4</span><span class="o">).</span><span class="na">setUserId</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="na">setOrderStatus</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">setOrderAmount</span><span class="o">(</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">2499</span><span class="o">));</span>
  <span class="n">orderInfoService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">);</span>

  <span class="nc">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderItem</span><span class="o">();</span>
  <span class="n">orderItem</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="na">setOrderId</span><span class="o">(</span><span class="mi">4</span><span class="o">).</span><span class="na">setProductName</span><span class="o">(</span><span class="s">"易跑跑步机GTS6"</span><span class="o">).</span><span class="na">setUserId</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
  <span class="n">orderItemService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="5-读写分离配置">5. 读写分离配置</h2>

<p>首先配置properties的数据源，如果有主机配置就必须要有从机配置</p>

<p>官网配置参考:<a href="https://shardingsphere.apache.org/document/legacy/4.x/document/cn/manual/sharding-jdbc/configuration/config-spring-boot/">https://shardingsphere.apache.org/document/legacy/4.x/document/cn/manual/sharding-jdbc/configuration/config-spring-boot/</a></p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 指定主从的配置节点
</span><span class="py">spring.shardingsphere.datasource.names</span><span class="p">=</span><span class="s">master0,master0slave0,master1,master1slave0</span>
<span class="c"># master0数据源链接配置
</span><span class="py">spring.shardingsphere.datasource.master0.type</span><span class="p">=</span><span class="s">com.zaxxer.hikari.HikariDataSource</span>
<span class="py">spring.shardingsphere.datasource.master0.driver-class-name</span><span class="p">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="py">spring.shardingsphere.datasource.master0.jdbcUrl</span><span class="p">=</span><span class="s">jdbc:mysql://39.103.163.215:3306/shard_order</span>
<span class="py">spring.shardingsphere.datasource.master0.username</span><span class="p">=</span><span class="s">gavin</span>
<span class="py">spring.shardingsphere.datasource.master0.password</span><span class="p">=</span><span class="s">123456</span>
<span class="c"># master0slave0数据源链接配置
</span><span class="py">spring.shardingsphere.datasource.master0slave0.type</span><span class="p">=</span><span class="s">com.zaxxer.hikari.HikariDataSource</span>
<span class="py">spring.shardingsphere.datasource.master0slave0.driver-class-name</span><span class="p">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="py">spring.shardingsphere.datasource.master0slave0.jdbcUrl</span><span class="p">=</span><span class="s">jdbc:mysql://39.99.212.46:3306/shard_order</span>
<span class="py">spring.shardingsphere.datasource.master0slave0.username</span><span class="p">=</span><span class="s">gavin</span>
<span class="py">spring.shardingsphere.datasource.master0slave0.password</span><span class="p">=</span><span class="s">123456</span>
<span class="c"># master1数据源链接配置
</span><span class="py">spring.shardingsphere.datasource.master1.type</span><span class="p">=</span><span class="s">com.zaxxer.hikari.HikariDataSource</span>
<span class="py">spring.shardingsphere.datasource.master1.driver-class-name</span><span class="p">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="py">spring.shardingsphere.datasource.master1.jdbcUrl</span><span class="p">=</span><span class="s">jdbc:mysql://39.101.221.95:3306/shard_order</span>
<span class="py">spring.shardingsphere.datasource.master1.username</span><span class="p">=</span><span class="s">gavin</span>
<span class="py">spring.shardingsphere.datasource.master1.password</span><span class="p">=</span><span class="s">123456</span>
<span class="c"># master1slave0数据源链接配置
</span><span class="py">spring.shardingsphere.datasource.master1slave0.type</span><span class="p">=</span><span class="s">com.zaxxer.hikari.HikariDataSource</span>
<span class="py">spring.shardingsphere.datasource.master1slave0.driver-class-name</span><span class="p">=</span><span class="s">com.mysql.jdbc.Driver</span>
<span class="py">spring.shardingsphere.datasource.master1slave0.jdbcUrl</span><span class="p">=</span><span class="s">jdbc:mysql://localhost:3306/shard_order</span>
<span class="py">spring.shardingsphere.datasource.master1slave0.username</span><span class="p">=</span><span class="s">root</span>
<span class="py">spring.shardingsphere.datasource.master1slave0.password</span><span class="p">=</span><span class="s">gavin</span>

<span class="c"># 具体的分片规则,基于数据节点
</span><span class="py">spring.shardingsphere.sharding.tables.order_info.actual-data-nodes</span><span class="p">=</span><span class="s">ds$-&gt;{0..1}.order_info_$-&gt;{1..2}</span>
<span class="c"># 分库的规则
</span><span class="py">spring.shardingsphere.sharding.tables.order_info.database-strategy.inline.sharding-column</span><span class="p">=</span><span class="s">id</span>
<span class="py">spring.shardingsphere.sharding.tables.order_info.database-strategy.inline.algorithm-expression</span><span class="p">=</span><span class="s">ds$-&gt;{id % 2}</span>
<span class="c"># 分表的规则
</span><span class="py">spring.shardingsphere.sharding.tables.order_info.table-strategy.inline.sharding-column</span><span class="p">=</span><span class="s">user_id</span>
<span class="py">spring.shardingsphere.sharding.tables.order_info.table-strategy.inline.algorithm-expression</span><span class="p">=</span><span class="s">order_info_$-&gt;{user_id % 2 + 1}</span>

<span class="c"># 具体的分片规则,基于数据节点
</span><span class="py">spring.shardingsphere.sharding.tables.order_item.actual-data-nodes</span><span class="p">=</span><span class="s">ds$-&gt;{0..1}.order_item_$-&gt;{1..2}</span>
<span class="c"># 分库的规则
</span><span class="py">spring.shardingsphere.sharding.tables.order_item.database-strategy.inline.sharding-column</span><span class="p">=</span><span class="s">order_id</span>
<span class="py">spring.shardingsphere.sharding.tables.order_item.database-strategy.inline.algorithm-expression</span><span class="p">=</span><span class="s">ds$-&gt;{order_id % 2}</span>
<span class="c"># 分表的规则
</span><span class="py">spring.shardingsphere.sharding.tables.order_item.table-strategy.inline.sharding-column</span><span class="p">=</span><span class="s">user_id</span>
<span class="py">spring.shardingsphere.sharding.tables.order_item.table-strategy.inline.algorithm-expression</span><span class="p">=</span><span class="s">order_item_$-&gt;{user_id % 2 + 1}</span>

<span class="c"># 绑定表关系
</span><span class="py">spring.shardingsphere.sharding.binding-tables</span><span class="p">=</span><span class="s">order_info,order_item</span>

<span class="c"># 广播表
</span><span class="py">spring.shardingsphere.sharding.broadcast-tables</span><span class="p">=</span><span class="s">province_info</span>

<span class="c"># 读写分离主从关系绑定
</span><span class="py">spring.shardingsphere.sharding.master-slave-rules.ds0.master-data-source-name</span><span class="p">=</span><span class="s">master0</span>
<span class="py">spring.shardingsphere.sharding.master-slave-rules.ds0.slave-data-source-names</span><span class="p">=</span><span class="s">master0slave0</span>
<span class="c"># 相当于mycat的schema.xml设置datahost的balance,从库负载均衡的规则,可选值：ROUND_ROBIN，RANDOM，这里是轮询从多个读节点上读取数据，从官网上看到是可以自定义负载均衡的规则的，springcloud的rinbon也支持自定义负载均衡的规则
</span><span class="py">spring.shardingsphere.sharding.master-slave-rules.ds0.load-balance-algorithm-type</span><span class="p">=</span><span class="s">round_robin  </span>

<span class="py">spring.shardingsphere.sharding.master-slave-rules.ds1.master-data-source-name</span><span class="p">=</span><span class="s">master1</span>
<span class="py">spring.shardingsphere.sharding.master-slave-rules.ds1.slave-data-source-names</span><span class="p">=</span><span class="s">master1slave0</span>
<span class="c"># 相当于mycat的schema.xml设置datahost的balance，从库负载均衡的规则,可选值：ROUND_ROBIN，RANDOM，这里是随机从多个读节点上读取数据
</span><span class="py">spring.shardingsphere.sharding.master-slave-rules.ds1.load-balance-algorithm-type</span><span class="p">=</span><span class="s">random</span>
</code></pre></div></div>

<p>读写分离后，主库从库要自己做主从复制，sharding jdbc是不会帮你把数据写到从库的，mycat也一样的。</p>

<p>源代码：</p>

<blockquote>
  <p>思考题：</p>
</blockquote>

<p>在sharding-jdbc里是否有双活的概念？是否像MyCat一样支持热切换，如果不支持，我们如何来解决这个问题？</p>

<p>答：sharding-jdbc没有双活的概念，不支持热切换，它没有mycat 的datahost下面配置多个writehost的概念，sharding-jdbc只是客户端数据源连接的高级管理应用。mysql搭建双主互备模式</p>

<h2 id="6-整合druid连接池注意">6. 整合druid连接池注意</h2>

<p><mark>其实sharding-jdbc自己会创建数据连接池的，没必要使用druid连接池</mark>，所以你如果导入了依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>druid-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>1.1.23<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>那么会使得sharding-jdbc创建数据源时与druid发送冲突，项目启动失败，如果要依然使用druid来监控数据库，那么需要做两步</p>

<p>第一步，去掉<code class="highlighter-rouge">DruidDataSourceAutoConfigure</code>自动配置</p>

<ul>
  <li>
    <p>不导入druid-spring-boot-starter包，使用</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>druid<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1.20<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>或者，启动类排除掉<code class="highlighter-rouge">DruidDataSourceAutoConfigure</code>自动配置</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">exclude</span><span class="o">={</span><span class="nc">DruidDataSourceAutoConfigure</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>第二步，使用JPA做ORM框架，加入如下配置</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">JpaProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSourceConfiguration</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">JpaProperties</span> <span class="n">jpaProperties</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Environment</span> <span class="n">environment</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">DataSourceConfiguration</span><span class="o">(</span><span class="nc">JpaProperties</span> <span class="n">jpaProperties</span><span class="o">,</span> <span class="nc">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">jpaProperties</span> <span class="o">=</span> <span class="n">jpaProperties</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Primary</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s">"spring.shardingsphere.datasource."</span><span class="o">;</span>
		<span class="nc">String</span> <span class="n">each</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getDataSourceNames</span><span class="o">(</span><span class="n">prefix</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getDataSource</span><span class="o">(</span><span class="n">prefix</span><span class="o">,</span> <span class="n">each</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">ReflectiveOperationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ShardingSphereException</span><span class="o">(</span><span class="s">"Can't find datasource type!"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Primary</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">EntityManagerFactory</span> <span class="nf">entityManagerFactory</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">HibernateJpaVendorAdapter</span> <span class="n">vendorAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HibernateJpaVendorAdapter</span><span class="o">();</span>
		<span class="n">vendorAdapter</span><span class="o">.</span><span class="na">setDatabase</span><span class="o">(</span><span class="nc">Database</span><span class="o">.</span><span class="na">MYSQL</span><span class="o">);</span>
		<span class="n">vendorAdapter</span><span class="o">.</span><span class="na">setGenerateDdl</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">vendorAdapter</span><span class="o">.</span><span class="na">setShowSql</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="nc">LocalContainerEntityManagerFactoryBean</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LocalContainerEntityManagerFactoryBean</span><span class="o">();</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">setJpaVendorAdapter</span><span class="o">(</span><span class="n">vendorAdapter</span><span class="o">);</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">setPersistenceUnitName</span><span class="o">(</span><span class="s">"default"</span><span class="o">);</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">setPackagesToScan</span><span class="o">(</span><span class="s">"com.lzm.*"</span><span class="o">);</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">dataSource</span><span class="o">());</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">setJpaPropertyMap</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">jpaProperties</span><span class="o">.</span><span class="na">getProperties</span><span class="o">());</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">();</span>
		<span class="k">return</span> <span class="n">factory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Bean</span>
	<span class="nd">@Primary</span>
	<span class="kd">public</span> <span class="nc">EntityManager</span> <span class="nf">entityManager</span><span class="o">(</span><span class="nc">EntityManagerFactory</span> <span class="n">entityManagerFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">SharedEntityManagerCreator</span><span class="o">.</span><span class="na">createSharedEntityManager</span><span class="o">(</span><span class="n">entityManagerFactory</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Primary</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">(</span><span class="nc">EntityManagerFactory</span> <span class="n">entityManagerFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">JpaTransactionManager</span> <span class="n">txManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JpaTransactionManager</span><span class="o">();</span>
		<span class="n">txManager</span><span class="o">.</span><span class="na">setEntityManagerFactory</span><span class="o">(</span><span class="n">entityManagerFactory</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">txManager</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getDataSourceNames</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">StandardEnvironment</span> <span class="n">standardEnv</span> <span class="o">=</span> <span class="o">(</span><span class="nc">StandardEnvironment</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">;</span>
		<span class="n">standardEnv</span><span class="o">.</span><span class="na">setIgnoreUnresolvableNestedPlaceholders</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="k">return</span> <span class="kc">null</span> <span class="o">==</span> <span class="n">standardEnv</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">"name"</span><span class="o">)</span>
				<span class="o">?</span> <span class="k">new</span> <span class="nc">InlineExpressionParser</span><span class="o">(</span><span class="n">standardEnv</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">"names"</span><span class="o">)).</span><span class="na">splitAndEvaluate</span><span class="o">()</span>
				<span class="o">:</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">standardEnv</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">"name"</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">DataSource</span> <span class="nf">getDataSource</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">prefix</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">dataSourceName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ReflectiveOperationException</span> <span class="o">{</span>
		<span class="nc">Map</span> <span class="n">dataSourceProps</span> <span class="o">=</span> <span class="nc">PropertyUtil</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">dataSourceName</span><span class="o">.</span><span class="na">trim</span><span class="o">(),</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="nc">Preconditions</span><span class="o">.</span><span class="na">checkState</span><span class="o">(!</span><span class="n">dataSourceProps</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(),</span> <span class="s">"Wrong datasource properties!"</span><span class="o">);</span>
		<span class="nc">DataSource</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">DataSourceUtil</span><span class="o">.</span><span class="na">getDataSource</span><span class="o">(</span><span class="n">dataSourceProps</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"type"</span><span class="o">).</span><span class="na">toString</span><span class="o">(),</span> <span class="n">dataSourceProps</span><span class="o">);</span>
		<span class="nc">DataSourcePropertiesSetterHolder</span><span class="o">.</span><span class="na">getDataSourcePropertiesSetterByType</span><span class="o">(</span><span class="n">dataSourceProps</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"type"</span><span class="o">).</span><span class="na">toString</span><span class="o">())</span>
				<span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">dataSourcePropertiesSetter</span> <span class="o">-&gt;</span> <span class="n">dataSourcePropertiesSetter</span><span class="o">.</span><span class="na">propertiesSet</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span> <span class="n">prefix</span><span class="o">,</span> <span class="n">dataSourceName</span><span class="o">,</span> <span class="n">result</span><span class="o">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>但我不喜欢JPA这个ORM框架，所以一般不用。</p>

<h2 id="7-分库分表配置实战">7. 分库分表配置实战</h2>

<h3 id="java配置方式">java配置方式</h3>

<p>上面是在application.properties配置分库分表的，也可以使用自定义配置类的方式配置分库分表，参考官网的java配置用户手册：<a href="https://shardingsphere.apache.org/document/legacy/4.x/document/cn/manual/sharding-jdbc/configuration/config-java/">https://shardingsphere.apache.org/document/legacy/4.x/document/cn/manual/sharding-jdbc/configuration/config-java/</a></p>

<p>以rcc的项目举例，pom.xml导入的依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.shardingsphere<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>sharding-jdbc-orchestration<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>4.1.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>不是xxx-starter，自然就没有xxxAutoConfiguration自动配置类和xxxProperty配置属性类，所以要通过java配置类的方式实现sharding分库分表的设置，做法如下：</p>

<blockquote>
  <p>1、application.yaml配置多个物理数据源</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">profiles</span><span class="pi">:</span>
    <span class="na">active</span><span class="pi">:</span> <span class="s">sit</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mcsp-rcc-service-xiejw17</span>
  <span class="na">main</span><span class="pi">:</span>
    <span class="na">allow-bean-definition-overriding</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">lifecycle</span><span class="pi">:</span>
    <span class="na">timeout-per-shutdown-phase</span><span class="pi">:</span> <span class="s">40s</span>
  <span class="na">datasource</span><span class="pi">:</span>
    <span class="na">rcc</span><span class="pi">:</span>
      <span class="na">default-ds</span><span class="pi">:</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.156.63:3306/mcsp_rcc?Unicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;zeroDateTimeBehavior=convertToNull&amp;rewriteBatchedStatements=true&amp;autoReconnect=true</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_rcc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">tZe16dyfF</span>
      <span class="na">read0</span><span class="pi">:</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.156.63:3306/mcsp_rcc_00?Unicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;zeroDateTimeBehavior=convertToNull&amp;rewriteBatchedStatements=true&amp;autoReconnect=true</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_rcc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">tZe16dyfF</span>
      <span class="na">write0</span><span class="pi">:</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.156.63:3306/mcsp_rcc_00?Unicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;zeroDateTimeBehavior=convertToNull&amp;rewriteBatchedStatements=true&amp;autoReconnect=true</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_rcc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">tZe16dyfF</span>
     <span class="s">....</span>   
      <span class="s">shard-count</span><span class="pi">:</span> <span class="m">8</span>
      <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">com.mysql.jdbc.Driver</span>
  <span class="err">	</span><span class="na">ivc</span><span class="pi">:</span>
      <span class="na">default-ds</span><span class="pi">:</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_ivc?Unicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;zeroDateTimeBehavior=convertToNull&amp;rewriteBatchedStatements=true&amp;autoReconnect=true</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_ivc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">di2yh2wPA</span>
      <span class="na">read0</span><span class="pi">:</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_ivc_00?Unicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;zeroDateTimeBehavior=convertToNull&amp;rewriteBatchedStatements=true&amp;autoReconnect=true</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_ivc_search</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">Nnlsa83Aj</span>
      <span class="na">write0</span><span class="pi">:</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_ivc_00?Unicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;zeroDateTimeBehavior=convertToNull&amp;rewriteBatchedStatements=true&amp;autoReconnect=true</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_ivc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">di2yh2wPA</span>
     <span class="s">....</span>   
      <span class="s">shard-count</span><span class="pi">:</span> <span class="m">2</span>
      <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">com.mysql.jdbc.Driver</span>
 <span class="s">.....</span>   
</code></pre></div></div>

<p><img src="\assets\images\2021\springcloud\sharding-jdbc-1.jpg" alt="" /></p>

<p>shard-count=8 表示分8个数据库</p>

<blockquote>
  <p>2、EnvironmentConfig.java，将物理数据源注册到spring容器</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EnvironmentConfig</span> <span class="kd">implements</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">,</span> <span class="nc">EnvironmentAware</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Environment</span> <span class="n">environment</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">modules</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"ivc"</span><span class="o">);</span>
        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"rcc"</span><span class="o">);</span>
        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"mcc"</span><span class="o">);</span>
        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"smc"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span> <span class="c1">// 获取环境变量</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnvironment</span><span class="o">(</span><span class="nc">Environment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">environment</span> <span class="o">=</span> <span class="n">env</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">beanDefinitionRegistry</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
        <span class="n">registerBeanDefinition</span><span class="o">(</span><span class="n">beanDefinitionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">configurableListableBeanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="o">(</span>  <span class="nc">BeanDefinitionRegistry</span> <span class="n">beanDefinitionRegistry</span><span class="o">){</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">String</span> <span class="n">module</span> <span class="o">:</span> <span class="n">modules</span><span class="o">){</span>
            <span class="nc">String</span> <span class="n">shardParam</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".shard-count"</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">shardCount</span> <span class="o">=</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">shardParam</span><span class="o">)</span> <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">shardParam</span><span class="o">)</span> <span class="o">:</span> <span class="mi">2</span><span class="o">;</span>
            <span class="nc">String</span> <span class="n">driverClass</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".driver-class-name"</span><span class="o">);</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">shardCount</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
                <span class="nc">String</span> <span class="n">read</span> <span class="o">=</span> <span class="s">".read"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"."</span><span class="o">;</span>
                <span class="nc">String</span> <span class="n">write</span> <span class="o">=</span> <span class="s">".write"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"."</span><span class="o">;</span>
                <span class="nc">String</span> <span class="n">readUrl</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">read</span> <span class="o">+</span> <span class="s">"url"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">readUser</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">read</span> <span class="o">+</span> <span class="s">"username"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">readPassWord</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">read</span> <span class="o">+</span> <span class="s">"password"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">writeUrl</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">write</span> <span class="o">+</span> <span class="s">"url"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">writeUser</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">write</span> <span class="o">+</span> <span class="s">"username"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">writePassWord</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">write</span> <span class="o">+</span> <span class="s">"password"</span><span class="o">);</span>

                <span class="nc">RootBeanDefinition</span> <span class="n">readBeanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">configBeanDefinition</span><span class="o">(</span><span class="n">readBeanDefinition</span><span class="o">,</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-readDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">readUser</span><span class="o">,</span> <span class="n">readPassWord</span><span class="o">,</span> <span class="n">readUrl</span><span class="o">,</span><span class="n">driverClass</span><span class="o">);</span>

                <span class="nc">RootBeanDefinition</span> <span class="n">writeBeanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">configBeanDefinition</span><span class="o">(</span><span class="n">writeBeanDefinition</span><span class="o">,</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-writeDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">writeUser</span><span class="o">,</span> <span class="n">writePassWord</span><span class="o">,</span> <span class="n">writeUrl</span><span class="o">,</span><span class="n">driverClass</span><span class="o">);</span>

                <span class="n">beanDefinitionRegistry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-readDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">readBeanDefinition</span><span class="o">);</span>
                <span class="n">beanDefinitionRegistry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-writeDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">writeBeanDefinition</span><span class="o">);</span>
            <span class="o">}</span>

                <span class="c1">// 模块的默认库写入bean定义信息注册器</span>
                <span class="nc">String</span> <span class="n">defaultDsUrl</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".default-ds.url"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">defaultDsUser</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".default-ds.username"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">defaultDsPassWord</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".default-ds.password"</span><span class="o">);</span>
                <span class="nc">RootBeanDefinition</span> <span class="n">defaultDsBeanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">configBeanDefinition</span><span class="o">(</span><span class="n">defaultDsBeanDefinition</span><span class="o">,</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-defaultDataSource"</span><span class="o">,</span> <span class="n">defaultDsUser</span><span class="o">,</span> <span class="n">defaultDsPassWord</span><span class="o">,</span> <span class="n">defaultDsUrl</span><span class="o">,</span><span class="n">driverClass</span><span class="o">);</span>
                <span class="n">beanDefinitionRegistry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-defaultDataSource"</span><span class="o">,</span> <span class="n">defaultDsBeanDefinition</span><span class="o">);</span>

        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span>  <span class="kt">void</span> <span class="nf">configBeanDefinition</span><span class="o">(</span><span class="nc">RootBeanDefinition</span> <span class="n">beanDefinition</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">user</span><span class="o">,</span> <span class="nc">String</span> <span class="n">passWord</span><span class="o">,</span> <span class="nc">String</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span> <span class="n">driverClass</span><span class="o">){</span>
        <span class="cm">/*beanDefinition.setSource("EnvironmentConfig");
        Properties prop = build(url, user, passWord, driverClass);
        beanDefinition.getPropertyValues().add("xaProperties", prop);
        beanDefinition.getPropertyValues().add("minPoolSize",5);
        beanDefinition.getPropertyValues().add("maxPoolSize",50);
        beanDefinition.getPropertyValues().add("maxIdleTime",0);
        beanDefinition.getPropertyValues().add("testQuery","select 1");
        beanDefinition.getPropertyValues().add("xaDataSourceClassName", "com.alibaba.druid.pool.xa.DruidXADataSource");  
      	beanDefinition.setRole(2);
        beanDefinition.setBeanClass(AtomikosDataSourceBean.class);*/</span>
      <span class="c1">// 这里使用XA两阶段协议解决分布式事务，使用atomikos充当TM角色，数据库充当RM角色，已实现XA接口协议，但mysql从5.0版本开始支持，但是性能不太好，本身XA就是同步的，对数据库资源锁的时间较长，不适合并发高和事务生命周期长的场景，容易造成获取数据库资源阻塞的问题，数据库的连接数是有限的，业务请求会堵塞在获取数据库连接，只适合并发低的单体应用。</span>
        <span class="nc">MutablePropertyValues</span> <span class="n">propertyValues</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MutablePropertyValues</span><span class="o">();</span>
        <span class="n">propertyValues</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="n">url</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">user</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="n">passWord</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">name</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"driverClassName"</span><span class="o">,</span> <span class="n">driverClass</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"initialSize"</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"minIdle"</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"maxActive"</span><span class="o">,</span><span class="mi">20</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"minEvictableIdleTimeMillis"</span><span class="o">,</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">5</span><span class="o">)</span>    <span class="c1">// 空闲连接最小5分钟后才关闭，默认30分钟</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"maxEvictableIdleTimeMillis"</span><span class="o">,</span><span class="mi">1000L</span><span class="o">*</span><span class="mi">60L</span><span class="o">*</span><span class="mi">60L</span><span class="o">)</span> <span class="c1">// 空闲连接最大60分钟后才关闭，默认7小时</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"validationQuery"</span><span class="o">,</span><span class="s">"select 1"</span><span class="o">)</span>
            <span class="c1">//.add("removeAbandoned",true) // 删除泄漏连接，为避免误删正在使用的连接，官网建议生产环境上关闭</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"removeAbandonedTimeout"</span><span class="o">,</span><span class="mi">3600</span><span class="o">)</span>     <span class="c1">// 60*60秒，从连接池获取的连接如果超过这个时间不归还到连接池，则被认为是泄漏连接，可以被删除回收释放资源</span>
                <span class="c1">// 避免连接泄漏，如果业务超过这个时间还没有处理完，可以适当延长这个时间</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"logAbandoned"</span><span class="o">,</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">;</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setPropertyValues</span><span class="o">(</span><span class="n">propertyValues</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="nc">DruidDataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Properties</span> <span class="nf">build</span><span class="o">(</span><span class="nc">String</span> <span class="n">url</span><span class="o">,</span><span class="nc">String</span> <span class="n">user</span><span class="o">,</span><span class="nc">String</span> <span class="n">passWord</span><span class="o">,</span> <span class="nc">String</span> <span class="n">driverClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Properties</span> <span class="n">prop</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="n">passWord</span><span class="o">);</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"driverClassName"</span><span class="o">,</span> <span class="n">driverClass</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">prop</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>EnvironmentConfig实现接口<code class="highlighter-rouge">BeanDefinitionRegistryPostProcessor</code>和<code class="highlighter-rouge">EnvironmentAware</code></p>

<ul>
  <li>实现接口<code class="highlighter-rouge">BeanDefinitionRegistryPostProcessor</code>是为了重写方法<code class="highlighter-rouge">postProcessBeanDefinitionRegistry</code>将数据源通过bean定义注册器<code class="highlighter-rouge">BeanDefinitionRegistry</code>注册进spring容器</li>
  <li>实现<code class="highlighter-rouge">EnvironmentAware</code>环境感知接口是为了通过环境变量读取application.yml配置文件上面配置的数据库信息</li>
</ul>

<p>物理数据源都在注册进spring ioc容器后，接着就配置shardingsphere的逻辑数据源与分库分表策略</p>

<blockquote>
  <p>3、Shardingsphere的分片配置</p>
</blockquote>

<p>ivc\mcc\rcc\smc 4个模块，每个模块都建一个xxxShardingJdbcConfig配置类：</p>

<p><img src="\assets\images\2021\springcloud\sharding-jdbc-2.jpg" alt="" /></p>

<p>以MccShardingJdbcConfig为例，其他模块配置类一样的</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MccShardingJdbcConfig</span> <span class="kd">implements</span> <span class="nc">ApplicationContextAware</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MODULE</span> <span class="o">=</span> <span class="s">"mcc"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"mccShardingDataSource"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">getShardingDataSource</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="c1">// ds逻辑数据源绑定物理数据源做主从设置</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MasterSlaveRuleConfiguration</span><span class="o">&gt;</span> <span class="n">masterSlaveRuleConfigurationSet</span> <span class="o">=</span> <span class="nc">EnvironmentUtil</span><span class="o">.</span><span class="na">fillDataSource</span><span class="o">(</span><span class="no">MODULE</span><span class="o">);</span>
        <span class="c1">// 数据分片的规则配置类</span>
        <span class="nc">ShardingRuleConfiguration</span> <span class="n">shardingRuleConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ShardingRuleConfiguration</span><span class="o">();</span>
      <span class="c1">// 设置读写分离规则</span>
        <span class="n">shardingRuleConfig</span><span class="o">.</span><span class="na">setMasterSlaveRuleConfigs</span><span class="o">(</span><span class="n">masterSlaveRuleConfigurationSet</span><span class="o">);</span>

        <span class="c1">// 添加需要进行分库分表的数据表的表分片规则配置对象</span>
        <span class="nc">TableRuleConfiguration</span> <span class="n">ivc_invoice_header</span> <span class="o">=</span> <span class="n">getTableRule</span><span class="o">(</span><span class="s">"mcc_receipt_header"</span><span class="o">,</span>  <span class="s">"ds_${0..7}.mcc_receipt_header_${2021..2026}${['06','07','08','09']}"</span><span class="o">,</span><span class="s">"id"</span><span class="o">);</span> <span class="c1">// actualDataNode实际物理表的表达式，会根据这个表达式生成所有的sharding认为的物理表名称，当你查询逻辑表时不带有这个表分片键 id ，就会去查询所有sharding生成的这些物理表，但是数据库没有建表就会报错</span>
        <span class="n">shardingRuleConfig</span><span class="o">.</span><span class="na">getTableRuleConfigs</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">ivc_invoice_header</span><span class="o">);</span>

        <span class="nc">TableRuleConfiguration</span> <span class="n">mcc_receipt_line</span> <span class="o">=</span> <span class="n">getTableRule</span><span class="o">(</span><span class="s">"mcc_receipt_line"</span><span class="o">,</span>  <span class="s">"ds_${0..7}.mcc_receipt_line_${2021..2026}${['06','07','08','09']}"</span><span class="o">,</span><span class="s">"id"</span><span class="o">);</span>
        <span class="n">shardingRuleConfig</span><span class="o">.</span><span class="na">getTableRuleConfigs</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">mcc_receipt_line</span><span class="o">);</span>

        <span class="nc">TableRuleConfiguration</span> <span class="n">mcc_receipt_relation</span> <span class="o">=</span> <span class="n">getTableRule</span><span class="o">(</span><span class="s">"mcc_receipt_relation"</span><span class="o">,</span>  <span class="s">"ds_${0..7}.mcc_receipt_relation_${2021..2026}${['06','07','08','09']}"</span><span class="o">,</span><span class="s">"id"</span><span class="o">);</span>
        <span class="n">shardingRuleConfig</span><span class="o">.</span><span class="na">getTableRuleConfigs</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">mcc_receipt_relation</span><span class="o">);</span>

        <span class="c1">// 默认的分表策略: 使用不分片的实现类，取逻辑表</span>
        <span class="n">shardingRuleConfig</span><span class="o">.</span><span class="na">setDefaultTableShardingStrategyConfig</span><span class="o">(</span><span class="k">new</span> <span class="nc">NoneShardingStrategyConfiguration</span><span class="o">());</span>
        <span class="c1">// 默认的分库策略：使用自定义的策略实现类，对租户编码取模，获取具体的分片数据库</span>
        <span class="nc">ShardingStrategyConfiguration</span> <span class="n">dataBaseConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StandardShardingStrategyConfiguration</span><span class="o">(</span><span class="s">"tenant_code"</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">DataBaseShardingAlgorithm</span><span class="o">());</span>
        <span class="n">shardingRuleConfig</span><span class="o">.</span><span class="na">setDefaultDatabaseShardingStrategyConfig</span><span class="o">(</span><span class="n">dataBaseConfig</span><span class="o">);</span>
      	<span class="n">shardingRuleConfig</span><span class="o">.</span><span class="na">setDefaultDataSourceName</span><span class="o">(</span><span class="s">"mcc-defaultDataSource"</span><span class="o">);</span>

        <span class="c1">// 返回分片的数据源，使用bean注解放入spring容器</span>
        <span class="k">return</span> <span class="nc">ShardingDataSourceFactory</span><span class="o">.</span><span class="na">createDataSource</span><span class="o">(</span><span class="nc">EnvironmentUtil</span><span class="o">.</span><span class="na">createDataSourceMap</span><span class="o">(</span><span class="no">MODULE</span><span class="o">,</span> <span class="n">applicationContext</span><span class="o">),</span> <span class="n">shardingRuleConfig</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 获取表分片规则配置对象
     * @param tableName 逻辑数据表名
     * @param tableNodes 分片表节点，由数据源名 + 表名组成，以小数点分隔
     * @param shardingColumn 分片列（键）
     * @return
     */</span>
    <span class="kd">private</span> <span class="nc">TableRuleConfiguration</span> <span class="nf">getTableRule</span><span class="o">(</span><span class="nc">String</span> <span class="n">tableName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">tableNodes</span><span class="o">,</span> <span class="nc">String</span> <span class="n">shardingColumn</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TableRuleConfiguration</span> <span class="n">tableRuleConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TableRuleConfiguration</span><span class="o">(</span><span class="n">tableName</span><span class="o">,</span> <span class="n">tableNodes</span><span class="o">);</span>
        <span class="c1">// 分表策略，使用单分片键的自定义精确分片算法</span>
        <span class="n">tableRuleConfig</span><span class="o">.</span><span class="na">setTableShardingStrategyConfig</span><span class="o">(</span><span class="k">new</span> <span class="nc">StandardShardingStrategyConfiguration</span><span class="o">(</span><span class="n">shardingColumn</span><span class="o">,</span>
                        <span class="k">new</span> <span class="nf">SingleKeyModuloTableShardingAlgorithm</span><span class="o">()));</span>
        <span class="k">return</span> <span class="n">tableRuleConfig</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setApplicationContext</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
        <span class="n">applicationContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>实现接口<code class="highlighter-rouge">ApplicationContextAware</code>应用上下文感知接口，是为了获取注入spring容器的物理数据源对象。表分片算法SingleKeyModuloTableShardingAlgorithm.java，实现精确分片算法接口PreciseShardingAlgorithm.java，适用于单分片键的标准分片场景，多分片键可以看看官网的ComplexShardingStrategyConfiguration</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingleKeyModuloTableShardingAlgorithm</span> <span class="kd">implements</span> <span class="nc">PreciseShardingAlgorithm</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">doSharding</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">,</span> <span class="nc">PreciseShardingValue</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">shardingValue</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">tableName</span> <span class="o">=</span> <span class="n">shardingValue</span><span class="o">.</span><span class="na">getLogicTableName</span><span class="o">();</span> <span class="c1">// 逻辑表名</span>
    <span class="c1">// 取分片列值的前6位</span>
    <span class="nc">Long</span> <span class="n">key</span>  <span class="o">=</span> <span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">shardingValue</span><span class="o">.</span><span class="na">getValue</span><span class="o">()).</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">6</span><span class="o">));</span>
    <span class="k">return</span> <span class="n">tableName</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="s">"_"</span><span class="o">).</span><span class="na">concat</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">key</span><span class="o">));</span> <span class="c1">// 返回具体分片表名</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>表分片算法NormalTableShardingAlgorithm.java，实现精确分片算法接口PreciseShardingAlgorithm.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NormalTableShardingAlgorithm</span> <span class="kd">implements</span> <span class="nc">PreciseShardingAlgorithm</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">doSharding</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">,</span> <span class="nc">PreciseShardingValue</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">shardingValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">shardingValue</span><span class="o">.</span><span class="na">getLogicTableName</span><span class="o">();</span> <span class="c1">// 直接返回逻辑表名</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>分库算法DataBaseShardingAlgorithm.java，实现精确分片算法接口PreciseShardingAlgorithm.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataBaseShardingAlgorithm</span> <span class="kd">implements</span> <span class="nc">PreciseShardingAlgorithm</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">doSharding</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">,</span> <span class="nc">PreciseShardingValue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">shardingValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">shardingValue</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">shard</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()%</span><span class="n">collection</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">ds</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">shard</span> <span class="o">==</span> <span class="n">temp</span><span class="o">){</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">temp</span> <span class="o">++;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">ds</span><span class="o">;</span> <span class="c1">// 返回具体的分片数据库</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>工具类EvironmentUtil.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EnvironmentUtil</span> <span class="o">{</span>
      <span class="cm">/**
     * 返回逻辑数据源的读写分离规则
     * @param module
     * @return
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MasterSlaveRuleConfiguration</span><span class="o">&gt;</span> <span class="nf">fillDataSource</span><span class="o">(</span> <span class="nc">String</span> <span class="n">module</span><span class="o">){</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MasterSlaveRuleConfiguration</span><span class="o">&gt;</span> <span class="n">masterSlaveRuleConfigurationSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
        <span class="nc">String</span> <span class="n">shardParam</span> <span class="o">=</span> <span class="nc">EnvironmentConfig</span><span class="o">.</span><span class="na">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".shard-count"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">shardCount</span> <span class="o">=</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">shardParam</span><span class="o">)</span> <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">shardParam</span><span class="o">)</span> <span class="o">:</span> <span class="mi">2</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">shardCount</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="nc">MasterSlaveRuleConfiguration</span> <span class="n">masterSlaveRuleConfig</span> <span class="o">=</span>
                    <span class="k">new</span> <span class="nf">MasterSlaveRuleConfiguration</span><span class="o">(</span><span class="s">"ds_"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">module</span> <span class="o">+</span> <span class="s">"-writeDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-readDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">));</span>
            <span class="n">masterSlaveRuleConfigurationSet</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">masterSlaveRuleConfig</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">masterSlaveRuleConfigurationSet</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 返回物理数据源map
     * @param module 业务模块名，ivc\mcc\rcc\smc
     * @param applicationContext 应用上下文
     * @return
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">DataSource</span><span class="o">&gt;</span> <span class="nf">createDataSourceMap</span><span class="o">(</span><span class="nc">String</span>  <span class="n">module</span><span class="o">,</span> <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">DataSource</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="nc">String</span> <span class="n">shardParam</span> <span class="o">=</span> <span class="nc">EnvironmentConfig</span><span class="o">.</span><span class="na">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".shard-count"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">shardCount</span> <span class="o">=</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">shardParam</span><span class="o">)</span> <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">shardParam</span><span class="o">)</span> <span class="o">:</span> <span class="mi">2</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">shardCount</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="nc">DataSource</span> <span class="n">readDataSource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span><span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-readDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="nc">DataSource</span> <span class="n">writeDataSource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span><span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-writeDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-writeDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">writeDataSource</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-readDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">readDataSource</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>4、MybatisPlusConfig配置类，绑定sqlsessionFactory与sharding数据源</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">(</span><span class="nc">EnvironmentConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MybatisPlusConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nd">@ConditionalOnMissingBean</span><span class="o">({</span><span class="nc">FileNameInterface</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">FileNameInterface</span> <span class="nf">defaultFileName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultFileNameServiceImpl</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Autowired</span>
    <span class="nc">PaginationInterceptor</span> <span class="n">paginationInterceptor</span><span class="o">;</span>

    <span class="c1">// 注意冒号:表示当没有配置对应属性时，变量logImpl为null，即默认值null</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${mybatis-plus.configuration.log-impl:}"</span><span class="o">)</span>
    <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Log</span><span class="o">&gt;</span> <span class="n">logImpl</span><span class="o">;</span>

  <span class="c1">// 依赖事务控制器的bean对象先注入spring容器</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"rccShardingSqlSessionFactory"</span><span class="o">)</span>
    <span class="c1">//@DependsOn({"transactionManager"})</span>
    <span class="nd">@Primary</span>
    <span class="kd">public</span> <span class="nc">SqlSessionFactory</span> <span class="nf">rccShardingSqlSessionFactory</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"rccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"globalConfiguration"</span><span class="o">)</span> <span class="nc">GlobalConfig</span> <span class="n">globalConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="c1">// mapper接口的xml文件路径</span>
        <span class="nc">String</span> <span class="n">mapperLocations</span> <span class="o">=</span> <span class="s">"classpath:mapping/rcc/**/*.xml"</span><span class="o">;</span>
      <span class="c1">// 数据库表映射的实体类的包路径</span>
        <span class="nc">String</span> <span class="n">typeAliasesPackage</span> <span class="o">=</span> <span class="s">"com.midea.mcsp.settlement.rcc.entity.rcc"</span><span class="o">;</span>
        <span class="k">return</span> <span class="nf">buildSqlSessionFactory</span><span class="o">(</span><span class="n">dataSource</span><span class="o">,</span> <span class="n">typeAliasesPackage</span><span class="o">,</span> <span class="n">mapperLocations</span><span class="o">,</span> <span class="n">globalConfig</span><span class="o">);</span>
    <span class="o">}</span>

  	<span class="c1">// smc模块做数据分片的表操作会话工厂sqlsessionFactory绑定smc的分片数据源,不分片的表则走默认数据源</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"smcShardingSqlSessionFactory"</span><span class="o">)</span>
    <span class="c1">//@DependsOn({"transactionManager"})</span>
    <span class="kd">public</span> <span class="nc">SqlSessionFactory</span> <span class="nf">smcShardingSqlSessionFactory</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"smcShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"globalConfiguration"</span><span class="o">)</span> <span class="nc">GlobalConfig</span> <span class="n">globalConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">mapperLocations</span> <span class="o">=</span> <span class="s">"classpath:mapping/smc/**/*.xml"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">typeAliasesPackage</span> <span class="o">=</span> <span class="s">"com.midea.mcsp.settlement.rcc.entity.smc"</span><span class="o">;</span>
        <span class="k">return</span> <span class="nf">buildSqlSessionFactory</span><span class="o">(</span><span class="n">dataSource</span><span class="o">,</span> <span class="n">typeAliasesPackage</span><span class="o">,</span> <span class="n">mapperLocations</span><span class="o">,</span> <span class="n">globalConfig</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"mccShardingSqlSessionFactory"</span><span class="o">)</span>
    <span class="nd">@DependsOn</span><span class="o">({</span><span class="s">"transactionManager"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">SqlSessionFactory</span> <span class="nf">mccShardingSqlSessionFactory</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"mccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"globalConfiguration"</span><span class="o">)</span> <span class="nc">GlobalConfig</span> <span class="n">globalConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">mapperLocations</span> <span class="o">=</span> <span class="s">"classpath:mapping/mcc/**/*.xml"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">typeAliasesPackage</span> <span class="o">=</span> <span class="s">"com.midea.mcsp.settlement.rcc.entity.mcc"</span><span class="o">;</span>
        <span class="k">return</span> <span class="nf">buildSqlSessionFactory</span><span class="o">(</span><span class="n">dataSource</span><span class="o">,</span> <span class="n">typeAliasesPackage</span><span class="o">,</span> <span class="n">mapperLocations</span><span class="o">,</span> <span class="n">globalConfig</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">GlobalConfig</span> <span class="nf">globalConfiguration</span><span class="o">(</span><span class="nc">MetaObjectHandler</span> <span class="n">myDbFeildFillHandler</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">GlobalConfig</span> <span class="n">conf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GlobalConfig</span><span class="o">();</span>
        <span class="n">conf</span><span class="o">.</span><span class="na">setBanner</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">GlobalConfig</span><span class="o">.</span><span class="na">DbConfig</span> <span class="n">dbConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GlobalConfig</span><span class="o">.</span><span class="na">DbConfig</span><span class="o">();</span>
        <span class="n">dbConfig</span><span class="o">.</span><span class="na">setIdType</span><span class="o">(</span><span class="nc">IdType</span><span class="o">.</span><span class="na">ASSIGN_ID</span><span class="o">);</span>
        <span class="n">dbConfig</span><span class="o">.</span><span class="na">setTableUnderline</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">dbConfig</span><span class="o">.</span><span class="na">setLogicDeleteValue</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
        <span class="n">dbConfig</span><span class="o">.</span><span class="na">setLogicNotDeleteValue</span><span class="o">(</span><span class="s">"0"</span><span class="o">);</span>
        <span class="n">conf</span><span class="o">.</span><span class="na">setDbConfig</span><span class="o">(</span><span class="n">dbConfig</span><span class="o">);</span>
        <span class="n">conf</span><span class="o">.</span><span class="na">setMetaObjectHandler</span><span class="o">(</span><span class="n">myDbFeildFillHandler</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">conf</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"impalaSqlSessionFactory"</span><span class="o">)</span>
    <span class="nd">@DependsOn</span><span class="o">({</span><span class="s">"transactionManager"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">SqlSessionFactory</span> <span class="nf">impalaSqlSessionFactory</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"impalaDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"globalConfiguration"</span><span class="o">)</span> <span class="nc">GlobalConfig</span> <span class="n">globalConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="c1">// mapper接口的xml文件路径</span>
        <span class="nc">String</span> <span class="n">mapperLocations</span> <span class="o">=</span> <span class="s">"classpath:mapping/impala/*.xml"</span><span class="o">;</span>
      <span class="c1">// 数据库表映射的实体类的包路径</span>
        <span class="nc">String</span> <span class="n">typeAliasesPackage</span> <span class="o">=</span> <span class="s">"com.midea.mcsp.settlement.rcc.entity.impala"</span><span class="o">;</span>
        <span class="k">return</span> <span class="nf">buildSqlSessionFactory</span><span class="o">(</span><span class="n">dataSource</span><span class="o">,</span> <span class="n">typeAliasesPackage</span><span class="o">,</span> <span class="n">mapperLocations</span><span class="o">,</span> <span class="n">globalConfig</span><span class="o">);</span>
    <span class="o">}</span>

  	<span class="c1">// 返回MybatisSqlSessionFactoryBean对象</span>
    <span class="kd">private</span> <span class="nc">SqlSessionFactory</span> <span class="nf">buildSqlSessionFactory</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nc">String</span> <span class="n">typeAliasesPackage</span><span class="o">,</span> <span class="nc">String</span> <span class="n">mapperLocations</span><span class="o">,</span> <span class="nc">GlobalConfig</span> <span class="n">globalConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">MybatisSqlSessionFactoryBean</span> <span class="n">sqlSessionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MybatisSqlSessionFactoryBean</span><span class="o">();</span>
        <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">setMapperLocations</span><span class="o">(</span><span class="k">new</span> <span class="nc">PathMatchingResourcePatternResolver</span><span class="o">().</span><span class="na">getResources</span><span class="o">(</span><span class="n">mapperLocations</span><span class="o">));</span>
        <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">setTypeAliasesPackage</span><span class="o">(</span><span class="n">typeAliasesPackage</span><span class="o">);</span>
        <span class="nc">MybatisConfiguration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MybatisConfiguration</span><span class="o">();</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setJdbcTypeForNull</span><span class="o">(</span><span class="nc">JdbcType</span><span class="o">.</span><span class="na">NULL</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setMapUnderscoreToCamelCase</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setCacheEnabled</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="c1">//configuration.setLogImpl(org.apache.ibatis.logging.stdout.StdOutImpl.class);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logImpl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">configuration</span><span class="o">.</span><span class="na">setLogImpl</span><span class="o">(</span><span class="n">logImpl</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">setConfiguration</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
        <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">setPlugins</span><span class="o">(</span><span class="k">new</span> <span class="nc">Interceptor</span><span class="o">[]{</span>
                <span class="n">paginationInterceptor</span>
        <span class="o">});</span>
        <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">setGlobalConfig</span><span class="o">(</span><span class="n">globalConfig</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// JTA分布式事务管理器,数据源连接要使用AtomikosDataSourceBean</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"transactionManager"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="nc">UserTransactionManager</span> <span class="n">userTransactionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserTransactionManager</span><span class="o">();</span>
        <span class="n">userTransactionManager</span><span class="o">.</span><span class="na">setForceShutdown</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">UserTransaction</span> <span class="n">userTransaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserTransactionImp</span><span class="o">();</span>
        <span class="n">userTransaction</span><span class="o">.</span><span class="na">setTransactionTimeout</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">JtaTransactionManager</span><span class="o">(</span><span class="n">userTransaction</span><span class="o">,</span> <span class="n">userTransactionManager</span><span class="o">);</span>
    <span class="o">}</span>

  	<span class="c1">// 每个逻辑数据源对应一个事务控制器</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Primary</span> <span class="c1">// 不指定事务控制器，使用该事务控制器</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">rccManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"rccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">smcManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"smcShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">mccManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"mccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里有个impalaDataSource，连接到大数据的sql查询引擎impala，表数据存储在kudu，在application.yml配置连接</p>

<p><img src="\assets\images\2021\springcloud\sharding-jdbc-3.jpg" alt="" /></p>

<p>它的数据源配置类，注入到spring ioc容器</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ImpalaDataSourceConfig</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.datasource.impala.url}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">url</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.datasource.impala.driver-class}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">driverClass</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.datasource.impala.username}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.datasource.impala.password}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"impalaDataSource"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">impalaDataSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// minEvictableIdleTimeMillis 会话连接保持空闲而不被关闭的最小时间，默认30分钟</span>
        <span class="c1">// maxEvictableIdleTimeMillis 会话连接保持空闲而不被关闭的最大时间，默认7小时</span>
        <span class="nc">DruidDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DruidDataSource</span><span class="o">();</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"impala-datasource"</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setInitialSize</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setMinIdle</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>   <span class="c1">// 连接池中容许保持空闲状态的最小连接数量,低于这个数量将创建新的连接,</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setMaxActive</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setMaxWait</span><span class="o">(</span><span class="mi">40000</span><span class="o">);</span> <span class="c1">// 连接等待时间，40秒还没有连接到数据库则连接失败</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUrl</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="n">driverClass</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setTimeBetweenEvictionRunsMillis</span><span class="o">(</span><span class="mi">60000</span><span class="o">);</span> <span class="c1">// 每隔60秒检查空闲连接</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setMinEvictableIdleTimeMillis</span><span class="o">(</span><span class="mi">60000</span><span class="o">);</span>   <span class="c1">// 会话最小空闲时间，默认30分钟</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setMaxEvictableIdleTimeMillis</span><span class="o">(</span><span class="mi">290000</span><span class="o">);</span> <span class="c1">// 会话最大空闲时间，默认7小时</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setValidationQuery</span><span class="o">(</span><span class="s">"select 1"</span><span class="o">);</span> <span class="c1">// SQL查询,用来验证从连接池取出的连接,在将连接返回给调用者之前,验证连接是否可用，默认为空</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setTestWhileIdle</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// 校验连接池中的空闲连接是否可用,默认true</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setTestOnBorrow</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  <span class="c1">// 从连接池中取出连接前进行校验，如果校验失败，则从池中去除连接并尝试取出另一个，开启这个会消耗内存CPU资源,默认false</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setTestOnReturn</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>  <span class="c1">// 连接归还到连接池前不进行校验,默认false</span>
        <span class="c1">//dataSource.setRemoveAbandoned(true); // 删除泄漏的连接，为避免误删正在使用的连接，官网建议生产环境上不开启</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setRemoveAbandonedTimeout</span><span class="o">(</span><span class="mi">3600</span><span class="o">);</span> <span class="c1">// 60*60秒，如果从连接池获取的连接超过这个时间仍然未归还连接池，则被认为是泄漏连接，可以被删除回收释放资源，如果</span>
        <span class="c1">// 业务超过这个时间还未处理完，则可适当延长这个时间，这个属性是针对活动连接的配置</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setLogAbandoned</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span><span class="c1">// 标记当Statement或连接被泄露时是否打印程序的stack traces日志。</span>

        <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>5、MapperScanerConfig配置类，绑定mapper接口与sqlsessionFactory</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">(</span><span class="nc">MybatisPlusConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MapperScannerConfig</span> <span class="o">{</span>
  <span class="c1">// rcc模块做数据分片的表操作的mapper接口绑定rcc的分片sqlSessionFactory</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MapperScannerConfigurer</span> <span class="nf">RccShardingMapperScannerConfigurer</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">MapperScannerConfigurer</span> <span class="n">mapperScannerConfigurer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapperScannerConfigurer</span><span class="o">();</span>
      <span class="c1">// 扫描mapper接口的包路径</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setBasePackage</span><span class="o">(</span><span class="s">"com.midea.mcsp.settlement.rcc.mapper.rcc"</span><span class="o">);</span>
      <span class="c1">// 指定对应的sqlsessionFactory</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setSqlSessionFactoryBeanName</span><span class="o">(</span><span class="s">"rccShardingSqlSessionFactory"</span><span class="o">);</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setAnnotationClass</span><span class="o">(</span><span class="nc">RccShardingRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">mapperScannerConfigurer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MapperScannerConfigurer</span> <span class="nf">SmcShardingMapperScannerConfigurer</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">MapperScannerConfigurer</span> <span class="n">mapperScannerConfigurer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapperScannerConfigurer</span><span class="o">();</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setBasePackage</span><span class="o">(</span><span class="s">"com.midea.mcsp.settlement.rcc.mapper.smc"</span><span class="o">);</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setSqlSessionFactoryBeanName</span><span class="o">(</span><span class="s">"smcShardingSqlSessionFactory"</span><span class="o">);</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setAnnotationClass</span><span class="o">(</span><span class="nc">SmcShardingRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">mapperScannerConfigurer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MapperScannerConfigurer</span> <span class="nf">MccShardingMapperScannerConfigurer</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">MapperScannerConfigurer</span> <span class="n">mapperScannerConfigurer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapperScannerConfigurer</span><span class="o">();</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setBasePackage</span><span class="o">(</span><span class="s">"com.midea.mcsp.settlement.rcc.mapper.mcc"</span><span class="o">);</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setSqlSessionFactoryBeanName</span><span class="o">(</span><span class="s">"mccShardingSqlSessionFactory"</span><span class="o">);</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setAnnotationClass</span><span class="o">(</span><span class="nc">MccShardingRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">mapperScannerConfigurer</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="c1">// impala的kudu大数据表操作的mapper接口扫描</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MapperScannerConfigurer</span> <span class="nf">ImpalaMapperScannerConfigurer</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">MapperScannerConfigurer</span> <span class="n">mapperScannerConfigurer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapperScannerConfigurer</span><span class="o">();</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setBasePackage</span><span class="o">(</span><span class="s">"com.midea.mcsp.settlement.rcc.mapper.impala"</span><span class="o">);</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setSqlSessionFactoryBeanName</span><span class="o">(</span><span class="s">"impalaSqlSessionFactory"</span><span class="o">);</span>
        <span class="n">mapperScannerConfigurer</span><span class="o">.</span><span class="na">setAnnotationClass</span><span class="o">(</span><span class="nc">ImpalaRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">mapperScannerConfigurer</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>最后，这个数据源配置的加载流程如下图：</p>

<p><img src="\assets\images\2021\springcloud\sharding-jdbc-4.jpg" alt="" /></p>

<h3 id="整合dynamic动态数据源">整合dynamic动态数据源</h3>

<p>pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.shardingsphere<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>sharding-jdbc-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>4.1.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>先说单逻辑数据源，以SMC的配置做参考</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#分库分表配置</span>
  <span class="na">shardingsphere</span><span class="pi">:</span>
    <span class="na">datasource</span><span class="pi">:</span>
      <span class="c1">#  数据库名称，可自定义，可以为多个，以逗号隔开，每个在这里定义的库，都要在下面定义连接属性</span>
      <span class="na">names</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mcsp-smc,mcsp-smc-00,mcsp-smc-01,mcsp-smc-02,mcsp-smc-03,mcsp-smc-04,mcsp-smc-05,mcsp-smc-06,mcsp-smc-07"</span>
      <span class="na">mcsp-smc</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-smc</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_smc?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_smc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">fVdb51Kxo</span>
        <span class="c1">#连接池中最小连接数</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">2</span>
        <span class="c1">#连接池中最大连接数</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">100</span>
        <span class="c1">#连接池中连接最大生命周期（创建，使用，空闲，销毁）</span>
        <span class="c1">#MyCat是30分钟，后端Mysql是1个小时，应用配置为15分钟。</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="c1">#连接池中获取连接等待最大时间</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="c1">#连接池中连接空闲多久进行才能被回收</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="c1">#设置连接被占用的超时时间，每个SQL不能执行超过这个时间，</span>
        <span class="c1">#Hikari与其他的数据库连接池不同，他会为每一个连接创建定时器，监听其执行时间。</span>
        <span class="c1">#其他数据源则共享一个timerTask，设置间隔多久跑一次。</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-smc-00</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-smc-00</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_smc_00?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_smc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">fVdb51Kxo</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-smc-01</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-smc-01</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_smc_01?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_smc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">fVdb51Kxo</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-smc-02</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-smc-02</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_smc_02?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_smc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">fVdb51Kxo</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-smc-03</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-smc-03</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_smc_03?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_smc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">fVdb51Kxo</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-smc-04</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-smc-04</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_smc_04?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_smc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">fVdb51Kxo</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-smc-05</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-smc-05</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_smc_05?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_smc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">fVdb51Kxo</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-smc-06</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-smc-06</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_smc_06?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_smc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">fVdb51Kxo</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-smc-07</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-st-07</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_smc_07?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_smc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">fVdb51Kxo</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">100</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
    <span class="na">sharding</span><span class="pi">:</span>
      <span class="na">default-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-smc</span>
      <span class="c1">#需要拆分的表，可以设置多个</span>
      <span class="na">tables</span><span class="pi">:</span>
      <span class="c1">#需要进行分表的逻辑表名，用MyBatis或者MyBatis-Plus操作数据库时只需要操作逻辑表即可，xml文件也只需要配置逻辑表</span>
      <span class="c1">#实际的表结点,下面代表的是t_order_为开头的所有表，如果能确定表的范围例如按月份分表，这里的写法是ds$-&gt;{2019..2020}.t_order_$-&gt;{2021..2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}表示12个月的表</span>
        <span class="na">intf_bd_result_back_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_bd_result_back_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
          <span class="na">database-strategy</span><span class="pi">:</span>
            <span class="na">complex</span><span class="pi">:</span>
              <span class="na">sharding-columns</span><span class="pi">:</span> <span class="s">request_id</span>
              <span class="na">algorithm-class-name</span><span class="pi">:</span> <span class="s">com.midea.mcsp.settlement.smc.infrastructure.config.SmcShardingDatabaseComplexAlgorithm01</span>
          <span class="na">table-strategy</span><span class="pi">:</span>
            <span class="na">complex</span><span class="pi">:</span>
              <span class="na">sharding-columns</span><span class="pi">:</span> <span class="s">id</span>
              <span class="na">algorithm-class-name</span><span class="pi">:</span> <span class="s">com.midea.mcsp.settlement.smc.infrastructure.config.SmcShardingTableComplexAlgorithm</span>
        <span class="na">intf_bd_result_back_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_bd_result_back_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
          <span class="na">database-strategy</span><span class="pi">:</span>
            <span class="na">complex</span><span class="pi">:</span>
              <span class="na">sharding-columns</span><span class="pi">:</span> <span class="s">request_id</span>
              <span class="na">algorithm-class-name</span><span class="pi">:</span> <span class="s">com.midea.mcsp.settlement.smc.infrastructure.config.SmcShardingDatabaseComplexAlgorithm01</span>
          <span class="na">table-strategy</span><span class="pi">:</span>
            <span class="na">complex</span><span class="pi">:</span>
              <span class="na">sharding-columns</span><span class="pi">:</span> <span class="s">id</span>
              <span class="na">algorithm-class-name</span><span class="pi">:</span> <span class="s">com.midea.mcsp.settlement.smc.infrastructure.config.SmcShardingTableComplexAlgorithm</span>
        <span class="na">intf_erp_icp_invoice_req_head</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_erp_icp_invoice_req_head_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">intf_erp_icp_invoice_req_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_erp_icp_invoice_req_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">intf_erp_icp_invoice_tax_contr</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_erp_icp_invoice_tax_contr_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">intf_erp_so_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_erp_so_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">intf_erp_so_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_erp_so_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">intf_nc_so_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_nc_so_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">intf_nc_so_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_nc_so_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">intf_settle_bill_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_settle_bill_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">intf_settle_bill_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_settle_bill_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">intf_settle_bill_line_detail</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.intf_settle_bill_line_detail_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_apply_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_apply_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_apply_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_apply_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_adjust_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_adjust_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_adjust_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_adjust_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_header_his</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_header_his_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_header_extend</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_header_extend_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_header_extend_his</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_header_extend_his_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_line_detail</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_line_detail_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_line_detail_his</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_line_detail_his_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_settle_bill_line_his</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_settle_bill_line_his_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_ec_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_ec_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_ec_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_ec_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_line_detail</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_line_detail_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_receipt_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_receipt_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_receipt_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_receipt_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_trx_adjust_apply</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_trx_adjust_apply_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_trx_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_trx_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_trx_header_relation</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_trx_header_relation_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_trx_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_trx_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_trx_line_relation</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_trx_line_relation_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_trx_oi_header</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_trx_oi_header_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_trx_oi_line</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_trx_oi_line_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
        <span class="na">smc_so_trx_post_detail</span><span class="pi">:</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-smc-$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.smc_so_trx_post_detail_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>
      <span class="s">binding-tables[0]</span><span class="pi">:</span> <span class="s">intf_erp_icp_invoice_req_head,intf_erp_icp_invoice_req_line</span>
      <span class="s">binding-tables[1]</span><span class="pi">:</span> <span class="s">intf_erp_so_header,intf_erp_so_line</span>
      <span class="s">binding-tables[2]</span><span class="pi">:</span> <span class="s">intf_nc_so_header,intf_nc_so_line</span>
      <span class="s">binding-tables[3]</span><span class="pi">:</span> <span class="s">intf_settle_bill_header,intf_settle_bill_line,intf_settle_bill_line_detail</span>
      <span class="s">binding-tables[4]</span><span class="pi">:</span> <span class="s">smc_settle_apply_header,smc_settle_apply_line</span>
      <span class="s">binding-tables[5]</span><span class="pi">:</span> <span class="s">smc_settle_bill_adjust_header,smc_settle_bill_adjust_line</span>
      <span class="s">binding-tables[6]</span><span class="pi">:</span> <span class="s">smc_so_ec_header,smc_so_ec_line</span>
      <span class="s">binding-tables[7]</span><span class="pi">:</span> <span class="s">smc_so_receipt_header,smc_so_receipt_line</span>
      <span class="s">binding-tables[8]</span><span class="pi">:</span> <span class="s">smc_so_trx_oi_header,smc_so_trx_oi_line,smc_so_trx_post_detail</span>
      <span class="s">binding-tables[9]</span><span class="pi">:</span> <span class="s">smc_so_trx_header,smc_so_trx_header_relation,smc_so_trx_line,smc_so_trx_line_relation</span>
      <span class="s">binding-tables[10]</span><span class="pi">:</span> <span class="s">smc_settle_bill_header,smc_settle_bill_header_extend,smc_settle_bill_header_extend_his,smc_settle_bill_header_his,smc_settle_bill_line,smc_settle_bill_line_detail,smc_settle_bill_line_detail_his,smc_settle_bill_line_his</span>
      <span class="s">binding-tables[11]</span><span class="pi">:</span> <span class="s">smc_so_header,smc_so_line,smc_so_line_detail</span>
      <span class="s">binding-tables[12]</span><span class="pi">:</span> <span class="s">intf_bd_result_back_header,intf_bd_result_back_line</span>

      <span class="c1">#分库策略，按照创建时间的年份分库，如果不用分库的，直接注释掉分库相关的代码</span>
      <span class="na">default-database-strategy</span><span class="pi">:</span>
        <span class="na">complex</span><span class="pi">:</span>
          <span class="na">sharding-columns</span><span class="pi">:</span> <span class="s">tenant_code</span>
          <span class="na">algorithm-class-name</span><span class="pi">:</span> <span class="s">com.midea.mcsp.settlement.smc.infrastructure.config.SmcShardingDatabaseComplexAlgorithm</span>
      <span class="na">default-table-strategy</span><span class="pi">:</span>
        <span class="c1">#分表策略，根据自己的需要写的分表策略，这里我是根据car_park_id这个字段的值作为后缀，来确定放到哪张表</span>
        <span class="na">complex</span><span class="pi">:</span>
          <span class="na">sharding-columns</span><span class="pi">:</span> <span class="s">id</span>
          <span class="na">algorithm-class-name</span><span class="pi">:</span> <span class="s">com.midea.mcsp.settlement.smc.infrastructure.config.SmcShardingTableComplexAlgorithm</span>
</code></pre></div></div>

<p>他们的分库分表策略都是实现了<code class="highlighter-rouge">ComplexKeysShardingAlgorithm</code>接口，其实更适用于多分片键的复合分片场景。应该使用StandardShardingStrategyConfiguration接口，单分片键的分片场景</p>

<p><img src="\assets\images\2021\springcloud\sharding-algorithm.jpg" alt="" /></p>

<p><img src="\assets\images\2021\springcloud\sharding-algorithm-2.jpg" alt="" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmcShardingDatabaseComplexAlgorithm</span> <span class="kd">implements</span> <span class="nc">ComplexKeysShardingAlgorithm</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DATA_BASE_SIZE</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">doSharding</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">availableTargetNames</span><span class="o">,</span> <span class="nc">ComplexKeysShardingValue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">shardingValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">columnNameAndShardingValuesMap</span> <span class="o">=</span> <span class="n">shardingValue</span><span class="o">.</span><span class="na">getColumnNameAndShardingValuesMap</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">columnNameAndShardingValuesMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"tenant_code"</span><span class="o">)){</span>
            <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tenantCodeCol</span> <span class="o">=</span> <span class="n">columnNameAndShardingValuesMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"tenant_code"</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">tenantCode</span> <span class="o">=</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span> <span class="n">tenantCodeCol</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">());</span>
            <span class="kt">long</span> <span class="n">tenant_code_mod</span>  <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">tenantCode</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()%</span><span class="no">DATA_BASE_SIZE</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">availableTargetName</span> <span class="o">:</span> <span class="n">availableTargetNames</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">availableTargetName</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%02d"</span><span class="o">,</span> <span class="n">tenant_code_mod</span><span class="o">))){</span>
                    <span class="k">return</span> <span class="nc">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span><span class="n">availableTargetName</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>多逻辑数据源的场景</p>
</blockquote>

<p>增加导入依赖包</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.baomidou<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>dynamic-datasource-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.5.6<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>以CDC工程为例，用到impala和mysql的分库两个数据源，默认数据源是mysql分库，application.yaml配置如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">profiles</span><span class="pi">:</span>
    <span class="na">active</span><span class="pi">:</span> <span class="s">dev</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">mcsp-cdc-service-zsl</span>
  <span class="na">main</span><span class="pi">:</span>
    <span class="na">allow-bean-definition-overriding</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">lifecycle</span><span class="pi">:</span>
    <span class="na">timeout-per-shutdown-phase</span><span class="pi">:</span> <span class="s">40s</span>

  <span class="na">datasource</span><span class="pi">:</span>
    <span class="na">dynamic</span><span class="pi">:</span>
      <span class="na">primary</span><span class="pi">:</span> <span class="s">sharding</span>
      <span class="na">strict</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">datasource</span><span class="pi">:</span>
        <span class="na">impala</span><span class="pi">:</span>
          <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:impala://10.18.25.72:24050/mcsp_kudu;AuthMech=3</span>
          <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:impala://10.18.25.72:24050/mcsp_kudu;AuthMech=3</span>
          <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_bind</span>
          <span class="na">password</span><span class="pi">:</span> <span class="s">f8Pi6Xp6Sp</span>
          <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">com.cloudera.impala.jdbc41.Driver</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>

  <span class="na">shardingsphere</span><span class="pi">:</span>
    <span class="na">datasource</span><span class="pi">:</span>
      <span class="c1">#  数据库名称，可自定义，可以为多个，以逗号隔开，每个在这里定义的库，都要在下面定义连接属性</span>
      <span class="na">names</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mcsp-cdc,mcsp-cdc-slave,mcsp-cdc-00,mcsp-cdc-00-slave,mcsp-cdc-01,mcsp-cdc-01-slave,</span><span class="nv">    </span><span class="se">\
</span>                <span class="s">mcsp-cdc-02,mcsp-cdc-02-slave,mcsp-cdc-03,mcsp-cdc-03-slave,mcsp-cdc-04,mcsp-cdc-04-slave,</span><span class="nv"> </span><span class="se">\
</span>                <span class="s">mcsp-cdc-05,mcsp-cdc-05-slave,mcsp-cdc-06,mcsp-cdc-06-slave,mcsp-cdc-07,mcsp-cdc-07-slave"</span>
      <span class="na">mcsp-cdc</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="c1">#连接池中最小连接数</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="c1">#连接池中最大连接数</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="c1">#连接池中连接最大生命周期（创建，使用，空闲，销毁）</span>
        <span class="c1">#MyCat是30分钟，后端Mysql是1个小时，应用配置为15分钟。</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="c1">#连接池中获取连接等待最大时间</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="c1">#连接池中连接空闲多久进行才能被回收</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="c1">#设置连接被占用的超时时间，每个SQL不能执行超过这个时间，</span>
        <span class="c1">#Hikari与其他的数据库连接池不同，他会为每一个连接创建定时器，监听其执行时间。</span>
        <span class="c1">#其他数据源则共享一个timerTask，设置间隔多久跑一次。</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-slave</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-00</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-00</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_00?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-00-slave</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-00</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_00?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-01</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-01</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_01?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-01-slave</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-01</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_01?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-02</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-02</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_02?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-02-slave</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-02</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_02?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-03</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-03</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_03?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-03-slave</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-03</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_03?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-04</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-04</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_04?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-04-slave</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-04</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_04?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-05</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-05</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_05?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-05-slave</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-05</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_05?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-06</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-06</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_06?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-06-slave</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-cdc-06</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_06?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-07</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-st-07</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_07?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
      <span class="na">mcsp-cdc-07-slave</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
        <span class="na">poolName</span><span class="pi">:</span> <span class="s">pool-mcsp-st-07</span>
        <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
        <span class="na">jdbcUrl</span><span class="pi">:</span> <span class="s">jdbc:mysql://10.16.92.106:3306/mcsp_cdc_07?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;zeroDateTimeBehavior=convertToNull</span>
        <span class="na">username</span><span class="pi">:</span> <span class="s">mcsp_cdc_user</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s">f5FpgUfb1</span>
        <span class="na">minimumIdle</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">maximumPoolSize</span><span class="pi">:</span> <span class="m">200</span>
        <span class="na">maxLifetime</span><span class="pi">:</span> <span class="m">1800000</span>
        <span class="na">connectionTimeout</span><span class="pi">:</span> <span class="m">6000</span>
        <span class="na">idleTimeout</span><span class="pi">:</span> <span class="m">300000</span>
        <span class="na">leakDetectionThreshold</span><span class="pi">:</span> <span class="m">15000</span>
    <span class="na">sharding</span><span class="pi">:</span>
      <span class="na">master-slave-rules</span><span class="pi">:</span>
        <span class="na">mcsp-cdc-r</span><span class="pi">:</span>
          <span class="na">master-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc</span>
          <span class="na">slave-data-source-names</span><span class="pi">:</span> <span class="s">mcsp-cdc-slave</span>
        <span class="na">mcsp-cdc-r00</span><span class="pi">:</span>
          <span class="na">master-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc-00</span>
          <span class="na">slave-data-source-names</span><span class="pi">:</span> <span class="s">mcsp-cdc-00-slave</span>
        <span class="na">mcsp-cdc-r01</span><span class="pi">:</span>
          <span class="na">master-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc-01</span>
          <span class="na">slave-data-source-names</span><span class="pi">:</span> <span class="s">mcsp-cdc-01-slave</span>
        <span class="na">mcsp-cdc-r02</span><span class="pi">:</span>
          <span class="na">master-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc-02</span>
          <span class="na">slave-data-source-names</span><span class="pi">:</span> <span class="s">mcsp-cdc-02-slave</span>
        <span class="na">mcsp-cdc-r03</span><span class="pi">:</span>
          <span class="na">master-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc-03</span>
          <span class="na">slave-data-source-names</span><span class="pi">:</span> <span class="s">mcsp-cdc-03-slave</span>
        <span class="na">mcsp-cdc-r04</span><span class="pi">:</span>
          <span class="na">master-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc-04</span>
          <span class="na">slave-data-source-names</span><span class="pi">:</span> <span class="s">mcsp-cdc-04-slave</span>
        <span class="na">mcsp-cdc-r05</span><span class="pi">:</span>
          <span class="na">master-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc-05</span>
          <span class="na">slave-data-source-names</span><span class="pi">:</span> <span class="s">mcsp-cdc-05-slave</span>
        <span class="na">mcsp-cdc-r06</span><span class="pi">:</span>
          <span class="na">master-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc-06</span>
          <span class="na">slave-data-source-names</span><span class="pi">:</span> <span class="s">mcsp-cdc-06-slave</span>
        <span class="na">mcsp-cdc-r07</span><span class="pi">:</span>
          <span class="na">master-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc-07</span>
          <span class="na">slave-data-source-names</span><span class="pi">:</span> <span class="s">mcsp-cdc-07-slave</span>
      <span class="na">default-data-source-name</span><span class="pi">:</span> <span class="s">mcsp-cdc-r</span>
    <span class="c1">#分库策略，按照创建时间的年份分库，如果不用分库的，直接注释掉分库相关的代码</span>
      <span class="na">default-database-strategy</span><span class="pi">:</span>
        <span class="na">complex</span><span class="pi">:</span>
          <span class="na">sharding-columns</span><span class="pi">:</span> <span class="s">tenant_code</span>
          <span class="na">algorithm-class-name</span><span class="pi">:</span> <span class="s">com.midea.mcsp.settlement.cdc.infrastructure.config.CdcShardingDatabaseComplexAlgorithm</span>
      <span class="na">default-table-strategy</span><span class="pi">:</span>
        <span class="c1"># 分表策略，根据自己的需要写的分表策略，这里我是根据car_park_id这个字段的值作为后缀，来确定放到哪张表</span>
        <span class="na">complex</span><span class="pi">:</span>
          <span class="na">sharding-columns</span><span class="pi">:</span> <span class="s">id</span>
          <span class="na">algorithm-class-name</span><span class="pi">:</span> <span class="s">com.midea.mcsp.settlement.cdc.infrastructure.config.CdcShardingTableComplexAlgorithm</span>

      <span class="c1">#需要拆分的表，可以设置多个</span>
      <span class="na">tables</span><span class="pi">:</span>
        <span class="c1">#需要进行分表的逻辑表名，用MyBatis或者MyBatis-Plus操作数据库时只需要操作逻辑表即可，xml文件也只需要配置逻辑表</span>
        <span class="na">cdc_account_amount_record</span><span class="pi">:</span>
          <span class="c1">#实际的表结点,下面代表的是t_order_为开头的所有表，如果能确定表的范围例如按月份分表，这里的写法是ds$-&gt;{2019..2020}.t_order_&amp;-&gt;{01..12}表示12个月的表</span>
          <span class="na">actual-data-nodes</span><span class="pi">:</span> <span class="s">mcsp-cdc-r$-&gt;{(0..7).collect{t -&gt;t.toString().padLeft(2,'0')}}.cdc_account_amount_record_$-&gt;{2021}$-&gt;{(1..12).collect{t -&gt;t.toString().padLeft(2,'0')}}</span>

    <span class="na">props</span><span class="pi">:</span>
      <span class="na">sql</span><span class="pi">:</span>
        <span class="na">show</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-edu/2020/06/28/icoding-note-053-1.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
