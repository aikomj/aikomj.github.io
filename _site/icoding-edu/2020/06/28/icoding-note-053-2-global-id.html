<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 飞天班第53节：全局分布式id的设计 - 大伟的博客 </title>
    <meta name="keywords" content="mysql,springboot,springcloud">
    <meta name="description"
          content="Mycat和Sharding jdbc如何通过UUID和雪花算法实现全局id">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-edu/2020/06/28/icoding-note-053-2-global-id.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="飞天班第53节：全局分布式id的设计">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>飞天班第53节：全局分布式id的设计</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/06/28
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1-分布式全局id概述及引发的问题">1. 分布式全局id概述及引发的问题</h2>

<ul>
  <li>在创建表的时候我们对主键id都是使用自增，通过这个来唯一区分数据</li>
  <li>在分库分表的场景中自增id就出现无法解决重复的问题了</li>
  <li>两条不同的业务数据由于id重复，就会导致查询出错或关联数据有问题</li>
</ul>

<h2 id="2-通过uuid实现全局id">2. 通过UUID实现全局id</h2>

<p>InnoDB引擎是一个索引组织表（数据和索引放在同一个文件）， 数据会跟着主键ID来排序和相应的数据排列，一旦数据ID发生变化会导致索引重排，如果主键ID是有序的就不会发生重排，但是uuid是无序的会导致数据跟着索引进行重排浪费性能，所以一般不建议使用uuid作为主键。但是MyISAM引擎的数据和索引是分开文件存储的，使用UUID作为主键不影响数据的排序</p>

<p>优点：</p>

<ul>
  <li>UUID通用唯一识别码</li>
  <li>值差异大，使用uuid作为条件查询会较快</li>
</ul>

<p>缺点：</p>

<ul>
  <li>只是一个单纯的id，没有实际意义，长度32位，太长没有顺序对MySQL innoDB引擎的索引组织表极不友好</li>
</ul>

<p><mark>MyCat不支持UUID的方式的，Sharding-Jdbc支持UUID的方式</mark></p>

<h3 id="21-在sharding-jdbc中使用uuid进行分库">2.1. 在sharding-jdbc中使用UUID进行分库</h3>

<p>第一步：分别在两个数据库db213和db214的schema shard_order下创建表</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`order_content_1`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`order_amount`</span> <span class="nb">decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`order_status`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`user_id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`order_content_2`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`order_amount`</span> <span class="nb">decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`order_status`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`user_id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/order-content.jpg" alt="" /></p>

<p>第二步：配置application.properties将UUID的列作为数据库的划分方式，userid作为分表的规则</p>

<p>我们就需要将inline的规则改成standard的规则，<font color="red">并自己实现standard的分片规则类</font></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 分库的规则</span>
spring.shardingsphere.sharding.tables.order_content.database-strategy.standard.sharding-column<span class="o">=</span><span class="nb">id
</span>spring.shardingsphere.sharding.tables.order_content.database-strategy.standard.precise-algorithm-class-name<span class="o">=</span>com.icodingedu.config.MyShardingRule
<span class="c"># 分表的规则</span>
<span class="c"># 分表的规则</span>
spring.shardingsphere.sharding.tables.order_content.table-strategy.inline.sharding-column<span class="o">=</span>user_id
spring.shardingsphere.sharding.tables.order_content.table-strategy.inline.algorithm-expression<span class="o">=</span>order_content_<span class="nv">$-</span><span class="o">&gt;{</span>user_id % 2 + 1<span class="o">}</span>
<span class="c"># 指定id的生成规则为UUID</span>
<span class="c"># 指定id的生成规则为UUID，由sharding-jdbc提供</span>
<span class="c"># 如果声明值的写入就会使用写入的而不是UUID（就是说id没有值才会使用uuid）</span>
spring.shardingsphere.sharding.tables.order_content.key-generator.column<span class="o">=</span><span class="nb">id
</span>spring.shardingsphere.sharding.tables.order_content.key-generator.type<span class="o">=</span>UUID
</code></pre></div></div>

<p>分库的自定义类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">icodingedu</span><span class="o">.</span><span class="na">config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.shardingsphere.api.sharding.standard.PreciseShardingAlgorithm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.shardingsphere.api.sharding.standard.PreciseShardingValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyShardingRule</span> <span class="kd">implements</span> <span class="nc">PreciseShardingAlgorithm</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">doSharding</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">,</span> <span class="nc">PreciseShardingValue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">preciseShardingValue</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 拿到用来分库的值</span>
        <span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">preciseShardingValue</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
      <span class="c1">// 通过hash才取模得到ds0还是ds1</span>
        <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">id</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()%</span><span class="n">collection</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
      <span class="c1">// 绝对值</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">mode</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="o">[]</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="o">[</span><span class="n">mode</span><span class="o">].</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/mysharding-rule-precise.jpg" alt="" /></p>

<p>测试</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">insertOrderContent</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into order_content(order_amount,order_status,user_id) values(333,1,10)"</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"******* 影响的结果："</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/db213-uuid.jpg" alt="" /></p>

<h2 id="3-通过雪花算法实现全局id">3. 通过雪花算法实现全局id</h2>

<p>​	全局分布式ID方案总结：<a href="https://www.cnblogs.com/haoxinyue/p/5208136.html">https://www.cnblogs.com/haoxinyue/p/5208136.html</a></p>

<ul>
  <li>
    <p>SnowFlack是由Twitter提出的分布式ID算法</p>
  </li>
  <li>
    <p>是一个64bit的long型数字</p>
  </li>
  <li>
    <p>引入了时间戳的概念，保持自增</p>
  </li>
  <li>
    <p>SnowFlack数据结构</p>

    <ul>
      <li>第一位是0固定不变的，表示一个正数，如果是1就是负数了</li>
      <li>41位的时间戳：当前时间减去你设置的开始时间的毫秒数，开始时间在雪花算法生成里可以设置，最长的时间范围是69年</li>
      <li>5位的机房id</li>
      <li>5位的机器id：5位机房和5位机器唯一标识机器的序列，可以配置2的10次方，也就是1024个机器在并发的情况下可以不重复</li>
      <li>12位的序号：同一时间同一机器并发可以生成2的12次方个序列，也就是说有4096个不同</li>
      <li>说明雪花支持<mark>毫秒级的并发是4096个</mark></li>
    </ul>

    <p><img src="\assets\images\2022\springcloud\snowflack.png" alt="" /></p>
  </li>
  <li>
    <p><mark>时间回调会引起重复</mark></p>

    <p>你在一开始上线的时候和实际的时间不一致，比实际早，发现后将时间修改就有一定可能导致时间重叠出现重复，重复的几率比较低</p>
  </li>
  <li>
    <p>MyCat和sharding-jdbc都支持雪花算法</p>
  </li>
  <li>
    <p>Sharding-jdbc可以设置最大容忍回调时间，如果超过之后再通过snowflack生成id会抛出异常</p>
  </li>
</ul>

<h3 id="31-mycat如何使用雪花生成id">3.1. MyCat如何使用雪花生成id</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 0.首先要将id由int修改为bigint(19),unsigned(无符号)</span>
<span class="c"># 1.修改server.xml的配置,修改为2将自动生成的id变更为雪花算法方式</span>
<span class="c"># 你会发现Mycat默认就是2的</span>
<span class="o">[</span>root@helloworld conf]# vim server.xml 
&lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">"sequnceHandlerType"</span><span class="o">&gt;</span>2&lt;/property&gt;

<span class="c"># 2.设置机房id和机器id</span>
<span class="c"># conf下的sequence_time_conf.properties</span>
<span class="o">[</span>root@helloworld conf]# vim sequence_time_conf.properties 
<span class="nv">WORKID</span><span class="o">=</span>03 <span class="c">#机器id,不超过32</span>
<span class="nv">DATAACENTERID</span><span class="o">=</span>03 <span class="c">#机房id，不超过32</span>

<span class="c"># 3.配置表生成的id规则</span>
<span class="c"># 修改schema.xml</span>
<span class="o">[</span>root@helloworld conf]# vim schema.xml 
&lt;table <span class="nv">name</span><span class="o">=</span><span class="s2">"order_info"</span> <span class="nv">dataNode</span><span class="o">=</span><span class="s2">"dn213,dn214"</span> <span class="nv">rule</span><span class="o">=</span><span class="s2">"mod-long"</span> <span class="nv">autoIncrement</span><span class="o">=</span><span class="s2">"true"</span> <span class="nv">primaryKey</span><span class="o">=</span><span class="s2">"id"</span><span class="o">&gt;</span>
		&lt;childTable <span class="nv">name</span><span class="o">=</span><span class="s2">"order_item"</span> <span class="nv">joinKey</span><span class="o">=</span><span class="s2">"order_id"</span> <span class="nv">parentKey</span><span class="o">=</span><span class="s2">"id"</span>/&gt;
&lt;/table&gt;
<span class="c"># autoIncrement</span>
<span class="c"># primaryKey</span>

<span class="c"># 4、重启mycat</span>
<span class="o">[</span>root@helloworld conf]# ../bin/mycat restart
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/mycat-workid-datacenterid.jpg" alt="" /></p>

<p><img src="/assets/images/2020/icoding/mysql/mycat-snowflake-id.jpg" alt="" /></p>

<h3 id="32-sharding-jdbc实现雪花">3.2. Sharding-Jdbc实现雪花</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 给两个数据源命名</span>
spring.shardingsphere.datasource.names<span class="o">=</span>ds0,ds1
<span class="c"># 数据源链接ds0要和命名一致</span>
spring.shardingsphere.datasource.ds0.type<span class="o">=</span>com.zaxxer.hikari.HikariDataSource
spring.shardingsphere.datasource.ds0.driver-class-name<span class="o">=</span>com.mysql.jdbc.Driver
spring.shardingsphere.datasource.ds0.jdbcUrl<span class="o">=</span>jdbc:mysql://39.103.163.215:3306/shard_order
spring.shardingsphere.datasource.ds0.username<span class="o">=</span>gavin
spring.shardingsphere.datasource.ds0.password<span class="o">=</span>123456
<span class="c"># 数据源链接ds1要和命名一致</span>
spring.shardingsphere.datasource.ds1.type<span class="o">=</span>com.zaxxer.hikari.HikariDataSource
spring.shardingsphere.datasource.ds1.driver-class-name<span class="o">=</span>com.mysql.jdbc.Driver
spring.shardingsphere.datasource.ds1.jdbcUrl<span class="o">=</span>jdbc:mysql://39.101.221.95:3306/shard_order
spring.shardingsphere.datasource.ds1.username<span class="o">=</span>gavin
spring.shardingsphere.datasource.ds1.password<span class="o">=</span>123456

<span class="c"># 具体的分片规则,基于数据节点</span>
spring.shardingsphere.sharding.tables.order_info.actual-data-nodes<span class="o">=</span>ds<span class="nv">$-</span><span class="o">&gt;{</span>0..1<span class="o">}</span>.order_info_<span class="nv">$-</span><span class="o">&gt;{</span>1..2<span class="o">}</span>
<span class="c"># 分库的规则</span>
spring.shardingsphere.sharding.tables.order_info.database-strategy.inline.sharding-column<span class="o">=</span><span class="nb">id
</span>spring.shardingsphere.sharding.tables.order_info.database-strategy.inline.algorithm-expression<span class="o">=</span>ds<span class="nv">$-</span><span class="o">&gt;{</span><span class="nb">id</span> % 2<span class="o">}</span>
<span class="c"># 分表的规则</span>
spring.shardingsphere.sharding.tables.order_info.table-strategy.inline.sharding-column<span class="o">=</span>user_id
spring.shardingsphere.sharding.tables.order_info.table-strategy.inline.algorithm-expression<span class="o">=</span>order_info_<span class="nv">$-</span><span class="o">&gt;{</span>user_id % 2 + 1<span class="o">}</span>
<span class="c"># 设定雪花id</span>
spring.shardingsphere.sharding.tables.order_info.key-generator.column<span class="o">=</span><span class="nb">id
</span>spring.shardingsphere.sharding.tables.order_info.key-generator.type<span class="o">=</span>snowflake
<span class="c"># 这里也需要设置机房id和机器id,两者合并了,是10位,所以不要超过1024</span>
spring.shardingsphere.sharding.tables.order_info.key-generator.props.worker.id<span class="o">=</span>1000
<span class="c"># 最大的时间容忍间隔,60000毫秒</span>
spring.shardingsphere.sharding.tables.order_info.key-generator.props.max.tolerate.time.difference.milliseconds<span class="o">=</span>60000
</code></pre></div></div>

<p>从官网可以看到</p>

<p><img src="/assets/images/2020/icoding/mysql/sharding-jdbc-snosflake.jpg" alt="" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">insertOrder</span><span class="o">(){</span>
  <span class="nc">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderInfo</span><span class="o">();</span>
  <span class="n">orderInfo</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="na">setOrderStatus</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">setOrderAmount</span><span class="o">(</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">129</span><span class="o">));</span>
  <span class="n">orderInfoService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">);</span>

  <span class="nc">OrderItem</span> <span class="n">orderItem</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderItem</span><span class="o">();</span>
  <span class="n">orderItem</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="na">setOrderId</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">setProductName</span><span class="o">(</span><span class="s">"安佳牛奶"</span><span class="o">).</span><span class="na">setUserId</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
  <span class="n">orderItemService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">orderItem</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mysql/sharding-jdbc-snowflake-id.jpg" alt="" /></p>

<h2 id="4-redis实现全局唯一id">4. Redis实现全局唯一ID</h2>

<h3 id="原理">原理</h3>

<p>因为 Redis 的所有命令是单线程的，所以可以利用 Redis 的原子操作 INCR 和 INCRBY，来生成全局唯一的ID。redis是单线程的，是因为它基于 Reactor 模型开发了网络事件处理器，这个处理器被称为文件事件处理器，它由4部分构成：</p>

<ul>
  <li>多个套接字</li>
  <li>IO多路复用程序</li>
  <li>文件事件分派器</li>
  <li>事件处理器</li>
</ul>

<p><mark>因为文件事件分派器队列的消费是单线程的，所以 Redis 才叫单线程模型。</mark></p>

<p>所谓的redis多路复用机制，就是指多个网络IO线程复用一个redis线程，这也是redis高效的原因。</p>

<p>好了，说回Redis生成全局唯一ID的事。</p>

<blockquote>
  <p>方式一：StringRedisTemplate</p>
</blockquote>

<p>我们的实体类如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Activity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">BigDecimal</span> <span class="n">price</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>我们定义一个Service类来调用redis生成全局唯一id</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IdGeneratorService</span> <span class="o">{</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ID_KEY</span> <span class="o">=</span> <span class="s">"id:generator:activity"</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">incrementId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">increment</span><span class="o">(</span><span class="no">ID_KEY</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>调用</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="n">id</span> <span class="o">=</span> <span class="n">idGeneratorService</span><span class="o">.</span><span class="na">incrementId</span><span class="o">();</span> <span class="c1">// 调用生成</span>
</code></pre></div></div>

<p>感觉好像有点 low ,但总算生成了全局唯一id</p>

<blockquote>
  <p>方式二：lua脚本</p>
</blockquote>

<p>生产环境中，我们的redis都是集群部署的，生成id就要变化一下：集群中每个节点预生成生成ID；然后与redis的已经存在的ID做比较。如果大于，则取节点生成的ID；小于的话，取Redis中最大ID自增。这个时候我们还需要一段 lua 脚本来保证我们实现的ID是唯一的，这才是真正的本质，不然我们实现的ID再高端，不唯一，有个锤子用。</p>

<p>lua核心脚本如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">local</span> <span class="n">function</span> <span class="nf">get_max_seq</span><span class="o">()</span>
    <span class="n">local</span> <span class="n">key</span> <span class="o">=</span> <span class="n">tostring</span><span class="o">(</span><span class="no">KEYS</span><span class="o">[</span><span class="mi">1</span><span class="o">])</span>
    <span class="n">local</span> <span class="n">incr_amoutt</span> <span class="o">=</span> <span class="n">tonumber</span><span class="o">(</span><span class="no">KEYS</span><span class="o">[</span><span class="mi">2</span><span class="o">])</span>
    <span class="n">local</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">tostring</span><span class="o">(</span><span class="no">KEYS</span><span class="o">[</span><span class="mi">3</span><span class="o">])</span>
    <span class="n">local</span> <span class="n">month_in_seconds</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">30</span>
    <span class="k">if</span> <span class="o">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">redis</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="err">\'</span><span class="n">setnx</span><span class="err">\'</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">seq</span><span class="o">))</span>
    <span class="n">then</span>
        <span class="n">redis</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="err">\'</span><span class="n">expire</span><span class="err">\'</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">month_in_seconds</span><span class="o">)</span>
        <span class="k">return</span> <span class="n">seq</span>
    <span class="k">else</span>
        <span class="n">local</span> <span class="n">prev_seq</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="err">\'</span><span class="n">get</span><span class="err">\'</span><span class="o">,</span> <span class="n">key</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">prev_seq</span> <span class="o">&lt;</span> <span class="n">seq</span><span class="o">)</span>
        <span class="n">then</span>
            <span class="n">redis</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="err">\'</span><span class="n">set</span><span class="err">\'</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">seq</span><span class="o">)</span>
            <span class="k">return</span> <span class="n">seq</span>
        <span class="k">else</span>
        <span class="o">--[[</span>
            <span class="err">不能直接返回</span><span class="n">redis</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="err">\'</span><span class="n">incr</span><span class="err">\'</span><span class="o">,</span> <span class="n">key</span><span class="o">),</span><span class="err">因为返回的是</span><span class="n">number</span><span class="err">浮点数类型</span><span class="o">,</span><span class="err">会出现不精确情况。</span>
            <span class="err">注意</span><span class="o">:</span> <span class="err">类似</span><span class="s">"16081817202494579"</span><span class="err">数字大小已经快超时</span><span class="n">lua</span><span class="err">和</span><span class="n">reids</span><span class="err">最大数值</span><span class="o">,</span><span class="err">请谨慎的增加</span><span class="n">seq</span><span class="err">的位数</span>
        <span class="o">--]]</span>
            <span class="n">redis</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="err">\'</span><span class="n">incrby</span><span class="err">\'</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">incr_amoutt</span><span class="o">)</span>
            <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="err">\'</span><span class="n">get</span><span class="err">\'</span><span class="o">,</span> <span class="n">key</span><span class="o">)</span>
        <span class="n">end</span>
    <span class="n">end</span>
<span class="n">end</span>
<span class="k">return</span> <span class="nf">get_max_seq</span><span class="o">()</span>
</code></pre></div></div>

<h3 id="reactor模式">Reactor模式</h3>

<p>前面我们说Redis 基于 Reactor 模型开发了网络事件处理器，这个网络事件处理器由4部分组成：多个套接字、IO多路复用程序、文件事件分派器、事件处理器。因为文件事件分派器队列的消费是单线程的，所以 Redis 才叫单线程模型。</p>

<p>这个Reactor模式，其实在Netty 中也是有使用的。</p>

<blockquote>
  <p>什么是Reactor模型</p>
</blockquote>

<p>Reactor模型，就是一个多路复用I/O模型，主要用于在高并发、高吞吐量的环境中进行I/O处理。而这种多路复用的模型所依赖的永远都是那么几个内容，事件分发器，事件处理器，还有调用的客户端，如下图：</p>

<p><img src="\assets\images\2021\springcloud\reactor-1.jpg" alt="" /></p>

<p>Reactor模型是一个同步的I/O多路复用模型，关于同步IO，可以看之前的文章回顾一下</p>

<p><a href="/java/2020/10/16/java-io.html">java io 体系</a></p>

<p><a href="/java/2021/04/29/about-netty.html">选择netty，不使用socket</a></p>

<p>这种单线程的模型是什么样子的呢，如下图：</p>

<p><img src="\assets\images\2021\springcloud\reactor-2.jpg" alt="" /></p>

<p>这种模型的意思是说：<mark>Redis 单线程指的是网络请求模块使用了一个线程（所以不需考虑并发安全性）</mark>，即一个线程处理所有网络请求，<strong>其他模块仍用了多个线程</strong>。多路复用，指的就是这个，也是为什么redis高效的原因。首先redis的数据是直接从内存读取的，但是我们这里说的快速是针对存储在磁盘上的数据来说的，因为断电后，内存中的数据丢失了，重启redis后，还是需要从磁盘读取的。</p>

<p>我们看一段redis官网说的话：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Redis is single threaded. How can I exploit multiple CPU / cores?
It<span class="s1">'s not very frequent that CPU becomes your bottleneck with Redis, as usually Redis is either memory or network bound. For instance, using pipelining Redis running on an average Linux system can deliver even 1 million requests per second, so if your application mainly uses O(N) or O(log(N)) commands, it is hardly going to use too much CPU.

However, to maximize CPU usage you can start multiple instances of Redis in the same box and treat them as different servers. At some point a single box may not be enough anyway, so if you want to use multiple CPUs you can start thinking of some way to shard earlier.

You can find more information about using multiple Redis instances in the Partitioning page.

However with Redis 4.0 we started to make Redis more threaded. For now this is limited to deleting objects in the background, and to blocking commands implemented via Redis modules. For future releases, the plan is to make Redis more and more threaded.
</span></code></pre></div></div>

<p>翻译过来大致就是说，<mark>当我们使用 Redis 的时候，CPU 成为瓶颈的情况并不常见，通常是内存或网络受限成为瓶颈。</mark></p>

<p>其实说白了，官网就是说我们 Redis 就是这么的快，并且正是由于在单线程模式的情况下已经很快了，就没有必要在使用多线程了。其实redis 6.0开始，已经支持多线程，只不过是默认关闭的。</p>

<p>使用多线程不见得一定快，原因在于CPU切换的时间损耗：其实 Redis 使用单个 CPU 绑定一个内存，针对内存的处理就是单线程的,而我们使用多个 CPU 模拟出多个线程来，光在多个 CPU 之间的切换，然后再操作 Redis ，实际上就不如直接从内存中拿出来，毕竟耗时在这里摆着。</p>

<p>你认为的 Redis 为什么是单线程的？</p>


            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-edu/2020/06/28/icoding-note-053-2-global-id.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
