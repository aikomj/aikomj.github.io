<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 飞天班第46节：Docker精通-4 - 大伟的博客 </title>
    <meta name="keywords" content="docker">
    <meta name="description"
          content="Docker compose 批量编排服务，一键启动多个服务，Swarm架构，Docker swarm 搭建服务集群，Raft协议，动态扩容服务实例，灰度发布">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-edu/2020/06/09/icoding-note-046.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="飞天班第46节：Docker精通-4">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>飞天班第46节：Docker精通-4</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/06/09
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1docker-compose重点">1、Docker Compose（重点）</h2>

<h3 id="简介">简介</h3>

<p>前面我们学了使用Dockerfile，build 生成 image 镜像，run 运行成 container 容器，但这只适合单个服务，我们的微服务架构通常包含多个服务，如何一起部署?</p>

<p>微服务架构（多个服务），会部署多个实例！大量的服务如果都需要手动启停，效率很低！</p>

<p>使用<mark>Docker Compse</mark>，高效轻松管理我们容器！运行多容器！</p>

<p>官网：https://docs.docker.com/compose/</p>

<p><img src="/assets/images/2020/icoding/docker/overview-of-docker-compose.jpg" alt="" /></p>

<p><strong>介绍：</strong></p>

<blockquote>
  <p>Compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to</p>

  <p>compose 是一个定义和运行多个包含docker应用的容器的工具。使用compose，你可以用一个yaml文件去配置</p>

  <p>configure your application’s services. Then, with a single command, you create and start all the services from your</p>

  <p>你的应用服务。然后用一个简单的命令，通过你的yaml文件配置去创建和启动所有的服务。</p>

  <p>configuration. To learn more about all the features of Compose, see <a href="https://docs.docker.com/compose/#features">the list of features</a>.</p>

  <p>需要了解更多，你可以看 compose的特性</p>

  <p>Compose works in all environments: production, staging, development, testing, as well as CI workflows.</p>

  <p>Compose 工作在所有的环境：生产、准备环境、开发、测试，</p>

  <p>You can learn more about each case in <a href="https://docs.docker.com/compose/#common-use-cases">Common Use Cases</a>.</p>

  <p>你可以通过Compose 使用案例，了解更多</p>

  <p>Using Compose is basically a three-step process:</p>

  <p>使用 Dockercompose的3个基本核心步骤：</p>

  <ol>
    <li>
      <p>Define your app’s environment with a <mark>Dockerfile</mark> so it can be reproduced anywhere.</p>

      <p>用一个Dockerfile定义你的app环境。这样它在其他地方可以使用</p>
    </li>
    <li>
      <p>Define the services that make up your app in <mark>docker-compose.yml</mark>  so they can be run together in an isolated environment.</p>

      <p>在docker-compose.yml定义组成你的应用程序的所有服务。这样它们可以在一个独立的环境一起运行。</p>
    </li>
    <li>
      <p>Run <mark>docker-compose up</mark>  and Compose starts and runs your entire app.</p>

      <p>运行 docker-compose up命令，启动运行你的整个应用程序。</p>
    </li>
  </ol>
</blockquote>

<p><strong>Docker Composr 就是一个核心功能： 批量编排服务</strong>！比如你有10个服务，你可以通过docker-compose up down 一键启停所有服务。</p>

<p>DockerCompose 本质就是Docker官方的一个开源项目，负责实现Docker容器集群的快速编排！</p>

<p>项目地址：<a href="https://github.com/docker/compose">https://github.com/docker/compose</a></p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-on-github.jpg" alt="" /></p>

<blockquote>
  <p>Compose has commands for managing the whole lifecycle of your application:</p>

  <p>Docker-compose 管理你的应用的整个生命周期的命令</p>

  <ul>
    <li>
      <p>Start, stop and rebuild services</p>

      <p>启动、停止、重建服务</p>
    </li>
    <li>
      <p>View the status of running services</p>

      <p>查看服务的状态</p>
    </li>
    <li>
      <p>Stream the log output of running services</p>

      <p>输出服务日志</p>
    </li>
    <li>
      <p>Run a one-off command on a service</p>

      <p>关闭一个服务的命令</p>
    </li>
  </ul>
</blockquote>

<h3 id="安装">安装</h3>

<p>确保服务器已安装docker引擎，然后选择 docker compose所对应的系统版本安装</p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-install-on-os.jpg" alt="" /></p>

<p>1、下载</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在linux上安装docker compose,它依赖下面的一些python环境</span>
py-pip, python-dev, libffi-dev, openssl-dev, gcc, libc-dev, and make.
<span class="c"># 使用yum安装这些依赖</span>
yum <span class="nb">install</span> <span class="nt">-y</span> py-pip
<span class="c"># 1、下载，这个网络十分慢，有可能还下载失败！</span>
<span class="nb">sudo </span>curl <span class="nt">-L</span> <span class="s2">"https://github.com/docker/compose/releases/download/1.25.5/docker-compose-</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-s</span><span class="si">)</span><span class="s2">-</span><span class="si">$(</span><span class="nb">uname</span> <span class="nt">-m</span><span class="si">)</span><span class="s2">"</span> <span class="nt">-o</span> /usr/local/bin/docker-compose

<span class="c"># 这个可能快点！16.7m大小 docker-compose </span>
curl <span class="nt">-L</span> https://get.daocloud.io/docker/compose/releases/download/1.25.5/docker-compose-<span class="sb">`</span><span class="nb">uname</span> <span class="nt">-s</span><span class="sb">`</span>-<span class="sb">`</span><span class="nb">uname</span> <span class="nt">-m</span><span class="sb">`</span> <span class="o">&gt;</span> /usr/local/bin/docker-compose

<span class="c"># 如果第一步没有下载下来，我们就手动去网站下载即可！</span>
<span class="c"># 地址：https://github.com/docker/compose/releases</span>
<span class="c"># 下载：docker-compose-Linux-x86_64</span>
<span class="c"># 然后将文件上传到 /usr/local/bin/ 文件夹下，然后将其重命名为docker-compose</span>

<span class="c"># 2、修改此文件的权限，增加可执行</span>
<span class="nb">sudo chmod</span> +x /usr/local/bin/docker-compose

<span class="c"># 查看版本信息，确认安装成功</span>
<span class="o">[</span>root@alibaba bin]# docker-compose version
docker-compose version 1.25.5, build 8a1c60f6
docker-py version: 4.1.0
CPython version: 3.7.5
OpenSSL version: OpenSSL 1.1.0l  10 Sep 2019

<span class="c"># 3、卸载docker compose</span>
<span class="nb">sudo rm</span> /usr/local/bin/docker-compose
</code></pre></div></div>

<p>2、赋予权限</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> +x /usr/local/bin/docker-compose
</code></pre></div></div>

<h3 id="快速开始">快速开始</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># pip 是Pyhon的包管理工具！</span>
<span class="o">[</span>root@alibaba bin]# yum <span class="nb">install</span> <span class="nt">-y</span> python-pip  
</code></pre></div></div>

<p>用一个简单的python web 应用：基于Flask框架，维护redis中的访问数的web应用。快速开始docker-compose,参考文档：https://docs.docker.com/compose/gettingstarted/</p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-getstart-with-python-webapp.jpg" alt="" /></p>

<p>按照官方文档走一篇</p>

<blockquote>
  <p>Python例子</p>
</blockquote>

<p>1、配置</p>

<ul>
  <li>
    <p>创建项目目录</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="o">[</span>root@alibaba www]# <span class="nb">mkdir </span>composetest
  <span class="o">[</span>root@alibaba www]# <span class="nb">cd </span>composetest
</code></pre></div>    </div>
  </li>
  <li>
    <p>composetest下创建一个app.py python文件，复制下面代码</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
  
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
  
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'redis'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
  
<span class="k">def</span> <span class="nf">get_hit_count</span><span class="p">():</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s">'hits'</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">redis</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="nb">ConnectionError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span>
            <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
  
<span class="c1"># 路由，把看了多少次的次数丢回来           
</span><span class="o">@</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">get_hit_count</span><span class="p">()</span>
    <span class="k">return</span> <span class="s">'Hello World! I have been seen {} times.</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>composetest定义另一个requirements.txt文件，复制下面内容，其实就是定义依赖包</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>flask
redis
</code></pre></div>    </div>
  </li>
</ul>

<p>2、创建一个Dockerfile，通过它构建镜像</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载python3.7作为基础镜像</span>
FROM python:3.7-alpine
<span class="c"># 设置工作目录</span>
WORKDIR /code
<span class="c"># 设置两个环境变量</span>
ENV FLASK_APP app.py
ENV FLASK_RUN_HOST 0.0.0.0
<span class="c"># 安装gcc，一些环境的添加</span>
RUN apk add <span class="nt">--no-cache</span> gcc musl-dev linux-headers
<span class="c"># 导入requirements.txt文件，安装依赖，也就是flask和redis</span>
COPY requirements.txt requirements.txt
RUN pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
<span class="c"># 复制当前目录文件到镜像里的工作目录，</span>
COPY <span class="nb">.</span> <span class="nb">.</span>
<span class="c"># 运行起来，类似于java -jar 命令</span>
CMD <span class="o">[</span><span class="s2">"flask"</span>, <span class="s2">"run"</span><span class="o">]</span>
</code></pre></div></div>

<p>3、在Compose 文件定义服务</p>

<p>创建一个docker-compose.yml文件，定义web和redis俩个服务，复制下面内容</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: <span class="s1">'3'</span>
<span class="c"># 可以有多个服务</span>
services:
  web:
  	<span class="c"># 相当于docker build，很多的编排指令！</span>
    build: <span class="nb">.</span>
    ports:
      - <span class="s2">"5000:5000"</span>
  redis:
    image: <span class="s2">"redis:alpine"</span>
</code></pre></div></div>

<p>web服务，是使用当前目录下的Dockerfile build创建的镜像，它绑定的是宿主机的5000端口到容器内flask web server的默认5000端口</p>

<p>redis服务，是从Docker hub 仓库拉取的公共Redis镜像</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 已有4个文件</span>
<span class="o">[</span>root@alibaba composetest]# <span class="nb">ls
</span>app.py  Dockerfile  requirements.txt docker-compose.yml
</code></pre></div></div>

<p>4、使用Compose 创建和运行你的应用</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 建议先单独pull拉取 python 和redis两个镜像到服务器</span>
<span class="o">[</span>root@alibaba composetest]# docker pull python:3.7-alpine
<span class="o">[</span>root@alibaba composetest]# docker pull redis:alpine
<span class="c"># 要在项目目录下执行docker-compose up</span>
<span class="o">[</span>root@alibaba composetest]# docker-compose up
<span class="c"># 启动关闭</span>
docker-compse up / down
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-up1.jpg" alt="" /></p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-up2.jpg" alt="" /></p>

<p>浏览器 访问 http://localhost:5000/ ， see the application running.服务器防火墙和安全组要开放5000端口</p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-up3.jpg" alt="" /></p>

<p>发现通过 docker-compse up，会阻塞控制台！我再打开一个控制台，使用curl命令测试</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba ~]# curl localhost:5000
Hello World! I have been seen 1 times.
<span class="o">[</span>root@alibaba ~]# curl localhost:5000
Hello World! I have been seen 2 times.
</code></pre></div></div>

<p>查看镜像</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba ~]# docker images
REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE
composetest_web       latest              2f7c2a237d5f        11 minutes ago      227MB
redis                 alpine              b546e82a6d0e        17 hours ago        31.5MB
</code></pre></div></div>

<p>关闭应用</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在项目目录下执行</span>
<span class="o">[</span>root@alibaba composetest]# docker-compose down
Stopping composetest_redis_1 ... <span class="k">done
</span>Stopping composetest_web_1   ... <span class="k">done</span>
<span class="c"># 对应的容器也会删除，docker ps -a 命令查看</span>
Removing composetest_redis_1 ... <span class="k">done
</span>Removing composetest_web_1   ... <span class="k">done</span>
<span class="c"># 网络也会删除</span>
Removing network composetest_default
</code></pre></div></div>

<p>5、修改docker-compose.yml文件，增加数据卷的挂载，指定Flask为开发环境</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">5000:5000"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">.:/code</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">FLASK_ENV</span><span class="pi">:</span> <span class="s">development</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">redis:alpine"</span>
</code></pre></div></div>

<p>把宿主机的当前目录和容器内的/code目录做挂载，这样你修改了代码，也不用重建镜像（传统的做法：进入容器修改，修改完后通过commit 容器重建成为新的镜像）。环境变量FLASK_ENV为开发者模式，当代码被修改后会自动reload 重新运行web应用，开发中使用开发模式很方便。</p>

<p>6、使用Compose 重建创建和运行你的应用</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba composetest]# docker-compose up
</code></pre></div></div>

<p>运行成功，查看运行的容器</p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-up-containers.jpg" alt="" /></p>

<p>7、更新应用app.py</p>

<p>因为已经将容器内的/code目录挂载到了项目目录下，所以我们可以直接修改代码app.py，马上看到效果，不用重建镜像</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 修改app.py，返回的message 修改为</span>
<span class="o">[</span>root@alibaba composetest]# vim app.py 
<span class="k">return</span> <span class="s1">'Hello from Docker! I have been seen {} times.\n'</span>.format<span class="o">(</span>count<span class="o">)</span>

<span class="c"># 马上访问测试，返回信息已经变了</span>
<span class="o">[</span>root@alibaba composetest]# curl localhost:5000
Hello from Docker! I have been seen 4 times.
</code></pre></div></div>

<p>8、-d后台运行，查看compose的状态</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 后台运行 </span>
docker-compose up <span class="nt">-d</span>

<span class="c"># 停止服务，与down的区别是不会移除容器，也就是可以通过start重启服务</span>
<span class="o">[</span>root@alibaba composetest]# docker-compose stop
Stopping composetest_web_1   ... <span class="k">done
</span>Stopping composetest_redis_1 ... <span class="k">done</span>
<span class="o">[</span>root@alibaba composetest]# docker-compose start
Starting web   ... <span class="k">done
</span>Starting redis ... <span class="k">done</span>
<span class="o">[</span>root@alibaba composetest]# curl localhost:5000 
Hello from DockerCompose! I have been seen 5 times.

<span class="c"># 查看运行的服务</span>
<span class="o">[</span>root@alibaba composetest]# docker-compose ps
       Name                      Command               State           Ports         
<span class="nt">-------------------------------------------------------------------------------------</span>
composetest_redis_1   docker-entrypoint.sh redis ...   Up      6379/tcp              
composetest_web_1     flask run                        Up      0.0.0.0:5000-&gt;5000/tcp

<span class="c"># 使用down，停止服务并移除容器，传递--vloumes 参数同时移除容器挂载的数据</span>
<span class="c"># 下面使用的是docker 搭建的mywordpress博客</span>
<span class="o">[</span>root@alibaba my_wordpress]# docker-compose down <span class="nt">--volumes</span>
Removing my_wordpress_wordpress_1 ... <span class="k">done
</span>Removing my_wordpress_db_1        ... <span class="k">done
</span>Removing network my_wordpress_default
Removing volume my_wordpress_wordpress_db_data  <span class="c"># 移除挂载目录</span>
</code></pre></div></div>

<blockquote>
  <p>Java 例子</p>
</blockquote>

<p>创建一个Spring Initialzr项目，选择web和redis依赖</p>

<p>1、配置文件application.yml</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 使用服务名连接
</span><span class="py">spring.redis.host</span><span class="p">=</span><span class="s">redis</span>
<span class="c"># 默认端口是6379
</span></code></pre></div></div>

<p>2、web层接口的定义HelloController</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="o">{</span>
	<span class="nd">@Autowired</span>
	<span class="nc">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="o">;</span>


	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">hello</span><span class="o">(){</span>
		<span class="nc">Long</span> <span class="n">view</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">increment</span><span class="o">(</span><span class="s">"view"</span><span class="o">);</span>
		<span class="k">return</span> <span class="s">"Hello from DockerCompose! I have been seen "</span><span class="o">+</span> <span class="n">view</span> <span class="o">+</span><span class="s">" times.\\n"</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3、项目根目录下创建Dockerfile文件</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM java:8
<span class="c"># 拷贝当前目录下的所有jar包到app.jar</span>
COPY <span class="k">*</span>.jar /app.jar
<span class="c"># 配置应用tomcat的端口</span>
CMD <span class="o">[</span><span class="s2">"--server.port=8080"</span><span class="o">]</span>
<span class="c"># 暴露容器的端口</span>
EXPOSE 8080
<span class="c"># 设置容器的入口程序</span>
ENTRYPOINT <span class="o">[</span><span class="s2">"java"</span>,<span class="s2">"-jar"</span>,<span class="s2">"/app.jar"</span><span class="o">]</span>
</code></pre></div></div>

<p>4、项目根目录下创建docker-compose.yml文件，定义web服务和redis服务</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 容器 =》 服务</span>
<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>
<span class="na">services</span><span class="pi">:</span>
<span class="err">	</span><span class="na">compose-web</span><span class="pi">:</span> 
<span class="err">		</span><span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
<span class="err">		</span><span class="na">image</span><span class="pi">:</span> <span class="s">compose-web</span>  <span class="c1"># 指定创建的镜像名称</span>
<span class="err">		</span><span class="na">depends_on</span><span class="pi">:</span>
<span class="err">			</span><span class="pi">-</span> <span class="s">redis</span>
<span class="err">		</span><span class="na">ports</span><span class="pi">:</span> 
<span class="err">			</span><span class="pi">-</span> <span class="s2">"</span><span class="s">8080:8080"</span>
<span class="err">	</span><span class="na">redis</span><span class="pi">:</span> 
    <span class="na">image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">redis:alpine"</span>
</code></pre></div></div>

<p>compose file的官方文档命令： <a href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></p>

<p><img src="/assets/images/2020/icoding/docker/compose-file-command.jpg" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># depends_on</span>
docker-compose up启动服务的依赖顺序
</code></pre></div></div>

<p>5、项目compose-web打包</p>

<p><img src="/assets/images/2020/icoding/docker/compose-web-package.jpg" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 创建项目目录composejava</span>
<span class="o">[</span>root@alibaba www]# <span class="nb">mkdir </span>composejava
<span class="o">[</span>root@alibaba www]# <span class="nb">cd </span>composejava
<span class="c"># 上传Dockerfile、docker-compose.yml、项目运行jar包到当前目录</span>
<span class="o">[</span>root@alibaba composejava]# <span class="nb">ls
</span>compose-web-0.0.1-SNAPSHOT.jar  docker-compose.yml  Dockerfile
</code></pre></div></div>

<p>6、使用Compose 创建和运行你的应用</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 要在项目目录下执行docker-compose up</span>
<span class="o">[</span>root@alibaba composejava]# docker-compose up
<span class="c"># 后台运行 docker-compose up --help 帮助命令</span>
<span class="o">[</span>root@alibaba composejava]# docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>第一步，先去下载java:8镜像</p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-java-step1.jpg" alt="" /></p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-java-step2.jpg" alt="" /></p>

<p>使用curl命令测试</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba composejava]# curl localhost:8080
Hello from DockerCompose! I have been seen 1 times.
<span class="o">[</span>root@alibaba composejava]# curl localhost:8080 
</code></pre></div></div>

<h3 id="细节探究">细节探究</h3>

<p><strong>1、容器</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># docker-compose up运行后，查询容器</span>
<span class="o">[</span>root@alibaba www]# docker ps
CONTAINER ID        IMAGE                 PORTS                    NAMES
ac4cf875adaf        compose-web           0.0.0.0:8080-&gt;8080/tcp   composejava_compose-web_1
1433dacfbe39        redis:alpine        6379/tcp                 	composejava_redis_1

<span class="c"># 镜像名：在 docker-compse.yml 中命名！</span>
<span class="c"># 容器名：composejava_compose-web_1   composejava_redis_1</span>
<span class="c"># 容器名默认规则： contextName(上下文，项目目录名)_服务名_num ，服务名在 docker-compse.yml中命名，num 按 1、2、3、4...副本（实例）可以有多个，</span>
<span class="c"># 容器名后面的_1，就是代表了有几个副本，集群状态下，我们可以定义一个服务在多个机器下都有副本！ 高可用！</span>
</code></pre></div></div>

<p><strong>2、网络</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba composejava]# docker network <span class="nb">ls
</span>NETWORK ID          NAME                  DRIVER              SCOPE
ff7225883433        bridge                bridge              <span class="nb">local
</span>4761487649f4        composejava_default   bridge              <span class="nb">local
</span>25538e0aaebc        host                  host                <span class="nb">local
</span>1da6a07a9ace        none                  null                <span class="nb">local</span>

<span class="c"># docker-compse up 服务上线之后，自动多一个网络 composejava_default。</span>
<span class="c"># docker-compose.yml 在同一服务编排下，会在同一个网络下！网络名格式：contextName(上下文，项目目录名)_default </span>
<span class="c"># 可以在docker-compose.yml 中设置</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-network.jpg" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看网络的全部信息</span>
<span class="o">[</span>root@alibaba composejava]# docker inspect 4761487649f4
  <span class="s2">"Containers"</span>: <span class="o">{</span>
            <span class="s2">"704a94be9c267f0499604f2c3c4e9e5071f13444b6183e14d5cb3f347097d226"</span>: <span class="o">{</span>
                <span class="s2">"Name"</span>: <span class="s2">"composejava_compose-web_1"</span>,
                <span class="s2">"EndpointID"</span>: <span class="s2">"d1450b0e78cf7cc250f5fb761f1497155b33540521420495df54abf920f7ce6a"</span>,
                <span class="s2">"MacAddress"</span>: <span class="s2">"02:42:ac:15:00:03"</span>,
                <span class="s2">"IPv4Address"</span>: <span class="s2">"172.21.0.3/16"</span>,
                <span class="s2">"IPv6Address"</span>: <span class="s2">""</span>
            <span class="o">}</span>,
            <span class="s2">"800bb7ccba16a7d8e211b4549914cc96ba63728c64638d956549fc01947d1127"</span>: <span class="o">{</span>
                <span class="s2">"Name"</span>: <span class="s2">"composejava_redis_1"</span>,
                <span class="s2">"EndpointID"</span>: <span class="s2">"9f5d6e45c35296c571771c8cd40f7705546871054b1d1e05fce673218b4f1976"</span>,
                <span class="s2">"MacAddress"</span>: <span class="s2">"02:42:ac:15:00:02"</span>,
                <span class="s2">"IPv4Address"</span>: <span class="s2">"172.21.0.2/16"</span>,
                <span class="s2">"IPv6Address"</span>: <span class="s2">""</span>
            <span class="o">}</span>
        <span class="o">}</span>,
<span class="c"># 发现编排的服务都在一个网络中，我们就可以使用服务名来ping通！所以配置application.properties 中spring.redis.host=redis,</span>
<span class="c"># 这个redis是服务名，直接使用服务名来连接</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-service-in-the-same-network.png" alt="" /></p>

<p><strong>3、服务</strong></p>

<p>查看所有的服务信息，我们现在发现是没有的，需要在集群下，就可以看到所有的服务！需要使用docker swarm init ，下面开始讲</p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-service-ls.png" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 停止 = 移除容器 + 移除网络</span>
docker-compose down
<span class="c"># --volumes 使用该参数移除挂载的数据卷</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-down.png" alt="" /></p>

<h3 id="配置说明">配置说明</h3>

<p>1、docker compose cli 客户端命令，通过官方文档学习或者help命令学习</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看docker-compose 帮助命令</span>
<span class="o">[</span>root@alibaba composejava]# docker-compose <span class="nt">--help</span>
Define and run multi-container applications with Docker.

Usage:
  docker-compose <span class="o">[</span><span class="nt">-f</span> &lt;arg&gt;...] <span class="o">[</span>options] <span class="o">[</span>COMMAND] <span class="o">[</span>ARGS...]
  docker-compose <span class="nt">-h</span>|--help

Options:
  <span class="nt">-f</span>, <span class="nt">--file</span> FILE             Specify an alternate compose file 指定compose文件名，默认docker-compse.yml
                              <span class="o">(</span>default: docker-compose.yml<span class="o">)</span> 
  <span class="nt">-p</span>, <span class="nt">--project-name</span> NAME     Specify an alternate project name 指定项目名，默认目录名,上下文
                              <span class="o">(</span>default: directory name<span class="o">)</span> 
  <span class="nt">--verbose</span>                   Show more output
  <span class="nt">--log-level</span> LEVEL           Set log level <span class="o">(</span>DEBUG, INFO, WARNING, ERROR, CRITICAL<span class="o">)</span>
  <span class="nt">--no-ansi</span>                   Do not print ANSI control characters
  <span class="nt">-v</span>, <span class="nt">--version</span>               Print version and <span class="nb">exit</span>
  <span class="nt">-H</span>, <span class="nt">--host</span> HOST             Daemon socket to connect to
  
Commands:
  build              Build or rebuild services  创建服务
  config             Validate and view the Compose file  
  create             Create services
  down               Stop and remove containers, networks, and volumes 关闭服务，移除容器，网络
  events             Receive real <span class="nb">time </span>events from containers 
  <span class="nb">exec               </span>Execute a <span class="nb">command </span><span class="k">in </span>a running container 进入容器
  <span class="nb">help               </span>Get <span class="nb">help </span>on a <span class="nb">command
  </span>images             List images
  <span class="nb">kill               </span>Kill containers
  logs               View output from containers
  pause              Pause services
  port               Print the public port <span class="k">for </span>a port binding
  ps                 List containers
  pull               Pull service images
  push               Push service images
  restart            Restart services
  <span class="nb">rm                 </span>Remove stopped containers
  run                Run a one-off <span class="nb">command
  </span>scale              Set number of containers <span class="k">for </span>a service
  start              Start services
  stop               Stop services
  top                Display the running processes
  unpause            Unpause services
  up                 Create and start containers 
  version            Show the Docker-Compose version information  
</code></pre></div></div>

<p>Docker run -&gt; docker-compose-&gt; swarm</p>

<blockquote>
  <p>docker-compose.yaml  记好三层</p>
</blockquote>

<p>2、docker-compose.yaml的官方文档命令： <a href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-file-doc.jpg" alt="" /></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># docker-compose.yaml  记好三层</span>
<span class="c1"># 第一层 版本</span>
<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>  <span class="c1"># 版本，向下兼容的</span>
<span class="c1"># 第二层 服务</span>
<span class="na">services</span><span class="pi">:</span> <span class="c1"># 服务，可以有一个和多个</span>
<span class="err">	</span><span class="s">服务1</span><span class="pi">:</span>
<span class="err">		</span><span class="c1"># 服务的具体配置（build、端口、挂载卷、网络、command、容器名、depends_on:启动顺序，deploy：集群多个服务实例replicas）</span>
<span class="err">	</span><span class="s">服务2</span><span class="pi">:</span> 
<span class="err">	</span>  <span class="c1"># 服务的具体配置（build、端口、挂载卷、网络、command、容器名、depends_on:启动顺序，deploy：集群多个服务实例replicas）</span>
<span class="err">	</span><span class="s">....</span>
<span class="c1"># 第三层 其他配置</span>
<span class="s">networks  容器(服务)运行的网络配置</span>
<span class="s">volumes   挂载卷的配置</span>
<span class="s">secrets   安全</span>
<span class="s">config</span>
<span class="nn">...</span>     <span class="s">配置相关的！</span>

<span class="c1"># docker stack 一个完整的应用很多的服务的，就是一个 服务栈（网站！）deploy的配置只会在swarm架构中使用docker stack 部署才会生效</span>
</code></pre></div></div>

<ul>
  <li>
    <p>例子1 网络</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.8"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">hostnet</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="na">networks</span><span class="pi">:</span>
  <span class="na">hostnet</span><span class="pi">:</span>
    <span class="na">external</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">host</span> 
</code></pre></div>    </div>
  </li>
  <li>
    <p>例子2 挂载卷</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.8"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:alpine</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">volume</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">mydata</span>
        <span class="na">target</span><span class="pi">:</span> <span class="s">/data</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">nocopy</span><span class="pi">:</span> <span class="no">true</span>
      <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">bind</span>
        <span class="na">source</span><span class="pi">:</span> <span class="s">./static</span>
        <span class="na">target</span><span class="pi">:</span> <span class="s">/opt/app/static</span>
  
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:latest</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">/var/run/postgres/postgres.sock:/var/run/postgres/postgres.sock"</span>  <span class="c1"># 指定目录挂载</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">dbdata:/var/lib/postgresql/data"</span>  <span class="c1"># 具名挂载</span>
  
<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">mydata</span><span class="pi">:</span> <span class="pi">{}</span>  <span class="c1"># 具名挂载，宿主机的目录在docker的默认目录/var/lib/docker/volumes</span>
  <span class="na">dbdata</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>例子3 安全</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.8"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">redis:latest</span>
    <span class="na">deploy</span><span class="pi">:</span>
      <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">my_secret</span>
      <span class="pi">-</span> <span class="s">my_other_secret</span>
<span class="na">secrets</span><span class="pi">:</span>
  <span class="na">my_secret</span><span class="pi">:</span>
    <span class="na">file</span><span class="pi">:</span> <span class="s">./my_secret.txt</span>
  <span class="na">my_other_secret</span><span class="pi">:</span>
    <span class="na">external</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="官方实战-部署wp博客">官方实战-部署wp博客</h3>

<p>官方文档：<a href="https://docs.docker.com/compose/wordpress/">https://docs.docker.com/compose/wordpress/</a></p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-wordpress.jpg" alt="" /></p>

<p>总共两步</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1、第一步定义项目</span>
<span class="c"># 创建项目目录</span>
<span class="o">[</span>root@alibaba www]# <span class="nb">mkdir </span>my_wordpress
<span class="o">[</span>root@alibaba www]# <span class="nb">cd </span>my_wordpress/
<span class="c"># 定义docker-compose.yml</span>
<span class="o">[</span>root@alibaba my_wordpress]# vim dokcer-compose.yml
version: <span class="s1">'3.8'</span>
services:
   db:
     image: mysql:5.7
     volumes:
       - db_data:/var/lib/mysql  <span class="c"># 数据的目录挂载</span>
     restart: always  <span class="c"># </span>
     environment:
       MYSQL_ROOT_PASSWORD: somewordpress   <span class="c"># mysql实例的root密码</span>
       MYSQL_DATABASE: wordpress  <span class="c"># 创建一个wordpress数据库</span>
       MYSQL_USER: wordpress			<span class="c"># 创建一个数据库用户/密码</span>
       MYSQL_PASSWORD: wordpress

   wordpress:
     depends_on:
       - db
     image: wordpress:latest
     ports:
       - <span class="s2">"8000:80"</span>		<span class="c"># 暴露端口，宿主机8080映射到容器内的80</span>
     restart: always
     environment:
       WORDPRESS_DB_HOST: db:3306    <span class="c"># 服务名:端口 mysql实例连接</span>
       WORDPRESS_DB_USER: wordpress
       WORDPRESS_DB_PASSWORD: wordpress		<span class="c"># 连接的用户/密码</span>
       WORDPRESS_DB_NAME: wordpress  <span class="c"># 连接的数据库</span>
volumes:
   db_data: <span class="o">{}</span>  <span class="c"># 具名挂载，表示docker的默认目录/var/lib/docker，运行成功后发现volumes目录下有个mywordpress_db_data</span>
<span class="c"># 先拉取镜像</span>
<span class="o">[</span>root@alibaba my_wordpress]# docker pull mysql:5.7
<span class="o">[</span>root@alibaba my_wordpress]# docker pull wordpress:latest

<span class="c"># 2、第二步创建和运行项目</span>
<span class="o">[</span>root@alibaba my_wordpress]# docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>启动成功，可以访问wp博客了，浏览器 http://服务器ip:8000，进入界面选择语言，进行相关设置，登录博客</p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-wordpress-blog.jpg" alt="" /></p>

<p>这是控制台</p>

<p><img src="/assets/images/2020/icoding/docker/docker-compose-wordpress-blog-admin.jpg" alt="" /></p>

<h3 id="总结">总结</h3>

<p>1、Dockerfile</p>

<p>2、Docker-compose 单机玩玩而已！</p>

<p>3、Docker集群，Docker底层，网络原理,,,,,</p>

<p>以后你们下载的开源项目中，有 Docker-compose.yaml，只需要配置对应的环境即可一键启动！</p>

<h2 id="2docker-swarm">2、Docker Swarm</h2>

<p>企业中，docker绝对是使用集群上线的！</p>

<h3 id="购买服务器">购买服务器</h3>

<p>购买4台服务器，登录阿里云（阿里云余额&gt;200）</p>

<p>1、创建实例</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-buy-aliyun-ecs-01.png" alt="" /></p>

<p>2、配置实例：按量付费+ 地域+共享型（至少1核2G）</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-buy-aliyun-ecs-02.png" alt="" /></p>

<p>3、购买数量4台，选择操作系统CentOS 7.8</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-buy-aliyun-ecs-03.png" alt="" /></p>

<p>4、创建网络和安全组，带宽计费按流量计费 ，安全组打开1/65535端口</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-buy-aliyun-ecs-04.png" alt="" /></p>

<p>5、 系统配置：root密码，实例名称</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-buy-aliyun-ecs-05.png" alt="" /></p>

<p>6、确认订单，创建即可</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-buy-aliyun-ecs-06.png" alt="" /></p>

<p>服务器启动完毕</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-buy-aliyun-ecs-07.png" alt="" /></p>

<p>7、可以互相访问，在一个网络中！使用Xshell连接或者SecureCRT连接4个服务器</p>

<p>把所有的服务器安装上docker！这里有个技巧，可以把命令同步发送到4个会话，同时安装docker!</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-buy-aliyun-ecs-08.png" alt="" /></p>

<p>准备工作结束。</p>

<h3 id="swarm架构">Swarm架构</h3>

<p>打开官方文档 <a href="https://docs.docker.com/engine/swarm/">https://docs.docker.com/engine/swarm/</a></p>

<p><img src="/assets/images/2020/icoding/docker/swarm-doc.jpg" alt="" /></p>

<p><img src="/assets/images/2020/icoding/docker/swarm-cli-commands.jpg" alt="" /></p>

<p>重点swarm架构：3个管理者节点+7个工作者节点</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-arch.png" alt="" /></p>

<p>Manager管理节点是互通的，Worker工作节点是隔离的，每个节点都是一个docker 引擎实例</p>

<p>1、Manager管理节点的作用：</p>

<ul>
  <li>管理集群状态</li>
  <li>调度服务</li>
  <li>使用 raft 一致性协议：集群要在大多数节点可存活的情况下才可以运行，<mark>集群必须要大于3个主节点！</mark></li>
</ul>

<p>2、Worker工作节点的作用：</p>

<ul>
  <li>执行容器</li>
  <li>
    <p>默认的，所有的管理节点都是工作节点，至少一个管理节点</p>
  </li>
  <li><mark>docker service create</mark> 创建服务，实现高可用</li>
</ul>

<p>3、互换角色：运行 docker node promote ，把一个Worker转换为Manager，也可以吧Manager转换为Worker!</p>

<h3 id="搭建一个集群">搭建一个集群</h3>

<p>1、初始网络查看</p>

<p><img src="/assets/images/2020/icoding/docker/docker-network-ls2.png" alt="" /></p>

<p>2、Swarm 命令，核心：初始化+加入+离开+更新</p>

<p><img src="/assets/images/2020/icoding/docker/docker-swarm-help.png" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker swarm init <span class="nt">--help</span>
</code></pre></div></div>

<p>3、省流量，私网ip搭建集群！</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 初始化一个主节点,广播地址</span>
<span class="c"># ip: 172.24.82.145</span>
<span class="c"># 初始化</span>
docker swarm init <span class="nt">--advertise-addr</span> 172.24.83.145
docker1 是一个管理节点，如何加入worker节点，manager节点看截图的命令
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-swarm-init.png" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在主节点（Manager节点）上执行</span>
<span class="c"># 创建一个worker token</span>
docker swarm join-token worker   
<span class="c"># 创建一个manager token</span>
docker swarm join-token manager  
</code></pre></div></div>

<p>可以颁发一个work token 让其他节点加入集群，也可以颁发，manager token 加入集群！</p>

<p>4、搭建一个worker节点</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在 docker2 上执行join加入swarm 成为一个worker节点 </span>
docker swarm <span class="nb">join</span> <span class="nt">-token</span> SMTKN-1xxxxx.......
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-swarm-join-a-worker.png" alt="" /></p>

<p>5、在主节点docker1上查看集群节点信息，注意：从节点不能操作！主节点操作的！</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在Manager节点上执行</span>
docker node <span class="nb">ls</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-swarm-ls-node.png" alt="" /></p>

<p>6、当前状态。docker-1 manager，docker-2/3 worker、docker4- manager</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在 docker3 上执行join加入swarm 成为一个worker节点 </span>
docker swarm <span class="nb">join</span> <span class="nt">-token</span> SMTKN-1xxxxx.......
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在 docker1上执行创建一个manager token</span>
docker swarm join-token manager 
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/swarm-create-manager-token.jpg" alt="" /></p>

<p>在 docker4 上执行返回的命令，加入swarm集群成为一个Manager节点</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-join-token-as-a-manager.jpg" alt="" /></p>

<p>现在就是一个双主双从的swarm架构</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-cluster-leader-reachable.jpg" alt="" /></p>

<p>7、集群是高可用的，哪挂一个节点还能不能正常使用？</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在 docker1 上执行 停止docker</span>
systemctl stop docker
</code></pre></div></div>

<p><mark>注意</mark>：这里有一个细节， raft 一致性协议：集群要在大多数节点可存活的情况下才可以运行，<mark>集群必须要大于3个主节点！</mark></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在 docker4 上执行查看集群节点状态</span>
docker node <span class="nb">ls</span>

<span class="c"># 发现报错了，集群不可用了，少于一半的管理者节点数</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/swarm-cluster-not-run.jpg" alt="" /></p>

<h3 id="raft-协议核心">Raft 协议(核心)</h3>

<p>目前我们是两个管理节点，如果一个节点挂了，另一个节点也不能使用！</p>

<p>Raft 协议来操作，保证绝对大数节点存活才可以使用，至少存活要大于1台才可以！</p>

<p>在项目中，Swarm 管理节点3个才可以保证高可用！至少3个管理节点，2 &gt; 1.5 ( 3 / 2 = 1.5)</p>

<p><strong>测试</strong></p>

<p>1、docker3离开集群</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在 docker3上执行 离开swarm 集群</span>
docker swarm leave
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/swarm-leave-docker3.jpg" alt="" /></p>

<p>2、docker3 以manger的角色重新加入，配置3个manager</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在主节点docker1 上创建manager token 令牌</span>
docker swarm join-token manager 
<span class="c"># 在docker3上执行返回的命令</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/swarm-cluster-three-manager.jpg" alt="" /></p>

<p>3、现在挂掉一个管理节点，其他管理节点依旧可以使用，集群服务可正常使用</p>

<p>4、如果挂掉两个管理节点，只剩下一个管理节点，这个时候集群服务不可用！</p>

<p><img src="/assets/images/2020/icoding/docker/swarm-cluster-not-run.jpg" alt="" /></p>

<p><strong>Raft 协议：确保大多数节点存活才可用！</strong> &gt; 1  , 集群最低要求，3个管理节点，基本的高可用！生产环境肯定不止3个管理节点</p>

<p>中小企业：原生的docker集群就足够了！ k8s！</p>

<h3 id="测试启动服务重点">测试启动服务(重点)</h3>

<p>从此告别 docker run，   docker compose up，启动服务！</p>

<p>集群，就需要使用 docker service (使用docker管理服务)， 容器（单个） ==&gt; 服务（多个容器实例）</p>

<font color="red">其实本质还是容器，只是在集群状态下，变为了服务！</font>

<p>单机下，compose ，也可以编排上线！单机！</p>

<p>1、创建一个服务！</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># docker service  管理集群中的所有服务</span>
<span class="c"># docker stack    一个完整的应用很多的服务的，就是一个 服务栈！（网站！）</span>
<span class="o">[</span>root@alibaba ~]# docker stack <span class="nt">--help</span>
Usage:  docker stack <span class="o">[</span>OPTIONS] COMMAND
Commands:
  deploy      Deploy a new stack or update an existing stack
  <span class="nb">ls          </span>List stacks
  ps          List the tasks <span class="k">in </span>the stack
  <span class="nb">rm          </span>Remove one or more stacks
  services    List the services <span class="k">in </span>the stack
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-service-help.jpg" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 创建服务</span>
docker service create <span class="nt">-p</span> 8888:80 <span class="nt">--name</span> my-nginx nginx
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-service-create-mynginx.png" alt="" /></p>

<p>2、测试节点访问！<font color="red">我们在集群当前启动的服务，可以在任何一节点访问，配置上负载均衡！</font></p>

<p>现在docker1运行了一个nginx服务，集群内的节点都能正常访问到这个服务</p>

<p><img src="/assets/images/2020/icoding/docker/docker-service-nginx.jpg" alt="" /></p>

<p>3、只有一个容器在里面！那么我们要并发很大，怎么操作！</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 你知道你的公司的大概并发量，初始并发量</span>
docker service create <span class="nt">--replicas</span> n
docker service create <span class="nt">--name</span> my-nginx <span class="nt">-p</span> 8888:80 <span class="nt">--replicas</span> 7 nginx

<span class="c"># 更新服务运行的时候动态扩容！一个服务多个实例，一个实例就是一个容器</span>
docker service update <span class="nt">--replicas</span> n 服务名 
<span class="c"># 降为3个服务实例</span>
docker service update <span class="nt">--replicas</span> 3 my-nginx
<span class="c"># 回滚到上次的服务实例个数</span>
docker service rollback my-nginx 
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-service-update-replicas.jpg" alt="" /></p>

<p>4、使用docker 来部署应用集群，十分的方便！</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看服务在哪些节点上运行</span>
docker service ps my-nginx
</code></pre></div></div>

<p><code class="highlighter-rouge">一个机器，可以运行多个容器，容器相互隔离！</code>,可以看到nginx服务运行在不同的docker节点上，有节点运行多个容器构成一个服务7个容器实例</p>

<p><img src="/assets/images/2020/icoding/docker/docker-service-ps-mynginx.png" alt="" /></p>

<p>5、假设可以设置两个状态：高并发 和 正常流量，<code class="highlighter-rouge">rollback </code>来回切换服务的容器实例个数</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service rollback 服务名 
</code></pre></div></div>

<p>6、7个nginx容器的服务my-nginx的端口是怎么暴露的？</p>

<p>大家疑问：为什么一个容器可以被多台机器访问 Swarm 集群管理，对外暴露的是一个服务，负载均衡=&gt; 服务！</p>

<p><img src="/assets/images/2020/icoding/docker/docker-swarm-balance-mynginx.png" alt="" /></p>

<p>为什么启动了多个容器还是可以访问，80端口对内（容器），对外只有服务的一个8888（在swarm集群上），访问的时候swarm负载均衡到具体的容器节点</p>

<p><img src="/assets/images/2020/icoding/docker/docker-swarm-balance-mynginx2.png" alt="" /></p>

<p>==对外就是一个服务，但是一个服务可以部署在多个节点上，每一个节点又可以启动多个容器服务！容器在内部自身运行，相互隔离！==</p>

<h3 id="灰度发布">灰度发布</h3>

<p>上面使用docker service 解决了服务水平扩展的问题，下面来解决如何灰度发布服务的问题！</p>

<p>灰度发布：项目上线 =&gt; 替换之前的版本！==&gt; 一点点更新！</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service update <span class="nt">--help</span>
<span class="c"># 更新服务，更新版本</span>
<span class="c"># --update-parallelism 最大并行更新服务数，0 就是所有一起更新</span>
<span class="c">#  --update-delay duration    Delay between updates (ns|us|ms|s|m|h)</span>
docker service update <span class="nt">--image</span> nginx:1.18.0-alpine <span class="nt">--update-parallelism</span> 1 <span class="nt">--update-delay</span> 10s my-nginx
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/docker/docker-service-update-version.png" alt="" /></p>

<p>按照自己配置的规则，一点点更新迭代项目上线，依旧保证服务的高可用！(更新的时候总有服务对外是可用的)</p>

<p><img src="/assets/images/2020/icoding/docker/docker-service-update-image-tags.jpg" alt="" /></p>

<h2 id="3核心概念">3、核心概念</h2>

<p>1、<strong>swarm</strong> ： 集群的管理和编排，docker自带的！docker在启动的时候可以初始化一个节点，或者加入一个节点！</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker swarm join-token worker
docker swarm join-token manager 
</code></pre></div></div>

<p>2、<strong>node</strong>：就是docker的一个实例，docker的节点！服务器的数量。节点是可以动态的扩缩容的，只需要加入即可。</p>

<ul>
  <li>管理节点中的容器
    <ul>
      <li>Manager nodes ： 调度任务，管理容器….. 在这里进行操作！每个节点可以跑多个容器</li>
      <li>Worker nodes： 工作的具体容器执行，不对外！ 无法操作的！每个节点可以跑多个容器</li>
      <li>可以角色互换</li>
    </ul>
  </li>
</ul>

<p>3、<strong>service</strong>：就是一个完整的服务，nginx 为例，一个服务下有多个运行的实例！这是一个核心！创建服务就需要在使用指定的容器镜像！</p>

<p>4、<strong>task</strong>：docker容器中执行的命令！</p>

<p><mark>集群和单机其实十分相似！只是多了节点和管理的概念！</mark></p>

<h2 id="4重新部署wp博客">4、重新部署wp博客</h2>

<p>跑一个项目，多个服务（docker-compose.yaml） 编排！</p>

<p>前面我们用docker-compose up 启动一个wp博客服务，下面我们使用docker swarm启动wp博客的服务集群</p>

<p>docker-compose.yml 文件不用修过</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@alibaba my_wordpress]# vim dokcer-compose.yml
version: <span class="s1">'3.8'</span>
services:
   db:
     image: mysql:5.7
     volumes:
       - db_data:/var/lib/mysql  <span class="c"># 数据的目录挂载</span>
     restart: always  <span class="c"># </span>
     environment:
       MYSQL_ROOT_PASSWORD: somewordpress   <span class="c"># mysql实例的root密码</span>
       MYSQL_DATABASE: wordpress  <span class="c"># 创建一个wordpress数据库</span>
       MYSQL_USER: wordpress			<span class="c"># 创建一个数据库用户/密码</span>
       MYSQL_PASSWORD: wordpress

   wordpress:
     depends_on:
       - db
     image: wordpress:latest
     ports:
       - <span class="s2">"8000:80"</span>		<span class="c"># 暴露端口，宿主机8080映射到容器内的80</span>
     restart: always
     environment:
       WORDPRESS_DB_HOST: db:3306    <span class="c"># 服务名:端口 mysql实例连接</span>
       WORDPRESS_DB_USER: wordpress
       WORDPRESS_DB_PASSWORD: wordpress		<span class="c"># 连接的用户/密码</span>
       WORDPRESS_DB_NAME: wordpress  <span class="c"># 连接的数据库</span>
volumes:
   db_data: <span class="o">{}</span>  <span class="c"># 具名挂载，表示dock</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># wp博客下线，之前挂在的数据不会被删除的</span>
<span class="o">[</span>root@alibaba my_wordpress]# docker-compose down
Removing my_wordpress_wordpress_1 ... <span class="k">done
</span>Removing my_wordpress_db_1        ... <span class="k">done
</span>Removing network my_wordpress_default

<span class="c"># 以服务的形式启动wp博客</span>
<span class="o">[</span>root@alibaba my_wordpress]# docker service create  <span class="nt">-p</span> 8080:80 <span class="nt">--name</span> wpblog wordpress
</code></pre></div></div>

<p>微服务-&gt;使用Dockerfile构建镜像-&gt;使用docker-composd.yml编排容器-&gt;通过docker swarm 上线集群</p>

<p><img src="/assets/images/2020/icoding/docker/docker-service-myworkdpress.jpg" alt="" /></p>

<p>访问wp博客:http://47.113.95.179:8080</p>

<p><img src="/assets/images/2020/icoding/docker/mywordpress-blog.jpg" alt="" /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 动态扩容wp博客的服务实例个数</span>
docker service update <span class="nt">--replicas</span> 3 wpblog 

<span class="c"># 扩容后有个问题，mysql数据库变成了每个docker节点下都有一个，数据的一致性有问题，应该把数据库独立出来连接</span>
<span class="c"># 修过dokcer-compose.yml</span>
<span class="o">[</span>root@alibaba my_wordpress]# vim dokcer-compose.yml 
version: <span class="s1">'3.8'</span>

 services:
   wordpress:
     image: wordpress:latest
     ports:
       - <span class="s2">"8000:80"</span>
     restart: always
     environment:
       WORDPRESS_DB_HOST: 172.18.196.184:3306
       WORDPRESS_DB_USER: jude
       WORDPRESS_DB_PASSWORD: jude#666
       WORDPRESS_DB_NAME: wordpress2
<span class="c"># 创建服务镜像       </span>
<span class="o">[</span>root@alibaba my_wordpress]# dcoker-compose create 
<span class="c"># 创建服务</span>
<span class="o">[</span>root@alibaba my_wordpress]# docker service create  <span class="nt">-p</span> 8000:80 <span class="nt">--name</span> wpblog wordpress
<span class="c"># 动态扩容服务实例</span>
docker service update <span class="nt">--replicas</span> 3 wpblog
</code></pre></div></div>

<p><img src="/assets/images/2020/springcloud/docker-service-wpblog.jpg" alt="" /></p>

<p>访问http://47.113.95.179:8080，进入界面选择语言，进行相关设置，登录博客</p>

<p><img src="/assets/images/2020/icoding/docker/wpblog-admin.jpg" alt="" /></p>

<p><img src="/assets/images/2020/icoding/docker/docker-service-update-wpblog-replicas.jpg" alt="" /></p>

<p><img src="/assets/images/2020/icoding/docker/wpblog-services.jpg" alt="" /></p>


            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-edu/2020/06/09/icoding-note-046.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
