<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 飞天班第42节：ActiveMQ消息队列实战-2 - 大伟的博客 </title>
    <meta name="keywords" content="activemq">
    <meta name="description"
          content="使用Broker内嵌一个MQ服务到代码中,SpringBoot集成ActiveMQ,ActiveMQ的传输协议，消息持久化到数据库,集群，异步投递，定时延时投递，消息重放，死信队列，ActiveMQ知识点总结">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-edu/2020/05/31/icoding-note-042.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="飞天班第42节：ActiveMQ消息队列实战-2">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>飞天班第42节：ActiveMQ消息队列实战-2</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/05/31
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1broker">1、Broker</h2>

<p>MQ 可以单独启动的一个服务，也可以使用Broker内置到代码中不用单独部署。</p>

<p>把MQ服务嵌入到代码中：<a href="activemq.apache.org/how-do-i-embed-a-broker-inside-a-connection">activemq.apache.org/how-do-i-embed-a-broker-inside-a-connection</a></p>

<p><img src="/assets/images/2020/icoding/mq/broker.gif" alt="" /></p>

<p>在昨天的项目中</p>

<p>1、导入依赖包</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.11.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、创建一个Broker server</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.broker.BrokerService</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmbedBroker</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// 1.创建服务</span>
        <span class="nc">BrokerService</span> <span class="n">broker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BrokerService</span><span class="o">();</span>

        <span class="c1">// 2、配置连接地址</span>
        <span class="c1">// jmx是java的一个新框架</span>
        <span class="c1">// 允许将我们所有的资源（软件和硬件）封装一个Java对象，直接暴露在服务中即可使用</span>
        <span class="n">broker</span><span class="o">.</span><span class="na">setUseJmx</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">broker</span><span class="o">.</span><span class="na">addConnector</span><span class="o">(</span><span class="s">"tcp://localhost:61616"</span><span class="o">);</span>

        <span class="c1">// 3、启动</span>
        <span class="n">broker</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>启动</p>

<p><img src="/assets/images/2020/icoding/mq/broker-start.gif" alt="" /></p>

<p>3、使用队列测试</p>

<p><img src="/assets/images/2020/icoding/mq/broker-producer.gif" alt="" /></p>

<p><img src="/assets/images/2020/icoding/mq/broker-consumer.gif" alt="" /></p>

<p>发现和之前启动的MQ服务效果是一样的，这样子方便测试，不用独立部署一个MQ服务。</p>

<h2 id="2整合到springboot">2、整合到SpringBoot</h2>

<h3 id="创建项目">创建项目</h3>

<p>新建一个springboot项目，可以使用spring initializer</p>

<p>1、导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-activemq<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>全局搜索自动配置类ActiveMQAutoConfiguration</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-auto-configuration.gif" alt="" /></p>

<p>点进<strong>JmsAutoConfiguration.class</strong></p>

<p>里面创建了两个bean：<strong>jmsTemplate</strong>和<strong>jmsMessagingTemplate</strong>，后者是基于前者创建的bean，springboot中我们使用<strong>jmsMessagingTemplate</strong> 模板类发送消息</p>

<p><img src="/assets/images/2020/icoding/mq/jmstempalte.gif" alt="" /></p>

<p>点进<strong>ActiveMQConnectionFactoryConfiguration.class</strong></p>

<p>里面创建了一个bean：<strong>jmsConnectionFactory</strong>，连接activemq 服务</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-connection-factory.gif" alt="" /></p>

<p>2、application.yaml配置</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">6666</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">activemq</span><span class="pi">:</span>
    <span class="na">broker-url</span><span class="pi">:</span> <span class="s">tcp://127.0.0.1:61616</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">admin  </span><span class="err">	</span><span class="s"># 登录activemq 控制台的用户密码</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">admin</span>
  <span class="na">jms</span><span class="pi">:</span>
    <span class="na">pub-sub-domain</span><span class="pi">:</span> <span class="no">false</span> <span class="c1"># false 队列，true 主题，看JmsProperties文件，默认就是false,使用队列</span>

<span class="na">myqueue</span><span class="pi">:</span> <span class="s">coding-queue</span>
</code></pre></div></div>

<h3 id="队列queue">队列Queue</h3>

<blockquote>
  <p>消息生产者</p>
</blockquote>

<p>1、编写bean，定义一个myqueue</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.command.ActiveMQQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jms.annotation.EnableJms</span><span class="o">;</span>

<span class="c1">// 注意导包，util java中的队列</span>
<span class="c1">// JMS 下的队列</span>
<span class="kn">import</span> <span class="nn">javax.jms.Queue</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableJms</span> <span class="c1">// 声明对 JMS 注解支持</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActiveMQConfig</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${myqueue}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">myqueue</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Queue</span> <span class="nf">myqueue</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ActiveMQQueue</span><span class="o">(</span><span class="n">myqueue</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2、业务实现类QueueProduceService</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QueueProduceService</span> <span class="o">{</span>
	<span class="nd">@Autowired</span>
	<span class="nc">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="o">;</span>

	<span class="nd">@Autowired</span>
	<span class="nc">Queue</span> <span class="n">myqueue</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">produceMsg</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">myqueue</span><span class="o">,</span><span class="s">"生产者发送一个消息"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3、web层接口</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActiveMQController</span> <span class="o">{</span>
	<span class="nd">@Autowired</span>
	<span class="nc">QueueProduceService</span> <span class="n">queueProduceService</span><span class="o">;</span>

	<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/queue/send"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">queueSend</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">queueProduceService</span><span class="o">.</span><span class="na">produceMsg</span><span class="o">();</span>
		<span class="k">return</span> <span class="s">"消息发送成功"</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>启动项目，访问http://localhost:8080/queue/send，消息发送成功</p>

<p><img src="/assets/images/2020/icoding/mq/spring-boot-queue-send.png" alt="" /></p>

<blockquote>
  <p>定时发送消息</p>
</blockquote>

<p>1、编写定时发送消息的任务，业务实现类QueueProduceService 添加</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="c1">// 每隔3秒 发送一次</span>
	<span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedDelay</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">produceMsgScheduled</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">myqueue</span><span class="o">,</span><span class="s">"系统定时发送一个消息"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"系统正在定时发送消息....."</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>2、启动类添加注解@EnableScheduling支持定时</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableScheduling</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringbootActivemqApplication</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">SpringbootActivemqApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>启动项目测试</p>

<p><img src="/assets/images/2020/icoding/mq/spring-boot-queue-send-secheduled.gif" alt="" /></p>

<blockquote>
  <p>消息消费者</p>
</blockquote>

<p>编写一个消费业务，使用@JmsListener监听某个队列，接收消息</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QueueConsumerService</span> <span class="o">{</span>

	<span class="c1">// 通过监听注解实现消息接收。</span>
	<span class="c1">// 具体消费  目的地：（队列还是主题）  接收到的消息</span>
	<span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span><span class="o">=</span> <span class="s">"${myqueue}"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="o">(</span><span class="nc">TextMessage</span> <span class="n">textMessage</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
		<span class="c1">// 接收消息</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>启动项目，前面消息生产者已发送了好几个消息，队列是默认持久化消息的，所以启动后消费者马上监听到之前的消息，并消费它</p>

<p><img src="/assets/images/2020/icoding/mq/spring-boot-queue-consumer.gif" alt="" /></p>

<p><img src="/assets/images/2020/icoding/mq/spring-boot-queue-consumer2.gif" alt="" /></p>

<h3 id="主题topic">主题Topic</h3>

<p>修改application.yaml配置文件</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
<span class="err">	</span><span class="na">jms</span><span class="pi">:</span>
    <span class="na">pub-sub-domain</span><span class="pi">:</span> <span class="no">true</span> <span class="c1"># 使用主题</span>
<span class="na">mytopic</span><span class="pi">:</span> <span class="s">coding-topic</span>    
</code></pre></div></div>

<blockquote>
  <p>消息生产者</p>
</blockquote>

<p>1、ActiveMQConfig 编写bean，定义mytopic</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 注意导包，JMS下的主题</span>
<span class="kn">import</span> <span class="nn">javax.jms.Topic</span><span class="o">;</span>

<span class="nd">@Value</span><span class="o">(</span><span class="s">"${mytopic}"</span><span class="o">)</span>
<span class="kd">private</span> <span class="nc">String</span> <span class="n">mytopic</span><span class="o">;</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">Topic</span> <span class="nf">mytopic</span><span class="o">(){</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">ActiveMQTopic</span><span class="o">(</span><span class="n">mytopic</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2、业务实现类TopicProduceService</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TopicProduceService</span> <span class="o">{</span>
	<span class="nd">@Autowired</span>
	<span class="nc">JmsMessagingTemplate</span> <span class="n">jmsMessagingTemplate</span><span class="o">;</span>

	<span class="nd">@Autowired</span>
	<span class="nc">Topic</span> <span class="n">mytopic</span><span class="o">;</span> <span class="c1">// 注意导包，JMS下的主题</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">produceMsg</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">mytopic</span><span class="o">,</span><span class="s">"生产者发送一个主题消息"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3、web层接口ActiveMQController</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/topic/send"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">topicSend</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">topicProduceService</span><span class="o">.</span><span class="na">produceMsg</span><span class="o">();</span>
  <span class="k">return</span> <span class="s">"主题消息发送成功"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>消息消费者</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 启动两个订阅者监听</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TopicConsumerService</span> <span class="o">{</span>
	<span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span><span class="o">=</span> <span class="s">"${mytopic}"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive1</span><span class="o">(</span><span class="nc">TextMessage</span> <span class="n">textMessage</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
		<span class="c1">// 接收消息</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"订阅者1号："</span> <span class="o">+</span> <span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span><span class="o">=</span> <span class="s">"${mytopic}"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive2</span><span class="o">(</span><span class="nc">TextMessage</span> <span class="n">textMessage</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
		<span class="c1">// 接收消息</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"订阅者2号："</span> <span class="o">+</span> <span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>启动项目，这时消费者已经开始订阅主题了，浏览器访问http://localhost:8080/topic/send，生产者发送主题消息</p>

<p>两个订阅者都会收到消息：</p>

<p><img src="/assets/images/2020/icoding/mq/spring-boot-topic-conumer.gif" alt="" /></p>

<h3 id="小结">小结</h3>

<p>SpringBoot去集成任何一个第三方框架，套路都是相同的。</p>

<p>1、导入依赖</p>

<p>2、寻找配置 ， 全局搜索xxxxAutoConfig 和 xxxxProperties</p>

<p>3、查看源码，</p>

<p>4、编写Bean，然后测试使用</p>

<h2 id="3activemq传输协议">3、ActiveMQ传输协议</h2>

<p>activemq支持多种传输协议：amqp、mqtt、ssl、tcp、nio、udp、ssl、https、http等，具体看官网</p>

<p><a href="http://activemq.apache.org/configuring-version-5-transports.html">http://activemq.apache.org/configuring-version-5-transports.html</a></p>

<h3 id="配置说明">配置说明</h3>

<p>activemq的所有配置都在<font color="red">activemq.xml</font>里，在activemq根目录conf下，配置连接方式如下图</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-xml-transportors.png" alt="" /></p>

<p>uri格式： 协议名称：//地址:端口号</p>

<p>发现其他的名称都是和协议对等的，但是  openwire 对应的是tcp。</p>

<p><strong>ActiveMQ 默认的协议就是 openwire</strong></p>

<p>登录ActiveMQ的控制台，看看当前activemq支持的协议</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-admin-connections.png" alt="" /></p>

<h3 id="传输协议基本分析">传输协议基本分析</h3>

<ul>
  <li>
    <p>TCP 默认协议</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcp://0.0.0.0:61616?key<span class="o">=</span>value&amp;key<span class="o">=</span>value
</code></pre></div>    </div>

    <p>activemq.xml里的配置名称叫openwire，<a href="http://activemq.apache.org/openwire">http://activemq.apache.org/openwire</a></p>

    <p><img src="/assets/images/2020/icoding/mq/openwire-java.gif" alt="" /></p>

    <p>参数配置，官网地址<a href="http://activemq.apache.org/tcp-transport-reference">http://activemq.apache.org/tcp-transport-reference</a></p>

    <p><img src="/assets/images/2020/icoding/mq/tcp-transport-reference.gif" alt="" /></p>
  </li>
  <li>
    <p>Nio</p>

    <p>Nio 和 tcp 很类似。 NIO 更偏向底层的访问操作。</p>

    <p>什么情况下使用NIO。</p>

    <ul>
      <li>可能存在<font color="red">大量的客户端</font>去连接消息队列服务器，默认tcp被限制的，一个tcp连接相当于一个线程，开启太多线程肯定不行，占有太多资源。</li>
      <li>默认Tcp(3次握手)，可能会有些迟钝，这时候NIO 效率也会比 Tcp高</li>
    </ul>

    <p>activemq.xml 添加支持nio传输协议</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;transportConnectors&gt;</span>
  <span class="c">&lt;!--端口不要冲突--&gt;</span>
  <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">"nio"</span> <span class="na">uri=</span><span class="s">"nio://0.0.0.0:61617"</span><span class="nt">/&gt;</span>  <span class="err">&lt;</span>/<span class="nt">&lt;transportConnectors&gt;</span>
</code></pre></div>    </div>

    <p>修改后，重启activemq</p>

    <blockquote>
      <p>nio的增强，让一个端口同时支持nio和ssl协议</p>
    </blockquote>

    <p><img src="/assets/images/2020/icoding/mq/nio-ssl.png" alt="" /></p>
  </li>
  <li>
    <p>AMQP</p>

    <p>一个消息服务层的协议，很多语言都可以去实现它。我们基于这个协议，客户端和消息中间件传递消息。</p>
  </li>
  <li>
    <p>STOMP</p>

    <p>简单文本协议。</p>
  </li>
  <li>
    <p>SSL</p>

    <p>安全套接字协议</p>
  </li>
  <li>
    <p>MQTT</p>

    <p>Iot设备，物联网相关的传输协议</p>
  </li>
</ul>

<blockquote>
  <p>使用其他协议测试连接</p>
</blockquote>

<p>启动springboot 项目，登录ActiveMQ的控制台查看当前的连接，默认是使用openwire tcp协议进行连接的</p>

<p><img src="/assets/images/2020/icoding/mq/connector-openwire.gif" alt="" /></p>

<p>修改application.yaml配置文件</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">activemq</span><span class="pi">:</span>
    <span class="na">broker-url</span><span class="pi">:</span> <span class="s">nio://127.0.0.1:61617</span>
</code></pre></div></div>

<p>重启springboot项目，再登录ActiveMQ的控制台查看当前的连接，看它使用的是否使用nio协议进行连接的</p>

<p>云服务器安全组只支持开放tcp/udp协议端口，所以这个测试不了。</p>

<p>本地使用broker开启一个nio协议的mq服务，发现可以正常接收消息</p>

<p><img src="/assets/images/2020/icoding/mq/broker-nio-mq.gif" alt="" /></p>

<h2 id="4消息持久化到db">4、消息持久化到DB</h2>

<h3 id="kahadb默认">KahaDB(默认)</h3>

<p>MQ 宕机了，数据会丢失，所以需要持久化！持久化的方式：JDBC 、KahaDB、LevelDB ，无论使用什么DB 来存储，道理相同，两步：</p>

<ul>
  <li>
    <p>消息发送出去（将数据存储到本地的数据库文件中）</p>
  </li>
  <li>
    <p>消息接收成功（删除这个记录)</p>
  </li>
</ul>

<p>在ActiveMQ的data文件夹下面，有个kahadb</p>

<p><img src="/assets/images/2020/icoding/mq/kahadb.png" alt="" /></p>

<p>ActiveMQ默认就是把消息持久化到kahadb，看配置文件activemq.xml</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-xml-persitence.png" alt="" /></p>

<p>消息持久化更多信息，请看官网 <a href="http://activemq.apache.org/persistence.html">http://activemq.apache.org/persistence.html</a></p>

<p><img src="/assets/images/2020/icoding/mq/persistence.gif" alt="" /></p>

<p>如果需要配置自己的持久化策略，就可以在这里进行配置。</p>

<p><strong>KahaDB特性：</strong></p>

<p><strong>1、日志的方式存储的信息</strong></p>

<p>2、B-Tree 索引，快速更新</p>

<p>3、可以快速恢复数据</p>

<p>点击kahadb,进入目录</p>

<p><img src="/assets/images/2020/icoding/mq/kahadb2.png" alt="" /></p>

<ul>
  <li>
    <p>db.data   保存数据的，B-tree 所用。</p>
  </li>
  <li>
    <p>db.redo   恢复消息的，自动启动然后备份</p>
  </li>
  <li>
    <p>lock   锁，表示 kahadb的读写权限。</p>
  </li>
</ul>

<p>核心就是几个配置文件组成，十分小巧和方便。</p>

<h3 id="leveldb">LevelDB</h3>

<p>从官网上知道 ，ActiveMQ  5.8 版本之后推荐使用它持久化，也是基于文件来存储的，经过优化的比kahadb更快持久化文件。</p>

<h3 id="jdbc配置持久化到mysql">JDBC配置持久化到Mysql</h3>

<p>原理图：</p>

<p><img src="/assets/images/2020/icoding/mq/persistence-jdbc.gif" alt="" /></p>

<blockquote>
  <p>如何配置</p>
</blockquote>

<p><strong>1、将mysql的驱动jar包放到activemq的lib目录下</strong></p>

<p><img src="/assets/images/2020/icoding/mq/persistence-mysql.gif" alt="" /></p>

<p><strong>2、修改配置文件conf/activemq.xml</strong></p>

<p>查看官网的配置<a href="http://activemq.apache.org/persistence.html">http://activemq.apache.org/persistence.html</a></p>

<p>发现JDBC持久化配置</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-mysql.png" alt="" /></p>

<p>查看官网 <a href="http://activemq.apache.org/jdbc-support">http://activemq.apache.org/jdbc-support</a></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@helloworld conf]# vim activemq.xml 
&lt;<span class="o">!</span><span class="nt">--</span>
Configure message persistence <span class="k">for </span>the broker. The default persistence
mechanism is the KahaDB store <span class="o">(</span>identified by the kahaDB tag<span class="o">)</span><span class="nb">.</span>
For more information, see:

http://activemq.apache.org/persistence.html
<span class="nt">--</span><span class="o">&gt;</span>
<span class="c"># 配置持久化策略</span>
&lt;persistenceAdapter&gt;
    &lt;<span class="o">!</span><span class="nt">--</span>  &lt;kahaDB <span class="nv">directory</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">activemq</span><span class="p">.data</span><span class="k">}</span><span class="s2">/kahadb"</span>/&gt; <span class="nt">--</span><span class="o">&gt;</span>
    &lt;jdbcPersistenceAdapter <span class="nv">dataSource</span><span class="o">=</span><span class="s2">"#mysql-ds"</span>/&gt; 
&lt;/persistenceAdapter&gt;
<span class="c"># 数据源,注意这里是dbcp2，官网上的文档没更新</span>
&lt;bean <span class="nb">id</span><span class="o">=</span><span class="s2">"mysql-ds"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"org.apache.commons.dbcp2.BasicDataSource"</span> destroy-method<span class="o">=</span><span class="s2">"close"</span><span class="o">&gt;</span>
    &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">"driverClassName"</span> <span class="nv">value</span><span class="o">=</span><span class="s2">"com.mysql.jdbc.Driver"</span>/&gt;
    &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">"url"</span> <span class="nv">value</span><span class="o">=</span><span class="s2">"jdbc:mysql://127.0.0.1:3306/activemq?relaxAutoCommit=true"</span>/&gt;
    &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">"username"</span> <span class="nv">value</span><span class="o">=</span><span class="s2">"root"</span>/&gt;
    &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">"password"</span> <span class="nv">value</span><span class="o">=</span><span class="s2">"123456"</span>/&gt;
    &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">"poolPreparedStatements"</span> <span class="nv">value</span><span class="o">=</span><span class="s2">"true"</span>/&gt;
&lt;/bean&gt;
</code></pre></div></div>

<p>bean 不能放在broker里面</p>

<p><img src="/assets/images/2020/icoding/mq/msql-bean.jpg" alt="" /></p>

<p><strong>3、创建数据库activemq</strong></p>

<p><img src="/assets/images/2020/icoding/mq/activemq-mysql2.png" alt="" /></p>

<p>4、重启MQ，观察数据库，会自动帮我们生成3个表</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-mysql3.png" alt="" /></p>

<ul>
  <li>
    <p>acks：  存储 订阅关系，持久化的 topic。</p>
  </li>
  <li>
    <p>lock： 集群中才会生效，保证了只有一个  Broker 获取的消息， Master</p>
  </li>
  <li>
    <p>msgs： 存储消息，Topic 和 Queue  都是 这个表中</p>
  </li>
</ul>

<p><img src="/assets/images/2020/icoding/mq/activemq-tables.jpg" alt="" /></p>

<blockquote>
  <p>队列测试</p>
</blockquote>

<p>1、编写生产者</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">coding</span><span class="o">.</span><span class="na">queue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce</span> <span class="o">{</span>
    <span class="c1">// 1、消息发送到哪里</span>
 	<span class="c1">// http://139.199.13.139:8161 控制台</span>
	<span class="c1">// tcp://139.199.13.139:61616 程序通信协议</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://127.0.0.1:61616"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
        <span class="c1">// 2、创建一个连接工厂</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>

        <span class="c1">// 3、获得连接</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// 4、创建会话</span>
        <span class="c1">// 参数：事务、签收  AUTO_ACKNOWLEDGE ： 自动确认</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>

        <span class="c1">// 5、模式，目的地（队列，主题）</span>
        <span class="c1">// session.createTopic();</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="s">"jdbc-queue01"</span><span class="o">);</span>

        <span class="c1">// 6、发送消息（生成者）</span>
        <span class="nc">MessageProducer</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>

        <span class="c1">// 开启持久化配置,否则不进入数据库</span>
        <span class="n">producer</span><span class="o">.</span><span class="na">setDeliveryMode</span><span class="o">(</span><span class="nc">DeliveryMode</span><span class="o">.</span><span class="na">PERSISTENT</span><span class="o">);</span>

        <span class="c1">// 7、发送具体的消息到队列, 创建的消息类型是什么就些什么</span>
        <span class="c1">// 简单文本(TextMessage)、可序列化的对象 (ObjectMessage)、属性集合 (MapMessage)、字节流 (BytesMessage)、原始值流 (StreamMessage)，还有无有效负载的消息 (Message)。</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">TextMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"msg=&gt;"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="c1">// 8、发送消息</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span> <span class="c1">// 积压，但是没有放入队列</span>
        <span class="o">}</span>

        <span class="c1">// 9、用完记得关闭资源</span>
        <span class="n">producer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"发送完毕"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2、持久化测试</p>

<p>执行生产者发送消息，先发送到ActiveMq中</p>

<p><img src="/assets/images/2020/icoding/mq/jdbc-queue01.jpg" alt="" /></p>

<p>在查询mysql数据库，消息已存放到msgs表</p>

<p><img src="/assets/images/2020/icoding/mq/jdbc-queue01-mysql.jpg" alt="" /></p>

<p>3、编写消费者</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">coding</span><span class="o">.</span><span class="na">queue</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsConsumer</span> <span class="o">{</span>


    <span class="c1">// 1、消息发送到哪里</span>
    <span class="c1">// 39.105.61.80:8161  控制板</span>
    <span class="c1">// 39.105.61.80:61616 程序通信tcp协议</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://127.0.0.1:61616"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
        <span class="c1">// 2、创建一个连接工厂</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

      <span class="c1">// true开启事务，需要session.commit()</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>

        <span class="c1">// 5、模式，目的地（队列，主题）</span>
        <span class="c1">// session.createTopic();</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="s">"jdbc-queue01"</span><span class="o">);</span>

        <span class="c1">// 6、消息接受者（角色变化）</span>
        <span class="nc">MessageConsumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createConsumer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>

        <span class="c1">// 7、获取消息</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
            <span class="c1">// tcp  等待接收消息的过程。 receive</span>
            <span class="c1">// receive 阻塞等待</span>
            <span class="c1">// receive(long timeout) 超过多少ms就消费结束，然后不等待了</span>
            <span class="nc">TextMessage</span> <span class="n">receive</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span> <span class="n">consumer</span><span class="o">.</span><span class="na">receive</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">receive</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"接收到消息："</span><span class="o">+</span> <span class="n">receive</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">session</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span> <span class="c1">// 假设客户端开启了事务，业务提交事务，否则不成功的！</span>

        <span class="c1">// 9、用完记得关闭资源</span>
        <span class="n">consumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"接收完毕"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4、查看效果</p>

<p>执行消费者，获取消息，mysql中msgs表的消息就会被删除</p>

<p><img src="/assets/images/2020/icoding/mq/jdbc-queue01-mysql-nomsg.jpg" alt="" /></p>

<p><mark>道理：持久化的时候将消息存储到数据库中，然后只要消息被消费成功，就从数据库中删除。</mark></p>

<blockquote>
  <p>主题持久化测试</p>
</blockquote>

<p>主题消息发送者</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">coding</span><span class="o">.</span><span class="na">topic</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduceTopic_Persist</span> <span class="o">{</span>
  <span class="c1">// 1、消息发送到哪里</span>
  <span class="c1">// 39.105.61.80:8161  控制板</span>
  <span class="c1">// 39.105.61.80:61616 程序通信tcp协议</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://127.0.0.1:61616"</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
    <span class="c1">// 1、创建一个连接工厂</span>
    <span class="nc">ActiveMQConnectionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
    <span class="c1">// 2、创建连接</span>
    <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
   
    <span class="c1">// 3、创建会话</span>
    <span class="c1">// connection.createSession(是否开启事务，签收机制)</span>
    <span class="c1">// true: 先执行send方法，然后在执行 commit 才是真正的放入队列。可以积压多个消息，然后一次发送</span>
    <span class="c1">// false:  send。直接进入队列，加入你关闭了事务，签收一定设置。</span>
    <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
   	<span class="c1">// 4、创建目的地</span>
    <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="s">"jdbc-topic01-persist"</span><span class="o">);</span>
    <span class="c1">// 5、创建消息生产者</span>
    <span class="nc">MessageProducer</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>
    <span class="c1">// 持久化策略开启后再连接(注意即可，消息发送就持久化)</span>
    <span class="n">producer</span><span class="o">.</span><span class="na">setDeliveryMode</span><span class="o">(</span><span class="nc">DeliveryMode</span><span class="o">.</span><span class="na">PERSISTENT</span><span class="o">);</span>
    <span class="c1">// 6、开启连接</span>
    <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

    <span class="c1">// 7、发送具体的消息到队列, 创建的消息类型是什么就些什么</span>
    <span class="c1">// 简单文本(TextMessage)、可序列化的对象 (ObjectMessage)、属性集合 (MapMessage)、字节流 (BytesMessage)、原始值流 (StreamMessage)，还有无有效负载的消息 (Message)。</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">TextMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"msg=&gt;"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
      <span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">session</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
    
    <span class="c1">// 8、用完记得关闭资源</span>
    <span class="n">producer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"发送完毕"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>主题消息消费者</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">coding</span><span class="o">.</span><span class="na">topic</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsConsumerTopic_Persist</span> <span class="o">{</span>
  <span class="c1">// 1、消息发送到哪里</span>
  <span class="c1">// 39.105.61.80:8161  控制板</span>
  <span class="c1">// 39.105.61.80:61616 程序通信tcp协议</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://127.0.0.1:61616"</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">// 1、创建一个连接工厂</span>
    <span class="nc">ActiveMQConnectionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
    <span class="c1">// 2、创建连接</span>
    <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
    <span class="c1">// 设置连接ID，我是谁（id），要订阅谁（topic-coding-persist），（客户端信息）</span>
    <span class="n">connection</span><span class="o">.</span><span class="na">setClientID</span><span class="o">(</span><span class="s">"icoding"</span><span class="o">);</span>
    <span class="c1">// 3、创建会话</span>
    <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
    <span class="c1">// 4、创建目的地</span>
    <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="s">"jdbc-topic01-persist"</span><span class="o">);</span>
    <span class="c1">// 5、创建订阅人</span>
    <span class="nc">TopicSubscriber</span> <span class="n">subscriber</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createDurableSubscriber</span><span class="o">(</span><span class="n">topic</span><span class="o">,</span> <span class="s">"学员-jude"</span><span class="o">);</span>
    <span class="c1">//TopicSubscriber topicSubscriber = session.createDurableSubscriber(topic, "coding老师2");</span>
    
    <span class="c1">// 6、开启连接</span>
    <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> 

    <span class="c1">// 7、获取消息，可以写基本的聊天程序了,接收,会一直阻塞接收</span>
    <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="n">topicSubscriber</span><span class="o">.</span><span class="na">receive</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">message</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
      <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"收到持久化的消息："</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
      <span class="c1">// 自动取消订阅，默认永久的</span>
      <span class="n">message</span> <span class="o">=</span> <span class="n">topicSubscriber</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="mi">5000L</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 8、用完记得关闭资源</span>
    <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"接收完毕"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>先启动消费者订阅，在ActiveMQ的控制台看到订阅者</p>

<p><img src="/assets/images/2020/icoding/mq/subscriber-jude.jpg" alt="" /></p>

<p>这个订阅者信息也会被写到数据库的acks表</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-acks.jpg" alt="" /></p>

<p>这里的sub_name订阅者名称??要在持久化的mysql连接字符串加上characterEncoding=utf-8</p>

<p>注意:ActiveMQ的控制台把订阅者jude删除了，acks表也会清除订阅者记录。</p>

<blockquote>
  <p>发现问题</p>
</blockquote>

<p>主题消息持久化，写到mysql后，即使被订阅者消费了也不会被删除，这是什么问题?</p>

<p><img src="/assets/images/2020/icoding/mq/topic-activemq-msgs-not-delete.jpg" alt="" /></p>

<blockquote>
  <p>小结</p>
</blockquote>

<p>1、队列持久化消息就是存在msg中</p>

<p>2、主题，维护一个订阅表，然后消息还是msg中存放。</p>

<h2 id="5集群">5、集群</h2>

<p>基于zookeeper的HA方案：</p>

<p><a href="https://www.cnblogs.com/yjmyzz/p/activemq-ha-with-zookeeper.html">https://www.cnblogs.com/yjmyzz/p/activemq-ha-with-zookeeper.html</a>；</p>

<p>3，这种方案搭建了zookeeper集群和activemq集群，总共6个服务，但是只有一个 activemq生效，master，其余两个不提供服务， 假设一个服务挂了，zk会自动在选举新的master来提供服务。</p>

<p><strong>缺点：</strong></p>

<p>1)  占用的节点数过多，1个zk集群至少3个节点，1个activemq集群也至少得3个节点，但其实正常运行时，只有一个master节点在对外响应，换句话说，花6个节点的成本只为了保证1个activemq master节点的高可用，太<strong>浪费资源了</strong>。</p>

<p>2)  <strong>性能下降太明显</strong>，比起单节点的activemq，性能下降了近1个数量级。</p>

<p>基于Networks of brokers的HA方案</p>

<p><a href="https://www.cnblogs.com/yjmyzz/p/activemq-ha-using-networks-of-brokers.html">https://www.cnblogs.com/yjmyzz/p/activemq-ha-using-networks-of-brokers.html</a></p>

<h2 id="6其他特性">6、其他特性</h2>

<h3 id="异步投递">异步投递</h3>

<p>官方文档：<a href="http://activemq.apache.org/async-sends">http://activemq.apache.org/async-sends</a></p>

<p><img src="/assets/images/2020/icoding/mq/async-send-1.png" alt="" /></p>

<font color="red">默认就是异步模式来发送消息，提高系统性能</font>

<p><strong>什么是异步投递？</strong></p>

<p>同步：发送确认接收后才能做下一个事情</p>

<p>异步：发送之后，就完事了，问题：如何确定这个消息发送成功了？<mark>使用回调函数确认 </mark></p>

<p>1、<strong>3种开启异步投递的方式</strong></p>

<p><img src="/assets/images/2020/icoding/mq/async-send-2.png" alt="" /></p>

<p><strong>2、重点：异步发送如何确定你这个消息发送成功了？</strong></p>

<p>由于咋们的消息不阻塞，这时候send差不多都会被发送到MQ。</p>

<p>MQ服务突然挂了。内存还没有被发送到MQ的消息就会丢失，需要重新发送</p>

<p><mark>正确的异步发送一定是需要开启 回调函数的，确认消息的发送状态。</mark></p>

<p>同步发送==&gt; 等待接收成功了，</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">coding</span><span class="o">.</span><span class="na">queue</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQMessageProducer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.AsyncCallback</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce</span> <span class="o">{</span>
  	<span class="c1">// 开启异步投递(默认开启)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://127.0.0.1:61616?jms.useAsyncSend=true"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
        <span class="c1">// 2、创建一个连接工厂</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>

        <span class="c1">// 3、获得连接</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// 4、创建会话</span>
        <span class="c1">// 参数：事务、签收  AUTO_ACKNOWLEDGE ： 自动确认</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>

        <span class="c1">// 5、模式，目的地（队列，主题）</span>
        <span class="c1">// session.createTopic();</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="s">"queue01"</span><span class="o">);</span>

        <span class="c1">// ((ActiveMQConnectionFactory)connectionFactory).setUseAsyncSend(true);</span>
        <span class="c1">// 开启异步投递之后，我们可以使用 ActiveMQMessageProducer 来进行回调的接收</span>
        <span class="c1">// 6、发送消息（生成者）</span>
        <span class="nc">ActiveMQMessageProducer</span> <span class="n">producer</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ActiveMQMessageProducer</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>

        <span class="c1">// 开启持久化配置</span>
        <span class="n">producer</span><span class="o">.</span><span class="na">setDeliveryMode</span><span class="o">(</span><span class="nc">DeliveryMode</span><span class="o">.</span><span class="na">PERSISTENT</span><span class="o">);</span>

        <span class="c1">// 7、发送具体的消息到队列, 创建的消息类型是什么就些什么</span>
        <span class="c1">// 简单文本(TextMessage)、可序列化的对象 (ObjectMessage)、属性集合 (MapMessage)、字节流 (BytesMessage)、原始值流 (StreamMessage)，还有无有效负载的消息 (Message)。</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">TextMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"msg=&gt;"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="c1">// 自己给消息定义一个消息的id</span>
            <span class="n">message</span><span class="o">.</span><span class="na">setJMSMessageID</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">()+</span><span class="s">"自定义id"</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">messageID</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">getJMSMessageID</span><span class="o">();</span>
            <span class="c1">// 8、发送消息，回调函数（很重要）。</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AsyncCallback</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// 发送成功！那个消息发送成功了，发送的时候就知道了</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">messageID</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onException</span><span class="o">(</span><span class="nc">JMSException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 发送失败！在针对这个消息重发即可。</span>
                    <span class="c1">// 处理失败的异常即可</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">messageID</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="c1">//producer.send(message); // 这里我们应该要确认消息是发送完毕的，这样才能保证效率。</span>
        <span class="o">}</span>
        <span class="c1">// 9、用完记得关闭资源</span>
        <span class="n">producer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"发送完毕"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="定时和延时投递">定时和延时投递</h3>

<p>SpringBoot就可以实现定时和延时投递。cron表达式。</p>

<p>可以通过在activemq.xml配置中将 broker 的schedulerSupport 这个值设置为true即可。</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-scheduler-support.png" alt="" /></p>

<p>消息发送端可以给消息设置下面4个属性，来设定消息的延迟发送</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-delay.png" alt="" /></p>

<ul>
  <li>Springboot，我们现在直接使用springboot来继承 acitvemq即可操作定时和延时消息发送</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 每隔3秒 发送一次</span>
<span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedDelay</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">produceMsgScheduled</span><span class="o">(){</span>
    <span class="n">template</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">topic</span><span class="o">,</span><span class="s">"produceMsgTopic"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"系统正在定时发送消息....."</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>原生代码，直接给消息增加延时设置即可</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TextMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"msg=&gt;"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
<span class="c1">// 消息的延时和定时发送</span>
<span class="n">message</span><span class="o">.</span><span class="na">setStringProperty</span><span class="o">(</span><span class="nc">ScheduledMessage</span><span class="o">.</span><span class="na">AMQ_SCHEDULED_CRON</span><span class="o">,</span> <span class="s">"0 * * * *"</span><span class="o">);</span> <span class="c1">// 每分钟发送一次</span>
<span class="n">message</span><span class="o">.</span><span class="na">setLongProperty</span><span class="o">(</span><span class="nc">ScheduledMessage</span><span class="o">.</span><span class="na">AMQ_SCHEDULED_DELAY</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
<span class="n">message</span><span class="o">.</span><span class="na">setLongProperty</span><span class="o">(</span><span class="nc">ScheduledMessage</span><span class="o">.</span><span class="na">AMQ_SCHEDULED_PERIOD</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
<span class="n">message</span><span class="o">.</span><span class="na">setIntProperty</span><span class="o">(</span><span class="nc">ScheduledMessage</span><span class="o">.</span><span class="na">AMQ_SCHEDULED_REPEAT</span><span class="o">,</span> <span class="mi">9</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="消息重发">消息重发</h3>

<p><strong>在哪些情况下，消息会重发？</strong></p>

<p>1、客户端开启了事务，没有进行rollback().就会重发(消息还在队列中，没有被成功消费)</p>

<p>2、客户端开启了事务，没有进行commit(),</p>

<p>3、开启了签收模式，没有手动签收</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-redelivery.png" alt="" /></p>

<p><strong>消息重发的次数说明？</strong></p>

<p>官网:<a href="http://activemq.apache.org/redelivery-policy">http://activemq.apache.org/redelivery-policy</a></p>

<p><img src="/assets/images/2020/icoding/mq/activemq-redelivery-policy.jpg" alt="" /></p>

<p>6次之后就会进入死信队列。</p>

<p>核心参数：</p>

<table>
  <thead>
    <tr>
      <th>最大重传次数</th>
      <th>默认</th>
      <th>在activemq.xml修改为-1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>maximumRedeliveries</td>
      <td>6</td>
      <td>Sets the maximum number of times a message will be redelivered before it is considered a <strong>poisoned pill</strong> and returned to the broker so it can go to a Dead Letter Queue. Set to <code class="highlighter-rouge">-1</code> for unlimited redeliveries.</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th>初始重发延时时间</th>
      <th>1秒</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">redeliveryDelay</code></td>
      <td>1000L</td>
      <td>The delivery delay if <code class="highlighter-rouge">initialRedeliveryDelay=0</code> (v5.4).</td>
    </tr>
  </tbody>
</table>

<p>逻辑：</p>

<p>正常消息应该直接就可以接受成功，假设一个消息，被重复消费了6次，如果还没有签收成功了！</p>

<p>这个时候客户端将收不到这个消息了，这个消息就被转义到死信队列中。</p>

<p><img src="/assets/images/2020/icoding/mq/activemq-dlq.png" alt="" /></p>

<p>如果要消费这个消息，就需要到死信队列中进行消费。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 假设进入了死信队列，我们从死信队列取值即可</span>
<span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="s">"ActiveMQ.DLQ"</span><span class="o">);</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mq/activemq-reddlivery-policy.png" alt="" /></p>

<h3 id="死信队列">死信队列</h3>

<p>ActiveMQ  引入了 死信队列。DLQ，如果一个消息6次都没有被接收成功，这个时候 ActiveMQ就会自动将消息放入死信队列中。</p>

<p>人工干预，从死信队列中再次消费。</p>

<p><mark>死信队列就是用来处理失败的消息的。</mark></p>

<p><img src="/assets/images/2020/icoding/mq/activemq-dlq-get-message.png" alt="" /></p>

<p>在我们生产环境中，在使用MQ的时候，一般都有两个队列：业务队列 + 死信队列。</p>

<p>可以在配置文件中修改对队列的名称，不使用缺省的死信队列</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@helloworld conf]# vim activemq.xml 
<span class="c">&lt;!--默认配置的是队列，通常情况下死信通道就是队列。--&gt;</span>
<span class="nt">&lt;policyEntry</span> <span class="na">queue=</span><span class="s">"&gt;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;deadLetterStrategy&gt;</span>
        <span class="c">&lt;!--queuePrefix:设置死信队列前缀 useQueueForQueueMessages: 设置使用队列保存死信，还可以设置		   useQueueForTopicMessages，使用Topic来保存死信--&gt;</span>
        <span class="nt">&lt;individualDeadLetterStrategy</span> <span class="na">queuePrefix=</span><span class="s">"DLQ."</span> <span class="na">useQueueForQueueMessages=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 配置其他的策略。 --&gt;</span>
        <span class="nt">&lt;sharedDeadLetterStrategy</span> <span class="na">processExpired=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/deadLetterStrategy&gt;</span>
<span class="nt">&lt;/policyEntry&gt;</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/mq/activemq-dead-queue.jpg" alt="" /></p>

<p>默认的情况下：Queue   Topic</p>

<p>Queue    默认死信队列名称：ActiveMQ.DLQ.Queue</p>

<p>Topic      默认死信队列名称：ActiveMQ.DLQ.Topic</p>

<p>处理业务：用户业务  ActiveMQ.DLQ.Queue.User     ActiveMQ.DLQ.Queue.Order。</p>

<h2 id="7面试">7、面试</h2>

<p><strong>引入了消息队列之后，如何保证它的高可用性？</strong></p>

<p>集群配置：zookeeper + 可复制的 levelDB store 主从集群！</p>

<p>了解 RocketMQ、RabbitMQ、Kafaka！的几个方面</p>

<ul>
  <li>
    <p>消息的发送和接收</p>
  </li>
  <li>
    <p>如何整合到项目中SpringBoot</p>
  </li>
  <li>
    <p>配置研究</p>
  </li>
  <li>
    <p>集群高可用</p>
  </li>
  <li>
    <p>了解这个消息队列产品独有特性</p>
  </li>
</ul>

<p>看看面试题。</p>

<h2 id="8activemq知识点总结">8、ActiveMQ知识点总结</h2>

<p><img src="/assets/images/2020/icoding/mq/ActiveMQ.png" alt="" /></p>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-edu/2020/05/31/icoding-note-042.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
