<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 飞天班第37节：Redis（Final） - 大伟的博客 </title>
    <meta name="keywords" content="redis">
    <meta name="description"
          content="Jedis、SpringBoot整合Redis，缓存击穿、穿透、雪崩及解决方案，布隆过滤器，Redisson分布式锁的源码分析与缺点，Redis6的新特性">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-edu/2020/05/20/icoding-note-037.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="飞天班第37节：Redis（Final）">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>飞天班第37节：Redis（Final）</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/05/20
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1jedis">1、Jedis</h2>

<p>Jedis是Redis官方推荐的Java连接开发工具，前面几节学习的Redis的所有命令在这里都可以找到。</p>

<p>注意，Redis安装在云服务器上连接：</p>

<ul>
  <li>配置文件的bind：127.0.0.1 (本机) 需要修改为 0.0.0.0(不限制IP)</li>
  <li>安全组要打开</li>
  <li>Linux防火墙端口要开放</li>
</ul>

<blockquote>
  <p>Jedis与原生Redis使用的比较</p>
</blockquote>

<ul>
  <li>原生：Redis服务客户端、配置、命令</li>
  <li>Java:  Redis对象（类）、配置（属性），方法（命令）</li>
</ul>

<p>使用：</p>

<p>1、导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>redis.clients<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jedis<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>3.2.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>fastjson<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.2.62<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></div>

<p>2、测试代码</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestKey</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Jedis 就是我们之前使用的客户端工具，抽象成为对象！</span>
		<span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Jedis</span><span class="o">(</span><span class="s">"39.99.3.39"</span><span class="o">,</span><span class="mi">6379</span><span class="o">);</span>
    <span class="c1">// 需要密码的要加这一行</span>
		<span class="n">jedis</span><span class="o">.</span><span class="na">auth</span><span class="o">(</span><span class="s">"xxxxdis"</span><span class="o">);</span>

		<span class="c1">// 里面所有学习过的方法，都是我们之前命令的方法</span>
		<span class="c1">// System.out.println(jedis.flushDB());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="s">"username"</span><span class="o">));</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="s">"jude"</span><span class="o">));</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"username"</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">mset</span><span class="o">(</span><span class="s">"k10"</span><span class="o">,</span><span class="s">"v10"</span><span class="o">,</span><span class="s">"k11"</span><span class="o">,</span><span class="s">"v11"</span><span class="o">,</span><span class="s">"k12"</span><span class="o">,</span><span class="s">"v12"</span><span class="o">));</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">mget</span><span class="o">(</span><span class="s">"k10"</span><span class="o">,</span><span class="s">"k11"</span><span class="o">,</span><span class="s">"k12"</span><span class="o">));</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>其他命令举例</p>
</blockquote>

<ul>
  <li>
    <p>expire 过期</p>

    <p><img src="/assets/images/2020/redis/jedis/expire.gif" alt="" /></p>

    <p><img src="/assets/images/2020/redis/jedis/setex.gif" alt="" /></p>
  </li>
  <li>
    <p>Incr 增加</p>

    <p><img src="/assets/images/2020/redis/jedis/incr.gif" alt="" /></p>
  </li>
  <li>
    <p>list</p>

    <p><img src="/assets/images/2020/redis/jedis/list.gif" alt="" /></p>
  </li>
  <li>
    <p>zset</p>

    <p><img src="/assets/images/2020/redis/jedis/zset.gif" alt="" /></p>
  </li>
  <li>
    <p>bitmap</p>

    <p><img src="/assets/images/2020/redis/jedis/bitmap.gif" alt="" /></p>
  </li>
  <li>
    <p>geo</p>

    <p><img src="/assets/images/2020/redis/jedis/geo.gif" alt="" /></p>
  </li>
  <li>
    <p>hyperloglog</p>

    <p><img src="/assets/images/2020/redis/jedis/hperloglog.gif" alt="" /></p>
  </li>
</ul>

<p>3、测试事务</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 1、连接redis</span>
  <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Jedis</span><span class="o">(</span><span class="s">"139.199.13.139"</span><span class="o">,</span><span class="mi">6379</span><span class="o">);</span>
  <span class="n">jedis</span><span class="o">.</span><span class="na">auth</span><span class="o">(</span><span class="s">"juderedis"</span><span class="o">);</span>

  <span class="c1">// 2、初始数据</span>
  <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"money"</span><span class="o">,</span><span class="s">"100"</span><span class="o">);</span>
  <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"use"</span><span class="o">,</span><span class="s">"0"</span><span class="o">);</span>
  <span class="n">jedis</span><span class="o">.</span><span class="na">watch</span><span class="o">(</span><span class="s">"money"</span><span class="o">);</span> <span class="c1">// 事务开始之前监控money，事务过程中这个money没有发生变化，这个事务才可以执行成功，否则事务自动取消</span>
  
  <span class="c1">// 3、开启事务</span>
  <span class="nc">Transaction</span> <span class="n">multi</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">multi</span><span class="o">();</span>

  <span class="c1">// 4、事务处理</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">multi</span><span class="o">.</span><span class="na">decrBy</span><span class="o">(</span><span class="s">"money"</span><span class="o">,</span><span class="mi">20</span><span class="o">);</span>
    <span class="n">multi</span><span class="o">.</span><span class="na">incrBy</span><span class="o">(</span><span class="s">"use"</span><span class="o">,</span><span class="mi">20</span><span class="o">);</span>
    <span class="n">multi</span><span class="o">.</span><span class="na">exec</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="n">multi</span><span class="o">.</span><span class="na">discard</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"money"</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"use"</span><span class="o">));</span>
    <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>jedis是十分简单的工具</p>

<h2 id="2springboot集成redis">2、Springboot集成Redis</h2>

<h3 id="分析源码">分析源码</h3>

<blockquote>
  <p>分析核心对象</p>
</blockquote>

<p>1、JedisPool 和 LettucePool （配置连接池）</p>

<p><img src="/assets/images/2020/redis/jedis-pool.gif" alt="" /></p>

<p><img src="/assets/images/2020/redis/lettuce-pool.gif" alt="" /></p>

<p>Springboot 1.x 使用的是jeids 作为连接池的，springboot 2.x使用的是lettuce作为连接池的</p>

<p>2、RedisConnectionFactory （配置连接的信息）
 <img src="/assets/images/2020/redis/redis-connection-factory.gif" alt="" /></p>

<p>3、RedisTemplate （具体的操作）</p>

<blockquote>
  <p>集成</p>
</blockquote>

<p>1、导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、分析源码</p>

<p>两步：xxxAutoConfiguration 和 xxxProperties</p>

<p>全局搜索一下RedisAutoConfiguration(windows按两下shift,Mac就按两下⇧)</p>

<p><img src="/assets/images/2020/redis/jedis/global-search-redisautoconfiguration.gif" alt="" /></p>

<p>找到RedisAutoConfiguration</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">RedisOperations</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">RedisProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="c1">// 引入了两个连接池，但实际上是使用lettuce做为连接池，jedis连接池失效，点击JedisConnectionConfiguration的源码就知道了</span>
<span class="nd">@Import</span><span class="o">({</span> <span class="nc">LettuceConnectionConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">JedisConnectionConfiguration</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisAutoConfiguration</span> <span class="o">{</span>

  <span class="c1">// 启动时，向spring注入了两个bean</span>
  <span class="c1">// 太简单，不符合真实开发需要，建议自定义一个Bean redisTemplate,则该bean失效</span>
	<span class="nd">@Bean</span>
	<span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"redisTemplate"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">UnknownHostException</span> <span class="o">{</span>
		<span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisTemplate</span><span class="o">&lt;&gt;();</span>
		<span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">template</span><span class="o">;</span>
	<span class="o">}</span>

  <span class="c1">// 因为在redis中，String最常用，所以单独提出一个bean</span>
	<span class="nd">@Bean</span>
	<span class="nd">@ConditionalOnMissingBean</span>
	<span class="kd">public</span> <span class="nc">StringRedisTemplate</span> <span class="nf">stringRedisTemplate</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">UnknownHostException</span> <span class="o">{</span>
		<span class="nc">StringRedisTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringRedisTemplate</span><span class="o">();</span>
		<span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">template</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>点进JedisConnectionConfiguration的源码</p>

<p><img src="/assets/images/2020/redis/jedis-connection-configuration.gif" alt="" /></p>

<p>可以看到因为2.x版本的spring-boot-starter-data-redis没有引入Jedis的依赖包，jedis连接池配置类是不生效的。</p>

<p>点进RedisTemplate的源码，这个对象封装了关于Redis的所有操作</p>

<p><img src="/assets/images/2020/redis/jedis/redis-ops.gif" alt="" /></p>

<p>点击RedisTemplate的structure</p>

<p><img src="/assets/images/2020/redis/redistemplate-opsfor.gif" alt="" /></p>

<p>结论：</p>

<p>所有的具体操作还需要通过opsForxxxxx() 进行操作Redis的八大类型（String，list，set，hash，zset，geo，bitmap，hyperloglog）</p>

<h3 id="操作redis的步骤">操作Redis的步骤</h3>

<p>1、导入依赖</p>

<p>2、编写redis的配置文件</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 单节点配置</span>
<span class="na">spirng</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">39.99.13.39</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">xxxx</span>  <span class="c1"># 无密码可以不用配置</span>
  
<span class="c1"># 主从+哨兵模式时配置</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">xxxxxx</span>
    <span class="na">sentinel</span><span class="pi">:</span>
      <span class="na">master</span><span class="pi">:</span> <span class="s">jude-master</span> 
      <span class="na">nodes</span><span class="pi">:</span> <span class="s">7.13.9.19:26379,7.13.9.19:26381,7.13.9.19:26382</span> <span class="c1"># 只需配置哨兵节点就可以了</span>
</code></pre></div></div>

<p>3、在使用的类中，调用redisTemplate.opsForxxxxxx</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
	<span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">redisTemplate</span><span class="o">;</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testOps</span><span class="o">(){</span>
  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="s">"jude"</span><span class="o">);</span>

  <span class="c1">// list,向左插入值</span>
  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForList</span><span class="o">().</span><span class="na">leftPush</span><span class="o">(</span><span class="s">"mylist"</span><span class="o">,</span><span class="s">"one"</span><span class="o">,</span><span class="s">"two"</span><span class="o">);</span>
  <span class="c1">// set,插入元素到集合</span>
  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForSet</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"myset"</span><span class="o">,</span><span class="s">"hello"</span><span class="o">,</span><span class="s">"coding"</span><span class="o">,</span><span class="s">"world"</span><span class="o">);</span>
  <span class="c1">// hash,给哈希key的field设置值</span>
  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHash</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"myhash"</span><span class="o">,</span><span class="s">"filed1"</span><span class="o">,</span><span class="s">"hello"</span><span class="o">);</span>
  <span class="c1">// zset,员工的工资，安工资排序</span>
  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForZSet</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"salary"</span><span class="o">,</span><span class="s">"jude"</span><span class="o">,</span><span class="mi">5000</span><span class="o">);</span>
  <span class="c1">// geo,添加城市和地理位置</span>
  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForGeo</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"china:city"</span><span class="o">,</span><span class="k">new</span> <span class="nc">Point</span><span class="o">(</span><span class="mf">116.23128</span><span class="o">,</span><span class="mf">40.22077</span><span class="o">),</span><span class="s">"北京"</span><span class="o">);</span>
  <span class="c1">// bitmap,员工打卡情况</span>
  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">setBit</span><span class="o">(</span><span class="s">"sign:12"</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
  <span class="c1">// hyperloglog,统计基数</span>
  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHyperLogLog</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"myhyper"</span><span class="o">,</span><span class="s">"1"</span><span class="o">,</span><span class="s">"3"</span><span class="o">,</span><span class="s">"5"</span><span class="o">,</span><span class="s">"1"</span><span class="o">,</span><span class="s">"3"</span><span class="o">);</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">getBit</span><span class="o">(</span><span class="s">"sign:12"</span><span class="o">,</span><span class="mi">1</span><span class="o">));</span>

  <span class="c1">// bitmap统计，返回1的个数</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bitcount</span><span class="o">(</span><span class="s">"sign:12"</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">// redisTemplate 不能使用bitcount方法，需要自己扩充</span>
<span class="kd">private</span> <span class="kt">long</span> <span class="nf">bitcount</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">){</span>
  <span class="k">return</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">((</span><span class="nc">RedisCallback</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;)</span> <span class="n">redisConnection</span> <span class="o">-&gt;</span> <span class="n">redisConnection</span><span class="o">.</span><span class="na">bitCount</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>发现redis命令和方法名并不一致，不像jedis的那样易懂，所以真实开放中，要对它进一步封装，封装成工具类，方法名给官方redis命令名称一致的话就比较清楚了。</p>

<h3 id="自定义redistemplate-bean">自定义RedisTemplate Bean</h3>

<p>官方自动配置的redisTemplate 太简单，不能满足实际开发的需要，一般都自定义一个redisTemplate Bean</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfig</span> <span class="o">{</span>
    <span class="c1">// 对于对象和hash&lt;key,value&gt; 使用这个主要就是对象转换和编码问题！</span>
    <span class="nd">@Bean</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"all"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">factory</span><span class="o">){</span>
        <span class="c1">// 改为自己要操作的对象模式</span>
        <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisTemplate</span><span class="o">&lt;&gt;();</span>
        <span class="n">template</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>
        <span class="c1">// Object 如何序列化的问题</span>
        <span class="nc">Jackson2JsonRedisSerializer</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Jackson2JsonRedisSerializer</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>
        <span class="n">mapper</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="nc">PropertyAccessor</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span><span class="nc">JsonAutoDetect</span><span class="o">.</span><span class="na">Visibility</span><span class="o">.</span><span class="na">ANY</span><span class="o">);</span>
        <span class="n">mapper</span><span class="o">.</span><span class="na">enableDefaultTyping</span><span class="o">(</span><span class="nc">ObjectMapper</span><span class="o">.</span><span class="na">DefaultTyping</span><span class="o">.</span><span class="na">NON_FINAL</span><span class="o">);</span>
        <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="na">setObjectMapper</span><span class="o">(</span><span class="n">mapper</span><span class="o">);</span>

        <span class="nc">StringRedisSerializer</span> <span class="n">stringRedisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">();</span>
      
        <span class="c1">// key: String的序列化方式</span>
        <span class="n">template</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="n">stringRedisSerializer</span><span class="o">);</span>
        <span class="c1">// hash: String的序列化方式</span>
        <span class="n">template</span><span class="o">.</span><span class="na">setHashKeySerializer</span><span class="o">(</span><span class="n">stringRedisSerializer</span><span class="o">);</span>
        <span class="c1">// Object： Jsckson</span>
        <span class="n">template</span><span class="o">.</span><span class="na">setValueSerializer</span><span class="o">(</span><span class="n">jackson2JsonRedisSerializer</span><span class="o">);</span>
        <span class="c1">// hashObject： Jsckson</span>
        <span class="n">template</span><span class="o">.</span><span class="na">setHashValueSerializer</span><span class="o">(</span><span class="n">jackson2JsonRedisSerializer</span><span class="o">);</span>
        <span class="c1">// 其与的类型设置同理</span>
      
      	<span class="c1">// 生效</span>
        <span class="n">template</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">template</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="封装工具类redisutils">封装工具类RedisUtils</h3>

<p>需要注意一下，自动装配的redisTemplate一定是自定义的redisTemplate</p>

<p><img src="/assets/images/2020/jedis/autowired-dependencies.gif" alt="" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisUtils</span> <span class="o">{</span>
	<span class="nd">@Autowired</span>
	<span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">redisTemplate</span><span class="o">;</span>

	<span class="c1">// ============================= common ============================</span>

	<span class="cm">/**
	 * 指定缓存失效时间
	 * @param key
	 * @param timeout
	 * @return
	 */</span>
	<span class="kd">public</span>  <span class="kt">boolean</span> <span class="nf">expire</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">){</span>
		<span class="k">try</span><span class="o">{</span>
			<span class="k">if</span><span class="o">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
				<span class="n">redisTemplate</span><span class="o">.</span><span class="na">expire</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>



	<span class="c1">// ============================ String =============================</span>

	<span class="cm">/**
	 * 普通缓存放入
	 * @param key
	 * @param value
	 * @return
	 */</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">set</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span><span class="nc">Object</span> <span class="n">value</span><span class="o">){</span>
		<span class="k">try</span><span class="o">{</span>
			<span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">value</span><span class="o">);</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// ============================ List =============================</span>

	<span class="cm">/**
	 * 获取list缓存的内容
	 * @param key
	 * @param start
	 * @param end
	 * @return
	 */</span>
	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">lrange</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">start</span><span class="o">,</span> <span class="kt">long</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">try</span><span class="o">{</span>
			<span class="k">return</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForList</span><span class="o">().</span><span class="na">range</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">start</span><span class="o">,</span><span class="n">end</span><span class="o">);</span>
		<span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>


	<span class="c1">// ============================ Set =============================</span>

	<span class="cm">/**
	 * 将数据放入set缓存
	 *
	 * @param key    键
	 * @param values 值 可以是多个
	 * @return 成功个数
	 */</span>
	<span class="kd">public</span> <span class="kt">long</span> <span class="nf">sadd</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForSet</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">values</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// ============================ HashMap =============================</span>
	<span class="cm">/**
	 * 向一张hash表中放入数据,如果不存在将创建
	 *
	 * @param key   键
	 * @param item  项
	 * @param value 值
	 * @param timeout  失效时间(秒) 注意:如果已存在的hash表有时间,这里将会替换原有的时间
	 * @return true 成功 false失败
	 */</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hset</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">String</span> <span class="n">item</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForHash</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">item</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">expire</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">timeout</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="c1">// ============================ zSet =============================</span>

	<span class="c1">// ============================ Geo =============================</span>

	<span class="c1">// ============================ Bitmaps =============================</span>

	<span class="c1">// ============================ HyperLogLog =============================</span>
<span class="o">}</span>

</code></pre></div></div>

<p>在代码中使用工具类，根据项目慢慢扩展， 不是一次性写好的</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RedisUtils</span> <span class="n">redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisUtils</span><span class="o">();</span>
<span class="n">redis</span><span class="o">.</span><span class="na">hset</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span><span class="s">"name"</span><span class="o">,</span><span class="s">"jude"</span><span class="o">,</span><span class="mi">10</span><span class="o">*</span><span class="mi">60</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="3缓存击穿一个点">3、缓存击穿（一个点）</h2>

<ul>
  <li><strong>缓存击穿</strong>：针对一个key的大量并发查询，key过期失效的瞬间，所有请求就会穿破缓存，砸到了Mysql数据库去查询，导致数据库压力过大的现象，可能挂掉。</li>
</ul>

<p><img src="/assets/images/2020/redis/cache-breakdown1.png" alt="" /></p>

<p>用户想要查询一个数据（热点的key），有很多人访问，如双11的秒杀活动，Redis不停的扛着高并发</p>

<p><img src="/assets/images/2020/redis/cache-breakdown2.png" alt="" /></p>

<p>大量的请求都集中在一个 key 上 ，如100万个请求去get(“test”)，突然一下缓存失效了，所有的请求一瞬间就砸到了MySQL上面，持续的并发就穿破Redis的缓存。</p>

<blockquote>
  <p>解决方案</p>
</blockquote>

<p><strong>1、设置热点数据永不过期</strong></p>

<p>从缓存层面来说，没有设置过期时间，就不会产生穿透问题。</p>

<p><strong>2、加互斥锁</strong></p>

<p>分布式锁：只要加了锁，可以保证每个key，只有一个线程去查询后端的服务，其他线程就等待。</p>

<p>核心：转移压力，尽量服务不崩就可以了，将数据库承受的压力转义到了分布式锁上面，如下图：</p>

<p><img src="/assets/images/2020/redis/cache-breakdown-lock.png" alt="" /></p>

<h2 id="4缓存穿透不存在">4、缓存穿透（不存在）</h2>

<ul>
  <li><strong>缓存穿透</strong>：用户想要查询一个数据，在redis中不存在（缓存未命中），就会进入数据库去查询。如果有就写回redis，没有则redis就不存在这个数据的缓存。当很多用户查询的时候，缓存都没有命中，所有的请求最终还是进入数据库去查询，导致数据库压力过大的现象，可能挂掉。</li>
</ul>

<blockquote>
  <p>解决方案</p>
</blockquote>

<p><strong>1、布隆过滤器</strong></p>

<p>布隆过滤器是一种数据结构，判断这个数据是否存在，在查询的时候进行校验，不符合（不存在）则丢弃，直接返回空，避免了直接到数据库查询。</p>

<p>第一步是将数据库所有的数据加载到布隆过滤器。</p>

<p>第二步当有请求来的时候先去布隆过滤器查询，如果bloom filter说没有，直接返回空</p>

<p>如果bloom filter说有，再往下走之前的流程。</p>

<p><img src="/assets/images/2020/redis/bloomfilter-redis-mysql.jpg" alt="" /></p>

<ul>
  <li>适用场景：数据命中低，数据相对固定实时性低</li>
  <li>维护成本：代码维护复杂，缓存空间占用少</li>
</ul>

<p>我的问题是应该将什么样的数据放到布隆过滤器中，也就是第一步数据预热的问题，新增的数据也可以实时放入到布隆过滤器，所以长度稍微长一些</p>

<p>场景举例：</p>

<blockquote>
  <p>我们的推荐服务有4亿个用户uid,  我们会根据用户的历史行为进行推荐（非实时），所有的用户推荐数据放到hbase中，但是每天有许多新用户来到网站，这些用户在当天的访问就会穿透到hbase。为此我们每天4点对所有uid做一份布隆过滤器。如果布隆过滤器认为uid不存在，那么就不会访问hbase，在一定程度保护了hbase（减少30%左右）。</p>
</blockquote>

<p>什么时候使用布隆过滤器，还真要看业务场景支不支持。</p>

<p>2、缓存空对象</p>

<p>请求过来，redis中查询不存在，到达数据库查询，数据库有数据就缓存数据到redis中，没有就缓存空字符串到redis中，并设置一个较短的过期时间，如60s。第二个请求到达，查询同样的key，就直接返回空字符串，避免了数据库的查询。</p>

<p><img src="/assets/images/2020/redis/redis-cache-null.png" alt="" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 伪代码</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPassThrough</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>  
  <span class="c1">// 从缓存中获取数据  </span>
  <span class="nc">String</span> <span class="n">cacheValue</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>  
  <span class="c1">// 缓存为空  </span>
  <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">cacheValue</span><span class="o">))</span> <span class="o">{</span>  
    <span class="c1">// 从存储中获取  </span>
    <span class="nc">String</span> <span class="n">storageValue</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>  
    <span class="n">cache</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">storageValue</span><span class="o">);</span>  
    <span class="c1">// 如果存储数据为空，需要设置一个过期时间(300秒)  </span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">storageValue</span><span class="o">))</span> <span class="o">{</span>  
      <span class="n">cache</span><span class="o">.</span><span class="na">expire</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span><span class="o">);</span>  
    <span class="o">}</span>  
    <span class="k">return</span> <span class="n">storageValue</span><span class="o">;</span>  
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>  
    <span class="c1">// 缓存非空  </span>
    <span class="k">return</span> <span class="n">cacheValue</span><span class="o">;</span>  
  <span class="o">}</span>  
<span class="o">}</span> 
</code></pre></div></div>

<ul>
  <li>适应场景：数据命中低，数据频繁变化实时性高</li>
  <li>维护成本：代码维护简单，需要过多的缓存空间</li>
</ul>

<h2 id="5缓存雪崩一个面">5、缓存雪崩（一个面）</h2>

<p>在某一个时间段，缓存集体失效，或者redis挂了，就会发生缓存雪崩。</p>

<p><img src="/assets/images/2020/redis/redis-cache-down.png" alt="" /></p>

<p>场景：双十一，0点抢购。</p>

<p>将抢购商品集中的放入缓存（一个小时过期），一个小时后集体失效，对于这批商品而言，所有的请求直接查询数据库。数据库周期性的压力,存储层的调用会暴增，可能直接挂掉，这就是触发了雪崩。</p>

<blockquote>
  <p>解决方案</p>
</blockquote>

<p>1、保证Redis的高可用，主从+哨兵模式，更大一点的可以考虑集群模式</p>

<p>2、限流降级，缓存失效后的处理，加锁，返回预定的对象（服务降级）</p>

<p>3、<mark>数据预热</mark>， 在正式的部署之前，我们先将这批数据放入到redis缓存中，假设即将发生高并发的情况，这个时候设置不同的过期时间，让缓存失效时间比较均匀。</p>

<p>4、缓存永不过期：冰封了</p>

<p>5、过期时间错开（可以在key创建时加入一个1-10分钟的随机数给到key）</p>

<p>6、多缓存数据结合（不要直接打到DB上，可以在DB上再加一个搜索引擎ES）</p>

<p>7、在代码里进行redis数据写入时通过锁解决（synchronized，分布式锁zookeeper），如果使用synchronized的话，最多并发放入的请求个数=该业务集群的节点数，使用分布式锁的话就是最多并发放入请求个数只有一个。</p>

<h2 id="6布隆过滤器">6、布隆过滤器</h2>

<p>通常我们会遇到很多要判断一个元素是否在某个集合中的业务场景，一般想到的是将集合中所有元素保存起来，然后通过比较确定。set，链表、树、散列表（又叫哈希表，Hash table）等等数据结构都是这种思路。但是随着集合中元素的增加，我们需要的存储空间也会呈现线性增长，最终达到瓶颈。同时检索速度也越来越慢。</p>

<p>1970年布隆提出了一种过滤数据的数据结构，由一个固定大小的二进制向量或者位图（bitmap）和一系列映射函数组成，它就是布隆过滤器。</p>

<p>先了解一下<strong>哈希函数的概念</strong>：将任意大小的输入数据转换成特定大小的输出数据的函数，转换后的数据称为哈希值或哈希编码，也叫散列值。下面是一幅示意图：</p>

<p><img src="/assets/images/2020/redis/hash-function.jpg" alt="" /></p>

<p>所有散列函数都有两个基本特性：</p>

<ul>
  <li>
    <p>如果两个散列值是不相同的（根据同一函数），那么这两个散列值的原始输入也是不相同的。这个特性是散列函数具有确定性的结果，具有这种性质的散列函数称为<strong>单向散列函数</strong>。</p>
  </li>
  <li>
    <p>散列函数的输入和输出不是唯一对应关系的，如果两个散列值相同，两个输入值很可能是相同的，但也可能不同，这种情况称为<strong>散列碰撞（collision）</strong></p>
  </li>
</ul>

<p>但是用 hash表存储大数据量时，空间效率还是很低，当只有一个 hash 函数时，还很容易发生哈希碰撞，所以一般经过多个hash函数计算，得到不同坐标的二进制向量0和1，得到</p>

<p>布隆过滤器初始状态都是0，当有数据加入集合，通过哈希函数将数据转换为二进制向量0和1，如下图：</p>

<p><img src="/assets/images/2020/redis/bloomfilter-hash.png" alt="" /></p>

<p>查询某个变量的时候我们只要看看这些点是不是都是 1：</p>

<ul>
  <li>如果这些点有一个 0，则被查询变量一定不在；</li>
  <li>如果都是 1，则被查询变量很<strong>可能存在</strong>，因为散列函数是会有碰撞的。这个就是所谓的误判，是指多个输入经过哈希之后在相同的bit位置都是1，这样就无法判断究竟是哪个输入产生的。</li>
</ul>

<p><strong>核心三个点：</strong></p>

<p>1、布隆过滤器是一个数据结构（容量，精确度）容量一旦初始化则不可更改。</p>

<p>2、布隆过滤器对于已存在的数据，不会存在误判</p>

<p>3、所有的存储都是使用 0 1 然后数据使用 hash 运算，然后通过hash碰撞来存放测试</p>

<p><mark>过滤器中都是0和1，所以说，你无法查询这个数据是什么，只能查询它是否存在，然后还发现，这个数据不能删除</mark></p>

<p>put 添加数据，mightContain判断数据是否存在。</p>

<blockquote>
  <p>布隆过滤器的应用举例：</p>
</blockquote>

<ul>
  <li>
    <p>今日头条：刷头条（很少刷到相同的内容，抖音）</p>

    <p>所有的视频（去判断。set （没看）——&gt;  set（看了的））十分不科学。</p>

    <p>有没有可能刷到同一个视频？在实际中是可能存在的。（有误差）</p>
  </li>
  <li>
    <p>缓存宕机、缓存击穿场景，一般判断用户是否在缓存中，如果在则直接返回结果，不在则查询db，如果来一波冷数据，会导致缓存大量击穿，造成雪崩效应，这时候可以用布隆过滤器当缓存的索引，只有在布隆过滤器中，才去查询缓存，如果没查询到，则穿透到db。如果不在布隆器中，则直接返回。</p>
  </li>
</ul>

<h3 id="java中使用布隆过滤器">Java中使用布隆过滤器</h3>

<p>1、pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.google.guava<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>guava<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>28.0-jre<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、测试</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBF</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// 创建一个布隆过滤器</span>
    <span class="c1">// 第一个参数：字符集</span>
    <span class="c1">// 第二个参数：预计插入数据的长度（二进制向量的容量长度）</span>
    <span class="c1">// 第三个参数：fpp就是期望的误判率，错误率越低，需要的空间越大</span>
    <span class="nc">BloomFilter</span><span class="o">&lt;</span><span class="nc">CharSequence</span><span class="o">&gt;</span> <span class="n">bloomFilter</span> <span class="o">=</span> <span class="nc">BloomFilter</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="nc">Funnels</span><span class="o">.</span><span class="na">stringFunnel</span><span class="o">(</span><span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">)),</span> <span class="mi">100000</span><span class="o">,</span> <span class="mf">0.000001</span><span class="o">);</span>

    <span class="c1">// 填满数据</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">bloomFilter</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">// 查询数据（故意查不存在的）</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">bloomFilter</span><span class="o">.</span><span class="na">mightContain</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">))){</span>
        <span class="n">flag</span><span class="o">++;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 查询存在的数据（100% 可以查到）</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">bloomFilter</span><span class="o">.</span><span class="na">mightContain</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">))){</span>
        <span class="n">flag</span><span class="o">++;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"误判了："</span><span class="o">+</span> <span class="n">flag</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>特点：</p>

<p>1、不存在的数据可能会误判被查到，我们可以调整精确度来尽量避免这个问题（时间和空间问题）</p>

<p>2、存在的数据100% 不会误判。</p>

<p>3、这种方式布隆过滤器只在java 本机内存中，要考虑分布式的问题</p>

<h3 id="redis集成布隆过滤器">Redis集成布隆过滤器</h3>

<p>分布式环境中，布隆过滤器肯定还需要考虑是可以共享的资源，不能只用在java 本机内存中，这个时候可以使用Redis。Redis官方提供的布隆过滤器支持的是到了Redis4.x以后提供的插件功能，布隆过滤器作为一个插件加载到 Redis Server 中，给 Redis 提供了强大的布隆去重功能。</p>

<blockquote>
  <p>集成</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1、下载布隆过滤器插件</span>
wget https://github.com/RedisBloom/RedisBloom/archive/v2.2.2.tar.gz
<span class="c"># 解压</span>
<span class="nb">tar</span> <span class="nt">-zxvf</span> v2.2.2.tar.gz 
<span class="c"># 2、进入解压目录之后make</span>
<span class="o">[</span>root@kuangshen RedisBloom-2.2.2]# make
<span class="c"># 3、redis的配置文件添加插件,MODULES</span>
loadmodule /opt/RedisBloom-2.2.2/redisbloom.so
<span class="c"># 重启redis，就加载好了</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/redis/redis-conf-bloomfilter.gif" alt="" /></p>

<p>核心文件redisbloom.so</p>

<p><img src="/assets/images/2020/redis/redis-bloom-so.png" alt="" /></p>

<blockquote>
  <p>基本使用</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 进入redis-cli客户端</span>
<span class="c"># 1、添加数据到布隆过滤器，默认过滤器元素容量为100，误判率0.01（精度）</span>
127.0.0.1:6379&gt; bf.add <span class="nb">users </span>value1
<span class="c"># 批量添加</span>
127.0.0.1:6379&gt; bf.madd <span class="nb">users </span>value2 value3
127.0.0.1:6379&gt; <span class="nb">type users
</span>MBloom

<span class="c"># 2、手动编写 bf 的配置，误判率0.001（精度），过滤器容量 10000个元素，添加的条目数超过此数字后，性能将开始下降</span>
<span class="c"># 如果对应的key已存在，会报错</span>
127.0.0.1:6379&gt; bf.reserve user-bm 0.001 10000 
<span class="o">(</span>error<span class="o">)</span> ERR item exists

<span class="c"># 3、判断是否存在</span>
127.0.0.1:6379&gt; bf.exists user-bm value1  
<span class="c"># 一次匹配多个数据</span>
127.0.0.1:6379&gt; bf.mEXISTS user-bm value1 value2 value3
</code></pre></div></div>

<h3 id="java集成redis-bloomfilter">Java集成Redis BloomFilter</h3>

<p>1、导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- https://mvnrepository.com/artifact/com.redislabs/jrebloom --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.redislabs<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jrebloom<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-m2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、测试</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">coding</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.rebloom.client.Client</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBF</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Client</span> <span class="n">bfClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Client</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">6379</span><span class="o">);</span>
    <span class="c1">// 创建一个过滤器，容量为1000个元素，误判率为0.01</span>
    <span class="n">bfClient</span><span class="o">.</span><span class="na">createFilter</span><span class="o">(</span><span class="s">"icoding"</span><span class="o">,</span><span class="mi">1000</span><span class="o">,</span><span class="mf">0.01</span><span class="o">);</span>
    <span class="c1">// 向bf中添加数据（将这个数据hash运算之后，）</span>
    <span class="n">bfClient</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"bm-icoding"</span><span class="o">,</span><span class="s">"arry"</span><span class="o">);</span>
    <span class="c1">// 然后再次判断这个值是够存在 coding，hash，然后比对。！</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bfClient</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="s">"bm-icoding"</span><span class="o">,</span><span class="s">"coding"</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>小结</strong></p>

<p>本质上布隆过滤器是一种数据结构，比较巧妙的概率型数据结构（probabilistic data structure），特点是高效地插入和查询，可以用来告诉你<font color="red"> “某样东西一定不存在或者可能存在”。</font></p>

<p>相比于传统的 List、Set、Map 等数据结构，<mark>它更高效、占用空间更少</mark>，但是<mark>缺点是其返回的结果是概率性的，而不是确切的</mark>。</p>

<p>参考：<a href="https://blog.csdn.net/weixin_45727359/article/details/106110663">https://blog.csdn.net/weixin_45727359/article/details/106110663</a></p>

<p>​			<a href="https://blog.csdn.net/u011870547/article/details/106018872/">https://blog.csdn.net/u011870547/article/details/106018872/</a></p>

<p>​			<a href="https://juejin.im/post/5c9d8db9f265da60f5612835">https://juejin.im/post/5c9d8db9f265da60f5612835</a></p>

<h2 id="7分布式锁redisson">7、分布式锁Redisson</h2>

<blockquote>
  <p>高效的分布式锁（设计）</p>
</blockquote>

<p>1、<mark>互斥</mark>（在分布式高并发的情况下，同一时刻只能有一个线程获得锁，最基本的点）</p>

<p>2、防止死锁（在分布式高并发的情况下，有线程获得锁的同时，还没有来的去释放锁，现在系统故障了，其他线程都无法获取，死锁），因此所有的锁都需要设置<mark>有效时间</mark>，解决死锁问题。</p>

<p>3、性能（减少锁等待时间，避免大量线程阻塞）</p>

<ul>
  <li><mark>锁的粒度要小</mark>，比如你要通过锁来减库存，那这个锁的名称你可以设置成是商品的ID,而不是任取名称。这样这个锁只对当前商品有效,锁的颗粒度小。</li>
  <li>锁的范围一定要小，比如只要锁2行代码就可以解决问题的，那就不要去锁10行代码了。</li>
</ul>

<p>4、可重入锁（即同一个线程可以重复拿到同一个资源的锁，JUC的ReentrantLock就是可重入锁）</p>

<blockquote>
  <p>Redisson</p>
</blockquote>

<ul>
  <li>加锁</li>
  <li>锁有效时间（解决死锁问题，保证高可用）</li>
  <li>锁删除</li>
</ul>

<p>使用</p>

<p>1、导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.redisson<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>redisson-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.12.5<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、分析源码</p>

<p>全局搜索RedissonAutoconfiguration，</p>

<p><img src="/assets/images/2020/redis/redisson-autoconfiguration.gif" alt="" /></p>

<p>redisson是基于redis的分布式锁，但是并不是使用lettuce作为连接池，而是使用redisson作为连接池，而且比RedisAutoconfiguration先加载的。</p>

<p><img src="/assets/images/2020/redis/redisson-factory.gif" alt="" /></p>

<p>3、编写测试代码</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestRedisson</span> <span class="o">{</span>

	<span class="nd">@Autowired</span>
	<span class="nc">RedissonClient</span> <span class="n">redissonClient</span><span class="o">;</span>

	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"redission"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">testRedison</span><span class="o">(){</span>
		<span class="nc">RLock</span> <span class="n">userLock</span> <span class="o">=</span> <span class="n">redissonClient</span><span class="o">.</span><span class="na">getLock</span><span class="o">(</span><span class="s">"userid:1223"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"get Lock"</span><span class="o">);</span>
		<span class="k">try</span><span class="o">{</span>
			<span class="c1">// 如果有锁，等待5秒，如果拿到了锁持有30秒</span>
			<span class="n">userLock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span><span class="mi">30</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"获取到锁"</span><span class="o">);</span>
			<span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"88"</span><span class="o">);</span>
		<span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"释放锁"</span><span class="o">);</span>
			<span class="n">userLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="s">"redission"</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>启动项目，浏览器访问http://localhost:8080/redission</p>

<p>后台输出：</p>

<p><img src="/assets/images/2020/redis/redisson-lock-test-success.gif" alt="" /></p>

<p>redisson默认就是加锁30秒，建议也是30秒以上，它还有一个监视锁的机制，<font color="red">默认的lockWatchdogTimeout会每隔10秒观察一下，待到20秒的时候如果主进程还没有释放锁，就会主动续期30秒</font></p>

<p>分布式锁流程</p>

<p><img src="/assets/images/2020/redis/redisson-lock.png" alt="" /></p>

<ul>
  <li>
    <p>加锁机制</p>

    <p>线程去获取锁，获取成功: 执行lua脚本，保存数据到redis数据库。</p>

    <p>线程去获取锁，获取失败: 一直通过while循环尝试获取锁，获取成功后，执行lua脚本，保存数据到redis数据库。</p>
  </li>
  <li>
    <p>Watch dog延迟锁有效时间机制</p>
  </li>
  <li>
    <p>可重入锁机制</p>

    <p>Redisson可以实现可重入加锁机制的原因，我觉得跟两点有关：</p>

    <ul>
      <li>1、Redis存储锁的数据类型是 Hash类型</li>
      <li>2、Hash数据类型的key值包含了当前线程信息。</li>
    </ul>

    <p>下面是redis存储锁的机制</p>

    <p><img src="/assets/images/2020/redis/redisson-lock-savein-redis.gif" alt="" /></p>
  </li>
</ul>

<p>点进RedissonLock.java的源码，找到trylock方法</p>

<p><img src="\assets\images\2021\redis\redisson-trylock.jpg" alt="" /></p>

<p><code class="highlighter-rouge">tryAcquire</code>就是加锁方法，</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">Long</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">long</span> <span class="n">leaseTime</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">,</span> <span class="kt">long</span> <span class="n">threadId</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">tryAcquireAsync</span><span class="o">(</span><span class="n">leaseTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="n">threadId</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>点击<code class="highlighter-rouge">tryAcquireAsync</code>方法</p>

<p><img src="\assets\images\2021\redis\redisson-tryAcquireAsync.jpg" alt="" /></p>

<p>从源码可以看出，leaseTime持锁时间等于-1的时候，才会启动watchdog机制，获取一个30秒的锁，<code class="highlighter-rouge">scheduleExpirationRenewal</code>方法给锁失效前进行续命，点击源码</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">scheduleExpirationRenewal</span><span class="o">(</span><span class="kt">long</span> <span class="n">threadId</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">ExpirationEntry</span> <span class="n">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExpirationEntry</span><span class="o">();</span>
  <span class="nc">ExpirationEntry</span> <span class="n">oldEntry</span> <span class="o">=</span> <span class="no">EXPIRATION_RENEWAL_MAP</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">getEntryName</span><span class="o">(),</span> <span class="n">entry</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">oldEntry</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">oldEntry</span><span class="o">.</span><span class="na">addThreadId</span><span class="o">(</span><span class="n">threadId</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">addThreadId</span><span class="o">(</span><span class="n">threadId</span><span class="o">);</span>
    <span class="n">renewExpiration</span><span class="o">();</span> <span class="c1">// 失效前续命</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>点击 <code class="highlighter-rouge">renewExpiration</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">renewExpiration</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">ExpirationEntry</span> <span class="n">ee</span> <span class="o">=</span> <span class="no">EXPIRATION_RENEWAL_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">getEntryName</span><span class="o">());</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">ee</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nc">Timeout</span> <span class="n">task</span> <span class="o">=</span> <span class="n">commandExecutor</span><span class="o">.</span><span class="na">getConnectionManager</span><span class="o">().</span><span class="na">newTimeout</span><span class="o">(</span><span class="k">new</span> <span class="nc">TimerTask</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">Timeout</span> <span class="n">timeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">ExpirationEntry</span> <span class="n">ent</span> <span class="o">=</span> <span class="no">EXPIRATION_RENEWAL_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">getEntryName</span><span class="o">());</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nc">Long</span> <span class="n">threadId</span> <span class="o">=</span> <span class="n">ent</span><span class="o">.</span><span class="na">getFirstThreadId</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">threadId</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nc">RFuture</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">renewExpirationAsync</span><span class="o">(</span><span class="n">threadId</span><span class="o">);</span> <span class="c1">// 重点，锁续命</span>
      <span class="n">future</span><span class="o">.</span><span class="na">onComplete</span><span class="o">((</span><span class="n">res</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Can't update lock "</span> <span class="o">+</span> <span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" expiration"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
          <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">res</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 续命成功，调用本身10后又来检查锁</span>
          <span class="c1">// reschedule itself</span>
          <span class="n">renewExpiration</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">});</span>
    <span class="o">}</span>
  <span class="o">},</span> <span class="n">internalLockLeaseTime</span> <span class="o">/</span> <span class="mi">3</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span> <span class="c1">// 这里internalLockLeaseTime是30秒,也就是10秒后观察锁的失效，</span>

  <span class="n">ee</span><span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>重点，锁续命方法<code class="highlighter-rouge">renewExpirationAsync</code>，点击源码</p>

<p><img src="\assets\images\2021\redis\redisson-renew-expiration.jpg" alt="" /></p>

<p>最终调用redis pexpire命令给key(锁名称)续命30毫秒，不过前面<code class="highlighter-rouge">trylock</code>的时候参数leaseTime=-1才会启动watchDog机制给锁续命，其实就是每隔10秒重新设置redis 的key过期时间为30秒后。</p>

<p><mark>缺点</mark></p>

<p>在redis master实例宕机的时候，可能导致多个客户端同时完成加锁：如果你对某个redis master实例，写入了myLock这种锁key的value，此时会异步复制给对应的master slave实例。但是这个过程中一旦发生redis master宕机，主备切换，redis slave成为新的redis master，但是没有myLock锁。接着就会导致，客户端2来尝试加锁的时候，在新的redis master上完成了加锁，而客户端1也以为自己成功加了锁。此时就会导致多个客户端对一个分布式锁完成了加锁。这时系统在业务上一定会出现问题，导致脏数据的产生。</p>

<p>参考：</p>

<ul>
  <li><a href="https://www.cnblogs.com/qdhxhz/p/11046905.html">https://www.cnblogs.com/qdhxhz/p/11046905.html</a></li>
  <li><a href="https://blog.csdn.net/chongbaozhong/article/details/114682080">https://blog.csdn.net/chongbaozhong/article/details/114682080</a></li>
  <li>https://www.cnblogs.com/wkynf/p/14479779.html</li>
</ul>

<h2 id="8redis60新特性">8、Redis6.0新特性</h2>

<p>Redis6.0开始支持多线程IO，但是默认是不开启的，默认还是单线程</p>

<p>打开redis.conf，可以看到多线程的相关配置是注释了</p>

<p><img src="/assets/images/2020/redis/redis-version6-io-threads.png" alt="" /></p>

<p>redis瓶颈在 cpu 和 内存！ 和IO线程无关</p>

<p>新特性参考这篇博客：<a href="https://www.cnblogs.com/madashu/p/12832766.html">https://www.cnblogs.com/madashu/p/12832766.html</a></p>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-edu/2020/05/20/icoding-note-037.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
