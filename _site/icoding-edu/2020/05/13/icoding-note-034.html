<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 飞天班第34节：Redis（1） - 大伟的博客 </title>
    <meta name="keywords" content="redis">
    <meta name="description"
          content="什么是NoSql，NoSql四大分类，什么是Redis，window、linux、Mac安装Redis，启动与停止redis服务，压力测试redis,redis的管道技术提高并发量吞吐量，Redis的key常用命令,config命令获取当前配置信息,String类型，dump命令避免redis服务端的反序列化操作，减少客户端等待redis命令请求的结果返回时间">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-edu/2020/05/13/icoding-note-034.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="飞天班第34节：Redis（1）">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>飞天班第34节：Redis（1）</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/05/13
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1nosql">1、NoSQL</h2>

<h3 id="nosql的概述">NoSQL的概述</h3>

<p>NoSQL(Not Only Sql)，分析一下历史，为什么会诞生NoSql，它帮助我们解决什么问题？</p>

<blockquote>
  <p>1、单机MySql使用</p>
</blockquote>

<p>早些年，小型网站很多，他们的访问量也不大，一个数据库完全可以搞定。但随着数据量和访问量的增大，就会产生瓶颈：</p>

<ul>
  <li>数据量如果太大，一个机器放不下</li>
  <li>数据的索引太大，一个机器内存也放不下</li>
  <li>访问量变大导致一个数据库实例不能够承受</li>
</ul>

<p>这个时候就需要升级了</p>

<font color="red">在架构中，没有什么是加一层解决不了的。</font>
<p>生活很多事情也是如此，如管理。</p>

<blockquote>
  <p>2、Memcache(缓存) + Mysql + 垂直拆分</p>
</blockquote>

<p>最初一般先加一层缓存解决，缓存热点数据，缓解数据库的压力，然后下一步优化数据库的结构和索引。使用Memcache成为这个时候最流行的产品</p>

<p>Memcache的优点：</p>

<ul>
  <li>
    <p>简单的key - value 存储</p>
  </li>
  <li>内存使用率高</li>
  <li>多核，多线程</li>
</ul>

<p>它的缺点：</p>

<ul>
  <li>无法容灾</li>
  <li>无法持久化</li>
</ul>

<p><img src="/assets/images/2020/redis/memcache-tushi.gif" alt="" /></p>

<blockquote>
  <p>3、主从复制和读写分离</p>
</blockquote>

<p>随着访问量更大，我们的数据库的写压力也增加了，Memcache只是解决了读的问题。</p>

<p>我们通过主从复制和读写分离来提高数据库的可读性和可扩展</p>

<p><img src="/assets/images/2020/redis/memcache-and-mysql-master-slave.gif" alt="" /></p>

<blockquote>
  <p>4、分库分表 + 水平拆分 + Mysql集群</p>
</blockquote>

<p>我们的数据量持续增大，Mysql的读和写会慢慢出现瓶颈。</p>

<ul>
  <li>
    <p>高并发问题，Mysql最开始的时候使用MyISAM(表锁) ，一个请求就把表给锁了（其实我只是修改一行），高并发的时候，性能低，后来使用InnoDB（行锁）解决。</p>
  </li>
  <li>
    <p>缓存问题，缓存数据量大，需要精简数据，提高热点数据的精度，使用分库分表，是基于业务相关来拆分表的，如下面的</p>

    <p>edu</p>

    <ul>
      <li>
        <p>user 表</p>

        <p>用户信息10个字段</p>

        <p>展示3个字段</p>

        <p>用户订单相关字段</p>
      </li>
      <li>
        <p>Course 表</p>
      </li>
      <li>
        <p>。。。100个表</p>
      </li>
    </ul>
  </li>
  <li>
    <p>表分区</p>
  </li>
  <li>
    <p>Mysql cluster 集群，高可用</p>

    <p>到这里使用集群这个架构，已经完全满足大部分的要求，横向扩展添加机器就行。</p>

    <p><img src="/assets/images/2020/redis/memcache-mysql-cluster.gif" alt="" /></p>
  </li>
</ul>

<blockquote>
  <p>5、寻求更加完美的解决方案</p>
</blockquote>

<p>Mysql是可以存储大文本的，数据表的压力会十分的大，要恢复数据的时候会特别慢 。假设有1000万条4kb大小的记录，接近40GB，如果能把这些数据从Mysql剔除，我们的Mysql数据库就会变得十分轻巧。</p>

<p>关系性数据库很强大，但是它并不能够很好的适应所有场景。如Mysql的扩展性比较差，大数据量IO压力大，假设1000万的数据要增加一个列，就会十分的困难了，Mysql开发人员就会很痛苦了。</p>

<font color="red">NoSQL(非关系型数据库) 和 MySQL(关系型数据库)</font>

<p>今天，我们的应用十分的复杂，集成了很多第三方平台，可以十分轻松的获取数据，如用户的信息、社交网络、地理位置等，这些数据每天都爆增，对这些数据进行操作，SQL关系性数据库就完全无法适应，而非关系型数据库在这上面就显得如鱼得水，如Redis、MongoDB。</p>

<p>最佳实践：NoSQL(非关系型数据库) + MySQL(关系型数据库)，综合才是王道！</p>

<h3 id="什么是nosql">什么是NoSQL</h3>

<p>Not Only Sql，不仅仅是SQL，泛指非关系型数据库</p>

<p>问题：大量的web2.0时代的产品，纯动态网站，海量的多样数据，关系型数据库解决不了</p>

<p>解决：存储的问题，NoSQL数据库的产生就是为了解决大规模数据集合多种多样的情况和挑战。</p>

<blockquote>
  <p>它的特点</p>
</blockquote>

<ul>
  <li>
    <p>易扩展</p>

    <p>由于去掉了数据的关系性，扩展就十分方便了</p>
  </li>
  <li>
    <p>大数据量高性能</p>

    <p>得益于数据之间没有关系，NoSQL数据库一般都是有很高的读写性能的，如Redis官方记录一秒读11万次，一秒写8万次。</p>
  </li>
  <li>
    <p>数据类型是灵活的</p>

    <p>NoSQL不需要给数据设置字段规则，随时可以存储自定义的格式</p>
  </li>
</ul>

<blockquote>
  <p>与关系型数据库的比较</p>
</blockquote>

<table>
  <thead>
    <tr>
      <th>RDBMS</th>
      <th>NoSQL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>结构化的数据</td>
      <td>不仅仅是SQL</td>
    </tr>
    <tr>
      <td>结构化的查询语言SQL</td>
      <td>没有声明式的查询语言get set</td>
    </tr>
    <tr>
      <td>所有的数据和关系都是存储在单独的表中</td>
      <td>键值对存储，列存储，文档存储，图形数据库</td>
    </tr>
    <tr>
      <td>预定义的模式</td>
      <td>没有预定义的模式</td>
    </tr>
    <tr>
      <td>事务支持</td>
      <td>没有事务</td>
    </tr>
    <tr>
      <td>纵向扩展</td>
      <td>高可用，高性能，可伸缩，横向扩展</td>
    </tr>
    <tr>
      <td>严格的一致性</td>
      <td>最终一致性</td>
    </tr>
    <tr>
      <td>ACID</td>
      <td>CAP定理</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>大数据时代的特征</p>
</blockquote>

<p><strong>3V</strong>：针对问题的描述</p>

<ul>
  <li>海量（Volume [ˈvɑːljuːm]），数据量越来越大</li>
  <li>多样（Velocity  [vəˈlɑːsəti]），各种各样类型的数据出现，类型多样</li>
  <li>速度（Variety ），数据量增长越来越快，需要处理的速度和响应越来越快</li>
</ul>

<p><strong>3高</strong>：对程序的基本要求</p>

<ul>
  <li>高并发</li>
  <li>高可用</li>
  <li>高性能</li>
</ul>

<font color="red">技术没有高低之分，NoSQL(非关系型数据库) + MySQL(关系型数据库) ,结合才是王道</font>

<h3 id="nosql的四大分类">NoSQL的四大分类</h3>

<p>1、<strong>KV键值对</strong></p>

<ul>
  <li>美团： Redis + tair</li>
  <li>阿里/百度：Redis + Memcache</li>
</ul>

<p>2、<strong>文档型数据库</strong></p>

<ul>
  <li>
    <p>MongoDB</p>

    <p>基于分布式文件存储的数据库，C++编写的。它就是介于关系型数据库和非关系型数据库之间的产品，是非关系数据库中最像关系型数据库的产品</p>
  </li>
  <li>
    <p>CouchDb</p>
  </li>
</ul>

<p>3、<strong>列存储数据库</strong></p>

<ul>
  <li>HBase + Cassandra</li>
  <li>分布式文件系统</li>
</ul>

<p>4、<strong>图关系数据库</strong></p>

<ul>
  <li>Neo4j,InfoGrid</li>
  <li>拓扑图，社交网络图</li>
</ul>

<p><img src="/assets/images/2020/redis/the-social-netword.jpg" alt="" /></p>

<p>对比</p>

<p><img src="/assets/images/2020/redis/nosql-4-type.jpg" alt="" /></p>

<p>理解NoSQL模型</p>

<p>例子：商品购买下订单</p>

<p>1、关系型数据库</p>

<p>ER图</p>

<p><img src="/assets/images/2020/redis/sql-er.gif" alt="" /></p>

<p>2、非关系型数据库</p>

<p>使用BSON数据类型</p>

<p><img src="/assets/images/2020/redis/nosql-bson-customer.gif" alt="" /></p>

<h2 id="2redis">2、Redis</h2>

<p>Redis( Remote Dictionary Server)，即远程字典服务，是一个开源的使用ANSI <a href="https://baike.baidu.com/item/C语言">C语言</a>编写（效率高）、支持网络、可基于内存亦可持久化的日志型、Key-Value<a href="https://baike.baidu.com/item/数据库/103728">数据库</a>，并提供多种语言的API。</p>

<p>是当下最热门的NoSQL数据库之一，数据结构服务器</p>

<p>对比其他key -value缓存产品的特点</p>

<ul>
  <li>支持数据的持久化，重启的话，数据不会丢失</li>
  <li>支持多种数据类型：string，list，set，hash，geo…</li>
  <li>支持备份，支持主从复制，哨兵模式，集群模式</li>
</ul>

<p><strong>Redis可以做什么</strong></p>

<ul>
  <li>内部存储和持久化</li>
  <li>
    <p>支持多种数据类型，满足日常</p>
  </li>
  <li>发布、订阅系统</li>
  <li>地图分析</li>
  <li>定时器</li>
  <li>统计打卡</li>
  <li>优化算法，hyperloglog、bitmap</li>
</ul>

<p>官网：<a href="https://redis.io/">https://redis.io/</a></p>

<p><img src="/assets/images/2020/redis/redis-io-6.gif" alt="" /></p>

<p>中文网：<a href="https://www.redis.net.cn/">https://www.redis.net.cn/</a></p>

<p><img src="/assets/images/2020/redis/redis-cn-5.gif" alt="" /></p>

<h3 id="安装redis">安装Redis</h3>

<blockquote>
  <p>Windows下安装</p>
</blockquote>

<p>windows只支持3.x版本，直接解压后启动服务端redis-server.exe</p>

<p><img src="/assets/images/2020/redis/redis-on-window.gif" alt="" /></p>

<p>启动客户端redis-cli.exe 连接</p>

<blockquote>
  <p>Linux下安装</p>
</blockquote>

<p>1、上官网https://redis.io/，下载最新版本redis-6.0.1.tar.gz上传到服务器的/opt目录下，解压</p>

<p><img src="/assets/images/2020/redis/redis-on-linux.gif" alt="" /></p>

<p>2、执行make命令安装</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装gcc环境</span>
yum <span class="nt">-y</span> <span class="nb">install </span>gcc-c++
<span class="c"># redis 6.0版本 需要升级 gcc环境</span>
<span class="o">[</span>root@localhost redis-6.0.1]# yum <span class="nt">-y</span> <span class="nb">install </span>centos-release-scl
<span class="o">[</span>root@localhost redis-6.0.1]# yum <span class="nt">-y</span> <span class="nb">install </span>devtoolset-9-gcc  devtoolset-9-gcc-c++ devtoolset-9-binutils
<span class="o">[</span>root@localhost redis-6.0.1]# scl <span class="nb">enable </span>devtoolset-9 bash
<span class="o">[</span>root@localhost redis-6.0.1]# <span class="nb">echo</span> <span class="s2">"source /opt/rh/devtoolset-9/enable"</span> <span class="o">&gt;&gt;</span> /etc/profile
<span class="o">[</span>root@localhost redis-6.0.1]# make 
</code></pre></div></div>

<p>3、再次执行make install</p>

<p><img src="/assets/images/2020/redis/redis-make-install.gif" alt="" /></p>

<p>4、安装成功后，redis的相关命令放在redis-6.0.1/src目录下，同时也会放在 /usr/local/bin目录下，如下图：</p>

<p><img src="/assets/images/2020/redis/redis-usr-local-bin.gif" alt="" /></p>

<p>5、启动redis服务</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#1.在/usr/local下创建redis目录</span>
<span class="nb">mkdir</span> /usr/local/redis
<span class="c">#2.复制redis.conf文件，以redis的端口号命名</span>
<span class="nb">cd </span>redis-6.0.1
<span class="nb">cp </span>redis.conf /usr/local/redis/6379.conf

<span class="c">#3.修改配置文件,更多配置参数看文档注释</span>
vi redis.conf
daemonize <span class="nb">yes</span> <span class="c">#后台运行</span>
<span class="nb">bind </span>0.0.0.0 <span class="c">#不限制ip访问</span>
requirepass icoding <span class="c">#配置密码</span>
<span class="nb">dir</span> /usr/local/redis/working <span class="c">#工作目录，rdb备份的数据保存目录</span>

<span class="c">#4.指定配置文件启动redis</span>
redis-server /usr/local/redis/6379.conf
<span class="c"># 不指定配置文件启动</span>
redis-server

<span class="c"># 进入客户端</span>
<span class="c"># /usr/local/bin下就有reds-server和reds-cli脚本，可以直接执行命令</span>
redis-cli <span class="nt">-p</span> 6379 <span class="c"># 指定端口连接redis</span>
redis-cli <span class="nt">--help</span>
redis-cli <span class="nt">-h</span> 10.12.13.1 <span class="nt">-p</span> 6379 <span class="nt">-u</span> jacob <span class="nt">-a</span> <span class="c"># 连接远程redis的客户端</span>
</code></pre></div></div>

<p>6、停止redis服务</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 查看6379端口，是否redis已启动</span>
lsof <span class="nt">-i</span> tcp:6379
<span class="c"># 查看redis进程</span>
ps <span class="nt">-ef</span>|grep redis
ps aux|grep redis
<span class="c"># 正常停止redis服务</span>
redis-cli shutdown <span class="c"># 默认端口6379</span>
redis-cli <span class="nt">-p</span> 8080 shutdown <span class="c"># 指定端口关闭服务</span>
<span class="c"># 远程关闭redis 服务器</span>
redis-cli <span class="nt">-h</span> xxx.xxx.xxx.xxx  <span class="nt">-p</span> xxxx <span class="nt">-u</span> xxxx <span class="nt">-a</span> xxxx  shutdown
<span class="c"># 杀死进程的方式停止redis服务,PID通过前面ps命令查看进程ID</span>
<span class="nb">kill</span> <span class="nt">-9</span> PID

</code></pre></div></div>

<p>7、卸载redis服务</p>

<p>停止redis服务后，</p>

<ul>
  <li>删除/usr/local/lib目录下与redis 相关的命令</li>
  <li>删除redis 解压后的目录 redis-6.0.1 即可</li>
</ul>

<blockquote>
  <p>Mac下安装</p>
</blockquote>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 解压</span>
<span class="nb">tar </span>zxvf redis-4.0.9.tar.gz
<span class="c"># 移动</span>
<span class="nb">mv </span>redis-4.0.9 /usr/local/
<span class="nb">cd</span> /usr/local/redis-4.0.9
<span class="c"># 编译测试</span>
<span class="nb">sudo </span>make <span class="nb">test</span>
<span class="c"># 编译安装</span>
<span class="nb">sudo </span>make <span class="nb">install</span>
</code></pre></div></div>

<p>注意，如果<code class="highlighter-rouge">redis-server</code>启动redis遇到没权限，提示<code class="highlighter-rouge">permission denied</code>，要修改redis文件夹的权限，脚步如下：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 修改redis文件夹的属主、属组、其它用户的rwx 读写执行权限，全部放开</span>
<span class="nb">sudo chmod</span> <span class="nt">-R</span> 777 文件目录
<span class="c"># 然后需要输入当前用户（要有管理员权限）的密码，就可以了，如下：</span>
xjwdeMacBook:local xjw<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> redis-4.0.13/
total 0
drwxrwxrwx@ 3 xjw  staff  96  6 18 21:55 tests
</code></pre></div></div>

<p>启动成功</p>

<p><img src="/assets/images/2021/redis/start-success-mac.jpg" alt="" /></p>

<h3 id="压力测试">压力测试</h3>

<blockquote>
  <p>redis-benchmark redis自带的压力测试工具</p>
</blockquote>

<p>模拟高并发情况测试redis性能</p>

<p>redis 性能测试工具可选参数如下所示：</p>

<table>
  <thead>
    <tr>
      <th>序号</th>
      <th>选项</th>
      <th>描述</th>
      <th>默认值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td><strong>-h</strong></td>
      <td>指定服务器主机名</td>
      <td>127.0.0.1</td>
    </tr>
    <tr>
      <td>2</td>
      <td><strong>-p</strong></td>
      <td>指定服务器端口</td>
      <td>6379</td>
    </tr>
    <tr>
      <td>3</td>
      <td><strong>-s</strong></td>
      <td>指定服务器 socket</td>
      <td> </td>
    </tr>
    <tr>
      <td>4</td>
      <td><strong>-c</strong></td>
      <td>指定并发连接数</td>
      <td>50</td>
    </tr>
    <tr>
      <td>5</td>
      <td><strong>-n</strong></td>
      <td>指定请求数</td>
      <td>10000</td>
    </tr>
    <tr>
      <td>6</td>
      <td><strong>-d</strong></td>
      <td>以字节的形式指定 SET/GET 值的数据大小</td>
      <td>2</td>
    </tr>
    <tr>
      <td>7</td>
      <td><strong>-k</strong></td>
      <td>1=keep alive 0=reconnect</td>
      <td>1</td>
    </tr>
    <tr>
      <td>8</td>
      <td><strong>-r</strong></td>
      <td>SET/GET/INCR 使用随机 key, SADD 使用随机值</td>
      <td> </td>
    </tr>
    <tr>
      <td>9</td>
      <td><strong>-P</strong></td>
      <td>通过管道传输 <numreq> 请求</numreq></td>
      <td>1</td>
    </tr>
    <tr>
      <td>10</td>
      <td><strong>-q</strong></td>
      <td>强制退出 redis。仅显示 query/sec 值</td>
      <td> </td>
    </tr>
    <tr>
      <td>11</td>
      <td><strong>–csv</strong></td>
      <td>以 CSV 格式输出</td>
      <td> </td>
    </tr>
    <tr>
      <td>12</td>
      <td><strong>-l</strong></td>
      <td>生成循环，永久执行测试</td>
      <td> </td>
    </tr>
    <tr>
      <td>13</td>
      <td><strong>-t</strong></td>
      <td>仅运行以逗号分隔的测试命令列表。</td>
      <td> </td>
    </tr>
    <tr>
      <td>14</td>
      <td><strong>-I</strong></td>
      <td>Idle 模式。仅打开 N 个 idle 连接并等待。</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 测试一：100个并发连接数，100000个请求</span>
<span class="o">[</span>root@iZwz996g0 redis-6379]# redis-benchmark <span class="nt">-h</span> localhost <span class="nt">-p</span> 6379 <span class="nt">-c</span> 100 <span class="nt">-n</span> 100000
<span class="c"># 测试结果</span>
<span class="o">======</span> SET <span class="o">======</span>
  100000 requests completed <span class="k">in </span>1.69 seconds  <span class="c"># 100000个请求完成的时间</span>
  100 parallel clients
  3 bytes payload <span class="c"># 每次写入 3个字节的数据</span>
  keep alive: 1	<span class="c"># 保持一个连接</span>

75.86% &lt;<span class="o">=</span> 1 milliseconds
98.64% &lt;<span class="o">=</span> 2 milliseconds
99.82% &lt;<span class="o">=</span> 3 milliseconds
99.90% &lt;<span class="o">=</span> 7 milliseconds
99.92% &lt;<span class="o">=</span> 8 milliseconds
99.96% &lt;<span class="o">=</span> 9 milliseconds
99.98% &lt;<span class="o">=</span> 10 milliseconds
100.00% &lt;<span class="o">=</span> 10 milliseconds 
59206.63 requests per second <span class="c"># 每秒处理的请求次数</span>
</code></pre></div></div>

<h3 id="默认16个数据库">默认16个数据库</h3>

<p>redis.conf配置文件默认配置了数据库有16个，下标从0开始</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>database 16
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在默认数据库set值</span>
127.0.0.1:6379&gt; <span class="nb">set </span>db0 testdb0
OK
127.0.0.1:6379&gt; <span class="k">select </span>7 <span class="c"># 切换数据库</span>
127.0.0.1:6379&gt; get db0
<span class="o">(</span>nil<span class="o">)</span>
127.0.0.1:6379&gt; DBSIZE <span class="c"># 查看当前数据库有多少数据</span>
<span class="o">(</span>integer<span class="o">)</span> 0
127.0.0.1:6379&gt; <span class="k">select </span>0
127.0.0.1:6379&gt; flushdb <span class="c"># 清空当前数据库 谨慎使用</span>
127.0.0.1:6379&gt; flushall <span class="c"># 清空全部数据库 16个都清空</span>
</code></pre></div></div>

<h3 id="pipeline管道">pipeline管道</h3>

<p><strong><font color="red">Redis 性能瓶颈主要是网络，主要原因是 Redis 执行命令的时间通常在微妙级别的，而传输网络是毫秒级别的，慢1000倍。</font></strong></p>

<p>Linux系统底层通过socket是如何通信的，看下图</p>

<p><img src="/assets/images/2020/redis/socket-1.png" alt="" /></p>

<p>计算机A与计算机B的通信过程是这样的：</p>

<p>1、计算机A将要发送的数据写到自己的发送缓冲区里面SendBuffer，Linux操作系统内核会自己把这部分数据，按照设定的协议，通过网关，把数据发送到复杂地计算机网络中。</p>

<p>2、计算机B的内核会接收到这部分信息，并且会把数据拷贝到接受缓冲区RecvBuffer，然后B机器的进程过来Read就能获取到数据，</p>

<p>3、这里就存在这样一种情况，如果Read的时候数据还没有到B机器或者还没拷贝到缓冲区，那么就会阻塞。很明显，如果我们在一次业务查询中有多次请求，那么，我们希望服务器只要从缓冲区里面读取一次数据，那么就能节省一定量的时间，这是一方面。</p>

<p>从另一方面进行考虑，假如我们在一个业务请求中，需要从Redis上获取3个不同的数据，如果我们一次一次的获取，那会怎么样？时间都浪费在了等待网络传输上，正常情况下，我们执行一条 Redis 命令流程要经过如下几个步骤：</p>

<ol>
  <li>客户端发送 Redis 命令，阻塞等待 Redis 应答</li>
  <li>Redis 接收到命令，执行命令</li>
  <li>应答，客户端收到响应信息</li>
</ol>

<p><img src="/assets/images/2020/redis/socket-6.png" alt="" /></p>

<p>其中 1 、3 称之为一次 RTT（Round Trip Time）</p>

<p>看下图</p>

<p><img src="/assets/images/2020/redis/socket-2.png" alt="" /></p>

<p>上面的redis请求有两个缺陷：</p>

<ul>
  <li>每次查询，都有网络上的延迟。特别是如果Redis跟系统服务不在同一个机房，单趟来回可能要10ms，多了两趟来回，就要多20ms。</li>
  <li>对于一个请求，里面需要处理20ms，对于整个请求来说，可能延迟就不止增加20ms了，毕竟服务器是多线程的，可能中途又被Linux操作系统切出去干其他事情，整个系统的并发跟吞吐立马就降下来了</li>
</ul>

<blockquote>
  <p>解决方案</p>
</blockquote>

<p>如果我们能够把三次请求合并成一次丢给服务器，服务器再一次性返回给我们，这不就解决问题了么？这便是Redis的管道！它允许客户端一次性发送多条命令，减少 RTT (Round Trip Time)和 IO 的调用次数（IO 调用涉及到用户态到内核态之间的切换）</p>

<p><img src="/assets/images/2020/redis/socket-3.png" alt="" /></p>

<p>对于Redis来说，还是需要进行3次子查询，但是对于整个系统来说，网络通信的次数只有2次，并发自然就上去了，吞吐自然也上去了。</p>

<p>redis的压力测试工具redis-benchmark 有个-P参数，就是通过管道的方式发送请求，默认管道数是1，我们测试一下增加管道数后看redis的性能有多大的提高</p>

<p><img src="/assets/images/2020/redis/socket-5.png" alt="" /></p>

<p>发现随着管道数的增加，每秒的并发量就提高上去了，但是管道数达到100后，并发量基本上就稳定不上升了，个人觉得是跟机器底层的缓存区有关，应该是饱和了，所以并发量已达到最大化。</p>

<p><strong>总结：pipeline就是把发送给redis服务器的多个请求合并成一个请求发送，减少RTT和IO的调用次数，从而提升性能</strong></p>

<blockquote>
  <p>与批量命令的比较</p>
</blockquote>

<ol>
  <li>
    <p>pipeline 可以一次性发送多个不同的命令，例如 set、get、而批量这是一次一个命令，只不过这一次对应的是多个 key 而已。</p>
  </li>
  <li>
    <p>pipeline 只是将多个命令一起发出去而已，不保证这些命令的执行是原子性，</p>

    <p>而批量提交则是原子性的，他需要保证整个操作的正确性，避免中途出错而导致最后产生的数据不一致。</p>
  </li>
</ol>

<blockquote>
  <p>与单个命令的性能比较测试</p>
</blockquote>

<p><strong>客户端使用jedis</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Jedis</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span><span class="mi">6379</span><span class="o">);</span>
  <span class="c1">// 1、管道</span>
  <span class="nc">Pipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">pipelined</span><span class="o">();</span>
  <span class="kt">long</span> <span class="n">pipelineBegin</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"pipeline:test_"</span><span class="o">+</span><span class="n">i</span><span class="o">,</span><span class="n">i</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">//获取所有的 response</span>
  <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
  <span class="kt">long</span> <span class="n">pipelineEnd</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"the pipeline is :"</span><span class="o">+</span> <span class="o">(</span><span class="n">pipelineEnd</span> <span class="o">-</span> <span class="n">pipelineBegin</span><span class="o">));</span>

  <span class="c1">// 2、单个命令</span>
  <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"jedis:test_"</span><span class="o">+</span><span class="n">i</span><span class="o">,</span><span class="n">i</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"the jedis is:"</span><span class="o">+</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>运行结果：</p>

<p><img src="/assets/images/2020/redis/redis-pipeline.jpg" alt="" /></p>

<p>发现使用管道后，比普通方式性能提升了8倍。</p>

<p><strong>客户端使用redisTemplate</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testPipeline</span><span class="o">(){</span>
  <span class="c1">// 1.管道</span>
  <span class="kt">long</span> <span class="n">pipelineBegin</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="n">redisTemplate</span><span class="o">.</span><span class="na">executePipelined</span><span class="o">(</span><span class="k">new</span> <span class="nc">SessionCallback</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nc">String</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">RedisOperations</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">redisOperations</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">DataAccessException</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"pipeline:test_"</span><span class="o">+</span><span class="n">i</span><span class="o">,</span><span class="n">i</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">});</span>
  <span class="kt">long</span> <span class="n">pipelineEnd</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"the pipeline is :"</span><span class="o">+</span> <span class="o">(</span><span class="n">pipelineEnd</span> <span class="o">-</span> <span class="n">pipelineBegin</span><span class="o">));</span>

  <span class="c1">// 2、单个命令</span>
  <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"template:test_"</span><span class="o">+</span><span class="n">i</span><span class="o">,</span><span class="n">i</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"the jedis is:"</span><span class="o">+</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>运行结果</p>

<p><img src="/assets/images/2020/redis/redis-pipeline-2.jpg" alt="" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">testPipeline</span><span class="o">(){</span>
  <span class="c1">// 1.管道</span>
  <span class="kt">long</span> <span class="n">pipelineBegin</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">objects</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">executePipelined</span><span class="o">(</span><span class="k">new</span> <span class="nc">RedisCallback</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">doInRedis</span><span class="o">(</span><span class="nc">RedisConnection</span> <span class="n">redisConnection</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">DataAccessException</span> <span class="o">{</span>
      <span class="n">redisConnection</span><span class="o">.</span><span class="na">openPipeline</span><span class="o">();</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"pipeline:test_"</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>
        <span class="n">redisConnection</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getBytes</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">});</span>
  <span class="kt">long</span> <span class="n">pipelineEnd</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"the pipeline is :"</span><span class="o">+</span> <span class="o">(</span><span class="n">pipelineEnd</span> <span class="o">-</span> <span class="n">pipelineBegin</span><span class="o">));</span>

  <span class="c1">// 2、单个命令</span>
  <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">opsForValue</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"template:test_"</span><span class="o">+</span><span class="n">i</span><span class="o">,</span><span class="n">i</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"the jedis is:"</span><span class="o">+</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>运行结果</p>

<p><img src="/assets/images/2020/redis/redis-pipeline-3.jpg" alt="" /></p>

<p>在这里需要注意4点内容：</p>

<ul>
  <li>这里的connect是redis原生链接，所以connection的返回结果是基本上是byte数组，如果需要存储的数据，需要对byte[]数组反序列化。</li>
  <li>在doInRedis中返回值必须返回为null，为什么返回为空？可以定位到内部代码去查看详情，这里不再赘</li>
  <li>connection.openPipeline()可以调用，也可以不调用，但是connection.closePipeline()不能调用，调用了拿不到返回值。因为调用的时候会直接将结果返回，同时也不会对代码进行反序列化。</li>
  <li>反序列化需要传入反序列化对象，这些对象都可以进行相应的实例化。</li>
</ul>

<p>根据你的项目需求选择合适的反序列化对象。比如我在项目中key使用的是StringRedisSerializer，而值通常使用的是GenerJackson2JsonRedisSerializer。所以在初始化redisTemplate的时候会这样做，代码如下，将序列化的实例化对象放入redisTemplate中，当使用的时候就可以直接redis.getKeySerializer()或者redis.getValueSerializer(),这样就不用在实例化一个对象，造成浪费和冗余。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyRedisUtil</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRedisTemplate</span><span class="o">(</span><span class="nc">RedisTemplate</span> <span class="n">redisTemplate</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">RedisSerializer</span> <span class="n">keySerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">();</span>
    <span class="nc">RedisSerializer</span> <span class="n">valueSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericJackson2JsonRedisSerializer</span><span class="o">();</span>
    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setKeySerializer</span><span class="o">(</span><span class="n">keySerializer</span><span class="o">);</span>
    <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setValueSerializer</span><span class="o">(</span><span class="n">valueSerializer</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">redisTemplate</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">RedisTemplate</span> <span class="nf">getRedisTemplate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">redisTemplate</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>通过这样的掉用方式，我们就可以不用进行强制转换，直接获得我们想要的对象了。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nc">List</span> <span class="o">=</span> <span class="n">redisTemplate</span><span class="o">.</span><span class="na">executePipelined</span><span class="o">(</span><span class="k">new</span> <span class="nc">RedisCallback</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;()</span> <span class="o">{</span>
  <span class="nd">@Nullable</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">User</span> <span class="nf">doInRedis</span><span class="o">(</span><span class="nc">RedisConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">DataAccessException</span> <span class="o">{</span>
    <span class="n">connection</span><span class="o">.</span><span class="na">openPipeline</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"123"</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>
      <span class="n">connection</span><span class="o">.</span><span class="na">zCount</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">},</span> <span class="n">myRedisComponent</span><span class="o">.</span><span class="na">getRedisTemplate</span><span class="o">().</span><span class="na">getValueSerializer</span><span class="o">());</span>
</code></pre></div></div>

<p>参考博客:</p>

<p><a href="https://blog.csdn.net/chenssy/article/details/104708045/">https://blog.csdn.net/chenssy/article/details/104708045/</a></p>

<p><a href="https://www.cnblogs.com/dobal/p/12039835.html">https://www.cnblogs.com/dobal/p/12039835.html</a></p>

<h2 id="38大数据类型">3、8大数据类型</h2>

<p><img src="/assets/images/2020/redis/redis-eight-type.gif" alt="" /></p>

<h3 id="redis-key-命令">Redis key 命令</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 进入客户端</span>
redis-cli <span class="nt">-p</span> 6379
<span class="c"># 设置 key 的值,没有就创建，有则覆盖</span>
127.0.0.1:6379&gt;set key value 
127.0.0.1:6379&gt;get key
<span class="c">#1 查看所有的key,不要在线上使用，有可能导致服务器崩溃</span>
127.0.0.1:6379&gt; key <span class="k">*</span>
<span class="c">#模糊查询key</span>
127.0.0.1:6379&gt; keys abc<span class="k">*</span>
<span class="c">#2 判断一个key是否存在</span>
127.0.0.1:6379&gt; exists name
<span class="o">(</span>integer<span class="o">)</span> 1

<span class="c">#3 当前key移到其他库</span>
127.0.0.1:6379&gt; move name 1
<span class="c">#4 epxire 以秒为单位给这个key设置过期时间，秒杀场景：60秒可能存在大量的请求，缓存</span>
127.0.0.1:6379&gt; <span class="nb">set </span>name jude
127.0.0.1:6379&gt; expire name 10 
<span class="c">#5 time to live 以秒为单位返回剩余生存时间</span>
127.0.0.1:6379&gt; ttl name 
<span class="o">(</span>integer<span class="o">)</span> 9
<span class="c">#6 查看当前key的类型</span>
127.0.0.1:6379&gt; <span class="nb">type </span>name
String
<span class="c"># 删除当前数据库的数据,原子性命令，一旦执行就无法回头</span>
127.0.0.1:6379&gt; flushdb
<span class="c"># 危险命令，删除所有数据库的数据，可以在配置文件中把命令改名字</span>
127.0.0.1:6379&gt; flushall
<span class="c"># 重要命令，获取配置信息</span>
127.0.0.1:6379&gt; config
</code></pre></div></div>

<p>通过中文官方文档学习客户端指令 <a href="https://www.redis.net.cn/">https://www.redis.net.cn/</a></p>

<h3 id="redis-dump命令">Redis dump命令</h3>

<p>Redis DUMP 命令用于序列化给定 key ，并返回被序列化的值（字节数组）。</p>

<ul>
  <li>客户端（业务应用）将key和java对象序列化成字节数组进行网络传输</li>
  <li>redis服务端接受到写网络请求，将key反序列化在全局hash桶通过hash算法找出存储的位置，保存序列化后的java对象</li>
  <li>redis服务端接受到读网络请求，将key反序列化在全局hash桶（数组）通过hash算法找出存储的位置，如果发生hash冲突，则比较同一个hash值的桶元素（链表）的每个key值，查找出key对应的value，这时value是一个序列化后的java对象，对应redis支持的8种数据结构（规则），然后将java对象的字节数组按存储指定的数据结构规则进行反序列化，得到原对象。redis内部将这个反序列化得到的原对象结果返回，我们通过redis-cli -p 6379进入客户端执行命令得到的结果就是经过反序列化得到的。但是需要经过网络传输给到客户端（业务应用），则又要将反序列化得到的java对象进行序列化转为字节数组。</li>
  <li>客户端（业务应用）得到redis响应网络请求，将字节数组按指定的数据结构（规则）进行反序列化的得到java对象。</li>
</ul>

<p>dump命令的出现，就是避免了redis服务端的反序列化操作，从而降低redis服务器的cpu资源占用，直接将内存中存储的value值（序列化对象）通过网络传输返回，也减少了整个网络请求的等待时间</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>redis 127.0.0.1:6379&gt; DUMP KEY_NAME
<span class="c"># 如果 key 不存在，那么返回 nil 。 否则，返回序列化之后的值。 </span>
redis&gt; SET greeting <span class="s2">"hello, dumping world!"</span>
OK
<span class="c"># 返回序列化后的值</span>
redis&gt; DUMP greeting
<span class="s2">"</span><span class="se">\x</span><span class="s2">00</span><span class="se">\x</span><span class="s2">15hello, dumping world!</span><span class="se">\x</span><span class="s2">06</span><span class="se">\x</span><span class="s2">00E</span><span class="se">\x</span><span class="s2">a0Z</span><span class="se">\x</span><span class="s2">82</span><span class="se">\x</span><span class="s2">d8r</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">de"</span>
redis&gt; DUMP not-exists-key
<span class="o">(</span>nil<span class="o">)</span>
</code></pre></div></div>

<h3 id="string字符串">String(字符串)</h3>

<p>这是Redis中最基本的级别，一个key对应一个value，字符串value最大不要超过512M</p>

<p><mark>单值单value</mark></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#=====================</span>
<span class="c"># set get del keys exists append strlen</span>
<span class="c">#=====================</span>
<span class="c"># 1、是否存在key</span>
127.0.0.1:6379&gt; exists key1
<span class="o">(</span>integer<span class="o">)</span> 0
<span class="c"># 2、对key内容追加，如果没有值等同于set key</span>
127.0.0.1:6379&gt; append key1 <span class="s2">"hello"</span>
127.0.0.1:6379&gt; append key1 <span class="s2">" world"</span>
127.0.0.1:6379&gt; get key1
hello wolrd
<span class="c"># 3、获取字符长度</span>
127.0.0.1:6379&gt; strlen key1
<span class="o">(</span>integer<span class="o">)</span> 11
<span class="c"># 4、删除某key</span>
127.0.0.1:6379&gt; del key1

<span class="c">#=====================</span>
<span class="c"># incr decr incrby decrby</span>
<span class="c">#=====================</span>
127.0.0.1:6379&gt; <span class="nb">set </span>views 0
<span class="c"># 5、每个人浏览就 +1</span>
127.0.0.1:6379&gt; incr views
127.0.0.1:6379&gt; get views
1
127.0.0.1:6379&gt; incr views
127.0.0.1:6379&gt; get views
2
<span class="c"># 6、浏览量 -1</span>
127.0.0.1:6379&gt; decr views
127.0.0.1:6379&gt; get views
1
<span class="c"># 7、设置增量</span>
127.0.0.1:6379&gt; incrby views 10
127.0.0.1:6379&gt; get views
11
<span class="c"># 8、设置减量</span>
127.0.0.1:6379&gt; decrby views 5
<span class="o">(</span>integer<span class="o">)</span> 6

<span class="c">#=====================</span>
<span class="c"># range [范围]</span>
<span class="c"># getrange setrange</span>
<span class="c">#=====================</span>
127.0.0.1:6379&gt; <span class="nb">set </span>key1 abcdefg123456
<span class="c"># 9、范围获取全部字符串</span>
127.0.0.1:6379&gt; getrange key1 0 <span class="nt">-1</span>
<span class="s2">"abcdefg123456"</span>
<span class="c"># 获取[0,1,2]</span>
127.0.0.1:6379&gt; getrange key1 0 2
<span class="s2">"abc"</span>
<span class="c"># 10、替换指定字符串</span>
127.0.0.1:6379&gt; setrange key1 1 xx
127.0.0.1:6379&gt; get key1
<span class="s2">"axxdefg123456"</span>

<span class="c">#=====================</span>
<span class="c"># setex(expire) setnx(not exist)</span>
<span class="c">#=====================</span>
<span class="c"># 11、设置60秒过期</span>
127.0.0.1:6379&gt; setex key3 60 expire
127.0.0.1:6379&gt; ttl key3
（integer）56
<span class="c"># 12、如果不存在就设置值，成功返回1，失败返回0</span>
<span class="c"># 可以理解为信号量，原来我们是版本号</span>
127.0.0.1:6379&gt; setnx key4 <span class="s2">"redis"</span>
<span class="o">(</span>integer<span class="o">)</span> 1
127.0.0.1:6379&gt; setnx key4 <span class="s2">"mongodb"</span>
<span class="o">(</span>integer<span class="o">)</span> 0

<span class="c">#=====================</span>
<span class="c"># 批量机制</span>
<span class="c"># mset mget msetnx</span>
<span class="c">#=====================</span>
<span class="c"># 13、批量设置键值对，</span>
127.0.0.1:6379&gt; mset k10 v10 k11 v11 k12 v12
<span class="c"># 14、批量获取键值对</span>
127.0.0.1:6379&gt; mget k10 k11 k12
<span class="s2">"v10"</span>
<span class="s2">"v11"</span>
<span class="s2">"v12"</span>
<span class="c"># 15、如果不存在就设置值批量操作，msetnx是一个原子性的操作，要么同时成功，要同时失败</span>
127.0.0.1:6379&gt; msetnx k10 10 k13 v13
<span class="o">(</span>integer<span class="o">)</span> 0 <span class="c"># 设置失败</span>

<span class="c"># 例子 缓存对象，获取对象，省去解析的过程，其实使用hash的方式更方便</span>
127.0.0.1:6379&gt; mset user:1:name zhangsan user:1:age 2
127.0.0.1:6379&gt; mget user:1:name user:1:age
<span class="s2">"zhangesan"</span>
2

<span class="c">#=====================</span>
<span class="c"># 16、getset 先get返回值，然后再set值</span>
<span class="c">#=====================</span>
127.0.0.1:6379&gt; getset db mongodb
<span class="o">(</span>nil<span class="o">)</span>
127.0.0.1:6379&gt; getset db redis
<span class="s2">"mongodb"</span>
127.0.0.1:6379&gt; get db
<span class="s2">"redis"</span>

</code></pre></div></div>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-edu/2020/05/13/icoding-note-034.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
