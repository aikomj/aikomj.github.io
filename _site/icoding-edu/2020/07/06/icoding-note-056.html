<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 飞天班第56节：分布式事务 - 大伟的博客 </title>
    <meta name="keywords" content="mysql,springcloud,mq">
    <meta name="description"
          content="CAP原理的解析，ACID原理与BASE原理，XA实现两阶段协议的分布式事务，使用atomikos解决分布式事务的缺点，RocketMQ的事务消息方案，TCC事务补偿机制对业务的侵入强，Seata 2阶段解决分布式事务，MQ消息中间件最终一致性解决分布式事务">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-edu/2020/07/06/icoding-note-056.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="飞天班第56节：分布式事务">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>飞天班第56节：分布式事务</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/07/06
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="前言分布式事务">前言：分布式事务</h2>

<p>在传统的数据库操作中，数据库本身就提供了ACID的相关特性操作，但是由于业务数据增大数据压力导致我们不得不将数据分到多个表中，如果还在一个库里还可以使用ACID原则，只要两个分在不同的数据库上ACID原则就不能实现，数据就会出现不一致。业务的服务化，我们在操作一个业务逻辑过程中，涉及两个或多个数据源，当A数据源出现异常，那么B数据源的操作回滚。</p>

<p><strong>要掌握分布式事务需要了解以下的概念</strong></p>

<ul>
  <li>CAP原理</li>
  <li>ACID原理与BASE原理</li>
  <li>基于XA协议的两阶段提交：在实际应用中因为提交过程比较复杂，如果提交中间出现失败就会导致数据库刮起状态</li>
  <li>事务补偿机制（TCC），符号<mark>ACID原理</mark>
    <ul>
      <li>理解起来非常简单，实现比较复杂</li>
      <li>操作多个数据库时，一个成功了一个失败了，成功的数据库要有一个补偿接口进行失败的回滚，让数据恢复到最初操作</li>
    </ul>
  </li>
  <li>基于本地消息的最终一致性（对外对接应用，直接使用http访问和数据库结合进行消息补偿），<mark>符号BASE原理</mark></li>
  <li>基于MQ消息队列的最终一致性（最后用上人工补偿），<mark>符号BASE原理</mark></li>
</ul>

<blockquote>
  <p>eg：recive money 收钱（支付模块）-&gt; insert order 下订单(订单模块) ，add point 加积分（用户积分模块） ，减库存（仓储模块）</p>

  <p>不能使用强一致性，只能基于MQ实现最终一致性，使用多线程不安全（如果线程任务失败无法重来），使用消息队列，消息消费失败进入死信对列，需要人工干预补偿</p>
</blockquote>

<p>Java领域针对分布式事务的解决方案就是JTA(Java Transaction API)，SpringBoot官方提供的Atomikos 和 Bitronix的两种解决思路。</p>

<p>业务的服务化，就是微服务，把原来单机支撑的应用服务，拆解为一块一块独立的服务。例如用户中心、订单中心、账户中心、库存中心。对于订单中心，有专门的数据库存储订单信息，用户中心也有专门的数据库存储用户信息，库存中心也会有专门的数据库存储库存信息。这就是数据切分方案上所讲的垂直切分，数据应用服务化。但往往就会产生分布式事务问题，如要同时对订单进行操作，那么就会涉及到订单数据库和账户数据库，为了保证数据一致性，就需要用到分布式事务。</p>

<p><img src="\assets\images\2020\icoding\mysql\distribute-transaction.png" alt="" /></p>

<h2 id="1-cap原理的解析">1. CAP原理的解析</h2>

<ul>
  <li>C-Consistent，一致性，具体是指操作成功后，所有的节点在同一时间看到数据完全一致，所以一致性就是指数据一致性（典型是Zookeeper,它会让等待所有节点的数据一致时，才让你查询到，例如A节点往B节点同步数据，一个请求路由到B节点查询新增的数据，是查询不到它会让你等待直到B同步完数据 ）</li>
  <li>A-Availability，可用性，指服务一致可用，在规定时间内完成响应（典型是Eureka）</li>
  <li>P-Partition tolerance，分区容错性，指分布式系统在遇到某个节点或网络分区故障的时候，依旧可以对外提供服务</li>
</ul>

<p>CAP原则只能满足其中两项：CP、AP</p>

<p>我们在使用分布式系统的时候就是为了满足某个节点不可用的情况下，系统还能对外服务，这正是P的体现，<font color="red">如果服务不满足P的话就不是一个分布式系统，在分布式系统中P总是成立的</font></p>

<p>分布式系统，那么A和C能不能同时满足呢？不能</p>

<p>client轮询访问A和B，A —&gt; B同步的过程中</p>

<ul>
  <li>能同时访问A和B，那么就是保证可用性A，但这时A和B的数据是不一样的。</li>
  <li>如何要保证访问A和B都能得到一样的数据，那么就必须等待数据同步完成，等待的过程中，服务对外是不可用的，就是不能访问A也不能访问B，直到数据同步完成对外服务才可用，那么就是保证一致性C</li>
  <li>所以A和C是不能同时满足的</li>
</ul>

<h2 id="2-acid与base">2. ACID与BASE</h2>

<p>在关系型数据库中，最大的特点就是事务处理，也就是ACID</p>

<ul>
  <li>A 原子性，整个事务中的所有操作，要么全部完成，要么全部不做，没有中间状态。对于事务在执行中发生错误，所有的操作都会被回滚，整个事务就像从没被执行过一样；</li>
  <li>C 一致性，事务的执行必须保证系统的一致性，就拿转账为例，A有500元，B有300元，如果在一个事务里A成功给B转账50元，那么不管并发多少，不管发生什么，只要事务执行成功了，那么最后A账户一定是450元，B账户一定是350元；</li>
  <li>I 隔离性，事务与事务之间不会互相影响，一个事务的中间状态不会被其他事务感知；</li>
  <li>D 持久性，事务完成，那么事务对数据所做的变更就完全保存在数据库中，即使发生停电，系统宕机也是如此。</li>
</ul>

<p><mark>ACID强调的是强一致性，要么全做，要么全不做</mark>，传统的数据库都有ACID的特性，在CAP原理中，保证的是CA(可用和一致，就是说可用的时候一定是一种的数据 )，在分布式系统流行的今天，ACID在逐步向BASE转换</p>

<p><strong>BASE是 Basically Availiable（基本可用），Soft-state（软状态），Eventually consistent（最终一致性）</strong></p>

<ul>
  <li>Basically Availiable（基本可用）：分布式系统在出现故障的情况下，允许损失部分可用性，保障核心可用</li>
  <li><strong>Soft-state（软状态）：就是指系统允许出现中间状态</strong>，该中间状态不会影响系统的整体可用性，分布式存储中一般一份数据会有两到三个副本，允许不同副本间数据的同步延时就是软状态的体现。Mysql的主从复制也就是软状态的体现</li>
  <li>Eventually consistent（最终一致性）：所有的数据副本经过一段时间，最终能够达到一致性，弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况</li>
</ul>

<p>BASE模型是传统ACID模型的发面，不同与ACID，BASE强调牺牲高一致性，从而获得可用性，数据允许在一段时间内不一致，但最终保持一致就行。</p>

<h2 id="3-分布式事务的常见解决方案">3. 分布式事务的常见解决方案</h2>

<h3 id="本地消息表">本地消息表</h3>

<p>本地消息表这种实现方式应该是业界使用最多的，其核心思想是将分布式事务拆分成本地事务进行处理，思路如下：</p>

<p>1、消息生产方，需要额外建一个消息表，并记录消息发送状态。消息表和业务数据要在一个事务里提交，也就是说他们要在一个数据库里面。然后消息会经过MQ发送到消息的消费方。如果消息发送失败，会进行重试发送。
2、消息消费方，需要处理这个消息，并完成自己的业务逻辑。此时如果本地事务处理成功，表明已经处理成功了，如果处理失败，那么就会重试执行。如果是业务上面的失败，可以给生产方发送一个业务补偿消息，通知生产方进行回滚等操作。
3、生产方和消费方定时扫描本地消息表，把还没处理完成的消息或者失败的消息再发送一遍。如果有靠谱的自动对账补账逻辑，这种方案还是非常实用的。</p>

<p>直接用RocketMQ的事务消息方案得了，它会将本地事务与发送消息绑定为一个原子性操作。</p>

<h3 id="xa实现两阶段协议">XA实现两阶段协议</h3>

<p><strong>什么是2PC？</strong></p>

<p>2PC就是两阶段提交协议，将数据库的事务提交分为两个阶段</p>

<ul>
  <li>P准备阶段 prepare phase</li>
  <li>C提交阶段 commit phase</li>
</ul>

<p><strong>XA方案</strong></p>

<ul>
  <li>
    <p>XA是由X/Open组织提出的分布式事务规范</p>
  </li>
  <li>
    <p>整体是由一个事务管理器Transaction Manager（TM）和多个本地资源管理器Resource Manager（RM）组成</p>

    <p>在XA规范中，RM就是数据库，TM就是应用程序，TM生成全局的txId事务Id，调用XAResource接口，把多个本地事务协调为全局统一的分布式事务。Oracle、DB2这些商业数据库都实现了XA接口，mysql数据库也支持，但性能没有前者理想。</p>
  </li>
  <li>
    <p>提交分为两个阶段</p>
  </li>
</ul>

<p><strong>第一阶段</strong></p>

<p><img src="/assets/images/2020/icoding/mysql/xa-1.png" alt="" /></p>

<p>TM会询问所有的数据库，如果都是ready了才commit，如果其中一个不ready所有都回滚</p>

<p><strong>第二阶段</strong></p>

<p><img src="/assets/images/2020/icoding/mysql/xa-2.png" alt="" /></p>

<p>如果到了第二阶段，第一个commit了，第二个无法commit，这个时候第一个commit就不能回滚了，这个时候就需要人工干预了，进行补偿， 比如发MQ消息进行补偿，短信通知让人工操作。</p>

<p>可以发现在第一阶段与第二阶段都是同步按顺序执行的，效率低。</p>

<p><strong>XA两阶段提交方式的总结：</strong></p>

<ul>
  <li>
    <p>保证数据的强一致性</p>
  </li>
  <li>
    <p>大部分商业数据库都实现了XA接口，使用分布式事务的成本较低，但性能不理想，并发量高的场景，容易造成获取数据库资源阻塞，大量线程会阻塞在获取事务控制器TM。</p>
  </li>
  <li>
    <p><mark>XA方式效率比较低，性能与本地事务相差10倍</mark></p>

    <p>准备阶段TM给所有的数据库送指令并接受反馈(同步)，提交阶段也是，自然效率就低下了。在prepare阶段需要等待所有参与子事务的反馈，因此可能造成数据库资源锁定时间过长，不适合并发高以及子事务生命周长较长的业务场景。</p>
  </li>
  <li>commit阶段出现问题，事务出现不一致，需要人工干预回滚</li>
  <li>MySQL v5.7及以上版本均支持XA协议，但是支持的不太理想，mysql的XA实现，没有记录prepare阶段日志，主备切换会导致主库与备库数据不一致。在prepare阶段需要等待所有其他的本地事务反馈，因此可能造成数据库资源锁定时间过长，不适合并发高以及子事务生命周长较长的业务场景。两阶段提交这种解决方案属于牺牲了一部分可用性来换取的一致性。</li>
  <li>mysql-connector-java驱动v5.0以上版本支持XA协议</li>
  <li>Java系统中，数据源可以采用Atomikos充当TM的角色，把多个本地事务协调为全局统一的分布式事务。</li>
</ul>

<blockquote>
  <p>SpringBoot整合Atomikos</p>
</blockquote>

<p>引入atomikos 依赖包，但是它仅适合并发低的单体应用，因为两阶段协议对数据库连接的持锁时间过长，当应用访问连接数上升，就会导致较多线程阻塞在获取数据库连接上。对账模块rcc的java应用就是因为使用了atomikos数据源来解决分布式事务，访问并发上来后，经常出现查询数据库操作页面就报超时，因为连接池管理对象上存在激烈的锁竞争，后来的请求线程在获取数据库连接被阻塞了，都在等待前面的请求线程释放数据库连接。后来改为使用druid数据源，避免这个问题，分布式事务的问题就要使用其他方案，个人建议微服务应用使用阿里的Seata框架解决分布式事务。</p>

<p>Atomilos对池中connection的管理效率随着连接数的上升，呈现指数级的下降，测试环境中，连接最大配置为300，但实际上最大值没有超过70，线程dump发现连接池管理对象上存在激烈的锁竞争，导致很多线程等待前面的线程释放锁对象；</p>

<p>Atomikos从池里取得connection时，每次都会去进行select test，这个对获取连接的影响很大，取消这个测试，TPS 吞吐量大概能提高近1倍；</p>

<p>pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-jta-atomikos<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>配置类中添加Jta分布式事务管理器，注入spring ioc</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableTransactionManagement</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">(</span><span class="nc">EnvironmentConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MybatisPlusConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"rccShardingSqlSessionFactory"</span><span class="o">)</span>
    <span class="nd">@DependsOn</span><span class="o">({</span><span class="s">"transactionManager"</span><span class="o">})</span>
    <span class="nd">@Primary</span>
    <span class="kd">public</span> <span class="nc">SqlSessionFactory</span> <span class="nf">rccShardingSqlSessionFactory</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"rccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"globalConfiguration"</span><span class="o">)</span> <span class="nc">GlobalConfig</span> <span class="n">globalConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">mapperLocations</span> <span class="o">=</span> <span class="s">"classpath:mapping/rcc/**/*.xml"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">typeAliasesPackage</span> <span class="o">=</span> <span class="s">"com.midea.mcsp.settlement.rcc.entity.rcc"</span><span class="o">;</span>
        <span class="k">return</span> <span class="nf">buildSqlSessionFactory</span><span class="o">(</span><span class="n">dataSource</span><span class="o">,</span> <span class="n">typeAliasesPackage</span><span class="o">,</span> <span class="n">mapperLocations</span><span class="o">,</span> <span class="n">globalConfig</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"mccShardingSqlSessionFactory"</span><span class="o">)</span>
    <span class="nd">@DependsOn</span><span class="o">({</span><span class="s">"transactionManager"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">SqlSessionFactory</span> <span class="nf">mccShardingSqlSessionFactory</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"mccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"globalConfiguration"</span><span class="o">)</span> <span class="nc">GlobalConfig</span> <span class="n">globalConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">mapperLocations</span> <span class="o">=</span> <span class="s">"classpath:mapping/mcc/**/*.xml"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">typeAliasesPackage</span> <span class="o">=</span> <span class="s">"com.midea.mcsp.settlement.rcc.entity.mcc"</span><span class="o">;</span>
        <span class="k">return</span> <span class="nf">buildSqlSessionFactory</span><span class="o">(</span><span class="n">dataSource</span><span class="o">,</span> <span class="n">typeAliasesPackage</span><span class="o">,</span> <span class="n">mapperLocations</span><span class="o">,</span> <span class="n">globalConfig</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">...</span>
        <span class="c1">// Jta 分布式事务控制器</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"transactionManager"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">JtaTransactionManager</span> <span class="nf">transactionManager</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="nc">UserTransactionManager</span> <span class="n">userTransactionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserTransactionManager</span><span class="o">();</span>
        <span class="n">userTransactionManager</span><span class="o">.</span><span class="na">setForceShutdown</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">UserTransaction</span> <span class="n">userTransaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserTransactionImp</span><span class="o">();</span>
        <span class="n">userTransaction</span><span class="o">.</span><span class="na">setTransactionTimeout</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">JtaTransactionManager</span><span class="o">(</span><span class="n">userTransaction</span><span class="o">,</span> <span class="n">userTransactionManager</span><span class="o">);</span>
    <span class="o">}</span> 
<span class="o">}</span>
</code></pre></div></div>

<p>项目需要连接rcc、smc、mcc、ivc4个数据源，这4个数据源又使用了shardingsphere 分库分表（切分数据），所以有4个sharding的逻辑数据源</p>

<p>首先将数据源注入Spring容器中</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EnvironmentConfig</span> <span class="kd">implements</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">,</span> <span class="nc">EnvironmentAware</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Environment</span> <span class="n">environment</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">modules</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"rcc"</span><span class="o">);</span>
        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"ivc"</span><span class="o">);</span>
        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"mcc"</span><span class="o">);</span>
        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"smc"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnvironment</span><span class="o">(</span><span class="nc">Environment</span> <span class="n">env</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">environment</span> <span class="o">=</span> <span class="n">env</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">beanDefinitionRegistry</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
        <span class="n">registerBeanDefinition</span><span class="o">(</span> <span class="n">beanDefinitionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">configurableListableBeanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="o">(</span>  <span class="nc">BeanDefinitionRegistry</span> <span class="n">beanDefinitionRegistry</span><span class="o">){</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">String</span> <span class="n">module</span> <span class="o">:</span> <span class="n">modules</span><span class="o">){</span>
            <span class="nc">String</span> <span class="n">shardParam</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".shard-count"</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">shardCount</span> <span class="o">=</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">shardParam</span><span class="o">)</span> <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">shardParam</span><span class="o">)</span> <span class="o">:</span> <span class="mi">2</span><span class="o">;</span>
            <span class="nc">String</span> <span class="n">driverClass</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".driver-class-name"</span><span class="o">);</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">shardCount</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
                <span class="nc">String</span> <span class="n">read</span> <span class="o">=</span> <span class="s">".read"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"."</span><span class="o">;</span>
                <span class="nc">String</span> <span class="n">write</span> <span class="o">=</span> <span class="s">".write"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"."</span><span class="o">;</span>
                <span class="nc">String</span> <span class="n">readUrl</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">read</span> <span class="o">+</span> <span class="s">"url"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">readUser</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">read</span> <span class="o">+</span> <span class="s">"username"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">readPassWord</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">read</span> <span class="o">+</span> <span class="s">"password"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">writeUrl</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">write</span> <span class="o">+</span> <span class="s">"url"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">writeUser</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">write</span> <span class="o">+</span> <span class="s">"username"</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">writePassWord</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="n">write</span> <span class="o">+</span> <span class="s">"password"</span><span class="o">);</span>

                <span class="nc">RootBeanDefinition</span> <span class="n">readBeanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">configBeanDefinition</span><span class="o">(</span><span class="n">readBeanDefinition</span><span class="o">,</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-readDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">readUser</span><span class="o">,</span> <span class="n">readPassWord</span><span class="o">,</span> <span class="n">readUrl</span><span class="o">,</span><span class="n">driverClass</span><span class="o">);</span>

                <span class="nc">RootBeanDefinition</span> <span class="n">writeBeanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="n">configBeanDefinition</span><span class="o">(</span><span class="n">writeBeanDefinition</span><span class="o">,</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-writeDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">writeUser</span><span class="o">,</span> <span class="n">writePassWord</span><span class="o">,</span> <span class="n">writeUrl</span><span class="o">,</span><span class="n">driverClass</span><span class="o">);</span>

                <span class="n">beanDefinitionRegistry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-readDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">readBeanDefinition</span><span class="o">);</span>
                <span class="n">beanDefinitionRegistry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-writeDataSource"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">writeBeanDefinition</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// 模块的默认库写入bean定义信息注册器</span>
            <span class="nc">String</span> <span class="n">defaultDsUrl</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".default-ds.url"</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">defaultDsUser</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".default-ds.username"</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">defaultDsPassWord</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="nc">CommonConstants</span><span class="o">.</span><span class="na">PREFIX</span> <span class="o">+</span> <span class="n">module</span> <span class="o">+</span> <span class="s">".default-ds.password"</span><span class="o">);</span>
            <span class="nc">RootBeanDefinition</span> <span class="n">defaultDsBeanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">configBeanDefinition</span><span class="o">(</span><span class="n">defaultDsBeanDefinition</span><span class="o">,</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-defaultDataSource"</span><span class="o">,</span> <span class="n">defaultDsUser</span><span class="o">,</span> <span class="n">defaultDsPassWord</span><span class="o">,</span> <span class="n">defaultDsUrl</span><span class="o">,</span><span class="n">driverClass</span><span class="o">);</span>
            <span class="n">beanDefinitionRegistry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">module</span> <span class="o">+</span> <span class="s">"-defaultDataSource"</span><span class="o">,</span> <span class="n">defaultDsBeanDefinition</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span>  <span class="kt">void</span> <span class="nf">configBeanDefinition</span><span class="o">(</span><span class="nc">RootBeanDefinition</span> <span class="n">beanDefinition</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">user</span><span class="o">,</span> <span class="nc">String</span> <span class="n">passWord</span><span class="o">,</span> <span class="nc">String</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span> <span class="n">driverClass</span><span class="o">){</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="s">"EnvironmentConfig"</span><span class="o">);</span>
        <span class="nc">Properties</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">build</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">passWord</span><span class="o">,</span> <span class="n">driverClass</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"xaProperties"</span><span class="o">,</span> <span class="n">prop</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"minPoolSize"</span><span class="o">,</span><span class="mi">3</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"maxPoolSize"</span><span class="o">,</span><span class="mi">30</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"maxIdleTime"</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"testQuery"</span><span class="o">,</span><span class="s">"select 1"</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"xaDataSourceClassName"</span><span class="o">,</span> <span class="s">"com.alibaba.druid.pool.xa.DruidXADataSource"</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setRole</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="nc">AtomikosDataSourceBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Properties</span> <span class="nf">build</span><span class="o">(</span><span class="nc">String</span> <span class="n">url</span><span class="o">,</span><span class="nc">String</span> <span class="n">user</span><span class="o">,</span><span class="nc">String</span> <span class="n">passWord</span><span class="o">,</span> <span class="nc">String</span> <span class="n">driverClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Properties</span> <span class="n">prop</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="n">passWord</span><span class="o">);</span>
        <span class="n">prop</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"driverClassName"</span><span class="o">,</span> <span class="n">driverClass</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">prop</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>注意这里DataSource数据源要使用AtomikosDataSourceBean，即所谓的atomikos数据源，每一个数据库连接都是atomikos数据源，atomikos框架底层就是2pc 二阶段提交，大概流程是这样的：</p>

<ol>
  <li>将数据源交给atomikos，atomikos将其封装成atomikos数据源</li>
  <li>atomikos开启atomikos全局事务</li>
  <li>拿atomikos数据源做sql操作</li>
  <li>第一个atomikos事务做完操作后告诉TM完成了，准备commit或rollback，这时atomikos事务是一直占用着数据库资源的直到第二阶段正常commit或rollback，然后轮到下一个atomikos数据源的事务执行操作，TM等待所有的atomikos数据源执行完事务操作后，都没有问题了，就通知每个atomikos数据源commit，注意整个过程是同步的。如果第一阶段就发生了rollback，TM就会通知前面已经执行完sql操作的RM进行rollback。</li>
</ol>

<p>这个atomikos数据源要结合JtaTransactionManager分布式事务控制器使用</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="s">"transactionManager"</span><span class="o">)</span>
</code></pre></div></div>

<blockquote>
  <p>去掉Atomikos，两阶段控制分布式事务</p>
</blockquote>

<p>后来并发多一点，导致大量请求阻塞在数据库资源获取上，前端经常出现请求超时，把atomikos数据源去掉，改为本地事务控制</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EnvironmentConfig</span> <span class="kd">implements</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">,</span> <span class="nc">EnvironmentAware</span> <span class="o">{</span>
  <span class="o">.....</span>
      <span class="kd">private</span>  <span class="kt">void</span> <span class="nf">configBeanDefinition</span><span class="o">(</span><span class="nc">RootBeanDefinition</span> <span class="n">beanDefinition</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">user</span><span class="o">,</span> <span class="nc">String</span> <span class="n">passWord</span><span class="o">,</span> <span class="nc">String</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span> <span class="n">driverClass</span><span class="o">){</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="s">"EnvironmentConfig"</span><span class="o">);</span>
        <span class="c1">// minEvictableIdleTimeMillis 会话连接保持空闲而不被关闭的最小时间，默认30分钟</span>
        <span class="c1">// maxEvictableIdleTimeMillis 会话连接保持空闲而不被关闭的最大时间，默认7小时</span>
        <span class="nc">MutablePropertyValues</span> <span class="n">propertyValues</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MutablePropertyValues</span><span class="o">();</span>
        <span class="n">propertyValues</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="n">url</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">user</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="n">passWord</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">name</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"driverClassName"</span><span class="o">,</span> <span class="n">driverClass</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"initialSize"</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"minIdle"</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"maxActive"</span><span class="o">,</span><span class="mi">20</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"minEvictableIdleTimeMillis"</span><span class="o">,</span><span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">5</span><span class="o">)</span>    <span class="c1">// 空闲连接最小5分钟后才关闭</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"maxEvictableIdleTimeMillis"</span><span class="o">,</span><span class="mi">1000L</span><span class="o">*</span><span class="mi">60L</span><span class="o">*</span><span class="mi">60L</span><span class="o">)</span> <span class="c1">// 空闲连接最大60分钟后才关闭</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"validationQuery"</span><span class="o">,</span><span class="s">"select 1"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"removeAbandoned"</span><span class="o">,</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"removeAbandonedTimeout"</span><span class="o">,</span><span class="mi">3600</span><span class="o">)</span>     <span class="c1">// 60*60秒，从连接池获取的连接如果超过这个时间不归还到连接池，</span>
                <span class="c1">// 就可能被垃圾回收器回收，避免连接泄漏，如果业务超过这个时间还没有处理完，可以适当延长这个时间</span>
            <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"logAbandoned"</span><span class="o">,</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">;</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setPropertyValues</span><span class="o">(</span><span class="n">propertyValues</span><span class="o">);</span>
        <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="nc">DruidDataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用<code class="highlighter-rouge">DruidDataSource</code>替换<code class="highlighter-rouge">AtomikosDataSourceBean</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableTransactionManagement</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">(</span><span class="nc">EnvironmentConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MybatisPlusConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"rccShardingSqlSessionFactory"</span><span class="o">)</span>
    <span class="nd">@Primary</span>
    <span class="kd">public</span> <span class="nc">SqlSessionFactory</span> <span class="nf">rccShardingSqlSessionFactory</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"rccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"globalConfiguration"</span><span class="o">)</span> <span class="nc">GlobalConfig</span> <span class="n">globalConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">mapperLocations</span> <span class="o">=</span> <span class="s">"classpath:mapping/rcc/**/*.xml"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">typeAliasesPackage</span> <span class="o">=</span> <span class="s">"com.midea.mcsp.settlement.rcc.entity.rcc"</span><span class="o">;</span>
        <span class="k">return</span> <span class="nf">buildSqlSessionFactory</span><span class="o">(</span><span class="n">dataSource</span><span class="o">,</span> <span class="n">typeAliasesPackage</span><span class="o">,</span> <span class="n">mapperLocations</span><span class="o">,</span> <span class="n">globalConfig</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"smcShardingSqlSessionFactory"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">SqlSessionFactory</span> <span class="nf">smcShardingSqlSessionFactory</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"smcShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"globalConfiguration"</span><span class="o">)</span> <span class="nc">GlobalConfig</span> <span class="n">globalConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">mapperLocations</span> <span class="o">=</span> <span class="s">"classpath:mapping/smc/**/*.xml"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">typeAliasesPackage</span> <span class="o">=</span> <span class="s">"com.midea.mcsp.settlement.rcc.entity.smc"</span><span class="o">;</span>
        <span class="k">return</span> <span class="nf">buildSqlSessionFactory</span><span class="o">(</span><span class="n">dataSource</span><span class="o">,</span> <span class="n">typeAliasesPackage</span><span class="o">,</span> <span class="n">mapperLocations</span><span class="o">,</span> <span class="n">globalConfig</span><span class="o">);</span>
    <span class="o">}</span>
  
  <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"transactionManager"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="nc">UserTransactionManager</span> <span class="n">userTransactionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserTransactionManager</span><span class="o">();</span>
        <span class="n">userTransactionManager</span><span class="o">.</span><span class="na">setForceShutdown</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">UserTransaction</span> <span class="n">userTransaction</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserTransactionImp</span><span class="o">();</span>
        <span class="n">userTransaction</span><span class="o">.</span><span class="na">setTransactionTimeout</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">JtaTransactionManager</span><span class="o">(</span><span class="n">userTransaction</span><span class="o">,</span> <span class="n">userTransactionManager</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="nd">@Primary</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">rccManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"rccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">smcManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"smcShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">ivcManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"ivcShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">mccManager</span><span class="o">(</span><span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"mccShardingDataSource"</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4个数据源都实例化一个事务控制器<code class="highlighter-rouge">DataSourceTransactionManager</code>，默认的本地事务控制器是rccManager</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 多数据源的情况下，必须要指定事务控制器</span>
<span class="nd">@Override</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">transactionManager</span> <span class="o">=</span> <span class="s">"rccManager"</span><span class="o">,</span> <span class="n">rollbackFor</span> <span class="o">=</span> <span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addWrtOffCstmRule</span><span class="o">(</span><span class="nc">CommonRequest</span><span class="o">&lt;</span><span class="nc">AddWrtOffCstmRuleHeadReqDTO</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="事务消息最终一致性">事务消息最终一致性</h3>

<p>事务消息作为一种异步确保型事务， 将两个事务分支通过MQ进行异步解耦，事务消息的设计流程同样借鉴了两阶段提交理论。</p>

<p>第三方的MQ是支持事务消息的，比如RocketMQ，但是市面上一些主流的MQ都是不支持事务消息的，比如 RabbitMQ 和 Kafka 都不支持。流程如下：</p>

<ul>
  <li>事务发起方首先发送prepare消息到MQ。</li>
  <li>在发送prepare消息成功后执行本地事务。</li>
  <li>根据本地事务执行结果返回commit或者是rollback。</li>
  <li>如果消息是rollback，MQ将删除该prepare消息不进行下发，如果是commit消息，MQ将会把这个消息发送给consumer端。</li>
  <li>如果执行本地事务过程中，执行端挂掉，或者超时，MQ将会不停的询问其同组的其它producer来获取状态。</li>
  <li>Consumer端的消费成功机制有MQ保证。</li>
</ul>

<p>两阶段提交基于MQ的解耦，那么就可以应用在高并发场景，将一个分布式事务拆成一个消息事务（A系统的本地操作+发消息）+B系统的本地操作，其中B系统的操作由消息驱动，只要消息事务成功，那么A操作一定成功，消息也一定发出来了，这时候B会收到消息去执行本地操作，如果本地操作失败，消息要重投(MQ的ACK确认需要设置为手动确认)，直到B操作成功，这样就变相地实现了A与B的分布式事务</p>

<p><img src="\assets\images\2021\mq\rockermq-transaction-message.jpg" alt="" /></p>

<h3 id="tcc-事务补偿机制">TCC 事务补偿机制</h3>

<p>Try Confirm Cancel(TCC)是ACID的，保证强一致性 ，操作多个数据库时，一个成功了一个失败了，成功的数据库要有一个补偿接口进行失败的回滚，让数据恢复到最初操作。</p>

<p>其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。TCC模型是把锁的粒度完全交给业务处理。<mark>它分为三个阶段：</mark></p>

<ul>
  <li>Try 阶段主要是对业务系统做检测及资源预留</li>
  <li>Confirm 阶段主要是对业务系统做确认提交，Try阶段执行成功并开始执行 Confirm阶段时，默认 Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。</li>
  <li>Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。</li>
</ul>

<p><img src="\assets\images\2020\icoding\mysql\tcc.png" alt="" /></p>

<p><strong>特点：</strong></p>

<p><mark>TCC模型对业务的侵入强，改造的难度大。</mark></p>

<ul>
  <li>TCC中的每个服务都需要开发对应的Try 、confirm、cancel API接口</li>
  <li>TCC整体性能高，锁加在了服务内部，并不是一个全局锁，锁的粒度小，有锁马上就释放了，提高了吞吐，不像2PC那样，并发上来，吞吐很低</li>
  <li>通常情况下，采用TCC则认为Confirm阶段是不会出错的。即 ：只要Try成功，Confirm一定成功。若Confirm阶段真的出错了，需引入重试机制或人工处理。</li>
  <li>通常情况下，采用TCC则认为Cancel阶段也是一定成功的。若Cancel阶段真的出错了，需引入重试机制或人工处理。</li>
  <li>由于Confirm和Cancel失败需进行重试，因此需要实现为幂等性是指同一个操作无论请求多少次，其结果都相同。</li>
</ul>

<p><strong>TCC框架 ： ByteTCC</strong></p>

<h3 id="seata框架解决分布式事务">Seata框架解决分布式事务</h3>

<p>现在最新版本是1.4.2</p>

<p><a href="/blog/icoding-edu/2020/07/08/icoding-note-057.html">Seata的AT模式</a></p>

<h3 id="消息队列与可靠消息服务方案">消息队列与可靠消息服务方案</h3>

<p><img src="\assets\images\2020\springcloud\mq-distribute-transaction.png" alt="" /></p>

<p>参考:</p>

<ul>
  <li>
    <p><a href="https://blog.csdn.net/qq_36743888/article/details/112297704">https://blog.csdn.net/qq_36743888/article/details/112297704</a></p>
  </li>
  <li>
    <p><a href="https://www.jianshu.com/p/c803fa4827b7">https://www.jianshu.com/p/c803fa4827b7</a></p>
  </li>
  <li>
    <p><a href="https://blog.csdn.net/qq_36743888/article/details/112297704">https://blog.csdn.net/qq_36743888/article/details/112297704</a></p>
  </li>
</ul>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-edu/2020/07/06/icoding-note-056.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
