<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 飞天班第13节：SpringSecurity权限控制 - 大伟的博客 </title>
    <meta name="keywords" content="springboot,springcloud">
    <meta name="description"
          content="使用SpringSecutiy用户认证和授权，结合前端实现不同权限不同视图">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-edu/2020/03/25/icoding-note-013.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="飞天班第13节：SpringSecurity权限控制">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>飞天班第13节：SpringSecurity权限控制</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/03/25
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1springsecurity简介">1、SpringSecurity简介</h2>

<h3 id="前言">前言</h3>

<p>Web开发中，安全一直是十分重要的一个环节，也属于非功能性需求，市面上比较知名的安全框架：</p>

<ul>
  <li>
    <p>Shiro，用的多，功能强大</p>
  </li>
  <li>
    <p>SpringSecurity，与Spring无缝结合，十分的方便，基本功能全都有，支持分布式。</p>

    <p>用户认证（账号密码）与 授权验证（url请求接口权限）的 安全框架，基于RBAC(角色的权限控制)对用户的访问权限进行控制，核心思想是通过一系列的filter chain 来进行拦截过滤的。使用起来就是继承WebSecurityConfigurerAdapter进行权限配置</p>
  </li>
</ul>

<p>今天我们就来学习SpringSecurity，学习思路：看官网简介，快速阅读官方文档</p>

<p>官方地址：<a href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></p>

<p><img src="/assets/images/2020/icoding/springsecurity/overview.gif" alt="" /></p>

<p>分不清authentication 和authentization?</p>

<p>举个例子说明一下：</p>

<p>你要登机，你需要出示你的身份证和机票，身份证是为了证明你张三确实是你张三，这就是authentication（认证）；而机票是为了证明你张三确实买了票可以上飞机，这就是authorization（授权）。</p>

<p>在从系统网站方面举个场景：</p>

<ul>
  <li>
    <p><mark>authentication（认证）</mark></p>

    <p>你要登陆论坛，输入用户名张三，密码1234，密码正确，证明你张三确实是张三 ；</p>
  </li>
  <li>
    <p><mark>authorization（授权）</mark></p>

    <p>再check用户张三是个版主，所以有权限加删别人的帖</p>
  </li>
</ul>

<h3 id="快速阅读官方文档">快速阅读官方文档</h3>

<p><img src="/assets/images/2020/icoding/springsecurity/release-5.3.gif" alt="" /></p>

<blockquote>
  <p>1、点击Reference Doc 找到Getting Spring Security，发现依赖&lt;</p>
</blockquote>

<p><img src="/assets/images/2020/icoding/springsecurity/dependency.gif" alt="" /></p>

<blockquote>
  <p>2、点击Project Modules</p>
</blockquote>

<p><img src="/assets/images/2020/icoding/springsecurity/module.gif" alt="" /></p>

<blockquote>
  <p>3、点击Servlet Applications，找到Spring Boot Auto Configuration</p>
</blockquote>

<p>Spring Boot automatically:</p>

<ul>
  <li>
    <p>Enables Spring Security’s default configuration, which creates a servlet <code class="highlighter-rouge">Filter</code> as a bean named <code class="highlighter-rouge">springSecurityFilterChain</code>. This bean is responsible for all the security (protecting the  application URLs, validating submitted username and passwords,  redirecting to the log in form, and so on) within your application.</p>

    <font color="red">springboot 自动开启SpringSecurity的默认配置，创建一个叫s pringSecurityFilterChain的过滤器，负责你的应用的安全，包括保护应用url，验证用户名和密码，重定向到登录表单页面等</font>
  </li>
  <li>
    <p>Creates a <code class="highlighter-rouge">UserDetailsService</code> bean with a username of <code class="highlighter-rouge">user</code> and a randomly generated password that is logged to the console.</p>

    <font color="red">创建一个叫user的用户名，一个随机生成的密码在登录后在控制台输出</font>
  </li>
  <li>
    <p>Registers the <code class="highlighter-rouge">Filter</code> with a bean named <code class="highlighter-rouge">springSecurityFilterChain</code> with the Servlet container for every request.</p>

    <font color="red">springSecurityFilterChain会过滤每一个请求</font>
  </li>
</ul>

<p>Spring Boot is not configuring much, but it does a lot. A summary of the features follows:</p>

<ul>
  <li>
    <p>Require an authenticated user for any interaction with the application</p>
  </li>
  <li>
    <p>Generate a default login form for you</p>

    <font color="red">生成一个默认的登录表单页面给你</font>
  </li>
  <li>
    <p>Let the user with a username of <code class="highlighter-rouge">user</code> and a password that is logged to the console to authenticate with form-based authentication (in the preceding example, the password is <code class="highlighter-rouge">8e557245-73e2-4286-969a-ff57fe326336</code>)</p>
  </li>
  <li>
    <p>Protects the password storage with BCrypt</p>

    <font color="red">使用BCrypt算法加密密码存储</font>
    <p>,它可以降低破解密码的暴力攻击,<a href="https://www.jianshu.com/p/bc563fcb5fee">快速了解BCrypt</a></p>
  </li>
</ul>

<p><strong>小结</strong></p>

<p>SpringSecurity 是通过Filter 来过认证和授权的，</p>

<p><img src="/assets/images/2020/icoding/springsecurity/a review of filters.gif" alt="" /></p>

<p>Filter会先判断请求的用户是否是应用的用户（认证），再判断是否有权限访问请求的URL(授权)，最后再通过DispatcherServlet分发器访问具体的Controller，获取数据。</p>

<p>我们需要了解SpringSecurity 内置的各种Filter</p>

<table>
  <thead>
    <tr>
      <th>Alias</th>
      <th>Filter Class</th>
      <th>Namespace Element or Attribute</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CHANNEL_FILTER</td>
      <td>ChannelProcessingFilter</td>
      <td>http/intercept-url@requires-channel</td>
    </tr>
    <tr>
      <td>SECURITY_CONTEXT_FILTER</td>
      <td>SecurityContextPersistenceFilter</td>
      <td>http</td>
    </tr>
    <tr>
      <td>CONCURRENT_SESSION_FILTER</td>
      <td>ConcurrentSessionFilter</td>
      <td>session-management/concurrency-control</td>
    </tr>
    <tr>
      <td>HEADERS_FILTER</td>
      <td>HeaderWriterFilter</td>
      <td>http/headers</td>
    </tr>
    <tr>
      <td>CSRF_FILTER</td>
      <td>CsrfFilter</td>
      <td>http/csrf</td>
    </tr>
    <tr>
      <td>LOGOUT_FILTER</td>
      <td>LogoutFilter</td>
      <td>http/logout</td>
    </tr>
    <tr>
      <td>X509_FILTER</td>
      <td>X509AuthenticationFilter</td>
      <td>http/x509</td>
    </tr>
    <tr>
      <td>PRE_AUTH_FILTER</td>
      <td>AbstractPreAuthenticatedProcessingFilter Subclasses</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td>CAS_FILTER</td>
      <td>CasAuthenticationFilter</td>
      <td>N/A</td>
    </tr>
    <tr>
      <td>FORM_LOGIN_FILTER</td>
      <td>UsernamePasswordAuthenticationFilter</td>
      <td>http/form-login</td>
    </tr>
    <tr>
      <td>BASIC_AUTH_FILTER</td>
      <td>BasicAuthenticationFilter</td>
      <td>http/http-basic</td>
    </tr>
    <tr>
      <td>SERVLET_API_SUPPORT_FILTER</td>
      <td>SecurityContextHolderAwareRequestFilter</td>
      <td>http/@servlet-api-provision</td>
    </tr>
    <tr>
      <td>JAAS_API_SUPPORT_FILTER</td>
      <td>JaasApiIntegrationFilter</td>
      <td>http/@jaas-api-provision</td>
    </tr>
    <tr>
      <td>REMEMBER_ME_FILTER</td>
      <td>RememberMeAuthenticationFilter</td>
      <td>http/remember-me</td>
    </tr>
    <tr>
      <td>ANONYMOUS_FILTER</td>
      <td>AnonymousAuthenticationFilter</td>
      <td>http/anonymous</td>
    </tr>
    <tr>
      <td>SESSION_MANAGEMENT_FILTER</td>
      <td>SessionManagementFilter</td>
      <td>session-management</td>
    </tr>
    <tr>
      <td>EXCEPTION_TRANSLATION_FILTER</td>
      <td>ExceptionTranslationFilter</td>
      <td>http</td>
    </tr>
    <tr>
      <td>FILTER_SECURITY_INTERCEPTOR</td>
      <td>FilterSecurityInterceptor</td>
      <td>http</td>
    </tr>
    <tr>
      <td>SWITCH_USER_FILTER</td>
      <td>SwitchUserFilter</td>
      <td>N/A</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>4、找到Handling Security Exceptions</p>
</blockquote>

<p>9.6. Handling Security Exceptions</p>

<p>The <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/web/access/ExceptionTranslationFilter.html"><code class="highlighter-rouge">ExceptionTranslationFilter</code></a> allows translation of <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/access/AccessDeniedException.html"><code class="highlighter-rouge">AccessDeniedException</code></a> and <a href="https://docs.spring.io/spring-security/site/docs/current/api//org/springframework/security/core/AuthenticationException.html"><code class="highlighter-rouge">AuthenticationException</code></a> into HTTP responses.</p>

<p><code class="highlighter-rouge">ExceptionTranslationFilter</code> is inserted into the <a href="https://docs.spring.io/spring-security/site/docs/5.3.1.RELEASE/reference/html5/#servlet-filterchainproxy">FilterChainProxy</a> as one of the <a href="https://docs.spring.io/spring-security/site/docs/5.3.1.RELEASE/reference/html5/#servlet-security-filters">Security Filters</a>.</p>

<p><img src="/assets/images/2020/icoding/springsecurity/translation filter.gif" alt="" /></p>

<p>1.ExceptionTranslationFilter 通知 FilterChain.doFilter 过滤</p>

<p>2.如果用户还没认证，那就走认证流程</p>

<p>3.如果是拒绝访问，那就抛异常给AccessDeniedHandler</p>

<blockquote>
  <p>5、springsecurity 我们重点关注</p>
</blockquote>

<p><img src="/assets/images/2020/icoding/springsecurity/usemore.gif" alt="" /></p>

<blockquote>
  <p>6、找到16. Java Configuration配置授权规则</p>
</blockquote>

<p>找到 HttpSecurity ，</p>

<p>Thus far our <a href="https://docs.spring.io/spring-security/site/docs/5.3.1.RELEASE/reference/html5/#jc-hello-wsca">WebSecurityConfig</a> only contains information about how to authenticate our users. How does Spring Security know that we want to require all users to be authenticated? How does Spring Security know we want to support form based authentication?</p>

<p>Actually, there is a configuration class that is being invoked behind the scenes called <code class="highlighter-rouge">WebSecurityConfigurerAdapter</code>. It has a method called <code class="highlighter-rouge">configure</code> with the following default implementation:</p>

<font color="red">spring security 是通过 WebSecurityConfigurerAdapter 配置类里的configure方法 配置授权规则 </font>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span>
        <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">(</span><span class="n">authorize</span> <span class="o">-&gt;</span> <span class="n">authorize</span>
            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">formLogin</span><span class="o">(</span><span class="n">withDefaults</span><span class="o">())</span>
        <span class="o">.</span><span class="na">httpBasic</span><span class="o">(</span><span class="n">withDefaults</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p>上面是默认的生效规则：</p>

<ul>
  <li>确保用户发起的所有应用请求都要认证</li>
  <li>Allows users to authenticate with form based login</li>
  <li>Allows users to authenticate with HTTP Basic authentication</li>
</ul>

<p>我们可以自定义一个SecurityConfig类继承WebSecurityConfigurerAdapter,重写configure(HttpSecurity http)方法，定义自己的授权规则。</p>

<h2 id="2用户认证和授权详解">2、用户认证和授权详解</h2>

<p>建一个简单的项目，没导入springsecurity，访问首页</p>

<p><img src="/assets/images/2020/icoding/springsecurity/main.gif" alt="" /></p>

<p>我们想要不同用户访问不同level</p>

<blockquote>
  <p>导入依赖</p>
</blockquote>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>我们先不编写配置类，如前面阅读官方文档，springboot已经自动帮我们做了一些配置，包括一个用户user和密码，还有登录页面，启动看后台生成了一个随机密码</p>

<p><img src="/assets/images/2020/icoding/springsecurity/user-password.gif" alt="" /></p>

<p>浏览器访问任何请求都会跳到生成的登录页面，因为你还没有认证</p>

<p><img src="/assets/images/2020/icoding/springsecurity/default-login.gif" alt="" /></p>

<p>我们使用user和生成的密码登录，就可以登录到首页了。</p>

<h3 id="配置授权规则">配置授权规则</h3>

<p>新建一个configure类继承WebSecurityConfigurerAdapter，重写configure(HttpSecurity http)方法</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

	<span class="c1">// 定义授权规则</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="c1">// htpp的方法基本分为4个类别：过滤器，登录注销规则，安全配置，OAuth2配置</span>
		<span class="c1">// 一般我们只配置规则即可</span>
		<span class="c1">// 首页允许所有人访问</span>
		<span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
			<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/level1/**"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"vip1"</span><span class="o">)</span>
			<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/level2/**"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"vip2"</span><span class="o">)</span>
			<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/level3/**"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"vip3"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>访问首页/,不用登录，点击Level-1-2访问页面会报403错误Access Denied，<b style="color:red">因为你还没有认证登录。</b></p>

<p><img src="/assets/images/2020/icoding/springsecurity/Access Denied.gif" alt="" /></p>

<p>添加formlogin，</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">();</span>
</code></pre></div></div>

<p>这样没有认证访问就会跳到登录页了，使用user账号登录，点击Level-1-2 访问页面会报403错误 Forbidden，<b style="color:red">因为你还有没有授权</b>，user账号没有vip1的角色。</p>

<p><img src="/assets/images/2020/icoding/springsecurity/forbidden.gif" alt="" /></p>

<p>点击formLogin进入源码</p>

<p><img src="/assets/images/2020/icoding/springsecurity/formlogin.gif" alt="" /></p>

<p>可以看到表单登录用户和密码的默认参数名是username和password</p>

<p>默认的登录页请求是/login(Get请求)</p>

<p>默认的提交登录请求是/login(Post请求)</p>

<p>认证失败默认会跳转/login?error(Get请求)</p>

<h3 id="内存模式配置认证用户测试">内存模式配置认证用户测试</h3>

<p>从上面读formLogin的源码知道，我们可以重写configure(AuthenticationManagerBuilder auth)方法添加认证用户：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

	<span class="c1">// 授权规则</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="c1">// htpp的方法基本分为4个类别：过滤器，登录注销规则，安全配置，OAuth2配置</span>
		<span class="c1">// 一般我们只配置规则即可</span>
		<span class="c1">// 首页允许所有人访问</span>
		<span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
			<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/level1/**"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"vip1"</span><span class="o">)</span>
			<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/level2/**"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"vip2"</span><span class="o">)</span>
			<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/level3/**"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"vip3"</span><span class="o">);</span>

<span class="c1">//		表单登录用户和密码的默认参数名是username和password</span>
<span class="c1">//		默认的登录页请求是/login(Get请求)</span>
<span class="c1">//		默认的提交登录请求是/login(Post请求)</span>
<span class="c1">//		认证失败默认会跳转到/login?error(Get请求)</span>
		<span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// 认证用户</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="c1">// 内存中定义用户</span>
		<span class="n">auth</span><span class="o">.</span><span class="na">inMemoryAuthentication</span><span class="o">()</span>
				<span class="o">.</span><span class="na">withUser</span><span class="o">(</span><span class="s">"jude"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"123456"</span><span class="o">).</span><span class="na">roles</span><span class="o">(</span><span class="s">"vip1"</span><span class="o">,</span><span class="s">"vip2"</span><span class="o">,</span><span class="s">"vip3"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">and</span><span class="o">()</span>
				<span class="o">.</span><span class="na">withUser</span><span class="o">(</span><span class="s">"guest"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"123456"</span><span class="o">).</span><span class="na">roles</span><span class="o">(</span><span class="s">"vip1"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>重启用以上账号登录，</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 认证用户</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="c1">// 内存中定义用户</span>
  <span class="n">auth</span><span class="o">.</span><span class="na">inMemoryAuthentication</span><span class="o">()</span>
    <span class="o">.</span><span class="na">withUser</span><span class="o">(</span><span class="s">"jude"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="k">new</span> <span class="nc">BCryptPasswordEncoder</span><span class="o">(</span><span class="mi">11</span><span class="o">).</span><span class="na">encode</span><span class="o">(</span><span class="s">"123456"</span><span class="o">)).</span><span class="na">roles</span><span class="o">(</span><span class="s">"vip1"</span><span class="o">,</span><span class="s">"vip2"</span><span class="o">,</span><span class="s">"vip3"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">and</span><span class="o">()</span>
    <span class="o">.</span><span class="na">withUser</span><span class="o">(</span><span class="s">"guest"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="k">new</span> <span class="nc">BCryptPasswordEncoder</span><span class="o">(</span><span class="mi">11</span><span class="o">).</span><span class="na">encode</span><span class="o">(</span><span class="s">"123456"</span><span class="o">)).</span><span class="na">roles</span><span class="o">(</span><span class="s">"vip1"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/springsecurity/no-password-encoder.gif" alt="" /></p>

<p>搜索密码接口PasswordEncoder,发现是一个接口，有很多实现类</p>

<p><img src="/assets/images/2020/icoding/springsecurity/password-encoder.gif" alt="" /></p>

<p><a href="https://www.zhihu.com/question/20299384">了解加盐密码的通用加密方法</a></p>

<p>SpringSecurity推荐我们使用BCryptPasswordEncoder,</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 认证用户</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="c1">// 内存中定义用户信息,指定加密方式，要前后一致</span>
  <span class="n">auth</span><span class="o">.</span><span class="na">inMemoryAuthentication</span><span class="o">().</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="k">new</span> <span class="nc">BCryptPasswordEncoder</span><span class="o">(</span><span class="mi">11</span><span class="o">))</span>
    <span class="o">.</span><span class="na">withUser</span><span class="o">(</span><span class="s">"jude"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="k">new</span> <span class="nc">BCryptPasswordEncoder</span><span class="o">(</span><span class="mi">11</span><span class="o">).</span><span class="na">encode</span><span class="o">(</span><span class="s">"123456"</span><span class="o">)).</span><span class="na">roles</span><span class="o">(</span><span class="s">"vip1"</span><span class="o">,</span><span class="s">"vip2"</span><span class="o">,</span><span class="s">"vip3"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">and</span><span class="o">()</span>
    <span class="o">.</span><span class="na">withUser</span><span class="o">(</span><span class="s">"guest"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="k">new</span> <span class="nc">BCryptPasswordEncoder</span><span class="o">(</span><span class="mi">11</span><span class="o">).</span><span class="na">encode</span><span class="o">(</span><span class="s">"123456"</span><span class="o">)).</span><span class="na">roles</span><span class="o">(</span><span class="s">"vip1"</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里我们可以从数据库读取用户信息放到内存，但还不是动态的，因为无论是授权规则（角色访问菜单url），还是认证用户（用户绑定角色）大多数业务场景都是需要在页面上动态配置的。</p>

<p>重启后用guest测试登录，成功。</p>

<p>添加error 403错误页面</p>

<p><img src="/assets/images/2020/icoding/springsecurity/403.gif" alt="" /></p>

<p>访问level2页面：</p>

<p><img src="/assets/images/2020/icoding/springsecurity/forbidden-403.gif" alt="" /></p>

<h3 id="用户认证信息从数据库读取">用户认证信息从数据库读取</h3>

<p>配置类SecurityConfig 继承WebSecurityConfigurerAdapter</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
   <span class="nd">@Autowired</span>
    <span class="nc">UserServiceImpl</span> <span class="n">userService</span><span class="o">;</span>
  
  	<span class="c1">//请求授权验证</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
          <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span><span class="s">"/index"</span><span class="o">,</span><span class="s">"/favicon.ico"</span><span class="o">,</span><span class="s">"/bootstrap/**"</span><span class="o">,</span><span class="s">"/css/**"</span><span class="o">,</span><span class="s">"/editormd/**"</span><span class="o">,</span><span class="s">"/images/**"</span><span class="o">,</span><span class="s">"/js/**"</span><span class="o">,</span><span class="s">"/layer/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/register"</span><span class="o">,</span><span class="s">"/toLogin"</span><span class="o">,</span><span class="s">"/login"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/swagger-ui.html"</span><span class="o">,</span><span class="s">"/v2/api-docs"</span><span class="o">,</span><span class="s">"/swagger-resources/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// 默认UI的swagger请求</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/doc.html"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// bootstrap-ui 的请求</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">();</span>   <span class="c1">// 其他请求登录后可以访问</span>
      
      <span class="c1">// 登录配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
                <span class="o">.</span><span class="na">usernameParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">passwordParameter</span><span class="o">(</span><span class="s">"password"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/toLogin"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">loginProcessingUrl</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span> <span class="c1">// 登陆表单提交请求</span>
                <span class="o">.</span><span class="na">defaultSuccessUrl</span><span class="o">(</span><span class="s">"/index"</span><span class="o">);</span> <span class="c1">// 设置默认登录成功后跳转的页面</span>

        <span class="c1">// 注销配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">contentTypeOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
        <span class="n">http</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">frameOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span> <span class="c1">// 图片跨域</span>
        <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span><span class="c1">// 关闭csrf功能:跨站请求伪造,默认只能通过post方式提交logout请求</span>
        <span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">().</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span> <span class="c1">// 注销成功跳转到首页</span>

        <span class="c1">// 记住我配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">rememberMe</span><span class="o">().</span><span class="na">rememberMeParameter</span><span class="o">(</span><span class="s">"remember"</span><span class="o">);</span>
    <span class="o">}</span> 
    
  	<span class="c1">// 用户认证验证</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
       <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// 密码加密方式</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">(){</span>
       <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>  
</code></pre></div></div>

<p>userService 实现了org.springframework.security.core.userdetails.UserDetailsService</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span> <span class="kd">extends</span> <span class="nc">ServiceImpl</span><span class="o">&lt;</span><span class="nc">UserMapper</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">UserService</span><span class="o">,</span><span class="nc">UserDetailsService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="nc">UserRoleService</span> <span class="n">roleService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="nc">HttpSession</span> <span class="n">session</span><span class="o">;</span>

    <span class="c1">// 用户登录逻辑和验证处理</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="c1">// 通过用户名查询用户</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">getOne</span><span class="o">(</span><span class="k">new</span> <span class="nc">QueryWrapper</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;().</span><span class="na">eq</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">s</span><span class="o">));</span>

        <span class="c1">// 放入session</span>
        <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"loginUser"</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>

        <span class="c1">//创建一个新的UserDetails对象，最后验证登陆的需要</span>
        <span class="nc">UserDetails</span> <span class="n">userDetails</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="c1">//System.out.println("未加密："+user.getPassword());</span>
            <span class="c1">//String BCryptPassword = new BCryptPasswordEncoder().encode(user.getPassword());</span>
            <span class="c1">// 登录后会将登录密码进行加密，然后比对数据库中的密码，数据库密码需要加密存储！</span>
            <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>

            <span class="c1">//创建一个集合来存放权限</span>
            <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">getAuthorities</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
            <span class="c1">//实例化UserDetails对象</span>
            <span class="n">userDetails</span><span class="o">=</span><span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">userdetails</span><span class="o">.</span><span class="na">User</span><span class="o">(</span><span class="n">s</span><span class="o">,</span><span class="n">password</span><span class="o">,</span>
                            <span class="kc">true</span><span class="o">,</span>
                            <span class="kc">true</span><span class="o">,</span>
                            <span class="kc">true</span><span class="o">,</span>
                            <span class="kc">true</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">userDetails</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 获取角色信息</span>
    <span class="kd">private</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;();</span>
        <span class="nc">UserRole</span> <span class="n">role</span> <span class="o">=</span> <span class="n">roleService</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getRoleId</span><span class="o">());</span>
        <span class="c1">//注意：这里每个权限前面都要加ROLE_。否在最后验证不会通过</span>
        <span class="n">authList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">"ROLE_"</span><span class="o">+</span><span class="n">role</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
        <span class="k">return</span> <span class="n">authList</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="动态配置url权限">动态配置URL权限</h3>

<p>有两种方式实现，参考<a href="https://www.cnblogs.com/xiaoqi/p/spring-security-rabc.html">https://www.cnblogs.com/xiaoqi/p/spring-security-rabc.html</a></p>

<blockquote>
  <p>1、自定义AccessDecisionManager</p>
</blockquote>

<p>官方的三个AccessDecisionManager都是基于AccessDecisionVoter来实现权限认证的，因此我们只需要自定义一个AccessDecisionVoter就可以了。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoleBasedVoter</span> <span class="kd">implements</span> <span class="nc">AccessDecisionVoter</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">ConfigAttribute</span> <span class="n">configAttribute</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">vote</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">authentication</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 用户认证信息为空</span>
            <span class="k">return</span> <span class="no">ACCESS_DENIED</span><span class="o">;</span>   <span class="c1">// 禁止访问 -1</span>
        <span class="o">}</span>
      	<span class="c1">// 请求的URL</span>
        <span class="nc">FilterInvocation</span> <span class="n">fi</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FilterInvocation</span><span class="o">)</span> <span class="n">object</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="na">getRequestUrl</span><span class="o">();</span>
        <span class="c1">// 放行的url</span>
        <span class="k">if</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/register"</span><span class="o">)</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/toLogin"</span><span class="o">)){</span>
            <span class="k">return</span> <span class="no">ACCESS_GRANTED</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="no">ACCESS_ABSTAIN</span><span class="o">;</span> <span class="c1">// 放弃 0</span>
        <span class="c1">// 当前认证用户的角色权限集合，都是ROLE_ 开头</span>
        <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">extractAuthorities</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>

        <span class="c1">// 从Redis或者DB动态加载当前url的访问ROLE,add到attributes，实现动态</span>
        <span class="n">attributes</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">SecurityConfig</span><span class="o">.</span><span class="na">createList</span><span class="o">(</span><span class="s">"ROLE_1"</span><span class="o">,</span><span class="s">"ROLE_2"</span><span class="o">,</span><span class="s">"ROLE_3"</span><span class="o">));</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">ConfigAttribute</span> <span class="n">attribute</span> <span class="o">:</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">attribute</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">()==</span><span class="kc">null</span><span class="o">){</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">supports</span><span class="o">(</span><span class="n">attribute</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="no">ACCESS_DENIED</span><span class="o">;</span>

                <span class="c1">// Attempt to find a matching granted authority</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">GrantedAuthority</span> <span class="n">authority</span> <span class="o">:</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">attribute</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">authority</span><span class="o">.</span><span class="na">getAuthority</span><span class="o">()))</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="no">ACCESS_GRANTED</span><span class="o">;</span> <span class="c1">// 已授权 1</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">extractAuthorities</span><span class="o">(</span>
            <span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>将RoleBasedVoter加入到配置类SecurityConfig</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">UserServiceImpl</span> <span class="n">userService</span><span class="o">;</span>

    <span class="c1">//请求授权验证</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// .denyAll();    //拒绝访问</span>
        <span class="c1">// .authenticated();    //需认证通过</span>
        <span class="c1">// .permitAll();    //无条件允许访问</span>
        <span class="c1">// 访问权限</span>
        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span><span class="s">"/index"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/register"</span><span class="o">,</span><span class="s">"/login"</span><span class="o">,</span><span class="s">"/toLogin"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/*"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">();</span>
      
        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">accessDecisionManager</span><span class="o">(</span><span class="n">accessDecisionManager</span><span class="o">());</span> 

        <span class="c1">// 登录配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
                <span class="o">.</span><span class="na">usernameParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">passwordParameter</span><span class="o">(</span><span class="s">"password"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/toLogin"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">loginProcessingUrl</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span> <span class="c1">// 登陆表单提交请求</span>
                <span class="o">.</span><span class="na">defaultSuccessUrl</span><span class="o">(</span><span class="s">"/index"</span><span class="o">);</span> <span class="c1">// 设置默认登录成功后跳转的页面</span>

        <span class="c1">// 注销配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">contentTypeOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
        <span class="n">http</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">frameOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span> <span class="c1">// 图片跨域</span>
        <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span><span class="c1">// 关闭csrf功能:跨站请求伪造,默认只能通过post方式提交logout请求</span>
        <span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">().</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span> <span class="c1">// 注销成功跳转到首页</span>

        <span class="c1">// 记住我配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">rememberMe</span><span class="o">().</span><span class="na">rememberMeParameter</span><span class="o">(</span><span class="s">"remember"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 用户认证验证</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// 密码加密方式</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">AccessDecisionManager</span> <span class="nf">accessDecisionManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AccessDecisionVoter</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">decisionVoters</span>
                <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">WebExpressionVoter</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nf">RoleBasedVoter</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nf">AuthenticatedVoter</span><span class="o">());</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">UnanimousBased</span><span class="o">(</span><span class="n">decisionVoters</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>认证测试结果：</p>

<p><img src="\assets\images\2020\icoding\springsecurity\forbidden.jpg" alt="" /></p>

<p>把权限调整一下</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 从Redis或者DB动态加载当前url的访问ROLE,add到attributes，实现动态</span>
<span class="n">attributes</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">SecurityConfig</span><span class="o">.</span><span class="na">createList</span><span class="o">(</span><span class="s">"ROLE_管理员"</span><span class="o">,</span><span class="s">"ROLE_2"</span><span class="o">,</span><span class="s">"ROLE_3"</span><span class="o">));</span>
</code></pre></div></div>

<p>重启项目，重新访问localhost:8080/blog，有权限访问了（登录用户有“ROLE_管理员”的角色）</p>

<p><img src="\assets\images\2020\icoding\springsecurity\forbidden-2.jpg" alt="" /></p>

<blockquote>
  <p>2、自定义权限校验类</p>
</blockquote>

<p>看了官网的API文档有这么一段授权的说明</p>

<p><a href="https://docs.spring.io/spring-security/site/docs/5.3.4.RELEASE/reference/html5/#authz-after-invocation-handling">https://docs.spring.io/spring-security/site/docs/5.3.4.RELEASE/reference/html5/#authz-after-invocation-handling</a></p>

<p><img src="\assets\images\2020\icoding\springsecurity\webSecurity.jpg" alt="" /></p>

<p>根据官网新建类WebSecurity.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurity</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">check</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">,</span> <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">authentication</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 用户认证信息为空</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>   <span class="c1">// 禁止访问 -1</span>
        <span class="o">}</span>
        <span class="c1">// 请求的URI</span>
        <span class="nc">String</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>

        <span class="c1">// 当前认证用户的角色权限集合，都是ROLE_ 开头</span>
        <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">();</span>
        <span class="c1">// 从Redis或者DB动态加载当前访问的URI 查询对应的ROLE,add到attributes，实现动态</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">attributes</span> <span class="o">=</span> <span class="nc">SecurityConfig</span><span class="o">.</span><span class="na">createList</span><span class="o">(</span><span class="s">"ROLE_1"</span><span class="o">,</span><span class="s">"ROLE_2"</span><span class="o">,</span><span class="s">"ROLE_3"</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">ConfigAttribute</span> <span class="n">attribute</span> <span class="o">:</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">attribute</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">()==</span><span class="kc">null</span><span class="o">){</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// Attempt to find a matching granted authority</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">GrantedAuthority</span> <span class="n">authority</span> <span class="o">:</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">attribute</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">authority</span><span class="o">.</span><span class="na">getAuthority</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// 已授权 1</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>bean webSecurity放到配置类SecurityConfig</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">UserServiceImpl</span> <span class="n">userService</span><span class="o">;</span>

    <span class="c1">//请求授权验证</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="c1">// .denyAll();    //拒绝访问</span>
        <span class="c1">// .authenticated();    //需认证通过</span>
        <span class="c1">// .permitAll();    //无条件允许访问</span>
        <span class="c1">// 访问权限</span>
        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span><span class="s">"/index"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/register"</span><span class="o">,</span><span class="s">"/login"</span><span class="o">,</span><span class="s">"/toLogin"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/swagger-ui.html"</span><span class="o">,</span><span class="s">"/v2/api-docs"</span><span class="o">,</span><span class="s">"/swagger-resources/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// 默认UI的swagger请求</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/doc.html"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span> <span class="c1">// bootstrap-ui 的请求</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/*"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">();</span>   <span class="c1">// 其他请求登录后可以访问</span>

        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/*"</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">"@webSecurity.check(authentication,request)"</span><span class="o">);</span>
        
        <span class="c1">// 登录配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
                <span class="o">.</span><span class="na">usernameParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">passwordParameter</span><span class="o">(</span><span class="s">"password"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/toLogin"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">loginProcessingUrl</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span> <span class="c1">// 登陆表单提交请求</span>
                <span class="o">.</span><span class="na">defaultSuccessUrl</span><span class="o">(</span><span class="s">"/index"</span><span class="o">);</span> <span class="c1">// 设置默认登录成功后跳转的页面</span>

        <span class="c1">// 注销配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">contentTypeOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
        <span class="n">http</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">frameOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span> <span class="c1">// 图片跨域</span>
        <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span><span class="c1">// 关闭csrf功能:跨站请求伪造,默认只能通过post方式提交logout请求</span>
        <span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">().</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span> <span class="c1">// 注销成功跳转到首页</span>

        <span class="c1">// 记住我配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">rememberMe</span><span class="o">().</span><span class="na">rememberMeParameter</span><span class="o">(</span><span class="s">"remember"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 用户认证验证</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// 密码加密方式</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">WebSecurity</span> <span class="nf">webSecurity</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">WebSecurity</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>认证测试结果：</p>

<p><img src="\assets\images\2020\icoding\springsecurity\forbidden.jpg" alt="" /></p>

<p>把权限调整一下</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">attributes</span> <span class="o">=</span> <span class="nc">SecurityConfig</span><span class="o">.</span><span class="na">createList</span><span class="o">(</span><span class="s">"ROLE_管理员"</span><span class="o">,</span><span class="s">"ROLE_2"</span><span class="o">,</span><span class="s">"ROLE_3"</span><span class="o">);</span>
</code></pre></div></div>

<p>重启项目，重新访问localhost:8080/blog，有权限访问了（登录用户有“ROLE_管理员”的角色）</p>

<p><img src="\assets\images\2020\icoding\springsecurity\forbidden-2.jpg" alt="" /></p>

<blockquote>
  <p>3、自定义SecurityMetadataSource</p>
</blockquote>

<p>自定义FilterInvocationSecurityMetadataSource只要实现接口即可，在接口里从DB动态加载规则。为了复用代码里的定义，我们可以将代码里生成的SecurityMetadataSource带上，在构造函数里传入默认的FilterInvocationSecurityMetadataSource。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyFilterInvocationSecurityMetadataSource</span> <span class="kd">implements</span> <span class="nc">FilterInvocationSecurityMetadataSource</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">FilterInvocationSecurityMetadataSource</span>  <span class="n">superMetadataSource</span><span class="o">;</span>
     <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AntPathMatcher</span> <span class="n">antPathMatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AntPathMatcher</span><span class="o">();</span>
    
    <span class="c1">// 这里的需要从DB或者Redis加载</span>
    <span class="kd">private</span>  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">urlRoleMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;();</span>

    <span class="kd">public</span> <span class="nf">MyFilterInvocationSecurityMetadataSource</span><span class="o">(</span><span class="nc">FilterInvocationSecurityMetadataSource</span> <span class="n">expressionBasedFilterInvocationSecurityMetadataSource</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">superMetadataSource</span> <span class="o">=</span> <span class="n">expressionBasedFilterInvocationSecurityMetadataSource</span><span class="o">;</span>
        <span class="c1">// TODO 从数据库加载权限配置,就是urlRoleMap</span>
        <span class="n">urlRoleMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"/open/**"</span><span class="o">,</span><span class="s">"ROLE_ANONYMOUS"</span><span class="o">);</span>
        <span class="n">urlRoleMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"/health"</span><span class="o">,</span><span class="s">"ROLE_ANONYMOUS"</span><span class="o">);</span>
        <span class="n">urlRoleMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"/restart"</span><span class="o">,</span><span class="s">"ROLE_ADMIN"</span><span class="o">);</span>
        <span class="n">urlRoleMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"/demo"</span><span class="o">,</span><span class="s">"ROLE_USER"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IllegalArgumentException</span> <span class="o">{</span>
        <span class="nc">FilterInvocation</span> <span class="n">fi</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FilterInvocation</span><span class="o">)</span> <span class="n">object</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="na">getRequestUrl</span><span class="o">();</span>

        <span class="k">for</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nl">entry:</span><span class="n">urlRoleMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">()){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">antPathMatcher</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span><span class="n">url</span><span class="o">)){</span> <span class="c1">// 获取当前请求url的访问角色</span>
                <span class="k">return</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">access</span><span class="o">.</span><span class="na">SecurityConfig</span><span class="o">.</span><span class="na">createList</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// 返回代码定义的默认配置,</span>
        <span class="k">return</span> <span class="n">superMetadataSource</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="nf">getAllConfigAttributes</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">FilterInvocation</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">aClass</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>将MyFilterInvocationSecurityMetadataSource加入到SecurityConfiguration ，</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableWebSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">UserServiceImpl</span> <span class="n">userService</span><span class="o">;</span>

    <span class="c1">//请求授权验证</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// 访问权限</span>
        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span><span class="s">"/index"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/register"</span><span class="o">,</span><span class="s">"/login"</span><span class="o">,</span><span class="s">"/toLogin"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withObjectPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ObjectPostProcessor</span><span class="o">&lt;</span><span class="nc">FilterSecurityInterceptor</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">O</span> <span class="kd">extends</span> <span class="nc">FilterSecurityInterceptor</span><span class="o">&gt;</span> <span class="no">O</span> <span class="nf">postProcess</span><span class="o">(</span><span class="no">O</span> <span class="n">fsi</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">fsi</span><span class="o">.</span><span class="na">setSecurityMetadataSource</span><span class="o">(</span><span class="n">mySecurityMetadataSource</span><span class="o">(</span><span class="n">fsi</span><span class="o">.</span><span class="na">getSecurityMetadataSource</span><span class="o">()));</span>
                        <span class="k">return</span> <span class="n">fsi</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">});</span>
      <span class="c1">// 登录配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
                <span class="o">.</span><span class="na">usernameParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">passwordParameter</span><span class="o">(</span><span class="s">"password"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/toLogin"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">loginProcessingUrl</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span> <span class="c1">// 登陆表单提交请求</span>
                <span class="o">.</span><span class="na">defaultSuccessUrl</span><span class="o">(</span><span class="s">"/index"</span><span class="o">);</span> <span class="c1">// 设置默认登录成功后跳转的页面</span>

        <span class="c1">// 注销配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">contentTypeOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
        <span class="n">http</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">frameOptions</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span> <span class="c1">// 图片跨域</span>
        <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span><span class="c1">// 关闭csrf功能:跨站请求伪造,默认只能通过post方式提交logout请求</span>
        <span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">().</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span> <span class="c1">// 注销成功跳转到首页</span>

        <span class="c1">// 记住我配置</span>
        <span class="n">http</span><span class="o">.</span><span class="na">rememberMe</span><span class="o">().</span><span class="na">rememberMeParameter</span><span class="o">(</span><span class="s">"remember"</span><span class="o">);</span>
    <span class="o">}</span>
  
  <span class="c1">// 用户认证验证</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// 密码加密方式</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>
  
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MyFilterInvocationSecurityMetadataSource</span> <span class="nf">mySecurityMetadataSource</span><span class="o">(</span><span class="nc">FilterInvocationSecurityMetadataSource</span> <span class="n">filterInvocationSecurityMetadataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MyFilterInvocationSecurityMetadataSource</span> <span class="n">securityMetadataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyFilterInvocationSecurityMetadataSource</span><span class="o">(</span><span class="n">filterInvocationSecurityMetadataSource</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">securityMetadataSource</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>      
</code></pre></div></div>

<p>认证测试结果：</p>

<p>失败，静态资源也拦截，但是都没有校验权限的。</p>

<h3 id="记住我">记住我</h3>

<p>参考 <a href="https://cloud.tencent.com/developer/article/1540670">https://cloud.tencent.com/developer/article/1540670</a></p>

<p>SpringSecurity过滤链如下图</p>

<p><img src="\assets\images\2020\icoding\springsecurity\filter-chain.png" alt="" /></p>

<p>进入登录页面，你输入用户名以及密码进行登录，Spring Security首先会进入UsernamePasswordAuthenticationFilter进行验证，如果认证成功它会调用一个叫RememberMeService的类（开启remember me 功能后），这个类会调用TokenRepository这个类，而这个类会将一个生成的Token写入数据库中，并且将Token存入cookie。下次请求就会带上name=”remember-me”,value=Token的cookie</p>

<p>当你下次再进入该网站的时候，SpringSecurity判断请求带有“remember-me”这个cookie，它会直接进入RemeberMeAuthticationFilter这个过滤器中，Cookie的值就是之前的Token，然后拿着这个Token通过RememberService到数据库中查找用户信息，如果存在该Token，则取出该Token对应的用户名以及其他信息放入UserDetailService，然后进入调用的URL。流程大概如下图：</p>

<p><img src="\assets\images\2020\icoding\springsecurity\remember-me-authentication-filter.jpg" alt="" /></p>

<blockquote>
  <p>实战</p>
</blockquote>

<p>1）配置 PersistentTokenRepository 对象</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>    
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

  <span class="nd">@Bean</span>
  <span class="nc">UserDetailsService</span> <span class="nf">myUserDetailService</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">MyUserDetailsService</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">PersistentTokenRepository</span> <span class="nf">persistentTokenRepository</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">JdbcTokenRepositoryImpl</span> <span class="n">persistentTokenRepository</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcTokenRepositoryImpl</span><span class="o">();</span>
    <span class="n">persistentTokenRepository</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">persistentTokenRepository</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">PersistentTokenRepository</code> 为一个接口类，这里我们用的是数据库持久化，所以实际使用的 PersistentTokenRepository 实现类是 <code class="highlighter-rouge">JdbcTokenRepositoryImpl</code>，使用它的时候需要指定数据源，所以我们需要将已配置的 <code class="highlighter-rouge">dataSource</code> 对象注入到 <code class="highlighter-rouge">JdbcTokenRepositoryImpl</code> 的 <code class="highlighter-rouge">dataSource</code> 属性中。</p>

<p>2)  创建 persistent_logins 数据表</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create</span> <span class="n">table</span> <span class="nf">persistent_logins</span> <span class="o">(</span>
  <span class="n">username</span> <span class="nf">varchar</span><span class="o">(</span><span class="mi">64</span><span class="o">)</span> <span class="n">not</span> <span class="kc">null</span><span class="o">,</span> 
  <span class="n">series</span> <span class="nf">varchar</span><span class="o">(</span><span class="mi">64</span><span class="o">)</span> <span class="n">primary</span> <span class="n">key</span><span class="o">,</span> 
	<span class="n">token</span> <span class="nf">varchar</span><span class="o">(</span><span class="mi">64</span><span class="o">)</span> <span class="n">not</span> <span class="kc">null</span><span class="o">,</span> 
  <span class="n">last_used</span> <span class="n">timestamp</span> <span class="n">not</span> <span class="kc">null</span>
<span class="o">)</span>
</code></pre></div></div>

<p>3) 添加 remember me 复选框</p>

<p>打开 <code class="highlighter-rouge">resources/templates</code> 路径下的 <code class="highlighter-rouge">login.html</code> 登录页，添加 Remember Me 复选框：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-field"</span><span class="nt">&gt;</span>
   Remember Me：<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">name=</span><span class="s">"remember-me"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Remember Me 复选框的 name 属性的值必须为 “remember-me”,因为<code class="highlighter-rouge">RememberMeConfigurer</code>里的rememberMeParameter字段默认是“remember-me”</p>

<p><img src="\assets\images\2020\icoding\springsecurity\remember-configurer.png" alt="" /></p>

<p>你可以修改在SecurityConfig配置类修改参数名</p>

<p><img src="\assets\images\2020\icoding\springsecurity\remember-configurer-2.png" alt="" /></p>

<p>SecurityConfig配置类开启remeber me配置</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 记住我设置，当服务重启后，用户不会被拦截到登录页面也可以访问资源，客户端token是存在cookie中的，所以清除了cookie就要重新登录了</span>
<span class="n">http</span><span class="o">.</span><span class="na">rememberMe</span><span class="o">()</span>
  <span class="o">.</span><span class="na">tokenRepository</span><span class="o">(</span><span class="n">persistentTokenRepository</span><span class="o">())</span> <span class="c1">// 配置token持久化仓库</span>
  <span class="o">.</span><span class="na">tokenValiditySeconds</span><span class="o">(</span><span class="mi">604800</span><span class="o">)</span> <span class="c1">// 过期时间七天，单位秒</span>
  <span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userConfig</span><span class="o">);</span> <span class="c1">// 自动登录逻辑处理</span>
</code></pre></div></div>

<h3 id="注销">注销</h3>

<p>授权规则里添加</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 开启注销，其实spring security默认已经开启的了</span>
<span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">();</span>
</code></pre></div></div>

<p>点击它的源码</p>

<p><img src="/assets/images/2020/icoding/springsecurity/logout-source-code.gif" alt="" /></p>

<p>首页添加我们的注销按钮</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"item"</span> <span class="na">th:href=</span><span class="s">"@{/logout}"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"address card icon"</span><span class="nt">&gt;&lt;/i&gt;</span> 登录
<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<p>发现其实SpringSecurity已经帮我们定义好了登录注销规则</p>

<p><img src="/assets/images/2020/icoding/springsecurity/login-logout.gif" alt="" /></p>

<p>关于默认的登出url，源码里这么说的</p>

<p><img src="/assets/images/2020/icoding/springboot/springsecurity-logouturl.jpg" alt="" /></p>

<p>默认注销url是<code class="highlighter-rouge">/logout</code>，开启CSRF后必须是post请求，关闭CSRF后可以是get请求</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 注销,默认开启的注销功能</span>
<span class="n">http</span><span class="o">.</span><span class="na">logout</span><span class="o">().</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>    <span class="c1">// 注销成功跳转到首页</span>
</code></pre></div></div>

<p>重启项目测试，登录和注销。</p>

<h2 id="3结合前端控制">3、结合前端控制</h2>

<p>Spring Security 和 Thymeleaf的结合</p>

<blockquote>
  <p>1.导入依赖</p>
</blockquote>

<p>访问maven仓库 <a href="https://mvnrepository.com/search?q=thymelea&amp;p=2">https://mvnrepository.com/search?q=thymeleaf&amp;p=2</a></p>

<p><img src="/assets/images/2020/icoding/springsecurity/thymleaf-extras-springsecurity5.gif" alt="" /></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- thymeleaf 和 springsecurity5的整合包，一定要与spring的版本对应--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.thymeleaf.extras<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>thymeleaf-extras-springsecurity5<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>3.0.4.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>发现shiro和thymeleaf的整合包也有</p>

<p><img src="/assets/images/2020/icoding/springsecurity/thymeleaf-extras-shiro.gif" alt="" /></p>

<blockquote>
  <p>2.修改前端页面</p>
</blockquote>

<p>导入命名空间约束</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span>
      <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span>
      <span class="na">xmlns:sec=</span><span class="s">"http://www.thymeleaf.org/extras/spring-security"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  .....
</code></pre></div></div>

<p><b style="color:red">Thymeleaf-extras-spring security 的github地址</b>：<a href="https://github.com/thymeleaf/thymeleaf-extras-springsecurity">https://github.com/thymeleaf/thymeleaf-extras-springsecurity</a></p>

<p><img src="/assets/images/2020/icoding/springsecurity/thymleaf-extras-springsecurity-github.gif" alt="" /></p>

<p>注意版本对应问题，上图已说明。</p>

<p><b style="color:red">命名空间</b>：	<img src="/assets/images/2020/icoding/springsecurity/thymleaf-extras-springsecurity-namespace.gif" alt="" /></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--登录注销--&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"right menu"</span><span class="nt">&gt;</span>

  <span class="c">&lt;!--核心类：Authentication--&gt;</span>
  <span class="c">&lt;!-- 如果未登录（认证）就显示登录按钮 --&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">sec:authorize=</span><span class="s">"!isAuthenticated()"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"item"</span> <span class="na">th:href=</span><span class="s">"@{/login}"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"address card icon"</span><span class="nt">&gt;&lt;/i&gt;</span> 登录
    <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="c">&lt;!-- 如果已登录，显示用户的信息 --&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">sec:authorize=</span><span class="s">"isAuthenticated()"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"item"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!--&lt;i class="address card icon"&gt;&lt;/i&gt;--&gt;</span>
      用户名：<span class="nt">&lt;span</span> <span class="na">sec:authentication=</span><span class="s">"principal.username"</span><span class="nt">&gt;&lt;/span&gt;</span> <span class="ni">&amp;nbsp;</span>
      角色：<span class="nt">&lt;span</span> <span class="na">sec:authentication=</span><span class="s">"principal.authorities"</span><span class="nt">&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">sec:authorize=</span><span class="s">"isAuthenticated()"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"item"</span> <span class="na">th:href=</span><span class="s">"@{/logout}"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"address card icon"</span><span class="nt">&gt;&lt;/i&gt;</span> 注销
    <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
....
<span class="c">&lt;!--前端控制显示--&gt;</span>
<span class="nt">&lt;div</span> <span class="na">sec:authorize=</span><span class="s">"hasRole('vip1')"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"column"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui raised segment"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h5</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>Level 1<span class="nt">&lt;/h5&gt;</span>
          <span class="nt">&lt;hr&gt;</span>
          <span class="nt">&lt;div&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/level1/1}"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"bullhorn icon"</span><span class="nt">&gt;&lt;/i&gt;</span> Level-1-1<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;div&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/level1/2}"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"bullhorn icon"</span><span class="nt">&gt;&lt;/i&gt;</span> Level-1-2<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;div&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/level1/3}"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"bullhorn icon"</span><span class="nt">&gt;&lt;/i&gt;</span> Level-1-3<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">sec:authorize=</span><span class="s">"hasRole('vip2')"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"column"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui raised segment"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h5</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>Level 2<span class="nt">&lt;/h5&gt;</span>
          <span class="nt">&lt;hr&gt;</span>
          <span class="nt">&lt;div&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/level2/1}"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"bullhorn icon"</span><span class="nt">&gt;&lt;/i&gt;</span> Level-2-1<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;div&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/level2/2}"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"bullhorn icon"</span><span class="nt">&gt;&lt;/i&gt;</span> Level-2-2<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;div&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/level2/3}"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"bullhorn icon"</span><span class="nt">&gt;&lt;/i&gt;</span> Level-2-3<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">sec:authorize=</span><span class="s">"hasRole('vip3')"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"column"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui raised segment"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h5</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>Level 3<span class="nt">&lt;/h5&gt;</span>
          <span class="nt">&lt;hr&gt;</span>
          <span class="nt">&lt;div&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/level3/1}"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"bullhorn icon"</span><span class="nt">&gt;&lt;/i&gt;</span> Level-3-1<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;div&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/level3/2}"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"bullhorn icon"</span><span class="nt">&gt;&lt;/i&gt;</span> Level-3-2<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;div&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/level3/3}"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"bullhorn icon"</span><span class="nt">&gt;&lt;/i&gt;</span> Level-3-3<span class="nt">&lt;/a&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>重启项目测试 ，访问首页</p>

<p><img src="/assets/images/2020/icoding/springsecurity/main-with-no-authentication.gif" alt="" /></p>

<p>用guest 登录：</p>

<p><img src="/assets/images/2020/icoding/springsecurity/main-guest.gif" alt="" /></p>

<p>用Jude登录：</p>

<p><img src="/assets/images/2020/icoding/springsecurity/main-jude.gif" alt="" /></p>

<h2 id="4登录页定制和记住我">4、登录页定制和记住我</h2>

<p>自定义登录页面 login.html：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui segment"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"text-align: center"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"header"</span><span class="nt">&gt;</span>登录<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui placeholder segment"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui column very relaxed stackable grid"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"column"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui form"</span><span class="nt">&gt;</span>
          <span class="c">&lt;!-- 提交请求记得修改！ --&gt;</span>
          <span class="nt">&lt;form</span> <span class="na">th:action=</span><span class="s">"@{/login}"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;label&gt;</span>Username<span class="nt">&lt;/label&gt;</span>
              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui left icon input"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">placeholder=</span><span class="s">"Username"</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"user icon"</span><span class="nt">&gt;&lt;/i&gt;</span>
              <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;label&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui left icon input"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"lock icon"</span><span class="nt">&gt;&lt;/i&gt;</span>
              <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">name=</span><span class="s">"remember"</span><span class="nt">&gt;</span> 记住我
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"ui blue submit button"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;/form&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"text-align: center"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui label"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/i&gt;</span>注册
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Controller 添加路由</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">login</span><span class="o">(){</span>
  <span class="k">return</span> <span class="s">"login"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>SecurityConfig 修改http指定登录页面请求</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
<span class="o">...</span>    
<span class="n">http</span><span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
			<span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/login"</span><span class="o">);</span>

<span class="c1">// 自定义的登录页需要配置 rememberMe 的参数名,就可以绑定到我们前端的！</span>
<span class="c1">// 记住我功能</span>
<span class="n">http</span><span class="o">.</span><span class="na">rememberMe</span><span class="o">().</span><span class="na">rememberMeParameter</span><span class="o">(</span><span class="s">"remember"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>重启项目测试，</p>

<p><img src="/assets/images/2020/icoding/springsecurity/login.gif" alt="" /></p>

<p>使用jude登录，勾选记住我，登录成功</p>

<p><img src="/assets/images/2020/icoding/springsecurity/remeber-me.gif" alt="" /></p>

<p>会发现cookie中多一个remember-me，有效期是半个月，也就是说你只要不退出，半个月都不用登录了，浏览器每次请求都会把这个cookie带到服务端判断。</p>

<p>但点击“注销”退出报404</p>

<p><img src="/assets/images/2020/icoding/springsecurity/logout-404.gif" alt="" /></p>

<p>估计是自定义了/login请求，也必须要自定义/logout请求的原因。</p>

<p>关闭防csrf攻击功能</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 如果注销404，因为 Security 默认是防止 csrf 跨站伪请求！</span>
 <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span> <span class="c1">// 可能会让我们系统不安全</span>
</code></pre></div></div>

<p>重启项目，测试注销登出成功。</p>

<p><img src="/assets/images/2020/icoding/springsecurity/logout-get.gif" alt="" /></p>

<p>但是这样不安全，百度百科CSRF:</p>

<blockquote>
  <p><strong>跨站请求伪造</strong>（英语：Cross-site request forgery），也被称为 <strong>one-click attack</strong> 或者 <strong>session riding</strong>，通常缩写为 <strong>CSRF</strong> 或者 <strong>XSRF</strong>， 是一种挟制用户在当前已登录的Web应用程序上执行非本意的操作的攻击方法。跟<a href="https://baike.baidu.com/item/跨网站脚本">跨网站脚本</a>（XSS）相比，<strong>XSS</strong> 利用的是用户对指定网站的信任，CSRF 利用的是网站对用户网页浏览器的信任。</p>
</blockquote>

<p>开启防CSRF攻击，把/logout 提交方法要改成用form表达 POST提交：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">sec:authorize=</span><span class="s">"isAuthenticated()"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- 将注销请求也改成post提交即可！ --&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">th:action=</span><span class="s">"@{/logout}"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>注销<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>重启项目，测试：</p>

<p><img src="/assets/images/2020/icoding/springsecurity/logout-post.gif" alt="" /></p>

<p>这样就安全了。</p>

<h2 id="5整合jwt无状态验证">5、整合JWT无状态验证</h2>

<p>1、pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!--JWT库--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.auth0<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>java-jwt<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>3.10.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、自定义过滤器用来解析JWT信息</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JWTAuthenticationFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">JWTUtils</span> <span class="n">jwt</span><span class="o">;</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">MyUserDetailsService</span> <span class="n">userDetailService</span><span class="o">;</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">BCryptPasswordEncoder</span> <span class="n">encoder</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">//获取Http头中的Authentication</span>
    <span class="nc">String</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Authentication"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNullOrEmpty</span><span class="o">(</span><span class="n">authentication</span><span class="o">)){</span>
      <span class="c1">//解析JWT</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">claims</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="na">parseToken</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>

      <span class="c1">//如果解析后不为空，并且Security上下文中没有获取到验证信息（说明没有登录过，因为是无状态的，所以不会保存验证信息。）</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">claims</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">()==</span><span class="kc">null</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">claims</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>

        <span class="c1">//重新经过userDetailService验证一次用户名和密码，因为JWT验证无法确保用户是否修改了密码，有被盗风险，或者可以加入IP验证。</span>
        <span class="nc">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="n">userDetailService</span><span class="o">.</span><span class="na">loadUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userDetails</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">encoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">password</span><span class="o">,</span><span class="n">userDetails</span><span class="o">.</span><span class="na">getPassword</span><span class="o">())){</span>
            <span class="nc">UsernamePasswordAuthenticationToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
            <span class="c1">//token.setDetails(new WebAuthenticationDetailsSource().buildDetails(httpServletRequest));</span>

            <span class="c1">//在上下文中写入jwt解析后的信息，经过UsernamePasswordAuthenticationFilter时就会认为验证通过                        </span>
            <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">httpServletRequest</span><span class="o">,</span> <span class="n">httpServletResponse</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3、配置类SecurityConfig</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableWebSecurity</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
  <span class="c1">// 密码加密方式</span>
  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">BCryptPasswordEncoder</span> <span class="nf">encoder</span><span class="o">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="c1">// 配置AuthenticationManager</span>
  <span class="nd">@Override</span>
  <span class="nd">@Bean</span>
  <span class="kd">public</span> <span class="nc">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="c1">// 用户信息服务，测试可以直接用memory方式</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">MyUserDetailsService</span> <span class="n">myUserDetailsService</span><span class="o">;</span>

  <span class="c1">// 自定义过滤器用来解析JWT信息</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">JWTAuthenticationFilter</span> <span class="n">jwtAuthenticationFilter</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">UrlBasedCorsConfigurationSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UrlBasedCorsConfigurationSource</span><span class="o">();</span>
    <span class="kd">final</span> <span class="nc">CorsConfiguration</span> <span class="n">corsConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CorsConfiguration</span><span class="o">();</span>
    <span class="n">corsConfiguration</span><span class="o">.</span><span class="na">setAllowCredentials</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">corsConfiguration</span><span class="o">.</span><span class="na">addAllowedHeader</span><span class="o">(</span><span class="s">"*"</span><span class="o">);</span>
    <span class="n">corsConfiguration</span><span class="o">.</span><span class="na">addAllowedOrigin</span><span class="o">(</span><span class="s">"*"</span><span class="o">);</span>
    <span class="n">corsConfiguration</span><span class="o">.</span><span class="na">addAllowedMethod</span><span class="o">(</span><span class="s">"*"</span><span class="o">);</span>
    <span class="n">corsConfiguration</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">18000L</span><span class="o">);</span>
    <span class="n">source</span><span class="o">.</span><span class="na">registerCorsConfiguration</span><span class="o">(</span><span class="s">"/**"</span><span class="o">,</span> <span class="n">corsConfiguration</span><span class="o">);</span>
    <span class="c1">// 配置访问权限 关闭csrf 允许跨域请求</span>
    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">"/login**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">().</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">();</span>
    <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
    <span class="n">http</span><span class="o">.</span><span class="na">cors</span><span class="o">().</span><span class="na">configurationSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
    <span class="n">http</span><span class="o">.</span><span class="na">sessionManagement</span><span class="o">().</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">);</span>
    <span class="c1">// 在Security里UsernamePasswordAuthenticationFilter之前，添加一个过滤器(自定义的)</span>
    <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span><span class="n">jwtAuthenticationFilter</span><span class="o">,</span> <span class="nc">UsernamePasswordAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>
  
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="cm">/* 继承org.springframework.security.core.userdetails.UserDetailsService;UserDetailsService，重写方法从数据库读取用户的账目密码信息构成一个用户令牌*/</span>
      <span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">myUserDetailsService</span><span class="o">).</span><span class="na">passwordEncoder</span><span class="o">(</span><span class="n">encoder</span><span class="o">());</span>
      <span class="c1">// 内存方式固定用户名密码构成用户令牌</span>
      <span class="cm">/*
      auth.inMemoryAuthentication()
      .withUser("test").password(bCryptPasswordEncoder().encode("test123"))
      .authorities("admin")
          .and().passwordEncoder(bCryptPasswordEncoder());
      */</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4、工具类JWTUtils 创建JWT token，解析token获取当前用户</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.auth0.jwt.JWT</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.auth0.jwt.algorithms.Algorithm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.auth0.jwt.exceptions.JWTVerificationException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.auth0.jwt.interfaces.DecodedJWT</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JWTUtils</span> <span class="o">{</span>
  <span class="c1">// 只有服务器上有的签名字符串</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Algorithm</span> <span class="no">SIGN</span> <span class="o">=</span> <span class="nc">Algorithm</span><span class="o">.</span><span class="na">HMAC256</span><span class="o">(</span><span class="s">"dfds%*af13%^##fgfgs1"</span><span class="o">);</span>

  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">createToken</span><span class="o">(</span><span class="nc">UserDetails</span> <span class="n">user</span><span class="o">){</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">claims</span><span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">());</span>
    <span class="n">claims</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
    <span class="k">return</span> <span class="no">JWT</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
      <span class="o">.</span><span class="na">withExpiresAt</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">))</span>  <span class="c1">//设置过期时间</span>
      <span class="o">.</span><span class="na">withClaim</span><span class="o">(</span><span class="s">"principal"</span><span class="o">,</span><span class="n">claims</span><span class="o">)</span>
      <span class="o">.</span><span class="na">sign</span><span class="o">(</span><span class="no">SIGN</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">parseToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">token</span><span class="o">){</span>
    <span class="k">try</span><span class="o">{</span>
      <span class="nc">DecodedJWT</span> <span class="n">verify</span> <span class="o">=</span> <span class="no">JWT</span><span class="o">.</span><span class="na">require</span><span class="o">(</span><span class="no">SIGN</span><span class="o">).</span><span class="na">build</span><span class="o">().</span><span class="na">verify</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">verify</span><span class="o">.</span><span class="na">getExpiresAt</span><span class="o">().</span><span class="na">after</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">())){</span>
        <span class="k">return</span> <span class="n">verify</span><span class="o">.</span><span class="na">getClaim</span><span class="o">(</span><span class="s">"principal"</span><span class="o">).</span><span class="na">asMap</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">JWTVerificationException</span> <span class="n">ignored</span><span class="o">){</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>5、测试</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>
  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">JWTUtils</span> <span class="n">jwt</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">AuthenticationManager</span> <span class="n">authenticationManager</span><span class="o">;</span>


  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
  <span class="nd">@ResponseBody</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">login</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"username"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">username</span><span class="o">,</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"password"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">//这里使用authenticationManager验证，最终还会用到Config中设置的userDetailsService的loadUserByUsername方法</span>
      <span class="c1">//也可以直接用userDetailsService进行验证，反正只是为了封装JWT信息</span>
      <span class="nc">UsernamePasswordAuthenticationToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
      <span class="n">authenticationManager</span><span class="o">.</span><span class="na">authenticate</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">BadCredentialsException</span> <span class="n">e</span><span class="o">){</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"账号密码错误"</span><span class="o">,</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="na">createToken</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">username</span><span class="o">(</span><span class="n">username</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">password</span><span class="o">).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"Login"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">)</span>
  <span class="nd">@ResponseBody</span>
  <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasAuthority('admin')"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">hello</span><span class="o">(){</span>
    <span class="k">return</span> <span class="s">"hello"</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>@EnableGlobalMethodSecurity</p>
</blockquote>

<p>注意在SecurityConfig添加了注解@EnableGlobalMethodSecurity开启了方法级别的安全认证，这个注解为我们提供了prePostEnabled 、securedEnabled 和 jsr250Enabled 三种不同的机制</p>

<p><img src="\assets\images\2020\icoding\springsecurity\enable-global-method-security.png" alt="" /></p>

<ul>
  <li>
    <p><strong>prePostEnabled</strong></p>

    <p>prePostEnabled = true 会解锁下面两个注解</p>

    <p>1) @PreAuthorize 在方法执行前进行验证</p>

    <p>2) @PostAuthorize 在方法执行后进行验证</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findAllUsers</span><span class="o">();</span>
  
    <span class="nd">@PostAuthorize</span> <span class="o">(</span><span class="s">"returnObject.type == authentication.name"</span><span class="o">)</span>
    <span class="nc">User</span> <span class="nf">findById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
      
	<span class="c1">//  @PreAuthorize("hasRole('ADMIN')") 必须拥有 ROLE_ADMIN 角色。</span>
    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasRole('ROLE_ADMIN ')"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">updateUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">);</span>
      
    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasRole('ADMIN') AND hasRole('DBA')"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
      
    <span class="c1">// @PreAuthorize("principal.username.startsWith('Felordcn')") 用户名开头为 Felordcn 的用户才能访问。</span>
    <span class="c1">// @PreAuthorize("#id.equals(principal.username)") 入参 id 必须同当前的用户名相同。</span>
    <span class="c1">// @PreAuthorize("#id &lt; 10") 限制只能查询 id 小于 10 的用户</span>
    
  <span class="nd">@PreFilter</span><span class="o">(</span><span class="n">filterTarget</span><span class="o">=</span><span class="s">"ids"</span><span class="o">,</span> <span class="n">value</span><span class="o">=</span><span class="s">"filterObject%2==0"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">username</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>常见的内置表达式如下：</p>

    <p><img src="\assets\images\2020\icoding\springsecurity\prepost-enabled-el.png" alt="" /></p>

    <p>@PostAuthorize： 该注解使用不多，在方法执行后再进行权限验证。 适合验证带有返回值的权限。Spring EL 提供 返回对象能够在表达式语言中获取返回的对象returnObject。区别在于先执行方法。而后进行表达式判断。如果方法没有返回值实际上等于开放权限控制；如果有返回值实际的结果是用户操作成功但是得不到响应。允许方法调用,但是如果表达式计算结果为false,将抛出一个安全性异常。</p>
  </li>
  <li>
    <p><strong>secureEnabled</strong></p>

    <p>在service方法上添加注解@Secured，在需要安全[角色/权限等]的方法上指定 @Secured，并且只有那些角色/权限的用户才可以调用该方法。</p>

    <p><mark>注意</mark>.</p>

    <p>1) 不支持Spring EL表达式</p>

    <p>2) 指定的角色必须以ROLE_开头，只要其声明的角色集合（value）中包含当前用户持有的任一角色就可以访问</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Secured</span><span class="o">({</span><span class="s">"ROLE_user"</span><span class="o">})</span>
<span class="kt">void</span> <span class="nf">updateUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">);</span>

<span class="nd">@Secured</span><span class="o">({</span><span class="s">"ROLE_admin"</span><span class="o">,</span> <span class="s">"ROLE_user1"</span><span class="o">})</span>
<span class="kt">void</span> <span class="nf">updateUser</span><span class="o">();</span>
</code></pre></div></div>

<ul>
  <li>
    <p><strong>jsr250Enabled</strong></p>

    <p>启用 JSR-250 安全控制注解，这属于 JavaEE 的安全规范（现为 jakarta 项目），为true开启下面三个注解</p>

    <p>1) @DenyAll： 拒绝所有访问</p>

    <p>2) @RolesAllowed({“USER”, “ADMIN”})： 该方法只要具有”USER”, “ADMIN”任意一种权限就可以访问。这里可以省略前缀ROLE_，实际的权限可能是ROLE_ADMIN</p>

    <p>3) @PermitAll： 允许所有访问</p>
  </li>
</ul>


            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-edu/2020/03/25/icoding-note-013.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
