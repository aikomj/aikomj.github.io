<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 黄埔班第37节：分布式搜索引擎ElasticSearch实战-3 - 大伟的博客 </title>
    <meta name="keywords" content="elasticSearch">
    <meta name="description"
          content="使用中文和拼音分词器搜索，深度分页问题的分析与scroll滚动搜索，批量查询doc，批量操作bulk，ES集群构建，脑裂问题分析与解决，集群文档的读写原理，如何合理设置分片数和副本数">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/icoding-gavin/2020/02/19/gavin-note-037.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="黄埔班第37节：分布式搜索引擎ElasticSearch实战-3">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>黄埔班第37节：分布式搜索引擎ElasticSearch实战-3</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/02/19
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <h2 id="1同时使用中文和拼音分词器">1、同时使用中文和拼音分词器</h2>

<ul>
  <li>拼音分词器</li>
  <li>ik中文分词</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载拼音分词器</span>
<span class="c"># 新增分词器后，先加的记录是不能被匹配出来的，要后加的记录才能匹配</span>
<span class="c"># elasticsearch-analysis-pinyin-7.5.2.zip</span>
<span class="c"># 1、下载分词器 Github: elasticsearch-analysis-pinyin</span>
wget https://github.com/medcl/elasticsearch-analysis-pinyin/releases/download/v7.5.2/elasticsearch-analysis-pinyin-7.5.2.zip

<span class="c"># 2、解压分词器到ES的plugins目录下</span>
unzip elasticsearch-analysis-pinyin-7.5.2.zip <span class="nt">-d</span> /usr/local/elasticsearch-7.5.2/plugins/pinyin

<span class="c">#3、重启es,测试分词器</span>
GET /_analyze
<span class="o">{</span>
	<span class="s2">"text"</span>:<span class="s2">"艾编程"</span>,
	<span class="s2">"analyzer"</span>:<span class="s2">"pinyin"</span>
<span class="o">}</span>
<span class="c"># 需求场景：我们需要对一个字段既可以进行中文搜索，也可以进行拼音搜索</span>
<span class="c"># index的常规设置mapping</span>
<span class="c"># 一个字段可以给自己设置子字段来增加新的type和分词器</span>
<span class="c"># mapping可以后期修改的</span>
POST /index_customer/_mapping
<span class="o">{</span>
    <span class="s2">"properties"</span>: <span class="o">{</span>
        <span class="s2">"id"</span>: <span class="o">{</span>
            <span class="s2">"type"</span>: <span class="s2">"long"</span>
        <span class="o">}</span>,
        <span class="s2">"age"</span>: <span class="o">{</span>
            <span class="s2">"type"</span>: <span class="s2">"integer"</span>
        <span class="o">}</span>,
        <span class="s2">"username"</span>: <span class="o">{</span>
            <span class="s2">"type"</span>: <span class="s2">"keyword"</span>
        <span class="o">}</span>,
        <span class="s2">"nickname"</span>: <span class="o">{</span>
            <span class="s2">"type"</span>: <span class="s2">"text"</span>,
            <span class="s2">"analyzer"</span>: <span class="s2">"ik_max_word"</span>,
          	<span class="s2">"fields"</span>: <span class="o">{</span>
              <span class="s2">"pinyin"</span>: <span class="o">{</span>
                <span class="s2">"type"</span>: <span class="s2">"text"</span>,
                <span class="s2">"analyzer"</span>: <span class="s2">"pinyin"</span>
              <span class="o">}</span>,
              <span class="s2">"keyword"</span>:<span class="o">{</span>
                <span class="s2">"type"</span>:<span class="s2">"keyword"</span>,
                <span class="s2">"ignore_above"</span>: 256
              <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>,
        <span class="s2">"consume"</span>: <span class="o">{</span>
            <span class="s2">"type"</span>: <span class="s2">"float"</span>
        <span class="o">}</span>,
        <span class="s2">"desc"</span>: <span class="o">{</span>
            <span class="s2">"type"</span>: <span class="s2">"text"</span>,
            <span class="s2">"analyzer"</span>: <span class="s2">"ik_max_word"</span>
        <span class="o">}</span>,
        <span class="s2">"sex"</span>: <span class="o">{</span>
            <span class="s2">"type"</span>: <span class="s2">"byte"</span>
        <span class="o">}</span>,
        <span class="s2">"birthday"</span>: <span class="o">{</span>
            <span class="s2">"type"</span>: <span class="s2">"date"</span>
        <span class="o">}</span>,
      	<span class="s2">"city"</span>: <span class="o">{</span>
          	<span class="s2">"type"</span>: <span class="s2">"keyword"</span>
        <span class="o">}</span>,
        <span class="s2">"faceimg"</span>: <span class="o">{</span>
            <span class="s2">"type"</span>: <span class="s2">"text"</span>,
            <span class="s2">"index"</span>: <span class="nb">false</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c"># 搜索的时候同时支持中文，拼音</span>
GET /index_customer/_search
<span class="o">{</span>
	<span class="s2">"query"</span>:<span class="o">{</span>
		<span class="s2">"multi_match"</span>:<span class="o">{</span>
			<span class="s2">"query"</span>: <span class="s2">"chuanzhang"</span>,
			<span class="s2">"fields"</span>:[<span class="s2">"nickname"</span>,<span class="s2">"nickname.pinyin"</span><span class="o">]</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="c"># 在前端调用声明分词器</span>
GET /index_customer/_search
<span class="o">{</span>
    <span class="s2">"query"</span>: <span class="o">{</span>
        <span class="s2">"match"</span>: <span class="o">{</span>
            <span class="s2">"nickname"</span>: <span class="o">{</span>
                <span class="s2">"query"</span>: <span class="s2">"太阳"</span>,
                <span class="s2">"analyzer"</span>: <span class="s2">"ik_max_word"</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>看elasticsearch里安装成功的插件</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>esuser@helloworld elasticsearch-9200]<span class="nv">$ </span><span class="nb">cd </span>plugins/
<span class="o">[</span>esuser@helloworld plugins]<span class="nv">$ </span><span class="nb">ls
</span>ik  pinyin
</code></pre></div></div>

<h2 id="2深度分页问题分析与解决">2、深度分页问题分析与解决</h2>

<h3 id="什么是深度分页">什么是深度分页</h3>

<p>深度分页就是我们搜索的深浅度，比如第1页，第2页，第100页都是比较浅的，如果第1w页，第2w页这就比较深。</p>

<p>先看一下MySQL</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">im_order</span> <span class="k">limit</span> <span class="mi">100000</span><span class="p">,</span><span class="mi">30</span><span class="p">;</span>
</code></pre></div></div>

<p>这样就会非常慢，这就涉及深度分页，就会比较慢</p>

<p>慢的原因是什么：MySQL的limit m,n的工作原理是先读取符合where条件的m+n的记录，要把这些数据全拿到内存中，然后抛弃前m条，返回后面的n条，所以m越大，偏移量就越大，性能就越差，大部分ORM框架都是如此</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">im_order</span> <span class="k">where</span> <span class="n">id</span><span class="o">&gt;</span><span class="mi">100000</span> <span class="k">limit</span> <span class="mi">30</span><span class="p">;</span>
</code></pre></div></div>

<p>但前提是：</p>

<ul>
  <li>主键id一定要连续，否则数据就会出现不连贯的情况</li>
  <li>不好进行总页数的计算了，只能进行上一页和下一页的操作了</li>
  <li>进行这样的优化，需要记住上次的点位</li>
</ul>

<p><strong>解决方案</strong></p>

<p>上一页 1 2 3 4 5 6 7 8 9 10 下一页</p>

<h3 id="es如何处理深度分页">ES如何处理深度分页</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /index_customer/_search
<span class="o">{</span>
    <span class="s2">"query"</span>: <span class="o">{</span>
        <span class="s2">"match_all"</span>: <span class="o">{}</span>
    <span class="o">}</span>,
    <span class="s2">"from"</span>:0,
    <span class="s2">"size"</span>:12
<span class="o">}</span>
GET /index_customer/_search
<span class="o">{</span>
    <span class="s2">"query"</span>: <span class="o">{</span>
        <span class="s2">"match_all"</span>: <span class="o">{}</span>
    <span class="o">}</span>,
    <span class="s2">"from"</span>:9999,
    <span class="s2">"size"</span>:10
<span class="o">}</span>
<span class="c"># Result window is too large, from + size must be less than or equal to: [10000] but was [10009]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.</span>
</code></pre></div></div>

<p><strong>elasticsearch默认也不允许你查询10000条以后的数据</strong>，那么拿后面10条数据的流程如下：</p>

<ol>
  <li>
    <p>ES中每个分片存储不同的数据，所有分片总和是这个集群的完整数据</p>
  </li>
  <li>
    <p>去每个分片上都要拿10009条，然后集合在一起，如果3个分片：3*10009条数据，针对30027进行排序_score，最终取到你想要的10条</p>
  </li>
  <li>
    <p>因此ES默认不支持10000条以上的查询</p>
  </li>
</ol>

<p>如果恰巧你的数据就只有12000条</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 先看下这个属性</span>
GET /index_customer/_settings
<span class="c"># 修改深度</span>
PUT /index_customer/_settings
<span class="o">{</span>
	<span class="s2">"index.max_result_window"</span>: <span class="s2">"20000"</span>
<span class="o">}</span>
<span class="c"># 注意，这种方式救急可以，但不要拿来常用，这是缓兵之计</span>
</code></pre></div></div>

<h3 id="滚动搜索scroll">滚动搜索scroll</h3>

<p>介绍一个滚动搜索</p>

<ul>
  <li>scroll可以先查询出一些数据，然后依次往下查询</li>
  <li>在第一次查询的时候会有一个滚动id，这个id就是一个锚标记，每次都需要记录和使用这个锚标记</li>
  <li>每次搜索都是基于历史的数据快照，查询数据期间，如果数据有变更，快照数据不变</li>
</ul>

<p>如何使用</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 这个m就是滚动查询的上下文时间，m是分钟的意思</span>
<span class="c"># 这是第一次查询，第一次查询需要设置偏移量：size，就是页容量</span>
POST /index_customer/_search?scroll<span class="o">=</span>1m
<span class="o">{</span>
    <span class="s2">"query"</span>: <span class="o">{</span>
        <span class="s2">"match_all"</span>: <span class="o">{}</span>
    <span class="o">}</span>,
	<span class="s2">"sort"</span>: <span class="o">[</span><span class="s2">"_doc"</span><span class="o">]</span>,
	<span class="s2">"size"</span>: 3
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/elasticsearch/scroll-search.gif" alt="" /></p>

<p>第二次，第三次</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 第二次第三次滚动需要将每次返回的滚动id_scroll_id填入当次查询中，不用写查询条件</span>
<span class="c"># 不要写index名，直接写_search</span>
<span class="c"># 1m是滚动数据的过期时间，每次都要设置，单位是m分钟</span>
POST /_search/scroll
<span class="o">{</span>
	<span class="s2">"scroll"</span>: <span class="s2">"1m"</span>,
	<span class="s2">"scroll_id"</span>: <span class="s2">"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAABcWc2d3clU2QzRSMXFvVjIySHdzZmgzUQ=="</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>如果请求指定了聚合数据（aggregation），仅第一次数据才会包含聚合结果</strong></p>

<h3 id="最大打开scroll上下文数">最大打开scroll上下文数</h3>

<p>elasticsearch7.x 开始加上了软限制，<code class="highlighter-rouge">max_open_scroll_context</code>默认为500个，这个参数可以理解为数据库可用活跃连接数，虽然scroll id有一个存活时限，过期后会自动被清理，但在高并发情况下还是会有可能达到限制，从而报错</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Trying to create too many scroll contexts. Must be less than or equal to 500
</code></pre></div></div>

<p>可以发送请求来查看es集群的<code class="highlighter-rouge">open_context</code>使用情况</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET  _nodes/stats/indices/search
</code></pre></div></div>

<p>查询相关参数解析</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"indices"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"search"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"open_contexts"</span><span class="p">:</span><span class="w"> </span><span class="mi">344</span><span class="p">,</span><span class="w">					</span><span class="err">//正在打开的查询上下文个数</span><span class="w">     
        </span><span class="nl">"query_total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2040238734</span><span class="p">,</span><span class="w">				</span><span class="err">//查询出来的总数据条数</span><span class="w"> 
        </span><span class="nl">"query_time_in_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">123880939</span><span class="p">,</span><span class="w">		 </span><span class="err">//查询阶段所耗费的时间</span><span class="w">  
        </span><span class="nl">"query_current"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">						</span><span class="err">//当前正在查询个数</span><span class="w"> 
        </span><span class="nl">"fetch_total"</span><span class="p">:</span><span class="w"> </span><span class="mi">956587</span><span class="p">,</span><span class="w">					</span><span class="err">//</span><span class="w"> 
        </span><span class="nl">"fetch_time_in_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">305711</span><span class="p">,</span><span class="w">			</span><span class="err">//Fetch阶段总耗时时间</span><span class="w"> 
        </span><span class="nl">"fetch_current"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"scroll_total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1804431262</span><span class="p">,</span><span class="w">				</span><span class="err">//通过scroll</span><span class="w"> </span><span class="err">api查询数据总条数</span><span class="w">
        </span><span class="nl">"scroll_time_in_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">16431383028</span><span class="p">,</span><span class="w">	</span><span class="err">//通过scroll</span><span class="w"> </span><span class="err">api总耗时时间</span><span class="w">
        </span><span class="nl">"scroll_current"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">				</span><span class="err">//当前滚动API调用次</span><span class="w">
        </span><span class="nl">"suggest_total"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"suggest_time_in_millis"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="err">//suggest总耗费时间</span><span class="w">    
        </span><span class="nl">"suggest_current"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">		</span><span class="err">//正在执行suggest</span><span class="w"> </span><span class="err">api的个数</span><span class="w"> 
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>报错的解决办法，调大打开查询上下文个数：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">curl</span><span class="w"> </span><span class="err">-X</span><span class="w"> </span><span class="err">PUT</span><span class="w"> </span><span class="err">http://ip:</span><span class="mi">9200</span><span class="err">/_cluster/settings</span><span class="w"> </span><span class="err">-H</span><span class="w"> </span><span class="err">'Content-Type:</span><span class="w"> </span><span class="err">application/json'</span><span class="w"> </span><span class="err">-d'</span><span class="p">{</span><span class="w">
    </span><span class="nl">"persistent"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"search.max_open_scroll_context"</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"transient"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"search.max_open_scroll_context"</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>使用查询后，手动清除scroll id</p>

<p>ES 7.15后，官方建议java客户端使用 transportClient</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//清除游标</span>
<span class="k">if</span> <span class="o">(</span><span class="n">searchResponse</span><span class="o">.</span><span class="na">getScrollId</span><span class="o">()!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">searchResponse</span><span class="o">.</span><span class="na">getScrollId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">)){</span>
    <span class="nc">ClearScrollRequest</span> <span class="n">clearScrollRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClearScrollRequest</span><span class="o">();</span>
    <span class="n">clearScrollRequest</span><span class="o">.</span><span class="na">addScrollId</span><span class="o">(</span><span class="n">searchResponse</span><span class="o">.</span><span class="na">getScrollId</span><span class="o">());</span>
    <span class="nc">ActionFuture</span><span class="o">&lt;</span><span class="nc">ClearScrollResponse</span><span class="o">&gt;</span> <span class="n">actionFuture</span> <span class="o">=</span>  <span class="n">transportClient</span><span class="o">.</span><span class="na">clearScroll</span><span class="o">(</span><span class="n">clearScrollRequest</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">actionFuture</span><span class="o">.</span><span class="na">actionGet</span><span class="o">().</span><span class="na">isSucceeded</span><span class="o">()){</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">actionFuture</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>我习惯使用restHighLevelClient</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">searchResponse</span><span class="o">.</span><span class="na">getScrollId</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">searchResponse</span><span class="o">.</span><span class="na">getScrollId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">)){</span>
    <span class="nc">ClearScrollRequest</span> <span class="n">clearScrollRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClearScrollRequest</span><span class="o">();</span>
    <span class="n">clearScrollRequest</span><span class="o">.</span><span class="na">addScrollId</span><span class="o">(</span><span class="n">searchResponse</span><span class="o">.</span><span class="na">getScrollId</span><span class="o">());</span>
    <span class="nc">ClearScrollResponse</span> <span class="n">clearScrollResponse</span> <span class="o">=</span> <span class="n">restHighLevelClient</span><span class="o">.</span><span class="na">clearScroll</span><span class="o">(</span><span class="n">clearScrollRequest</span><span class="o">,</span><span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">clearScrollResponse</span><span class="o">.</span><span class="na">isSucceeded</span><span class="o">()){</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">clearScrollResponse</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>查询时，每次返回的游标都是一样的，所以只需要最后删除一次就可以</p>

<h2 id="3批量文档操作">3、批量文档操作</h2>

<h3 id="批量查询doc">批量查询doc</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 只查一个</span>
GET /index_customer/_doc/1001

<span class="c"># 通过DSL可以进行批量查询</span>
POST /index_customer/_search
<span class="o">{</span>
	<span class="s2">"query"</span>:<span class="o">{</span>
		<span class="s2">"ids"</span>:<span class="o">{</span>
			<span class="s2">"type"</span>:<span class="s2">"_doc"</span>,
			<span class="s2">"values"</span>:[<span class="s2">"1001"</span>,<span class="s2">"1009"</span>,<span class="s2">"1010"</span><span class="o">]</span>
		<span class="o">}</span>
	<span class="o">}</span>,
	<span class="s2">"_source"</span>:[<span class="s2">"id"</span>,<span class="s2">"username"</span>,<span class="s2">"nickname"</span>,<span class="s2">"desc"</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用_mget来进行查询</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /index_customer/_doc/_mget
<span class="o">{</span>
    <span class="s2">"ids"</span>: <span class="o">[</span><span class="s2">"1001"</span>,<span class="s2">"1009"</span>,<span class="s2">"1010"</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="批量操作bulk">批量操作bulk</h3>

<p><strong>基本语法</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span> action: <span class="o">{</span> metadata<span class="o">}}</span><span class="se">\n</span>
<span class="o">{</span> request body       <span class="o">}</span><span class="se">\n</span>
<span class="o">{</span> action: <span class="o">{</span> metadata<span class="o">}}</span><span class="se">\n</span>
<span class="o">{</span> request body       <span class="o">}</span><span class="se">\n</span>
<span class="o">{</span> action: <span class="o">{</span> metadata<span class="o">}}</span><span class="se">\n</span>
<span class="o">{</span> request body       <span class="o">}</span><span class="se">\n</span>
...
</code></pre></div></div>

<ul>
  <li>{ action: { metadata}}：代表批量操作的类型，可以新增，删除，修改</li>
  <li>\n：每行必须是回车换行，不要用json解析器来格式</li>
  <li>{ request body       }：就是你的具体doc数据</li>
  <li>post提交的content-type是application/json</li>
</ul>

<p><strong>批量操作的类型</strong></p>

<p>action必须是以下选项之一</p>

<ul>
  <li>create：文档不存在则创建，存在则报错，但发生异常不会影响其他行的数据导入</li>
  <li>index：文档不存在则创建，存在则覆盖</li>
  <li>update：部分更新一个文档</li>
  <li>delete：批量删除</li>
</ul>

<blockquote>
  <p>create/index操作</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 不用加索引名，直接在路径里写_bulk</span>
POST /_bulk
<span class="o">{</span><span class="s2">"create"</span>:<span class="o">{</span><span class="s2">"_index"</span>:<span class="s2">"index_customer"</span>,<span class="s2">"_type"</span>:<span class="s2">"_doc"</span>,<span class="s2">"_id"</span>:<span class="s2">"1013"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"id"</span>:1013,<span class="s2">"age"</span>:30,<span class="s2">"username"</span>:<span class="s2">"wangge"</span>,<span class="s2">"nickname"</span>:<span class="s2">"大哥就是棒"</span>,<span class="s2">"consume"</span>:16899.99,<span class="s2">"desc"</span>:<span class="s2">"就喜欢研究技术，非常喜欢和大家交流"</span>,<span class="s2">"sex"</span>:1,<span class="s2">"birthday"</span>:<span class="s2">"1990-10-22"</span>,<span class="s2">"city"</span>:<span class="s2">"杭州"</span>,<span class="s2">"faceimg"</span>:<span class="s2">"https://www.icodingedu.com/img/customers/1013/logo.png"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"create"</span>:<span class="o">{</span><span class="s2">"_index"</span>:<span class="s2">"index_customer"</span>,<span class="s2">"_type"</span>:<span class="s2">"_doc"</span>,<span class="s2">"_id"</span>:<span class="s2">"1014"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"id"</span>:1014,<span class="s2">"age"</span>:28,<span class="s2">"username"</span>:<span class="s2">"lichangming"</span>,<span class="s2">"nickname"</span>:<span class="s2">"永远光明"</span>,<span class="s2">"consume"</span>:14899.99,<span class="s2">"desc"</span>:<span class="s2">"非常喜欢和大家交流Java技术和架构心得"</span>,<span class="s2">"sex"</span>:1,<span class="s2">"birthday"</span>:<span class="s2">"1992-09-22"</span>,<span class="s2">"city"</span>:<span class="s2">"北京"</span>,<span class="s2">"faceimg"</span>:<span class="s2">"https://www.icodingedu.com/img/customers/1014/logo.png"</span><span class="o">}</span>

<span class="c"># 注意最后一行也必须有回车</span>
POST /_bulk
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_index"</span>:<span class="s2">"index_customer"</span>,<span class="s2">"_type"</span>:<span class="s2">"_doc"</span>,<span class="s2">"_id"</span>:<span class="s2">"1013"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"id"</span>:1013,<span class="s2">"age"</span>:30,<span class="s2">"username"</span>:<span class="s2">"wangge"</span>,<span class="s2">"nickname"</span>:<span class="s2">"大哥就是棒"</span>,<span class="s2">"consume"</span>:16899.99,<span class="s2">"desc"</span>:<span class="s2">"就喜欢研究技术，非常喜欢和大家交流"</span>,<span class="s2">"sex"</span>:1,<span class="s2">"birthday"</span>:<span class="s2">"1990-10-22"</span>,<span class="s2">"city"</span>:<span class="s2">"杭州"</span>,<span class="s2">"faceimg"</span>:<span class="s2">"https://www.icodingedu.com/img/customers/1013/logo.png"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_index"</span>:<span class="s2">"index_customer"</span>,<span class="s2">"_type"</span>:<span class="s2">"_doc"</span>,<span class="s2">"_id"</span>:<span class="s2">"1014"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"id"</span>:1014,<span class="s2">"age"</span>:28,<span class="s2">"username"</span>:<span class="s2">"lichangming"</span>,<span class="s2">"nickname"</span>:<span class="s2">"永远光明"</span>,<span class="s2">"consume"</span>:14899.99,<span class="s2">"desc"</span>:<span class="s2">"非常喜欢和大家交流Java技术和架构心得"</span>,<span class="s2">"sex"</span>:1,<span class="s2">"birthday"</span>:<span class="s2">"1992-09-22"</span>,<span class="s2">"city"</span>:<span class="s2">"北京"</span>,<span class="s2">"faceimg"</span>:<span class="s2">"https://www.icodingedu.com/img/customers/1014/logo.png"</span><span class="o">}</span>

</code></pre></div></div>

<p>也可以在index资源路径下来进行操作</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># doc类型可以去掉 POST /index_customer/_doc/_bulk</span>
POST /index_customer/_bulk
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"1013"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"id"</span>:1013,<span class="s2">"age"</span>:30,<span class="s2">"username"</span>:<span class="s2">"wangge"</span>,<span class="s2">"nickname"</span>:<span class="s2">"大哥就是棒"</span>,<span class="s2">"consume"</span>:16899.99,<span class="s2">"desc"</span>:<span class="s2">"就喜欢研究技术，非常喜欢和大家交流"</span>,<span class="s2">"sex"</span>:1,<span class="s2">"birthday"</span>:<span class="s2">"1990-10-22"</span>,<span class="s2">"city"</span>:<span class="s2">"杭州"</span>,<span class="s2">"faceimg"</span>:<span class="s2">"https://www.icodingedu.com/img/customers/1013/logo.png"</span><span class="o">}</span>
<span class="o">{</span><span class="s2">"index"</span>:<span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"1014"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"id"</span>:1014,<span class="s2">"age"</span>:28,<span class="s2">"username"</span>:<span class="s2">"lichangming"</span>,<span class="s2">"nickname"</span>:<span class="s2">"永远光明"</span>,<span class="s2">"consume"</span>:14899.99,<span class="s2">"desc"</span>:<span class="s2">"非常喜欢和大家交流Java技术和架构心得"</span>,<span class="s2">"sex"</span>:1,<span class="s2">"birthday"</span>:<span class="s2">"1992-09-22"</span>,<span class="s2">"city"</span>:<span class="s2">"北京"</span>,<span class="s2">"faceimg"</span>:<span class="s2">"https://www.icodingedu.com/img/customers/1014/logo.png"</span><span class="o">}</span>

<span class="c"># 注意最后一行也必须有回车</span>
</code></pre></div></div>

<blockquote>
  <p>update/delete操作</p>
</blockquote>

<p>批量更新</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /index_customer/_doc/_bulk
<span class="o">{</span><span class="s2">"update"</span>:<span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"1013"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"doc"</span>:<span class="o">{</span><span class="s2">"nickname"</span>:<span class="s2">"一只花骨朵"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"update"</span>:<span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"1014"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"doc"</span>:<span class="o">{</span><span class="s2">"desc"</span>:<span class="s2">"对架构师课程感兴趣，所以报名艾编程学习"</span><span class="o">}}</span>

<span class="c"># 注意最后一行也必须有回车</span>
</code></pre></div></div>

<p>批量删除</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /index_customer/_doc/_bulk
<span class="o">{</span><span class="s2">"delete"</span>:<span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"1013"</span><span class="o">}}</span>
<span class="o">{</span><span class="s2">"delete"</span>:<span class="o">{</span><span class="s2">"_id"</span>:<span class="s2">"1014"</span><span class="o">}}</span>

<span class="c"># 注意最后一行也必须有回车</span>
</code></pre></div></div>

<p><strong>所有批量的操作：create、index、update、delete都可以放在一起执行</strong></p>

<p>需要注意的点</p>

<ul>
  <li>
    <p>由于批量操作是加载到内存中的，如果值比较多，会比较慢</p>
  </li>
  <li>
    <p>所有操作在一起只需符合语法规则，内容可以多样</p>
  </li>
</ul>

<h2 id="4elasticsearch集群构建">4、Elasticsearch集群构建</h2>

<h3 id="分片原理分析">分片原理分析</h3>

<p>分布式搜索引擎，如果是单机，那既不能HA，也不能实现分布式</p>

<ul>
  <li>HA</li>
  <li>海量数据的水平扩展</li>
  <li>高并发访问</li>
</ul>

<p><strong>分片机制</strong></p>

<ul>
  <li>
    <p>通俗来讲就是一个放数据的盒子</p>
  </li>
  <li>每个索引都会被分片</li>
  <li>创建索引的时候会要求制定主分片和副本分片的数量，索引创建后，主分片数不能修改，除非reindex重建索引，副本分片则可以随意修改</li>
</ul>

<p><strong>分片的逻辑</strong></p>

<ul>
  <li>副本分片不允许和主分片在同一个机器上</li>
  <li>主分片挂了，还有副本分片来进行数据访问</li>
  <li>所以单机的时候，副本分片不会指定机器，是灰色不可用的</li>
</ul>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-index-shards.png" alt="" /></p>

<h3 id="集群搭建">集群搭建</h3>

<p>在elasticsearch.yml里进行配置</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># elasticsearch.yml</span>
<span class="c"># 1、集群名称，每个集群的机器如果要加入同一个集群，这个名字必须一样</span>
cluster.name: icoding-es
<span class="c"># 节点名，这个必须都不一样</span>
node.name: es-node-1
path.data: /usr/local/elasticsearch/esdata	<span class="c"># 数据路径</span>
path.logs: /usr/local/elasticsearch/eslogs	<span class="c"># 日志路径</span>
http.port: 9200
transport.tcp.port: 9300
<span class="c"># 2、主节点，设置后在主节点挂掉后有机会升级为master</span>
node.master: <span class="nb">true</span>
<span class="c"># 数据节点</span>
node.data: <span class="nb">true</span>
<span class="c"># 3、配置ip和域名，配置后ES会通过9300-9305的端口进行数据连接,不配置端口，默认就是9300</span>
discovery.seed_hosts: <span class="o">[</span><span class="s2">"192.168.0.146"</span>, <span class="s2">"192.168.0.147"</span>, <span class="s2">"192.168.0.148"</span><span class="o">]</span>
<span class="c"># 集群初始化设置的master节点</span>
cluster.initial_master_nodes: <span class="o">[</span><span class="s2">"es-node-1"</span><span class="o">]</span>
<span class="c"># 4、允许跨域</span>
http.cors.enabled: <span class="nb">true
</span>http.cors.allow-origin: <span class="s2">"*"</span>

<span class="c"># 注意不同局域网的服务器搭建ES集群，需要修改以下参数</span>
<span class="c"># 建议线上要在局域网内搭建ES集群，基于安全和数据传输的考虑</span>
<span class="c"># 参考：https://www.jianshu.com/p/a78b9eba0934</span>
<span class="c"># 自己尝试在腾讯云、阿里云服务器上搭建ES集群失败，节点间无法通信</span>
<span class="c"># 可以在一台服务器上开启多个ES实例构建成集群，只需要修改http和tcp的端口，如 es-node-1: 9200/9300，es-node-2: 9201/9301,</span>
<span class="c"># es-node-3: 9202/9302</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster1.png" alt="" />星：代表主节点</p>

<p>圆圈：代表从节点</p>

<h3 id="集群配置用户密码访问">集群配置用户密码访问</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 三个es节点关闭es服务</span>
<span class="c"># 进入es的bin目录</span>
<span class="c"># 1、为集群创建认证机构，依次输入回车（文件使用默认名），密码</span>
<span class="o">[</span>esuser@helloworld bin]<span class="nv">$ </span>./elasticsearch-certutil ca
Please enter the desired output file <span class="o">[</span>elastic-stack-ca.p12]: 
Enter password <span class="k">for </span>elastic-stack-ca.p12 :

<span class="c"># 2、为节点颁发证书,回车（文件使用默认名），密码与步骤1的密码相同</span>
<span class="c"># 2.1</span>
<span class="o">[</span>esuser@helloworld bin]<span class="nv">$ </span>./elasticsearch-certutil cert <span class="nt">--ca</span> elastic-stack-ca.p12
Enter password <span class="k">for </span>CA <span class="o">(</span>elastic-stack-ca.p12<span class="o">)</span> : 
Please enter the desired output file <span class="o">[</span>elastic-certificates.p12]: 
Enter password <span class="k">for </span>elastic-certificates.p12 : 
Certificates written to /home/esuser/elasticsearch-9200/elastic-certificates.p12
<span class="c"># 2.2 回车（文件使用默认名），密码与步骤1的密码相同</span>
<span class="o">[</span>esuser@helloworld bin]<span class="nv">$ </span>./elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
Enter value <span class="k">for </span>xpack.security.transport.ssl.keystore.secure_password: 
<span class="c"># 2.3 回车（文件使用默认名），密码与步骤1的密码相同</span>
<span class="o">[</span>esuser@helloworld bin]<span class="nv">$ </span>./elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password
Enter value <span class="k">for </span>xpack.security.transport.ssl.truststore.secure_password: 
</code></pre></div></div>

<p><strong>3、多节点配置</strong></p>

<p>将生成的elastic-certificates.p12、elastic-stack-ca.p12文件mv到config目录下，并连同elasticsearch.keystore 文件 scp到其他节点的config目录中。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp elastic-certificates.p12 elasticsearch.keystore elastic-stack-ca.p12 root@192.168.1.100:/home/wes/elasticsearch-7.6.1/config/ 
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-config-password.jpg" alt="" /></p>

<p>我这里搭建的单机三个节点的伪集群，使用cp命令复制就行</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>esuser@helloworld config]<span class="nv">$ </span><span class="nb">cp </span>elastic-certificates.p12 elasticsearch.keystore elastic-stack-ca.p12 /home/esuser/elasticsearch-9201/config/
<span class="o">[</span>esuser@helloworld config]<span class="nv">$ </span><span class="nb">cp </span>elastic-certificates.p12 elasticsearch.keystore elastic-stack-ca.p12 /home/esuser/elasticsearch-9202/config/
</code></pre></div></div>

<p><strong>4、开启证书访问</strong></p>

<p>修改三个节点的配置文件elasticsearch.yml，添加下面内容</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># --------------------------------- Security -----------------------------------</span>
xpack.security.enabled: <span class="nb">true
</span>xpack.security.transport.ssl.enabled: <span class="nb">true
</span>xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: elastic-certificates.p12
http.cors.allow-headers: Authorization,Content-Type  <span class="c"># es-header连接需要配置这个</span>
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-config-password-3.jpg" alt="" /></p>

<p>重启3个节点的es服务</p>

<p><strong>5、密码设置</strong></p>

<p>待节点启动完毕之后，进入第一个节点elasticsearch目录，执行以下命令，进行密码设置：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>esuser@helloworld elasticsearch-9200]<span class="nv">$ </span>./bin/elasticsearch-setup-passwords interactive
</code></pre></div></div>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-config-password-4.jpg" alt="" /></p>

<p><strong>6、访问测试</strong></p>

<p>访问任意一个节点都需要输入elastic的密码</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-config-password-5.jpg" alt="" /></p>

<p><strong>elasticsearch-head访问es集群的用户及密码</strong></p>

<p>url+认证信息方式访问es集群</p>

<p>http://localhost:9100/?auth_user=elastic&amp;auth_password=elastic666</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-config-password-6.jpg" alt="" /></p>

<p><strong>logstash增加访问es集群的用户及密码</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>output <span class="o">{</span>

  <span class="k">if</span> <span class="o">[</span>fields][log_source] <span class="o">==</span> <span class="s1">'messages'</span> <span class="o">{</span>
    elasticsearch <span class="o">{</span>
      hosts <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"http://192.168.80.104:9200"</span>, <span class="s2">"http://192.168.80.105:9200"</span>,<span class="s2">"http://192.168.80.106:9200"</span><span class="o">]</span>
      index <span class="o">=&gt;</span> <span class="s2">"messages-%{+YYYY.MM.dd}"</span>
      user <span class="o">=&gt;</span> <span class="s2">"elastic"</span> <span class="c"># 账号是默认的</span>
      password <span class="o">=&gt;</span> <span class="s2">"elkstack123456"</span> <span class="c"># 密码是上面步骤设置的</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">[</span>fields][log_source] <span class="o">==</span> <span class="s2">"secure"</span> <span class="o">{</span>
    elasticsearch <span class="o">{</span>
      hosts <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"http://192.168.80.104:9200"</span>, <span class="s2">"http://192.168.80.105:9200"</span>,<span class="s2">"http://192.168.80.106:9200"</span><span class="o">]</span>
      index <span class="o">=&gt;</span> <span class="s2">"secure-%{+YYYY.MM.dd}"</span>
      user <span class="o">=&gt;</span> <span class="s2">"elastic"</span>
      password <span class="o">=&gt;</span> <span class="s2">"elkstack123456"</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>kibana组件访问es集群</strong></p>

<p>有两种方法</p>

<ul>
  <li>
    <p>方法1:</p>

    <p>配置文件kibana.yml中需要加入用户密码，明文的密码</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>elasticsearch.username: <span class="s2">"elastic"</span>
elasticsearch.password: <span class="s2">"elastic123456"</span>
</code></pre></div>    </div>

    <p>然后重启kibana服务，再次访问的话就需要输入上述账号密码才能登陆访问了</p>
  </li>
  <li>
    <p>方法2:</p>

    <p>通过keystore配置es的加密用户名和密码进行访问</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>esuser@helloworld kibana-7.6.1]<span class="nv">$ </span><span class="nb">cd </span>bin
<span class="c"># 1、创建keystore</span>
<span class="o">[</span>esuser@helloworld bin]<span class="nv">$ </span>./kibana-keystore create
Created Kibana keystore <span class="k">in</span> /home/esuser/kibana-7.6.1/data/kibana.keystore
  
<span class="c"># 2、设置kibana访问es的用户名</span>
<span class="o">[</span>esuser@helloworld bin]<span class="nv">$ </span>./kibana-keystore add elasticsearch.username
Enter value <span class="k">for </span>elasticsearch.username: <span class="k">*******</span>  <span class="c"># 输入用户名 elastic</span>
  
<span class="c"># 3、设置kibana访问es的密码</span>
<span class="o">[</span>esuser@helloworld bin]<span class="nv">$ </span>./kibana-keystore add elasticsearch.password
Enter value <span class="k">for </span>elasticsearch.password: <span class="k">**********</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="节点宕机测试-分片容灾的机制">节点宕机测试-分片容灾的机制</h3>

<p>集群所有Node都启动的状态</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-nodes-start-all.png" alt="" /></p>

<p>我要kill掉es-node-1，es-node-2和es-node-3上的副本分片就升级为主分片</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-nodes-kill-one.png" alt="" /></p>

<p>过了一会，刚升级的主分片复制出副本分片</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-nodes-kill-one-after.png" alt="" /></p>

<p>启动刚刚kill掉的es-node-1，数据还没有复制过来</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-nodes-start-new-one.png" alt="" /></p>

<p>过了一会数据进行了移动，通过9300内部通信端口进行数据的传输的</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/cluster-nodes-start-new-one-after.png" alt="" /></p>

<h3 id="脑裂问题分析">脑裂问题分析</h3>

<p>集群中有一个master节点：相当于一个管理节点</p>

<p>Node：elasticsearch的服务节点，安装ES的机器（主，从）</p>

<p>Index：是我们数据的一个逻辑集合，他拥有数据的结构，以及提前做好的分词内容，主要用来搜索的的对象</p>

<p>Shard：物理分片，进行数据的实际物理存储和管理的地方（主分片数不能修改，但副本分片可以增加）</p>

<p><img src="/assets/images/2020/icoding/elasticsearch/es-two-master.png" alt="" /></p>

<p>当原来的Master因为网络问题无法和其他slave链接，就出现了其他slave选举出新的master的情况</p>

<ul>
  <li>只要最小投票人数1个就能把节点投为master</li>
  <li>由于和其他节点连接不上，这个节点就把自己投成master</li>
</ul>

<p><strong>脑裂的解决方案</strong></p>

<p>master主节点应该要经过多个有资格成为master（node.master=true）的节点选举后才能成为新的节点，不是你一个人自己选自己就能决定</p>

<ul>
  <li>
    <p>discovery.zen.minimum_master_nodes=(N/2)+1</p>

    <ul>
      <li>N就是有资格成为master的节点数</li>
      <li>这个值默认是1</li>
      <li>在ES7.x以前是这样的</li>
    </ul>
  </li>
  <li>
    <p>在ES7.x版本中，这个参数已经被移除了，这块的内容完全由ES自身做管理，避免了多个脑裂的情况，选举也非常快</p>
  </li>
</ul>

<h3 id="文档读写原理">文档读写原理</h3>

<blockquote>
  <p>写原理</p>
</blockquote>

<p><img src="/assets/images/2020/icoding/elasticsearch/elastisearch-nodes-write.png" alt="image-20200220203755592" /></p>

<ul>
  <li>客户端连接的时候，首先要连接一个协调节点coordinating node 发送请求</li>
  <li>协调节点会根据客户端写入的数据来hash判断是写入P0还是P1，P2，只要主分片才能写入数据</li>
  <li>如果hash后写入到P2分片，会由协调节点来路由转发数据到P2分片</li>
  <li>P2分片数据写入完成后会同步到R2副本分片，会将完成写入的响应返回到协调节点</li>
  <li>协调节点收到完成操作后返回给客户端，完成了这次写入的操作了</li>
  <li>客户端每次连接的协调节点coordinating node 都可能会变，也就是每个node都会充当协调节点的角色</li>
</ul>

<p><img src="\assets\images\2020\icoding\elasticsearch\elastisearch-nodes-write-2.png" alt="" /></p>

<blockquote>
  <p>读原理</p>
</blockquote>

<ul>
  <li>客户端读请求会先选择一个协调节点coordinate  node</li>
  <li>由协调节点根据数据的请求hash得知是放在哪个分片上的</li>
  <li>由于数据在主副本分片上都有，并且数据一模一样，读取操作在主分片和副本分片上是采用轮询的方式，读负载</li>
  <li>因此副本分片多了后会提升分片的负载能力</li>
  <li>数据查询完毕后返回document给协调节点，协调节点返回客户端</li>
</ul>

<blockquote>
  <p>搜索过程原理</p>
</blockquote>

<p>es 最强大的是做全文检索，就是比如你有三条数据：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java真好玩儿啊
java好难学啊
j2ee特别牛Copy to clipboardErrorCopied
</code></pre></div></div>

<p>你根据 <code class="highlighter-rouge">java</code> 关键词来搜索，将包含 <code class="highlighter-rouge">java</code> 的 <code class="highlighter-rouge">document</code> 给搜索出来。es 就会给你返回：java真好玩儿啊，java好难学啊。过程原理：</p>

<ul>
  <li>客户端发送请求到一个 协调节点<code class="highlighter-rouge">coordinate node</code> 。</li>
  <li>协调节点将搜索请求转发到索引所在的shard （<code class="highlighter-rouge">primary shard</code> 或 <code class="highlighter-rouge">replica shard</code>，采取轮询的方式）。</li>
  <li>query phase（查询阶段）：每个 shard 分片 将自己的搜索结果（其实就是一些 <code class="highlighter-rouge">doc id</code> ）返回给协调节点，由协调节点进行数据的合并、排序、分页等操作，产出最终结果。</li>
  <li>fetch phase（拿阶段）：接着由协调节点根据 <code class="highlighter-rouge">doc id</code> 去各个节点上<strong>拉取实际</strong>的 <code class="highlighter-rouge">document</code> 数据，最终返回给客户端。</li>
</ul>

<blockquote>
  <p>写的底层原理研究</p>
</blockquote>

<p><img src="\assets\images\2020\icoding\elasticsearch\elastisearch-nodes-write-3.png" alt="" /></p>

<ul>
  <li>先写入内存 buffer，在 buffer 里的时候数据是搜索不到的；同时将数据写入 translog 日志文件。</li>
  <li>如果 buffer 快满了，或者到一定时间，就会将内存 buffer 数据 <code class="highlighter-rouge">refresh</code> 到一个新的 <code class="highlighter-rouge">segment file</code> 中，但是此时数据不是直接进入 <code class="highlighter-rouge">segment file</code> 磁盘文件，而是先进入 <code class="highlighter-rouge">os cache</code> 。这个过程就是 <code class="highlighter-rouge">refresh</code> ，有点类似kafka的<strong>Page Cache（页面缓存）</strong>，其实就是OS的核心缓冲区。</li>
  <li>每隔 1 秒钟，es 将 buffer 中的数据写入一个<strong>新的</strong> <code class="highlighter-rouge">segment file</code>（ buffer先refresh到os cache，再由os cache 刷到 segment file） ，每秒钟会产生一个<strong>新的磁盘文件</strong> <code class="highlighter-rouge">segment file</code> ，这个 <code class="highlighter-rouge">segment file</code> 中就存储最近 1 秒内 buffer 中写入的数据。</li>
  <li>操作系统里面，磁盘文件其实都有一个东西，叫做 <code class="highlighter-rouge">os cache</code> ，即操作系统缓存，就是说数据写入磁盘文件之前，会先进入 <code class="highlighter-rouge">os cache</code> ，先进入操作系统级别的一个内存缓存中去。只要 <code class="highlighter-rouge">buffer</code> 中的数据被 refresh 操作刷入 <code class="highlighter-rouge">os cache</code> 中，这个数据就可以被搜索到了。</li>
  <li>为什么叫es是nrt（ <code class="highlighter-rouge">near real-time</code> 准实时），就是因为他的每1秒钟refresh一次数据。可以通过 es 的 <code class="highlighter-rouge">restful api</code> 或者 <code class="highlighter-rouge">java api</code> ，<strong>手动</strong>执行一次 refresh 操作，就是手动将 buffer 中的数据刷入 <code class="highlighter-rouge">os cache</code> 中，让数据立马就可以被搜索到。只要数据被输入 <code class="highlighter-rouge">os cache</code> 中，buffer 就会被清空了，因为不需要保留 buffer 了，数据在 translog 里面已经持久化到磁盘去一份了(每5秒触发一次将os cache的写入操作记录到translog日志文件)。translog 日志文件的作用是什么？你执行 commit 操作之前，数据要么是停留在 buffer 中，要么是停留在 os cache 中，无论是 buffer 还是 os cache 都是内存，一旦这台机器死了，内存中的数据就全丢了。所以需要将数据对应的操作写入一个专门的日志文件 <code class="highlighter-rouge">translog</code> 中，一旦此时机器宕机，再次重启的时候，es 会自动读取 translog 日志文件中的数据，恢复到内存 buffer 和 os cache 中去。但每5秒触发一次，机器宕机会有5秒的数据丢失。</li>
  <li>
    <p>重复上面的步骤，新的数据不断进入 buffer 和 translog，不断将 <code class="highlighter-rouge">buffer</code> 数据写入一个又一个新的 <code class="highlighter-rouge">segment file</code> 中去，每次 <code class="highlighter-rouge">refresh</code> 完 buffer 清空，translog 保留。随着这个过程推进，translog 会变得越来越大。当 translog 达到一定长度的时候，就会触发 <code class="highlighter-rouge">commit</code> 操作。</p>
  </li>
  <li>
    <p>commit 操作发生第一步，就是将 buffer 中现有数据 <code class="highlighter-rouge">refresh</code> 到 <code class="highlighter-rouge">os cache</code> 中去，清空 buffer。然后，将一个 <code class="highlighter-rouge">commit point</code> 写入磁盘文件，里面标识着这个 <code class="highlighter-rouge">commit point</code> 对应的所有 <code class="highlighter-rouge">segment file</code> ，同时强行将 <code class="highlighter-rouge">os cache</code> 中目前所有的数据都 <code class="highlighter-rouge">fsync</code> 到 <code class="highlighter-rouge">segment file</code> 磁盘文件中去。最后<strong>清空</strong>现有 translog 日志文件，重启一个 translog，此时 commit 操作完成。</p>

    <p>这个 commit 操作叫做 <code class="highlighter-rouge">flush</code> 。默认 30 分钟自动执行一次 <code class="highlighter-rouge">flush</code> ，但如果 translog 过大，也会触发 <code class="highlighter-rouge">flush</code> 。flush 操作就对应着 commit 的全过程，我们可以通过 es api，手动执行 flush 操作，手动将 os cache （translog os cache、segment file os cache）中的数据 fsync 强刷到磁盘上去。</p>
  </li>
</ul>

<p><strong>总结：</strong></p>

<ul>
  <li>es 第一是准实时的，数据写入 1 秒后可以搜索到；可能会丢失数据的。有 5 秒的数据，停留在 buffer、translog os cache、segment file os cache 中，而不在磁盘上，此时如果宕机，会导致 5 秒的<strong>数据丢失</strong>。</li>
  <li>数据先写入内存 buffer，然后每隔 1s，将数据 refresh 到 os cache，到了 os cache 数据就能被搜索到（所以我们才说 es 从写入到能被搜索到，中间有 1s 的延迟）。每隔 5s，将数据写入 translog 文件（这样如果机器宕机，内存数据全没，最多会有 5s 的数据丢失），translog 大到一定程度，或者默认每隔 30mins，会触发 commit 操作，将缓冲区(buffer、translog os cache、segment file os cache )的数据都 flush 到 segment file 磁盘文件中。就是说30分钟才将translog文件的数据写到segment file 磁盘文件中，清空现有translog文件</li>
</ul>

<p><mark>注意：数据写入 segment file 之后，同时就建立好了倒排索引。前面文章内容有讲到</mark></p>

<blockquote>
  <p>删除、更新数据的底层原理</p>
</blockquote>

<p>如果是删除操作，commit 的时候会生成一个 <code class="highlighter-rouge">.del</code> 文件，里面将某个 doc 标识为 <code class="highlighter-rouge">deleted</code> 状态，那么搜索的时候根据 <code class="highlighter-rouge">.del</code> 文件就知道这个 doc 是否被删除了。</p>

<p>如果是更新操作，就是将原来的 doc 标识为 <code class="highlighter-rouge">deleted</code> 状态，然后新写入一条数据。所以update其实底层就是删除。</p>

<p>buffer 每 refresh 一次，就会产生一个 <code class="highlighter-rouge">segment file</code> （其实数据是在 segment file 的os cache 中，并不在 segment file 磁盘文件中），所以默认情况下是 1 秒钟一个 <code class="highlighter-rouge">segment file</code> ，这样下来 <code class="highlighter-rouge">segment file</code> 会越来越多，此时会定期执行 merge。每次 merge 的时候，会将多个 <code class="highlighter-rouge">segment file</code> 合并成一个，同时这里会将标识为 <code class="highlighter-rouge">deleted</code> 的 doc 给<strong>物理删除掉</strong>，然后将新的 <code class="highlighter-rouge">segment file</code> 写入磁盘，这里会写一个 <code class="highlighter-rouge">commit point</code> ，标识所有新的 <code class="highlighter-rouge">segment file</code> ，然后打开 <code class="highlighter-rouge">segment file</code> 供搜索使用，同时删除旧的 <code class="highlighter-rouge">segment file</code> 。</p>

<h3 id="如何合理设置分片数和副本数">如何合理设置分片数和副本数</h3>

<p><strong>当你在Elasticsearch中将index的分片设置好后，主分片数量在集群中是不能进行修改的，即便是你发现主分片数量不合理也无法调整，那怎么办？</strong></p>

<ul>
  <li>分配分片时主要要考虑的问题
    <ul>
      <li>数据集的增长趋势</li>
      <li>很多用户认为提前放大分配好分片的量就能确保以后不会出现新的问题，比如分1000个分片</li>
    </ul>
  </li>
  <li>要知道分配的每个分片都是由额外的成本的
    <ul>
      <li>每个分片其实都是要存数据的，并且都是一个lucene的索引，会消耗文件句柄已经CPU和内存资源</li>
      <li>当你进行数据访问时，我们的index就会去到所有的分片上去取数据</li>
      <li>如果要取100条，如果你有100个分片，就会从100个分片上各取出100个数据然后进行排序给出最终的排序结果，取了100*100条数据</li>
    </ul>
  </li>
  <li>主分片数据到底多少为宜呢？
    <ul>
      <li>根据你的节点数来进行分片，3个Node，N*(1.5-3)</li>
      <li>我们现在3个节点，主分片数据：5-9个分片</li>
    </ul>
  </li>
</ul>

<p><strong>总结</strong></p>

<ul>
  <li>分片是有相依消耗的，并且持续投入</li>
  <li>
    <font color="red">当index拥有多个分片时，ES会查询所有分片然后进行数据合并排序</font>
  </li>
  <li>分片数量建议：node*(1.5-3)</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 创建索引过程中进行分片设置</span>
PUT /index_test
<span class="o">{</span>
    <span class="s2">"settings"</span>: <span class="o">{</span>
        <span class="s2">"number_of_shards"</span>: 5,
        <span class="s2">"number_of_replicas"</span>: 1
    <span class="o">}</span>
<span class="o">}</span>
<span class="c"># 修改副本分片数量，可以随时修改，副本建议1到2个就好了</span>
<span class="c"># 副本分片如果过多在写入的时候会消耗更多时间来复制数据</span>
PUT /index_test/_settings
<span class="o">{</span>
    <span class="s2">"number_of_replicas"</span>: 2
<span class="o">}</span>
</code></pre></div></div>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/icoding-gavin/2020/02/19/gavin-note-037.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
