<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <title> 23种设计模式之代理模式-Proxy - 大伟的博客 </title>
    <meta name="keywords" content="design-mode">
    <meta name="description"
          content="代理模式是一种结构型设计模式，允许你控制原对象的访问和增加额外操作，读懂代理模式的概念,实现方式-静态代理、JDK动态代理、CGLIB动态代理、Javassist动态代理、ASM动态代理">

    <link rel="canonical" href="http://47.113.95.179/jk-blog/design-mode/2020/05/03/3-java-proxy-mode.html">
    <link rel="alternate" type="application/rss+xml" title="大伟,专注Spring Boot,Spring Cloud,Docker,Java后端技术" href="http://47.113.95.179/jk-blog/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/gitalk.css">
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->

    

    <!-- My CSS -->
    <link rel="stylesheet" href="/assets/css/common.css">

    <!-- CSS set in page -->
    

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" href="/assets/css/sidebar-post-nav.css">
    

    <!--<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">-->

    <script type="text/javascript" src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/lock.js"></script>
</head>


    <body>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/archives.html"
                       target="_self"
                       title="Archives">
                        Archives
                    </a>
                </div>
                
                <div class="item">
                    <a href="/linux.html"
                       target="_self"
                       title="Linux">
                        Linux
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mysql.html"
                       target="_self"
                       title="Mysql">
                        Mysql
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mongodb.html"
                       target="_self"
                       title="MongoB">
                        MongoB
                    </a>
                </div>
                
                <div class="item">
                    <a href="/mq.html"
                       target="_self"
                       title="MQ">
                        MQ
                    </a>
                </div>
                
                <div class="item">
                    <a href="/fastdfs.html"
                       target="_self"
                       title="FastDFS">
                        FastDFS
                    </a>
                </div>
                
                <div class="item">
                    <a href="/redis.html"
                       target="_self"
                       title="Redis">
                        Redis
                    </a>
                </div>
                
                <div class="item">
                    <a href="/elasticsearch.html"
                       target="_self"
                       title="ES">
                        ES
                    </a>
                </div>
                
                <div class="item">
                    <a href="/docker.html"
                       target="_self"
                       title="Docker">
                        Docker
                    </a>
                </div>
                
                <div class="item">
                    <a href="/k8s.html"
                       target="_self"
                       title="K8s">
                        K8s
                    </a>
                </div>
                
                <div class="item">
                    <a href="/architect.html"
                       target="_self"
                       title="架构师">
                        架构师
                    </a>
                </div>
                
                <div class="item">
                    <a href="/gitee.html"
                       target="_self"
                       title="开源项目">
                        开源项目
                    </a>
                </div>
                
                <div class="item">
                    <a href="/tool.html"
                       target="_self"
                       title="工具">
                        工具
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="生活">
                        生活
                    </a>
                </div>
                
                <div class="item">
                    <a href="/say.html"
                       target="_self"
                       title="说说">
                        说说
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大展宏兔">
            <!--<span class="octicon octicon-mark-github"></span>-->
            <img class="logo" src="/assets/images/favicon.jpeg">
            大展宏兔
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/"
                   target=""
                   title="Home">
                    Home
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Icoding">
                    Icoding
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/icoding-edu.html" 
                           target="_self"
                     >飞天班笔记</a></li>
                    
                    <li><a href="/icoding-gavin.html" 
                           target="_self"
                     >黄埔班笔记</a></li>
                    
                    <li><a href="/icoding-allen.html" 
                           target="_self"
                     >源码分析</a></li>
                    
                    <li><a href="https://www.icodingedu.com/" 
                           target="_blank"
                     >艾编程官网</a></li>
                    
                    <li><a href="https://leetcode-cn.com/problemset/all/" 
                           target="_blank"
                     >力扣刷题</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Java">
                    Java
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/java-base.html" 
                           target="_self"
                     >Java基础</a></li>
                    
                    <li><a href="/java-concurrent.html" 
                           target="_self"
                     >Java并发</a></li>
                    
                    <li><a href="/design-mode.html" 
                           target="_self"
                     >设计模式</a></li>
                    
                    <li><a href="http://www.justdojava.com" 
                           target="_blank"
                     >Java 极客技术</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring.html"
                   target="_self"
                   title="Spring">
                    Spring
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-boot.html"
                   target="_self"
                   title="Spring Boot">
                    Spring Boot
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/spring-cloud.html"
                   target="_self"
                   title="Spring Cloud">
                    Spring Cloud
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href=""
                   target=""
                   title="Go全栈">
                    Go全栈
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/go-base.html" 
                           target="_self"
                     >Go语言基础</a></li>
                    
                    <li><a href="/go-web.html" 
                           target="_self"
                     >Web开发</a></li>
                    
                    <li><a href="/go-middleware.html" 
                           target="_self"
                     >中间件</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/front.html"
                   target="_self"
                   title="大前端">
                    大前端
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="23种设计模式之代理模式-Proxy">
    <div class="container">
        <div id="jumbotron-meta-info">        
            <h1>23种设计模式之代理模式-Proxy</h1>
            <span class="meta-info">
                
                
                <span class="octicon octicon-calendar"></span> 2020/05/03
                
            </span>
        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container noneed" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <p><mark>代理模式Proxy</mark></p>

<p><img src="\assets\images\2021\javabase\proxy-mini.png" alt="" /></p>

<p>动态代理在 Java 中有着广泛的应用，比如 <strong>AOP 的实现原理、RPC远程调用、Java 注解对象获取、日志框架、全局性异常处理、事务处理等</strong>。</p>

<h2 id="1代理模式的概念">1、代理模式的概念</h2>

<p><code class="highlighter-rouge">代理模式(Proxy Pattern)</code>是 23 种设计模式的一种，属于<code class="highlighter-rouge">结构型模式</code>。他指的是一个对象（代理对象）本身不做实际的操作，而是通过其他对象（目标对象）来得到自己想要的结果。这样做的好处是可以在<strong>目标对象实现的基础上，增强额外的功能操作，即扩展目标对象的功能</strong>。代理模式就是加一层的架构思想。</p>

<p>这里能体现出一个非常重要的编程思想：不要随意去改源码，如果需要修改，<font color="red">可以通过代理的方式来扩展该方法</font>，无侵入式的统一结果返回，就是拦截返回结果再进行封装返回给Response。</p>

<p><img src="\assets\images\2021\javabase\proxy-pattern.png" alt="" /></p>

<p>如上图所示，用户不能直接使用目标对象，而是构造出一个代理对象，由代理对象作为中转，代理对象负责调用目标对象真正的行为，从而把结果返回给用户。</p>

<p>代理的关键点就是<strong>代理对象和目标对象的关系</strong>。</p>

<p>代理其实就和经纪人一样，比如你是一个明星，有很多粉丝。你的流量很多，经常会有很多金主来找你洽谈合作等，你自己肯定忙不过来，因为你要处理的不只是谈合作这件事情，你还要懂才艺、拍戏、维护和粉丝的关系、营销等。为此，你找了一个经纪人，你让他负责和金主谈合作这件事，经纪人做事很认真负责，他圆满的完成了任务，于是，金主找你谈合作就变成了金主和你的经纪人谈合作，你就有更多的时间来忙其他事情了。如下图所示</p>

<p><img src="\assets\images\2021\javabase\proxy-pattern-2.png" alt="" /></p>

<p>这是一种静态代理，因为这个<code class="highlighter-rouge">代理(经纪人)</code>是你自己亲自挑选的。</p>

<p>但是后来随着你的业务逐渐拓展，你无法选择每个经纪人，所以你索性交给了代理公司来帮你做。如果你想在 B 站火一把，那就直接让代理公司帮你找到负责营销方面的代理人，如果你想维护和粉丝的关系，那你直接让代理公司给你找一些托儿就可以了，那么此时的关系图会变为如下</p>

<p><img src="\assets\images\2021\javabase\proxy-pattern-3.png" alt="" /></p>

<p>此时你几乎所有的工作都是由代理公司来进行打理，而他们派出谁来帮你做这些事情你就不得而知了，这得根据实际情况来定，因为代理公司也不只是负责你一个明星，而且每个人所擅长的领域也不同，所以你只有等到有实际需求后，才会给你指定对应的代理人，这种情况就叫做<code class="highlighter-rouge">动态代理</code>。从编程角度来看，这些代理人就是是代理接口下的所有类，所以<code class="highlighter-rouge">动态代理</code>是代理接口/抽象类的。</p>

<h2 id="2-静态代理">2 、静态代理</h2>

<p>在编译阶段就能确定最终的执行方法的代理模式，这是静态代理</p>

<h3 id="租房子的例子">租房子的例子</h3>

<p><img src="/assets/images/2020/java/proxy-example.gif" alt="" /></p>

<p>静态代理，角色分析：</p>

<ul>
  <li>抽象角色：一般会使用接口和抽象类实现</li>
  <li>真实的角色：被代理的角色</li>
  <li>代理角色：代理真实角色，代理后，一般会做一些附属操作（增强）</li>
  <li>客户：访问代理的人</li>
</ul>

<p>代码实现</p>

<p>1、抽象角色Rent接口</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Rent</span> <span class="o">{</span>
	<span class="kt">void</span> <span class="nf">rent</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2、真实的角色-房东</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Host</span> <span class="kd">implements</span> <span class="nc">Rent</span> <span class="o">{</span>
  <span class="c1">// 真实角色要做的操作</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">rent</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"房东要出租房子。。。。"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3、代理角色-中介</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 房东不想去找客户租房子，让中介代理</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HostProxy</span> <span class="kd">implements</span> <span class="nc">Rent</span><span class="o">{</span>
  <span class="c1">// 具体的目标对象（真实角色）</span>
	<span class="kd">private</span> <span class="nc">Host</span> <span class="n">host</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">HostProxy</span><span class="o">(){}</span>

	<span class="kd">public</span> <span class="nf">HostProxy</span><span class="o">(</span><span class="nc">Host</span> <span class="n">host</span><span class="o">){</span>
		<span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">rent</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// 房东出租房子</span>
		<span class="n">host</span><span class="o">.</span><span class="na">rent</span><span class="o">();</span>
		<span class="c1">// 中介带你看房子</span>
		<span class="n">seeHouse</span><span class="o">();</span>
		<span class="c1">// 合适就签合同</span>
		<span class="n">signRentContract</span><span class="o">();</span>
		<span class="c1">// 收中介费</span>
		<span class="n">fee</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// 代理的一些附属操作：</span>
	<span class="c1">// 看房</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">seeHouse</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"中介带你看房子"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="c1">// 签合同</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">signRentContract</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"签租赁合同"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="c1">// 收中介费</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">fee</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"收中介费"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4、客户：你要租房子，找到代理</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Host</span> <span class="n">host</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Host</span><span class="o">();</span>
		<span class="nc">HostProxy</span> <span class="n">proxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HostProxy</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>
		<span class="n">proxy</span><span class="o">.</span><span class="na">rent</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>执行结果：</p>

<p><img src="\assets\images\2020\java\proxy-rent-1.jpg" alt="" /></p>

<h3 id="修改用户的例子">修改用户的例子</h3>

<p>1、抽象角色UserService接口</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserService</span> <span class="o">{</span>
	<span class="kt">void</span> <span class="nf">add</span><span class="o">();</span>

	<span class="kt">void</span> <span class="nf">delete</span><span class="o">();</span>

	<span class="kt">void</span> <span class="nf">update</span><span class="o">();</span>

	<span class="kt">void</span> <span class="nf">query</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2、真实的角色UserServiceImpl实现类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span> <span class="kd">implements</span> <span class="nc">UserService</span><span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"新增了一个用户"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"删除了一个用户"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"更新了一个用户"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">query</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"查询了多个用户"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>现在我们想在调用CRUD（增删改查）前记录一下日志，在不入侵原有代码的原则下，加一层代理。</p>

<p>3、代理角色UserServiceProxy类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceProxy</span> <span class="kd">implements</span> <span class="nc">UserService</span><span class="o">{</span>
	<span class="kd">private</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserService</span><span class="o">(</span><span class="nc">UserService</span> <span class="n">userService</span><span class="o">){</span>
		<span class="k">this</span><span class="o">.</span><span class="na">userService</span> <span class="o">=</span> <span class="n">userService</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">(</span><span class="s">"add"</span><span class="o">);</span>
		<span class="n">userService</span><span class="o">.</span><span class="na">add</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">(</span><span class="s">"delete"</span><span class="o">)</span>
		<span class="n">userService</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">(</span><span class="s">"update"</span><span class="o">);</span>
		<span class="n">userService</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">query</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">log</span><span class="o">(</span><span class="s">"query"</span><span class="o">);</span>
		<span class="n">userService</span><span class="o">.</span><span class="na">query</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">log</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">){</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"【Debug】使用了"</span><span class="o">+</span> <span class="n">msg</span> <span class="o">+</span><span class="s">"方法"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4、客户UserClient类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserClient</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">UserServiceImpl</span> <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserServiceImpl</span><span class="o">();</span>
		<span class="nc">UserServiceProxy</span> <span class="n">proxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserServiceProxy</span><span class="o">();</span>
		<span class="n">proxy</span><span class="o">.</span><span class="na">setUserService</span><span class="o">(</span><span class="n">userService</span><span class="o">);</span>
		<span class="n">proxy</span><span class="o">.</span><span class="na">add</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="小结">小结</h3>

<ul>
  <li>静态代理类：由程序员创建或者由第三方工具生成，再进行编译；在程序运行之前，代理类的 .class 文件已经存在了。</li>
  <li>静态代理事先知道要代理的是什么。</li>
  <li>静态代理类通常只代理一个类。</li>
</ul>

<p>优点</p>

<ul>
  <li><strong>可以使真实角色的操作更加纯粹，不用关注公共业务</strong></li>
  <li>公共业务交给代理角色，实现业务分工，降低耦合性</li>
  <li>公共业务发生扩展的时候，方便集中管理</li>
</ul>

<p>缺点</p>

<ul>
  <li>一个真实角色会产生一个代理角色，代码量翻倍，开发效率变低！</li>
</ul>

<p>代理类UserServiceProxy本身不做用户数据的CRUD,内部是调用实现类UserServiceImpl的CRUD，所以JVM在编译阶段就已经确定了最终的执行方法，这种代理模式叫做静态代理。</p>

<p>相关知识点，AOP：</p>

<p><img src="/assets/images/2020/java/mode-aop.gif" alt="" /></p>

<p>代理模式具有无侵入式的优点，但是静态代理模式的缺点是每个实现类都有一个对应的代理类的代码要写，当代理类很多且要修改的时候就会很烦。所以使用动态代理来代理一个接口，而不是代理一个具体的目标类。</p>

<h2 id="3动态代理">3、动态代理</h2>

<ul>
  <li>动态代理和静态代理的角色一样</li>
  <li>代理类是动态生成的</li>
  <li>动态代理分为两大类：基于接口的动态代理 + 基于类的动态代理</li>
</ul>

<p><strong>动态代理的实现技术有4种：</strong></p>

<ul>
  <li>
    <p>基于接口–使用JDK动态代理实现，内置在 JDK 中</p>
  </li>
  <li>
    <p>基于类— Cglib实现</p>
  </li>
  <li>
    <p>Java字节码实现–Javassist</p>

    <p>Cglib 和 Javassist 都是高级的字节码生成库，总体性能比 JDK 自带的动态代理好，而且功能十分强大。</p>
  </li>
  <li>
    <p>ASM代理</p>

    <p>SM 是低级的字节码生成工具，使用 ASM 已经近乎于在使用字节码编程，对开发人员要求最高。当然，也是<code class="highlighter-rouge">性能最好</code>的一种动态代理生成工具。但 ASM 的使用很繁琐，而且性能也没有数量级的提升，与 CGLIB 等高级字节码生成工具相比，ASM 程序的维护性较差，如果不是在对性能有苛刻要求的场合，还是推荐 CGLIB 或者 Javassist。</p>
  </li>
</ul>

<h3 id="jdk动态代理">JDK动态代理</h3>

<p>需要了解反射相关的两个类：Proxy、InvocationHandler，动态代理的处理类事先继承InvocationHandler接口，使用 Proxy 类中的 newProxyInstance 方法动态的创建代理类。</p>

<p><img src="/assets/images/2020/java/invocation-handler.gif" alt="" /></p>

<p><img src="/assets/images/2020/java/invocation-handler3.gif" alt="" /></p>

<p>新建InvocationHandler的实现类HostInvocationHandler</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HostInvocationHandler</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
  <span class="c1">// 被代理的接口</span>
  <span class="kd">private</span> <span class="nc">Rent</span> <span class="n">rent</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRent</span><span class="o">(</span><span class="nc">Rent</span> <span class="n">rent</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">rent</span> <span class="o">=</span> <span class="n">rent</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// 动态生成得到代理类</span>
  <span class="c1">// 第一个参数：类加载器路径</span>
  <span class="c1">// 第二个参数：要代理的接口</span>
  <span class="c1">// 第三个参数：InvocationHandler的实现类，动态代理应该怎么执行方法，就是下面的invoke方法</span>
  <span class="c1">// 返回一个动态代理类</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getProxy</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="n">rent</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// 动态代理的核心，它会在这里拦截目标方法的执行，也就是接口rent的每一个方法执行</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span><span class="o">{</span>
    <span class="c1">// 动态代理的本质，就是使用反射机制实现</span>
    <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">rent</span><span class="o">,</span><span class="n">args</span><span class="o">);</span> <span class="c1">// 调用目标类的方法</span>
    <span class="n">seeHouse</span><span class="o">();</span>
    <span class="n">signRentContract</span><span class="o">();</span>
    <span class="n">fee</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// 看房</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">seeHouse</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"动态代理-中介带你看房子"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// 签合同</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">signRentContract</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"动态代理-签租赁合同"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// 收中介费</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fee</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"动态代理-收中介费"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>客户Client</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 真实角色：房东</span>
    <span class="nc">Host</span> <span class="n">host</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Host</span><span class="o">();</span>
    <span class="c1">// 代理角色没有，动态生成一个</span>
    <span class="nc">HostInvocationHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HostInvocationHandler</span><span class="o">();</span>
    <span class="c1">// 要代理的目标对象</span>
    <span class="n">handler</span><span class="o">.</span><span class="na">setRent</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>
    <span class="nc">Rent</span> <span class="n">proxy</span> <span class="o">=(</span><span class="nc">Rent</span><span class="o">)</span> <span class="n">handler</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span>
    <span class="n">proxy</span><span class="o">.</span><span class="na">rent</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>运行结果：</p>

<p><img src="\assets\images\2020\java\proxy-rent-2.jpg" alt="" /></p>

<p>HostInvocationHandler是动态代理类，里面有一个接口Rent，方法getProxy() 就是通过类加载器、接口数组获取代理类实例，proxy.rent()执行是接口方法，最终是由invoke触发的执行的是隐藏在代理对象后面的真实对象host的rent()方法。JVM在编译期阶段是无法确定最终的执行方法的。</p>

<blockquote>
  <p>封装成工具类写法</p>
</blockquote>

<p>新建ProxyInvocationHandler</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyInvocationHandler</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
	<span class="c1">// 被代理的接口</span>
	<span class="kd">private</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTarget</span><span class="o">(</span><span class="nc">Object</span> <span class="n">target</span><span class="o">){</span>
		<span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="c1">// 生成得到代理类</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getProxy</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">(),</span><span class="k">this</span><span class="o">);</span>
	<span class="o">}</span>

  <span class="c1">// 动态代理的核心，它会在这里拦截目标方法的执行，也就是接口target的每一个方法执行</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span><span class="o">{</span>
    <span class="c1">// 通过反射获取方法名</span>
    <span class="n">log</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
  
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">log</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">){</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"【Debug】使用了"</span><span class="o">+</span> <span class="n">msg</span> <span class="o">+</span><span class="s">"方法"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>客户角色Client类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 真实角色</span>
    <span class="nc">UserServiceImpl</span> <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserServiceImpl</span><span class="o">();</span>
    <span class="c1">// 代理角色，不存在，通过handler生成</span>
    <span class="nc">ProxyInvocationHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProxyInvocationHandler</span><span class="o">();</span>
    <span class="c1">// 设置要代理的对象</span>
    <span class="n">handler</span><span class="o">.</span><span class="na">setTarget</span><span class="o">(</span><span class="n">userService</span><span class="o">);</span>
    <span class="nc">UserService</span> <span class="n">proxy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserService</span><span class="o">)</span> <span class="n">handler</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span> <span class="c1">// 动态创建实现类 </span>
    <span class="n">proxy</span><span class="o">.</span><span class="na">add</span><span class="o">();</span>
    <span class="n">proxy</span><span class="o">.</span><span class="na">query</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>运行结果应该很清晰啦，就不截图了</p>

<p>JDK动态代理的特点：</p>

<ul>
  <li>动态代理通常是在程序运行时，Proxy.newProxyInstance()通过<code class="highlighter-rouge">反射机制</code>动态生成的代理类，本质上它就是所代理接口的实现类</li>
  <li>动态代理类通常代理<code class="highlighter-rouge">接口</code>下的所有类。</li>
  <li>动态代理事先不知道要代理的目标类是什么，只有在运行的时候才能确定，其实它代理的是接口，</li>
  <li>动态代理的调用处理程序必须事先继承 InvocationHandler 接口，使用 Proxy 类中的 newProxyInstance 方法动态的创建代理类。</li>
  <li>核心在于动态代理的处理类即继承 InvocationHandler 接口的实现类中的invoke方法，它会拦截所有代理接口的方法的调用</li>
</ul>

<h3 id="cglib-动态代理">CGLIB 动态代理</h3>

<p>上面我们提到 JDK 动态代理是基于接口的代理，而 CGLIB 动态代理<strong>是针对类实现代理，主要是对指定的类生成一个子类，覆盖其中的方法</strong> ，也就是说 CGLIB 动态代理采用类继承 -&gt; 方法重写的方式进行的，下面我们先来看一下 CGLIB 动态代理的结构。</p>

<p><img src="\assets\images\2021\javabase\proxy-pattern-4.png" alt="" /></p>

<p>如上图所示，代理类继承于目标类，每次调用代理类的方法都会在拦截器中进行拦截，拦截器中再会调用目标类的方法。下面我们通过一个示例来演示一下 CGLIB 动态代理的使用，新建一个Springboot工程。</p>

<p>1、pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>cglib<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>cglib<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>3.2.5<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、以上面租房子的例子为基础，Host类就是我们要代理的目标类，我们通过代理模式在执行Host.rent()方法的前后增加一些操作进行增强，同时不入侵目标类方法。</p>

<p>创建一个自定义方法拦截类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AutoMethodInterceptor</span> <span class="kd">implements</span> <span class="nc">MethodInterceptor</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">intercept</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">MethodProxy</span> <span class="n">methodProxy</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---- 方法拦截 ----"</span><span class="o">);</span>
    <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">methodProxy</span><span class="o">.</span><span class="na">invokeSuper</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里解释一下这几个参数都是什么含义</p>

<ul>
  <li>Object obj: obj 是 CGLIB 动态生成代理类实例</li>
  <li>Method method: Method 为实体类所调用的被代理的方法引用</li>
  <li>Objectp[] args: 这个就是方法的参数列表</li>
  <li>MethodProxy methodProxy : 这个就是生成的代理类对方法的引用。</li>
</ul>

<p>对于 <code class="highlighter-rouge">methodProxy</code> 参数调用的方法，在其内部有两种选择：<code class="highlighter-rouge">invoke()</code> 和 <code class="highlighter-rouge">invokeSuper()</code> ，二者的区别不在本文展开说明，感兴趣的读者可以参考本篇文章：Cglib源码分析 invoke和invokeSuper的差别</p>

<p>3、测试一下</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 3、cglib动态代理</span>
    <span class="nc">Enhancer</span> <span class="n">enhancer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Enhancer</span><span class="o">();</span>
    <span class="n">enhancer</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="nc">Host</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">enhancer</span><span class="o">.</span><span class="na">setCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">AutoMethodInterceptor</span><span class="o">());</span>
    <span class="nc">Host</span> <span class="n">host1</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Host</span><span class="o">)</span><span class="n">enhancer</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
    <span class="n">host1</span><span class="o">.</span><span class="na">rent</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>执行结果：</p>

<p><img src="\assets\images\2021\javabase\proxy-pattern-cglib-1.png" alt="" /></p>

<p>实际项目中引入的cglib.jar是3.1版本的，百度上说是因为与asm版本冲突的原因</p>

<p><img src="\assets\images\2021\javabase\proxy-pattern-cglib-2.png" alt="" /></p>

<p>修改版本为3.2.5，maven重新引入jar包，重新执行成功</p>

<p><img src="\assets\images\2021\javabase\proxy-pattern-cglib-3.png" alt="" /></p>

<p>我们给拦截方法增加一些业务操作，如下</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AutoMethodInterceptor</span> <span class="kd">implements</span> <span class="nc">MethodInterceptor</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">intercept</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">MethodProxy</span> <span class="n">methodProxy</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---- 方法拦截 ----"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">methodProxy</span><span class="o">.</span><span class="na">invokeSuper</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="n">seeHouse</span><span class="o">();</span>
        <span class="n">signRentContract</span><span class="o">();</span>
        <span class="n">fee</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 看房</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">seeHouse</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"cglib动态代理-中介带你看房子"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 签合同</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">signRentContract</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"cglib动态代理-签租赁合同"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 收中介费</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fee</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"cglib动态代理-收中介费"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>执行一些Client.main方法，结果：</p>

<p><img src="\assets\images\2021\javabase\proxy-pattern-cglib-4.png" alt="" /></p>

<p>main方法中主要涉及 <code class="highlighter-rouge">Enhancer</code> 的使用，Enhancer 是一个非常重要的类，它允许为<code class="highlighter-rouge">非接口类型</code>创建一个 Java 代理，Enhancer 动态的创建给定类的子类并且拦截代理类的所有的方法，和 JDK 动态代理不一样的是不管是接口还是类它都能正常工作。</p>

<blockquote>
  <p>小结</p>
</blockquote>

<ul>
  <li>JDK 动态代理与 CGLIB 动态代理都是将真实对象<mark>隐藏</mark>在代理对象的后面，以达到 <code class="highlighter-rouge">代理</code> 的效果。与 JDK 动态代理所不同的是 CGLIB 动态代理使用 Enhancer 来创建代理对象，而 JDK 动态代理使用的是 Proxy.newProxyInstance 来创建代理对象；</li>
  <li>CGLIB 可以代理大部分类，而 JDK 动态代理只能代理实现了接口的类。</li>
</ul>

<h3 id="javassit代理">Javassit代理</h3>

<p><strong>百度百科：</strong></p>

<p>Javassist是一个<a href="https://baike.baidu.com/item/开源/20720669">开源</a>的分析、编辑和创建Java<a href="https://baike.baidu.com/item/字节码">字节码</a>的类库。是由<a href="https://baike.baidu.com/item/东京工业大学/2567295">东京工业大学</a>的数学和计算机科学系的 Shigeru Chiba （千叶 滋）所创建的。它已加入了开放源代码<a href="https://baike.baidu.com/item/JBoss/5611767">JBoss</a> <a href="https://baike.baidu.com/item/应用服务器/4971773">应用服务器</a>项目，通过使用Javassist对字节码操作为JBoss实现动态”AOP”框架。关于java字节码的处理，有很多工具，如bcel，<a href="https://baike.baidu.com/item/asm">asm</a>。不过这些都需要直接跟<a href="https://baike.baidu.com/item/虚拟机">虚拟机</a>指令打交道。如果你不想了解虚拟机指令，可以采用javassist。javassist是<a href="https://baike.baidu.com/item/jboss">jboss</a>的一个子项目，其主要的优点，在于简单，而且快速。直接使用java编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构，或者动态生成类。</p>

<p><code class="highlighter-rouge">Javassist</code>是在 Java 中编辑字节码的类库(直接修改字节码，更低层)；它使 Java 程序能够在运行时定义一个新类, 并在 JVM 加载时修改类文件。我们使用最频繁的动态特性就是 <code class="highlighter-rouge">反射</code>，而且反射也是动态代理的基础，我们之所以没有提反射对动态代理的作用是因为我想在后面详聊，反射可以在运行时查找对象属性、方法，修改作用域，通过方法名称调用方法等。实时应用不会频繁使用反射来创建，因为反射开销比较大，另外，还有一种具有和反射一样功能强大的特性那就是 <code class="highlighter-rouge">Javaassist</code>。</p>

<p>以上面租房子的例子，继续说明</p>

<p>1、pom.xml导入依赖</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.javassist<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>javassist<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.27.0-GA<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>2、新建一个AssistByteCode 类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.CtClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.CtMethod</span><span class="o">;</span>

<span class="cm">/**
 * @Author xiejw17
 * @Date 2021/1/20 11:03
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AssistByteCode</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createByteCode</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">ClassPool</span> <span class="n">classPool</span> <span class="o">=</span> <span class="nc">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="c1">// 类路径</span>
        <span class="nc">CtClass</span> <span class="n">ctClass</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">"proxy.Host2"</span><span class="o">);</span>
        <span class="c1">// 设置接口</span>
        <span class="nc">CtClass</span> <span class="n">ctInterface</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"proxy.Rent"</span><span class="o">);</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">setInterfaces</span><span class="o">(</span><span class="k">new</span> <span class="nc">CtClass</span><span class="o">[]{</span><span class="n">ctInterface</span><span class="o">});</span>

        <span class="c1">// 创建方法</span>
        <span class="nc">CtMethod</span> <span class="n">rent</span> <span class="o">=</span> <span class="nc">CtMethod</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="s">"public void rent(){}"</span><span class="o">,</span><span class="n">ctClass</span><span class="o">);</span>
        <span class="n">rent</span><span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="s">"System.out.println(\"房东要出租房子。。。。\");"</span><span class="o">);</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">rent</span><span class="o">);</span>

        <span class="c1">// 输出字节码文件</span>
        <span class="nc">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">toClass</span><span class="o">();</span>
      	<span class="n">ctClass</span><span class="o">.</span><span class="na">writeFile</span><span class="o">(</span><span class="s">"D:/jacob/code/c-ccs/web-parent/ccs-common/src/test/java/"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">ClassPool</code>：ClassPool 就是一个 CtClass 的容器，而一个 <code class="highlighter-rouge">CtClass</code> 对象就是一个 class 对象的实例，这个实例和 class 对象一样，包含属性、方法等。</p>

<p>那么上面代码主要做了哪些事儿呢？通过 ClassPool 来获取 CtClass 所需要的接口、抽象类的 CtClass 实例，然后通过 CtClass 实例添加自己的属性和方法，并通过它的 writeFile 把二进制流输出到当前项目的根目录路径下。writeFile 其内部是使用了 <code class="highlighter-rouge">DataOutputStream</code> 进行输出的。</p>

<p>我们在main方法里执行一下createByteCode()方法</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="nc">AssistByteCode</span><span class="o">.</span><span class="na">createByteCode</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>流写完后，我们打开这个 <code class="highlighter-rouge">.class</code> 文件如下所示</p>

<p><img src="\assets\images\2021\javabase\proxy-javassist-1.png" alt="" /></p>

<p>可以对比一下上面发现 Host2 发现编译器除了为我们添加了一个公有的构造器，其他基本一致。</p>

<p><img src="\assets\images\2021\javabase\proxy-javassist-2.png" alt="" /></p>

<p>上面演示了javassist动态的在JVM新增一个类的字节码文件。</p>

<p>javassist如何实现动态代理，创建一个代理工厂，代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">javassist.util.proxy.ProxyFactory</span><span class="o">;</span>

<span class="cm">/**
 * @Author xiejw17
 * @Date 2021/1/20 15:07
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JavaassistProxyFactory</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nc">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>

        <span class="c1">// 代理工厂</span>
        <span class="nc">ProxyFactory</span> <span class="n">proxyFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProxyFactory</span><span class="o">();</span>
        <span class="c1">// 设置需要创建的子类</span>
        <span class="n">proxyFactory</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="n">proxyFactory</span><span class="o">.</span><span class="na">setHandler</span><span class="o">((</span><span class="n">self</span><span class="o">,</span> <span class="n">thisMethod</span><span class="o">,</span> <span class="n">proceed</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---- javassist动态代理,开始拦截 ----"</span><span class="o">);</span>
            <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">proceed</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">self</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---- javassist动态代理,结束拦截 ----"</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">proxyFactory</span><span class="o">.</span><span class="na">createClass</span><span class="o">().</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>上面我们定义了一个代理工厂，代理工厂里面创建了一个 handler，在调用目标方法时，Javassist 会回调 MethodHandler 接口方法拦截，来调用真正执行的方法，你可以在拦截方法的前后实现自己的业务逻辑。最后的 <strong>proxyFactory.createClass().newInstance()</strong> 就是使用字节码技术来创建了最终的子类实例，这种代理方式类似于 JDK 中的 InvocationHandler 接口。</p>

<p>在Client.main()方法执行一下</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 4、javassist动态代理</span>
      <span class="nc">JavaassistProxyFactory</span> <span class="n">proxyFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JavaassistProxyFactory</span><span class="o">();</span>
      <span class="nc">Host</span> <span class="n">proxy</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Host</span><span class="o">)</span><span class="n">proxyFactory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">(</span><span class="nc">Host</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">proxy</span><span class="o">.</span><span class="na">rent</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="D:\jacob\code\aikomj.github.io\assets\images\2021\javabase\proxy-javassist-3.png" alt="" /></p>

<h3 id="asm代理">ASM代理</h3>

<p>ASM 是一套 Java 字节码生成架构，它可以动态生成二进制格式的子类或其它代理类，或者在类被 Java 虚拟机装入内存之前，动态修改类。</p>

<p>下面我们使用 ASM 框架实现一个动态代理，ASM 生成的动态代理</p>

<p>以下代码摘自 https://blog.csdn.net/lightj1996/article/details/107305662</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsmProxy</span> <span class="kd">extends</span> <span class="nc">ClassLoader</span> <span class="kd">implements</span> <span class="nc">Opcodes</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createAsmProxy</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="c1">// 目标类类名 字节码中类修饰符以 “/” 分割</span>
        <span class="nc">String</span> <span class="n">targetServiceName</span> <span class="o">=</span> <span class="nc">TargetService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">"."</span><span class="o">,</span> <span class="s">"/"</span><span class="o">);</span>
        <span class="c1">// 切面类类名</span>
        <span class="nc">String</span> <span class="n">aspectServiceName</span> <span class="o">=</span> <span class="nc">AspectService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">"."</span><span class="o">,</span> <span class="s">"/"</span><span class="o">);</span>
        <span class="c1">// 代理类类名</span>
        <span class="nc">String</span> <span class="n">proxyServiceName</span> <span class="o">=</span> <span class="n">targetServiceName</span><span class="o">+</span><span class="s">"Proxy"</span><span class="o">;</span>
        <span class="c1">// 创建一个 classWriter 它是继承了ClassVisitor</span>
        <span class="nc">ClassWriter</span> <span class="n">classWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassWriter</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="c1">// 访问类 指定jdk版本号为1.8, 修饰符为 public，父类是TargetService</span>
        <span class="n">classWriter</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="nc">Opcodes</span><span class="o">.</span><span class="na">V1_8</span><span class="o">,</span> <span class="nc">Opcodes</span><span class="o">.</span><span class="na">ACC_PUBLIC</span><span class="o">,</span> <span class="n">proxyServiceName</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">targetServiceName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="c1">// 访问目标类成员变量 为类添加切面属性 “private TargetService targetService”</span>
        <span class="n">classWriter</span><span class="o">.</span><span class="na">visitField</span><span class="o">(</span><span class="no">ACC_PRIVATE</span><span class="o">,</span> <span class="s">"targetService"</span><span class="o">,</span> <span class="s">"L"</span> <span class="o">+</span> <span class="n">targetServiceName</span><span class="o">+</span><span class="s">";"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="c1">// 访问切面类成员变量 为类添加目标属性 “private AspectService aspectService”</span>
        <span class="n">classWriter</span><span class="o">.</span><span class="na">visitField</span><span class="o">(</span><span class="no">ACC_PRIVATE</span><span class="o">,</span> <span class="s">"aspectService"</span><span class="o">,</span> <span class="s">"L"</span> <span class="o">+</span> <span class="n">aspectServiceName</span><span class="o">+</span><span class="s">";"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="c1">// 访问默认构造方法 TargetServiceProxy()</span>
        <span class="c1">// 定义函数 修饰符为public 方法名为 &lt;init&gt;， 方法表述符为()V 表示无参数，无返回参数</span>
        <span class="nc">MethodVisitor</span> <span class="n">initVisitor</span> <span class="o">=</span> <span class="n">classWriter</span><span class="o">.</span><span class="na">visitMethod</span><span class="o">(</span><span class="no">ACC_PUBLIC</span><span class="o">,</span> <span class="s">"&lt;init&gt;"</span><span class="o">,</span> <span class="s">"()V"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="c1">// 从局部变量表取第0个元素 “this”</span>
        <span class="n">initVisitor</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">ALOAD</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="c1">// 调用super 的构造方法 invokeSpecial在这里的意思是调用父类方法</span>
        <span class="n">initVisitor</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKESPECIAL</span><span class="o">,</span> <span class="n">targetServiceName</span><span class="o">,</span> <span class="s">"&lt;init&gt;"</span><span class="o">,</span> <span class="s">"()V"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">// 方法返回</span>
        <span class="n">initVisitor</span><span class="o">.</span><span class="na">visitInsn</span><span class="o">(</span><span class="no">RETURN</span><span class="o">);</span>
        <span class="c1">// 设置最大栈数量，最大局部变量表数量</span>
        <span class="n">initVisitor</span><span class="o">.</span><span class="na">visitMaxs</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="c1">// 访问结束</span>
        <span class="n">initVisitor</span><span class="o">.</span><span class="na">visitEnd</span><span class="o">();</span>

        <span class="c1">// 创建有参构造方法 TargetServiceProxy(TargetService var1, AspectService var2)</span>
        <span class="c1">// 定义函数 修饰符为public 方法名为 &lt;init&gt;， 方法表述符为(TargetService, AspectService)V 表示无参数，无返回参数</span>
        <span class="nc">MethodVisitor</span> <span class="n">methodVisitor</span> <span class="o">=</span> <span class="n">classWriter</span><span class="o">.</span><span class="na">visitMethod</span><span class="o">(</span><span class="no">ACC_PUBLIC</span><span class="o">,</span> <span class="s">"&lt;init&gt;"</span><span class="o">,</span> <span class="s">"(L"</span> <span class="o">+</span> <span class="n">targetServiceName</span> <span class="o">+</span> <span class="s">";L"</span><span class="o">+</span><span class="n">aspectServiceName</span><span class="o">+</span><span class="s">";)V"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="c1">// 从局部变量表取第0个元素 “this”压入栈顶</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">ALOAD</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="c1">// this出栈 , 调用super 的构造方法 invokeSpecial在这里的意思是调用父类方法。 &lt;init&gt;的owner是AspectService, 无参无返回类型</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKESPECIAL</span><span class="o">,</span> <span class="n">targetServiceName</span><span class="o">,</span> <span class="s">"&lt;init&gt;"</span><span class="o">,</span> <span class="s">"()V"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">// 从局部变量表取第0个元素 “this”压入栈顶</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">ALOAD</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="c1">// 从局部变量表取第1个元素 “targetService”压入栈顶</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">ALOAD</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="c1">// this 和 targetService 出栈, 调用targetService put 赋值给this.targetService</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitFieldInsn</span><span class="o">(</span><span class="no">PUTFIELD</span><span class="o">,</span> <span class="n">proxyServiceName</span><span class="o">,</span> <span class="s">"targetService"</span><span class="o">,</span> <span class="s">"L"</span> <span class="o">+</span> <span class="n">targetServiceName</span> <span class="o">+</span> <span class="s">";"</span><span class="o">);</span>
        <span class="c1">// 从局部变量表取第0个元素 “this”压入栈顶</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">ALOAD</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="c1">// 从局部变量表取第2个元素 “aspectService”压入栈顶</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">ALOAD</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
        <span class="c1">// this 和 aspectService 出栈 将 targetService put 赋值给this.aspectService</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitFieldInsn</span><span class="o">(</span><span class="no">PUTFIELD</span><span class="o">,</span> <span class="n">proxyServiceName</span><span class="o">,</span> <span class="s">"aspectService"</span><span class="o">,</span> <span class="s">"L"</span> <span class="o">+</span> <span class="n">aspectServiceName</span> <span class="o">+</span> <span class="s">";"</span><span class="o">);</span>
        <span class="c1">// 方法返回</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitInsn</span><span class="o">(</span><span class="no">RETURN</span><span class="o">);</span>
        <span class="c1">// 设置最大栈数量，最大局部变量表数量</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitMaxs</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
        <span class="c1">// 方法返回</span>
        <span class="n">methodVisitor</span><span class="o">.</span><span class="na">visitEnd</span><span class="o">();</span>

        <span class="c1">// 创建代理方法 修饰符为public，方法名为 demoQuest</span>
        <span class="nc">MethodVisitor</span> <span class="n">visitMethod</span> <span class="o">=</span> <span class="n">classWriter</span><span class="o">.</span><span class="na">visitMethod</span><span class="o">(</span><span class="no">ACC_PUBLIC</span><span class="o">,</span> <span class="s">"demoQuest"</span><span class="o">,</span> <span class="s">"()I"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="c1">// 从局部变量表取第0个元素 “this”压入栈顶</span>
        <span class="n">visitMethod</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">ALOAD</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="c1">// this 出栈 将this.aspectService压入栈顶</span>
        <span class="n">visitMethod</span><span class="o">.</span><span class="na">visitFieldInsn</span><span class="o">(</span><span class="no">GETFIELD</span><span class="o">,</span> <span class="n">proxyServiceName</span><span class="o">,</span> <span class="s">"aspectService"</span><span class="o">,</span> <span class="s">"L"</span><span class="o">+</span><span class="n">aspectServiceName</span><span class="o">+</span><span class="s">";"</span><span class="o">);</span>
        <span class="c1">// 取栈顶元素出栈 也就是targetService 调用其preOperation方法， demoQuest的owner是AspectService, 无参无返回类型</span>
        <span class="n">visitMethod</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKEVIRTUAL</span><span class="o">,</span> <span class="n">aspectServiceName</span><span class="o">,</span><span class="s">"preOperation"</span><span class="o">,</span> <span class="s">"()V"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">// 从局部变量表取第0个元素 “this”压入栈顶</span>
        <span class="n">visitMethod</span><span class="o">.</span><span class="na">visitVarInsn</span><span class="o">(</span><span class="no">ALOAD</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="c1">// this 出栈, 取this.targetService压入栈顶</span>
        <span class="n">visitMethod</span><span class="o">.</span><span class="na">visitFieldInsn</span><span class="o">(</span><span class="no">GETFIELD</span><span class="o">,</span> <span class="n">proxyServiceName</span><span class="o">,</span> <span class="s">"targetService"</span><span class="o">,</span> <span class="s">"L"</span><span class="o">+</span><span class="n">targetServiceName</span><span class="o">+</span><span class="s">";"</span><span class="o">);</span>
        <span class="c1">// 取栈顶元素出栈 也就是targetService调用其demoQuest方法, demoQuest的owner是TargetService, 无参无返回类型</span>
        <span class="n">visitMethod</span><span class="o">.</span><span class="na">visitMethodInsn</span><span class="o">(</span><span class="no">INVOKEVIRTUAL</span><span class="o">,</span> <span class="n">targetServiceName</span><span class="o">,</span> <span class="s">"demoQuest"</span><span class="o">,</span> <span class="s">"()I"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">// 方法返回</span>
        <span class="n">visitMethod</span><span class="o">.</span><span class="na">visitInsn</span><span class="o">(</span><span class="no">IRETURN</span><span class="o">);</span>
        <span class="c1">// 设置最大栈数量，最大局部变量表数量</span>
        <span class="n">visitMethod</span><span class="o">.</span><span class="na">visitMaxs</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="c1">// 方法返回</span>
        <span class="n">visitMethod</span><span class="o">.</span><span class="na">visitEnd</span><span class="o">();</span>

        <span class="c1">// 生成字节码二进制流</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">classWriter</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
        <span class="c1">// 自定义classloader加载类</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="nc">AsmProxy</span><span class="o">()).</span><span class="na">defineClass</span><span class="o">(</span><span class="nc">TargetService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"Proxy"</span><span class="o">,</span> <span class="n">code</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">code</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="c1">// 取其带参数的构造方法</span>
        <span class="nc">Constructor</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="nc">TargetService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">AspectService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// 使用构造方法实例化对象</span>
        <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="k">new</span> <span class="nc">TargetService</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">AspectService</span><span class="o">());</span>

        <span class="c1">// 使用TargetService类型的引用接收这个对象</span>
        <span class="nc">TargetService</span> <span class="n">targetService</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">object</span> <span class="k">instanceof</span> <span class="nc">TargetService</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">targetService</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TargetService</span><span class="o">)</span><span class="n">object</span><span class="o">;</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"生成代理类的名称: "</span> <span class="o">+</span> <span class="n">targetService</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
        <span class="c1">// 调用被代理方法</span>
        <span class="n">targetService</span><span class="o">.</span><span class="na">demoQuest</span><span class="o">();</span>

        <span class="c1">// 这里可以不用写, 但是如果想看最后生成的字节码长什么样子，可以写 "ascp-purchase-app/target/classes/"是我的根目录, 阅读者需要将其替换成自己的</span>
        <span class="nc">String</span> <span class="n">classPath</span> <span class="o">=</span> <span class="s">"/Users/mr.l/cxuan-justdoit/"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">classPath</span> <span class="o">+</span> <span class="n">proxyServiceName</span> <span class="o">+</span> <span class="s">".class"</span><span class="o">;</span>
        <span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span>
                <span class="k">new</span> <span class="nf">FileOutputStream</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        <span class="n">fos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
        <span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用 ASM 生成动态代理的代码比较长，上面这段代码的含义就是生成类 TargetServiceProxy，用于代理TargetService ，在调用 targetService.demoQuest() 方法之前调用切面的方法 aspectService.preOperation();</p>

<p>测试类就直接调用 AsmProxy.createAsmProxy() 方法即可，比较简单。</p>

<p>下面是我们生成 TargetServiceProxy 的目标类</p>

<p><img src="\assets\images\2021\javabase\proxy-asm-1.png" alt="" /></p>

<h3 id="小结-1">小结</h3>

<p>至此，我们已经介绍了四种动态代理的方式，分别是<strong>JDK 动态代理、CGLIB 动态代理、Javaassist 动态代理、ASM 动态代理</strong>，那么现在思考一个问题，为什么会有动态代理的出现呢？或者说动态代理是基于什么原理呢？</p>

<p>其实我们上面已经提到过了，没错，动态代理使用的就是<code class="highlighter-rouge">反射</code> 机制，反射机制是 Java 语言提供的一种基础功能，􏱥􏱩赋予程序在运行时动态修改属性、方法的能力。通过反射我们能够直接操作类或者对象，比如获取某个类的定义，获取某个类的属性和方法等。</p>

<p>另外还有需要注意的一点，从性能角度来讲，有些人得出结论说是 Java 动态代理要比 CGLIB 和 Javaassist 慢几十倍，其实，在主流 JDK 版本中，Java 动态代理可以提供相等的性能水平，<strong>数量级的差距不是广泛存在的</strong>。而且，在现代 JDK 中，反射已经得到了改进和优化。</p>

<p>动态代理的好处：</p>

<ul>
  <li>一个动态代理类代理的是一个接口，一般对应一类业务，而静态代理类代理的是一个真实的角色对象。</li>
  <li>一个动态可以代理多个类，只要是实现同一个接口。</li>
  <li>在无侵入式的代码扩展目标类的方法（增强），同时减少代码量，避免代理类泛滥成灾。</li>
</ul>

<p>我们在选型中，性能考量并不是主要关注点，<strong>可靠性、可维护性、编码工作量</strong>同等重要。</p>

<h2 id="4意图">4、意图</h2>

<p>以下内容转载自 <a href="https://refactoringguru.cn/design-patterns/proxy">https://refactoringguru.cn/design-patterns/proxy</a></p>

<p>结构型设计模式：该模式将对象和类组装成较大的结构， 并同时保持结构的灵活和高效</p>

<p><strong>代理模式</strong>是一种结构型设计模式， 让你能够提供对象的替代品或其占位符。 代理控制着对于原对象的访问， 并允许在将请求提交给对象前后进行一些处理。</p>

<p><img src="\assets\images\2021\javabase\proxy.png" alt="" /></p>

<h3 id="问题">问题</h3>

<p>为什么要控制对于某个对象的访问呢？ 举个例子： 有这样一个消耗大量系统资源的巨型对象， 你只是偶尔需要使用它， 并非总是需要。如数据库的访问</p>

<p><img src="\assets\images\2021\javabase\proxy-problem-zh.png" alt="" /></p>

<h3 id="解决方案">解决方案</h3>

<p>代理模式建议新建一个与原服务对象接口相同的代理类， 然后更新应用以将代理对象传递给所有原始对象客户端。 代理类接收到客户端请求后会创建实际的服务对象， 并将所有工作委派给它。动态代理</p>

<p><img src="\assets\images\2021\javabase\proxy-solution-zh.png" alt="" /></p>

<p><mark>代理将自己伪装成数据库对象， 可在客户端或实际数据库对象不知情的情况下处理延迟初始化和缓存查询结果的工作。</mark></p>

<p>这有什么好处呢？ 如果需要在类的主要业务逻辑前后执行一些工作， 你无需修改类就能完成这项工作。 由于代理实现的接口与原类相同， 因此你可将其传递给任何一个使用实际服务对象的客户端。</p>

<h3 id="真实世界类比">真实世界类比</h3>

<p><img src="\assets\images\2021\javabase\proxy-live-example-zh.png" alt="" /></p>

<p>信用卡是银行账户的代理， 银行账户则是一大捆现金的代理。 它们都实现了同样的接口， 均可用于进行支付。 消费者会非常满意， 因为不必随身携带大量现金； 商店老板同样会十分高兴， 因为交易收入能以电子化的方式进入商店的银行账户中， 无需担心存款时出现现金丢失或被抢劫的情况。信用卡和银行账户支付都是现金支付的代理，它可以记录支付的相关信息，相当于增强了现金支付的功能，你使用现金支付是没有记录相关信息的。</p>

<h3 id="代理模式结构">代理模式结构</h3>

<p><img src="\assets\images\2021\javabase\proxy-structure.png" alt="" /></p>

<p>代理对象可以在服务对象的基础上做增强，如记录日志、访问控制、缓存</p>

<h3 id="伪代码">伪代码</h3>

<p>本例演示如何使用<strong>代理</strong>模式在第三方腾讯视频 （TencentVideo， 代码示例中记为 TV） 程序库中添加延迟初始化和缓存</p>

<p><img src="\assets\images\2021\javabase\proxy-example-zh.png" alt="" /></p>

<p>程序库提供了视频下载类。 但是该类的效率非常低。 如果客户端程序多次请求同一视频， 程序库会反复下载该视频， 而不会将首次下载的文件缓存下来复用。</p>

<p>代理类实现和原下载器相同的接口， 并将所有工作委派给原下载器。 不过， 代理类会保存所有的文件下载记录， 如果程序多次请求同一文件， 它会返回缓存的文件</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1、远程服务接口。</span>
<span class="kd">interface</span> <span class="nc">ThirdPartyTVLib</span> <span class="n">is</span>
    <span class="n">method</span> <span class="nf">listVideos</span><span class="o">()</span>
    <span class="n">method</span> <span class="nf">getVideoInfo</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
    <span class="n">method</span> <span class="nf">downloadVideo</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>

<span class="c1">// 2、服务对象（目标对象）  </span>
<span class="c1">// 服务连接器的具体实现。该类的方法可以向腾讯视频请求信息。请求速度取决于</span>
<span class="c1">// 用户和腾讯视频的互联网连接情况。如果同时发送大量请求，即使所请求的信息</span>
<span class="c1">// 一模一样，程序的速度依然会减慢。</span>
<span class="kd">class</span> <span class="nc">ThirdPartyTVClass</span> <span class="kd">implements</span> <span class="nc">ThirdPartyTVLib</span> <span class="n">is</span>
    <span class="n">method</span> <span class="nf">listVideos</span><span class="o">()</span> <span class="n">is</span>
        <span class="c1">// 向腾讯视频发送一个 API 请求。</span>

    <span class="n">method</span> <span class="nf">getVideoInfo</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="n">is</span>
        <span class="c1">// 获取某个视频的元数据。</span>

    <span class="n">method</span> <span class="nf">downloadVideo</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="n">is</span>
        <span class="c1">// 从腾讯视频下载一个视频文件。</span>

<span class="c1">// 3、代理对象  </span>
<span class="c1">// 为了节省网络带宽，我们可以将请求结果缓存下来并保存一段时间。但你可能无</span>
<span class="c1">// 法直接将这些代码放入服务类中。比如该类可能是第三方程序库的一部分或其签</span>
<span class="c1">// 名是`final（最终）`。因此我们会在一个实现了服务类接口的新代理类中放入</span>
<span class="c1">// 缓存代码。当代理类接收到真实请求后，才会将其委派给服务对象。</span>
<span class="kd">class</span> <span class="nc">CachedTVClass</span> <span class="kd">implements</span> <span class="nc">ThirdPartyTVLib</span> <span class="n">is</span>
    <span class="kd">private</span> <span class="n">field</span> <span class="nl">service:</span> <span class="nc">ThirdPartyTVLib</span>
    <span class="kd">private</span> <span class="n">field</span> <span class="n">listCache</span><span class="o">,</span> <span class="n">videoCache</span>
    <span class="n">field</span> <span class="n">needReset</span>

    <span class="n">constructor</span> <span class="nf">CachedTVClass</span><span class="o">(</span><span class="nl">service:</span> <span class="nc">ThirdPartyTVLib</span><span class="o">)</span> <span class="n">is</span>
        <span class="k">this</span><span class="o">.</span><span class="na">service</span> <span class="o">=</span> <span class="n">service</span>

    <span class="n">method</span> <span class="nf">listVideos</span><span class="o">()</span> <span class="n">is</span>
        <span class="nf">if</span> <span class="o">(</span><span class="n">listCache</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">needReset</span><span class="o">)</span>
            <span class="n">listCache</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">listVideos</span><span class="o">()</span>
        <span class="k">return</span> <span class="n">listCache</span>

    <span class="n">method</span> <span class="nf">getVideoInfo</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="n">is</span>
        <span class="nf">if</span> <span class="o">(</span><span class="n">videoCache</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">needReset</span><span class="o">)</span>
            <span class="n">videoCache</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getVideoInfo</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
        <span class="k">return</span> <span class="n">videoCache</span>

    <span class="n">method</span> <span class="nf">downloadVideo</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="n">is</span>
        <span class="nf">if</span> <span class="o">(!</span><span class="n">downloadExists</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">||</span> <span class="n">needReset</span><span class="o">)</span>
            <span class="n">service</span><span class="o">.</span><span class="na">downloadVideo</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>

<span class="c1">// 4、管理类</span>
<span class="c1">// 之前直接与服务对象交互的 GUI 类不需要改变，前提是它仅通过接口与服务对</span>
<span class="c1">// 象交互。我们可以安全地传递一个代理对象来代替真实服务对象，因为它们都实</span>
<span class="c1">// 现了相同的接口。</span>
<span class="kd">class</span> <span class="nc">TVManager</span> <span class="n">is</span>
    <span class="kd">protected</span> <span class="n">field</span> <span class="nl">service:</span> <span class="nc">ThirdPartyTVLib</span>

    <span class="n">constructor</span> <span class="nf">TVManager</span><span class="o">(</span><span class="nl">service:</span> <span class="nc">ThirdPartyTVLib</span><span class="o">)</span> <span class="n">is</span>
        <span class="k">this</span><span class="o">.</span><span class="na">service</span> <span class="o">=</span> <span class="n">service</span>

    <span class="n">method</span> <span class="nf">renderVideoPage</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="n">is</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getVideoInfo</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
        <span class="c1">// 渲染视频页面。</span>

    <span class="n">method</span> <span class="nf">renderListPanel</span><span class="o">()</span> <span class="n">is</span>
        <span class="n">list</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">listVideos</span><span class="o">()</span>
        <span class="c1">// 渲染视频缩略图列表。</span>

    <span class="n">method</span> <span class="nf">reactOnUserInput</span><span class="o">()</span> <span class="n">is</span>
        <span class="nf">renderVideoPage</span><span class="o">()</span>
        <span class="n">renderListPanel</span><span class="o">()</span>

<span class="c1">// 5、客户端</span>
<span class="c1">// 程序可在运行时对代理进行配置。</span>
<span class="kd">class</span> <span class="nc">Application</span> <span class="n">is</span>
    <span class="n">method</span> <span class="nf">init</span><span class="o">()</span> <span class="n">is</span>
        <span class="n">aTVService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThirdPartyTVClass</span><span class="o">()</span>
        <span class="n">aTVProxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CachedTVClass</span><span class="o">(</span><span class="n">aTVService</span><span class="o">)</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TVManager</span><span class="o">(</span><span class="n">aTVProxy</span><span class="o">)</span>
        <span class="n">manager</span><span class="o">.</span><span class="na">reactOnUserInput</span><span class="o">()</span>      
      
</code></pre></div></div>

<p>这个代码示例是静态代理的方式。</p>

<h3 id="适合应用场景">适合应用场景</h3>

<ol>
  <li>
    <p>延迟初始化 （虚拟代理）。 如果你有一个偶尔使用的重量级服务对象， 一直保持该对象运行会消耗系统资源时， 可使用代理模式。</p>

    <p><mark>你无需在程序启动时就创建该对象， 可将对象的初始化延迟到真正有需要的时候。</mark></p>
  </li>
  <li>
    <p>访问控制 （保护代理）。 如果你只希望特定客户端使用服务对象， 这里的服务对象可以是操作系统中非常重要的部分， 而客户端则是各种已启动的程序 （包括恶意程序）， 此时可使用代理模式。</p>

    <p><mark>代理可仅在客户端凭据满足要求时将请求传递给服务对象。</mark></p>
  </li>
  <li>
    <p>本地执行远程服务 （远程代理）。 适用于服务对象位于远程服务器上的情形。</p>

    <p>在这种情形中， 代理通过网络传递客户端请求， 负责处理所有与网络相关的复杂细节。</p>
  </li>
  <li>
    <p>记录日志请求 （日志记录代理）。 适用于当你需要保存对于服务对象的请求历史记录时。 代理可以在向服务传递请求前进行记录。</p>
  </li>
  <li>
    <p>缓存请求结果 （缓存代理）。 适用于需要缓存客户请求结果并对缓存生命周期进行管理时， 特别是当返回结果的体积非常大时。</p>
  </li>
</ol>

<p>代理可对重复请求所需的相同结果进行缓存， 还可使用请求参数作为索引缓存的键值。</p>

<ol>
  <li>
    <p>智能引用。 可在没有客户端使用某个重量级对象时立即销毁该对象。</p>

    <p>代理会将所有获取了指向服务对象或其结果的客户端记录在案。 代理会时不时地遍历各个客户端， 检查它们是否仍在运行。 如果相应的客户端列表为空， 代理就会销毁该服务对象， 释放底层系统资源。像GC垃圾回收，原理是懂了但是落地实现，还是不懂。</p>

    <p>代理还可以记录客户端是否修改了服务对象。 其他客户端还可以复用未修改的对象。</p>
  </li>
</ol>

<h3 id="实现方式">实现方式</h3>

<ol>
  <li>如果没有现成的服务接口， 你就需要创建一个接口来实现代理和服务对象的可交换性。 从服务类中抽取接口并非总是可行的， 因为你需要对服务的所有客户端进行修改， 让它们使用接口。 <strong>备选计划是将代理作为服务类的子类， 这样代理就能继承服务的所有接口了</strong>，CGLIB就是使用类继承的方式实现动态创建代理类的。</li>
  <li>创建代理类， 其中必须包含一个存储指向服务的引用的成员变量。 通常情况下， 代理负责创建服务并对其整个生命周期进行管理。 在一些特殊情况下， 客户端会通过构造函数将服务传递给代理。</li>
  <li>根据需求实现代理方法。 在大部分情况下， 代理在完成一些任务后应将工作委派给服务对象。</li>
  <li>可以考虑新建一个构建方法来判断客户端可获取的是代理还是实际服务。 你可以在代理类中创建一个简单的静态方法， 也可以创建一个完整的工厂方法。</li>
  <li>可以考虑为服务对象实现延迟初始化。</li>
</ol>

<h3 id="优缺点">优缺点</h3>

<ul>
  <li>你可以在客户端毫无察觉的情况下控制服务对象。</li>
  <li>如果客户端对服务对象的生命周期没有特殊要求， 你可以对生命周期进行管理</li>
  <li>即使服务对象还未准备好或不存在， 代理也可以正常工作。</li>
  <li>开闭原则，你可以在不对服务或客户端做出修改的情况下创建新代理。</li>
</ul>

<h3 id="与其他模式的关系">与其他模式的关系</h3>

<ul>
  <li>
    <p><a href="https://refactoringguru.cn/design-patterns/adapter">适配器模式</a>能为被封装对象（目标对象，服务对象）提供不同的接口， <a href="https://refactoringguru.cn/design-patterns/proxy">代理模式</a>能为对象提供相同的接口， <a href="https://refactoringguru.cn/design-patterns/decorator">装饰模式</a>则能为对象提供加强的接口（目标对象和装饰器遵循同一接口）。</p>
  </li>
  <li><a href="https://refactoringguru.cn/design-patterns/facade">外观模式</a>与<a href="https://refactoringguru.cn/design-patterns/proxy">代理</a>的相似之处在于它们都缓存了一个复杂实体并自行对其进行初始化。 <em>代理</em>与其服务对象遵循同一接口， 使得自己和服务对象可以互换， 在这一点上它与外观不同。</li>
  <li><a href="https://refactoringguru.cn/design-patterns/decorator">装饰</a>和<a href="https://refactoringguru.cn/design-patterns/proxy">代理</a>有着相似的结构， 但是其意图却非常不同。 这两个模式的构建都基于组合原则， 也就是说一个对象应该将部分工作委派给另一个对象。 两者之间的不同之处在于<em>代理</em>通常自行管理其服务对象的生命周期， 而<em>装饰</em>的生成则总是由客户端进行控制。</li>
</ul>

<h3 id="代码示例">代码示例</h3>

<p>复杂度：2</p>

<p>流行度：1</p>

<p><strong>使用示例：</strong> 尽管代理模式在绝大多数 Java 程序中并不常见， 但它在一些特殊情况下仍然非常方便。 当你希望在无需修改客户代码的前提下于已有类的对象上增加额外行为时， 该模式是无可替代的。</p>

<p><strong>识别方法：</strong>代理模式会将所有实际工作委派给一些其他对象。 除非代理是某个服务的子类， 否则每个代理方法最后都应该引用一个服务对象。</p>

<blockquote>
  <p>缓存代理</p>
</blockquote>

<p>在本例中， 代理模式有助于实现延迟初始化， 并对低效的第三方 YouTube 集成程序库进行缓存</p>

<p>1)<strong>some_cool_media_library/ThirdPartyYouTubeLib.java:</strong>  远程服务接口</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">refactoring_guru</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">some_cool_media_library</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ThirdPartyYouTubeLib</span> <span class="o">{</span>
    <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;</span> <span class="nf">popularVideos</span><span class="o">();</span>

    <span class="nc">Video</span> <span class="nf">getVideo</span><span class="o">(</span><span class="nc">String</span> <span class="n">videoId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2) <strong>some_cool_media_library/ThirdPartyYouTubeClass.java:</strong>  远程服务实现</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThirdPartyYouTubeClass</span> <span class="kd">implements</span> <span class="nc">ThirdPartyYouTubeLib</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;</span> <span class="nf">popularVideos</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">connectToServer</span><span class="o">(</span><span class="s">"http://www.youtube.com"</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">getRandomVideos</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Video</span> <span class="nf">getVideo</span><span class="o">(</span><span class="nc">String</span> <span class="n">videoId</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">connectToServer</span><span class="o">(</span><span class="s">"http://www.youtube.com/"</span> <span class="o">+</span> <span class="n">videoId</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">getSomeVideo</span><span class="o">(</span><span class="n">videoId</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// -----------------------------------------------------------------------</span>
  <span class="c1">// Fake methods to simulate network activity. They as slow as a real life.</span>

  <span class="kd">private</span> <span class="kt">int</span> <span class="nf">random</span><span class="o">(</span><span class="kt">int</span> <span class="n">min</span><span class="o">,</span> <span class="kt">int</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">min</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">*</span> <span class="o">((</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">experienceNetworkLatency</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">randomLatency</span> <span class="o">=</span> <span class="n">random</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">randomLatency</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">connectToServer</span><span class="o">(</span><span class="nc">String</span> <span class="n">server</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Connecting to "</span> <span class="o">+</span> <span class="n">server</span> <span class="o">+</span> <span class="s">"... "</span><span class="o">);</span>
    <span class="n">experienceNetworkLatency</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Connected!"</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;</span> <span class="nf">getRandomVideos</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Downloading populars... "</span><span class="o">);</span>

    <span class="n">experienceNetworkLatency</span><span class="o">();</span>
    <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;</span> <span class="n">hmap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;();</span>
    <span class="n">hmap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"catzzzzzzzzz"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Video</span><span class="o">(</span><span class="s">"sadgahasgdas"</span><span class="o">,</span> <span class="s">"Catzzzz.avi"</span><span class="o">));</span>
    <span class="n">hmap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mkafksangasj"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Video</span><span class="o">(</span><span class="s">"mkafksangasj"</span><span class="o">,</span> <span class="s">"Dog play with ball.mp4"</span><span class="o">));</span>
    <span class="n">hmap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"dancesvideoo"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Video</span><span class="o">(</span><span class="s">"asdfas3ffasd"</span><span class="o">,</span> <span class="s">"Dancing video.mpq"</span><span class="o">));</span>
    <span class="n">hmap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"dlsdk5jfslaf"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Video</span><span class="o">(</span><span class="s">"dlsdk5jfslaf"</span><span class="o">,</span> <span class="s">"Barcelona vs RealM.mov"</span><span class="o">));</span>
    <span class="n">hmap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"3sdfgsd1j333"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Video</span><span class="o">(</span><span class="s">"3sdfgsd1j333"</span><span class="o">,</span> <span class="s">"Programing lesson#1.avi"</span><span class="o">));</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Done!"</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">hmap</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">Video</span> <span class="nf">getSomeVideo</span><span class="o">(</span><span class="nc">String</span> <span class="n">videoId</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Downloading video... "</span><span class="o">);</span>

    <span class="n">experienceNetworkLatency</span><span class="o">();</span>
    <span class="nc">Video</span> <span class="n">video</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Video</span><span class="o">(</span><span class="n">videoId</span><span class="o">,</span> <span class="s">"Some video title"</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Done!"</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">video</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>some_cool_media_library/Video.java: 视频文件</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Video</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="n">data</span><span class="o">;</span>

  <span class="nc">Video</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="s">"Random video."</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>代理Proxy</p>

<p>3)  <strong>proxy/YouTubeCacheProxy.java:</strong>  缓存代理</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">YouTubeCacheProxy</span> <span class="kd">implements</span> <span class="nc">ThirdPartyYouTubeLib</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">ThirdPartyYouTubeLib</span> <span class="n">youtubeService</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;</span> <span class="n">cachePopular</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;();</span>
  <span class="kd">private</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;</span> <span class="n">cacheAll</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;();</span>

  <span class="kd">public</span> <span class="nf">YouTubeCacheProxy</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">youtubeService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThirdPartyYouTubeClass</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;</span> <span class="nf">popularVideos</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cachePopular</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">cachePopular</span> <span class="o">=</span> <span class="n">youtubeService</span><span class="o">.</span><span class="na">popularVideos</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Retrieved list from cache."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">cachePopular</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Video</span> <span class="nf">getVideo</span><span class="o">(</span><span class="nc">String</span> <span class="n">videoId</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Video</span> <span class="n">video</span> <span class="o">=</span> <span class="n">cacheAll</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">videoId</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">video</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">video</span> <span class="o">=</span> <span class="n">youtubeService</span><span class="o">.</span><span class="na">getVideo</span><span class="o">(</span><span class="n">videoId</span><span class="o">);</span>
      <span class="n">cacheAll</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">videoId</span><span class="o">,</span> <span class="n">video</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Retrieved video '"</span> <span class="o">+</span> <span class="n">videoId</span> <span class="o">+</span> <span class="s">"' from cache."</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">video</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reset</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">cachePopular</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">cacheAll</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>4) <strong>downloader/YouTubeDownloader.java:</strong>  媒体下载应用</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">YouTubeDownloader</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">ThirdPartyYouTubeLib</span> <span class="n">api</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">YouTubeDownloader</span><span class="o">(</span><span class="nc">ThirdPartyYouTubeLib</span> <span class="n">api</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">api</span> <span class="o">=</span> <span class="n">api</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">renderVideoPage</span><span class="o">(</span><span class="nc">String</span> <span class="n">videoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Video</span> <span class="n">video</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="na">getVideo</span><span class="o">(</span><span class="n">videoId</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n-------------------------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Video page (imagine fancy HTML)"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ID: "</span> <span class="o">+</span> <span class="n">video</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Title: "</span> <span class="o">+</span> <span class="n">video</span><span class="o">.</span><span class="na">title</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Video: "</span> <span class="o">+</span> <span class="n">video</span><span class="o">.</span><span class="na">data</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------------------------------\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">renderPopularVideos</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Video</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="na">popularVideos</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n-------------------------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Most popular videos on YouTube (imagine fancy HTML)"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Video</span> <span class="n">video</span> <span class="o">:</span> <span class="n">list</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ID: "</span> <span class="o">+</span> <span class="n">video</span><span class="o">.</span><span class="na">id</span> <span class="o">+</span> <span class="s">" / Title: "</span> <span class="o">+</span> <span class="n">video</span><span class="o">.</span><span class="na">title</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------------------------------\n"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>5) Demo测试</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Demo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">YouTubeDownloader</span> <span class="n">naiveDownloader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">YouTubeDownloader</span><span class="o">(</span><span class="k">new</span> <span class="nc">ThirdPartyYouTubeClass</span><span class="o">());</span>
    <span class="nc">YouTubeDownloader</span> <span class="n">smartDownloader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">YouTubeDownloader</span><span class="o">(</span><span class="k">new</span> <span class="nc">YouTubeCacheProxy</span><span class="o">());</span>

    <span class="kt">long</span> <span class="n">naive</span> <span class="o">=</span> <span class="n">test</span><span class="o">(</span><span class="n">naiveDownloader</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">smart</span> <span class="o">=</span> <span class="n">test</span><span class="o">(</span><span class="n">smartDownloader</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Time saved by caching proxy: "</span> <span class="o">+</span> <span class="o">(</span><span class="n">naive</span> <span class="o">-</span> <span class="n">smart</span><span class="o">)</span> <span class="o">+</span> <span class="s">"ms"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">test</span><span class="o">(</span><span class="nc">YouTubeDownloader</span> <span class="n">downloader</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="c1">// User behavior in our app:</span>
    <span class="n">downloader</span><span class="o">.</span><span class="na">renderPopularVideos</span><span class="o">();</span>
    <span class="n">downloader</span><span class="o">.</span><span class="na">renderVideoPage</span><span class="o">(</span><span class="s">"catzzzzzzzzz"</span><span class="o">);</span>
    <span class="n">downloader</span><span class="o">.</span><span class="na">renderPopularVideos</span><span class="o">();</span>
    <span class="n">downloader</span><span class="o">.</span><span class="na">renderVideoPage</span><span class="o">(</span><span class="s">"dancesvideoo"</span><span class="o">);</span>
    <span class="c1">// Users might visit the same page quite often.</span>
    <span class="n">downloader</span><span class="o">.</span><span class="na">renderVideoPage</span><span class="o">(</span><span class="s">"catzzzzzzzzz"</span><span class="o">);</span>
    <span class="n">downloader</span><span class="o">.</span><span class="na">renderVideoPage</span><span class="o">(</span><span class="s">"someothervid"</span><span class="o">);</span>

    <span class="kt">long</span> <span class="n">estimatedTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Time elapsed: "</span> <span class="o">+</span> <span class="n">estimatedTime</span> <span class="o">+</span> <span class="s">"ms\n"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">estimatedTime</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>



            <div>
   <!-- <p align="center">
     	  
         <img src="/assets/images/keeppuresmile.jpg" >
         <br/>
         微信扫描二维码，关注一个有故事的程序员
        

   </p>
   <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
       <strong>（转载本站文章请注明作者和出处 <a href="http://www.ityouknow.com">纯洁的微笑-ityouknow</a>）</strong>
   </p>
   <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
       <strong><a href="http://www.justdojava.com/" target="_blank">点击了解 ：Java 技术人的网站</a></strong>
   </p> -->
</div>

            <!-- Comments -->
            <div class="comment">
             

  

  
        <div id="gitalk-container"></div>
        <script src="/assets/js/gitalk.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> -->
        <script>
        var gitalk = new Gitalk({
            id: '/design-mode/2020/05/03/3-java-proxy-mode.html',
            clientID: '6cd8ad4d1cf1d1e6ad95',
            clientSecret: 'c4ce22a25efe50bfd60da67c990b534bc99a6424',
            repo: 'aikomj.github.io',
            owner: 'aikomj',
            admin: ['aikomj'],
            labels: ['gitalk'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>
     <!--<div class="asb-post-01">-->
        <!--<div class="mask"></div>-->
            <!--<div class="info">-->
                <!--<div>扫码关注公众号：<span style="color: #E9405A; font-weight: bold;">纯洁的微笑</span></div>-->
            <!--<div>-->
            <!--<span>发送 </span><span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;">290992</span>-->
            <!--<div>-->
                <!--即可<span style="color: #e9415a; font-weight: bold;">立即永久</span>解锁本站全部文章-->
            <!--</div>-->
            <!--<img class="code-img" style="width: 300px;display:unset" src="/assets/images/keeppuresmile.jpg">-->
        <!--</div>-->
    <!--</div>-->
</article>

        </div>

    
<footer class="container">
    <div class="site-footer">
       <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/ityouknow">
               微博
            </a>
            <a target="_blank" href="https://github.com/ityouknow">
                GitHub
            </a>
        </div> -->
        <!-- <div class="card text-center">
            <ul class="list-inline" style="margin-left: 0;">
               <li>
                <a target="_blank" href="https://github.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a target="_blank" href="https://www.zhihu.com/people/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                  </span>
                </a>
              </li>
                  <li>
                <a target="_blank" href="https://weibo.com/ityouknow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          </ul>
        </div> -->
        <div class="site-footer-links mobile-hidden">
            
        </div>
        <div class="scrolltop">
            <a href="javascript:window.scrollTo(0,0)" >TOP</a>
        </div>
        <div class="rss">
            <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
            Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
        </div>
    </div>
    <!-- Third-Party JS -->
    <script type="text/javascript" src="/bower_components/geopattern/js/geopattern.min.js"></script>
    <!-- My JS -->
    <script type="text/javascript" src="/assets/js/script.js"></script>
    
    
     <!-- Cnzz Analytics -->
       <div style="display:none">
         <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260945749'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260945749' type='text/javascript'%3E%3C/script%3E"));</script>
       </div>
     <!-- Cnzz Analytics -->
</footer>


    </body>

</html>
