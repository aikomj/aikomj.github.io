---
layout: post
title: 飞天班第10节：SpringBoot开发单体应用（中）
category: icoding-edu
tags: [icoding-edu]
keywords: springboot
excerpt: 页面国际化配置，登录拦截器，前端Thymeleaf页面的CRUD操作
lock: noneed
---

## 1、页面国际化

### 新增国际化配置文件

idea首先要保证文件编码是UTF8

![](/assets/images/2020/icoding/springboot/file-encode-utf8.jpg)

K8s(kubernetes) 中间有8个字母

i18n(internationalization 国际化) 中间有18个字母 ，在项目中建一个i18n文件夹，表示国际化配置

在resource目录下建一个i18n文件夹，并在该文件下建一个login.properties文件

![](/assets/images/2020/icoding/springboot/i18n-properties.jpg)

再建一个中文的配置文件login_zh_CN.properties

![](/assets/images/2020/icoding/springboot/i18n-properties-2.jpg)

<mark>注意文件夹的变化，IDEA自动帮我们识别了国际化配置文件</mark>

这时候我们就可以快速的配置其他语言的配置文件了，如下图右键

![](/assets/images/2020/icoding/springboot/i18n-properties-3.jpg)

弹框中，点击加号

![](/assets/images/2020/icoding/springboot/i18n-properties-4.jpg)

![](/assets/images/2020/icoding/springboot/i18n-properties-5.jpg)

这时候我们发现已经添加类en_US 英文配置文件

### 配置键值对

我们给这三个配置文件加一个属性，点击下图中添加按钮，然后再点击`Resource Bundle`视图

![](/assets/images/2020/icoding/springboot/i18n-login-1.jpg)

![](/assets/images/2020/icoding/springboot/i18n-login-2.jpg)

继续配置其他属性，最终完成的效果：

![](/assets/images/2020/icoding/springboot/i18n-login-3.jpg)

![](/assets/images/2020/icoding/springboot/i18n-login-4.jpg)

**如果是一整个完整的页面，文章量十分大的时候，没必要做这些细节的国际化操作**，直接路由到两个不同语言的页面就好。

> 1、Thymeleaf配置国际化

看官方文档，我们知道使用#来获取国际化的配置变量值

```sh
Message Expressions: #{…} 国际化内容获取！
```

> 2、还需要让项目识别我们的国际化配置

首先我们全局搜索`MessageSourceAutoConfiguration` 分析源码，它是国际化消息读取的自动配置类

每一个AutoConfiguration都会绑定一个Properties，Properties绑定到我们的application.properties配置文件，所以我们可以在application.properties修改配置属性

![](/assets/images/2020/icoding/springboot/i18n-messageSourceAutoconfiguration.jpg)

```java
@Bean
public MessageSource messageSource(MessageSourceProperties properties) {
  ResourceBundleMessageSource messageSource = new ResourceBundleMessageSource();
  if (StringUtils.hasText(properties.getBasename())) {
    messageSource.setBasenames(StringUtils
                               .commaDelimitedListToStringArray(StringUtils.trimAllWhitespace(properties.getBasename())));
  }
  // 获取properties的编码信息
  if (properties.getEncoding() != null) {
    messageSource.setDefaultEncoding(properties.getEncoding().name());
  }
  messageSource.setFallbackToSystemLocale(properties.isFallbackToSystemLocale());
  Duration cacheDuration = properties.getCacheDuration();
  if (cacheDuration != null) {
    messageSource.setCacheMillis(cacheDuration.toMillis());
  }
  messageSource.setAlwaysUseMessageFormat(properties.isAlwaysUseMessageFormat());
  messageSource.setUseCodeAsDefaultMessage(properties.isUseCodeAsDefaultMessage());
  return messageSource;
}
```

这里我们需要在application.properties配置`MessageSourceProperties`的basename属性

```properties
# 配置绑定国际化的login路径,不加classpath,默认从根路径resource下读取
spring.messages.basename=i18n.login
```

配置完后，可以在我们的前端页面看到提示，如我们这里的login.html显示了前面配置的国际化信息

![](/assets/images/2020/icoding/springboot/i18n-login-5.jpg)

把前端内容填写完毕，重新启动项目，刷新页面，

![](/assets/images/2020/icoding/springboot/i18n-login-6.jpg)

原理，请求头带有语言信息 Accept-Language

![](/assets/images/2020/icoding/springboot/i18n-login-7.jpg)



### 动态切换

理想效果，可以通过点击按钮实现动态切换

以Duubo官网为例

中文：[https://dubbo.apache.org/zh/](https://dubbo.apache.org/zh/)

英文：[https://dubbo.apache.org/en/](https://dubbo.apache.org/en)

可以发现是通过不同链接来实现国际化映射的！

在Spring中，有一个国际化对象Locale，它是Java的一个原生对象！我们在`WebMvcAutoConfiguration`自动配置类中，搜索locale

![](/assets/images/2020/icoding/springboot/i18n-locale-resolver.jpg)

发现Springboot  帮我们自动注入了国际化的组件 localResolver

```java
@Bean
@ConditionalOnMissingBean // 不存在这个bean才生效
@ConditionalOnProperty(prefix = "spring.mvc", name = "locale")
public LocaleResolver localeResolver() {
  // 如果用户没配置国际化解析对象，就使用默认的
  if (this.mvcProperties.getLocaleResolver() == WebMvcProperties.LocaleResolver.FIXED) {
    return new FixedLocaleResolver(this.mvcProperties.getLocale());
  }
  // 否则，使用接受请求头关于国际化的对象
  AcceptHeaderLocaleResolver localeResolver = new AcceptHeaderLocaleResolver();
  localeResolver.setDefaultLocale(this.mvcProperties.getLocale());
  return localeResolver;
}
```

重点在`AcceptHeaderLocaleResolver`，点击它的源码

![](/assets/images/2020/icoding/springboot/i18n-locale-resolver-2.jpg)

它实现了`LocalResolver`接口，我们找到它重写的方法（看一个类的3个主要地方：构造函数、init方法、重写方法）

```java
@Override
public Locale resolveLocale(HttpServletRequest request) {
  Locale defaultLocale = getDefaultLocale();
  // 从request请求中获取Accept-Language的语言信息
  if (defaultLocale != null && request.getHeader("Accept-Language") == null) {
    return defaultLocale; // 返回默认的国际化对象
  }
  Locale requestLocale = request.getLocale(); // 得到请求中的国际化信息
  List<Locale> supportedLocales = getSupportedLocales();
  if (supportedLocales.isEmpty() || supportedLocales.contains(requestLocale)) {
    return requestLocale; // 返回请求的国际化对象
  }
  Locale supportedLocale = findSupportedLocale(request, supportedLocales);
  if (supportedLocale != null) {
    return supportedLocale; // 返回支持的国际化对象，具体看源码中的findSupportedLocale方法
  }
  return (defaultLocale != null ? defaultLocale : requestLocale);
}
```

我们要定义一个国际化请求解析器，让Spring使用我们请求的国际化解析器

1、修改前端页面的点击链接

```html
<!-- localhost:8080/index?l=zh_CN thymeleaf中传递参数不用使用? 使用（）-->
<a class="btn btn-sm" th:href="@{/index(l='zh_CN')}">中文</a>
<a class="btn btn-sm" th:href="@{/index(l='en_US')}">English</a>
```

2、实现`LocalResolver`接口

点击`Locale`，看源码里有很多已经定义的国家和语言

![](/assets/images/2020/icoding/springboot/i18n-locale-1.jpg)

看构造函数

```java
public Locale(String language) {
  this(language, "", "");
}
public Locale(String language, String country) {
  this(language, country, "");
}
/**
     * This method must be called only for creating the Locale.*
     * constants due to making shortcuts.
     */
private static Locale createConstant(String lang, String country) {
  BaseLocale base = BaseLocale.createInstance(lang, country);
  return getInstance(base, null);
}
```

自定义国家化处理器

```java
public class MyLocaleResolver implements LocaleResolver {
	@Override
	public Locale resolveLocale(HttpServletRequest request) {
		String language = request.getParameter("l");
		Locale locale = Locale.getDefault(); // 如果我们没有配置，就使用默认的
		if(!StringUtils.isEmpty(language)){
			String[] split = language.split("_");
			locale = new Locale(split[0],split[1]); // 创建国际化对象
		}

		return locale;
	}

	@Override
	public void setLocale(HttpServletRequest request, HttpServletResponse response, Locale locale) {

	}
}
```

3、注册到spring容器中

```java
@Configuration
public class MyMvcConfig implements WebMvcConfigurer {

	@Override
	public void addViewControllers(ViewControllerRegistry registry) {
		// 视图跳转的控制！
		registry.addViewController("/index").setViewName("login2");
		registry.addViewController("/").setViewName("login2");
		registry.addViewController("/index.html").setViewName("login2");
	}

  // 注意bean的id 只能为localeResolver，因为Springboot会去扫描并识别
	@Bean
	public LocaleResolver localeResolver(){
		return new MyLocaleResolver();
	}
}

```

重启项目，点击测试

![](/assets/images/2020/icoding/springboot/i18n-locale-2.jpg)

## 拦截登录





















源码：[https://gitee.com/jacobmj/study-demo/tree/master/jacob-single-app](https://gitee.com/jacobmj/study-demo/tree/master/jacob-single-app)