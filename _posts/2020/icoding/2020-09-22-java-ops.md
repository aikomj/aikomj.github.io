---
layout: post
title: JAVA 线上故障排查完整套路，从 CPU、磁盘、内存、网络、GC 一条龙
category: java
tags: [java]
keywords: jvm
excerpt: 线上故障主要会包括cpu、磁盘、内存以及网络问题
lock: noneed
---

## 1、CPU

一般来讲我们首先会排查cpu方面的问题。cpu异常往往还是比较好定位的。原因包括业务逻辑问题(死循环)、频繁gc以及上下文切换过多。而最常见的往往是业务逻辑(或者框架逻辑)导致的，可以使用jstack来分析对应的堆栈情况。



### 使用jstack分析cpu问题

```sh
[ccslog@mvxl1842 22]$ top -H
```

注意看是command列是java

![](\assets\images\2020\java\top-java.jpg)

```sh
# 转nid
[ccslog@mvxl1842 22]$ printf '%x\n' 66
42
# 查看堆栈信息
[ccslog@mvxl1842 22]$ jstack pid |grep '0x42' -C5
```

![](\assets\images\2020\java\top-java-2.jpg)



### 频繁GC

我们可以先确定下gc是不是太频繁

```sh
# 格式，1000表示采样间隔(ms)，pid是java进程id，可以通过jps命令获取，或者top命令获取
jstat -gc pid 1000
```

- S0C/S1C、S0U/S1U、EC/EU、OC/OU、MC/MU分别代表两个Survivor区、Eden区、老年代、元数据区的容量和使用量。

- YGC/YGT、FGC/FGCT、GCT则代表YoungGc、FullGc的耗时和次数以及总耗时

![](\assets\images\2020\java\top-java-3.jpg)

### 上下文切换

针对频繁上下文问题，我们可以使用vmstat命令来进行查看

```sh
[ccslog@mvxl1842 22]$ vmstat pid 
# cs(context switch)一列则代表了上下文切换的次数。
```

![](\assets\images\2020\java\top-java-4.jpg)

```sh
# 对特定的pid进行监控,cswch和nvcswch表示自愿及非自愿切换
[ccslog@mvxl1842 22]$ pidstat -w pid 
```



## 2、磁盘

```sh
# 查看空间
df -hl
# 更多时候是性能上的问题，
iostat -d -k -x 1
```

最后一列%util可以看到每块磁盘写入的程度，而rrqpm/s以及wrqm/s分别表示读写速度



## 3、内存

我们会先用free命令先来检查一发内存的各种情况。

![](\assets\images\2020\java\top-java-6.jpg)

### 堆内存

通常就是OOM，有6中情况

- java.lang.StackOverflowError

  栈内存溢出，对应-Xss参数设置的栈大小

- java.lang.OutOfMemoryError: Java heap space

  堆内存溢出，这个意思是堆的内存占用已经达到-Xmx设置的最大值，应该是最常见的OOM错误了。解决思路仍然是先应该在代码中找，怀疑存在内存泄漏，通过jstack和jmap去定位问题。如果说一切都正常，才需要通过调整Xmx的值来扩大内存。

- java.lang.OutOfMemoryError: Metaspace 元空间报错

  这个意思是元数据区的内存占用已经达到XX:MaxMetaspaceSize设置的最大值，排查思路和上面的一致，参数方面可以通过XX:MaxPermSize来进行调整(这里就不说1.8以前的永久代了)。

- java.lang.OutOfMemoryError: unable to create  native Thread

  高并发下，线程开太多，没有内存空间分配

  基本上还是线程池代码写的有问题，比如说忘记shutdown，所以说应该首先从代码层面来寻找问题，使用jstack或者jmap。如果一切都正常，JVM方面可以通过指定Xss来减少单个thread stack的大小。

  系统层面，可以通过修改/etc/security/limits.confnofile和nproc来增大os对线程的限制

#### 使用JMAP定位代码内存泄漏

```sh
jmap -dump:format=b,file=filename pid来导出dump文件
```



