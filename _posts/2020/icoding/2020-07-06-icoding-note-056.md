---
layout: post
title: 飞天班第56节：分布式事务
category: icoding-edu
tags: [mysql]
keywords: mysql
excerpt: CAP原理的解析，ACID原理与BASE原理，XA实现两阶段协议的分布式事务
lock: noneed
---

## 前言：分布式事务

在传统的数据库操作中，数据库本身就提供了ACID的相关特性操作，但是由于业务数据增大数据压力导致我们不得不将数据分到多个表中，如果还在一个库里还可以使用ACID原则，只要两个分在不同的数据库上ACID原则就不能实现，数据就会出现不一致。

**要掌握分布式事务需要了解以下的概念**

- CAP原理
- ACID原理与BASE原理
- 基于XA协议的两阶段提交：在实际应用中因为提交过程比较复杂，如果提交中间出现失败就会导致数据库刮起状态
- 事务补偿机制（TCC），符号<mark>ACID原理</mark>
  - 理解起来非常简单，实现比较复杂
  - 操作多个数据库时，一个成功了一个失败了，成功的数据库要有一个补偿接口进行失败的回滚，让数据恢复到最初操作

- 基于本地消息的最终一致性（对外对接应用，直接使用http访问和数据库结合进行消息补偿），<mark>符号BASE原理</mark>
- 基于MQ消息队列的最终一致性（最后用上人工补偿），<mark>符号BASE原理</mark>

> eg：recive money 收钱（支付模块）-> insert order 下订单(订单模块) ，add point 加积分（用户积分模块） ，减库存（仓储模块）
>
> 不能使用强一致性，只能基于MQ实现最终一致性，使用多线程不安全（如果线程任务失败无法重来），使用消息队列，消息消费失败进入死信对列，需要人工干预补偿

## 1. CAP原理的解析

- C-Consistent，一致性，具体是指操作成功后，所有的节点在同一时间看到数据完全一致，所以一致性就是指数据一致性（典型是Zookeeper,它会让等待所有节点的数据一致时，才让你查询到，例如A节点往B节点同步数据，一个请求路由到B节点查询新增的数据，是查询不到它会让你等待直到B同步完数据 ）
- A-Availability，可用性，指服务一致可用，在规定时间内完成响应（典型是Eureka）
- P-Partition tolerance，分区容错性，指分布式系统在遇到某个节点或网络分区故障的时候，依旧可以对外提供服务

CAP原则只能满足其中两项：CP、AP

我们在使用分布式系统的时候就是为了满足某个节点不可用的情况下，系统还能对外服务，这正是P的体现，<font color=red>如果服务不满足P的话就不是一个分布式系统，在分布式系统中P总是成立的</font>

分布式系统，那么A和C能不能同时满足呢？不能

client轮询访问A和B，A ---> B同步的过程中

- 能同时访问A和B，那么就是保证可用性A，但这时A和B的数据是不一样的。
- 如何要保证访问A和B都能得到一样的数据，那么就必须等待数据同步完成，等待的过程中，服务对外是不可用的，就是不能访问A也不能访问B，直到数据同步完成对外服务才可用，那么就是保证一致性C
- 所以A和C是不能同时满足的

## 2. ACID与BASE

在关系型数据库中，最大的特点就是事务处理，也就是ACID

- A 原子性
- C 一致性
- I 隔离性
- D 持久性

<mark>ACID强调的是强一致性，要么全做，要么全不做</mark>，传统的数据库都有ACID的特性，在CAP原理中，保证的是CA(可用和一致，就是说可用的时候一定是一种的数据 )，在分布式系统流行的今天，ACID在逐步向BASE转换

**BASE是 Basically Availiable（基本可用），Soft-state（软状态），Eventually consistent（最终一致性）**

- Basically Availiable（基本可用）：分布式系统在出现故障的情况下，允许损失部分可用性，保障核心可用
- **Soft-state（软状态）：就是指系统允许出现中间状态**，该中间状态不会影响系统的整体可用性，分布式存储中一般一份数据会有两到三个副本，允许不同副本间数据的同步延时就是软状态的体现。Mysql的主从复制也就是软状态的体现
- Eventually consistent（最终一致性）：所有的数据副本经过一段时间，最终能够达到一致性，弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况

BASE模型是传统ACID模型的发面，不同与ACID，BASE强调牺牲高一致性，从而获得可用性，数据允许在一段时间内不一致，但最终保持一致就行。

> TCC 事务补偿机制 ，Try Confirm Cancle

TCC是ACID的，保证强一致性 ，操作多个数据库时，一个成功了一个失败了，成功的数据库要有一个补偿接口进行失败的回滚，让数据恢复到最初操作。



## 3. XA实现两阶段协议的分布式事务

**什么是2PC**(prepare commit)

- 2PC就是两阶段提交协议，将数据库的事务提交分为两个阶段，准备阶段prepare phase，提交阶段commit phase，P是准备节点，C是提交阶段

**XA方案**

- XA是由X/Open组织提出的分布式事务规范
- 整体是由一个事务管理器（TM）和多个资源管理器（RM）组成
  - RM一般就是数据库
  - TM就相当于程序中的数据源
- 提交分为两个阶段：prepare/commit

### 3.1. 第一阶段

![](/Users/xjw/Documents/code/aikomj.github.io/assets/images/2020/icoding/mysql/xa-1.png)

TM会询问所有的数据库，如果都是ready了才commit，如果其中一个不ready所有都回滚

### 3.2. 第二阶段

![](/Users/xjw/Documents/code/aikomj.github.io/assets/images/2020/icoding/mysql/xa-2.png)

如果到了第二阶段，第一个commit了，第二个无法commit，这个时候第一个commit就不能回滚了，这个时候就需要人工干预了，进行补偿

**XA两阶段提交方式的总结：**

- 保证数据的强一致性
- commit阶段出现问题，事务出现不一致，需要人工干预
- <mark>XA方式效率比较低，性能与本地事务相差10倍</mark>
  - 准备阶段TM给所有的数据库送指令并接受反馈(同步)，提交阶段也是，自然效率就低下了

- MySQL v5.7及以上版本均支持XA协议
- mysql-connector-java驱动v5.0以上版本支持XA协议
- Java系统中，数据源可以采用Atomikos充当TM的角色

