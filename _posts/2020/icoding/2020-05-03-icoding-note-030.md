---
layout: post
title: 飞天班第30节：整合Nacos
category: icoding-edu
tags: [icoding-edu]
keywords: springcloud
excerpt: 集成Nacos服务注册发现与配置中心，Feign服务调用删除云端视频，集成Hystrix实现服务降级
lock: noneed
---

## 1、Nacos

### 基本概念

官网：[https://nacos.io/zh-cn/docs/quick-start.html](https://nacos.io/zh-cn/docs/quick-start.html)

GitHub: [https://github.com/alibaba/nacos](https://github.com/alibaba/nacos)

Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。

> 常见的注册中心

- Eureka 原生，出了2.x版本后不再维护了
- Zookeeper（支持、专业级的独立产品，Dubbo）
- Consul （Go语言），使用参考我这篇[博客](http://139.199.13.139/blog/springcloud/2019/12/19/springcloud-consul.html)
- Nacos



Nacos的主要功能

1、服务发现和服务健康监测（）

2、动态配置服务

3、动态DNS服务

4、服务及元数据管理

一图看懂:

![](/assets/images/2020/icoding/project-build/nacosMap.jpg)

架构图：

![](/assets/images/2020/icoding/project-build/nacos-arch.jpeg)

### 下载安装

Nacos依赖于Java环境，所以必须安装Java环境。然后从官网下载Nacos的解压包，安装稳定版的，下载地址：[https://github.com/alibaba/nacos/releases](https://github.com/alibaba/nacos/releases)

目前最新版本是1.2.1

![](/assets/images/2020/icoding/project-build/nacos-1.2.1.gif)

解压后文件的/bin目录下，windows系统点击startup.cmd就可以启动nacos。linux或mac执行以下命令启动nacos。

![](/assets/images/2020/icoding/project-build/nacos-bin.gif)

```shell
# standalone表示非集群模式,在没有参数模式，是集群模式
sh startup.sh -m standalone
# 关闭
sh shutdown.sh
```

nacos的启动端口为8848,在启动时要保证端口不被占用。
启动成功，在浏览器上访问：http://localhost:8848/nacos 会跳转到登陆界面，

默认的登陆用户名密码都是nacos : nacos。

![](/assets/images/2020/icoding/project-build/nacos-console.png)

集群模式参考官方文档配置[https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html](https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html)



### 服务注册

edu-edu和edu-vod 俩个服务都注册到nacos

1、pom.xml导入依赖

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    <version>0.9.0.RELEASE</version>
</dependency>
```

2、配置文件appliation.properties增加nacos server地址配置

```properties
spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848
```

3、启动类开启注解@EnableDiscoveryClient

```java
// @EnableEurekaClient 只有Eureka可以用
// 通过 Spring Cloud 原生注解 @EnableDiscoveryClient 开启服务注册发现功能
@SpringBootApplication
@ComponentScan(basePackages = {"com.coding.edu","com.coding.common"})
@EnableDiscoveryClient
public class EduApplication {
    public static void main(String[] args) {
        SpringApplication.run(EduApplication.class,args);
    }
}
```

4、启动测试，成功注册到nacos

![](/assets/images/2020/icoding/project-build/nacos-service.gif)



### 配置中心

回看自己写的这篇[博客](http://139.199.13.139/blog/springcloud/2019/12/18/springcloud-nacos-config.html)



## 2、Feign调用删除阿里云视频

任务：edu 服务 feign调用vod服务删除阿里云上的视频

回顾Feign：

- 声明式、模板化、Http客户端！    作用： 微服务之间调用HTTP api！
- Ribbon（负载均衡，客户端），Hystrix （服务降级！） 无缝集成这两个！

1、edu-edu的pom.xml添加依赖
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

2、edu-edu的主启动类添加 Feign的支持注解@EnableFeignClients
```java
@SpringBootApplication
@ComponentScan(basePackages = {"com.jude.edu","com.jude.common"})
@EnableDiscoveryClient 
@EnableFeignClients
public class EduApplication {
	public static void main(String[] args) {
		SpringApplication.run(EduApplication.class,args);
	}
}
```

3、edu-edu的feign接口VodClient
```java
@FeignClient(name = "edu-vod")
public interface VodClient {
	// 直接调用服务中的请求
	@DeleteMapping("/admin/vod/video/{videoId}")
	R removeVideo(@PathVariable("videoId") String videoId);
}
```

4、edu-edu的业务层接口VideoService
```java
void removeVideoById(String id);
```
接口实现类VideoServiceImpl
```java
@Autowired
VodClient vodClient;

@Override
public void removeVideoById(String id) {
    Video video = this.getById(id);
    // 删除oss上的视频
    String sourceId = video.getVideoSourceId();
    if (!StringUtils.isEmpty(sourceId)){
        // 调用vod微服务的方法，删除云端视频
        R r = vodClient.removeVideo(sourceId);
        if (r.getCode()!= 20000) { // 返回结果不是ok
            throw new JudeException(r.getCode(),r.getMessage());
        }
    }

    this.removeById(id);
}
```

5、edu-eud web层接口的定义
```java
@ApiOperation(value = "根据id删除课时节点")
@DeleteMapping("{id}")
public R deleteById(@ApiParam(name = "id",value = "课时id",required = true) @PathVariable String id){
    videoService.removeVideoById(id);
    return R.ok();
}
```

> 测试服务调用

edu-admin-login也注册到nacos，启动nginx、nacos、edu-admin-login、edu-edu、edu-vod 和 前端后台vue工程edu-admin

```shell
xjwdeMacBook:jude-web-admin xjw$ npm run dev
 DONE  Compiled successfully in 7714ms                                                           15:58:15

 I  Your application is running here: http://localhost:9528
```

## 3、Hystrix服务降级

> Spring Cloud 调用接口的过程

Zuul -> Feign -> Hsystix -> Ribbon -> HttpClient，如下图:

![](/assets/images/2020/icoding/project-build/spring-cloud-service-request-flow.png)

1、edu-edu 开启熔断支持
```properties
feign.hystrixs.enabled=true
```

2、edu-edu编写降级方法
```java
@Component
public class VodClientHystrixFallback implements VodClient {
    @Override
    public R removeVideo(String videoId) {
        return R.error().message("服务降级,VodClientHystrixFallback...执行中");
    }
}
```

3、edu-edu的feign接口VodClient添加失败回调
```java
@FeignClient(name = "edu-vod",fallback = VodClientHystrixFallback.class)
public interface VodClient {
	// 直接调用服务中的请求
	@DeleteMapping("/admin/vod/video/{videoId}")
	R removeVideo(@PathVariable("videoId") String videoId);
}
```

> 测试

把edu-vod服务关掉，删除视频

![](/assets/images/2020/icoding/ali-vod/edu-feign-vod-failure.gif)

![](/assets/images/2020/icoding/ali-vod/edu-feign-vod-failure2.gif)

> 区分服务降级和服务熔断

- 服务降级：客户端调用服务无法访问，调用Hystrix的fallback方法，实现服务降级 
- 服务熔断：服务端方法异常，调用 @HystrixCommand 的fallbackMethod，快速返回。

